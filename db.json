{"meta":{"version":1,"warehouse":"4.0.1"},"models":{"Asset":[{"_id":"source/custom/privacy-policy.html","path":"custom/privacy-policy.html","modified":0,"renderable":0},{"_id":"themes/archer/source/assets/algolia_logo.svg","path":"assets/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/archer/source/assets/beian.png","path":"assets/beian.png","modified":0,"renderable":1},{"_id":"themes/archer/source/assets/favicon.ico","path":"assets/favicon.ico","modified":1,"renderable":1},{"_id":"themes/archer/source/assets/loading.svg","path":"assets/loading.svg","modified":0,"renderable":1},{"_id":"themes/archer/source/css/dark.css","path":"css/dark.css","modified":0,"renderable":1},{"_id":"themes/archer/source/css/dark.css.map","path":"css/dark.css.map","modified":0,"renderable":1},{"_id":"themes/archer/source/css/mobile.css","path":"css/mobile.css","modified":0,"renderable":1},{"_id":"themes/archer/source/css/mobile.css.map","path":"css/mobile.css.map","modified":0,"renderable":1},{"_id":"themes/archer/source/css/style.css","path":"css/style.css","modified":0,"renderable":1},{"_id":"themes/archer/source/css/style.css.map","path":"css/style.css.map","modified":0,"renderable":1},{"_id":"themes/archer/source/font/Oswald-Regular.ttf","path":"font/Oswald-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/archer/source/font/Source Sans Pro.woff","path":"font/Source Sans Pro.woff","modified":0,"renderable":1},{"_id":"themes/archer/source/font/Source Sans Pro.woff2","path":"font/Source Sans Pro.woff2","modified":0,"renderable":1},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff","path":"font/SourceCodePro-Regular.ttf.woff","modified":0,"renderable":1},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff2","path":"font/SourceCodePro-Regular.ttf.woff2","modified":0,"renderable":1},{"_id":"themes/archer/source/intro/404-bg.jpg","path":"intro/404-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/about-bg.jpg","path":"intro/about-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/post-bg.jpg","path":"intro/post-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/lib/jquery.min.js","path":"lib/jquery.min.js","modified":0,"renderable":1},{"_id":"themes/archer/source/lib/webfontloader.min.js","path":"lib/webfontloader.min.js","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/customFontLoader.js","path":"scripts/customFontLoader.js","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/customFontLoader.js.map","path":"scripts/customFontLoader.js.map","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/dark.js","path":"scripts/dark.js","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/dark.js.map","path":"scripts/dark.js.map","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/main.js","path":"scripts/main.js","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/main.js.LICENSE.txt","path":"scripts/main.js.LICENSE.txt","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/main.js.map","path":"scripts/main.js.map","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/search.js","path":"scripts/search.js","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/search.js.LICENSE.txt","path":"scripts/search.js.LICENSE.txt","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/search.js.map","path":"scripts/search.js.map","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/share.js","path":"scripts/share.js","modified":0,"renderable":1},{"_id":"themes/archer/source/scripts/share.js.map","path":"scripts/share.js.map","modified":0,"renderable":1},{"_id":"themes/archer/source/avatar/L.jpeg","path":"avatar/L.jpeg","modified":1,"renderable":1},{"_id":"themes/archer/source/assets/wechat_qr.jpeg","path":"assets/wechat_qr.jpeg","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/index-bg.jpeg","path":"intro/index-bg.jpeg","modified":1,"renderable":1}],"Cache":[{"_id":"source/.DS_Store","hash":"543fb51b5b10dcab23e850bd2f4377e00abafbf9","modified":1655293283112},{"_id":"source/_posts/2018年复盘.md","hash":"338e77db3bcd96bdcb1461ff07a2217448745bbd","modified":1655291972303},{"_id":"source/_posts/Activity启动流程-基于Android26.md","hash":"5c5ff976d95b2015fca3fed7eda91a63ad544488","modified":1655291972304},{"_id":"source/_posts/AppPlugin中的Task-第一篇.md","hash":"1b07e2a3c05639214049d356a761a021d9d7f620","modified":1655291972315},{"_id":"source/_posts/ArrayList源码分析.md","hash":"683f1abe2fe32c76242074784849394d4fb9a072","modified":1655291972315},{"_id":"source/_posts/Android消息机制-Handler.md","hash":"46c8b849d95219e47c59df4dc96b0ca934dac511","modified":1655291972311},{"_id":"source/_posts/Flutter-ListView-源码分析.md","hash":"a04802fc694c527cf45ad575ba1042cddae722a3","modified":1655291972316},{"_id":"source/_posts/Gradle多项目实践.md","hash":"0cca966a802c440fa49d60f4af5f850fdf2c1dbd","modified":1655291972316},{"_id":"source/_posts/Gradle多项目构建.md","hash":"635bb4c68fd958ca3836824c4165a2d875250599","modified":1655291972317},{"_id":"source/_posts/Gradle插件-基础篇.md","hash":"d7e11790592eba05427c0c6c4289b156a87f10cb","modified":1655291972317},{"_id":"source/_posts/Gradle插件-提高篇.md","hash":"0ac087efbca9e9d94a1754041e1beddb7dafa021","modified":1655291972318},{"_id":"source/_posts/HashMap源码分析.md","hash":"d1acf7770fbb152391a6c309d07c1ac487bab69a","modified":1655291972319},{"_id":"source/_posts/JavaScript正则表达式.md","hash":"b9995358640b161724fb4d1d5ca648112e439575","modified":1655291972319},{"_id":"source/_posts/Jetpack中的Lifecycle.md","hash":"b28b24cdc1e70e661886551d6863d413e5663624","modified":1655291972320},{"_id":"source/_posts/Jetpack中的LiveData.md","hash":"892b52b90324c3ac152edfb60d15efc62823ffd2","modified":1655291972320},{"_id":"source/_posts/Jetpack中的ViewModel.md","hash":"7c2cac582a8231dd1fb9bfaf7e3a6a76a26f8571","modified":1655291972321},{"_id":"source/_posts/LeetCode-5-Longest-Palindromic-Substring.md","hash":"f6fcccce13d948b789f4d2a75e5bd78768cf6ad2","modified":1655291972321},{"_id":"source/_posts/Looper中的死循环.md","hash":"4c5fe3f88603c1e57d72d18d43c9780fc5313e90","modified":1655291972322},{"_id":"source/_posts/仿即刻Flutter版本.md","hash":"6965cf92c492388820ba136afa9248a949000346","modified":1655291972323},{"_id":"source/_posts/scoped-model源码解析.md","hash":"d1665d11842a515056549b5debbfdde04f088d89","modified":1655291972323},{"_id":"source/_posts/SparseArray源码解析.md","hash":"ef998eb71e6b66cac912831ea5aeb426aa4beb51","modified":1655291972322},{"_id":"source/_posts/hello-world.md","hash":"7d143ea20eb8fe54463dd464d7fe7f6856e9d616","modified":1655291972322},{"_id":"source/_posts/优化包大小-PNG部分.md","hash":"2820fc2dd1b59ca72882aa553b716e238fa9ca4e","modified":1655291972323},{"_id":"source/_posts/可拖拽的网格布局.md","hash":"31417482ba49a6a6b132e45a44b4542ebbf46382","modified":1655291972324},{"_id":"source/_posts/性能优化第一步.md","hash":"22e93a7207dd6180767914af2566f391b5b605e0","modified":1655291972324},{"_id":"source/_posts/浅谈Flutter构建.md","hash":"011131ef6e198efe990e0688dd83e3e81dc508a9","modified":1655291972326},{"_id":"source/_posts/浅谈Flutter热重载-上.md","hash":"14c36f28f8da18199f4a0b35abfd045fcd20957a","modified":1655291972326},{"_id":"source/_posts/熟悉又陌生的Context.md","hash":"21e102472375f2fa024bb2021efed000f272d4d5","modified":1655291972327},{"_id":"source/_posts/解决Flutter版本不一致的flutterw.md","hash":"d202634e93c4a76476307460791d517fc43c9d99","modified":1655291972328},{"_id":"source/_posts/灵活使用位运算符.md","hash":"0a7c2e118393f6f396a0b45a49a2f15600b48a6a","modified":1655291972327},{"_id":"source/_posts/无侵入引入Flutter模块.md","hash":"50a6756de837ef9a68d2eb04167ce0f197dba273","modified":1655291972325},{"_id":"source/_posts/触摸事件实践之路.md","hash":"3991218abe6b95ae1abfd5b40d29dec98bfdacce","modified":1655291972328},{"_id":"source/about/index.md","hash":"3d5687f73f030597def353686f8d85267ccf8419","modified":1655291972329},{"_id":"source/tags/index.md","hash":"758576e3a3061215a1c02f147bd5e8572df4f3a5","modified":1655291972329},{"_id":"source/categories/index.md","hash":"01aaad46196103db69d1d2545e486453d0c4cafb","modified":1655291972329},{"_id":"source/custom/privacy-policy.html","hash":"5242c60b4ed730331b602608f6461a29d49d8ff8","modified":1655292774978},{"_id":"themes/archer/layout/_partial/comment/custom.ejs","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1655442043534},{"_id":"themes/archer/.eslintrc.json","hash":"352a07b94efa124a5658b502bf973683be09fd00","modified":1655442043526},{"_id":"themes/archer/.editorconfig","hash":"3a7f38d9586f73ed1c46cfbc9839b3465ec57d7c","modified":1655442043526},{"_id":"themes/archer/.babelrc","hash":"078678843ebb6992f0cc44304faa6f1cb082bd4a","modified":1655442043526},{"_id":"themes/archer/.gitattributes","hash":"82c1a621642d5b620275ae1ed59845c3f7015a64","modified":1655442043526},{"_id":"themes/archer/CHANGELOG.md","hash":"6fbf3e5e8ed6ae6fb68fd74bfd2b53d99db4b1fd","modified":1655442043528},{"_id":"themes/archer/LICENSE","hash":"0da0c361bf299375739c6b668a44af0f5faf37bb","modified":1655442043528},{"_id":"themes/archer/README.md","hash":"069ea3c82bb762e76420b1fa1515eb93fc545574","modified":1655442043529},{"_id":"themes/archer/_config.yml","hash":"93a02363aaf413f7fdd5960c22dd83a293de7d9c","modified":1655442043529},{"_id":"themes/archer/gulpfile.js","hash":"ee1ad57aa5113a084091fd86fca2c34e1b9e4b95","modified":1655442043531},{"_id":"themes/archer/.gitignore","hash":"b5de96e5158df11ad8c49d149f45ec014e18971a","modified":1655442043528},{"_id":"themes/archer/.prettierignore","hash":"41abb32fef2d4686421aff0f29b796fef29dcc18","modified":1655442043528},{"_id":"themes/archer/package.json","hash":"8fe7d738be6f9b73a624ea1236a12881b900c555","modified":1655442043540},{"_id":"themes/archer/webpack.config.js","hash":"e090744d8e7a0d0906d1d6b8192eb906092d1e9b","modified":1655442043594},{"_id":"themes/archer/webpack.prod.js","hash":"a34abc06d6cd8fa4e267069468726322a3656e2b","modified":1655442043595},{"_id":"themes/archer/webpack.dev.js","hash":"7c740341894bd584f72145512a58703bb134ea60","modified":1655442043594},{"_id":"themes/archer/.prettierrc.js","hash":"bae1d8dab7bf8b68207386f366e092778940540c","modified":1655442043528},{"_id":"themes/archer/dev/archer.sh","hash":"4065c4e55462d5ecf016464adea0d1db967ef4b4","modified":1655442043529},{"_id":"themes/archer/docs/README-en.md","hash":"f325565c0bb94501fd046268659c7752709895d1","modified":1655442043529},{"_id":"themes/archer/docs/develop-guide-zh.md","hash":"db6a9945e6040bd63d006da7b0b7e7ba5febd150","modified":1655442043530},{"_id":"themes/archer/docs/develop-guide-en.md","hash":"0bb09c3c9d5f56820cb84e3316f60352b731d70c","modified":1655442043529},{"_id":"themes/archer/languages/default.yml","hash":"e937791c5080868c3abe20bab4cf266a342b5922","modified":1655442043531},{"_id":"themes/archer/languages/en.yml","hash":"5a1a85fed95dab4f01671714ee8cc5420936c05f","modified":1655442043531},{"_id":"themes/archer/layout/404.ejs","hash":"9137c0b1153ca8cd32e60a38fd79b7e4b91c8bf4","modified":1655442043532},{"_id":"themes/archer/layout/about.ejs","hash":"748786bebad03b1ef79c551f26522fa2bee1b9dd","modified":1655442043538},{"_id":"themes/archer/layout/index.ejs","hash":"093f8dbe875cad94b9618f181d1b5621d8874b19","modified":1655442043538},{"_id":"themes/archer/layout/layout.ejs","hash":"1bee90a75c1f4b04c90421419dd68acdec15b998","modified":1655442043538},{"_id":"themes/archer/layout/post.ejs","hash":"d421aba0ab93e2b7a22d060da4c56441bf97cdb9","modified":1655442043538},{"_id":"themes/archer/layout/site-meta.ejs","hash":"562e446a742fde07e0880343d5693bf8cb0dec23","modified":1655442043538},{"_id":"themes/archer/.github/ISSUE_TEMPLATE/-----------bug--help-wanted-or-bug-report-.md","hash":"012bd3afea5565204f75d8c89048ad33b9c2f948","modified":1655442043527},{"_id":"themes/archer/.github/ISSUE_TEMPLATE/-----feature-request-.md","hash":"886fb1252702d46c89536b579d35ce49e53ec54d","modified":1655442043527},{"_id":"themes/archer/layout/_partial/algolia.ejs","hash":"c7bf50dd6e60fd8e8dfbeab9960172359af7307e","modified":1655442043532},{"_id":"themes/archer/.github/ISSUE_TEMPLATE/-----other-issue-.md","hash":"4bf3c8ebef14a81bb55e8e0468d816e83c4133ac","modified":1655442043527},{"_id":"themes/archer/layout/_partial/base-background-image.ejs","hash":"4e6091b81f7f327cffee6275174c52918cd1789a","modified":1655442043532},{"_id":"themes/archer/layout/_partial/base-footer-fixed.ejs","hash":"e4dbde6594c0c2d1c5de71ddf968be0879ceddb7","modified":1655442043532},{"_id":"themes/archer/layout/_partial/base-footer.ejs","hash":"d8f4236166d058421c2e4ff00660be75a3494704","modified":1655442043533},{"_id":"themes/archer/layout/_partial/base-head.ejs","hash":"76fd2b40c501d5c6eb764c336f11521e045febc9","modified":1655442043533},{"_id":"themes/archer/layout/_partial/base-header.ejs","hash":"57d1ae0fd6f9f1ab52a64c44a8ae17ee71de22ef","modified":1655442043533},{"_id":"themes/archer/layout/_partial/base-preload-polyfill.ejs","hash":"d046322674052b0667775dca0886f14e0d812897","modified":1655442043533},{"_id":"themes/archer/layout/_partial/base-profile.ejs","hash":"b4be51c4c02b69d3e95a555ae00047f3b6c2926f","modified":1655442043533},{"_id":"themes/archer/layout/_partial/base-social.ejs","hash":"0190f06c2f0345cec00eba2074bbfd1b56a7fdc9","modified":1655442043534},{"_id":"themes/archer/layout/_partial/custom-font.ejs","hash":"bc6bfda53f8856e1473263a44fd861e96cc00719","modified":1655442043536},{"_id":"themes/archer/layout/_partial/base-title-tags.ejs","hash":"1d5a95782ffc382fdb6b1239b3b97db125984fa0","modified":1655442043534},{"_id":"themes/archer/layout/_partial/intro-height.ejs","hash":"7b8b078b1c1e5b216e46b32a0cab67330c92c734","modified":1655442043536},{"_id":"themes/archer/source/assets/beian.png","hash":"a99df13e8eb11db86edebf6e5ac246eb59f4b3c4","modified":1655442043541},{"_id":"themes/archer/.github/workflows/deploy-demo-page.yml","hash":"91c065ee0ec29f7bb10263fefa6f3072bc493a38","modified":1655442043528},{"_id":"themes/archer/source/assets/loading.svg","hash":"45be17d07697d604d8981890eb21e308530c7a38","modified":1655442043542},{"_id":"themes/archer/source/assets/algolia_logo.svg","hash":"90035272fa31a3f65b3c0e2cb8a633876ef457dc","modified":1655442043541},{"_id":"themes/archer/source/assets/example_qr.png","hash":"cce20432c34875f4d9c6df927ede0fc0f00bb194","modified":1655442043541},{"_id":"themes/archer/source/assets/favicon.ico","hash":"8b200c575d273d41a179c102442e191414e74eae","modified":1655442043541},{"_id":"themes/archer/source/css/dark.css","hash":"32b2072ca8d39803cbd8f7395dcf02f6390dbee3","modified":1655442043543},{"_id":"themes/archer/source/css/mobile.css","hash":"7b73350f80ee39ec30b4c61895d274b4889329f4","modified":1655442043544},{"_id":"themes/archer/source/avatar/Misaka.jpg","hash":"74a0372523f98dfbba992bf80642e160d04dc9b1","modified":1655442043542},{"_id":"themes/archer/source/css/style.css","hash":"2a3733ec29221a6f9a74f08b821ca079d18dbea6","modified":1655442043544},{"_id":"themes/archer/source/css/dark.css.map","hash":"f5b60d05584b47dea744edff92c44bc389675e05","modified":1655442043543},{"_id":"themes/archer/source/css/mobile.css.map","hash":"1f26e4000a416870ccf4e85083f7209dc55f4482","modified":1655442043544},{"_id":"themes/archer/source/font/Source Sans Pro.woff2","hash":"da65f527a8da65d5eb6721626d28cfdb46ab104a","modified":1655442043546},{"_id":"themes/archer/source/font/Source Sans Pro.woff","hash":"a6722c9b6439b7a020a9be3d3178970757a9265c","modified":1655442043546},{"_id":"themes/archer/source/lib/webfontloader.min.js","hash":"4c69aeb4e4f355912503d1c460e8e7aa6ea6963e","modified":1655442043554},{"_id":"themes/archer/source/scripts/customFontLoader.js","hash":"e95e00bdb80b5b2abef477eabe59005cc8d196c5","modified":1655442043555},{"_id":"themes/archer/source/scripts/dark.js","hash":"b0b3b400432f1913c57c817e3d8ad40dbfeebabc","modified":1655442043556},{"_id":"themes/archer/source/scripts/main.js.LICENSE.txt","hash":"7f3206da6b550feb5291feee14bc02e74d3076a1","modified":1655442043564},{"_id":"themes/archer/source/scripts/search.js.LICENSE.txt","hash":"f98b4df48bbadc7ab1e8f9fc4618b86d33bdf44f","modified":1655442043576},{"_id":"themes/archer/source/scripts/dark.js.map","hash":"512d8ca5ed89950d8fad95ba1200f0b21ba82388","modified":1655442043556},{"_id":"themes/archer/source/scripts/share.js","hash":"f47267d78d896ae1ec2b4daba9f7ed098712a95b","modified":1655442043581},{"_id":"themes/archer/src/js/browser.js","hash":"c56e0094a04d6f20564f8f0da1496cb7631d4dc2","modified":1655442043583},{"_id":"themes/archer/src/js/customFontLoader.js","hash":"98bb3a1c0f69bc2675bfa6579df2dde38ba6fded","modified":1655442043583},{"_id":"themes/archer/src/js/dark.js","hash":"2cd243df8593b18a1a293f483d2db18503c53547","modified":1655442043583},{"_id":"themes/archer/src/js/fancybox.js","hash":"6dfc8015d6000c76806424876f5472f39e5485af","modified":1655442043584},{"_id":"themes/archer/src/js/fontawsome.js","hash":"43e852899ee1bc22495253428a2ff3bdedf89882","modified":1655442043584},{"_id":"themes/archer/src/js/init.js","hash":"dee0a1c959bd4dc3953428b1b2137f42bc659b32","modified":1655442043584},{"_id":"themes/archer/src/js/initSidebar.js","hash":"c9c030a451ed394934c1858c7d55ec5a7b588305","modified":1655442043584},{"_id":"themes/archer/src/js/main.js","hash":"103af0f91a07e77cb20ac3f8b547a043586d34ea","modified":1655442043584},{"_id":"themes/archer/src/js/mobile.js","hash":"4ae6837e18b729f85b5097867fc742ba2d1edf25","modified":1655442043584},{"_id":"themes/archer/src/js/scroll.js","hash":"19f1e5352228034f897f503a25bd760c3bebcbf2","modified":1655442043584},{"_id":"themes/archer/src/js/share.js","hash":"c2e6a3d8d6883cde0c67484daca5e742ebb8e0d1","modified":1655442043585},{"_id":"themes/archer/src/js/search.js","hash":"0bf92b51fef092989f4fe16fb7ef7724d11e9f58","modified":1655442043585},{"_id":"themes/archer/src/js/sidebar.js","hash":"3f917f2fb5c5b9db1660458899506547b1767746","modified":1655442043585},{"_id":"themes/archer/src/js/tag.js","hash":"395db7eb2d09e2df6eefcf3f4c7da5cd809a6221","modified":1655442043585},{"_id":"themes/archer/src/js/toc.js","hash":"ff7022cd08e26baf22cbf8c1f158e5fd67e74e48","modified":1655442043585},{"_id":"themes/archer/src/js/util.js","hash":"e49b30f6ba82d5183d005fc0192d2d673969586b","modified":1655442043585},{"_id":"themes/archer/src/scss/_mixin.scss","hash":"78da2632e7150baa0fd1f6d04fc59ca5e304903d","modified":1655442043588},{"_id":"themes/archer/src/scss/_common.scss","hash":"e80acb4f0049d24260f0a32a301f985ae7e166b8","modified":1655442043586},{"_id":"themes/archer/src/scss/_normalize.scss","hash":"a2dbeb38ad08bb8975856d75954cc697bf8e5ff7","modified":1655442043589},{"_id":"themes/archer/src/scss/mobile.scss","hash":"20bb8ac78c3a2505f5b8997f31544ff23179aaf7","modified":1655442043594},{"_id":"themes/archer/src/scss/_variables.scss","hash":"01e5cab2b5fc686c52145d65229f17db13a3cc54","modified":1655442043594},{"_id":"themes/archer/src/scss/dark.scss","hash":"739af46f0ef8c0c89c3e78ec577e844678f737b5","modified":1655442043594},{"_id":"themes/archer/src/scss/style.scss","hash":"b10b9a44efaa293b7ac220e66c963dca04ad4bc7","modified":1655442043594},{"_id":"themes/archer/layout/_partial/comment/changyan.ejs","hash":"cc02b3cf9586135d2d7f822c7ad97d81fdf6d4e5","modified":1655442043534},{"_id":"themes/archer/layout/_partial/comment/gitalk.ejs","hash":"840279fd3e21dc1cdb1932fe4d9a3be5f670e764","modified":1655442043535},{"_id":"themes/archer/layout/_partial/comment/gitment.ejs","hash":"eda79ada5171ed44e4f3ae4d8a345ad2c7adb2df","modified":1655442043535},{"_id":"themes/archer/layout/_partial/comment/disqus.ejs","hash":"0f0612ce9ca5c3dc349153a87fdc9dba5f93c52c","modified":1655442043535},{"_id":"themes/archer/layout/_partial/comment/livere.ejs","hash":"d65d9372fca4b316b94ae511f8ccfb0b92d7b065","modified":1655442043535},{"_id":"themes/archer/layout/_partial/comment/utteranc.ejs","hash":"f4ec58c74e6870b8c22032ad3a3c1ee33e5ec41d","modified":1655442043535},{"_id":"themes/archer/layout/_partial/comment/valine.ejs","hash":"24cd7b9e28ceb4b2083ddccce26517de64b35119","modified":1655442043535},{"_id":"themes/archer/layout/_partial/comment/waline.ejs","hash":"c2208d6f05490bbf1b35cdf1519a39933212c33e","modified":1655442043536},{"_id":"themes/archer/layout/_partial/comment/youyan.ejs","hash":"2f4ef49a74a8d63310af60ecda6d765b8c386ff4","modified":1655442043536},{"_id":"themes/archer/layout/_partial/critical-css/critical-style.ejs","hash":"e67a7a2f6bcbfd97e95577446872e217e0c48e80","modified":1655442043536},{"_id":"themes/archer/layout/_partial/math/mathjax.ejs","hash":"84c40a07765e95213045e9b9f7a8c9aaa9c69161","modified":1655442043537},{"_id":"themes/archer/layout/_partial/script/font-loader.ejs","hash":"0473335774025d185dcbaf641496b25a8f33f7af","modified":1655442043537},{"_id":"themes/archer/layout/_partial/sidebar/sidebar-archives.ejs","hash":"6360da867c23b8daa5e34e62c5c5552e2974e360","modified":1655442043537},{"_id":"themes/archer/layout/_partial/sidebar/sidebar-tags.ejs","hash":"469455994771da166ddecb4839efa9ef28f2775d","modified":1655442043538},{"_id":"themes/archer/layout/_partial/sidebar/base-sidebar.ejs","hash":"bdf08beebbe454da9d4c55b35efd317d5f222be5","modified":1655442043537},{"_id":"themes/archer/layout/_partial/sidebar/sidebar-categories.ejs","hash":"02f407d9f9968d228a6a47f2a283b8cf41836a1a","modified":1655442043537},{"_id":"themes/archer/src/scss/_dark/_common-dark.scss","hash":"fc03470312c57a39bc131a1e86cdd3ea2ddb164a","modified":1655442043586},{"_id":"themes/archer/src/scss/_partial/_404.scss","hash":"9e5cb20871e5bf1af4cf50694a73bd7c9fe64685","modified":1655442043590},{"_id":"themes/archer/src/scss/_partial/_index-page.scss","hash":"7ed45c11316bb9bf441ab897fcfed9beea108ad6","modified":1655442043591},{"_id":"themes/archer/src/scss/_partial/_post-page.scss","hash":"26a55109cd29fd0f01134aaf5cb80bde789f4d13","modified":1655442043593},{"_id":"themes/archer/src/scss/_dark/_partial/_algolia-dark.scss","hash":"e9ea52ca5410c6a6eb53d2a6de1419d3db97d8ca","modified":1655442043586},{"_id":"themes/archer/src/scss/_dark/_partial/_index-page-dark.scss","hash":"4c1406e82b2d4503e027443f64f0984fe0942e1d","modified":1655442043587},{"_id":"themes/archer/src/scss/_dark/_partial/_post-page-dark.scss","hash":"d61059785c72c626990f5b473dc3570cb52c0d73","modified":1655442043588},{"_id":"themes/archer/src/scss/_mobile/_partial/_index-page-mobile.scss","hash":"2d166bb6f234b8773a9ea12457b10e94902a32f1","modified":1655442043589},{"_id":"themes/archer/src/scss/_partial/_comment/_gitalk.scss","hash":"341bb251987f30221936e36b44374b2b5ce0d218","modified":1655442043591},{"_id":"themes/archer/src/scss/_partial/_partial/_footer-fixed.scss","hash":"1eb918f6c16054ef2b53b9eea60c751ad89bbd55","modified":1655442043591},{"_id":"themes/archer/src/scss/_partial/_algolia.scss","hash":"fd7716d8559a9f58f7caef576c553ca7ba1a85e1","modified":1655442043590},{"_id":"themes/archer/src/scss/_partial/_partial/_footer.scss","hash":"4aafefa6834c8a8583c1cdace620a31306676a57","modified":1655442043591},{"_id":"themes/archer/src/scss/_partial/_partial/_intro.scss","hash":"4567b9081f063e5fb388b0671f3bc322bdc9acfa","modified":1655442043592},{"_id":"themes/archer/src/scss/_partial/_partial/_profile.scss","hash":"4771add895f8a47917ae2d0d34b92cb327329bf1","modified":1655442043592},{"_id":"themes/archer/src/scss/_partial/_partial/_header.scss","hash":"3ae33e6dec6956dee8e9f524e2947ad3cc717b37","modified":1655442043592},{"_id":"themes/archer/src/scss/_partial/_partial/_paginator.scss","hash":"67c2e697a5fbb3b8006cf358ea45eb7f75b496f8","modified":1655442043592},{"_id":"themes/archer/src/scss/_partial/_partial/_scrollbar.scss","hash":"424c08f4acc3f643567f138ffea7d8337791d2c4","modified":1655442043592},{"_id":"themes/archer/src/scss/_partial/_post/_code.scss","hash":"504f9fdb723c7b287d958211189d25919ac592f6","modified":1655442043593},{"_id":"themes/archer/src/scss/_partial/_sidebar/_sidebar-archive.scss","hash":"a7374f46ca31bf8ebf5bafea909100921d0c52a4","modified":1655442043593},{"_id":"themes/archer/src/scss/_partial/_post/_writing-enhance.scss","hash":"4cb495c64d144b2bcf225f2b87641017bd652e66","modified":1655442043593},{"_id":"themes/archer/src/scss/_partial/_sidebar/_sidebar-tags.scss","hash":"93cc82cb56663e83e90fbd6fe31ffdd38e694f3b","modified":1655442043593},{"_id":"themes/archer/src/scss/_partial/_sidebar/_sidebar.scss","hash":"b2870a9cdaea9b9c8426d406d6859a8f3f1a995f","modified":1655442043594},{"_id":"themes/archer/src/scss/_dark/_partial/_comment/_gitalk-dark.scss","hash":"f5d5c83166450e2346d0a2182c8726f8c98cfb1a","modified":1655442043587},{"_id":"themes/archer/src/scss/_dark/_partial/_partial/_footer-fixed-dark.scss","hash":"f4e3eb7aa19c1061b5d9df4f6a7745902e5843f2","modified":1655442043587},{"_id":"themes/archer/src/scss/_dark/_partial/_partial/_footer-dark.scss","hash":"d074a8fef75ba626dd3448cc42290a8c722fd182","modified":1655442043587},{"_id":"themes/archer/src/scss/_dark/_partial/_partial/_header-dark.scss","hash":"ed815d959a37cccdf9137ace91c68bea8ca922c2","modified":1655442043587},{"_id":"themes/archer/src/scss/_dark/_partial/_partial/_profile-dark.scss","hash":"c0fe68f6e9c196157adc71fea0d97f6f70f0a31b","modified":1655442043587},{"_id":"themes/archer/src/scss/_dark/_partial/_post/_code-dark.scss","hash":"9ded8203699f816558fd1493a3ce7cf3d38818e9","modified":1655442043588},{"_id":"themes/archer/src/scss/_dark/_partial/_sidebar/_sidebar-dark.scss","hash":"8e77738f83a425eebb00513ee98e487fe71fdc22","modified":1655442043588},{"_id":"themes/archer/src/scss/_dark/_partial/_sidebar/_sidebar-archive-dark.scss","hash":"79b7548214339807ff713f0c7454a227d24d6d0d","modified":1655442043588},{"_id":"themes/archer/src/scss/_dark/_partial/_sidebar/_sidebar-tags-dark.scss","hash":"6621db2ff1182e3cd14286af4b8f3d8c5bd14e2a","modified":1655442043588},{"_id":"themes/archer/src/scss/_mobile/_partial/_sidebar/_sidebar-tags-mobile.scss","hash":"b5c62234defe693b4cfa65bda188d71c937eeaf9","modified":1655442043589},{"_id":"themes/archer/src/scss/_mobile/_partial/_post/_writing-enhance-mobile.scss","hash":"9e714c1cdc61a4ebd5510667e87e879d0b14de67","modified":1655442043589},{"_id":"themes/archer/source/css/style.css.map","hash":"c9495e0d815109b6cb17ddaa1a99e10714e0a6e8","modified":1655442043545},{"_id":"themes/archer/source/font/Oswald-Regular.ttf","hash":"965d729546a43a8490ad4cf33c25ac475682100c","modified":1655442043546},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff","hash":"12eef75e1ad3eca9dae42b65505010ce4464a315","modified":1655442043547},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff2","hash":"f5991289ec17884cb641da0646d278d36702a190","modified":1655442043547},{"_id":"themes/archer/source/intro/404-bg.jpg","hash":"3afb5bb26f4ff0bd0e0a28df955c8aa7d746d3c5","modified":1655442043548},{"_id":"themes/archer/source/lib/jquery.min.js","hash":"ad886e472b3557f3dc7dfa2bc43468ab8d1cef5b","modified":1655442043554},{"_id":"themes/archer/source/scripts/customFontLoader.js.map","hash":"0fb40aed5a9c1d3f97dbad07ae3279229eaebea9","modified":1655442043556},{"_id":"themes/archer/source/scripts/share.js.map","hash":"b6a3e931cf44fdac5fd717f64019f2aa3b0d62ef","modified":1655442043583},{"_id":"themes/archer/source/intro/post-bg.jpg","hash":"525fafb2238c27754d8fa751f143ff1de9b8482d","modified":1655442043553},{"_id":"themes/archer/source/scripts/search.js","hash":"6f2e0cefb575617be37bfb2c2954f48e568e8f00","modified":1655442043576},{"_id":"themes/archer/source/intro/about-bg.jpg","hash":"ab388276822417cc4e703312c14e20280ec783b3","modified":1655442043550},{"_id":"themes/archer/source/intro/index-bg.jpg","hash":"96b52e177b8bc53e64ec6ee1e10b2b6a4e13083b","modified":1655442043552},{"_id":"themes/archer/package-lock.json","hash":"b0768219adb4e1abc5fa057ec2dcc5451f924ddb","modified":1655442043540},{"_id":"themes/archer/docs/snap.png","hash":"0b2a8bf016f6eed576abfdcdb7dcf8de51c12562","modified":1655442043531},{"_id":"themes/archer/source/scripts/search.js.map","hash":"1ecdd768a261ebede8b51ca383c9bf519a4f6c7c","modified":1655442043580},{"_id":"themes/archer/source/scripts/main.js","hash":"95f0284e68221e5f2f50e8a59de6f7fdda66608b","modified":1655442043563},{"_id":"themes/archer/source/scripts/main.js.map","hash":"b2f3bab368e872ecc910e48fff47797432ab019f","modified":1655442043574}],"Category":[{"name":"随笔","_id":"cl4hzcrlm000kfho6heipgen5"},{"name":"Java","_id":"cl4hzcrls000ofho65z4d6cnj"},{"name":"Gradle","_id":"cl4hzcrlv000sfho65egm8gol"},{"name":"JavaScript","_id":"cl4hzcrlz0010fho6d9izb36a"},{"name":"Android","_id":"cl4hzcrlz0011fho605lph1ko"},{"name":"LeetCode","_id":"cl4hzcrlz0012fho615j6021p"},{"name":"Flutter","_id":"cl4hzcrm00014fho66xta04zr"}],"Data":[],"Page":[{"title":"about","date":"2019-12-10T11:25:03.000Z","_content":"\n大家好，我叫 Leo，2015 年毕业后，一直从事 Android 应用开发工作，平时也会写一些 Shell 脚本、Python 脚本之类的，做过一段时间的 Xposed 插件开发工作，最近时间专注于 Android 性能优化和 Flutter，欢迎一起探讨。","source":"about/index.md","raw":"---\ntitle: about\ndate: 2019-12-10 19:25:03\n---\n\n大家好，我叫 Leo，2015 年毕业后，一直从事 Android 应用开发工作，平时也会写一些 Shell 脚本、Python 脚本之类的，做过一段时间的 Xposed 插件开发工作，最近时间专注于 Android 性能优化和 Flutter，欢迎一起探讨。","updated":"2022-06-15T11:19:32.329Z","path":"about/index.html","comments":1,"layout":"page","_id":"cl4hzcrl20000fho6hy551xg8","content":"<p>大家好，我叫 Leo，2015 年毕业后，一直从事 Android 应用开发工作，平时也会写一些 Shell 脚本、Python 脚本之类的，做过一段时间的 Xposed 插件开发工作，最近时间专注于 Android 性能优化和 Flutter，欢迎一起探讨。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>大家好，我叫 Leo，2015 年毕业后，一直从事 Android 应用开发工作，平时也会写一些 Shell 脚本、Python 脚本之类的，做过一段时间的 Xposed 插件开发工作，最近时间专注于 Android 性能优化和 Flutter，欢迎一起探讨。</p>\n"},{"title":"tags","layout":"tags","comments":0,"date":"2018-04-15T08:44:13.000Z","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\nlayout: tags\ncomments: false\ndate: 2018-04-15 16:44:13\n---\n","updated":"2022-06-15T11:19:32.329Z","path":"tags/index.html","_id":"cl4hzcrl80002fho68vo80n57","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"categories","date":"2018-04-15T08:45:33.000Z","layout":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2018-04-15 16:45:33\nlayout: categories\ncomments: false\n---\n","updated":"2022-06-15T11:19:32.329Z","path":"categories/index.html","_id":"cl4hzcrl90004fho6e5fp55w9","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"2018年复盘","date":"2018-12-31T15:25:06.000Z","_content":"\n2018也到了尾声，这一年感觉经历了较之往年更多的事情，比如有了想守护一辈子的另一半，一年之间换了两次工作，面了很多试。。。\n算算从毕业工作到现在也有三年多了，一直做着 Android 开发，说起来入门 Android 真的是非常巧合，大学的专业不是软件工程，虽然说跟计算机有点联系，但课程跟软件有点联系的，也就 C 语言，数据库和网络课程等，编程基础的数据结构算法，这些都没有。那时候对编程的认识，也仅限于很模糊的 \"很酷的黑客\"，大一大二的时候也开始自学数据结构和算法知识，很可惜都没有坚持下去，那时候感觉很枯燥，每次都是信心满满然后又半途而废，学过 c++，c#，还用过 qt，可惜要么是学了基础语法后就没实用过，要么是跟着教程写了个粗糙的页面就放弃了。现在想起来也是挺可笑的，那时候甚至没明白 GUI 编程，想着为什么写来写去都是这黑黑的控制台。那时候跟着网上教程写了贪吃蛇游戏，都能自豪好久。直到今天我都觉得真的是非常可惜那时候没有找准学习的方向。\n如果说对大学期间的编程学习做下复盘的话，我觉得那时候最大的失误是，没有去接触外面的编程世界，甚至都没有用好搜索，只是沉浸在个人世界中。\n但是人生永远没有后悔药吃，这段经历永远告诉我，看事情要站在一定的高度上，这样思考才能最大程度的避免局限性。\n大学就这样浑浑噩噩的度过，直到开始找工作，那时候真的不知道自己能干什么，那时候有个老师和同学都跟我说过，现在移动端发展不错可以试试。反正自己也没啥一技之长，就去了解了下，跟很多入门 Android 的同学一样，因为没有苹果设备而放弃了 iOS 开发。知道 Android 需要学习 Java ，就花了一个星期学了基础语法。那时候学习 Android 是从一个视频学校网站上学的，跟着视频一点点手打了一个程序，所以不知道什么意思但也成功运行起来了。就这样，学了两个星期就开始找工作，第一面就失败了，影响深刻，当时人家问了什么是四大组件，没答上来就说了个 Activity，23333，接着问了我那个程序的实现原理，支支吾吾说不上了。接着去面了家 web 开发的岗位，那时候还天真的以为 web 开发是写 html，css 后来才发现人家招的是后端人员，开始让我写了一套题目，还有手写排序，写完了，有个小伙子进来面试，问我用过什么框架，我说没有用过。然后就问了一些其他的，没记清，因为那时候不懂前端开发和后端开发，所以估计也是答的乱七八糟。最后人家让回去等消息，自己还以为是还有机会。。。\n最后还是找到了实习工作，在一家十几个人的小公司，开发人员加上我就两个，面试的时候，估计另外一个开发不懂移动开发，所以老板就让我回去做个从网络获取数据的页面，我花了几天时间，不断百度，拼了个页面发给老板，老板说可以了去实习了。。公司就我一个几乎零基础的 Android 开发，从零开始搭建项目，甚至连对接后端的人员都没有，说是在招了，但到我离职都没有。老板就让我自己去摸索，那时候每天的工作内容就是不断的学习 Android 知识，看博客，看视频去积累，这里特别感谢下郭大神，郭霖，真正意义上的启蒙老师。从他的博客学习了太多的知识了。在那里实习了两个月，说来惭愧最后没写出什么来，就做了几个列表页面。。。接口是自己从工作的外包出去的 web 项目源码中找到了\n虽然两个月的实习很短，但让我接触到了 Android 开发入门的门槛。感谢郭大神，感谢实习公司的老板。\n讲完了入门的经历，再来讲讲今年在开发技能上的得与失。\n掌握了 gradle shell 等脚本编程，能通过搜索辅助，实现一些持续构建，优化打包的需求。在新语言上面，kotlin 和 js 也更加熟练了，特别是 kotlin 以后 Android 开发的主力语言。开始去刷 Leetcode，掌握了更为全面的知识后，开发信心上也得到了提升。\n本来年初想着今年的能在 Android Framework 和 逆向安全上面有所提升，可惜也是三天打鱼两天晒网。这也是今年心态上的一个写照，心急。总想着快速去学习不同的新东西，尝试过小程序，前端开发，flutter 等等，总是怕落后别人，但都没有去深入。哎\n以前一直以为自己是个独行侠，暂时不会在感情上有所投入，但至少她进入我的生活后，才发现原来每天下班回到出租屋中，有个人在等你回来的感觉是这么的好。才意识到认认真真生活真的是非常美好。当你真正想去照顾一个人的时候，你就像是一瞬间长大的大人。\n工作上，今年竟然换了两家工作，这种太过频繁的跳动，其实是我不愿意看到的。因为每到一家新公司都需要一段时间去融入新环境。哎，只能说计划赶不上变化。\n新的一年里，我希望在学习上，能够沉下心去，完完整整，有计划地去学习某个知识点。工作上能够稳定，在现在这家公司不断锤炼自己的技能。生活上能够给予我所爱的人一片天空。\n最后希望我所爱的人，和爱我的人身体健康。\n2018.12.31 23.06","source":"_posts/2018年复盘.md","raw":"---\ntitle: 2018年复盘\ndate: 2018-12-31 23:25:06\ncategories: 随笔\ntags:\n---\n\n2018也到了尾声，这一年感觉经历了较之往年更多的事情，比如有了想守护一辈子的另一半，一年之间换了两次工作，面了很多试。。。\n算算从毕业工作到现在也有三年多了，一直做着 Android 开发，说起来入门 Android 真的是非常巧合，大学的专业不是软件工程，虽然说跟计算机有点联系，但课程跟软件有点联系的，也就 C 语言，数据库和网络课程等，编程基础的数据结构算法，这些都没有。那时候对编程的认识，也仅限于很模糊的 \"很酷的黑客\"，大一大二的时候也开始自学数据结构和算法知识，很可惜都没有坚持下去，那时候感觉很枯燥，每次都是信心满满然后又半途而废，学过 c++，c#，还用过 qt，可惜要么是学了基础语法后就没实用过，要么是跟着教程写了个粗糙的页面就放弃了。现在想起来也是挺可笑的，那时候甚至没明白 GUI 编程，想着为什么写来写去都是这黑黑的控制台。那时候跟着网上教程写了贪吃蛇游戏，都能自豪好久。直到今天我都觉得真的是非常可惜那时候没有找准学习的方向。\n如果说对大学期间的编程学习做下复盘的话，我觉得那时候最大的失误是，没有去接触外面的编程世界，甚至都没有用好搜索，只是沉浸在个人世界中。\n但是人生永远没有后悔药吃，这段经历永远告诉我，看事情要站在一定的高度上，这样思考才能最大程度的避免局限性。\n大学就这样浑浑噩噩的度过，直到开始找工作，那时候真的不知道自己能干什么，那时候有个老师和同学都跟我说过，现在移动端发展不错可以试试。反正自己也没啥一技之长，就去了解了下，跟很多入门 Android 的同学一样，因为没有苹果设备而放弃了 iOS 开发。知道 Android 需要学习 Java ，就花了一个星期学了基础语法。那时候学习 Android 是从一个视频学校网站上学的，跟着视频一点点手打了一个程序，所以不知道什么意思但也成功运行起来了。就这样，学了两个星期就开始找工作，第一面就失败了，影响深刻，当时人家问了什么是四大组件，没答上来就说了个 Activity，23333，接着问了我那个程序的实现原理，支支吾吾说不上了。接着去面了家 web 开发的岗位，那时候还天真的以为 web 开发是写 html，css 后来才发现人家招的是后端人员，开始让我写了一套题目，还有手写排序，写完了，有个小伙子进来面试，问我用过什么框架，我说没有用过。然后就问了一些其他的，没记清，因为那时候不懂前端开发和后端开发，所以估计也是答的乱七八糟。最后人家让回去等消息，自己还以为是还有机会。。。\n最后还是找到了实习工作，在一家十几个人的小公司，开发人员加上我就两个，面试的时候，估计另外一个开发不懂移动开发，所以老板就让我回去做个从网络获取数据的页面，我花了几天时间，不断百度，拼了个页面发给老板，老板说可以了去实习了。。公司就我一个几乎零基础的 Android 开发，从零开始搭建项目，甚至连对接后端的人员都没有，说是在招了，但到我离职都没有。老板就让我自己去摸索，那时候每天的工作内容就是不断的学习 Android 知识，看博客，看视频去积累，这里特别感谢下郭大神，郭霖，真正意义上的启蒙老师。从他的博客学习了太多的知识了。在那里实习了两个月，说来惭愧最后没写出什么来，就做了几个列表页面。。。接口是自己从工作的外包出去的 web 项目源码中找到了\n虽然两个月的实习很短，但让我接触到了 Android 开发入门的门槛。感谢郭大神，感谢实习公司的老板。\n讲完了入门的经历，再来讲讲今年在开发技能上的得与失。\n掌握了 gradle shell 等脚本编程，能通过搜索辅助，实现一些持续构建，优化打包的需求。在新语言上面，kotlin 和 js 也更加熟练了，特别是 kotlin 以后 Android 开发的主力语言。开始去刷 Leetcode，掌握了更为全面的知识后，开发信心上也得到了提升。\n本来年初想着今年的能在 Android Framework 和 逆向安全上面有所提升，可惜也是三天打鱼两天晒网。这也是今年心态上的一个写照，心急。总想着快速去学习不同的新东西，尝试过小程序，前端开发，flutter 等等，总是怕落后别人，但都没有去深入。哎\n以前一直以为自己是个独行侠，暂时不会在感情上有所投入，但至少她进入我的生活后，才发现原来每天下班回到出租屋中，有个人在等你回来的感觉是这么的好。才意识到认认真真生活真的是非常美好。当你真正想去照顾一个人的时候，你就像是一瞬间长大的大人。\n工作上，今年竟然换了两家工作，这种太过频繁的跳动，其实是我不愿意看到的。因为每到一家新公司都需要一段时间去融入新环境。哎，只能说计划赶不上变化。\n新的一年里，我希望在学习上，能够沉下心去，完完整整，有计划地去学习某个知识点。工作上能够稳定，在现在这家公司不断锤炼自己的技能。生活上能够给予我所爱的人一片天空。\n最后希望我所爱的人，和爱我的人身体健康。\n2018.12.31 23.06","slug":"2018年复盘","published":1,"updated":"2022-06-15T11:19:32.303Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrl60001fho6hydz2xn5","content":"<p>2018也到了尾声，这一年感觉经历了较之往年更多的事情，比如有了想守护一辈子的另一半，一年之间换了两次工作，面了很多试。。。<br>算算从毕业工作到现在也有三年多了，一直做着 Android 开发，说起来入门 Android 真的是非常巧合，大学的专业不是软件工程，虽然说跟计算机有点联系，但课程跟软件有点联系的，也就 C 语言，数据库和网络课程等，编程基础的数据结构算法，这些都没有。那时候对编程的认识，也仅限于很模糊的 “很酷的黑客”，大一大二的时候也开始自学数据结构和算法知识，很可惜都没有坚持下去，那时候感觉很枯燥，每次都是信心满满然后又半途而废，学过 c++，c#，还用过 qt，可惜要么是学了基础语法后就没实用过，要么是跟着教程写了个粗糙的页面就放弃了。现在想起来也是挺可笑的，那时候甚至没明白 GUI 编程，想着为什么写来写去都是这黑黑的控制台。那时候跟着网上教程写了贪吃蛇游戏，都能自豪好久。直到今天我都觉得真的是非常可惜那时候没有找准学习的方向。<br>如果说对大学期间的编程学习做下复盘的话，我觉得那时候最大的失误是，没有去接触外面的编程世界，甚至都没有用好搜索，只是沉浸在个人世界中。<br>但是人生永远没有后悔药吃，这段经历永远告诉我，看事情要站在一定的高度上，这样思考才能最大程度的避免局限性。<br>大学就这样浑浑噩噩的度过，直到开始找工作，那时候真的不知道自己能干什么，那时候有个老师和同学都跟我说过，现在移动端发展不错可以试试。反正自己也没啥一技之长，就去了解了下，跟很多入门 Android 的同学一样，因为没有苹果设备而放弃了 iOS 开发。知道 Android 需要学习 Java ，就花了一个星期学了基础语法。那时候学习 Android 是从一个视频学校网站上学的，跟着视频一点点手打了一个程序，所以不知道什么意思但也成功运行起来了。就这样，学了两个星期就开始找工作，第一面就失败了，影响深刻，当时人家问了什么是四大组件，没答上来就说了个 Activity，23333，接着问了我那个程序的实现原理，支支吾吾说不上了。接着去面了家 web 开发的岗位，那时候还天真的以为 web 开发是写 html，css 后来才发现人家招的是后端人员，开始让我写了一套题目，还有手写排序，写完了，有个小伙子进来面试，问我用过什么框架，我说没有用过。然后就问了一些其他的，没记清，因为那时候不懂前端开发和后端开发，所以估计也是答的乱七八糟。最后人家让回去等消息，自己还以为是还有机会。。。<br>最后还是找到了实习工作，在一家十几个人的小公司，开发人员加上我就两个，面试的时候，估计另外一个开发不懂移动开发，所以老板就让我回去做个从网络获取数据的页面，我花了几天时间，不断百度，拼了个页面发给老板，老板说可以了去实习了。。公司就我一个几乎零基础的 Android 开发，从零开始搭建项目，甚至连对接后端的人员都没有，说是在招了，但到我离职都没有。老板就让我自己去摸索，那时候每天的工作内容就是不断的学习 Android 知识，看博客，看视频去积累，这里特别感谢下郭大神，郭霖，真正意义上的启蒙老师。从他的博客学习了太多的知识了。在那里实习了两个月，说来惭愧最后没写出什么来，就做了几个列表页面。。。接口是自己从工作的外包出去的 web 项目源码中找到了<br>虽然两个月的实习很短，但让我接触到了 Android 开发入门的门槛。感谢郭大神，感谢实习公司的老板。<br>讲完了入门的经历，再来讲讲今年在开发技能上的得与失。<br>掌握了 gradle shell 等脚本编程，能通过搜索辅助，实现一些持续构建，优化打包的需求。在新语言上面，kotlin 和 js 也更加熟练了，特别是 kotlin 以后 Android 开发的主力语言。开始去刷 Leetcode，掌握了更为全面的知识后，开发信心上也得到了提升。<br>本来年初想着今年的能在 Android Framework 和 逆向安全上面有所提升，可惜也是三天打鱼两天晒网。这也是今年心态上的一个写照，心急。总想着快速去学习不同的新东西，尝试过小程序，前端开发，flutter 等等，总是怕落后别人，但都没有去深入。哎<br>以前一直以为自己是个独行侠，暂时不会在感情上有所投入，但至少她进入我的生活后，才发现原来每天下班回到出租屋中，有个人在等你回来的感觉是这么的好。才意识到认认真真生活真的是非常美好。当你真正想去照顾一个人的时候，你就像是一瞬间长大的大人。<br>工作上，今年竟然换了两家工作，这种太过频繁的跳动，其实是我不愿意看到的。因为每到一家新公司都需要一段时间去融入新环境。哎，只能说计划赶不上变化。<br>新的一年里，我希望在学习上，能够沉下心去，完完整整，有计划地去学习某个知识点。工作上能够稳定，在现在这家公司不断锤炼自己的技能。生活上能够给予我所爱的人一片天空。<br>最后希望我所爱的人，和爱我的人身体健康。<br>2018.12.31 23.06</p>\n","site":{"data":{}},"excerpt":"","more":"<p>2018也到了尾声，这一年感觉经历了较之往年更多的事情，比如有了想守护一辈子的另一半，一年之间换了两次工作，面了很多试。。。<br>算算从毕业工作到现在也有三年多了，一直做着 Android 开发，说起来入门 Android 真的是非常巧合，大学的专业不是软件工程，虽然说跟计算机有点联系，但课程跟软件有点联系的，也就 C 语言，数据库和网络课程等，编程基础的数据结构算法，这些都没有。那时候对编程的认识，也仅限于很模糊的 “很酷的黑客”，大一大二的时候也开始自学数据结构和算法知识，很可惜都没有坚持下去，那时候感觉很枯燥，每次都是信心满满然后又半途而废，学过 c++，c#，还用过 qt，可惜要么是学了基础语法后就没实用过，要么是跟着教程写了个粗糙的页面就放弃了。现在想起来也是挺可笑的，那时候甚至没明白 GUI 编程，想着为什么写来写去都是这黑黑的控制台。那时候跟着网上教程写了贪吃蛇游戏，都能自豪好久。直到今天我都觉得真的是非常可惜那时候没有找准学习的方向。<br>如果说对大学期间的编程学习做下复盘的话，我觉得那时候最大的失误是，没有去接触外面的编程世界，甚至都没有用好搜索，只是沉浸在个人世界中。<br>但是人生永远没有后悔药吃，这段经历永远告诉我，看事情要站在一定的高度上，这样思考才能最大程度的避免局限性。<br>大学就这样浑浑噩噩的度过，直到开始找工作，那时候真的不知道自己能干什么，那时候有个老师和同学都跟我说过，现在移动端发展不错可以试试。反正自己也没啥一技之长，就去了解了下，跟很多入门 Android 的同学一样，因为没有苹果设备而放弃了 iOS 开发。知道 Android 需要学习 Java ，就花了一个星期学了基础语法。那时候学习 Android 是从一个视频学校网站上学的，跟着视频一点点手打了一个程序，所以不知道什么意思但也成功运行起来了。就这样，学了两个星期就开始找工作，第一面就失败了，影响深刻，当时人家问了什么是四大组件，没答上来就说了个 Activity，23333，接着问了我那个程序的实现原理，支支吾吾说不上了。接着去面了家 web 开发的岗位，那时候还天真的以为 web 开发是写 html，css 后来才发现人家招的是后端人员，开始让我写了一套题目，还有手写排序，写完了，有个小伙子进来面试，问我用过什么框架，我说没有用过。然后就问了一些其他的，没记清，因为那时候不懂前端开发和后端开发，所以估计也是答的乱七八糟。最后人家让回去等消息，自己还以为是还有机会。。。<br>最后还是找到了实习工作，在一家十几个人的小公司，开发人员加上我就两个，面试的时候，估计另外一个开发不懂移动开发，所以老板就让我回去做个从网络获取数据的页面，我花了几天时间，不断百度，拼了个页面发给老板，老板说可以了去实习了。。公司就我一个几乎零基础的 Android 开发，从零开始搭建项目，甚至连对接后端的人员都没有，说是在招了，但到我离职都没有。老板就让我自己去摸索，那时候每天的工作内容就是不断的学习 Android 知识，看博客，看视频去积累，这里特别感谢下郭大神，郭霖，真正意义上的启蒙老师。从他的博客学习了太多的知识了。在那里实习了两个月，说来惭愧最后没写出什么来，就做了几个列表页面。。。接口是自己从工作的外包出去的 web 项目源码中找到了<br>虽然两个月的实习很短，但让我接触到了 Android 开发入门的门槛。感谢郭大神，感谢实习公司的老板。<br>讲完了入门的经历，再来讲讲今年在开发技能上的得与失。<br>掌握了 gradle shell 等脚本编程，能通过搜索辅助，实现一些持续构建，优化打包的需求。在新语言上面，kotlin 和 js 也更加熟练了，特别是 kotlin 以后 Android 开发的主力语言。开始去刷 Leetcode，掌握了更为全面的知识后，开发信心上也得到了提升。<br>本来年初想着今年的能在 Android Framework 和 逆向安全上面有所提升，可惜也是三天打鱼两天晒网。这也是今年心态上的一个写照，心急。总想着快速去学习不同的新东西，尝试过小程序，前端开发，flutter 等等，总是怕落后别人，但都没有去深入。哎<br>以前一直以为自己是个独行侠，暂时不会在感情上有所投入，但至少她进入我的生活后，才发现原来每天下班回到出租屋中，有个人在等你回来的感觉是这么的好。才意识到认认真真生活真的是非常美好。当你真正想去照顾一个人的时候，你就像是一瞬间长大的大人。<br>工作上，今年竟然换了两家工作，这种太过频繁的跳动，其实是我不愿意看到的。因为每到一家新公司都需要一段时间去融入新环境。哎，只能说计划赶不上变化。<br>新的一年里，我希望在学习上，能够沉下心去，完完整整，有计划地去学习某个知识点。工作上能够稳定，在现在这家公司不断锤炼自己的技能。生活上能够给予我所爱的人一片天空。<br>最后希望我所爱的人，和爱我的人身体健康。<br>2018.12.31 23.06</p>\n"},{"title":"ArrayList源码分析","date":"2018-11-09T02:16:12.000Z","_content":"\n### 构造函数\n\nArrayList 的构造函数有三个：\n\n* `ArrayList()`\n* `ArrayList(int)`\n* `ArrayList(Collection<? extends E>)`\n\n其中用的最多的是无参默认构造函数，ArrayList 底层是使用数组实现的，这里初始化一个空数组\n\n``` java\npublic ArrayList() {                                     \n    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;\n} \n\nprivate static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = {};\n```\n\n如果传入指定的容量（initialCapacity），则会初始化指定大小的数组\n\n### add 操作\n\n调用 `add(value)` 会在列表的尾部添加一个元素\n\n``` java\npublic boolean add(E e) {                                                  \n    ensureCapacityInternal(size + 1);  // Increments modCount!!            \n    elementData[size++] = e;                                               \n    return true;                                                           \n}\n\nprivate void ensureCapacityInternal(int minCapacity) {                  \n    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));\n}\n\nprivate static int calculateCapacity(Object[] elementData, int minCapacity) {\n    if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {\n        // 如果是初始化，则使用 DEFAULT_CAPACITY = 10\n        return Math.max(DEFAULT_CAPACITY, minCapacity);                       \n    }                                                                         \n    return minCapacity;                                                       \n}\n\nprivate void ensureExplicitCapacity(int minCapacity) { \n    modCount++;                                        \n                                                       \n    // overflow-conscious code                         \n    if (minCapacity - elementData.length > 0) // 需要扩容          \n        grow(minCapacity);                             \n}\n\n// 可使用的数组最大容量，一些虚拟机会在数组中保留一个头部字段\nprivate static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;\n\nprivate void grow(int minCapacity) {                           \n    // overflow-conscious code 考虑溢出情况                                 \n    int oldCapacity = elementData.length;\n    // 增加旧容量 * 0.5 = 旧容量 * 1.5\n    int newCapacity = oldCapacity + (oldCapacity >> 1);        \n    if (newCapacity - minCapacity < 0)                         \n        newCapacity = minCapacity;     // 还不够大，直接用 minCapacity                       \n    if (newCapacity - MAX_ARRAY_SIZE > 0)  // 大于允许的最大容量                    \n        newCapacity = hugeCapacity(minCapacity);               \n    // minCapacity is usually close to size, so this is a win: \n    elementData = Arrays.copyOf(elementData, newCapacity);     \n}\n\nprivate static int hugeCapacity(int minCapacity) { \n    if (minCapacity < 0) // overflow // 超过 Integer.MAX_VALUE，变成负值             \n        throw new OutOfMemoryError();              \n    return (minCapacity > MAX_ARRAY_SIZE) ?        \n        Integer.MAX_VALUE :                        \n        MAX_ARRAY_SIZE;                            \n}                                                  \n```\n\n> 允许添加 null\n\n### remove 操作\n\n调用 `remove(int)` 删除指定下标的元素\n\n``` java\npublic E remove(int index) {\n    // 下标范围检查\n    rangeCheck(index);                                                   \n                                                                         \n    modCount++;                                                          \n    E oldValue = elementData(index);                                     \n    \n    // 需要移动的个数\n    int numMoved = size - index - 1;                                     \n    if (numMoved > 0)\n        // 元素拷贝移动\n        System.arraycopy(elementData, index+1, elementData, index,       \n                         numMoved);                                      \n    elementData[--size] = null; // clear to let GC do its work           \n                                                                         \n    return oldValue;                                                     \n}                                                                        \n```\n\n调用 `remove(object)` 删除指定元素\n\n``` java\npublic boolean remove(Object o) {                      \n    if (o == null) {\n        // 如果删除 null 元素\n        for (int index = 0; index < size; index++)     \n            if (elementData[index] == null) {          \n                fastRemove(index);                     \n                return true;                           \n            }                                          \n    } else {                                           \n        for (int index = 0; index < size; index++)\n            // 调用 equals 判断\n            if (o.equals(elementData[index])) {        \n                fastRemove(index);                     \n                return true;                           \n            }                                          \n    }                                                  \n    return false;                                      \n} \nprivate void fastRemove(int index) {                                       \n    modCount++;                                                            \n    int numMoved = size - index - 1;                                       \n    if (numMoved > 0)                                                      \n        System.arraycopy(elementData, index+1, elementData, index,         \n                         numMoved);                                        \n    elementData[--size] = null; // clear to let GC do its work             \n}                                                                                                                               \n```\n\n","source":"_posts/ArrayList源码分析.md","raw":"---\ntitle: ArrayList源码分析\ndate: 2018-11-09 10:16:12\ncategories: Java\ntags:\n---\n\n### 构造函数\n\nArrayList 的构造函数有三个：\n\n* `ArrayList()`\n* `ArrayList(int)`\n* `ArrayList(Collection<? extends E>)`\n\n其中用的最多的是无参默认构造函数，ArrayList 底层是使用数组实现的，这里初始化一个空数组\n\n``` java\npublic ArrayList() {                                     \n    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;\n} \n\nprivate static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = {};\n```\n\n如果传入指定的容量（initialCapacity），则会初始化指定大小的数组\n\n### add 操作\n\n调用 `add(value)` 会在列表的尾部添加一个元素\n\n``` java\npublic boolean add(E e) {                                                  \n    ensureCapacityInternal(size + 1);  // Increments modCount!!            \n    elementData[size++] = e;                                               \n    return true;                                                           \n}\n\nprivate void ensureCapacityInternal(int minCapacity) {                  \n    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));\n}\n\nprivate static int calculateCapacity(Object[] elementData, int minCapacity) {\n    if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {\n        // 如果是初始化，则使用 DEFAULT_CAPACITY = 10\n        return Math.max(DEFAULT_CAPACITY, minCapacity);                       \n    }                                                                         \n    return minCapacity;                                                       \n}\n\nprivate void ensureExplicitCapacity(int minCapacity) { \n    modCount++;                                        \n                                                       \n    // overflow-conscious code                         \n    if (minCapacity - elementData.length > 0) // 需要扩容          \n        grow(minCapacity);                             \n}\n\n// 可使用的数组最大容量，一些虚拟机会在数组中保留一个头部字段\nprivate static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;\n\nprivate void grow(int minCapacity) {                           \n    // overflow-conscious code 考虑溢出情况                                 \n    int oldCapacity = elementData.length;\n    // 增加旧容量 * 0.5 = 旧容量 * 1.5\n    int newCapacity = oldCapacity + (oldCapacity >> 1);        \n    if (newCapacity - minCapacity < 0)                         \n        newCapacity = minCapacity;     // 还不够大，直接用 minCapacity                       \n    if (newCapacity - MAX_ARRAY_SIZE > 0)  // 大于允许的最大容量                    \n        newCapacity = hugeCapacity(minCapacity);               \n    // minCapacity is usually close to size, so this is a win: \n    elementData = Arrays.copyOf(elementData, newCapacity);     \n}\n\nprivate static int hugeCapacity(int minCapacity) { \n    if (minCapacity < 0) // overflow // 超过 Integer.MAX_VALUE，变成负值             \n        throw new OutOfMemoryError();              \n    return (minCapacity > MAX_ARRAY_SIZE) ?        \n        Integer.MAX_VALUE :                        \n        MAX_ARRAY_SIZE;                            \n}                                                  \n```\n\n> 允许添加 null\n\n### remove 操作\n\n调用 `remove(int)` 删除指定下标的元素\n\n``` java\npublic E remove(int index) {\n    // 下标范围检查\n    rangeCheck(index);                                                   \n                                                                         \n    modCount++;                                                          \n    E oldValue = elementData(index);                                     \n    \n    // 需要移动的个数\n    int numMoved = size - index - 1;                                     \n    if (numMoved > 0)\n        // 元素拷贝移动\n        System.arraycopy(elementData, index+1, elementData, index,       \n                         numMoved);                                      \n    elementData[--size] = null; // clear to let GC do its work           \n                                                                         \n    return oldValue;                                                     \n}                                                                        \n```\n\n调用 `remove(object)` 删除指定元素\n\n``` java\npublic boolean remove(Object o) {                      \n    if (o == null) {\n        // 如果删除 null 元素\n        for (int index = 0; index < size; index++)     \n            if (elementData[index] == null) {          \n                fastRemove(index);                     \n                return true;                           \n            }                                          \n    } else {                                           \n        for (int index = 0; index < size; index++)\n            // 调用 equals 判断\n            if (o.equals(elementData[index])) {        \n                fastRemove(index);                     \n                return true;                           \n            }                                          \n    }                                                  \n    return false;                                      \n} \nprivate void fastRemove(int index) {                                       \n    modCount++;                                                            \n    int numMoved = size - index - 1;                                       \n    if (numMoved > 0)                                                      \n        System.arraycopy(elementData, index+1, elementData, index,         \n                         numMoved);                                        \n    elementData[--size] = null; // clear to let GC do its work             \n}                                                                                                                               \n```\n\n","slug":"ArrayList源码分析","published":1,"updated":"2022-06-15T11:19:32.315Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrl90003fho6c8t54zs5","content":"<h3 id=\"构造函数\"><a href=\"#构造函数\" class=\"headerlink\" title=\"构造函数\"></a>构造函数</h3><p>ArrayList 的构造函数有三个：</p>\n<ul>\n<li><code>ArrayList()</code></li>\n<li><code>ArrayList(int)</code></li>\n<li><code>ArrayList(Collection&lt;? extends E&gt;)</code></li>\n</ul>\n<p>其中用的最多的是无参默认构造函数，ArrayList 底层是使用数组实现的，这里初始化一个空数组</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ArrayList</span><span class=\"params\">()</span> &#123;                                     </span><br><span class=\"line\">    <span class=\"built_in\">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>如果传入指定的容量（initialCapacity），则会初始化指定大小的数组</p>\n<h3 id=\"add-操作\"><a href=\"#add-操作\" class=\"headerlink\" title=\"add 操作\"></a>add 操作</h3><p>调用 <code>add(value)</code> 会在列表的尾部添加一个元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">add</span><span class=\"params\">(E e)</span> &#123;                                                  </span><br><span class=\"line\">    ensureCapacityInternal(size + <span class=\"number\">1</span>);  <span class=\"comment\">// Increments modCount!!            </span></span><br><span class=\"line\">    elementData[size++] = e;                                               </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                                                           </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">ensureCapacityInternal</span><span class=\"params\">(<span class=\"type\">int</span> minCapacity)</span> &#123;                  </span><br><span class=\"line\">    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">calculateCapacity</span><span class=\"params\">(Object[] elementData, <span class=\"type\">int</span> minCapacity)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果是初始化，则使用 DEFAULT_CAPACITY = 10</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Math.max(DEFAULT_CAPACITY, minCapacity);                       </span><br><span class=\"line\">    &#125;                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">return</span> minCapacity;                                                       </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">ensureExplicitCapacity</span><span class=\"params\">(<span class=\"type\">int</span> minCapacity)</span> &#123; </span><br><span class=\"line\">    modCount++;                                        </span><br><span class=\"line\">                                                       </span><br><span class=\"line\">    <span class=\"comment\">// overflow-conscious code                         </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (minCapacity - elementData.length &gt; <span class=\"number\">0</span>) <span class=\"comment\">// 需要扩容          </span></span><br><span class=\"line\">        grow(minCapacity);                             </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 可使用的数组最大容量，一些虚拟机会在数组中保留一个头部字段</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">MAX_ARRAY_SIZE</span> <span class=\"operator\">=</span> Integer.MAX_VALUE - <span class=\"number\">8</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">grow</span><span class=\"params\">(<span class=\"type\">int</span> minCapacity)</span> &#123;                           </span><br><span class=\"line\">    <span class=\"comment\">// overflow-conscious code 考虑溢出情况                                 </span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldCapacity</span> <span class=\"operator\">=</span> elementData.length;</span><br><span class=\"line\">    <span class=\"comment\">// 增加旧容量 * 0.5 = 旧容量 * 1.5</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">newCapacity</span> <span class=\"operator\">=</span> oldCapacity + (oldCapacity &gt;&gt; <span class=\"number\">1</span>);        </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newCapacity - minCapacity &lt; <span class=\"number\">0</span>)                         </span><br><span class=\"line\">        newCapacity = minCapacity;     <span class=\"comment\">// 还不够大，直接用 minCapacity                       </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class=\"number\">0</span>)  <span class=\"comment\">// 大于允许的最大容量                    </span></span><br><span class=\"line\">        newCapacity = hugeCapacity(minCapacity);               </span><br><span class=\"line\">    <span class=\"comment\">// minCapacity is usually close to size, so this is a win: </span></span><br><span class=\"line\">    elementData = Arrays.copyOf(elementData, newCapacity);     </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">hugeCapacity</span><span class=\"params\">(<span class=\"type\">int</span> minCapacity)</span> &#123; </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (minCapacity &lt; <span class=\"number\">0</span>) <span class=\"comment\">// overflow // 超过 Integer.MAX_VALUE，变成负值             </span></span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">OutOfMemoryError</span>();              </span><br><span class=\"line\">    <span class=\"keyword\">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?        </span><br><span class=\"line\">        Integer.MAX_VALUE :                        </span><br><span class=\"line\">        MAX_ARRAY_SIZE;                            </span><br><span class=\"line\">&#125;                                                  </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>允许添加 null</p>\n</blockquote>\n<h3 id=\"remove-操作\"><a href=\"#remove-操作\" class=\"headerlink\" title=\"remove 操作\"></a>remove 操作</h3><p>调用 <code>remove(int)</code> 删除指定下标的元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> E <span class=\"title function_\">remove</span><span class=\"params\">(<span class=\"type\">int</span> index)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 下标范围检查</span></span><br><span class=\"line\">    rangeCheck(index);                                                   </span><br><span class=\"line\">                                                                         </span><br><span class=\"line\">    modCount++;                                                          </span><br><span class=\"line\">    <span class=\"type\">E</span> <span class=\"variable\">oldValue</span> <span class=\"operator\">=</span> elementData(index);                                     </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 需要移动的个数</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">numMoved</span> <span class=\"operator\">=</span> size - index - <span class=\"number\">1</span>;                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (numMoved &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"comment\">// 元素拷贝移动</span></span><br><span class=\"line\">        System.arraycopy(elementData, index+<span class=\"number\">1</span>, elementData, index,       </span><br><span class=\"line\">                         numMoved);                                      </span><br><span class=\"line\">    elementData[--size] = <span class=\"literal\">null</span>; <span class=\"comment\">// clear to let GC do its work           </span></span><br><span class=\"line\">                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">return</span> oldValue;                                                     </span><br><span class=\"line\">&#125;                                                                        </span><br></pre></td></tr></table></figure>\n\n<p>调用 <code>remove(object)</code> 删除指定元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">remove</span><span class=\"params\">(Object o)</span> &#123;                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (o == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果删除 null 元素</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">index</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; index &lt; size; index++)     </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (elementData[index] == <span class=\"literal\">null</span>) &#123;          </span><br><span class=\"line\">                fastRemove(index);                     </span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                           </span><br><span class=\"line\">            &#125;                                          </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                           </span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">index</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; index &lt; size; index++)</span><br><span class=\"line\">            <span class=\"comment\">// 调用 equals 判断</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (o.equals(elementData[index])) &#123;        </span><br><span class=\"line\">                fastRemove(index);                     </span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                           </span><br><span class=\"line\">            &#125;                                          </span><br><span class=\"line\">    &#125;                                                  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;                                      </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">fastRemove</span><span class=\"params\">(<span class=\"type\">int</span> index)</span> &#123;                                       </span><br><span class=\"line\">    modCount++;                                                            </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">numMoved</span> <span class=\"operator\">=</span> size - index - <span class=\"number\">1</span>;                                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (numMoved &gt; <span class=\"number\">0</span>)                                                      </span><br><span class=\"line\">        System.arraycopy(elementData, index+<span class=\"number\">1</span>, elementData, index,         </span><br><span class=\"line\">                         numMoved);                                        </span><br><span class=\"line\">    elementData[--size] = <span class=\"literal\">null</span>; <span class=\"comment\">// clear to let GC do its work             </span></span><br><span class=\"line\">&#125;                                                                                                                               </span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"构造函数\"><a href=\"#构造函数\" class=\"headerlink\" title=\"构造函数\"></a>构造函数</h3><p>ArrayList 的构造函数有三个：</p>\n<ul>\n<li><code>ArrayList()</code></li>\n<li><code>ArrayList(int)</code></li>\n<li><code>ArrayList(Collection&lt;? extends E&gt;)</code></li>\n</ul>\n<p>其中用的最多的是无参默认构造函数，ArrayList 底层是使用数组实现的，这里初始化一个空数组</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ArrayList</span><span class=\"params\">()</span> &#123;                                     </span><br><span class=\"line\">    <span class=\"built_in\">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>如果传入指定的容量（initialCapacity），则会初始化指定大小的数组</p>\n<h3 id=\"add-操作\"><a href=\"#add-操作\" class=\"headerlink\" title=\"add 操作\"></a>add 操作</h3><p>调用 <code>add(value)</code> 会在列表的尾部添加一个元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">add</span><span class=\"params\">(E e)</span> &#123;                                                  </span><br><span class=\"line\">    ensureCapacityInternal(size + <span class=\"number\">1</span>);  <span class=\"comment\">// Increments modCount!!            </span></span><br><span class=\"line\">    elementData[size++] = e;                                               </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                                                           </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">ensureCapacityInternal</span><span class=\"params\">(<span class=\"type\">int</span> minCapacity)</span> &#123;                  </span><br><span class=\"line\">    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">calculateCapacity</span><span class=\"params\">(Object[] elementData, <span class=\"type\">int</span> minCapacity)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果是初始化，则使用 DEFAULT_CAPACITY = 10</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Math.max(DEFAULT_CAPACITY, minCapacity);                       </span><br><span class=\"line\">    &#125;                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">return</span> minCapacity;                                                       </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">ensureExplicitCapacity</span><span class=\"params\">(<span class=\"type\">int</span> minCapacity)</span> &#123; </span><br><span class=\"line\">    modCount++;                                        </span><br><span class=\"line\">                                                       </span><br><span class=\"line\">    <span class=\"comment\">// overflow-conscious code                         </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (minCapacity - elementData.length &gt; <span class=\"number\">0</span>) <span class=\"comment\">// 需要扩容          </span></span><br><span class=\"line\">        grow(minCapacity);                             </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 可使用的数组最大容量，一些虚拟机会在数组中保留一个头部字段</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">MAX_ARRAY_SIZE</span> <span class=\"operator\">=</span> Integer.MAX_VALUE - <span class=\"number\">8</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">grow</span><span class=\"params\">(<span class=\"type\">int</span> minCapacity)</span> &#123;                           </span><br><span class=\"line\">    <span class=\"comment\">// overflow-conscious code 考虑溢出情况                                 </span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldCapacity</span> <span class=\"operator\">=</span> elementData.length;</span><br><span class=\"line\">    <span class=\"comment\">// 增加旧容量 * 0.5 = 旧容量 * 1.5</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">newCapacity</span> <span class=\"operator\">=</span> oldCapacity + (oldCapacity &gt;&gt; <span class=\"number\">1</span>);        </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newCapacity - minCapacity &lt; <span class=\"number\">0</span>)                         </span><br><span class=\"line\">        newCapacity = minCapacity;     <span class=\"comment\">// 还不够大，直接用 minCapacity                       </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class=\"number\">0</span>)  <span class=\"comment\">// 大于允许的最大容量                    </span></span><br><span class=\"line\">        newCapacity = hugeCapacity(minCapacity);               </span><br><span class=\"line\">    <span class=\"comment\">// minCapacity is usually close to size, so this is a win: </span></span><br><span class=\"line\">    elementData = Arrays.copyOf(elementData, newCapacity);     </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">hugeCapacity</span><span class=\"params\">(<span class=\"type\">int</span> minCapacity)</span> &#123; </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (minCapacity &lt; <span class=\"number\">0</span>) <span class=\"comment\">// overflow // 超过 Integer.MAX_VALUE，变成负值             </span></span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">OutOfMemoryError</span>();              </span><br><span class=\"line\">    <span class=\"keyword\">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?        </span><br><span class=\"line\">        Integer.MAX_VALUE :                        </span><br><span class=\"line\">        MAX_ARRAY_SIZE;                            </span><br><span class=\"line\">&#125;                                                  </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>允许添加 null</p>\n</blockquote>\n<h3 id=\"remove-操作\"><a href=\"#remove-操作\" class=\"headerlink\" title=\"remove 操作\"></a>remove 操作</h3><p>调用 <code>remove(int)</code> 删除指定下标的元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> E <span class=\"title function_\">remove</span><span class=\"params\">(<span class=\"type\">int</span> index)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 下标范围检查</span></span><br><span class=\"line\">    rangeCheck(index);                                                   </span><br><span class=\"line\">                                                                         </span><br><span class=\"line\">    modCount++;                                                          </span><br><span class=\"line\">    <span class=\"type\">E</span> <span class=\"variable\">oldValue</span> <span class=\"operator\">=</span> elementData(index);                                     </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 需要移动的个数</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">numMoved</span> <span class=\"operator\">=</span> size - index - <span class=\"number\">1</span>;                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (numMoved &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"comment\">// 元素拷贝移动</span></span><br><span class=\"line\">        System.arraycopy(elementData, index+<span class=\"number\">1</span>, elementData, index,       </span><br><span class=\"line\">                         numMoved);                                      </span><br><span class=\"line\">    elementData[--size] = <span class=\"literal\">null</span>; <span class=\"comment\">// clear to let GC do its work           </span></span><br><span class=\"line\">                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">return</span> oldValue;                                                     </span><br><span class=\"line\">&#125;                                                                        </span><br></pre></td></tr></table></figure>\n\n<p>调用 <code>remove(object)</code> 删除指定元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">remove</span><span class=\"params\">(Object o)</span> &#123;                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (o == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果删除 null 元素</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">index</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; index &lt; size; index++)     </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (elementData[index] == <span class=\"literal\">null</span>) &#123;          </span><br><span class=\"line\">                fastRemove(index);                     </span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                           </span><br><span class=\"line\">            &#125;                                          </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                           </span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">index</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; index &lt; size; index++)</span><br><span class=\"line\">            <span class=\"comment\">// 调用 equals 判断</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (o.equals(elementData[index])) &#123;        </span><br><span class=\"line\">                fastRemove(index);                     </span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                           </span><br><span class=\"line\">            &#125;                                          </span><br><span class=\"line\">    &#125;                                                  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;                                      </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">fastRemove</span><span class=\"params\">(<span class=\"type\">int</span> index)</span> &#123;                                       </span><br><span class=\"line\">    modCount++;                                                            </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">numMoved</span> <span class=\"operator\">=</span> size - index - <span class=\"number\">1</span>;                                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (numMoved &gt; <span class=\"number\">0</span>)                                                      </span><br><span class=\"line\">        System.arraycopy(elementData, index+<span class=\"number\">1</span>, elementData, index,         </span><br><span class=\"line\">                         numMoved);                                        </span><br><span class=\"line\">    elementData[--size] = <span class=\"literal\">null</span>; <span class=\"comment\">// clear to let GC do its work             </span></span><br><span class=\"line\">&#125;                                                                                                                               </span><br></pre></td></tr></table></figure>\n\n"},{"title":"Gradle多项目构建","date":"2018-04-29T01:57:51.000Z","_content":"\n## 参考\n\n[multi_project_builds](https://docs.gradle.org/current/userguide/multi_project_builds.html)\n\n## 概述\n\n在使用 Android Studio 作为 IDE 之后，Android 项目就开始使用 Gradle 作为构建脚本，Gradle 的优点就不用我多说了，使用 Groovy 作为开发语言，配合各种 Gradle 插件和 DSL 可以实现多样化的构建过程。\n\nGradle 能讲的知识点很多，本文主要讲的是 Gradle 在多项目构建上提供的一些便捷的功能，希望能给大家一些启发。\n\n## 名词解释\n\n* 构建脚本：本文所说的构建脚本指的是 Gradle 文件，以 `.gradle` 为后缀的文件\n* 项目：在多项目构建中，有根项目和子项目。根项目的称呼是相对的，以执行 gradle 命令的目录为根项目，当前目录的子目录称为子项目\n\n## Gradle 多项目构建\n\n首先我们对 Gradle 多项目构建先做下了解，这里所涉及的知识点大部分来源于参考文档。\n\n### 跨项目配置\n\nGradle 提供了在任何构建脚本中访问任何项目，比如可以使用 `allprojects` 来对所有项目进行配置：\n\n``` groovy\nallprojects {\n    task hello {\n        doLast {\n            println \"Hello Gradle\"\n        }\n    }\n}\n```\n\n这个例子我们对所有项目都创建了一个叫 \"hello\" 的 task，如果你只是想对当前项目的子项目进行配置：\n\n``` groovy\nsubprojects {\n    task hello {\n        doLast {\n            println \"Hello Gradle\"\n        }\n    }\n}\n```\n\n当然你也可以针对单个项目进行配置：\n\n``` groovy\nproject (':project') {\n    task hello {\n        doLast {\n            println \"Hello Gradle\"\n        }\n    }\n}\n```\n\n上面所说的操作可以在任何一个构建脚本上执行，所以你可以选择统一写到单独的构建脚本上，再通过 `apply from: \"xxx.gradle\"` 应用进来。\n\n### 边读取边解释\n\n可能有的同学会问，为什么上面要用 doLast，可以不用 doLast，直接写可以吗？\n\n当前可以，但是执行的时机就不一样了，doLast 从字面意思来看，表示在最后执行，那么这个最后指的是什么之后呢。答案就是项目配置评测(evaluation)之后，简单来讲，当 Gradle 开始执行时，会先从根目录的 `settings.gradle` 中读取参与构建的项目，即只有将子项目 `include` 才能参与构建，接着 Gradle 会在每个项目的根目录下读取 `build.gradle` 如果存在的话，即 `build.gradle` 并不是必须的。默认情况下，Gradle 会先读取根项目的配置，即当你执行 Gradle 命令时所在目录的项目。接着按字母排序，读取子项目的配置，当项目配置评测完成之后，再执行对应的 task.doLast。\n\n那有的同学又会问了，那如果直接写，执行的顺序是什么呢？是在评测之后，doLast 之前吗？这可能是写习惯应用程序的同学最常见的误区了，之前博主也是这么想的，后来经过同事的点拨，**Gradle 是边读取边解释**，有点口语化，但确实如此，回到上面的问题，如果直接写在 task 的代码，会在 Gradle 读取到这一行的时候执行，即可能先于其他还没评测的项目执行，我们可以通过一个例子来看下：\n\n这是项目的目录结构：\n\n```\n├── build.gradle\n├── config.gradle\n├── gradle\n│   └── wrapper\n│       ├── gradle-wrapper.jar\n│       └── gradle-wrapper.properties\n├── gradle.properties\n├── gradlew\n├── gradlew.bat\n├── settings.gradle\n├── sub1\n│   └── build.gradle\n└── sub2\n    └── build.gradle\n```\n\n这里我们包含了两个子项目，分别是 `sub1` 和 `sub2`，在每个项目的 `build.gradle` 我们都加上 Log 打印：\n\n``` groovy\nprintln \"$project.name init\"\n\nprintln \"$project.name  end\"\n```\n\n接着我们在根项目的 `build.gradle` 即最外层目录下，添加一个 task：\n\n``` groovy\ntask hello {\n    println \"我直接运行\"\n    doLast {\n        println \"我运行在 doLast\"\n    }\n}\n```\n\n记得在根目录下执行 `./gradlew -q hello`，参数 `-q` 只打印我们的 log，结果如下：\n\n```\nMyApplication init\n我直接运行\nMyApplication  end\nsub1 init\nsub1 end\nsub2 init\nsub2  end\n我运行在 doLast\n```\n\n结果是不是和我们想的一样。接着我们在 sub1 的 `build.gradle` 中增加以下代码：\n\n``` groovy\nprintln \"当前 sub2 是否存在 username 属性：\" + rootProject.project(\":sub2\").findProperty('username')\n\nrootProject.project(\":sub2\") {\n    ext {\n        username = \"Leo\"\n    }\n}\n\nprintln \"当前 sub2 是否存在 username 属性：\" + rootProject.project(\":sub2\").findProperty('username')\n```\n\n上面我们说到，在任何一个构建脚本中，都可以去配置其他项目，所以我们在 sub1 中往 sub2 添加一个变量，然后在 sub2 中将它打印出来：\n\n``` groovy\nprintln \"我的名字是 $project.ext.username\"\n```\n\n执行下：\n\n``` \nMyApplication init\n我直接运行\nMyApplication  end\nsub1 init\n当前 sub2 是否存在 username 属性：null\n当前 sub2 是否存在 username 属性：Leo\nsub1  end\nsub2 init\n我的名字是 Leo\nsub2  end\n我运行在 doLast\n```\n\n是不是非常有意思，要记住：**Gradle 边读取边解释，先评测项目配置，再执行相应的 Task.doLast**\n\n### 执行规则\n\nGradle 执行时，从当前执行的目录开始查看项目结构，即当前目录为根项目，根据目录下的 `setting.gradle` 去评估子项目的配置，执行相应的 Task，我们同样来看个例子：\n\n```\n.\n├── build.gradle\n├── config.gradle\n├── gradle\n│   └── wrapper\n│       ├── gradle-wrapper.jar\n│       └── gradle-wrapper.properties\n├── gradle.properties\n├── gradlew\n├── gradlew.bat\n├── settings.gradle\n├── sub1\n│   └── build.gradle\n└── sub2\n    ├── build.gradle\n    ├── settings.gradle\n    └── sub3\n        └── build.gradle\n```\n\n我们在 sub2 目录下创建一个新的目录 sub3，其中的 `build.gradle` 如下：\n\n``` groovy\nprintln \"rootProject is $rootProject.name\"\n```\n\n代码非常简单，就是输出当前根项目的名称。我们先在最外层的目录下，执行 `./gradlew` 输出如下：\n\n```\nrootProject is MyApplication\n```\n\n记得将 sub3 `include` 到 `settings.gradle` 可以看到当前的根项目名称即为当前运行的目录，接着我们切换到 sub2 目录下执行同样的命令，输出如下：\n\n```\nrootProject is sub2\n```\n\n### 执行顺序\n\n这里我们所说的执行顺序，包括两个方面，第一是项目的评测顺序，第二是各个项目 Task 的执行顺序。\n\n上面我们提到了项目评测顺序是，先评测根项目，接着按字母顺序评测子项目。那我们如果想改变默认顺序，又不想修改名称呢。Gradle 提供了 `evaluationDependsOn` 用于声明某个项目的评测依赖于其他项目的评测，所以会在依赖项目评测完成之后进行。在上面的例子中，sub1 默认会在 sub2 之前执行，但是如果我们在 sub1 项目中增加如下配置：\n\n``` groovy\nprintln \"$project.name init\"\n\nevaluationDependsOn(':sub2')\n\nprintln \"$project.name  end\"\n```\n\n执行 `./gradlew -q` 输出如下：\n\n``` \nsub1 init\nsub2 init\nsub2  end\nsub1  end\n```\n\n结合我们之前说到的，Gradle 是边读取边解释的，那么 `sub1 end` 在最后输出就不难理解了。\n\nGradle 还提供了 `evaluationDependsOnChildren` 声明子项目先于根项目进行评测。\n\nTask 也是类似的，Gradle 提供了 `dependsOn` 去声明某个 Task 依赖于其他 Task，所以会在依赖 Task 执行后执行。使用例子如下：\n\n``` groovy\ntask hello(dependsOn: ':project:task') {\n    \n}\n```\n\n### 项目解耦\n\nGradle 允许任何项目去访问当前多项目构建中其他项目，虽然这很灵活，但使用不当却会导致项目耦合程度高。\n\n例如，我们通过会在根项目中使用 `allprojects` 或者 `subprojects` 进行项目配置注入，但如果我们在子项目中去对其他项目进行配置注入，就会导致项目耦合。同时如果在子项目构建时，去更改其他项目的配置，这同样也会导致项目耦合，并且这两个操作都可能会影响到 **并行模式** 和 **按需配置** 的正确性。\n\n为了更好的使用配置注入和其他优化选项，我们应该：\n\n* 避免在子项目 `build.gradle` 引用其他子项目，更适合在根项目中进行配置注入\n* 避免在构建时更改其他的项目的配置\n\n### 多项目编译和测试\n\n在 Java 插件的 `build` task 通常是用于对单个项目进行编译、测试和应用代码格式化检查等等。在多项目中构建中你可能想要将 task 作用于指定范围内的项目，那么 `buildNeeded` 和 `buildDependents` task 可以帮助你。\n\n> 接下来的例子都是从官方文档中翻译而来的\n\n比如在这个[例子](https://docs.gradle.org/current/userguide/multi_project_builds.html#javadependencies_2)中，`:services:personservice` 项目依赖于 `:api` 和 `:shared` 项目，同时 `:api` 项目也依赖于 `:shared`。\n\n当我们执行 `./gradlew :api:build` 时，输出可能如下：\n\n``` \n> gradle :api:build\n> Task :shared:compileJava\n> Task :shared:processResources\n> Task :shared:classes\n> Task :shared:jar\n> Task :api:compileJava\n> Task :api:processResources\n> Task :api:classes\n> Task :api:jar\n> Task :api:assemble\n> Task :api:compileTestJava\n> Task :api:processTestResources\n> Task :api:testClasses\n> Task :api:test\n> Task :api:check\n> Task :api:build\n\nBUILD SUCCESSFUL in 0s\n9 actionable tasks: 9 executed\n```\n\n可以看到，当我们只执行 `:api` 项目的 `build` task，同时也会执行其依赖项目 `:shared` 部分的 task，如果我们确定对 `:api` 项目的修改不会影响 `:share` 项目，可以使用 `-a` 选项参数，这个参数可以让 Gradle 去缓存依赖项目生成的 jars，不重新去编译依赖项目，现在我们增加 `-a` 参数，`./gradlew -a :api:build`，输出可能如下：\n\n```\n> gradle -a :api:build\n> Task :api:compileJava\n> Task :api:processResources\n> Task :api:classes\n> Task :api:jar\n> Task :api:assemble\n> Task :api:compileTestJava\n> Task :api:processTestResources\n> Task :api:testClasses\n> Task :api:test\n> Task :api:check\n> Task :api:build\n\nBUILD SUCCESSFUL in 0s\n6 actionable tasks: 6 executed\n```\n\n可以看到 `-a` 选项起作用了。\n\n如果你刚刚从版本控制工具中更新了 `:api` 项目依赖的项目，你可能不仅仅想要只执行编译，可能想要去测试它们，那么 `buildNeeded` task 将测试所有依赖项目测试运行时的配置。执行 `./gradlew :api:buildNeeded`，可能输出如下：\n\n```\n> gradle :api:buildNeeded\n> Task :shared:compileJava\n> Task :shared:processResources\n> Task :shared:classes\n> Task :shared:jar\n> Task :api:compileJava\n> Task :api:processResources\n> Task :api:classes\n> Task :api:jar\n> Task :api:assemble\n> Task :api:compileTestJava\n> Task :api:processTestResources\n> Task :api:testClasses\n> Task :api:test\n> Task :api:check\n> Task :api:build\n> Task :shared:assemble\n> Task :shared:compileTestJava\n> Task :shared:processTestResources\n> Task :shared:testClasses\n> Task :shared:test\n> Task :shared:check\n> Task :shared:build\n> Task :shared:buildNeeded\n> Task :api:buildNeeded\n\nBUILD SUCCESSFUL in 0s\n12 actionable tasks: 12 executed\n```\n\n有时候你重构了 `:api` 的某些代码，想要测试依赖于 `:api` 项目的其他项目，那么可以使用 `buildDependents`，它可以测试编译依赖指定的项目的所有项目，运行 `./gradlew :api:buildDependents` 输出如下：\n\n``` \n> gradle :api:buildDependents\n> Task :shared:compileJava\n> Task :shared:processResources\n> Task :shared:classes\n> Task :shared:jar\n> Task :api:compileJava\n> Task :api:processResources\n> Task :api:classes\n> Task :api:jar\n> Task :api:assemble\n> Task :api:compileTestJava\n> Task :api:processTestResources\n> Task :api:testClasses\n> Task :api:test\n> Task :api:check\n> Task :api:build\n> Task :services:personService:compileJava\n> Task :services:personService:processResources\n> Task :services:personService:classes\n> Task :services:personService:jar\n> Task :services:personService:assemble\n> Task :services:personService:compileTestJava\n> Task :services:personService:processTestResources\n> Task :services:personService:testClasses\n> Task :services:personService:test\n> Task :services:personService:check\n> Task :services:personService:build\n> Task :services:personService:buildDependents\n> Task :api:buildDependents\n\nBUILD SUCCESSFUL in 0s\n17 actionable tasks: 17 executed\n```\n\n最后，如果你在根项目执行的任何 task 都会导致所有项目中存在同名的 task 的执行。\n\n### 属性和方法的继承\n\n在根项目中声明的属性和方法都会继承到子项目中，这是配置注入的替代方式。而配置注入不支持方法，\n\n### 其他选项\n\n#### 并行模式\n\n可以使用 `—parallel` 开启并行模式，这可以减少项目构建时间\n\n#### 按需配置\n\n可以使用 `--configure-on-demand` 开启按需配置，这同样可以减少构建配置时间\n\n## 总结\n\n在上面的篇幅我们着重讲解了 Gradle 对多项目构建的支持，包括跨项目配置，多项目的执行规则和执行顺序，配置注入等等。但理论知识毕竟只是纸上谈兵，下一篇文章会通过具体的项目配置，来讲解实际的使用。","source":"_posts/Gradle多项目构建.md","raw":"---\ntitle: Gradle多项目构建\ndate: 2018-04-29 09:57:51\ncategories: Gradle\ntags:\n---\n\n## 参考\n\n[multi_project_builds](https://docs.gradle.org/current/userguide/multi_project_builds.html)\n\n## 概述\n\n在使用 Android Studio 作为 IDE 之后，Android 项目就开始使用 Gradle 作为构建脚本，Gradle 的优点就不用我多说了，使用 Groovy 作为开发语言，配合各种 Gradle 插件和 DSL 可以实现多样化的构建过程。\n\nGradle 能讲的知识点很多，本文主要讲的是 Gradle 在多项目构建上提供的一些便捷的功能，希望能给大家一些启发。\n\n## 名词解释\n\n* 构建脚本：本文所说的构建脚本指的是 Gradle 文件，以 `.gradle` 为后缀的文件\n* 项目：在多项目构建中，有根项目和子项目。根项目的称呼是相对的，以执行 gradle 命令的目录为根项目，当前目录的子目录称为子项目\n\n## Gradle 多项目构建\n\n首先我们对 Gradle 多项目构建先做下了解，这里所涉及的知识点大部分来源于参考文档。\n\n### 跨项目配置\n\nGradle 提供了在任何构建脚本中访问任何项目，比如可以使用 `allprojects` 来对所有项目进行配置：\n\n``` groovy\nallprojects {\n    task hello {\n        doLast {\n            println \"Hello Gradle\"\n        }\n    }\n}\n```\n\n这个例子我们对所有项目都创建了一个叫 \"hello\" 的 task，如果你只是想对当前项目的子项目进行配置：\n\n``` groovy\nsubprojects {\n    task hello {\n        doLast {\n            println \"Hello Gradle\"\n        }\n    }\n}\n```\n\n当然你也可以针对单个项目进行配置：\n\n``` groovy\nproject (':project') {\n    task hello {\n        doLast {\n            println \"Hello Gradle\"\n        }\n    }\n}\n```\n\n上面所说的操作可以在任何一个构建脚本上执行，所以你可以选择统一写到单独的构建脚本上，再通过 `apply from: \"xxx.gradle\"` 应用进来。\n\n### 边读取边解释\n\n可能有的同学会问，为什么上面要用 doLast，可以不用 doLast，直接写可以吗？\n\n当前可以，但是执行的时机就不一样了，doLast 从字面意思来看，表示在最后执行，那么这个最后指的是什么之后呢。答案就是项目配置评测(evaluation)之后，简单来讲，当 Gradle 开始执行时，会先从根目录的 `settings.gradle` 中读取参与构建的项目，即只有将子项目 `include` 才能参与构建，接着 Gradle 会在每个项目的根目录下读取 `build.gradle` 如果存在的话，即 `build.gradle` 并不是必须的。默认情况下，Gradle 会先读取根项目的配置，即当你执行 Gradle 命令时所在目录的项目。接着按字母排序，读取子项目的配置，当项目配置评测完成之后，再执行对应的 task.doLast。\n\n那有的同学又会问了，那如果直接写，执行的顺序是什么呢？是在评测之后，doLast 之前吗？这可能是写习惯应用程序的同学最常见的误区了，之前博主也是这么想的，后来经过同事的点拨，**Gradle 是边读取边解释**，有点口语化，但确实如此，回到上面的问题，如果直接写在 task 的代码，会在 Gradle 读取到这一行的时候执行，即可能先于其他还没评测的项目执行，我们可以通过一个例子来看下：\n\n这是项目的目录结构：\n\n```\n├── build.gradle\n├── config.gradle\n├── gradle\n│   └── wrapper\n│       ├── gradle-wrapper.jar\n│       └── gradle-wrapper.properties\n├── gradle.properties\n├── gradlew\n├── gradlew.bat\n├── settings.gradle\n├── sub1\n│   └── build.gradle\n└── sub2\n    └── build.gradle\n```\n\n这里我们包含了两个子项目，分别是 `sub1` 和 `sub2`，在每个项目的 `build.gradle` 我们都加上 Log 打印：\n\n``` groovy\nprintln \"$project.name init\"\n\nprintln \"$project.name  end\"\n```\n\n接着我们在根项目的 `build.gradle` 即最外层目录下，添加一个 task：\n\n``` groovy\ntask hello {\n    println \"我直接运行\"\n    doLast {\n        println \"我运行在 doLast\"\n    }\n}\n```\n\n记得在根目录下执行 `./gradlew -q hello`，参数 `-q` 只打印我们的 log，结果如下：\n\n```\nMyApplication init\n我直接运行\nMyApplication  end\nsub1 init\nsub1 end\nsub2 init\nsub2  end\n我运行在 doLast\n```\n\n结果是不是和我们想的一样。接着我们在 sub1 的 `build.gradle` 中增加以下代码：\n\n``` groovy\nprintln \"当前 sub2 是否存在 username 属性：\" + rootProject.project(\":sub2\").findProperty('username')\n\nrootProject.project(\":sub2\") {\n    ext {\n        username = \"Leo\"\n    }\n}\n\nprintln \"当前 sub2 是否存在 username 属性：\" + rootProject.project(\":sub2\").findProperty('username')\n```\n\n上面我们说到，在任何一个构建脚本中，都可以去配置其他项目，所以我们在 sub1 中往 sub2 添加一个变量，然后在 sub2 中将它打印出来：\n\n``` groovy\nprintln \"我的名字是 $project.ext.username\"\n```\n\n执行下：\n\n``` \nMyApplication init\n我直接运行\nMyApplication  end\nsub1 init\n当前 sub2 是否存在 username 属性：null\n当前 sub2 是否存在 username 属性：Leo\nsub1  end\nsub2 init\n我的名字是 Leo\nsub2  end\n我运行在 doLast\n```\n\n是不是非常有意思，要记住：**Gradle 边读取边解释，先评测项目配置，再执行相应的 Task.doLast**\n\n### 执行规则\n\nGradle 执行时，从当前执行的目录开始查看项目结构，即当前目录为根项目，根据目录下的 `setting.gradle` 去评估子项目的配置，执行相应的 Task，我们同样来看个例子：\n\n```\n.\n├── build.gradle\n├── config.gradle\n├── gradle\n│   └── wrapper\n│       ├── gradle-wrapper.jar\n│       └── gradle-wrapper.properties\n├── gradle.properties\n├── gradlew\n├── gradlew.bat\n├── settings.gradle\n├── sub1\n│   └── build.gradle\n└── sub2\n    ├── build.gradle\n    ├── settings.gradle\n    └── sub3\n        └── build.gradle\n```\n\n我们在 sub2 目录下创建一个新的目录 sub3，其中的 `build.gradle` 如下：\n\n``` groovy\nprintln \"rootProject is $rootProject.name\"\n```\n\n代码非常简单，就是输出当前根项目的名称。我们先在最外层的目录下，执行 `./gradlew` 输出如下：\n\n```\nrootProject is MyApplication\n```\n\n记得将 sub3 `include` 到 `settings.gradle` 可以看到当前的根项目名称即为当前运行的目录，接着我们切换到 sub2 目录下执行同样的命令，输出如下：\n\n```\nrootProject is sub2\n```\n\n### 执行顺序\n\n这里我们所说的执行顺序，包括两个方面，第一是项目的评测顺序，第二是各个项目 Task 的执行顺序。\n\n上面我们提到了项目评测顺序是，先评测根项目，接着按字母顺序评测子项目。那我们如果想改变默认顺序，又不想修改名称呢。Gradle 提供了 `evaluationDependsOn` 用于声明某个项目的评测依赖于其他项目的评测，所以会在依赖项目评测完成之后进行。在上面的例子中，sub1 默认会在 sub2 之前执行，但是如果我们在 sub1 项目中增加如下配置：\n\n``` groovy\nprintln \"$project.name init\"\n\nevaluationDependsOn(':sub2')\n\nprintln \"$project.name  end\"\n```\n\n执行 `./gradlew -q` 输出如下：\n\n``` \nsub1 init\nsub2 init\nsub2  end\nsub1  end\n```\n\n结合我们之前说到的，Gradle 是边读取边解释的，那么 `sub1 end` 在最后输出就不难理解了。\n\nGradle 还提供了 `evaluationDependsOnChildren` 声明子项目先于根项目进行评测。\n\nTask 也是类似的，Gradle 提供了 `dependsOn` 去声明某个 Task 依赖于其他 Task，所以会在依赖 Task 执行后执行。使用例子如下：\n\n``` groovy\ntask hello(dependsOn: ':project:task') {\n    \n}\n```\n\n### 项目解耦\n\nGradle 允许任何项目去访问当前多项目构建中其他项目，虽然这很灵活，但使用不当却会导致项目耦合程度高。\n\n例如，我们通过会在根项目中使用 `allprojects` 或者 `subprojects` 进行项目配置注入，但如果我们在子项目中去对其他项目进行配置注入，就会导致项目耦合。同时如果在子项目构建时，去更改其他项目的配置，这同样也会导致项目耦合，并且这两个操作都可能会影响到 **并行模式** 和 **按需配置** 的正确性。\n\n为了更好的使用配置注入和其他优化选项，我们应该：\n\n* 避免在子项目 `build.gradle` 引用其他子项目，更适合在根项目中进行配置注入\n* 避免在构建时更改其他的项目的配置\n\n### 多项目编译和测试\n\n在 Java 插件的 `build` task 通常是用于对单个项目进行编译、测试和应用代码格式化检查等等。在多项目中构建中你可能想要将 task 作用于指定范围内的项目，那么 `buildNeeded` 和 `buildDependents` task 可以帮助你。\n\n> 接下来的例子都是从官方文档中翻译而来的\n\n比如在这个[例子](https://docs.gradle.org/current/userguide/multi_project_builds.html#javadependencies_2)中，`:services:personservice` 项目依赖于 `:api` 和 `:shared` 项目，同时 `:api` 项目也依赖于 `:shared`。\n\n当我们执行 `./gradlew :api:build` 时，输出可能如下：\n\n``` \n> gradle :api:build\n> Task :shared:compileJava\n> Task :shared:processResources\n> Task :shared:classes\n> Task :shared:jar\n> Task :api:compileJava\n> Task :api:processResources\n> Task :api:classes\n> Task :api:jar\n> Task :api:assemble\n> Task :api:compileTestJava\n> Task :api:processTestResources\n> Task :api:testClasses\n> Task :api:test\n> Task :api:check\n> Task :api:build\n\nBUILD SUCCESSFUL in 0s\n9 actionable tasks: 9 executed\n```\n\n可以看到，当我们只执行 `:api` 项目的 `build` task，同时也会执行其依赖项目 `:shared` 部分的 task，如果我们确定对 `:api` 项目的修改不会影响 `:share` 项目，可以使用 `-a` 选项参数，这个参数可以让 Gradle 去缓存依赖项目生成的 jars，不重新去编译依赖项目，现在我们增加 `-a` 参数，`./gradlew -a :api:build`，输出可能如下：\n\n```\n> gradle -a :api:build\n> Task :api:compileJava\n> Task :api:processResources\n> Task :api:classes\n> Task :api:jar\n> Task :api:assemble\n> Task :api:compileTestJava\n> Task :api:processTestResources\n> Task :api:testClasses\n> Task :api:test\n> Task :api:check\n> Task :api:build\n\nBUILD SUCCESSFUL in 0s\n6 actionable tasks: 6 executed\n```\n\n可以看到 `-a` 选项起作用了。\n\n如果你刚刚从版本控制工具中更新了 `:api` 项目依赖的项目，你可能不仅仅想要只执行编译，可能想要去测试它们，那么 `buildNeeded` task 将测试所有依赖项目测试运行时的配置。执行 `./gradlew :api:buildNeeded`，可能输出如下：\n\n```\n> gradle :api:buildNeeded\n> Task :shared:compileJava\n> Task :shared:processResources\n> Task :shared:classes\n> Task :shared:jar\n> Task :api:compileJava\n> Task :api:processResources\n> Task :api:classes\n> Task :api:jar\n> Task :api:assemble\n> Task :api:compileTestJava\n> Task :api:processTestResources\n> Task :api:testClasses\n> Task :api:test\n> Task :api:check\n> Task :api:build\n> Task :shared:assemble\n> Task :shared:compileTestJava\n> Task :shared:processTestResources\n> Task :shared:testClasses\n> Task :shared:test\n> Task :shared:check\n> Task :shared:build\n> Task :shared:buildNeeded\n> Task :api:buildNeeded\n\nBUILD SUCCESSFUL in 0s\n12 actionable tasks: 12 executed\n```\n\n有时候你重构了 `:api` 的某些代码，想要测试依赖于 `:api` 项目的其他项目，那么可以使用 `buildDependents`，它可以测试编译依赖指定的项目的所有项目，运行 `./gradlew :api:buildDependents` 输出如下：\n\n``` \n> gradle :api:buildDependents\n> Task :shared:compileJava\n> Task :shared:processResources\n> Task :shared:classes\n> Task :shared:jar\n> Task :api:compileJava\n> Task :api:processResources\n> Task :api:classes\n> Task :api:jar\n> Task :api:assemble\n> Task :api:compileTestJava\n> Task :api:processTestResources\n> Task :api:testClasses\n> Task :api:test\n> Task :api:check\n> Task :api:build\n> Task :services:personService:compileJava\n> Task :services:personService:processResources\n> Task :services:personService:classes\n> Task :services:personService:jar\n> Task :services:personService:assemble\n> Task :services:personService:compileTestJava\n> Task :services:personService:processTestResources\n> Task :services:personService:testClasses\n> Task :services:personService:test\n> Task :services:personService:check\n> Task :services:personService:build\n> Task :services:personService:buildDependents\n> Task :api:buildDependents\n\nBUILD SUCCESSFUL in 0s\n17 actionable tasks: 17 executed\n```\n\n最后，如果你在根项目执行的任何 task 都会导致所有项目中存在同名的 task 的执行。\n\n### 属性和方法的继承\n\n在根项目中声明的属性和方法都会继承到子项目中，这是配置注入的替代方式。而配置注入不支持方法，\n\n### 其他选项\n\n#### 并行模式\n\n可以使用 `—parallel` 开启并行模式，这可以减少项目构建时间\n\n#### 按需配置\n\n可以使用 `--configure-on-demand` 开启按需配置，这同样可以减少构建配置时间\n\n## 总结\n\n在上面的篇幅我们着重讲解了 Gradle 对多项目构建的支持，包括跨项目配置，多项目的执行规则和执行顺序，配置注入等等。但理论知识毕竟只是纸上谈兵，下一篇文章会通过具体的项目配置，来讲解实际的使用。","slug":"Gradle多项目构建","published":1,"updated":"2022-06-15T11:19:32.317Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrla0005fho6cvz9gngc","content":"<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"https://docs.gradle.org/current/userguide/multi_project_builds.html\">multi_project_builds</a></p>\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><p>在使用 Android Studio 作为 IDE 之后，Android 项目就开始使用 Gradle 作为构建脚本，Gradle 的优点就不用我多说了，使用 Groovy 作为开发语言，配合各种 Gradle 插件和 DSL 可以实现多样化的构建过程。</p>\n<p>Gradle 能讲的知识点很多，本文主要讲的是 Gradle 在多项目构建上提供的一些便捷的功能，希望能给大家一些启发。</p>\n<h2 id=\"名词解释\"><a href=\"#名词解释\" class=\"headerlink\" title=\"名词解释\"></a>名词解释</h2><ul>\n<li>构建脚本：本文所说的构建脚本指的是 Gradle 文件，以 <code>.gradle</code> 为后缀的文件</li>\n<li>项目：在多项目构建中，有根项目和子项目。根项目的称呼是相对的，以执行 gradle 命令的目录为根项目，当前目录的子目录称为子项目</li>\n</ul>\n<h2 id=\"Gradle-多项目构建\"><a href=\"#Gradle-多项目构建\" class=\"headerlink\" title=\"Gradle 多项目构建\"></a>Gradle 多项目构建</h2><p>首先我们对 Gradle 多项目构建先做下了解，这里所涉及的知识点大部分来源于参考文档。</p>\n<h3 id=\"跨项目配置\"><a href=\"#跨项目配置\" class=\"headerlink\" title=\"跨项目配置\"></a>跨项目配置</h3><p>Gradle 提供了在任何构建脚本中访问任何项目，比如可以使用 <code>allprojects</code> 来对所有项目进行配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">allprojects &#123;</span><br><span class=\"line\">    task hello &#123;</span><br><span class=\"line\">        doLast &#123;</span><br><span class=\"line\">            println <span class=\"string\">&quot;Hello Gradle&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这个例子我们对所有项目都创建了一个叫 “hello” 的 task，如果你只是想对当前项目的子项目进行配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">subprojects &#123;</span><br><span class=\"line\">    task hello &#123;</span><br><span class=\"line\">        doLast &#123;</span><br><span class=\"line\">            println <span class=\"string\">&quot;Hello Gradle&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>当然你也可以针对单个项目进行配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project (<span class=\"string\">&#x27;:project&#x27;</span>) &#123;</span><br><span class=\"line\">    task hello &#123;</span><br><span class=\"line\">        doLast &#123;</span><br><span class=\"line\">            println <span class=\"string\">&quot;Hello Gradle&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>上面所说的操作可以在任何一个构建脚本上执行，所以你可以选择统一写到单独的构建脚本上，再通过 <code>apply from: &quot;xxx.gradle&quot;</code> 应用进来。</p>\n<h3 id=\"边读取边解释\"><a href=\"#边读取边解释\" class=\"headerlink\" title=\"边读取边解释\"></a>边读取边解释</h3><p>可能有的同学会问，为什么上面要用 doLast，可以不用 doLast，直接写可以吗？</p>\n<p>当前可以，但是执行的时机就不一样了，doLast 从字面意思来看，表示在最后执行，那么这个最后指的是什么之后呢。答案就是项目配置评测(evaluation)之后，简单来讲，当 Gradle 开始执行时，会先从根目录的 <code>settings.gradle</code> 中读取参与构建的项目，即只有将子项目 <code>include</code> 才能参与构建，接着 Gradle 会在每个项目的根目录下读取 <code>build.gradle</code> 如果存在的话，即 <code>build.gradle</code> 并不是必须的。默认情况下，Gradle 会先读取根项目的配置，即当你执行 Gradle 命令时所在目录的项目。接着按字母排序，读取子项目的配置，当项目配置评测完成之后，再执行对应的 task.doLast。</p>\n<p>那有的同学又会问了，那如果直接写，执行的顺序是什么呢？是在评测之后，doLast 之前吗？这可能是写习惯应用程序的同学最常见的误区了，之前博主也是这么想的，后来经过同事的点拨，<strong>Gradle 是边读取边解释</strong>，有点口语化，但确实如此，回到上面的问题，如果直接写在 task 的代码，会在 Gradle 读取到这一行的时候执行，即可能先于其他还没评测的项目执行，我们可以通过一个例子来看下：</p>\n<p>这是项目的目录结构：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── build.gradle</span><br><span class=\"line\">├── config.gradle</span><br><span class=\"line\">├── gradle</span><br><span class=\"line\">│   └── wrapper</span><br><span class=\"line\">│       ├── gradle-wrapper.jar</span><br><span class=\"line\">│       └── gradle-wrapper.properties</span><br><span class=\"line\">├── gradle.properties</span><br><span class=\"line\">├── gradlew</span><br><span class=\"line\">├── gradlew.bat</span><br><span class=\"line\">├── settings.gradle</span><br><span class=\"line\">├── sub1</span><br><span class=\"line\">│   └── build.gradle</span><br><span class=\"line\">└── sub2</span><br><span class=\"line\">    └── build.gradle</span><br></pre></td></tr></table></figure>\n\n<p>这里我们包含了两个子项目，分别是 <code>sub1</code> 和 <code>sub2</code>，在每个项目的 <code>build.gradle</code> 我们都加上 Log 打印：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">println <span class=\"string\">&quot;$project.name init&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">println <span class=\"string\">&quot;$project.name  end&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>接着我们在根项目的 <code>build.gradle</code> 即最外层目录下，添加一个 task：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">task hello &#123;</span><br><span class=\"line\">    println <span class=\"string\">&quot;我直接运行&quot;</span></span><br><span class=\"line\">    doLast &#123;</span><br><span class=\"line\">        println <span class=\"string\">&quot;我运行在 doLast&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>记得在根目录下执行 <code>./gradlew -q hello</code>，参数 <code>-q</code> 只打印我们的 log，结果如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MyApplication init</span><br><span class=\"line\">我直接运行</span><br><span class=\"line\">MyApplication  end</span><br><span class=\"line\">sub1 init</span><br><span class=\"line\">sub1 end</span><br><span class=\"line\">sub2 init</span><br><span class=\"line\">sub2  end</span><br><span class=\"line\">我运行在 doLast</span><br></pre></td></tr></table></figure>\n\n<p>结果是不是和我们想的一样。接着我们在 sub1 的 <code>build.gradle</code> 中增加以下代码：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">println <span class=\"string\">&quot;当前 sub2 是否存在 username 属性：&quot;</span> + rootProject.project(<span class=\"string\">&quot;:sub2&quot;</span>).findProperty(<span class=\"string\">&#x27;username&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">rootProject.project(<span class=\"string\">&quot;:sub2&quot;</span>) &#123;</span><br><span class=\"line\">    ext &#123;</span><br><span class=\"line\">        username = <span class=\"string\">&quot;Leo&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">println <span class=\"string\">&quot;当前 sub2 是否存在 username 属性：&quot;</span> + rootProject.project(<span class=\"string\">&quot;:sub2&quot;</span>).findProperty(<span class=\"string\">&#x27;username&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>上面我们说到，在任何一个构建脚本中，都可以去配置其他项目，所以我们在 sub1 中往 sub2 添加一个变量，然后在 sub2 中将它打印出来：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">println <span class=\"string\">&quot;我的名字是 $project.ext.username&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>执行下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MyApplication init</span><br><span class=\"line\">我直接运行</span><br><span class=\"line\">MyApplication  end</span><br><span class=\"line\">sub1 init</span><br><span class=\"line\">当前 sub2 是否存在 username 属性：null</span><br><span class=\"line\">当前 sub2 是否存在 username 属性：Leo</span><br><span class=\"line\">sub1  end</span><br><span class=\"line\">sub2 init</span><br><span class=\"line\">我的名字是 Leo</span><br><span class=\"line\">sub2  end</span><br><span class=\"line\">我运行在 doLast</span><br></pre></td></tr></table></figure>\n\n<p>是不是非常有意思，要记住：<strong>Gradle 边读取边解释，先评测项目配置，再执行相应的 Task.doLast</strong></p>\n<h3 id=\"执行规则\"><a href=\"#执行规则\" class=\"headerlink\" title=\"执行规则\"></a>执行规则</h3><p>Gradle 执行时，从当前执行的目录开始查看项目结构，即当前目录为根项目，根据目录下的 <code>setting.gradle</code> 去评估子项目的配置，执行相应的 Task，我们同样来看个例子：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.</span><br><span class=\"line\">├── build.gradle</span><br><span class=\"line\">├── config.gradle</span><br><span class=\"line\">├── gradle</span><br><span class=\"line\">│   └── wrapper</span><br><span class=\"line\">│       ├── gradle-wrapper.jar</span><br><span class=\"line\">│       └── gradle-wrapper.properties</span><br><span class=\"line\">├── gradle.properties</span><br><span class=\"line\">├── gradlew</span><br><span class=\"line\">├── gradlew.bat</span><br><span class=\"line\">├── settings.gradle</span><br><span class=\"line\">├── sub1</span><br><span class=\"line\">│   └── build.gradle</span><br><span class=\"line\">└── sub2</span><br><span class=\"line\">    ├── build.gradle</span><br><span class=\"line\">    ├── settings.gradle</span><br><span class=\"line\">    └── sub3</span><br><span class=\"line\">        └── build.gradle</span><br></pre></td></tr></table></figure>\n\n<p>我们在 sub2 目录下创建一个新的目录 sub3，其中的 <code>build.gradle</code> 如下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">println <span class=\"string\">&quot;rootProject is $rootProject.name&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>代码非常简单，就是输出当前根项目的名称。我们先在最外层的目录下，执行 <code>./gradlew</code> 输出如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rootProject is MyApplication</span><br></pre></td></tr></table></figure>\n\n<p>记得将 sub3 <code>include</code> 到 <code>settings.gradle</code> 可以看到当前的根项目名称即为当前运行的目录，接着我们切换到 sub2 目录下执行同样的命令，输出如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rootProject is sub2</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"执行顺序\"><a href=\"#执行顺序\" class=\"headerlink\" title=\"执行顺序\"></a>执行顺序</h3><p>这里我们所说的执行顺序，包括两个方面，第一是项目的评测顺序，第二是各个项目 Task 的执行顺序。</p>\n<p>上面我们提到了项目评测顺序是，先评测根项目，接着按字母顺序评测子项目。那我们如果想改变默认顺序，又不想修改名称呢。Gradle 提供了 <code>evaluationDependsOn</code> 用于声明某个项目的评测依赖于其他项目的评测，所以会在依赖项目评测完成之后进行。在上面的例子中，sub1 默认会在 sub2 之前执行，但是如果我们在 sub1 项目中增加如下配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">println <span class=\"string\">&quot;$project.name init&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">evaluationDependsOn(<span class=\"string\">&#x27;:sub2&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">println <span class=\"string\">&quot;$project.name  end&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>执行 <code>./gradlew -q</code> 输出如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sub1 init</span><br><span class=\"line\">sub2 init</span><br><span class=\"line\">sub2  end</span><br><span class=\"line\">sub1  end</span><br></pre></td></tr></table></figure>\n\n<p>结合我们之前说到的，Gradle 是边读取边解释的，那么 <code>sub1 end</code> 在最后输出就不难理解了。</p>\n<p>Gradle 还提供了 <code>evaluationDependsOnChildren</code> 声明子项目先于根项目进行评测。</p>\n<p>Task 也是类似的，Gradle 提供了 <code>dependsOn</code> 去声明某个 Task 依赖于其他 Task，所以会在依赖 Task 执行后执行。使用例子如下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">task hello(<span class=\"attr\">dependsOn:</span> <span class=\"string\">&#x27;:project:task&#x27;</span>) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"项目解耦\"><a href=\"#项目解耦\" class=\"headerlink\" title=\"项目解耦\"></a>项目解耦</h3><p>Gradle 允许任何项目去访问当前多项目构建中其他项目，虽然这很灵活，但使用不当却会导致项目耦合程度高。</p>\n<p>例如，我们通过会在根项目中使用 <code>allprojects</code> 或者 <code>subprojects</code> 进行项目配置注入，但如果我们在子项目中去对其他项目进行配置注入，就会导致项目耦合。同时如果在子项目构建时，去更改其他项目的配置，这同样也会导致项目耦合，并且这两个操作都可能会影响到 <strong>并行模式</strong> 和 <strong>按需配置</strong> 的正确性。</p>\n<p>为了更好的使用配置注入和其他优化选项，我们应该：</p>\n<ul>\n<li>避免在子项目 <code>build.gradle</code> 引用其他子项目，更适合在根项目中进行配置注入</li>\n<li>避免在构建时更改其他的项目的配置</li>\n</ul>\n<h3 id=\"多项目编译和测试\"><a href=\"#多项目编译和测试\" class=\"headerlink\" title=\"多项目编译和测试\"></a>多项目编译和测试</h3><p>在 Java 插件的 <code>build</code> task 通常是用于对单个项目进行编译、测试和应用代码格式化检查等等。在多项目中构建中你可能想要将 task 作用于指定范围内的项目，那么 <code>buildNeeded</code> 和 <code>buildDependents</code> task 可以帮助你。</p>\n<blockquote>\n<p>接下来的例子都是从官方文档中翻译而来的</p>\n</blockquote>\n<p>比如在这个<a href=\"https://docs.gradle.org/current/userguide/multi_project_builds.html#javadependencies_2\">例子</a>中，<code>:services:personservice</code> 项目依赖于 <code>:api</code> 和 <code>:shared</code> 项目，同时 <code>:api</code> 项目也依赖于 <code>:shared</code>。</p>\n<p>当我们执行 <code>./gradlew :api:build</code> 时，输出可能如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; gradle :api:build</span><br><span class=\"line\">&gt; Task :shared:compileJava</span><br><span class=\"line\">&gt; Task :shared:processResources</span><br><span class=\"line\">&gt; Task :shared:classes</span><br><span class=\"line\">&gt; Task :shared:jar</span><br><span class=\"line\">&gt; Task :api:compileJava</span><br><span class=\"line\">&gt; Task :api:processResources</span><br><span class=\"line\">&gt; Task :api:classes</span><br><span class=\"line\">&gt; Task :api:jar</span><br><span class=\"line\">&gt; Task :api:assemble</span><br><span class=\"line\">&gt; Task :api:compileTestJava</span><br><span class=\"line\">&gt; Task :api:processTestResources</span><br><span class=\"line\">&gt; Task :api:testClasses</span><br><span class=\"line\">&gt; Task :api:test</span><br><span class=\"line\">&gt; Task :api:check</span><br><span class=\"line\">&gt; Task :api:build</span><br><span class=\"line\"></span><br><span class=\"line\">BUILD SUCCESSFUL in 0s</span><br><span class=\"line\">9 actionable tasks: 9 executed</span><br></pre></td></tr></table></figure>\n\n<p>可以看到，当我们只执行 <code>:api</code> 项目的 <code>build</code> task，同时也会执行其依赖项目 <code>:shared</code> 部分的 task，如果我们确定对 <code>:api</code> 项目的修改不会影响 <code>:share</code> 项目，可以使用 <code>-a</code> 选项参数，这个参数可以让 Gradle 去缓存依赖项目生成的 jars，不重新去编译依赖项目，现在我们增加 <code>-a</code> 参数，<code>./gradlew -a :api:build</code>，输出可能如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; gradle -a :api:build</span><br><span class=\"line\">&gt; Task :api:compileJava</span><br><span class=\"line\">&gt; Task :api:processResources</span><br><span class=\"line\">&gt; Task :api:classes</span><br><span class=\"line\">&gt; Task :api:jar</span><br><span class=\"line\">&gt; Task :api:assemble</span><br><span class=\"line\">&gt; Task :api:compileTestJava</span><br><span class=\"line\">&gt; Task :api:processTestResources</span><br><span class=\"line\">&gt; Task :api:testClasses</span><br><span class=\"line\">&gt; Task :api:test</span><br><span class=\"line\">&gt; Task :api:check</span><br><span class=\"line\">&gt; Task :api:build</span><br><span class=\"line\"></span><br><span class=\"line\">BUILD SUCCESSFUL in 0s</span><br><span class=\"line\">6 actionable tasks: 6 executed</span><br></pre></td></tr></table></figure>\n\n<p>可以看到 <code>-a</code> 选项起作用了。</p>\n<p>如果你刚刚从版本控制工具中更新了 <code>:api</code> 项目依赖的项目，你可能不仅仅想要只执行编译，可能想要去测试它们，那么 <code>buildNeeded</code> task 将测试所有依赖项目测试运行时的配置。执行 <code>./gradlew :api:buildNeeded</code>，可能输出如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; gradle :api:buildNeeded</span><br><span class=\"line\">&gt; Task :shared:compileJava</span><br><span class=\"line\">&gt; Task :shared:processResources</span><br><span class=\"line\">&gt; Task :shared:classes</span><br><span class=\"line\">&gt; Task :shared:jar</span><br><span class=\"line\">&gt; Task :api:compileJava</span><br><span class=\"line\">&gt; Task :api:processResources</span><br><span class=\"line\">&gt; Task :api:classes</span><br><span class=\"line\">&gt; Task :api:jar</span><br><span class=\"line\">&gt; Task :api:assemble</span><br><span class=\"line\">&gt; Task :api:compileTestJava</span><br><span class=\"line\">&gt; Task :api:processTestResources</span><br><span class=\"line\">&gt; Task :api:testClasses</span><br><span class=\"line\">&gt; Task :api:test</span><br><span class=\"line\">&gt; Task :api:check</span><br><span class=\"line\">&gt; Task :api:build</span><br><span class=\"line\">&gt; Task :shared:assemble</span><br><span class=\"line\">&gt; Task :shared:compileTestJava</span><br><span class=\"line\">&gt; Task :shared:processTestResources</span><br><span class=\"line\">&gt; Task :shared:testClasses</span><br><span class=\"line\">&gt; Task :shared:test</span><br><span class=\"line\">&gt; Task :shared:check</span><br><span class=\"line\">&gt; Task :shared:build</span><br><span class=\"line\">&gt; Task :shared:buildNeeded</span><br><span class=\"line\">&gt; Task :api:buildNeeded</span><br><span class=\"line\"></span><br><span class=\"line\">BUILD SUCCESSFUL in 0s</span><br><span class=\"line\">12 actionable tasks: 12 executed</span><br></pre></td></tr></table></figure>\n\n<p>有时候你重构了 <code>:api</code> 的某些代码，想要测试依赖于 <code>:api</code> 项目的其他项目，那么可以使用 <code>buildDependents</code>，它可以测试编译依赖指定的项目的所有项目，运行 <code>./gradlew :api:buildDependents</code> 输出如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; gradle :api:buildDependents</span><br><span class=\"line\">&gt; Task :shared:compileJava</span><br><span class=\"line\">&gt; Task :shared:processResources</span><br><span class=\"line\">&gt; Task :shared:classes</span><br><span class=\"line\">&gt; Task :shared:jar</span><br><span class=\"line\">&gt; Task :api:compileJava</span><br><span class=\"line\">&gt; Task :api:processResources</span><br><span class=\"line\">&gt; Task :api:classes</span><br><span class=\"line\">&gt; Task :api:jar</span><br><span class=\"line\">&gt; Task :api:assemble</span><br><span class=\"line\">&gt; Task :api:compileTestJava</span><br><span class=\"line\">&gt; Task :api:processTestResources</span><br><span class=\"line\">&gt; Task :api:testClasses</span><br><span class=\"line\">&gt; Task :api:test</span><br><span class=\"line\">&gt; Task :api:check</span><br><span class=\"line\">&gt; Task :api:build</span><br><span class=\"line\">&gt; Task :services:personService:compileJava</span><br><span class=\"line\">&gt; Task :services:personService:processResources</span><br><span class=\"line\">&gt; Task :services:personService:classes</span><br><span class=\"line\">&gt; Task :services:personService:jar</span><br><span class=\"line\">&gt; Task :services:personService:assemble</span><br><span class=\"line\">&gt; Task :services:personService:compileTestJava</span><br><span class=\"line\">&gt; Task :services:personService:processTestResources</span><br><span class=\"line\">&gt; Task :services:personService:testClasses</span><br><span class=\"line\">&gt; Task :services:personService:test</span><br><span class=\"line\">&gt; Task :services:personService:check</span><br><span class=\"line\">&gt; Task :services:personService:build</span><br><span class=\"line\">&gt; Task :services:personService:buildDependents</span><br><span class=\"line\">&gt; Task :api:buildDependents</span><br><span class=\"line\"></span><br><span class=\"line\">BUILD SUCCESSFUL in 0s</span><br><span class=\"line\">17 actionable tasks: 17 executed</span><br></pre></td></tr></table></figure>\n\n<p>最后，如果你在根项目执行的任何 task 都会导致所有项目中存在同名的 task 的执行。</p>\n<h3 id=\"属性和方法的继承\"><a href=\"#属性和方法的继承\" class=\"headerlink\" title=\"属性和方法的继承\"></a>属性和方法的继承</h3><p>在根项目中声明的属性和方法都会继承到子项目中，这是配置注入的替代方式。而配置注入不支持方法，</p>\n<h3 id=\"其他选项\"><a href=\"#其他选项\" class=\"headerlink\" title=\"其他选项\"></a>其他选项</h3><h4 id=\"并行模式\"><a href=\"#并行模式\" class=\"headerlink\" title=\"并行模式\"></a>并行模式</h4><p>可以使用 <code>—parallel</code> 开启并行模式，这可以减少项目构建时间</p>\n<h4 id=\"按需配置\"><a href=\"#按需配置\" class=\"headerlink\" title=\"按需配置\"></a>按需配置</h4><p>可以使用 <code>--configure-on-demand</code> 开启按需配置，这同样可以减少构建配置时间</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>在上面的篇幅我们着重讲解了 Gradle 对多项目构建的支持，包括跨项目配置，多项目的执行规则和执行顺序，配置注入等等。但理论知识毕竟只是纸上谈兵，下一篇文章会通过具体的项目配置，来讲解实际的使用。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"https://docs.gradle.org/current/userguide/multi_project_builds.html\">multi_project_builds</a></p>\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><p>在使用 Android Studio 作为 IDE 之后，Android 项目就开始使用 Gradle 作为构建脚本，Gradle 的优点就不用我多说了，使用 Groovy 作为开发语言，配合各种 Gradle 插件和 DSL 可以实现多样化的构建过程。</p>\n<p>Gradle 能讲的知识点很多，本文主要讲的是 Gradle 在多项目构建上提供的一些便捷的功能，希望能给大家一些启发。</p>\n<h2 id=\"名词解释\"><a href=\"#名词解释\" class=\"headerlink\" title=\"名词解释\"></a>名词解释</h2><ul>\n<li>构建脚本：本文所说的构建脚本指的是 Gradle 文件，以 <code>.gradle</code> 为后缀的文件</li>\n<li>项目：在多项目构建中，有根项目和子项目。根项目的称呼是相对的，以执行 gradle 命令的目录为根项目，当前目录的子目录称为子项目</li>\n</ul>\n<h2 id=\"Gradle-多项目构建\"><a href=\"#Gradle-多项目构建\" class=\"headerlink\" title=\"Gradle 多项目构建\"></a>Gradle 多项目构建</h2><p>首先我们对 Gradle 多项目构建先做下了解，这里所涉及的知识点大部分来源于参考文档。</p>\n<h3 id=\"跨项目配置\"><a href=\"#跨项目配置\" class=\"headerlink\" title=\"跨项目配置\"></a>跨项目配置</h3><p>Gradle 提供了在任何构建脚本中访问任何项目，比如可以使用 <code>allprojects</code> 来对所有项目进行配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">allprojects &#123;</span><br><span class=\"line\">    task hello &#123;</span><br><span class=\"line\">        doLast &#123;</span><br><span class=\"line\">            println <span class=\"string\">&quot;Hello Gradle&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这个例子我们对所有项目都创建了一个叫 “hello” 的 task，如果你只是想对当前项目的子项目进行配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">subprojects &#123;</span><br><span class=\"line\">    task hello &#123;</span><br><span class=\"line\">        doLast &#123;</span><br><span class=\"line\">            println <span class=\"string\">&quot;Hello Gradle&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>当然你也可以针对单个项目进行配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project (<span class=\"string\">&#x27;:project&#x27;</span>) &#123;</span><br><span class=\"line\">    task hello &#123;</span><br><span class=\"line\">        doLast &#123;</span><br><span class=\"line\">            println <span class=\"string\">&quot;Hello Gradle&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>上面所说的操作可以在任何一个构建脚本上执行，所以你可以选择统一写到单独的构建脚本上，再通过 <code>apply from: &quot;xxx.gradle&quot;</code> 应用进来。</p>\n<h3 id=\"边读取边解释\"><a href=\"#边读取边解释\" class=\"headerlink\" title=\"边读取边解释\"></a>边读取边解释</h3><p>可能有的同学会问，为什么上面要用 doLast，可以不用 doLast，直接写可以吗？</p>\n<p>当前可以，但是执行的时机就不一样了，doLast 从字面意思来看，表示在最后执行，那么这个最后指的是什么之后呢。答案就是项目配置评测(evaluation)之后，简单来讲，当 Gradle 开始执行时，会先从根目录的 <code>settings.gradle</code> 中读取参与构建的项目，即只有将子项目 <code>include</code> 才能参与构建，接着 Gradle 会在每个项目的根目录下读取 <code>build.gradle</code> 如果存在的话，即 <code>build.gradle</code> 并不是必须的。默认情况下，Gradle 会先读取根项目的配置，即当你执行 Gradle 命令时所在目录的项目。接着按字母排序，读取子项目的配置，当项目配置评测完成之后，再执行对应的 task.doLast。</p>\n<p>那有的同学又会问了，那如果直接写，执行的顺序是什么呢？是在评测之后，doLast 之前吗？这可能是写习惯应用程序的同学最常见的误区了，之前博主也是这么想的，后来经过同事的点拨，<strong>Gradle 是边读取边解释</strong>，有点口语化，但确实如此，回到上面的问题，如果直接写在 task 的代码，会在 Gradle 读取到这一行的时候执行，即可能先于其他还没评测的项目执行，我们可以通过一个例子来看下：</p>\n<p>这是项目的目录结构：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── build.gradle</span><br><span class=\"line\">├── config.gradle</span><br><span class=\"line\">├── gradle</span><br><span class=\"line\">│   └── wrapper</span><br><span class=\"line\">│       ├── gradle-wrapper.jar</span><br><span class=\"line\">│       └── gradle-wrapper.properties</span><br><span class=\"line\">├── gradle.properties</span><br><span class=\"line\">├── gradlew</span><br><span class=\"line\">├── gradlew.bat</span><br><span class=\"line\">├── settings.gradle</span><br><span class=\"line\">├── sub1</span><br><span class=\"line\">│   └── build.gradle</span><br><span class=\"line\">└── sub2</span><br><span class=\"line\">    └── build.gradle</span><br></pre></td></tr></table></figure>\n\n<p>这里我们包含了两个子项目，分别是 <code>sub1</code> 和 <code>sub2</code>，在每个项目的 <code>build.gradle</code> 我们都加上 Log 打印：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">println <span class=\"string\">&quot;$project.name init&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">println <span class=\"string\">&quot;$project.name  end&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>接着我们在根项目的 <code>build.gradle</code> 即最外层目录下，添加一个 task：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">task hello &#123;</span><br><span class=\"line\">    println <span class=\"string\">&quot;我直接运行&quot;</span></span><br><span class=\"line\">    doLast &#123;</span><br><span class=\"line\">        println <span class=\"string\">&quot;我运行在 doLast&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>记得在根目录下执行 <code>./gradlew -q hello</code>，参数 <code>-q</code> 只打印我们的 log，结果如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MyApplication init</span><br><span class=\"line\">我直接运行</span><br><span class=\"line\">MyApplication  end</span><br><span class=\"line\">sub1 init</span><br><span class=\"line\">sub1 end</span><br><span class=\"line\">sub2 init</span><br><span class=\"line\">sub2  end</span><br><span class=\"line\">我运行在 doLast</span><br></pre></td></tr></table></figure>\n\n<p>结果是不是和我们想的一样。接着我们在 sub1 的 <code>build.gradle</code> 中增加以下代码：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">println <span class=\"string\">&quot;当前 sub2 是否存在 username 属性：&quot;</span> + rootProject.project(<span class=\"string\">&quot;:sub2&quot;</span>).findProperty(<span class=\"string\">&#x27;username&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">rootProject.project(<span class=\"string\">&quot;:sub2&quot;</span>) &#123;</span><br><span class=\"line\">    ext &#123;</span><br><span class=\"line\">        username = <span class=\"string\">&quot;Leo&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">println <span class=\"string\">&quot;当前 sub2 是否存在 username 属性：&quot;</span> + rootProject.project(<span class=\"string\">&quot;:sub2&quot;</span>).findProperty(<span class=\"string\">&#x27;username&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>上面我们说到，在任何一个构建脚本中，都可以去配置其他项目，所以我们在 sub1 中往 sub2 添加一个变量，然后在 sub2 中将它打印出来：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">println <span class=\"string\">&quot;我的名字是 $project.ext.username&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>执行下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MyApplication init</span><br><span class=\"line\">我直接运行</span><br><span class=\"line\">MyApplication  end</span><br><span class=\"line\">sub1 init</span><br><span class=\"line\">当前 sub2 是否存在 username 属性：null</span><br><span class=\"line\">当前 sub2 是否存在 username 属性：Leo</span><br><span class=\"line\">sub1  end</span><br><span class=\"line\">sub2 init</span><br><span class=\"line\">我的名字是 Leo</span><br><span class=\"line\">sub2  end</span><br><span class=\"line\">我运行在 doLast</span><br></pre></td></tr></table></figure>\n\n<p>是不是非常有意思，要记住：<strong>Gradle 边读取边解释，先评测项目配置，再执行相应的 Task.doLast</strong></p>\n<h3 id=\"执行规则\"><a href=\"#执行规则\" class=\"headerlink\" title=\"执行规则\"></a>执行规则</h3><p>Gradle 执行时，从当前执行的目录开始查看项目结构，即当前目录为根项目，根据目录下的 <code>setting.gradle</code> 去评估子项目的配置，执行相应的 Task，我们同样来看个例子：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.</span><br><span class=\"line\">├── build.gradle</span><br><span class=\"line\">├── config.gradle</span><br><span class=\"line\">├── gradle</span><br><span class=\"line\">│   └── wrapper</span><br><span class=\"line\">│       ├── gradle-wrapper.jar</span><br><span class=\"line\">│       └── gradle-wrapper.properties</span><br><span class=\"line\">├── gradle.properties</span><br><span class=\"line\">├── gradlew</span><br><span class=\"line\">├── gradlew.bat</span><br><span class=\"line\">├── settings.gradle</span><br><span class=\"line\">├── sub1</span><br><span class=\"line\">│   └── build.gradle</span><br><span class=\"line\">└── sub2</span><br><span class=\"line\">    ├── build.gradle</span><br><span class=\"line\">    ├── settings.gradle</span><br><span class=\"line\">    └── sub3</span><br><span class=\"line\">        └── build.gradle</span><br></pre></td></tr></table></figure>\n\n<p>我们在 sub2 目录下创建一个新的目录 sub3，其中的 <code>build.gradle</code> 如下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">println <span class=\"string\">&quot;rootProject is $rootProject.name&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>代码非常简单，就是输出当前根项目的名称。我们先在最外层的目录下，执行 <code>./gradlew</code> 输出如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rootProject is MyApplication</span><br></pre></td></tr></table></figure>\n\n<p>记得将 sub3 <code>include</code> 到 <code>settings.gradle</code> 可以看到当前的根项目名称即为当前运行的目录，接着我们切换到 sub2 目录下执行同样的命令，输出如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rootProject is sub2</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"执行顺序\"><a href=\"#执行顺序\" class=\"headerlink\" title=\"执行顺序\"></a>执行顺序</h3><p>这里我们所说的执行顺序，包括两个方面，第一是项目的评测顺序，第二是各个项目 Task 的执行顺序。</p>\n<p>上面我们提到了项目评测顺序是，先评测根项目，接着按字母顺序评测子项目。那我们如果想改变默认顺序，又不想修改名称呢。Gradle 提供了 <code>evaluationDependsOn</code> 用于声明某个项目的评测依赖于其他项目的评测，所以会在依赖项目评测完成之后进行。在上面的例子中，sub1 默认会在 sub2 之前执行，但是如果我们在 sub1 项目中增加如下配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">println <span class=\"string\">&quot;$project.name init&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">evaluationDependsOn(<span class=\"string\">&#x27;:sub2&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">println <span class=\"string\">&quot;$project.name  end&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>执行 <code>./gradlew -q</code> 输出如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sub1 init</span><br><span class=\"line\">sub2 init</span><br><span class=\"line\">sub2  end</span><br><span class=\"line\">sub1  end</span><br></pre></td></tr></table></figure>\n\n<p>结合我们之前说到的，Gradle 是边读取边解释的，那么 <code>sub1 end</code> 在最后输出就不难理解了。</p>\n<p>Gradle 还提供了 <code>evaluationDependsOnChildren</code> 声明子项目先于根项目进行评测。</p>\n<p>Task 也是类似的，Gradle 提供了 <code>dependsOn</code> 去声明某个 Task 依赖于其他 Task，所以会在依赖 Task 执行后执行。使用例子如下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">task hello(<span class=\"attr\">dependsOn:</span> <span class=\"string\">&#x27;:project:task&#x27;</span>) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"项目解耦\"><a href=\"#项目解耦\" class=\"headerlink\" title=\"项目解耦\"></a>项目解耦</h3><p>Gradle 允许任何项目去访问当前多项目构建中其他项目，虽然这很灵活，但使用不当却会导致项目耦合程度高。</p>\n<p>例如，我们通过会在根项目中使用 <code>allprojects</code> 或者 <code>subprojects</code> 进行项目配置注入，但如果我们在子项目中去对其他项目进行配置注入，就会导致项目耦合。同时如果在子项目构建时，去更改其他项目的配置，这同样也会导致项目耦合，并且这两个操作都可能会影响到 <strong>并行模式</strong> 和 <strong>按需配置</strong> 的正确性。</p>\n<p>为了更好的使用配置注入和其他优化选项，我们应该：</p>\n<ul>\n<li>避免在子项目 <code>build.gradle</code> 引用其他子项目，更适合在根项目中进行配置注入</li>\n<li>避免在构建时更改其他的项目的配置</li>\n</ul>\n<h3 id=\"多项目编译和测试\"><a href=\"#多项目编译和测试\" class=\"headerlink\" title=\"多项目编译和测试\"></a>多项目编译和测试</h3><p>在 Java 插件的 <code>build</code> task 通常是用于对单个项目进行编译、测试和应用代码格式化检查等等。在多项目中构建中你可能想要将 task 作用于指定范围内的项目，那么 <code>buildNeeded</code> 和 <code>buildDependents</code> task 可以帮助你。</p>\n<blockquote>\n<p>接下来的例子都是从官方文档中翻译而来的</p>\n</blockquote>\n<p>比如在这个<a href=\"https://docs.gradle.org/current/userguide/multi_project_builds.html#javadependencies_2\">例子</a>中，<code>:services:personservice</code> 项目依赖于 <code>:api</code> 和 <code>:shared</code> 项目，同时 <code>:api</code> 项目也依赖于 <code>:shared</code>。</p>\n<p>当我们执行 <code>./gradlew :api:build</code> 时，输出可能如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; gradle :api:build</span><br><span class=\"line\">&gt; Task :shared:compileJava</span><br><span class=\"line\">&gt; Task :shared:processResources</span><br><span class=\"line\">&gt; Task :shared:classes</span><br><span class=\"line\">&gt; Task :shared:jar</span><br><span class=\"line\">&gt; Task :api:compileJava</span><br><span class=\"line\">&gt; Task :api:processResources</span><br><span class=\"line\">&gt; Task :api:classes</span><br><span class=\"line\">&gt; Task :api:jar</span><br><span class=\"line\">&gt; Task :api:assemble</span><br><span class=\"line\">&gt; Task :api:compileTestJava</span><br><span class=\"line\">&gt; Task :api:processTestResources</span><br><span class=\"line\">&gt; Task :api:testClasses</span><br><span class=\"line\">&gt; Task :api:test</span><br><span class=\"line\">&gt; Task :api:check</span><br><span class=\"line\">&gt; Task :api:build</span><br><span class=\"line\"></span><br><span class=\"line\">BUILD SUCCESSFUL in 0s</span><br><span class=\"line\">9 actionable tasks: 9 executed</span><br></pre></td></tr></table></figure>\n\n<p>可以看到，当我们只执行 <code>:api</code> 项目的 <code>build</code> task，同时也会执行其依赖项目 <code>:shared</code> 部分的 task，如果我们确定对 <code>:api</code> 项目的修改不会影响 <code>:share</code> 项目，可以使用 <code>-a</code> 选项参数，这个参数可以让 Gradle 去缓存依赖项目生成的 jars，不重新去编译依赖项目，现在我们增加 <code>-a</code> 参数，<code>./gradlew -a :api:build</code>，输出可能如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; gradle -a :api:build</span><br><span class=\"line\">&gt; Task :api:compileJava</span><br><span class=\"line\">&gt; Task :api:processResources</span><br><span class=\"line\">&gt; Task :api:classes</span><br><span class=\"line\">&gt; Task :api:jar</span><br><span class=\"line\">&gt; Task :api:assemble</span><br><span class=\"line\">&gt; Task :api:compileTestJava</span><br><span class=\"line\">&gt; Task :api:processTestResources</span><br><span class=\"line\">&gt; Task :api:testClasses</span><br><span class=\"line\">&gt; Task :api:test</span><br><span class=\"line\">&gt; Task :api:check</span><br><span class=\"line\">&gt; Task :api:build</span><br><span class=\"line\"></span><br><span class=\"line\">BUILD SUCCESSFUL in 0s</span><br><span class=\"line\">6 actionable tasks: 6 executed</span><br></pre></td></tr></table></figure>\n\n<p>可以看到 <code>-a</code> 选项起作用了。</p>\n<p>如果你刚刚从版本控制工具中更新了 <code>:api</code> 项目依赖的项目，你可能不仅仅想要只执行编译，可能想要去测试它们，那么 <code>buildNeeded</code> task 将测试所有依赖项目测试运行时的配置。执行 <code>./gradlew :api:buildNeeded</code>，可能输出如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; gradle :api:buildNeeded</span><br><span class=\"line\">&gt; Task :shared:compileJava</span><br><span class=\"line\">&gt; Task :shared:processResources</span><br><span class=\"line\">&gt; Task :shared:classes</span><br><span class=\"line\">&gt; Task :shared:jar</span><br><span class=\"line\">&gt; Task :api:compileJava</span><br><span class=\"line\">&gt; Task :api:processResources</span><br><span class=\"line\">&gt; Task :api:classes</span><br><span class=\"line\">&gt; Task :api:jar</span><br><span class=\"line\">&gt; Task :api:assemble</span><br><span class=\"line\">&gt; Task :api:compileTestJava</span><br><span class=\"line\">&gt; Task :api:processTestResources</span><br><span class=\"line\">&gt; Task :api:testClasses</span><br><span class=\"line\">&gt; Task :api:test</span><br><span class=\"line\">&gt; Task :api:check</span><br><span class=\"line\">&gt; Task :api:build</span><br><span class=\"line\">&gt; Task :shared:assemble</span><br><span class=\"line\">&gt; Task :shared:compileTestJava</span><br><span class=\"line\">&gt; Task :shared:processTestResources</span><br><span class=\"line\">&gt; Task :shared:testClasses</span><br><span class=\"line\">&gt; Task :shared:test</span><br><span class=\"line\">&gt; Task :shared:check</span><br><span class=\"line\">&gt; Task :shared:build</span><br><span class=\"line\">&gt; Task :shared:buildNeeded</span><br><span class=\"line\">&gt; Task :api:buildNeeded</span><br><span class=\"line\"></span><br><span class=\"line\">BUILD SUCCESSFUL in 0s</span><br><span class=\"line\">12 actionable tasks: 12 executed</span><br></pre></td></tr></table></figure>\n\n<p>有时候你重构了 <code>:api</code> 的某些代码，想要测试依赖于 <code>:api</code> 项目的其他项目，那么可以使用 <code>buildDependents</code>，它可以测试编译依赖指定的项目的所有项目，运行 <code>./gradlew :api:buildDependents</code> 输出如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; gradle :api:buildDependents</span><br><span class=\"line\">&gt; Task :shared:compileJava</span><br><span class=\"line\">&gt; Task :shared:processResources</span><br><span class=\"line\">&gt; Task :shared:classes</span><br><span class=\"line\">&gt; Task :shared:jar</span><br><span class=\"line\">&gt; Task :api:compileJava</span><br><span class=\"line\">&gt; Task :api:processResources</span><br><span class=\"line\">&gt; Task :api:classes</span><br><span class=\"line\">&gt; Task :api:jar</span><br><span class=\"line\">&gt; Task :api:assemble</span><br><span class=\"line\">&gt; Task :api:compileTestJava</span><br><span class=\"line\">&gt; Task :api:processTestResources</span><br><span class=\"line\">&gt; Task :api:testClasses</span><br><span class=\"line\">&gt; Task :api:test</span><br><span class=\"line\">&gt; Task :api:check</span><br><span class=\"line\">&gt; Task :api:build</span><br><span class=\"line\">&gt; Task :services:personService:compileJava</span><br><span class=\"line\">&gt; Task :services:personService:processResources</span><br><span class=\"line\">&gt; Task :services:personService:classes</span><br><span class=\"line\">&gt; Task :services:personService:jar</span><br><span class=\"line\">&gt; Task :services:personService:assemble</span><br><span class=\"line\">&gt; Task :services:personService:compileTestJava</span><br><span class=\"line\">&gt; Task :services:personService:processTestResources</span><br><span class=\"line\">&gt; Task :services:personService:testClasses</span><br><span class=\"line\">&gt; Task :services:personService:test</span><br><span class=\"line\">&gt; Task :services:personService:check</span><br><span class=\"line\">&gt; Task :services:personService:build</span><br><span class=\"line\">&gt; Task :services:personService:buildDependents</span><br><span class=\"line\">&gt; Task :api:buildDependents</span><br><span class=\"line\"></span><br><span class=\"line\">BUILD SUCCESSFUL in 0s</span><br><span class=\"line\">17 actionable tasks: 17 executed</span><br></pre></td></tr></table></figure>\n\n<p>最后，如果你在根项目执行的任何 task 都会导致所有项目中存在同名的 task 的执行。</p>\n<h3 id=\"属性和方法的继承\"><a href=\"#属性和方法的继承\" class=\"headerlink\" title=\"属性和方法的继承\"></a>属性和方法的继承</h3><p>在根项目中声明的属性和方法都会继承到子项目中，这是配置注入的替代方式。而配置注入不支持方法，</p>\n<h3 id=\"其他选项\"><a href=\"#其他选项\" class=\"headerlink\" title=\"其他选项\"></a>其他选项</h3><h4 id=\"并行模式\"><a href=\"#并行模式\" class=\"headerlink\" title=\"并行模式\"></a>并行模式</h4><p>可以使用 <code>—parallel</code> 开启并行模式，这可以减少项目构建时间</p>\n<h4 id=\"按需配置\"><a href=\"#按需配置\" class=\"headerlink\" title=\"按需配置\"></a>按需配置</h4><p>可以使用 <code>--configure-on-demand</code> 开启按需配置，这同样可以减少构建配置时间</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>在上面的篇幅我们着重讲解了 Gradle 对多项目构建的支持，包括跨项目配置，多项目的执行规则和执行顺序，配置注入等等。但理论知识毕竟只是纸上谈兵，下一篇文章会通过具体的项目配置，来讲解实际的使用。</p>\n"},{"title":"Gradle插件-基础篇","date":"2018-05-16T01:20:58.000Z","_content":"\n## 前言\n\n本文是 Gradle 系列的第三篇，前两篇都是关于 Gradle 多项目构建，有兴趣的同学可以去翻看下。Gradle 系列作者会一直更新下去，这些知识大部分都来自于 [Gradle 用户手册](https://docs.gradle.org/current/userguide/userguide.html)，但我并不想写成翻译类型的文章，从最基础的知识开始深入，因为这样前期枯燥的理论知识会让人感到厌倦，所以从用户最常用的知识入手，再穿插必要的基础知识，最终达到知识的融会贯通。因为作者从事 Android 开发，所以会更多提及 Android 中关于 Gradle 的知识。\n\n> 博客中的[源码地址](https://github.com/LinXiaoTao/GradleCaseProject)\n\n## Gradle插件\n\nGradle 是非常强大的构建工具，所有的知识都围绕着 project 和 task 这两个知识点。project 在前面的文章中我们已经简单介绍了，task 现在是穿插着讲，后续会考虑单独写成文章。而我们今天讲的 plugin 对于大部分的 Gradle 使用者来说，可能是一个熟悉又陌生的知识点，熟悉是因为用的太频繁了，比如 Android 项目中，我们都会使用以下配置：\n\n``` groovy\napply plugin: 'com.android.application'\n\nandroid {\n    compileSdkVersion xxx\n    buildToolsVersion xxx\n    defaultConfig {\n        \n    }\n}\n```\n\n但另外一方面，我们对 plugin 的实现又似懂非懂，使用 Android Application Plugin 后，`android {}` 配置块是如何生成的，又有哪些配置可以用。现在有很多自定义的 Gradle Plugin，比如使用 AOP 实现的代码插桩，打点等等功能的库，那么这些库又是如何通过 Plugin 功能实现的。\n\n接下来，我们将基于 [Gradle 用户手册](https://docs.gradle.org/current/userguide/userguide.html) 中关于 Plugin 的知识，从 Plugin 的理论知识到自定义实现 Plugin 写一系列文章。\n\n> 友情提示：如果想深入理解 Gradle 知识，最好还是从 Gradle 官方文档入手，比如 [Gradle 用户手册](https://docs.gradle.org/current/userguide/userguide.html)，[API 文档](https://docs.gradle.org/current/javadoc/) 等等，如果只是想快速了解，那么可以继续往下读。\n\n### 设计\n\nGradle Plugin 的设计应该符合以下准则：\n\n#### 架构\n\n* 可复用的逻辑应该写成二进制形式\n\n  Gradle Plugin 有两种形式：脚本插件和二进制插件。脚本插件就是普通的构建脚本，虽然脚本插件也可以组织构建逻辑，但是它不能进行测试，也不能定义可复用的类型，难于长期维护。\n\n* 考虑性能影响\n\n  虽然在设计 Gradle Plugin 时，可以实现你能想到的任何逻辑，但是应该考虑对构建时间的影响。\n\n* 约定大于配置\n\n  Gradle Plugin 的设计应该秉承**约定大于配置**的准则，尽量减少用户陷入繁琐的配置中，又提供配置入口给具有自定义需求的用户。比如 Android Application Plugin 的 ***sourceSets*** 配置，如果不进行配置，会使用默认的目录，可以使用  `./gradlew :app:sourceSets` 打印默认使用的目录。\n\n* 功能与约定\n\n  为了让用户能够更灵活地使用你设计的 Plugin，你应该提供更为灵活的使用方式，其中一个方式就是，将实现功能与通用配置分离开来。比如： [Java Base Plugin](https://docs.gradle.org/current/userguide/standard_plugins.html?_ga=2.84655903.747719590.1526541985-590693097.1523454314#sec:base_plugins) 和 [Java Plugin](https://docs.gradle.org/current/userguide/java_plugin.html?_ga=2.72588053.747719590.1526541985-590693097.1523454314)：\n\n  * Java Base Plugin：提供了 ***sourceSets*** 配置属性，用于定义源文件的目录，但它并不会被用于任何构建任务\n  * Java Plugin：则是在 Java Base Plugin 提供的 ***sourceSets*** 配置上读取源文件，同时定义了具体的构建任务\n\n  如果用户想实现更深层次的定制，则可以继承于 Java Base Plugin 实现自定义构建任务。\n\n  在实现自定义 Plugin 可以这样实现：\n\n  假设 `BasePlugin` 实现了通用配置：\n\n  ``` groovy\n  public class BasePlugin implements Plugin<Project> {\n      public void apply(Project project) {\n          \n      }\n  }\n  ```\n\n  `MyPlugin` 则是基于 `BasePlugin` 实现了特定功能：\n\n  ``` groovy\n  public class MyPlugin implements Plugin<Project> {\n      public void apply(Project project) {\n          proejct.getPlugins().apply(BasePlugin.class);\n      }\n  }\n  ```\n\n  #### 技术实现\n\n* 倾向于使用静态类型语言来实现\n\n  Gradle Plugin 的实现语言可以是任何 JVM 语言（即编译产物能在 JVM 上运行），可以是 Java、Kotlin、Groovy 等等。\n\n  但建议使用 Java 或 Kotlin 等静态类型语言来实现，以降低出现不兼容的可能。\n\n* 使用 Gradle 公开 API 实现\n\n  当实现 Gradle Plugin，需要指定使用的 Gradle API 版本，例如以下配置：\n\n  ``` groovy\n  dependencies {\n      compile gradleAPi()\n  }\n  ```\n\n  但因为 Gradle 的历史原因，公开和内部的 API 并没有分离开来，为了确保与各个 Gradle 版本的兼容性，请尽量使用公开的 API\n\n  > 能在 [DSL 文档](https://docs.gradle.org/current/dsl/?_ga=2.131010252.258862271.1526633053-590693097.1523454314) 和  [DOC 文档](https://docs.gradle.org/current/javadoc/?_ga=2.131010252.258862271.1526633053-590693097.1523454314) 中找到的，即为公开的 API\n\n* 最大程度地减少外部库的依赖\n\n  当我们在编写 Plugin 时，可能会习惯性地去引入某个功能齐全的外部库，比如：Guave，但是这同时也会带来一些问题，可以使用 `buildEnvironment` task 查看构建环境依赖关系，包括 Plugin：\n\n  ```\n  classpath\n  +--- com.android.tools.build:gradle:2.3.3\n  |    \\--- com.android.tools.build:gradle-core:2.3.3\n  |         +--- com.android.tools.build:builder:2.3.3\n  ```\n\n  因为 Gradle Plugin 并没有独立的类加载器运行环境，所以这些依赖可能会与其他 Plugin 的依赖发生冲突。\n\n### 例子\n\n上面是自定义 Gradle Plugin 的一些规范和注意事项，下面我们通过一个比较简单的自定义 Plugin 来实践下。\n\n这个 Plugin 的功能很简单，创建一个 task，获取配置的属性，再打印出来。\n\n上面我们说到，Plugin 可以分为脚本插件和二进制插件两种，脚本插件就是 Gradle 文件，而二进制文件的可以像普通依赖一样，从中央仓库上下载，还有一种方式是，将源码存放到当前项目下的 ***buildSrc*** module，当应用插件时，会从中查找。为了方便起见，我们使用后面那种方式。\n\n* 首先，我们创建一个名为 ***buildSrc*** 的 module，记得在 `setting.gradle` 中配置，在该 module 的根目录下创建 `build.gradle`，因为我们打算用 Java 实现，所以先引入 Java Plugin，同时依赖 Gradle API。\n\n  > Gradle 同时也提供了一个 Plugin 用于简化这些步骤，具体可以查看 [java-gradle-plugin](https://docs.gradle.org/4.7/userguide/java_gradle_plugin.html?_ga=2.132564685.258862271.1526633053-590693097.1523454314)\n\n  ``` groovy\n  apply plugin: 'java-library'\n  \n  dependencies {\n      implementation fileTree(dir: 'libs', include: ['*.jar'])\n      implementation gradleApi()\n  }\n  \n  sourceCompatibility = \"1.8\"\n  targetCompatibility = \"1.8\"\n  ```\n\n* 接着，创建一个 Task 类型，命名为 `HelloWorld`：\n\n  ``` java\n  public class HelloWorld extends DefaultTask {\n      \n      public String userName;\n  \n      @TaskAction\n      public void run() {\n          System.out.println(\"Hello World，\" + userName);\n      }\n  }\n  ```\n\n  一般继承于 `DefaultTask` 也可以选择其他 Task 基类，`@TaskAction` 是必须的，用于注解方法为 Task 运行时执行的代码，`userName` 是可选配置。\n\n* 其实上一步做完，我们已经可以在其他 module 下的 gradle 文件中直接引用这个 Task 类型，比如：\n\n  ``` groovy\n  import com.example.gradle.HelloWorld\n  \n  task hello(type: HelloWorld) {\n      userName = \"leo\"\n  }\n  ```\n\n  执行 `./gradlew :app:hello` 输出 \"Hello World，leo\"\n\n  > 注意：上面这样做的前提是，这部分的代码位于 ***buildSrc*** module，这也是约定配置，符合**约定大于配置**规范\n\n  在我们这个例子中，我们通过 Plugin 去动态创建一个 Task：\n\n  ``` java\n  public final class HelloWorldPlugin implements Plugin<Project> {\n      @Override\n      public void apply(Project project) {\n          project.getTasks().create(\"pluginHello\", HelloWorld.class, helloWorld ->\n                  helloWorld.userName = \"leo\");\n      }\n  }\n  ```\n\n  实现自定义 Plugin 需要实现于 Plugin，接着在 `apply()` 中添加一个名为 \"pluginHello\"，类型为 `HelloWorld` 的 Task。\n\n* 至此，我们已经写好了 Plugin 的逻辑代码，要想在当前项目中的其他 module 中引用 ***buildSrc*** 中的 Plugin，需要给 `HelloWorldPlugin` 指定一个 ID，注：直接写在构建脚本中的插件则不需要。具体配置如下：\n\n  在 `src/main/resources/META-INF/gradle-plugins/` 目录下创建一个配置文件，命名规则为：***[PluginID].properties***，在我们这个例子中为：`com.example.hello.properties`：\n\n  ``` properties\n  implementation-class=com.example.gradle.HelloWorldPlugin\n  ```\n\n  `implementation-class` 表示 Plugin 类\n\n  > Plugin ID 应该符合以下规定：\n  >\n  > * 可以包含任何字母、字符，'.'、'-'\n  > * 必须至少包含一个 '.' 分隔命名空间和插件名称\n  > * 按照惯例，使用域名反向小写作为命名空间\n  > * 按照惯例，命名空间只使用小写字母\n  > * `org.gradle` 和 `com.gradleware` 命名空间不能被使用\n  > * 不能使用 '.' 作为开始或结束字符\n  > * 不能使用连续的 '.' 字符\n\n* 至此，我们已经写好了一个简单自定义 Plugin，我们在 app module 下的 `build.gradle` 引入这个它：\n\n  ```\n  apply plugin: 'com.example.hello'\n  ```\n\n  执行 `./gradlew :app:pluginHello` 输出 \"Hello World，leo\"\n\n  > 上面我们提到了 java-gradle-plugin，如果使用这个 Plugin 的话，可以无需手动配置 properties，只需在 gradle 中配置如下即可：\n  >\n  > ``` groovy\n  > gradlePlugin {\n  >     plugins {\n  >         helloPlugin {\n  >             id = 'com.example.hello'\n  >             implementationClass = 'com.example.gradle.HelloWorldPlugin'\n  >         }\n  >     }\n  > }\n  > ```\n\n### 插件源码\n\n在上面的例子中，我们将代码写在了 ***buildSrc*** module 中，那么除此之外还有：\n\n* 构建脚本\n\n  可以将 Plugin 的源码直接包含在构建脚本中，这样子可以方便地在当前构建脚本直接使用该 Plugin，但是无法在其他构建脚本中使用。\n\n  ***build.gradle***\n\n  ``` groovy\n  class TestPlugin implements Plugin<Project> {\n      void apply(Project project) {\n          project.tasks.create('pluginTest') {\n              doLast {\n                  println \"This is Test\"\n              }\n          }\n      }\n  }\n  \n  apply plugin: TestPlugin\n  ```\n\n  > 需要注意：上面的书写顺序，还记得我们之前说的**边读取边解释**\n\n* 单独的项目\n\n  你可以为 Gradle Plugin 创建一个单独的项目，这种方式和 ***buildSrc*** 类似，并且可以生成 JAR 上传到中央仓库提供给其他开发者使用，而 ***buildSrc*** 只能在当前项目中使用。\n\n### 结束语\n\n由于篇幅的限制，基础篇我们就讲到这里，后续的文章还会更深入地讲解 Gradle Plugin 知识。","source":"_posts/Gradle插件-基础篇.md","raw":"---\ntitle: Gradle插件-基础篇\ndate: 2018-05-16 09:20:58\ncategories: Gradle\ntags: \n---\n\n## 前言\n\n本文是 Gradle 系列的第三篇，前两篇都是关于 Gradle 多项目构建，有兴趣的同学可以去翻看下。Gradle 系列作者会一直更新下去，这些知识大部分都来自于 [Gradle 用户手册](https://docs.gradle.org/current/userguide/userguide.html)，但我并不想写成翻译类型的文章，从最基础的知识开始深入，因为这样前期枯燥的理论知识会让人感到厌倦，所以从用户最常用的知识入手，再穿插必要的基础知识，最终达到知识的融会贯通。因为作者从事 Android 开发，所以会更多提及 Android 中关于 Gradle 的知识。\n\n> 博客中的[源码地址](https://github.com/LinXiaoTao/GradleCaseProject)\n\n## Gradle插件\n\nGradle 是非常强大的构建工具，所有的知识都围绕着 project 和 task 这两个知识点。project 在前面的文章中我们已经简单介绍了，task 现在是穿插着讲，后续会考虑单独写成文章。而我们今天讲的 plugin 对于大部分的 Gradle 使用者来说，可能是一个熟悉又陌生的知识点，熟悉是因为用的太频繁了，比如 Android 项目中，我们都会使用以下配置：\n\n``` groovy\napply plugin: 'com.android.application'\n\nandroid {\n    compileSdkVersion xxx\n    buildToolsVersion xxx\n    defaultConfig {\n        \n    }\n}\n```\n\n但另外一方面，我们对 plugin 的实现又似懂非懂，使用 Android Application Plugin 后，`android {}` 配置块是如何生成的，又有哪些配置可以用。现在有很多自定义的 Gradle Plugin，比如使用 AOP 实现的代码插桩，打点等等功能的库，那么这些库又是如何通过 Plugin 功能实现的。\n\n接下来，我们将基于 [Gradle 用户手册](https://docs.gradle.org/current/userguide/userguide.html) 中关于 Plugin 的知识，从 Plugin 的理论知识到自定义实现 Plugin 写一系列文章。\n\n> 友情提示：如果想深入理解 Gradle 知识，最好还是从 Gradle 官方文档入手，比如 [Gradle 用户手册](https://docs.gradle.org/current/userguide/userguide.html)，[API 文档](https://docs.gradle.org/current/javadoc/) 等等，如果只是想快速了解，那么可以继续往下读。\n\n### 设计\n\nGradle Plugin 的设计应该符合以下准则：\n\n#### 架构\n\n* 可复用的逻辑应该写成二进制形式\n\n  Gradle Plugin 有两种形式：脚本插件和二进制插件。脚本插件就是普通的构建脚本，虽然脚本插件也可以组织构建逻辑，但是它不能进行测试，也不能定义可复用的类型，难于长期维护。\n\n* 考虑性能影响\n\n  虽然在设计 Gradle Plugin 时，可以实现你能想到的任何逻辑，但是应该考虑对构建时间的影响。\n\n* 约定大于配置\n\n  Gradle Plugin 的设计应该秉承**约定大于配置**的准则，尽量减少用户陷入繁琐的配置中，又提供配置入口给具有自定义需求的用户。比如 Android Application Plugin 的 ***sourceSets*** 配置，如果不进行配置，会使用默认的目录，可以使用  `./gradlew :app:sourceSets` 打印默认使用的目录。\n\n* 功能与约定\n\n  为了让用户能够更灵活地使用你设计的 Plugin，你应该提供更为灵活的使用方式，其中一个方式就是，将实现功能与通用配置分离开来。比如： [Java Base Plugin](https://docs.gradle.org/current/userguide/standard_plugins.html?_ga=2.84655903.747719590.1526541985-590693097.1523454314#sec:base_plugins) 和 [Java Plugin](https://docs.gradle.org/current/userguide/java_plugin.html?_ga=2.72588053.747719590.1526541985-590693097.1523454314)：\n\n  * Java Base Plugin：提供了 ***sourceSets*** 配置属性，用于定义源文件的目录，但它并不会被用于任何构建任务\n  * Java Plugin：则是在 Java Base Plugin 提供的 ***sourceSets*** 配置上读取源文件，同时定义了具体的构建任务\n\n  如果用户想实现更深层次的定制，则可以继承于 Java Base Plugin 实现自定义构建任务。\n\n  在实现自定义 Plugin 可以这样实现：\n\n  假设 `BasePlugin` 实现了通用配置：\n\n  ``` groovy\n  public class BasePlugin implements Plugin<Project> {\n      public void apply(Project project) {\n          \n      }\n  }\n  ```\n\n  `MyPlugin` 则是基于 `BasePlugin` 实现了特定功能：\n\n  ``` groovy\n  public class MyPlugin implements Plugin<Project> {\n      public void apply(Project project) {\n          proejct.getPlugins().apply(BasePlugin.class);\n      }\n  }\n  ```\n\n  #### 技术实现\n\n* 倾向于使用静态类型语言来实现\n\n  Gradle Plugin 的实现语言可以是任何 JVM 语言（即编译产物能在 JVM 上运行），可以是 Java、Kotlin、Groovy 等等。\n\n  但建议使用 Java 或 Kotlin 等静态类型语言来实现，以降低出现不兼容的可能。\n\n* 使用 Gradle 公开 API 实现\n\n  当实现 Gradle Plugin，需要指定使用的 Gradle API 版本，例如以下配置：\n\n  ``` groovy\n  dependencies {\n      compile gradleAPi()\n  }\n  ```\n\n  但因为 Gradle 的历史原因，公开和内部的 API 并没有分离开来，为了确保与各个 Gradle 版本的兼容性，请尽量使用公开的 API\n\n  > 能在 [DSL 文档](https://docs.gradle.org/current/dsl/?_ga=2.131010252.258862271.1526633053-590693097.1523454314) 和  [DOC 文档](https://docs.gradle.org/current/javadoc/?_ga=2.131010252.258862271.1526633053-590693097.1523454314) 中找到的，即为公开的 API\n\n* 最大程度地减少外部库的依赖\n\n  当我们在编写 Plugin 时，可能会习惯性地去引入某个功能齐全的外部库，比如：Guave，但是这同时也会带来一些问题，可以使用 `buildEnvironment` task 查看构建环境依赖关系，包括 Plugin：\n\n  ```\n  classpath\n  +--- com.android.tools.build:gradle:2.3.3\n  |    \\--- com.android.tools.build:gradle-core:2.3.3\n  |         +--- com.android.tools.build:builder:2.3.3\n  ```\n\n  因为 Gradle Plugin 并没有独立的类加载器运行环境，所以这些依赖可能会与其他 Plugin 的依赖发生冲突。\n\n### 例子\n\n上面是自定义 Gradle Plugin 的一些规范和注意事项，下面我们通过一个比较简单的自定义 Plugin 来实践下。\n\n这个 Plugin 的功能很简单，创建一个 task，获取配置的属性，再打印出来。\n\n上面我们说到，Plugin 可以分为脚本插件和二进制插件两种，脚本插件就是 Gradle 文件，而二进制文件的可以像普通依赖一样，从中央仓库上下载，还有一种方式是，将源码存放到当前项目下的 ***buildSrc*** module，当应用插件时，会从中查找。为了方便起见，我们使用后面那种方式。\n\n* 首先，我们创建一个名为 ***buildSrc*** 的 module，记得在 `setting.gradle` 中配置，在该 module 的根目录下创建 `build.gradle`，因为我们打算用 Java 实现，所以先引入 Java Plugin，同时依赖 Gradle API。\n\n  > Gradle 同时也提供了一个 Plugin 用于简化这些步骤，具体可以查看 [java-gradle-plugin](https://docs.gradle.org/4.7/userguide/java_gradle_plugin.html?_ga=2.132564685.258862271.1526633053-590693097.1523454314)\n\n  ``` groovy\n  apply plugin: 'java-library'\n  \n  dependencies {\n      implementation fileTree(dir: 'libs', include: ['*.jar'])\n      implementation gradleApi()\n  }\n  \n  sourceCompatibility = \"1.8\"\n  targetCompatibility = \"1.8\"\n  ```\n\n* 接着，创建一个 Task 类型，命名为 `HelloWorld`：\n\n  ``` java\n  public class HelloWorld extends DefaultTask {\n      \n      public String userName;\n  \n      @TaskAction\n      public void run() {\n          System.out.println(\"Hello World，\" + userName);\n      }\n  }\n  ```\n\n  一般继承于 `DefaultTask` 也可以选择其他 Task 基类，`@TaskAction` 是必须的，用于注解方法为 Task 运行时执行的代码，`userName` 是可选配置。\n\n* 其实上一步做完，我们已经可以在其他 module 下的 gradle 文件中直接引用这个 Task 类型，比如：\n\n  ``` groovy\n  import com.example.gradle.HelloWorld\n  \n  task hello(type: HelloWorld) {\n      userName = \"leo\"\n  }\n  ```\n\n  执行 `./gradlew :app:hello` 输出 \"Hello World，leo\"\n\n  > 注意：上面这样做的前提是，这部分的代码位于 ***buildSrc*** module，这也是约定配置，符合**约定大于配置**规范\n\n  在我们这个例子中，我们通过 Plugin 去动态创建一个 Task：\n\n  ``` java\n  public final class HelloWorldPlugin implements Plugin<Project> {\n      @Override\n      public void apply(Project project) {\n          project.getTasks().create(\"pluginHello\", HelloWorld.class, helloWorld ->\n                  helloWorld.userName = \"leo\");\n      }\n  }\n  ```\n\n  实现自定义 Plugin 需要实现于 Plugin，接着在 `apply()` 中添加一个名为 \"pluginHello\"，类型为 `HelloWorld` 的 Task。\n\n* 至此，我们已经写好了 Plugin 的逻辑代码，要想在当前项目中的其他 module 中引用 ***buildSrc*** 中的 Plugin，需要给 `HelloWorldPlugin` 指定一个 ID，注：直接写在构建脚本中的插件则不需要。具体配置如下：\n\n  在 `src/main/resources/META-INF/gradle-plugins/` 目录下创建一个配置文件，命名规则为：***[PluginID].properties***，在我们这个例子中为：`com.example.hello.properties`：\n\n  ``` properties\n  implementation-class=com.example.gradle.HelloWorldPlugin\n  ```\n\n  `implementation-class` 表示 Plugin 类\n\n  > Plugin ID 应该符合以下规定：\n  >\n  > * 可以包含任何字母、字符，'.'、'-'\n  > * 必须至少包含一个 '.' 分隔命名空间和插件名称\n  > * 按照惯例，使用域名反向小写作为命名空间\n  > * 按照惯例，命名空间只使用小写字母\n  > * `org.gradle` 和 `com.gradleware` 命名空间不能被使用\n  > * 不能使用 '.' 作为开始或结束字符\n  > * 不能使用连续的 '.' 字符\n\n* 至此，我们已经写好了一个简单自定义 Plugin，我们在 app module 下的 `build.gradle` 引入这个它：\n\n  ```\n  apply plugin: 'com.example.hello'\n  ```\n\n  执行 `./gradlew :app:pluginHello` 输出 \"Hello World，leo\"\n\n  > 上面我们提到了 java-gradle-plugin，如果使用这个 Plugin 的话，可以无需手动配置 properties，只需在 gradle 中配置如下即可：\n  >\n  > ``` groovy\n  > gradlePlugin {\n  >     plugins {\n  >         helloPlugin {\n  >             id = 'com.example.hello'\n  >             implementationClass = 'com.example.gradle.HelloWorldPlugin'\n  >         }\n  >     }\n  > }\n  > ```\n\n### 插件源码\n\n在上面的例子中，我们将代码写在了 ***buildSrc*** module 中，那么除此之外还有：\n\n* 构建脚本\n\n  可以将 Plugin 的源码直接包含在构建脚本中，这样子可以方便地在当前构建脚本直接使用该 Plugin，但是无法在其他构建脚本中使用。\n\n  ***build.gradle***\n\n  ``` groovy\n  class TestPlugin implements Plugin<Project> {\n      void apply(Project project) {\n          project.tasks.create('pluginTest') {\n              doLast {\n                  println \"This is Test\"\n              }\n          }\n      }\n  }\n  \n  apply plugin: TestPlugin\n  ```\n\n  > 需要注意：上面的书写顺序，还记得我们之前说的**边读取边解释**\n\n* 单独的项目\n\n  你可以为 Gradle Plugin 创建一个单独的项目，这种方式和 ***buildSrc*** 类似，并且可以生成 JAR 上传到中央仓库提供给其他开发者使用，而 ***buildSrc*** 只能在当前项目中使用。\n\n### 结束语\n\n由于篇幅的限制，基础篇我们就讲到这里，后续的文章还会更深入地讲解 Gradle Plugin 知识。","slug":"Gradle插件-基础篇","published":1,"updated":"2022-06-15T11:19:32.317Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrla0006fho66c8betl2","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>本文是 Gradle 系列的第三篇，前两篇都是关于 Gradle 多项目构建，有兴趣的同学可以去翻看下。Gradle 系列作者会一直更新下去，这些知识大部分都来自于 <a href=\"https://docs.gradle.org/current/userguide/userguide.html\">Gradle 用户手册</a>，但我并不想写成翻译类型的文章，从最基础的知识开始深入，因为这样前期枯燥的理论知识会让人感到厌倦，所以从用户最常用的知识入手，再穿插必要的基础知识，最终达到知识的融会贯通。因为作者从事 Android 开发，所以会更多提及 Android 中关于 Gradle 的知识。</p>\n<blockquote>\n<p>博客中的<a href=\"https://github.com/LinXiaoTao/GradleCaseProject\">源码地址</a></p>\n</blockquote>\n<h2 id=\"Gradle插件\"><a href=\"#Gradle插件\" class=\"headerlink\" title=\"Gradle插件\"></a>Gradle插件</h2><p>Gradle 是非常强大的构建工具，所有的知识都围绕着 project 和 task 这两个知识点。project 在前面的文章中我们已经简单介绍了，task 现在是穿插着讲，后续会考虑单独写成文章。而我们今天讲的 plugin 对于大部分的 Gradle 使用者来说，可能是一个熟悉又陌生的知识点，熟悉是因为用的太频繁了，比如 Android 项目中，我们都会使用以下配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;com.android.application&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">android &#123;</span><br><span class=\"line\">    compileSdkVersion xxx</span><br><span class=\"line\">    buildToolsVersion xxx</span><br><span class=\"line\">    defaultConfig &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>但另外一方面，我们对 plugin 的实现又似懂非懂，使用 Android Application Plugin 后，<code>android &#123;&#125;</code> 配置块是如何生成的，又有哪些配置可以用。现在有很多自定义的 Gradle Plugin，比如使用 AOP 实现的代码插桩，打点等等功能的库，那么这些库又是如何通过 Plugin 功能实现的。</p>\n<p>接下来，我们将基于 <a href=\"https://docs.gradle.org/current/userguide/userguide.html\">Gradle 用户手册</a> 中关于 Plugin 的知识，从 Plugin 的理论知识到自定义实现 Plugin 写一系列文章。</p>\n<blockquote>\n<p>友情提示：如果想深入理解 Gradle 知识，最好还是从 Gradle 官方文档入手，比如 <a href=\"https://docs.gradle.org/current/userguide/userguide.html\">Gradle 用户手册</a>，<a href=\"https://docs.gradle.org/current/javadoc/\">API 文档</a> 等等，如果只是想快速了解，那么可以继续往下读。</p>\n</blockquote>\n<h3 id=\"设计\"><a href=\"#设计\" class=\"headerlink\" title=\"设计\"></a>设计</h3><p>Gradle Plugin 的设计应该符合以下准则：</p>\n<h4 id=\"架构\"><a href=\"#架构\" class=\"headerlink\" title=\"架构\"></a>架构</h4><ul>\n<li><p>可复用的逻辑应该写成二进制形式</p>\n<p>Gradle Plugin 有两种形式：脚本插件和二进制插件。脚本插件就是普通的构建脚本，虽然脚本插件也可以组织构建逻辑，但是它不能进行测试，也不能定义可复用的类型，难于长期维护。</p>\n</li>\n<li><p>考虑性能影响</p>\n<p>虽然在设计 Gradle Plugin 时，可以实现你能想到的任何逻辑，但是应该考虑对构建时间的影响。</p>\n</li>\n<li><p>约定大于配置</p>\n<p>Gradle Plugin 的设计应该秉承<strong>约定大于配置</strong>的准则，尽量减少用户陷入繁琐的配置中，又提供配置入口给具有自定义需求的用户。比如 Android Application Plugin 的 <em><strong>sourceSets</strong></em> 配置，如果不进行配置，会使用默认的目录，可以使用  <code>./gradlew :app:sourceSets</code> 打印默认使用的目录。</p>\n</li>\n<li><p>功能与约定</p>\n<p>为了让用户能够更灵活地使用你设计的 Plugin，你应该提供更为灵活的使用方式，其中一个方式就是，将实现功能与通用配置分离开来。比如： <a href=\"https://docs.gradle.org/current/userguide/standard_plugins.html?_ga=2.84655903.747719590.1526541985-590693097.1523454314#sec:base_plugins\">Java Base Plugin</a> 和 <a href=\"https://docs.gradle.org/current/userguide/java_plugin.html?_ga=2.72588053.747719590.1526541985-590693097.1523454314\">Java Plugin</a>：</p>\n<ul>\n<li>Java Base Plugin：提供了 <em><strong>sourceSets</strong></em> 配置属性，用于定义源文件的目录，但它并不会被用于任何构建任务</li>\n<li>Java Plugin：则是在 Java Base Plugin 提供的 <em><strong>sourceSets</strong></em> 配置上读取源文件，同时定义了具体的构建任务</li>\n</ul>\n<p>如果用户想实现更深层次的定制，则可以继承于 Java Base Plugin 实现自定义构建任务。</p>\n<p>在实现自定义 Plugin 可以这样实现：</p>\n<p>假设 <code>BasePlugin</code> 实现了通用配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">BasePlugin</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Plugin</span>&lt;Project&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">void</span> apply(Project project) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>MyPlugin</code> 则是基于 <code>BasePlugin</code> 实现了特定功能：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyPlugin</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Plugin</span>&lt;Project&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">void</span> apply(Project project) &#123;</span><br><span class=\"line\">        proejct.getPlugins().apply(BasePlugin.<span class=\"keyword\">class</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"技术实现\"><a href=\"#技术实现\" class=\"headerlink\" title=\"技术实现\"></a>技术实现</h4><ul>\n<li><p>倾向于使用静态类型语言来实现</p>\n<p>Gradle Plugin 的实现语言可以是任何 JVM 语言（即编译产物能在 JVM 上运行），可以是 Java、Kotlin、Groovy 等等。</p>\n<p>但建议使用 Java 或 Kotlin 等静态类型语言来实现，以降低出现不兼容的可能。</p>\n</li>\n<li><p>使用 Gradle 公开 API 实现</p>\n<p>当实现 Gradle Plugin，需要指定使用的 Gradle API 版本，例如以下配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dependencies &#123;</span><br><span class=\"line\">    compile gradleAPi()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>但因为 Gradle 的历史原因，公开和内部的 API 并没有分离开来，为了确保与各个 Gradle 版本的兼容性，请尽量使用公开的 API</p>\n<blockquote>\n<p>能在 <a href=\"https://docs.gradle.org/current/dsl/?_ga=2.131010252.258862271.1526633053-590693097.1523454314\">DSL 文档</a> 和  <a href=\"https://docs.gradle.org/current/javadoc/?_ga=2.131010252.258862271.1526633053-590693097.1523454314\">DOC 文档</a> 中找到的，即为公开的 API</p>\n</blockquote>\n</li>\n<li><p>最大程度地减少外部库的依赖</p>\n<p>当我们在编写 Plugin 时，可能会习惯性地去引入某个功能齐全的外部库，比如：Guave，但是这同时也会带来一些问题，可以使用 <code>buildEnvironment</code> task 查看构建环境依赖关系，包括 Plugin：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">classpath</span><br><span class=\"line\">+--- com.android.tools.build:gradle:2.3.3</span><br><span class=\"line\">|    \\--- com.android.tools.build:gradle-core:2.3.3</span><br><span class=\"line\">|         +--- com.android.tools.build:builder:2.3.3</span><br></pre></td></tr></table></figure>\n\n<p>因为 Gradle Plugin 并没有独立的类加载器运行环境，所以这些依赖可能会与其他 Plugin 的依赖发生冲突。</p>\n</li>\n</ul>\n<h3 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h3><p>上面是自定义 Gradle Plugin 的一些规范和注意事项，下面我们通过一个比较简单的自定义 Plugin 来实践下。</p>\n<p>这个 Plugin 的功能很简单，创建一个 task，获取配置的属性，再打印出来。</p>\n<p>上面我们说到，Plugin 可以分为脚本插件和二进制插件两种，脚本插件就是 Gradle 文件，而二进制文件的可以像普通依赖一样，从中央仓库上下载，还有一种方式是，将源码存放到当前项目下的 <em><strong>buildSrc</strong></em> module，当应用插件时，会从中查找。为了方便起见，我们使用后面那种方式。</p>\n<ul>\n<li><p>首先，我们创建一个名为 <em><strong>buildSrc</strong></em> 的 module，记得在 <code>setting.gradle</code> 中配置，在该 module 的根目录下创建 <code>build.gradle</code>，因为我们打算用 Java 实现，所以先引入 Java Plugin，同时依赖 Gradle API。</p>\n<blockquote>\n<p>Gradle 同时也提供了一个 Plugin 用于简化这些步骤，具体可以查看 <a href=\"https://docs.gradle.org/4.7/userguide/java_gradle_plugin.html?_ga=2.132564685.258862271.1526633053-590693097.1523454314\">java-gradle-plugin</a></p>\n</blockquote>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;java-library&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">dependencies &#123;</span><br><span class=\"line\">    implementation fileTree(<span class=\"attr\">dir:</span> <span class=\"string\">&#x27;libs&#x27;</span>, <span class=\"attr\">include:</span> [<span class=\"string\">&#x27;*.jar&#x27;</span>])</span><br><span class=\"line\">    implementation gradleApi()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sourceCompatibility = <span class=\"string\">&quot;1.8&quot;</span></span><br><span class=\"line\">targetCompatibility = <span class=\"string\">&quot;1.8&quot;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>接着，创建一个 Task 类型，命名为 <code>HelloWorld</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HelloWorld</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">DefaultTask</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> String userName;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@TaskAction</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Hello World，&quot;</span> + userName);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>一般继承于 <code>DefaultTask</code> 也可以选择其他 Task 基类，<code>@TaskAction</code> 是必须的，用于注解方法为 Task 运行时执行的代码，<code>userName</code> 是可选配置。</p>\n</li>\n<li><p>其实上一步做完，我们已经可以在其他 module 下的 gradle 文件中直接引用这个 Task 类型，比如：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.example.gradle.HelloWorld</span><br><span class=\"line\"></span><br><span class=\"line\">task hello(<span class=\"attr\">type:</span> HelloWorld) &#123;</span><br><span class=\"line\">    userName = <span class=\"string\">&quot;leo&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>执行 <code>./gradlew :app:hello</code> 输出 “Hello World，leo”</p>\n<blockquote>\n<p>注意：上面这样做的前提是，这部分的代码位于 <em><strong>buildSrc</strong></em> module，这也是约定配置，符合<strong>约定大于配置</strong>规范</p>\n</blockquote>\n<p>在我们这个例子中，我们通过 Plugin 去动态创建一个 Task：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HelloWorldPlugin</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Plugin</span>&lt;Project&gt; &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">apply</span><span class=\"params\">(Project project)</span> &#123;</span><br><span class=\"line\">        project.getTasks().create(<span class=\"string\">&quot;pluginHello&quot;</span>, HelloWorld.class, helloWorld -&gt;</span><br><span class=\"line\">                helloWorld.userName = <span class=\"string\">&quot;leo&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>实现自定义 Plugin 需要实现于 Plugin，接着在 <code>apply()</code> 中添加一个名为 “pluginHello”，类型为 <code>HelloWorld</code> 的 Task。</p>\n</li>\n<li><p>至此，我们已经写好了 Plugin 的逻辑代码，要想在当前项目中的其他 module 中引用 <em><strong>buildSrc</strong></em> 中的 Plugin，需要给 <code>HelloWorldPlugin</code> 指定一个 ID，注：直接写在构建脚本中的插件则不需要。具体配置如下：</p>\n<p>在 <code>src/main/resources/META-INF/gradle-plugins/</code> 目录下创建一个配置文件，命名规则为：***[PluginID].properties***，在我们这个例子中为：<code>com.example.hello.properties</code>：</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">implementation-class</span>=<span class=\"string\">com.example.gradle.HelloWorldPlugin</span></span><br></pre></td></tr></table></figure>\n\n<p><code>implementation-class</code> 表示 Plugin 类</p>\n<blockquote>\n<p>Plugin ID 应该符合以下规定：</p>\n<ul>\n<li>可以包含任何字母、字符，’.’、’-‘</li>\n<li>必须至少包含一个 ‘.’ 分隔命名空间和插件名称</li>\n<li>按照惯例，使用域名反向小写作为命名空间</li>\n<li>按照惯例，命名空间只使用小写字母</li>\n<li><code>org.gradle</code> 和 <code>com.gradleware</code> 命名空间不能被使用</li>\n<li>不能使用 ‘.’ 作为开始或结束字符</li>\n<li>不能使用连续的 ‘.’ 字符</li>\n</ul>\n</blockquote>\n</li>\n<li><p>至此，我们已经写好了一个简单自定义 Plugin，我们在 app module 下的 <code>build.gradle</code> 引入这个它：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply plugin: &#x27;com.example.hello&#x27;</span><br></pre></td></tr></table></figure>\n\n<p>执行 <code>./gradlew :app:pluginHello</code> 输出 “Hello World，leo”</p>\n<blockquote>\n<p>上面我们提到了 java-gradle-plugin，如果使用这个 Plugin 的话，可以无需手动配置 properties，只需在 gradle 中配置如下即可：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gradlePlugin &#123;</span><br><span class=\"line\">    plugins &#123;</span><br><span class=\"line\">        helloPlugin &#123;</span><br><span class=\"line\">            id = <span class=\"string\">&#x27;com.example.hello&#x27;</span></span><br><span class=\"line\">            implementationClass = <span class=\"string\">&#x27;com.example.gradle.HelloWorldPlugin&#x27;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></blockquote>\n</li>\n</ul>\n<h3 id=\"插件源码\"><a href=\"#插件源码\" class=\"headerlink\" title=\"插件源码\"></a>插件源码</h3><p>在上面的例子中，我们将代码写在了 <em><strong>buildSrc</strong></em> module 中，那么除此之外还有：</p>\n<ul>\n<li><p>构建脚本</p>\n<p>可以将 Plugin 的源码直接包含在构建脚本中，这样子可以方便地在当前构建脚本直接使用该 Plugin，但是无法在其他构建脚本中使用。</p>\n<p><em><strong>build.gradle</strong></em></p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">TestPlugin</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Plugin</span>&lt;Project&gt; &#123;</span><br><span class=\"line\">    <span class=\"type\">void</span> apply(Project project) &#123;</span><br><span class=\"line\">        project.tasks.create(<span class=\"string\">&#x27;pluginTest&#x27;</span>) &#123;</span><br><span class=\"line\">            doLast &#123;</span><br><span class=\"line\">                println <span class=\"string\">&quot;This is Test&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">apply <span class=\"attr\">plugin:</span> TestPlugin</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>需要注意：上面的书写顺序，还记得我们之前说的<strong>边读取边解释</strong></p>\n</blockquote>\n</li>\n<li><p>单独的项目</p>\n<p>你可以为 Gradle Plugin 创建一个单独的项目，这种方式和 <em><strong>buildSrc</strong></em> 类似，并且可以生成 JAR 上传到中央仓库提供给其他开发者使用，而 <em><strong>buildSrc</strong></em> 只能在当前项目中使用。</p>\n</li>\n</ul>\n<h3 id=\"结束语\"><a href=\"#结束语\" class=\"headerlink\" title=\"结束语\"></a>结束语</h3><p>由于篇幅的限制，基础篇我们就讲到这里，后续的文章还会更深入地讲解 Gradle Plugin 知识。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>本文是 Gradle 系列的第三篇，前两篇都是关于 Gradle 多项目构建，有兴趣的同学可以去翻看下。Gradle 系列作者会一直更新下去，这些知识大部分都来自于 <a href=\"https://docs.gradle.org/current/userguide/userguide.html\">Gradle 用户手册</a>，但我并不想写成翻译类型的文章，从最基础的知识开始深入，因为这样前期枯燥的理论知识会让人感到厌倦，所以从用户最常用的知识入手，再穿插必要的基础知识，最终达到知识的融会贯通。因为作者从事 Android 开发，所以会更多提及 Android 中关于 Gradle 的知识。</p>\n<blockquote>\n<p>博客中的<a href=\"https://github.com/LinXiaoTao/GradleCaseProject\">源码地址</a></p>\n</blockquote>\n<h2 id=\"Gradle插件\"><a href=\"#Gradle插件\" class=\"headerlink\" title=\"Gradle插件\"></a>Gradle插件</h2><p>Gradle 是非常强大的构建工具，所有的知识都围绕着 project 和 task 这两个知识点。project 在前面的文章中我们已经简单介绍了，task 现在是穿插着讲，后续会考虑单独写成文章。而我们今天讲的 plugin 对于大部分的 Gradle 使用者来说，可能是一个熟悉又陌生的知识点，熟悉是因为用的太频繁了，比如 Android 项目中，我们都会使用以下配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;com.android.application&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">android &#123;</span><br><span class=\"line\">    compileSdkVersion xxx</span><br><span class=\"line\">    buildToolsVersion xxx</span><br><span class=\"line\">    defaultConfig &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>但另外一方面，我们对 plugin 的实现又似懂非懂，使用 Android Application Plugin 后，<code>android &#123;&#125;</code> 配置块是如何生成的，又有哪些配置可以用。现在有很多自定义的 Gradle Plugin，比如使用 AOP 实现的代码插桩，打点等等功能的库，那么这些库又是如何通过 Plugin 功能实现的。</p>\n<p>接下来，我们将基于 <a href=\"https://docs.gradle.org/current/userguide/userguide.html\">Gradle 用户手册</a> 中关于 Plugin 的知识，从 Plugin 的理论知识到自定义实现 Plugin 写一系列文章。</p>\n<blockquote>\n<p>友情提示：如果想深入理解 Gradle 知识，最好还是从 Gradle 官方文档入手，比如 <a href=\"https://docs.gradle.org/current/userguide/userguide.html\">Gradle 用户手册</a>，<a href=\"https://docs.gradle.org/current/javadoc/\">API 文档</a> 等等，如果只是想快速了解，那么可以继续往下读。</p>\n</blockquote>\n<h3 id=\"设计\"><a href=\"#设计\" class=\"headerlink\" title=\"设计\"></a>设计</h3><p>Gradle Plugin 的设计应该符合以下准则：</p>\n<h4 id=\"架构\"><a href=\"#架构\" class=\"headerlink\" title=\"架构\"></a>架构</h4><ul>\n<li><p>可复用的逻辑应该写成二进制形式</p>\n<p>Gradle Plugin 有两种形式：脚本插件和二进制插件。脚本插件就是普通的构建脚本，虽然脚本插件也可以组织构建逻辑，但是它不能进行测试，也不能定义可复用的类型，难于长期维护。</p>\n</li>\n<li><p>考虑性能影响</p>\n<p>虽然在设计 Gradle Plugin 时，可以实现你能想到的任何逻辑，但是应该考虑对构建时间的影响。</p>\n</li>\n<li><p>约定大于配置</p>\n<p>Gradle Plugin 的设计应该秉承<strong>约定大于配置</strong>的准则，尽量减少用户陷入繁琐的配置中，又提供配置入口给具有自定义需求的用户。比如 Android Application Plugin 的 <em><strong>sourceSets</strong></em> 配置，如果不进行配置，会使用默认的目录，可以使用  <code>./gradlew :app:sourceSets</code> 打印默认使用的目录。</p>\n</li>\n<li><p>功能与约定</p>\n<p>为了让用户能够更灵活地使用你设计的 Plugin，你应该提供更为灵活的使用方式，其中一个方式就是，将实现功能与通用配置分离开来。比如： <a href=\"https://docs.gradle.org/current/userguide/standard_plugins.html?_ga=2.84655903.747719590.1526541985-590693097.1523454314#sec:base_plugins\">Java Base Plugin</a> 和 <a href=\"https://docs.gradle.org/current/userguide/java_plugin.html?_ga=2.72588053.747719590.1526541985-590693097.1523454314\">Java Plugin</a>：</p>\n<ul>\n<li>Java Base Plugin：提供了 <em><strong>sourceSets</strong></em> 配置属性，用于定义源文件的目录，但它并不会被用于任何构建任务</li>\n<li>Java Plugin：则是在 Java Base Plugin 提供的 <em><strong>sourceSets</strong></em> 配置上读取源文件，同时定义了具体的构建任务</li>\n</ul>\n<p>如果用户想实现更深层次的定制，则可以继承于 Java Base Plugin 实现自定义构建任务。</p>\n<p>在实现自定义 Plugin 可以这样实现：</p>\n<p>假设 <code>BasePlugin</code> 实现了通用配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">BasePlugin</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Plugin</span>&lt;Project&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">void</span> apply(Project project) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>MyPlugin</code> 则是基于 <code>BasePlugin</code> 实现了特定功能：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyPlugin</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Plugin</span>&lt;Project&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">void</span> apply(Project project) &#123;</span><br><span class=\"line\">        proejct.getPlugins().apply(BasePlugin.<span class=\"keyword\">class</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"技术实现\"><a href=\"#技术实现\" class=\"headerlink\" title=\"技术实现\"></a>技术实现</h4><ul>\n<li><p>倾向于使用静态类型语言来实现</p>\n<p>Gradle Plugin 的实现语言可以是任何 JVM 语言（即编译产物能在 JVM 上运行），可以是 Java、Kotlin、Groovy 等等。</p>\n<p>但建议使用 Java 或 Kotlin 等静态类型语言来实现，以降低出现不兼容的可能。</p>\n</li>\n<li><p>使用 Gradle 公开 API 实现</p>\n<p>当实现 Gradle Plugin，需要指定使用的 Gradle API 版本，例如以下配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dependencies &#123;</span><br><span class=\"line\">    compile gradleAPi()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>但因为 Gradle 的历史原因，公开和内部的 API 并没有分离开来，为了确保与各个 Gradle 版本的兼容性，请尽量使用公开的 API</p>\n<blockquote>\n<p>能在 <a href=\"https://docs.gradle.org/current/dsl/?_ga=2.131010252.258862271.1526633053-590693097.1523454314\">DSL 文档</a> 和  <a href=\"https://docs.gradle.org/current/javadoc/?_ga=2.131010252.258862271.1526633053-590693097.1523454314\">DOC 文档</a> 中找到的，即为公开的 API</p>\n</blockquote>\n</li>\n<li><p>最大程度地减少外部库的依赖</p>\n<p>当我们在编写 Plugin 时，可能会习惯性地去引入某个功能齐全的外部库，比如：Guave，但是这同时也会带来一些问题，可以使用 <code>buildEnvironment</code> task 查看构建环境依赖关系，包括 Plugin：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">classpath</span><br><span class=\"line\">+--- com.android.tools.build:gradle:2.3.3</span><br><span class=\"line\">|    \\--- com.android.tools.build:gradle-core:2.3.3</span><br><span class=\"line\">|         +--- com.android.tools.build:builder:2.3.3</span><br></pre></td></tr></table></figure>\n\n<p>因为 Gradle Plugin 并没有独立的类加载器运行环境，所以这些依赖可能会与其他 Plugin 的依赖发生冲突。</p>\n</li>\n</ul>\n<h3 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h3><p>上面是自定义 Gradle Plugin 的一些规范和注意事项，下面我们通过一个比较简单的自定义 Plugin 来实践下。</p>\n<p>这个 Plugin 的功能很简单，创建一个 task，获取配置的属性，再打印出来。</p>\n<p>上面我们说到，Plugin 可以分为脚本插件和二进制插件两种，脚本插件就是 Gradle 文件，而二进制文件的可以像普通依赖一样，从中央仓库上下载，还有一种方式是，将源码存放到当前项目下的 <em><strong>buildSrc</strong></em> module，当应用插件时，会从中查找。为了方便起见，我们使用后面那种方式。</p>\n<ul>\n<li><p>首先，我们创建一个名为 <em><strong>buildSrc</strong></em> 的 module，记得在 <code>setting.gradle</code> 中配置，在该 module 的根目录下创建 <code>build.gradle</code>，因为我们打算用 Java 实现，所以先引入 Java Plugin，同时依赖 Gradle API。</p>\n<blockquote>\n<p>Gradle 同时也提供了一个 Plugin 用于简化这些步骤，具体可以查看 <a href=\"https://docs.gradle.org/4.7/userguide/java_gradle_plugin.html?_ga=2.132564685.258862271.1526633053-590693097.1523454314\">java-gradle-plugin</a></p>\n</blockquote>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;java-library&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">dependencies &#123;</span><br><span class=\"line\">    implementation fileTree(<span class=\"attr\">dir:</span> <span class=\"string\">&#x27;libs&#x27;</span>, <span class=\"attr\">include:</span> [<span class=\"string\">&#x27;*.jar&#x27;</span>])</span><br><span class=\"line\">    implementation gradleApi()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sourceCompatibility = <span class=\"string\">&quot;1.8&quot;</span></span><br><span class=\"line\">targetCompatibility = <span class=\"string\">&quot;1.8&quot;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>接着，创建一个 Task 类型，命名为 <code>HelloWorld</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HelloWorld</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">DefaultTask</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> String userName;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@TaskAction</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Hello World，&quot;</span> + userName);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>一般继承于 <code>DefaultTask</code> 也可以选择其他 Task 基类，<code>@TaskAction</code> 是必须的，用于注解方法为 Task 运行时执行的代码，<code>userName</code> 是可选配置。</p>\n</li>\n<li><p>其实上一步做完，我们已经可以在其他 module 下的 gradle 文件中直接引用这个 Task 类型，比如：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.example.gradle.HelloWorld</span><br><span class=\"line\"></span><br><span class=\"line\">task hello(<span class=\"attr\">type:</span> HelloWorld) &#123;</span><br><span class=\"line\">    userName = <span class=\"string\">&quot;leo&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>执行 <code>./gradlew :app:hello</code> 输出 “Hello World，leo”</p>\n<blockquote>\n<p>注意：上面这样做的前提是，这部分的代码位于 <em><strong>buildSrc</strong></em> module，这也是约定配置，符合<strong>约定大于配置</strong>规范</p>\n</blockquote>\n<p>在我们这个例子中，我们通过 Plugin 去动态创建一个 Task：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HelloWorldPlugin</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Plugin</span>&lt;Project&gt; &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">apply</span><span class=\"params\">(Project project)</span> &#123;</span><br><span class=\"line\">        project.getTasks().create(<span class=\"string\">&quot;pluginHello&quot;</span>, HelloWorld.class, helloWorld -&gt;</span><br><span class=\"line\">                helloWorld.userName = <span class=\"string\">&quot;leo&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>实现自定义 Plugin 需要实现于 Plugin，接着在 <code>apply()</code> 中添加一个名为 “pluginHello”，类型为 <code>HelloWorld</code> 的 Task。</p>\n</li>\n<li><p>至此，我们已经写好了 Plugin 的逻辑代码，要想在当前项目中的其他 module 中引用 <em><strong>buildSrc</strong></em> 中的 Plugin，需要给 <code>HelloWorldPlugin</code> 指定一个 ID，注：直接写在构建脚本中的插件则不需要。具体配置如下：</p>\n<p>在 <code>src/main/resources/META-INF/gradle-plugins/</code> 目录下创建一个配置文件，命名规则为：***[PluginID].properties***，在我们这个例子中为：<code>com.example.hello.properties</code>：</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">implementation-class</span>=<span class=\"string\">com.example.gradle.HelloWorldPlugin</span></span><br></pre></td></tr></table></figure>\n\n<p><code>implementation-class</code> 表示 Plugin 类</p>\n<blockquote>\n<p>Plugin ID 应该符合以下规定：</p>\n<ul>\n<li>可以包含任何字母、字符，’.’、’-‘</li>\n<li>必须至少包含一个 ‘.’ 分隔命名空间和插件名称</li>\n<li>按照惯例，使用域名反向小写作为命名空间</li>\n<li>按照惯例，命名空间只使用小写字母</li>\n<li><code>org.gradle</code> 和 <code>com.gradleware</code> 命名空间不能被使用</li>\n<li>不能使用 ‘.’ 作为开始或结束字符</li>\n<li>不能使用连续的 ‘.’ 字符</li>\n</ul>\n</blockquote>\n</li>\n<li><p>至此，我们已经写好了一个简单自定义 Plugin，我们在 app module 下的 <code>build.gradle</code> 引入这个它：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply plugin: &#x27;com.example.hello&#x27;</span><br></pre></td></tr></table></figure>\n\n<p>执行 <code>./gradlew :app:pluginHello</code> 输出 “Hello World，leo”</p>\n<blockquote>\n<p>上面我们提到了 java-gradle-plugin，如果使用这个 Plugin 的话，可以无需手动配置 properties，只需在 gradle 中配置如下即可：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gradlePlugin &#123;</span><br><span class=\"line\">    plugins &#123;</span><br><span class=\"line\">        helloPlugin &#123;</span><br><span class=\"line\">            id = <span class=\"string\">&#x27;com.example.hello&#x27;</span></span><br><span class=\"line\">            implementationClass = <span class=\"string\">&#x27;com.example.gradle.HelloWorldPlugin&#x27;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></blockquote>\n</li>\n</ul>\n<h3 id=\"插件源码\"><a href=\"#插件源码\" class=\"headerlink\" title=\"插件源码\"></a>插件源码</h3><p>在上面的例子中，我们将代码写在了 <em><strong>buildSrc</strong></em> module 中，那么除此之外还有：</p>\n<ul>\n<li><p>构建脚本</p>\n<p>可以将 Plugin 的源码直接包含在构建脚本中，这样子可以方便地在当前构建脚本直接使用该 Plugin，但是无法在其他构建脚本中使用。</p>\n<p><em><strong>build.gradle</strong></em></p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">TestPlugin</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Plugin</span>&lt;Project&gt; &#123;</span><br><span class=\"line\">    <span class=\"type\">void</span> apply(Project project) &#123;</span><br><span class=\"line\">        project.tasks.create(<span class=\"string\">&#x27;pluginTest&#x27;</span>) &#123;</span><br><span class=\"line\">            doLast &#123;</span><br><span class=\"line\">                println <span class=\"string\">&quot;This is Test&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">apply <span class=\"attr\">plugin:</span> TestPlugin</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>需要注意：上面的书写顺序，还记得我们之前说的<strong>边读取边解释</strong></p>\n</blockquote>\n</li>\n<li><p>单独的项目</p>\n<p>你可以为 Gradle Plugin 创建一个单独的项目，这种方式和 <em><strong>buildSrc</strong></em> 类似，并且可以生成 JAR 上传到中央仓库提供给其他开发者使用，而 <em><strong>buildSrc</strong></em> 只能在当前项目中使用。</p>\n</li>\n</ul>\n<h3 id=\"结束语\"><a href=\"#结束语\" class=\"headerlink\" title=\"结束语\"></a>结束语</h3><p>由于篇幅的限制，基础篇我们就讲到这里，后续的文章还会更深入地讲解 Gradle Plugin 知识。</p>\n"},{"title":"Gradle插件-提高篇","date":"2018-05-21T00:44:35.000Z","_content":"\n## 前言\n\n在上一篇文章 [Gradle插件-基础篇](https://linxiaotao.github.io/2018/05/16/Gradle%E6%8F%92%E4%BB%B6-%E5%9F%BA%E7%A1%80%E7%AF%87/) 中，我们学习了 Plugin 的设计规范，并且通过一个非常简单的例子对自定义 Plugin 有了初步认识，在这篇文章中，我们来继续学习 Gradle Plugin 更为深入的知识点。\n\n> 本文参考 [Gradle用户手册](https://guides.gradle.org/implementing-gradle-plugins/?_ga=2.31320828.258862271.1526633053-590693097.1523454314#writing-and-using-custom-task-types) \n\n## Gradle插件\n\n> 本文涉及的所有源码都位于 [github](https://github.com/LinXiaoTao/GradleCaseProject)\n\n### 简单扩展\n\n当我们引入 Android Plugin 时，在 `android{}` 有一些常用的配置，比如：\n\n``` groovy\nandroid {\n    compileSdkVersion 27\n}\n```\n\n如果我们想在自定义的 Plugin 中也使用这样的配置，可以使用 Gradle 提供的扩展功能：`Extensions` ，在第一篇文章中我们自定义了一个简单的 `com.example.hello` 插件，我们现在就在这个基础上添加一个扩展功能，最终实现的配置如下：\n\n``` groovy\nhello {\n    outFile 'hello'\n}\n```\n\n向 outFile 指定的文件中写入一句 \"Hello World\"，如文件不存在则创建它。\n\n为了创建扩展，我们先定义一个数据模型用于读取配置：\n\n``` java\npublic class HelloModel {\n    \n    private String outFile;\n\n    public String getOutFile() {\n        return outFile;\n    }\n\n    public void setOutFile(String outFile) {\n        this.outFile = outFile;\n    }\n}\n```\n\n接着使用 `ExtensionContainer` 创建一个扩展：\n\n``` java\nproject.getExtensions().create(\"hello\", HelloModel.class);\n```\n\n`getExtensions(String,Class,Object...)` 这个方法有三个参数，第一个参数为扩展的名称即在 ***gradle*** 文件中使用的配置块，第二个参数为扩展的模型，用于定义可配置的属性，在上面的例子上，只有一个简单的 `outFile` 表示输出文件，第三个参数为可变长参数，表示模型的构造参数，在这个例子中，我们使用默认的无参构造函数。\n\n经过上面的步骤，我们已经创建好了扩展，接下来是读取扩展的属性值，还记得我们之前说的，**Gradle 是边读取边解释**，所以当我们 `apply plugin` 时，会创建好扩展，而扩展的属性值配置只能在 `apply plugin` 之后，所以我们在 plugin 中直接读取扩展属性值是不行的，必须在项目评估完成之后：\n\n``` java \nproject.afterEvaluate(project1 -> {\n            HelloModel helloModel = project1.getExtensions().getByType(HelloModel.class);\n            mLogger.quiet(\"hello : \" + helloModel);\n            if (helloModel.getOutFile() == null || helloModel.getOutFile().isEmpty()) {\n                throw new GradleException(\"outFile 不能等于空\");\n            }\n            FileOutputStream fileOutputStream = null;\n            try {\n                File outFile = project1.file(helloModel.getOutFile());\n                if (!outFile.exists()) {\n                    outFile.createNewFile();\n                }\n                fileOutputStream = new FileOutputStream(outFile);\n                fileOutputStream.write(\"Hello World\".getBytes());\n            } catch (Exception e) {\n                e.printStackTrace();\n            } finally {\n                if (fileOutputStream != null) {\n                    try {\n                        fileOutputStream.close();\n                    } catch (IOException e) {\n                        e.printStackTrace();\n                    }\n                }\n            }\n        });\n```\n\n逻辑比较简单，我们现在直接运行在 `.gradlew` 即可，可以看到在 app 目录下生成一个 ***hello*** 文件：\n\n```\nHello World\n```\n\n### 嵌套扩展\n\n如果要想实现如下 DSL 配置：\n\n``` groovy\nandroid {\n    defaultConfig {\n        applicationId \"com.example.leo.gradlecaseproject\"\n    }\n}\n```\n\nGradle 也支持这种嵌套扩展，同样是上面的例子，我们现在想添加一个 `info` 配置块，将这部分的信息也写入到文件中，最终配置如下：\n\n``` groovy\nhello {\n    outFile = 'hello'\n    info {\n        username = \"leo\"\n        email = \"linxiaotao1993@vip.qq.com\"\n    }\n}\n```\n\n首先我们先创建一个 InfoModel，这里有个要注意的地方：用于实现扩展的类不能是 `final`，因为最终用于扩展的实现类就是继承于这个类。\n\n``` java\nstatic class InfoModel {\n        private String username;\n        private String email;\n\n        @Inject\n        public InfoModel() {\n        }\n\n        public String getUsername() {\n            return username;\n        }\n\n        public void setUsername(String username) {\n            this.username = username;\n        }\n\n        public String getEmail() {\n            return email;\n        }\n\n        public void setEmail(String email) {\n            this.email = email;\n        }\n\n        @Override\n        public String toString() {\n            return \"InfoModel{\" +\n                    \"username='\" + username + '\\'' +\n                    \", email='\" + email + '\\'' +\n                    '}';\n        }\n    }\n```\n\n上面在构造方法中添加 `@Inject` 注解是为了能用 Gradle 提供的 `ObjectFactor` 用于实现依赖注入功能。而在原来的 `HelloModel` 中，我们增加了 `private final InfoModel info;` 同时在构建函数中增加了 `ObjectFactory` 参数：\n\n``` java\npublic HelloModel(ObjectFactory objectFactory) {\n        info = objectFactory.newInstance(InfoModel.class);\n}\n```\n\n但这样还不够，还需要当 `info` 配置块被调用时所传递的实例：\n\n``` java\npublic void info(Action<InfoModel> action) {\n        action.execute(info);\n}\n```\n\n注意：这里的方法名和 DSL 中的使用的配置块名称一致。\n\n最后我们在写入文件时，将这部分配置的信息也写入，同时在生成扩展时提供 `ObjectFactor` 实例：\n\n``` java\nproject.getExtensions().create(\"hello\", HelloModel.class, project.getObjects());\n\nfileOutputStream.write(String.format(\n                        Locale.getDefault(),\n                        \"Hello World\\ncreate by %s %s\",\n                        helloModel.getInfo().getUsername(),\n                        helloModel.getInfo().getEmail()).getBytes()\n                      );\n```\n\n最后执行下就可以看到结果了。\n\n> 可以看到 Gradle 可以很方便地使用依赖注入。\n\n### 配置容器\n\n在 Android 项目中，我们可以去配置不同的构建变体：\n\n``` groovy\nflavorDimensions \"api\", \"mode\"\n    productFlavors {\n        demo {\n            dimension \"mode\"\n        }\n        full {\n            dimension \"mode\"\n        }\n        minApi24 {\n            dimension \"api\"\n        }\n        minApi23 {\n            dimension \"api\"\n        }\n    }\n```\n\n如果我们想要实现类似 `productFlavors` 这种动态生成的 DSL 配置块，我们可以使用 `NamedDomainObjectContainer` 来实现，接着上面的例子，我们最终的配置如下：\n\n``` groovy\nhello {\n    outFile = 'hello'\n    info {\n        username = \"leo\"\n        email = \"linxiaotao1993@vip.qq.com\"\n    }\n    other {\n        time {\n            value = new SimpleDateFormat(\"yyyy-MM-dd\").format(new Date())\n        }\n    }\n}\n```\n\n我们先创建 `ValueModel` 用于表示容器中每一项的格式，注意：这个类必须有个字段为 `name` ，比如上面的例子中，`name` 就是我们配置的 `time`：\n\n``` java\npublic class ValueModel {\n\n    private final String name;\n    private String value;\n\n    public ValueModel(String name) {\n        this.name = name;\n    }\n\n    @Override\n    public String toString() {\n        return \"ValueModel{\" +\n                \"name='\" + name + '\\'' +\n                \", value='\" + value + '\\'' +\n                '}';\n    }\n\n    public String getName() {\n        return name;\n    }\n\n    public String getValue() {\n        return value;\n    }\n\n    public void setValue(String value) {\n        this.value = value;\n    }\n}\n```\n\n> 这个类不能写成内部类，静态内部类也不行\n\n接着，我们在 `HelloModel` 中同样创建 `other` 配置块，需要注意的是，这里我们要使用 `NamedDomainObjectContainer` ：\n\n``` java\npublic void other(Action<NamedDomainObjectContainer<ValueModel>> action) {\n        action.execute(other);\n}\n```\n\n而 `other` 则是这样子创建的：\n\n``` java\nother = project.container(ValueModel.class);\n```\n\n最后，同样的，我们将这块的配置也写入到 `hello` 文件中：\n\n``` java\nStringBuilder otherString = new StringBuilder();\n                helloModel.getOther().forEach(valueModel ->\n                        otherString.append(valueModel.getName())\n                                .append(\"：\")\n                                .append(valueModel.getValue())\n                                .append(\"\\n\"));\n                fileOutputStream.write(String.format(\n                        Locale.getDefault(),\n                        \"Hello World\\ncreate by %s %s\\n%s\",\n                        helloModel.getInfo().getUsername(),\n                        helloModel.getInfo().getEmail(),\n                        otherString.toString()).getBytes()\n);\n```\n\n### 懒加载属性\n\n在上面的例子中，我们都是通过使用原始数据类型去映射在构建脚本中的配置，这种方式会在配置完成之后直接映射，Gradle 4.0 提供了 `Provider` 和 `Property` 来提供懒加载属性，其中 `Provider` 表示不可变属性，`Property` 表示可变属性。这个 API 提供了两个好处：\n\n1. 可以放心地连接不同的数据模型，而不用担心某个数据模型的值是否已经知道。举个例子，比如你想将扩展中的属性映射到 task 中的属性，但扩展的属性值只有在构建脚本配置后才能知道。\n2. 避免在构建阶段进行资源密集型工作，比如当属性值时从文件中解析时\n\n使用也比较简单，首先我们先声明一个`Property<String>` 然后使用 `ObjectFactor` 去创建：\n\n``` java\nprivate final Property<String> testProperty;\n\ntestProperty = project.getObjects().property(String.class);\n```\n\n> Gradle 会自动为 `Property` 生成 setter 方法，同时允许你使用 \"=\" 操作符来设置属性值\n\n## 总结\n\n在这篇文章中，我们主要讲的是，在自定义 Plugin 中经常用的到扩展功能，下一篇文章中，我们就开始进入 Plugin 的编写。","source":"_posts/Gradle插件-提高篇.md","raw":"---\ntitle: Gradle插件-提高篇\ndate: 2018-05-21 08:44:35\ncategories: Gradle\ntags:\n---\n\n## 前言\n\n在上一篇文章 [Gradle插件-基础篇](https://linxiaotao.github.io/2018/05/16/Gradle%E6%8F%92%E4%BB%B6-%E5%9F%BA%E7%A1%80%E7%AF%87/) 中，我们学习了 Plugin 的设计规范，并且通过一个非常简单的例子对自定义 Plugin 有了初步认识，在这篇文章中，我们来继续学习 Gradle Plugin 更为深入的知识点。\n\n> 本文参考 [Gradle用户手册](https://guides.gradle.org/implementing-gradle-plugins/?_ga=2.31320828.258862271.1526633053-590693097.1523454314#writing-and-using-custom-task-types) \n\n## Gradle插件\n\n> 本文涉及的所有源码都位于 [github](https://github.com/LinXiaoTao/GradleCaseProject)\n\n### 简单扩展\n\n当我们引入 Android Plugin 时，在 `android{}` 有一些常用的配置，比如：\n\n``` groovy\nandroid {\n    compileSdkVersion 27\n}\n```\n\n如果我们想在自定义的 Plugin 中也使用这样的配置，可以使用 Gradle 提供的扩展功能：`Extensions` ，在第一篇文章中我们自定义了一个简单的 `com.example.hello` 插件，我们现在就在这个基础上添加一个扩展功能，最终实现的配置如下：\n\n``` groovy\nhello {\n    outFile 'hello'\n}\n```\n\n向 outFile 指定的文件中写入一句 \"Hello World\"，如文件不存在则创建它。\n\n为了创建扩展，我们先定义一个数据模型用于读取配置：\n\n``` java\npublic class HelloModel {\n    \n    private String outFile;\n\n    public String getOutFile() {\n        return outFile;\n    }\n\n    public void setOutFile(String outFile) {\n        this.outFile = outFile;\n    }\n}\n```\n\n接着使用 `ExtensionContainer` 创建一个扩展：\n\n``` java\nproject.getExtensions().create(\"hello\", HelloModel.class);\n```\n\n`getExtensions(String,Class,Object...)` 这个方法有三个参数，第一个参数为扩展的名称即在 ***gradle*** 文件中使用的配置块，第二个参数为扩展的模型，用于定义可配置的属性，在上面的例子上，只有一个简单的 `outFile` 表示输出文件，第三个参数为可变长参数，表示模型的构造参数，在这个例子中，我们使用默认的无参构造函数。\n\n经过上面的步骤，我们已经创建好了扩展，接下来是读取扩展的属性值，还记得我们之前说的，**Gradle 是边读取边解释**，所以当我们 `apply plugin` 时，会创建好扩展，而扩展的属性值配置只能在 `apply plugin` 之后，所以我们在 plugin 中直接读取扩展属性值是不行的，必须在项目评估完成之后：\n\n``` java \nproject.afterEvaluate(project1 -> {\n            HelloModel helloModel = project1.getExtensions().getByType(HelloModel.class);\n            mLogger.quiet(\"hello : \" + helloModel);\n            if (helloModel.getOutFile() == null || helloModel.getOutFile().isEmpty()) {\n                throw new GradleException(\"outFile 不能等于空\");\n            }\n            FileOutputStream fileOutputStream = null;\n            try {\n                File outFile = project1.file(helloModel.getOutFile());\n                if (!outFile.exists()) {\n                    outFile.createNewFile();\n                }\n                fileOutputStream = new FileOutputStream(outFile);\n                fileOutputStream.write(\"Hello World\".getBytes());\n            } catch (Exception e) {\n                e.printStackTrace();\n            } finally {\n                if (fileOutputStream != null) {\n                    try {\n                        fileOutputStream.close();\n                    } catch (IOException e) {\n                        e.printStackTrace();\n                    }\n                }\n            }\n        });\n```\n\n逻辑比较简单，我们现在直接运行在 `.gradlew` 即可，可以看到在 app 目录下生成一个 ***hello*** 文件：\n\n```\nHello World\n```\n\n### 嵌套扩展\n\n如果要想实现如下 DSL 配置：\n\n``` groovy\nandroid {\n    defaultConfig {\n        applicationId \"com.example.leo.gradlecaseproject\"\n    }\n}\n```\n\nGradle 也支持这种嵌套扩展，同样是上面的例子，我们现在想添加一个 `info` 配置块，将这部分的信息也写入到文件中，最终配置如下：\n\n``` groovy\nhello {\n    outFile = 'hello'\n    info {\n        username = \"leo\"\n        email = \"linxiaotao1993@vip.qq.com\"\n    }\n}\n```\n\n首先我们先创建一个 InfoModel，这里有个要注意的地方：用于实现扩展的类不能是 `final`，因为最终用于扩展的实现类就是继承于这个类。\n\n``` java\nstatic class InfoModel {\n        private String username;\n        private String email;\n\n        @Inject\n        public InfoModel() {\n        }\n\n        public String getUsername() {\n            return username;\n        }\n\n        public void setUsername(String username) {\n            this.username = username;\n        }\n\n        public String getEmail() {\n            return email;\n        }\n\n        public void setEmail(String email) {\n            this.email = email;\n        }\n\n        @Override\n        public String toString() {\n            return \"InfoModel{\" +\n                    \"username='\" + username + '\\'' +\n                    \", email='\" + email + '\\'' +\n                    '}';\n        }\n    }\n```\n\n上面在构造方法中添加 `@Inject` 注解是为了能用 Gradle 提供的 `ObjectFactor` 用于实现依赖注入功能。而在原来的 `HelloModel` 中，我们增加了 `private final InfoModel info;` 同时在构建函数中增加了 `ObjectFactory` 参数：\n\n``` java\npublic HelloModel(ObjectFactory objectFactory) {\n        info = objectFactory.newInstance(InfoModel.class);\n}\n```\n\n但这样还不够，还需要当 `info` 配置块被调用时所传递的实例：\n\n``` java\npublic void info(Action<InfoModel> action) {\n        action.execute(info);\n}\n```\n\n注意：这里的方法名和 DSL 中的使用的配置块名称一致。\n\n最后我们在写入文件时，将这部分配置的信息也写入，同时在生成扩展时提供 `ObjectFactor` 实例：\n\n``` java\nproject.getExtensions().create(\"hello\", HelloModel.class, project.getObjects());\n\nfileOutputStream.write(String.format(\n                        Locale.getDefault(),\n                        \"Hello World\\ncreate by %s %s\",\n                        helloModel.getInfo().getUsername(),\n                        helloModel.getInfo().getEmail()).getBytes()\n                      );\n```\n\n最后执行下就可以看到结果了。\n\n> 可以看到 Gradle 可以很方便地使用依赖注入。\n\n### 配置容器\n\n在 Android 项目中，我们可以去配置不同的构建变体：\n\n``` groovy\nflavorDimensions \"api\", \"mode\"\n    productFlavors {\n        demo {\n            dimension \"mode\"\n        }\n        full {\n            dimension \"mode\"\n        }\n        minApi24 {\n            dimension \"api\"\n        }\n        minApi23 {\n            dimension \"api\"\n        }\n    }\n```\n\n如果我们想要实现类似 `productFlavors` 这种动态生成的 DSL 配置块，我们可以使用 `NamedDomainObjectContainer` 来实现，接着上面的例子，我们最终的配置如下：\n\n``` groovy\nhello {\n    outFile = 'hello'\n    info {\n        username = \"leo\"\n        email = \"linxiaotao1993@vip.qq.com\"\n    }\n    other {\n        time {\n            value = new SimpleDateFormat(\"yyyy-MM-dd\").format(new Date())\n        }\n    }\n}\n```\n\n我们先创建 `ValueModel` 用于表示容器中每一项的格式，注意：这个类必须有个字段为 `name` ，比如上面的例子中，`name` 就是我们配置的 `time`：\n\n``` java\npublic class ValueModel {\n\n    private final String name;\n    private String value;\n\n    public ValueModel(String name) {\n        this.name = name;\n    }\n\n    @Override\n    public String toString() {\n        return \"ValueModel{\" +\n                \"name='\" + name + '\\'' +\n                \", value='\" + value + '\\'' +\n                '}';\n    }\n\n    public String getName() {\n        return name;\n    }\n\n    public String getValue() {\n        return value;\n    }\n\n    public void setValue(String value) {\n        this.value = value;\n    }\n}\n```\n\n> 这个类不能写成内部类，静态内部类也不行\n\n接着，我们在 `HelloModel` 中同样创建 `other` 配置块，需要注意的是，这里我们要使用 `NamedDomainObjectContainer` ：\n\n``` java\npublic void other(Action<NamedDomainObjectContainer<ValueModel>> action) {\n        action.execute(other);\n}\n```\n\n而 `other` 则是这样子创建的：\n\n``` java\nother = project.container(ValueModel.class);\n```\n\n最后，同样的，我们将这块的配置也写入到 `hello` 文件中：\n\n``` java\nStringBuilder otherString = new StringBuilder();\n                helloModel.getOther().forEach(valueModel ->\n                        otherString.append(valueModel.getName())\n                                .append(\"：\")\n                                .append(valueModel.getValue())\n                                .append(\"\\n\"));\n                fileOutputStream.write(String.format(\n                        Locale.getDefault(),\n                        \"Hello World\\ncreate by %s %s\\n%s\",\n                        helloModel.getInfo().getUsername(),\n                        helloModel.getInfo().getEmail(),\n                        otherString.toString()).getBytes()\n);\n```\n\n### 懒加载属性\n\n在上面的例子中，我们都是通过使用原始数据类型去映射在构建脚本中的配置，这种方式会在配置完成之后直接映射，Gradle 4.0 提供了 `Provider` 和 `Property` 来提供懒加载属性，其中 `Provider` 表示不可变属性，`Property` 表示可变属性。这个 API 提供了两个好处：\n\n1. 可以放心地连接不同的数据模型，而不用担心某个数据模型的值是否已经知道。举个例子，比如你想将扩展中的属性映射到 task 中的属性，但扩展的属性值只有在构建脚本配置后才能知道。\n2. 避免在构建阶段进行资源密集型工作，比如当属性值时从文件中解析时\n\n使用也比较简单，首先我们先声明一个`Property<String>` 然后使用 `ObjectFactor` 去创建：\n\n``` java\nprivate final Property<String> testProperty;\n\ntestProperty = project.getObjects().property(String.class);\n```\n\n> Gradle 会自动为 `Property` 生成 setter 方法，同时允许你使用 \"=\" 操作符来设置属性值\n\n## 总结\n\n在这篇文章中，我们主要讲的是，在自定义 Plugin 中经常用的到扩展功能，下一篇文章中，我们就开始进入 Plugin 的编写。","slug":"Gradle插件-提高篇","published":1,"updated":"2022-06-15T11:19:32.318Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlb0007fho6dlbm4ojr","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在上一篇文章 <a href=\"https://linxiaotao.github.io/2018/05/16/Gradle%E6%8F%92%E4%BB%B6-%E5%9F%BA%E7%A1%80%E7%AF%87/\">Gradle插件-基础篇</a> 中，我们学习了 Plugin 的设计规范，并且通过一个非常简单的例子对自定义 Plugin 有了初步认识，在这篇文章中，我们来继续学习 Gradle Plugin 更为深入的知识点。</p>\n<blockquote>\n<p>本文参考 <a href=\"https://guides.gradle.org/implementing-gradle-plugins/?_ga=2.31320828.258862271.1526633053-590693097.1523454314#writing-and-using-custom-task-types\">Gradle用户手册</a> </p>\n</blockquote>\n<h2 id=\"Gradle插件\"><a href=\"#Gradle插件\" class=\"headerlink\" title=\"Gradle插件\"></a>Gradle插件</h2><blockquote>\n<p>本文涉及的所有源码都位于 <a href=\"https://github.com/LinXiaoTao/GradleCaseProject\">github</a></p>\n</blockquote>\n<h3 id=\"简单扩展\"><a href=\"#简单扩展\" class=\"headerlink\" title=\"简单扩展\"></a>简单扩展</h3><p>当我们引入 Android Plugin 时，在 <code>android&#123;&#125;</code> 有一些常用的配置，比如：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">android &#123;</span><br><span class=\"line\">    compileSdkVersion <span class=\"number\">27</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果我们想在自定义的 Plugin 中也使用这样的配置，可以使用 Gradle 提供的扩展功能：<code>Extensions</code> ，在第一篇文章中我们自定义了一个简单的 <code>com.example.hello</code> 插件，我们现在就在这个基础上添加一个扩展功能，最终实现的配置如下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hello &#123;</span><br><span class=\"line\">    outFile <span class=\"string\">&#x27;hello&#x27;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>向 outFile 指定的文件中写入一句 “Hello World”，如文件不存在则创建它。</p>\n<p>为了创建扩展，我们先定义一个数据模型用于读取配置：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HelloModel</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> String outFile;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">getOutFile</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> outFile;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setOutFile</span><span class=\"params\">(String outFile)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.outFile = outFile;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>接着使用 <code>ExtensionContainer</code> 创建一个扩展：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.getExtensions().create(<span class=\"string\">&quot;hello&quot;</span>, HelloModel.class);</span><br></pre></td></tr></table></figure>\n\n<p><code>getExtensions(String,Class,Object...)</code> 这个方法有三个参数，第一个参数为扩展的名称即在 <em><strong>gradle</strong></em> 文件中使用的配置块，第二个参数为扩展的模型，用于定义可配置的属性，在上面的例子上，只有一个简单的 <code>outFile</code> 表示输出文件，第三个参数为可变长参数，表示模型的构造参数，在这个例子中，我们使用默认的无参构造函数。</p>\n<p>经过上面的步骤，我们已经创建好了扩展，接下来是读取扩展的属性值，还记得我们之前说的，<strong>Gradle 是边读取边解释</strong>，所以当我们 <code>apply plugin</code> 时，会创建好扩展，而扩展的属性值配置只能在 <code>apply plugin</code> 之后，所以我们在 plugin 中直接读取扩展属性值是不行的，必须在项目评估完成之后：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.afterEvaluate(project1 -&gt; &#123;</span><br><span class=\"line\">            <span class=\"type\">HelloModel</span> <span class=\"variable\">helloModel</span> <span class=\"operator\">=</span> project1.getExtensions().getByType(HelloModel.class);</span><br><span class=\"line\">            mLogger.quiet(<span class=\"string\">&quot;hello : &quot;</span> + helloModel);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (helloModel.getOutFile() == <span class=\"literal\">null</span> || helloModel.getOutFile().isEmpty()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">GradleException</span>(<span class=\"string\">&quot;outFile 不能等于空&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">FileOutputStream</span> <span class=\"variable\">fileOutputStream</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"type\">File</span> <span class=\"variable\">outFile</span> <span class=\"operator\">=</span> project1.file(helloModel.getOutFile());</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!outFile.exists()) &#123;</span><br><span class=\"line\">                    outFile.createNewFile();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                fileOutputStream = <span class=\"keyword\">new</span> <span class=\"title class_\">FileOutputStream</span>(outFile);</span><br><span class=\"line\">                fileOutputStream.write(<span class=\"string\">&quot;Hello World&quot;</span>.getBytes());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (fileOutputStream != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        fileOutputStream.close();</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                        e.printStackTrace();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br></pre></td></tr></table></figure>\n\n<p>逻辑比较简单，我们现在直接运行在 <code>.gradlew</code> 即可，可以看到在 app 目录下生成一个 <em><strong>hello</strong></em> 文件：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Hello World</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"嵌套扩展\"><a href=\"#嵌套扩展\" class=\"headerlink\" title=\"嵌套扩展\"></a>嵌套扩展</h3><p>如果要想实现如下 DSL 配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">android &#123;</span><br><span class=\"line\">    defaultConfig &#123;</span><br><span class=\"line\">        applicationId <span class=\"string\">&quot;com.example.leo.gradlecaseproject&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Gradle 也支持这种嵌套扩展，同样是上面的例子，我们现在想添加一个 <code>info</code> 配置块，将这部分的信息也写入到文件中，最终配置如下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hello &#123;</span><br><span class=\"line\">    outFile = <span class=\"string\">&#x27;hello&#x27;</span></span><br><span class=\"line\">    info &#123;</span><br><span class=\"line\">        username = <span class=\"string\">&quot;leo&quot;</span></span><br><span class=\"line\">        email = <span class=\"string\">&quot;linxiaotao1993@vip.qq.com&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先我们先创建一个 InfoModel，这里有个要注意的地方：用于实现扩展的类不能是 <code>final</code>，因为最终用于扩展的实现类就是继承于这个类。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">InfoModel</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> String username;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> String email;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Inject</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"title function_\">InfoModel</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> String <span class=\"title function_\">getUsername</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> username;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setUsername</span><span class=\"params\">(String username)</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.username = username;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> String <span class=\"title function_\">getEmail</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> email;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setEmail</span><span class=\"params\">(String email)</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.email = email;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> String <span class=\"title function_\">toString</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;InfoModel&#123;&quot;</span> +</span><br><span class=\"line\">                    <span class=\"string\">&quot;username=&#x27;&quot;</span> + username + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                    <span class=\"string\">&quot;, email=&#x27;&quot;</span> + email + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                    <span class=\"string\">&#x27;&#125;&#x27;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>上面在构造方法中添加 <code>@Inject</code> 注解是为了能用 Gradle 提供的 <code>ObjectFactor</code> 用于实现依赖注入功能。而在原来的 <code>HelloModel</code> 中，我们增加了 <code>private final InfoModel info;</code> 同时在构建函数中增加了 <code>ObjectFactory</code> 参数：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">HelloModel</span><span class=\"params\">(ObjectFactory objectFactory)</span> &#123;</span><br><span class=\"line\">        info = objectFactory.newInstance(InfoModel.class);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>但这样还不够，还需要当 <code>info</code> 配置块被调用时所传递的实例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">info</span><span class=\"params\">(Action&lt;InfoModel&gt; action)</span> &#123;</span><br><span class=\"line\">        action.execute(info);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>注意：这里的方法名和 DSL 中的使用的配置块名称一致。</p>\n<p>最后我们在写入文件时，将这部分配置的信息也写入，同时在生成扩展时提供 <code>ObjectFactor</code> 实例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.getExtensions().create(<span class=\"string\">&quot;hello&quot;</span>, HelloModel.class, project.getObjects());</span><br><span class=\"line\"></span><br><span class=\"line\">fileOutputStream.write(String.format(</span><br><span class=\"line\">                        Locale.getDefault(),</span><br><span class=\"line\">                        <span class=\"string\">&quot;Hello World\\ncreate by %s %s&quot;</span>,</span><br><span class=\"line\">                        helloModel.getInfo().getUsername(),</span><br><span class=\"line\">                        helloModel.getInfo().getEmail()).getBytes()</span><br><span class=\"line\">                      );</span><br></pre></td></tr></table></figure>\n\n<p>最后执行下就可以看到结果了。</p>\n<blockquote>\n<p>可以看到 Gradle 可以很方便地使用依赖注入。</p>\n</blockquote>\n<h3 id=\"配置容器\"><a href=\"#配置容器\" class=\"headerlink\" title=\"配置容器\"></a>配置容器</h3><p>在 Android 项目中，我们可以去配置不同的构建变体：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flavorDimensions <span class=\"string\">&quot;api&quot;</span>, <span class=\"string\">&quot;mode&quot;</span></span><br><span class=\"line\">    productFlavors &#123;</span><br><span class=\"line\">        demo &#123;</span><br><span class=\"line\">            dimension <span class=\"string\">&quot;mode&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        full &#123;</span><br><span class=\"line\">            dimension <span class=\"string\">&quot;mode&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        minApi24 &#123;</span><br><span class=\"line\">            dimension <span class=\"string\">&quot;api&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        minApi23 &#123;</span><br><span class=\"line\">            dimension <span class=\"string\">&quot;api&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果我们想要实现类似 <code>productFlavors</code> 这种动态生成的 DSL 配置块，我们可以使用 <code>NamedDomainObjectContainer</code> 来实现，接着上面的例子，我们最终的配置如下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hello &#123;</span><br><span class=\"line\">    outFile = <span class=\"string\">&#x27;hello&#x27;</span></span><br><span class=\"line\">    info &#123;</span><br><span class=\"line\">        username = <span class=\"string\">&quot;leo&quot;</span></span><br><span class=\"line\">        email = <span class=\"string\">&quot;linxiaotao1993@vip.qq.com&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    other &#123;</span><br><span class=\"line\">        time &#123;</span><br><span class=\"line\">            value = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">&quot;yyyy-MM-dd&quot;</span>).format(<span class=\"keyword\">new</span> Date())</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>我们先创建 <code>ValueModel</code> 用于表示容器中每一项的格式，注意：这个类必须有个字段为 <code>name</code> ，比如上面的例子中，<code>name</code> 就是我们配置的 <code>time</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ValueModel</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">ValueModel</span><span class=\"params\">(String name)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">toString</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;ValueModel&#123;&quot;</span> +</span><br><span class=\"line\">                <span class=\"string\">&quot;name=&#x27;&quot;</span> + name + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                <span class=\"string\">&quot;, value=&#x27;&quot;</span> + value + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                <span class=\"string\">&#x27;&#125;&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">getName</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">getValue</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setValue</span><span class=\"params\">(String value)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.value = value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这个类不能写成内部类，静态内部类也不行</p>\n</blockquote>\n<p>接着，我们在 <code>HelloModel</code> 中同样创建 <code>other</code> 配置块，需要注意的是，这里我们要使用 <code>NamedDomainObjectContainer</code> ：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">other</span><span class=\"params\">(Action&lt;NamedDomainObjectContainer&lt;ValueModel&gt;&gt; action)</span> &#123;</span><br><span class=\"line\">        action.execute(other);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>而 <code>other</code> 则是这样子创建的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">other = project.container(ValueModel.class);</span><br></pre></td></tr></table></figure>\n\n<p>最后，同样的，我们将这块的配置也写入到 <code>hello</code> 文件中：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">StringBuilder</span> <span class=\"variable\">otherString</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">StringBuilder</span>();</span><br><span class=\"line\">                helloModel.getOther().forEach(valueModel -&gt;</span><br><span class=\"line\">                        otherString.append(valueModel.getName())</span><br><span class=\"line\">                                .append(<span class=\"string\">&quot;：&quot;</span>)</span><br><span class=\"line\">                                .append(valueModel.getValue())</span><br><span class=\"line\">                                .append(<span class=\"string\">&quot;\\n&quot;</span>));</span><br><span class=\"line\">                fileOutputStream.write(String.format(</span><br><span class=\"line\">                        Locale.getDefault(),</span><br><span class=\"line\">                        <span class=\"string\">&quot;Hello World\\ncreate by %s %s\\n%s&quot;</span>,</span><br><span class=\"line\">                        helloModel.getInfo().getUsername(),</span><br><span class=\"line\">                        helloModel.getInfo().getEmail(),</span><br><span class=\"line\">                        otherString.toString()).getBytes()</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"懒加载属性\"><a href=\"#懒加载属性\" class=\"headerlink\" title=\"懒加载属性\"></a>懒加载属性</h3><p>在上面的例子中，我们都是通过使用原始数据类型去映射在构建脚本中的配置，这种方式会在配置完成之后直接映射，Gradle 4.0 提供了 <code>Provider</code> 和 <code>Property</code> 来提供懒加载属性，其中 <code>Provider</code> 表示不可变属性，<code>Property</code> 表示可变属性。这个 API 提供了两个好处：</p>\n<ol>\n<li>可以放心地连接不同的数据模型，而不用担心某个数据模型的值是否已经知道。举个例子，比如你想将扩展中的属性映射到 task 中的属性，但扩展的属性值只有在构建脚本配置后才能知道。</li>\n<li>避免在构建阶段进行资源密集型工作，比如当属性值时从文件中解析时</li>\n</ol>\n<p>使用也比较简单，首先我们先声明一个<code>Property&lt;String&gt;</code> 然后使用 <code>ObjectFactor</code> 去创建：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Property&lt;String&gt; testProperty;</span><br><span class=\"line\"></span><br><span class=\"line\">testProperty = project.getObjects().property(String.class);</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Gradle 会自动为 <code>Property</code> 生成 setter 方法，同时允许你使用 “&#x3D;” 操作符来设置属性值</p>\n</blockquote>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>在这篇文章中，我们主要讲的是，在自定义 Plugin 中经常用的到扩展功能，下一篇文章中，我们就开始进入 Plugin 的编写。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在上一篇文章 <a href=\"https://linxiaotao.github.io/2018/05/16/Gradle%E6%8F%92%E4%BB%B6-%E5%9F%BA%E7%A1%80%E7%AF%87/\">Gradle插件-基础篇</a> 中，我们学习了 Plugin 的设计规范，并且通过一个非常简单的例子对自定义 Plugin 有了初步认识，在这篇文章中，我们来继续学习 Gradle Plugin 更为深入的知识点。</p>\n<blockquote>\n<p>本文参考 <a href=\"https://guides.gradle.org/implementing-gradle-plugins/?_ga=2.31320828.258862271.1526633053-590693097.1523454314#writing-and-using-custom-task-types\">Gradle用户手册</a> </p>\n</blockquote>\n<h2 id=\"Gradle插件\"><a href=\"#Gradle插件\" class=\"headerlink\" title=\"Gradle插件\"></a>Gradle插件</h2><blockquote>\n<p>本文涉及的所有源码都位于 <a href=\"https://github.com/LinXiaoTao/GradleCaseProject\">github</a></p>\n</blockquote>\n<h3 id=\"简单扩展\"><a href=\"#简单扩展\" class=\"headerlink\" title=\"简单扩展\"></a>简单扩展</h3><p>当我们引入 Android Plugin 时，在 <code>android&#123;&#125;</code> 有一些常用的配置，比如：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">android &#123;</span><br><span class=\"line\">    compileSdkVersion <span class=\"number\">27</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果我们想在自定义的 Plugin 中也使用这样的配置，可以使用 Gradle 提供的扩展功能：<code>Extensions</code> ，在第一篇文章中我们自定义了一个简单的 <code>com.example.hello</code> 插件，我们现在就在这个基础上添加一个扩展功能，最终实现的配置如下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hello &#123;</span><br><span class=\"line\">    outFile <span class=\"string\">&#x27;hello&#x27;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>向 outFile 指定的文件中写入一句 “Hello World”，如文件不存在则创建它。</p>\n<p>为了创建扩展，我们先定义一个数据模型用于读取配置：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HelloModel</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> String outFile;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">getOutFile</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> outFile;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setOutFile</span><span class=\"params\">(String outFile)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.outFile = outFile;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>接着使用 <code>ExtensionContainer</code> 创建一个扩展：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.getExtensions().create(<span class=\"string\">&quot;hello&quot;</span>, HelloModel.class);</span><br></pre></td></tr></table></figure>\n\n<p><code>getExtensions(String,Class,Object...)</code> 这个方法有三个参数，第一个参数为扩展的名称即在 <em><strong>gradle</strong></em> 文件中使用的配置块，第二个参数为扩展的模型，用于定义可配置的属性，在上面的例子上，只有一个简单的 <code>outFile</code> 表示输出文件，第三个参数为可变长参数，表示模型的构造参数，在这个例子中，我们使用默认的无参构造函数。</p>\n<p>经过上面的步骤，我们已经创建好了扩展，接下来是读取扩展的属性值，还记得我们之前说的，<strong>Gradle 是边读取边解释</strong>，所以当我们 <code>apply plugin</code> 时，会创建好扩展，而扩展的属性值配置只能在 <code>apply plugin</code> 之后，所以我们在 plugin 中直接读取扩展属性值是不行的，必须在项目评估完成之后：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.afterEvaluate(project1 -&gt; &#123;</span><br><span class=\"line\">            <span class=\"type\">HelloModel</span> <span class=\"variable\">helloModel</span> <span class=\"operator\">=</span> project1.getExtensions().getByType(HelloModel.class);</span><br><span class=\"line\">            mLogger.quiet(<span class=\"string\">&quot;hello : &quot;</span> + helloModel);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (helloModel.getOutFile() == <span class=\"literal\">null</span> || helloModel.getOutFile().isEmpty()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">GradleException</span>(<span class=\"string\">&quot;outFile 不能等于空&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"type\">FileOutputStream</span> <span class=\"variable\">fileOutputStream</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"type\">File</span> <span class=\"variable\">outFile</span> <span class=\"operator\">=</span> project1.file(helloModel.getOutFile());</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!outFile.exists()) &#123;</span><br><span class=\"line\">                    outFile.createNewFile();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                fileOutputStream = <span class=\"keyword\">new</span> <span class=\"title class_\">FileOutputStream</span>(outFile);</span><br><span class=\"line\">                fileOutputStream.write(<span class=\"string\">&quot;Hello World&quot;</span>.getBytes());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (fileOutputStream != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        fileOutputStream.close();</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                        e.printStackTrace();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br></pre></td></tr></table></figure>\n\n<p>逻辑比较简单，我们现在直接运行在 <code>.gradlew</code> 即可，可以看到在 app 目录下生成一个 <em><strong>hello</strong></em> 文件：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Hello World</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"嵌套扩展\"><a href=\"#嵌套扩展\" class=\"headerlink\" title=\"嵌套扩展\"></a>嵌套扩展</h3><p>如果要想实现如下 DSL 配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">android &#123;</span><br><span class=\"line\">    defaultConfig &#123;</span><br><span class=\"line\">        applicationId <span class=\"string\">&quot;com.example.leo.gradlecaseproject&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Gradle 也支持这种嵌套扩展，同样是上面的例子，我们现在想添加一个 <code>info</code> 配置块，将这部分的信息也写入到文件中，最终配置如下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hello &#123;</span><br><span class=\"line\">    outFile = <span class=\"string\">&#x27;hello&#x27;</span></span><br><span class=\"line\">    info &#123;</span><br><span class=\"line\">        username = <span class=\"string\">&quot;leo&quot;</span></span><br><span class=\"line\">        email = <span class=\"string\">&quot;linxiaotao1993@vip.qq.com&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先我们先创建一个 InfoModel，这里有个要注意的地方：用于实现扩展的类不能是 <code>final</code>，因为最终用于扩展的实现类就是继承于这个类。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">InfoModel</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> String username;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> String email;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Inject</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"title function_\">InfoModel</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> String <span class=\"title function_\">getUsername</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> username;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setUsername</span><span class=\"params\">(String username)</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.username = username;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> String <span class=\"title function_\">getEmail</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> email;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setEmail</span><span class=\"params\">(String email)</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.email = email;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> String <span class=\"title function_\">toString</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;InfoModel&#123;&quot;</span> +</span><br><span class=\"line\">                    <span class=\"string\">&quot;username=&#x27;&quot;</span> + username + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                    <span class=\"string\">&quot;, email=&#x27;&quot;</span> + email + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                    <span class=\"string\">&#x27;&#125;&#x27;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>上面在构造方法中添加 <code>@Inject</code> 注解是为了能用 Gradle 提供的 <code>ObjectFactor</code> 用于实现依赖注入功能。而在原来的 <code>HelloModel</code> 中，我们增加了 <code>private final InfoModel info;</code> 同时在构建函数中增加了 <code>ObjectFactory</code> 参数：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">HelloModel</span><span class=\"params\">(ObjectFactory objectFactory)</span> &#123;</span><br><span class=\"line\">        info = objectFactory.newInstance(InfoModel.class);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>但这样还不够，还需要当 <code>info</code> 配置块被调用时所传递的实例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">info</span><span class=\"params\">(Action&lt;InfoModel&gt; action)</span> &#123;</span><br><span class=\"line\">        action.execute(info);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>注意：这里的方法名和 DSL 中的使用的配置块名称一致。</p>\n<p>最后我们在写入文件时，将这部分配置的信息也写入，同时在生成扩展时提供 <code>ObjectFactor</code> 实例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.getExtensions().create(<span class=\"string\">&quot;hello&quot;</span>, HelloModel.class, project.getObjects());</span><br><span class=\"line\"></span><br><span class=\"line\">fileOutputStream.write(String.format(</span><br><span class=\"line\">                        Locale.getDefault(),</span><br><span class=\"line\">                        <span class=\"string\">&quot;Hello World\\ncreate by %s %s&quot;</span>,</span><br><span class=\"line\">                        helloModel.getInfo().getUsername(),</span><br><span class=\"line\">                        helloModel.getInfo().getEmail()).getBytes()</span><br><span class=\"line\">                      );</span><br></pre></td></tr></table></figure>\n\n<p>最后执行下就可以看到结果了。</p>\n<blockquote>\n<p>可以看到 Gradle 可以很方便地使用依赖注入。</p>\n</blockquote>\n<h3 id=\"配置容器\"><a href=\"#配置容器\" class=\"headerlink\" title=\"配置容器\"></a>配置容器</h3><p>在 Android 项目中，我们可以去配置不同的构建变体：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flavorDimensions <span class=\"string\">&quot;api&quot;</span>, <span class=\"string\">&quot;mode&quot;</span></span><br><span class=\"line\">    productFlavors &#123;</span><br><span class=\"line\">        demo &#123;</span><br><span class=\"line\">            dimension <span class=\"string\">&quot;mode&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        full &#123;</span><br><span class=\"line\">            dimension <span class=\"string\">&quot;mode&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        minApi24 &#123;</span><br><span class=\"line\">            dimension <span class=\"string\">&quot;api&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        minApi23 &#123;</span><br><span class=\"line\">            dimension <span class=\"string\">&quot;api&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果我们想要实现类似 <code>productFlavors</code> 这种动态生成的 DSL 配置块，我们可以使用 <code>NamedDomainObjectContainer</code> 来实现，接着上面的例子，我们最终的配置如下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hello &#123;</span><br><span class=\"line\">    outFile = <span class=\"string\">&#x27;hello&#x27;</span></span><br><span class=\"line\">    info &#123;</span><br><span class=\"line\">        username = <span class=\"string\">&quot;leo&quot;</span></span><br><span class=\"line\">        email = <span class=\"string\">&quot;linxiaotao1993@vip.qq.com&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    other &#123;</span><br><span class=\"line\">        time &#123;</span><br><span class=\"line\">            value = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">&quot;yyyy-MM-dd&quot;</span>).format(<span class=\"keyword\">new</span> Date())</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>我们先创建 <code>ValueModel</code> 用于表示容器中每一项的格式，注意：这个类必须有个字段为 <code>name</code> ，比如上面的例子中，<code>name</code> 就是我们配置的 <code>time</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ValueModel</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">ValueModel</span><span class=\"params\">(String name)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">toString</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;ValueModel&#123;&quot;</span> +</span><br><span class=\"line\">                <span class=\"string\">&quot;name=&#x27;&quot;</span> + name + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                <span class=\"string\">&quot;, value=&#x27;&quot;</span> + value + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                <span class=\"string\">&#x27;&#125;&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">getName</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">getValue</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setValue</span><span class=\"params\">(String value)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.value = value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这个类不能写成内部类，静态内部类也不行</p>\n</blockquote>\n<p>接着，我们在 <code>HelloModel</code> 中同样创建 <code>other</code> 配置块，需要注意的是，这里我们要使用 <code>NamedDomainObjectContainer</code> ：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">other</span><span class=\"params\">(Action&lt;NamedDomainObjectContainer&lt;ValueModel&gt;&gt; action)</span> &#123;</span><br><span class=\"line\">        action.execute(other);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>而 <code>other</code> 则是这样子创建的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">other = project.container(ValueModel.class);</span><br></pre></td></tr></table></figure>\n\n<p>最后，同样的，我们将这块的配置也写入到 <code>hello</code> 文件中：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">StringBuilder</span> <span class=\"variable\">otherString</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">StringBuilder</span>();</span><br><span class=\"line\">                helloModel.getOther().forEach(valueModel -&gt;</span><br><span class=\"line\">                        otherString.append(valueModel.getName())</span><br><span class=\"line\">                                .append(<span class=\"string\">&quot;：&quot;</span>)</span><br><span class=\"line\">                                .append(valueModel.getValue())</span><br><span class=\"line\">                                .append(<span class=\"string\">&quot;\\n&quot;</span>));</span><br><span class=\"line\">                fileOutputStream.write(String.format(</span><br><span class=\"line\">                        Locale.getDefault(),</span><br><span class=\"line\">                        <span class=\"string\">&quot;Hello World\\ncreate by %s %s\\n%s&quot;</span>,</span><br><span class=\"line\">                        helloModel.getInfo().getUsername(),</span><br><span class=\"line\">                        helloModel.getInfo().getEmail(),</span><br><span class=\"line\">                        otherString.toString()).getBytes()</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"懒加载属性\"><a href=\"#懒加载属性\" class=\"headerlink\" title=\"懒加载属性\"></a>懒加载属性</h3><p>在上面的例子中，我们都是通过使用原始数据类型去映射在构建脚本中的配置，这种方式会在配置完成之后直接映射，Gradle 4.0 提供了 <code>Provider</code> 和 <code>Property</code> 来提供懒加载属性，其中 <code>Provider</code> 表示不可变属性，<code>Property</code> 表示可变属性。这个 API 提供了两个好处：</p>\n<ol>\n<li>可以放心地连接不同的数据模型，而不用担心某个数据模型的值是否已经知道。举个例子，比如你想将扩展中的属性映射到 task 中的属性，但扩展的属性值只有在构建脚本配置后才能知道。</li>\n<li>避免在构建阶段进行资源密集型工作，比如当属性值时从文件中解析时</li>\n</ol>\n<p>使用也比较简单，首先我们先声明一个<code>Property&lt;String&gt;</code> 然后使用 <code>ObjectFactor</code> 去创建：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Property&lt;String&gt; testProperty;</span><br><span class=\"line\"></span><br><span class=\"line\">testProperty = project.getObjects().property(String.class);</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Gradle 会自动为 <code>Property</code> 生成 setter 方法，同时允许你使用 “&#x3D;” 操作符来设置属性值</p>\n</blockquote>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>在这篇文章中，我们主要讲的是，在自定义 Plugin 中经常用的到扩展功能，下一篇文章中，我们就开始进入 Plugin 的编写。</p>\n"},{"title":"JavaScript正则表达式","date":"2018-09-08T15:20:22.000Z","_content":"\n* 快速字符\n\n  | 字符 | 说明                                                |\n  | ---- | --------------------------------------------------- |\n  | \\d   | 所有数字，相当于 [0-9]                              |\n  | \\D   | 非数字，相当于 ``[^0-9]``                           |\n  | \\s   | 空白字符，包括空格、制表符、换页符、换行符          |\n  | \\S   | 非空白字符                                          |\n  | \\w   | 单字符（字母、数字或者下划线），相当于 [A-Za-z0-9_] |\n  | \\W   | 非单字符                                            |\n\n* 使用 {} 表示出现的次数\n\n  ``` javascript\n  /s{2,6}/   // s 字符出现 2 到 6 次，要注意这些情况：ssssssss，这里会当作 ssssss ss，而匹配成功\n  ```\n\n  ``` javascript\n  /s{2,}/    // s 字符至少出现 2 次以上\n  ```\n\n  ``` javascript\n  /s {2}/\t   // s 字符精确出现 2 次\n  ```\n\n* 使用 ? 表示出现 0 次或者 1 次，等价于 {0,1}\n\n  ``` javascript\n  /apples?/\t// 匹配 aaple 和 apples\n  ```\n\n  注意：如果紧跟在任何量词 *、+、? 或 {} 的后面，将会湿的量词变为非贪婪（匹配尽量少的字符），缺省使用的是贪婪模式\n\n  ``` javascript\n  /\\d+/;\t// 对于 123abc 将会返回 123\n  /\\d+?/;\t// 对于 123abc 将会返回 1\n  ```\n\n* 使用 ^ 表示开头匹配，使用 $ 表示末尾匹配\n\n  ``` javascript\n  /^a/\t// 匹配 apple 不匹配 banana\n  /e$/\t// 匹配 apple 不匹配 element\n  ```\n\n  注意和 反向字符集 的区别\n\n  ``` javascript\n  /[^abc]/\t// 匹配不包括 abc 的字符\n  ```\n\n* 使用 /i 表示忽略大小写\n\n  ``` javascript\n  /abc/i\n  ```\n\n* 使用 /g 表示全局搜索\n\n  ``` javascript\n  /abc/g\n  ```\n\n* 使用 x(?=y) 正向肯定查找，匹配'x'仅仅当'x'后面跟着'y'.\n\n  ``` javascript\n  /Jack(?=Sprat)/\t// 会匹配到 Jack 仅当它后面跟着 Sprat，但 Sprat 不作为匹配项返回\n  ```\n\n* 使用 x(?!y) 反向否定查找，匹配'x'仅仅当'x'后面不跟着'y'\n\n  ``` javascript\n  /Jack(?!Sprat)/\t//\t会匹配到 Jack 仅当它后面不跟着 Sprat\n  ```\n\n* 使用 (x) 匹配 'x' 并且记住匹配项，括号被称为 *捕获括号*\n\n  ``` javascript\n  /(foo) (bar) \\1 \\2/;\t// 匹配 foo bar foo bar，注意空格\n  ```\n\n  如果使用 replace 功能，则需要使用 $1 等\n\n* 使用 (?:x) 匹配 'x' 但是不记住匹配项。这种叫作非捕获括号，使得你能够定义为与正则表达式运算符一起使用的子表达式\n\n  ``` javascript\n  /foo{2}/;\t\t// 将匹配 fooo，将 {2} 作用到 o\n  /(?:foo){2}/;\t// 将匹配 foofoo，将 {2} 作用到 foo\n  ```","source":"_posts/JavaScript正则表达式.md","raw":"---\ntitle: JavaScript正则表达式\ndate: 2018-09-08 23:20:22\ncategories: JavaScript\ntags: \n---\n\n* 快速字符\n\n  | 字符 | 说明                                                |\n  | ---- | --------------------------------------------------- |\n  | \\d   | 所有数字，相当于 [0-9]                              |\n  | \\D   | 非数字，相当于 ``[^0-9]``                           |\n  | \\s   | 空白字符，包括空格、制表符、换页符、换行符          |\n  | \\S   | 非空白字符                                          |\n  | \\w   | 单字符（字母、数字或者下划线），相当于 [A-Za-z0-9_] |\n  | \\W   | 非单字符                                            |\n\n* 使用 {} 表示出现的次数\n\n  ``` javascript\n  /s{2,6}/   // s 字符出现 2 到 6 次，要注意这些情况：ssssssss，这里会当作 ssssss ss，而匹配成功\n  ```\n\n  ``` javascript\n  /s{2,}/    // s 字符至少出现 2 次以上\n  ```\n\n  ``` javascript\n  /s {2}/\t   // s 字符精确出现 2 次\n  ```\n\n* 使用 ? 表示出现 0 次或者 1 次，等价于 {0,1}\n\n  ``` javascript\n  /apples?/\t// 匹配 aaple 和 apples\n  ```\n\n  注意：如果紧跟在任何量词 *、+、? 或 {} 的后面，将会湿的量词变为非贪婪（匹配尽量少的字符），缺省使用的是贪婪模式\n\n  ``` javascript\n  /\\d+/;\t// 对于 123abc 将会返回 123\n  /\\d+?/;\t// 对于 123abc 将会返回 1\n  ```\n\n* 使用 ^ 表示开头匹配，使用 $ 表示末尾匹配\n\n  ``` javascript\n  /^a/\t// 匹配 apple 不匹配 banana\n  /e$/\t// 匹配 apple 不匹配 element\n  ```\n\n  注意和 反向字符集 的区别\n\n  ``` javascript\n  /[^abc]/\t// 匹配不包括 abc 的字符\n  ```\n\n* 使用 /i 表示忽略大小写\n\n  ``` javascript\n  /abc/i\n  ```\n\n* 使用 /g 表示全局搜索\n\n  ``` javascript\n  /abc/g\n  ```\n\n* 使用 x(?=y) 正向肯定查找，匹配'x'仅仅当'x'后面跟着'y'.\n\n  ``` javascript\n  /Jack(?=Sprat)/\t// 会匹配到 Jack 仅当它后面跟着 Sprat，但 Sprat 不作为匹配项返回\n  ```\n\n* 使用 x(?!y) 反向否定查找，匹配'x'仅仅当'x'后面不跟着'y'\n\n  ``` javascript\n  /Jack(?!Sprat)/\t//\t会匹配到 Jack 仅当它后面不跟着 Sprat\n  ```\n\n* 使用 (x) 匹配 'x' 并且记住匹配项，括号被称为 *捕获括号*\n\n  ``` javascript\n  /(foo) (bar) \\1 \\2/;\t// 匹配 foo bar foo bar，注意空格\n  ```\n\n  如果使用 replace 功能，则需要使用 $1 等\n\n* 使用 (?:x) 匹配 'x' 但是不记住匹配项。这种叫作非捕获括号，使得你能够定义为与正则表达式运算符一起使用的子表达式\n\n  ``` javascript\n  /foo{2}/;\t\t// 将匹配 fooo，将 {2} 作用到 o\n  /(?:foo){2}/;\t// 将匹配 foofoo，将 {2} 作用到 foo\n  ```","slug":"JavaScript正则表达式","published":1,"updated":"2022-06-15T11:19:32.319Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlb0008fho686eqehs1","content":"<ul>\n<li><p>快速字符</p>\n<table>\n<thead>\n<tr>\n<th>字符</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>\\d</td>\n<td>所有数字，相当于 [0-9]</td>\n</tr>\n<tr>\n<td>\\D</td>\n<td>非数字，相当于 <code>[^0-9]</code></td>\n</tr>\n<tr>\n<td>\\s</td>\n<td>空白字符，包括空格、制表符、换页符、换行符</td>\n</tr>\n<tr>\n<td>\\S</td>\n<td>非空白字符</td>\n</tr>\n<tr>\n<td>\\w</td>\n<td>单字符（字母、数字或者下划线），相当于 [A-Za-z0-9_]</td>\n</tr>\n<tr>\n<td>\\W</td>\n<td>非单字符</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>使用 {} 表示出现的次数</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/s&#123;<span class=\"number\">2</span>,<span class=\"number\">6</span>&#125;/   <span class=\"comment\">// s 字符出现 2 到 6 次，要注意这些情况：ssssssss，这里会当作 ssssss ss，而匹配成功</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/s&#123;<span class=\"number\">2</span>,&#125;/    <span class=\"comment\">// s 字符至少出现 2 次以上</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/s &#123;<span class=\"number\">2</span>&#125;/\t   <span class=\"comment\">// s 字符精确出现 2 次</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 ? 表示出现 0 次或者 1 次，等价于 {0,1}</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/apples?<span class=\"regexp\">/\t/</span><span class=\"regexp\">/ 匹配 aaple 和 apples</span></span><br></pre></td></tr></table></figure>\n\n<p>注意：如果紧跟在任何量词 *、+、? 或 {} 的后面，将会湿的量词变为非贪婪（匹配尽量少的字符），缺省使用的是贪婪模式</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/\\d+<span class=\"regexp\">/;\t/</span><span class=\"regexp\">/ 对于 123abc 将会返回 123</span></span><br><span class=\"line\"><span class=\"regexp\">/</span>\\d+?<span class=\"regexp\">/;\t/</span><span class=\"regexp\">/ 对于 123abc 将会返回 1</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 ^ 表示开头匹配，使用 $ 表示末尾匹配</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/^a/\t<span class=\"comment\">// 匹配 apple 不匹配 banana</span></span><br><span class=\"line\"><span class=\"regexp\">/e$/</span>\t<span class=\"comment\">// 匹配 apple 不匹配 element</span></span><br></pre></td></tr></table></figure>\n\n<p>注意和 反向字符集 的区别</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/[^abc]/\t<span class=\"comment\">// 匹配不包括 abc 的字符</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 &#x2F;i 表示忽略大小写</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/abc/i</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 &#x2F;g 表示全局搜索</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/abc/g</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 x(?&#x3D;y) 正向肯定查找，匹配’x’仅仅当’x’后面跟着’y’.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/<span class=\"title class_\">Jack</span>(?=<span class=\"title class_\">Sprat</span>)/\t<span class=\"comment\">// 会匹配到 Jack 仅当它后面跟着 Sprat，但 Sprat 不作为匹配项返回</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 x(?!y) 反向否定查找，匹配’x’仅仅当’x’后面不跟着’y’</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/<span class=\"title class_\">Jack</span>(?!<span class=\"title class_\">Sprat</span>)/\t<span class=\"comment\">//\t会匹配到 Jack 仅当它后面不跟着 Sprat</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 (x) 匹配 ‘x’ 并且记住匹配项，括号被称为 <em>捕获括号</em></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/(foo) (bar) \\<span class=\"number\">1</span> \\<span class=\"number\">2</span>/;\t<span class=\"comment\">// 匹配 foo bar foo bar，注意空格</span></span><br></pre></td></tr></table></figure>\n\n<p>如果使用 replace 功能，则需要使用 $1 等</p>\n</li>\n<li><p>使用 (?:x) 匹配 ‘x’ 但是不记住匹配项。这种叫作非捕获括号，使得你能够定义为与正则表达式运算符一起使用的子表达式</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/foo&#123;<span class=\"number\">2</span>&#125;/;\t\t<span class=\"comment\">// 将匹配 fooo，将 &#123;2&#125; 作用到 o</span></span><br><span class=\"line\"><span class=\"regexp\">/(?:foo)&#123;2&#125;/</span>;\t<span class=\"comment\">// 将匹配 foofoo，将 &#123;2&#125; 作用到 foo</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<ul>\n<li><p>快速字符</p>\n<table>\n<thead>\n<tr>\n<th>字符</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>\\d</td>\n<td>所有数字，相当于 [0-9]</td>\n</tr>\n<tr>\n<td>\\D</td>\n<td>非数字，相当于 <code>[^0-9]</code></td>\n</tr>\n<tr>\n<td>\\s</td>\n<td>空白字符，包括空格、制表符、换页符、换行符</td>\n</tr>\n<tr>\n<td>\\S</td>\n<td>非空白字符</td>\n</tr>\n<tr>\n<td>\\w</td>\n<td>单字符（字母、数字或者下划线），相当于 [A-Za-z0-9_]</td>\n</tr>\n<tr>\n<td>\\W</td>\n<td>非单字符</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>使用 {} 表示出现的次数</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/s&#123;<span class=\"number\">2</span>,<span class=\"number\">6</span>&#125;/   <span class=\"comment\">// s 字符出现 2 到 6 次，要注意这些情况：ssssssss，这里会当作 ssssss ss，而匹配成功</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/s&#123;<span class=\"number\">2</span>,&#125;/    <span class=\"comment\">// s 字符至少出现 2 次以上</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/s &#123;<span class=\"number\">2</span>&#125;/\t   <span class=\"comment\">// s 字符精确出现 2 次</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 ? 表示出现 0 次或者 1 次，等价于 {0,1}</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/apples?<span class=\"regexp\">/\t/</span><span class=\"regexp\">/ 匹配 aaple 和 apples</span></span><br></pre></td></tr></table></figure>\n\n<p>注意：如果紧跟在任何量词 *、+、? 或 {} 的后面，将会湿的量词变为非贪婪（匹配尽量少的字符），缺省使用的是贪婪模式</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/\\d+<span class=\"regexp\">/;\t/</span><span class=\"regexp\">/ 对于 123abc 将会返回 123</span></span><br><span class=\"line\"><span class=\"regexp\">/</span>\\d+?<span class=\"regexp\">/;\t/</span><span class=\"regexp\">/ 对于 123abc 将会返回 1</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 ^ 表示开头匹配，使用 $ 表示末尾匹配</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/^a/\t<span class=\"comment\">// 匹配 apple 不匹配 banana</span></span><br><span class=\"line\"><span class=\"regexp\">/e$/</span>\t<span class=\"comment\">// 匹配 apple 不匹配 element</span></span><br></pre></td></tr></table></figure>\n\n<p>注意和 反向字符集 的区别</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/[^abc]/\t<span class=\"comment\">// 匹配不包括 abc 的字符</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 &#x2F;i 表示忽略大小写</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/abc/i</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 &#x2F;g 表示全局搜索</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/abc/g</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 x(?&#x3D;y) 正向肯定查找，匹配’x’仅仅当’x’后面跟着’y’.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/<span class=\"title class_\">Jack</span>(?=<span class=\"title class_\">Sprat</span>)/\t<span class=\"comment\">// 会匹配到 Jack 仅当它后面跟着 Sprat，但 Sprat 不作为匹配项返回</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 x(?!y) 反向否定查找，匹配’x’仅仅当’x’后面不跟着’y’</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/<span class=\"title class_\">Jack</span>(?!<span class=\"title class_\">Sprat</span>)/\t<span class=\"comment\">//\t会匹配到 Jack 仅当它后面不跟着 Sprat</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用 (x) 匹配 ‘x’ 并且记住匹配项，括号被称为 <em>捕获括号</em></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/(foo) (bar) \\<span class=\"number\">1</span> \\<span class=\"number\">2</span>/;\t<span class=\"comment\">// 匹配 foo bar foo bar，注意空格</span></span><br></pre></td></tr></table></figure>\n\n<p>如果使用 replace 功能，则需要使用 $1 等</p>\n</li>\n<li><p>使用 (?:x) 匹配 ‘x’ 但是不记住匹配项。这种叫作非捕获括号，使得你能够定义为与正则表达式运算符一起使用的子表达式</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/foo&#123;<span class=\"number\">2</span>&#125;/;\t\t<span class=\"comment\">// 将匹配 fooo，将 &#123;2&#125; 作用到 o</span></span><br><span class=\"line\"><span class=\"regexp\">/(?:foo)&#123;2&#125;/</span>;\t<span class=\"comment\">// 将匹配 foofoo，将 &#123;2&#125; 作用到 foo</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n"},{"title":"Jetpack中的ViewModel","date":"2019-01-05T03:36:18.000Z","_content":"\n### 前言\n\n首先祝大家在新的一年中，身体健康，心想事成。\n\n算了下，去年技术类博客写了 15 篇，看下数量还算比较满意，可是基本都是前半年写的，那时候刚刚下定决心要好好写博客，后半年因为工作上还有自己偷懒心理，基本都没怎么写了，真是惭愧。\n\n不过经过去年写了这些文章，慢慢也学习到了一些写技术文章上的技巧，希望今年能方得始终，提升文章的质量。\n\n### 关于 Jetpack\n\n相信已经有不少人对 Google 推出的 Jetpack 系列组件都有所耳闻，现在网上已经有不少的分析文章了，涵盖了用法和源码解析，所以我就不重复造轮子，在这个系列文章中，不会涉及使用教程等，只写一些个人的使用体会，也当作给自己做笔记。\n\n### 关于本文\n\n这篇文章主要讲 Jetpack 中的 ViewModel\n\n### ViewModel\n\n> The [`ViewModel`](https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html) class is designed to store and manage UI-related data in a lifecycle conscious way. \n\n简而言之，就是在生命周期中管理数据。说到生命周期，我们都知道 Android 中 `Activity` 和 `Fragment` 都有各自对应的生命周期，比如 `Activity`，它的生命周期如下图：\n\n![activity_lifecycle](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/activity_lifecycle.png?x-oss-process=style/doc-img)\n\n通常我们会在 `onCreate()` 初始化数据，在 `onResume()` 中展示数据，`onDestroy()` 中释放数据，类似下面这些伪代码：\n\n``` java\nonCreate() {\n    initData();\n}\n\nonResume() {\n    displayData()\n}\n\nonDestory() {\n    recycleData();\n}\n```\n\n如果没有在 `onDestory()` 中及时释放某些资源，可能还会导致内存泄漏，这是第一个问题。\n\n第二个问题，Android 系统可能会在内存不足的情况下，回收了 `Activity`，导致 `Activity` 重建时数据会丢失，对于这种情况，Android 提供了 `onSaveInstanceState` 中保存数据，在 `onRestoreInstanceState` 和 `onCreate` 中获取。类似下面这些伪代码：\n\n``` java\nonSaveInstanceState(Bundle outState) {\n \toutState.putData();   \n}\n\nonRestoreInstanceState(Bundle outState) {\n    outState.getData();\n}\n\nonCreate(Bundle savedInstanceState) {\n    if (savedInstanceState != null) {\n        savedInstanceState.getData();\n    }\n}\n```\n\n这种方式除了重复的胶水代码以外，还存在 `Bundle` 存储只适用于支持序列化（Serializable 和 Parcelable）的少量数据，当然除了使用 Android SDK 提供的这种方案以外，我们也可以自己实现类似的方案，类似以下伪代码：\n\n``` java\n// Data Repository\nMap<String,Data> map;\n\ngetData(String id) {\n    if (map.get(id) == null){\n        Data data = createData();\n        map.put(id,data);\n    }\n    return map.get(id);\n}\n\nremoveData(String id) {\n    map.removeByKey(id);\n}\n\n// Activity\nonCreate() {\n    getData(this);\n}\n\nonDestory() {\n    if (!isChangingConfigurations){\n            removeData(this);\n    }\n}\n```\n\n看了上面解决思路后，我们再来看看 Google 提供的 `ViewModel`，它是如何解决上面提到的两个问题的。首先看下，`ViewModel` 的典型用法，来源于官方文档：\n\n首先定义一个 `MyViewModel` 继承于 `ViewModel`，这里使用 `LiveData` 作为数据源，这里我们只需要知道 `LiveData` 和 `RxJava` 是差不多的东西就可以了\n\n``` java\npublic class MyViewModel extends ViewModel {\n    private MutableLiveData<List<User>> users;\n    public LiveData<List<User>> getUsers() {\n        if (users == null) {\n            users = new MutableLiveData<List<User>>();\n            loadUsers();\n        }\n        return users;\n    }\n\n    private void loadUsers() {\n        // Do an asynchronous operation to fetch users.\n    }\n}\n```\n\n定义好 `ViewModel` 之后，我们在 `Activity` 中使用它：\n\n``` java\npublic class MyActivity extends AppCompatActivity {\n    public void onCreate(Bundle savedInstanceState) {\n        // Create a ViewModel the first time the system calls an activity's onCreate() method.\n        // Re-created activities receive the same MyViewModel instance created by the first activity.\n\n        MyViewModel model = ViewModelProviders.of(this).get(MyViewModel.class);\n        model.getUsers().observe(this, users -> {\n            // update UI\n        });\n    }\n}\n```\n\n我们先看下 `ViewModelProviders.of` 的函数签名：\n\n``` java\npublic static ViewModelProvider of(@NonNull Fragment fragment);\npublic static ViewModelProvider of(@NonNull FragmentActivity activity);\npublic static ViewModelProvider of(@NonNull Fragment fragment, @Nullable Factory factory);\npublic static ViewModelProvider of(@NonNull FragmentActivity activity,\n            @Nullable Factory factory);\n```\n\n需要将当前 `Activity` 或 `Fragment` 作为参数，这也是 `ViewModel` 将数据与生命周期结合起来的地方。那具体也是如何实现的呢？\n\n``` java\n@NonNull                                                                             \n@MainThread                                                                          \npublic static ViewModelProvider of(@NonNull FragmentActivity activity,               \n        @Nullable Factory factory) {                                                 \n    Application application = checkApplication(activity);                            \n    if (factory == null) {                                                           \n        factory = ViewModelProvider.AndroidViewModelFactory.getInstance(application);\n    }                                                                                \n    return new ViewModelProvider(activity.getViewModelStore(), factory);             \n}                                                                                    \n```\n\n`factory` 顾名思义就是 `ViewModel` 的工厂类，这里默认使用 `AndroidViewModelFactory` 最后返回 `ViewModelProvider` 实例\n\n``` java\n// ViewModelProvider\n@NonNull                                                                                 \n@MainThread                                                                              \npublic <T extends ViewModel> T get(@NonNull String key, @NonNull Class<T> modelClass) {  \n    ViewModel viewModel = mViewModelStore.get(key);                                      \n                                                                                         \n    if (modelClass.isInstance(viewModel)) {                                              \n        //noinspection unchecked                                                         \n        return (T) viewModel;                                                            \n    } else {                                                                             \n        //noinspection StatementWithEmptyBody                                            \n        if (viewModel != null) {                                                         \n            // TODO: log a warning.                                                      \n        }                                                                                \n    }                                                                                    \n                                                                                         \n    viewModel = mFactory.create(modelClass);                                             \n    mViewModelStore.put(key, viewModel);                                                 \n    //noinspection unchecked                                                             \n    return (T) viewModel;                                                                \n}\n\n// AndroidViewModelFactory\n@NonNull                                                                                   \n@Override                                                                                  \npublic <T extends ViewModel> T create(@NonNull Class<T> modelClass) {                      \n    if (AndroidViewModel.class.isAssignableFrom(modelClass)) {                             \n        //noinspection TryWithIdenticalCatches                                             \n        try {                                                                              \n            return modelClass.getConstructor(Application.class).newInstance(mApplication); \n        } catch (NoSuchMethodException e) {                                                \n            throw new RuntimeException(\"Cannot create an instance of \" + modelClass, e);   \n        } catch (IllegalAccessException e) {                                               \n            throw new RuntimeException(\"Cannot create an instance of \" + modelClass, e);   \n        } catch (InstantiationException e) {                                               \n            throw new RuntimeException(\"Cannot create an instance of \" + modelClass, e);   \n        } catch (InvocationTargetException e) {                                            \n            throw new RuntimeException(\"Cannot create an instance of \" + modelClass, e);   \n        }                                                                                  \n    }                                                                                      \n    return super.create(modelClass);                                                       \n}                                                                                          \n```\n\n我们将以上两段代码合起来看，其实逻辑是比较清晰的：\n\n![ViewModelProvider#create](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/viewmodel/ViewModelProvider%23create.png?x-oss-process=style/doc-img)\n\n`Factor` 的实现可以通过反射来实现，比如默认的 `AndroidViewModelFactory` 会优先调用使用 `Application` 作为参数的构造方法，来创建实例。所以，如果自定义的 `ViewModel` 构造方法有其他参数，就需要自定义 `Factor`\n\n而 `ViewModelStore` 则是 `Activity` 重建时还能拥有之前数据的保障。\n\n``` java\nprivate final HashMap<String, ViewModel> mMap = new HashMap<>();                  \n                                                                                  \nfinal void put(String key, ViewModel viewModel) {                                 \n    ViewModel oldViewModel = mMap.put(key, viewModel);                            \n    if (oldViewModel != null) {                                                   \n        oldViewModel.onCleared();                                                 \n    }                                                                             \n}                                                                                 \n                                                                                  \nfinal ViewModel get(String key) {                                                 \n    return mMap.get(key);                                                         \n}                                                                                 \n                                                                                  \n/**                                                                               \n *  Clears internal storage and notifies ViewModels that they are no longer used. \n */                                                                               \npublic final void clear() {                                                       \n    for (ViewModel vm : mMap.values()) {                                          \n        vm.onCleared();                                                           \n    }                                                                             \n    mMap.clear();                                                                 \n}                                                                                 \n```\n\n`ViewModelStore` 的源码很短，可以看到其实就是使用 `HashMap` 作为数据载体。既然有使用，那就需要清理操作，可以看到有个 `clear` 它会清除 `HashMap` 中的缓存数据。我们首先看下 `ViewModelProvider` 中的 `mViewModelStore` 是在哪里赋值的：\n\n``` java\npublic ViewModelProvider(@NonNull ViewModelStoreOwner owner, @NonNull Factory factory) { \n    this(owner.getViewModelStore(), factory);                                            \n}                                                                                        \n                                                                                                                                                                             \npublic ViewModelProvider(@NonNull ViewModelStore store, @NonNull Factory factory) {      \n    mFactory = factory;                                                                  \n    this.mViewModelStore = store;                                                        \n}                                                                                        \n```\n\n通过 `ViewModelStoreOwner.getViewModelStore` 获取 `ViewModelStore` 实例对象，而 `ViewModelStoreOwner` 实际就是我们调用 `ViewModelProviders.of` 中传递的 `FragmentActivity` 和 `Fragment`\n\n> `FragmentActivity` 中会通过 `onRetainNonConfigurationInstance` 和 `getLastNonConfigurationInstance` 去保持 `Activity` 因为屏幕旋转等配置发生改变而导致重建时，数据的唯一性\n\n而 `Fragment` 和 `FragmentActivity` 会在 `onDestory` 时判断是否需要调用 `ViewModelStore.clear`\n\n``` java\n@Override                                                            \nprotected void onDestroy() {                                         \n    super.onDestroy();                                               \n                                                                     \n    if (mViewModelStore != null && !isChangingConfigurations()) {    \n        mViewModelStore.clear();                                     \n    }                                                                \n                                                                     \n    mFragments.dispatchDestroy();                                    \n}                                                                    \n```\n\n讲完 `ViewModelStore` 的缓存功能之后，我们再来看下，`ViewModelProvider.of` 不同签名的方法：\n\n``` java\n@NonNull                                                         \n@MainThread                                                      \npublic static ViewModelProvider of(@NonNull Fragment fragment) { \n    return of(fragment, null);                                   \n}\n\n@NonNull                                                                    \n@MainThread                                                                 \npublic static ViewModelProvider of(@NonNull FragmentActivity activity) {    \n    return of(activity, null);                                              \n}                                                                           \n```\n\n这里需要注意的是，`ViewModel` 在不同作用域下的实例，首先，`FragmentActivity` 和 `Fragment` 都实现了 `ViewModelStoreOwner` 即它们都有各自的 `ViewModelStore` 简单来说，如果想在 `Fragment` 中获取依附的 `Activity` 的 `ViewModel` 实例，那需要使用 `of(FragmentActivity)` 的方法，这也是一种 `Activity` 和 `Fragment` 之间通信的好方式。\n\n### 总结\n\n现在我们来比较下自定义实现的方案和 `ViewModel` ，可以发现其实核心思想是共通，首先我们需要一个保存于 `Activity` 和 `Fragment` 生命周期之外的存储空间，在 `ViewModel` 中是 `ViewModelStore`，其次我们需要在 `Activity` 和 `Fragment` 对应的生命周期中，去初始化和清理这个 `ViewModelStore`","source":"_posts/Jetpack中的ViewModel.md","raw":"---\ntitle: Jetpack中的ViewModel\ndate: 2019-01-05 11:36:18\ncategories: Android\ntags: Jetpack\n---\n\n### 前言\n\n首先祝大家在新的一年中，身体健康，心想事成。\n\n算了下，去年技术类博客写了 15 篇，看下数量还算比较满意，可是基本都是前半年写的，那时候刚刚下定决心要好好写博客，后半年因为工作上还有自己偷懒心理，基本都没怎么写了，真是惭愧。\n\n不过经过去年写了这些文章，慢慢也学习到了一些写技术文章上的技巧，希望今年能方得始终，提升文章的质量。\n\n### 关于 Jetpack\n\n相信已经有不少人对 Google 推出的 Jetpack 系列组件都有所耳闻，现在网上已经有不少的分析文章了，涵盖了用法和源码解析，所以我就不重复造轮子，在这个系列文章中，不会涉及使用教程等，只写一些个人的使用体会，也当作给自己做笔记。\n\n### 关于本文\n\n这篇文章主要讲 Jetpack 中的 ViewModel\n\n### ViewModel\n\n> The [`ViewModel`](https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html) class is designed to store and manage UI-related data in a lifecycle conscious way. \n\n简而言之，就是在生命周期中管理数据。说到生命周期，我们都知道 Android 中 `Activity` 和 `Fragment` 都有各自对应的生命周期，比如 `Activity`，它的生命周期如下图：\n\n![activity_lifecycle](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/activity_lifecycle.png?x-oss-process=style/doc-img)\n\n通常我们会在 `onCreate()` 初始化数据，在 `onResume()` 中展示数据，`onDestroy()` 中释放数据，类似下面这些伪代码：\n\n``` java\nonCreate() {\n    initData();\n}\n\nonResume() {\n    displayData()\n}\n\nonDestory() {\n    recycleData();\n}\n```\n\n如果没有在 `onDestory()` 中及时释放某些资源，可能还会导致内存泄漏，这是第一个问题。\n\n第二个问题，Android 系统可能会在内存不足的情况下，回收了 `Activity`，导致 `Activity` 重建时数据会丢失，对于这种情况，Android 提供了 `onSaveInstanceState` 中保存数据，在 `onRestoreInstanceState` 和 `onCreate` 中获取。类似下面这些伪代码：\n\n``` java\nonSaveInstanceState(Bundle outState) {\n \toutState.putData();   \n}\n\nonRestoreInstanceState(Bundle outState) {\n    outState.getData();\n}\n\nonCreate(Bundle savedInstanceState) {\n    if (savedInstanceState != null) {\n        savedInstanceState.getData();\n    }\n}\n```\n\n这种方式除了重复的胶水代码以外，还存在 `Bundle` 存储只适用于支持序列化（Serializable 和 Parcelable）的少量数据，当然除了使用 Android SDK 提供的这种方案以外，我们也可以自己实现类似的方案，类似以下伪代码：\n\n``` java\n// Data Repository\nMap<String,Data> map;\n\ngetData(String id) {\n    if (map.get(id) == null){\n        Data data = createData();\n        map.put(id,data);\n    }\n    return map.get(id);\n}\n\nremoveData(String id) {\n    map.removeByKey(id);\n}\n\n// Activity\nonCreate() {\n    getData(this);\n}\n\nonDestory() {\n    if (!isChangingConfigurations){\n            removeData(this);\n    }\n}\n```\n\n看了上面解决思路后，我们再来看看 Google 提供的 `ViewModel`，它是如何解决上面提到的两个问题的。首先看下，`ViewModel` 的典型用法，来源于官方文档：\n\n首先定义一个 `MyViewModel` 继承于 `ViewModel`，这里使用 `LiveData` 作为数据源，这里我们只需要知道 `LiveData` 和 `RxJava` 是差不多的东西就可以了\n\n``` java\npublic class MyViewModel extends ViewModel {\n    private MutableLiveData<List<User>> users;\n    public LiveData<List<User>> getUsers() {\n        if (users == null) {\n            users = new MutableLiveData<List<User>>();\n            loadUsers();\n        }\n        return users;\n    }\n\n    private void loadUsers() {\n        // Do an asynchronous operation to fetch users.\n    }\n}\n```\n\n定义好 `ViewModel` 之后，我们在 `Activity` 中使用它：\n\n``` java\npublic class MyActivity extends AppCompatActivity {\n    public void onCreate(Bundle savedInstanceState) {\n        // Create a ViewModel the first time the system calls an activity's onCreate() method.\n        // Re-created activities receive the same MyViewModel instance created by the first activity.\n\n        MyViewModel model = ViewModelProviders.of(this).get(MyViewModel.class);\n        model.getUsers().observe(this, users -> {\n            // update UI\n        });\n    }\n}\n```\n\n我们先看下 `ViewModelProviders.of` 的函数签名：\n\n``` java\npublic static ViewModelProvider of(@NonNull Fragment fragment);\npublic static ViewModelProvider of(@NonNull FragmentActivity activity);\npublic static ViewModelProvider of(@NonNull Fragment fragment, @Nullable Factory factory);\npublic static ViewModelProvider of(@NonNull FragmentActivity activity,\n            @Nullable Factory factory);\n```\n\n需要将当前 `Activity` 或 `Fragment` 作为参数，这也是 `ViewModel` 将数据与生命周期结合起来的地方。那具体也是如何实现的呢？\n\n``` java\n@NonNull                                                                             \n@MainThread                                                                          \npublic static ViewModelProvider of(@NonNull FragmentActivity activity,               \n        @Nullable Factory factory) {                                                 \n    Application application = checkApplication(activity);                            \n    if (factory == null) {                                                           \n        factory = ViewModelProvider.AndroidViewModelFactory.getInstance(application);\n    }                                                                                \n    return new ViewModelProvider(activity.getViewModelStore(), factory);             \n}                                                                                    \n```\n\n`factory` 顾名思义就是 `ViewModel` 的工厂类，这里默认使用 `AndroidViewModelFactory` 最后返回 `ViewModelProvider` 实例\n\n``` java\n// ViewModelProvider\n@NonNull                                                                                 \n@MainThread                                                                              \npublic <T extends ViewModel> T get(@NonNull String key, @NonNull Class<T> modelClass) {  \n    ViewModel viewModel = mViewModelStore.get(key);                                      \n                                                                                         \n    if (modelClass.isInstance(viewModel)) {                                              \n        //noinspection unchecked                                                         \n        return (T) viewModel;                                                            \n    } else {                                                                             \n        //noinspection StatementWithEmptyBody                                            \n        if (viewModel != null) {                                                         \n            // TODO: log a warning.                                                      \n        }                                                                                \n    }                                                                                    \n                                                                                         \n    viewModel = mFactory.create(modelClass);                                             \n    mViewModelStore.put(key, viewModel);                                                 \n    //noinspection unchecked                                                             \n    return (T) viewModel;                                                                \n}\n\n// AndroidViewModelFactory\n@NonNull                                                                                   \n@Override                                                                                  \npublic <T extends ViewModel> T create(@NonNull Class<T> modelClass) {                      \n    if (AndroidViewModel.class.isAssignableFrom(modelClass)) {                             \n        //noinspection TryWithIdenticalCatches                                             \n        try {                                                                              \n            return modelClass.getConstructor(Application.class).newInstance(mApplication); \n        } catch (NoSuchMethodException e) {                                                \n            throw new RuntimeException(\"Cannot create an instance of \" + modelClass, e);   \n        } catch (IllegalAccessException e) {                                               \n            throw new RuntimeException(\"Cannot create an instance of \" + modelClass, e);   \n        } catch (InstantiationException e) {                                               \n            throw new RuntimeException(\"Cannot create an instance of \" + modelClass, e);   \n        } catch (InvocationTargetException e) {                                            \n            throw new RuntimeException(\"Cannot create an instance of \" + modelClass, e);   \n        }                                                                                  \n    }                                                                                      \n    return super.create(modelClass);                                                       \n}                                                                                          \n```\n\n我们将以上两段代码合起来看，其实逻辑是比较清晰的：\n\n![ViewModelProvider#create](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/viewmodel/ViewModelProvider%23create.png?x-oss-process=style/doc-img)\n\n`Factor` 的实现可以通过反射来实现，比如默认的 `AndroidViewModelFactory` 会优先调用使用 `Application` 作为参数的构造方法，来创建实例。所以，如果自定义的 `ViewModel` 构造方法有其他参数，就需要自定义 `Factor`\n\n而 `ViewModelStore` 则是 `Activity` 重建时还能拥有之前数据的保障。\n\n``` java\nprivate final HashMap<String, ViewModel> mMap = new HashMap<>();                  \n                                                                                  \nfinal void put(String key, ViewModel viewModel) {                                 \n    ViewModel oldViewModel = mMap.put(key, viewModel);                            \n    if (oldViewModel != null) {                                                   \n        oldViewModel.onCleared();                                                 \n    }                                                                             \n}                                                                                 \n                                                                                  \nfinal ViewModel get(String key) {                                                 \n    return mMap.get(key);                                                         \n}                                                                                 \n                                                                                  \n/**                                                                               \n *  Clears internal storage and notifies ViewModels that they are no longer used. \n */                                                                               \npublic final void clear() {                                                       \n    for (ViewModel vm : mMap.values()) {                                          \n        vm.onCleared();                                                           \n    }                                                                             \n    mMap.clear();                                                                 \n}                                                                                 \n```\n\n`ViewModelStore` 的源码很短，可以看到其实就是使用 `HashMap` 作为数据载体。既然有使用，那就需要清理操作，可以看到有个 `clear` 它会清除 `HashMap` 中的缓存数据。我们首先看下 `ViewModelProvider` 中的 `mViewModelStore` 是在哪里赋值的：\n\n``` java\npublic ViewModelProvider(@NonNull ViewModelStoreOwner owner, @NonNull Factory factory) { \n    this(owner.getViewModelStore(), factory);                                            \n}                                                                                        \n                                                                                                                                                                             \npublic ViewModelProvider(@NonNull ViewModelStore store, @NonNull Factory factory) {      \n    mFactory = factory;                                                                  \n    this.mViewModelStore = store;                                                        \n}                                                                                        \n```\n\n通过 `ViewModelStoreOwner.getViewModelStore` 获取 `ViewModelStore` 实例对象，而 `ViewModelStoreOwner` 实际就是我们调用 `ViewModelProviders.of` 中传递的 `FragmentActivity` 和 `Fragment`\n\n> `FragmentActivity` 中会通过 `onRetainNonConfigurationInstance` 和 `getLastNonConfigurationInstance` 去保持 `Activity` 因为屏幕旋转等配置发生改变而导致重建时，数据的唯一性\n\n而 `Fragment` 和 `FragmentActivity` 会在 `onDestory` 时判断是否需要调用 `ViewModelStore.clear`\n\n``` java\n@Override                                                            \nprotected void onDestroy() {                                         \n    super.onDestroy();                                               \n                                                                     \n    if (mViewModelStore != null && !isChangingConfigurations()) {    \n        mViewModelStore.clear();                                     \n    }                                                                \n                                                                     \n    mFragments.dispatchDestroy();                                    \n}                                                                    \n```\n\n讲完 `ViewModelStore` 的缓存功能之后，我们再来看下，`ViewModelProvider.of` 不同签名的方法：\n\n``` java\n@NonNull                                                         \n@MainThread                                                      \npublic static ViewModelProvider of(@NonNull Fragment fragment) { \n    return of(fragment, null);                                   \n}\n\n@NonNull                                                                    \n@MainThread                                                                 \npublic static ViewModelProvider of(@NonNull FragmentActivity activity) {    \n    return of(activity, null);                                              \n}                                                                           \n```\n\n这里需要注意的是，`ViewModel` 在不同作用域下的实例，首先，`FragmentActivity` 和 `Fragment` 都实现了 `ViewModelStoreOwner` 即它们都有各自的 `ViewModelStore` 简单来说，如果想在 `Fragment` 中获取依附的 `Activity` 的 `ViewModel` 实例，那需要使用 `of(FragmentActivity)` 的方法，这也是一种 `Activity` 和 `Fragment` 之间通信的好方式。\n\n### 总结\n\n现在我们来比较下自定义实现的方案和 `ViewModel` ，可以发现其实核心思想是共通，首先我们需要一个保存于 `Activity` 和 `Fragment` 生命周期之外的存储空间，在 `ViewModel` 中是 `ViewModelStore`，其次我们需要在 `Activity` 和 `Fragment` 对应的生命周期中，去初始化和清理这个 `ViewModelStore`","slug":"Jetpack中的ViewModel","published":1,"updated":"2022-06-15T11:19:32.321Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlc0009fho69t9ef91i","content":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>首先祝大家在新的一年中，身体健康，心想事成。</p>\n<p>算了下，去年技术类博客写了 15 篇，看下数量还算比较满意，可是基本都是前半年写的，那时候刚刚下定决心要好好写博客，后半年因为工作上还有自己偷懒心理，基本都没怎么写了，真是惭愧。</p>\n<p>不过经过去年写了这些文章，慢慢也学习到了一些写技术文章上的技巧，希望今年能方得始终，提升文章的质量。</p>\n<h3 id=\"关于-Jetpack\"><a href=\"#关于-Jetpack\" class=\"headerlink\" title=\"关于 Jetpack\"></a>关于 Jetpack</h3><p>相信已经有不少人对 Google 推出的 Jetpack 系列组件都有所耳闻，现在网上已经有不少的分析文章了，涵盖了用法和源码解析，所以我就不重复造轮子，在这个系列文章中，不会涉及使用教程等，只写一些个人的使用体会，也当作给自己做笔记。</p>\n<h3 id=\"关于本文\"><a href=\"#关于本文\" class=\"headerlink\" title=\"关于本文\"></a>关于本文</h3><p>这篇文章主要讲 Jetpack 中的 ViewModel</p>\n<h3 id=\"ViewModel\"><a href=\"#ViewModel\" class=\"headerlink\" title=\"ViewModel\"></a>ViewModel</h3><blockquote>\n<p>The <a href=\"https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html\"><code>ViewModel</code></a> class is designed to store and manage UI-related data in a lifecycle conscious way. </p>\n</blockquote>\n<p>简而言之，就是在生命周期中管理数据。说到生命周期，我们都知道 Android 中 <code>Activity</code> 和 <code>Fragment</code> 都有各自对应的生命周期，比如 <code>Activity</code>，它的生命周期如下图：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/activity_lifecycle.png?x-oss-process=style/doc-img\" alt=\"activity_lifecycle\"></p>\n<p>通常我们会在 <code>onCreate()</code> 初始化数据，在 <code>onResume()</code> 中展示数据，<code>onDestroy()</code> 中释放数据，类似下面这些伪代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">onCreate() &#123;</span><br><span class=\"line\">    initData();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">onResume() &#123;</span><br><span class=\"line\">    displayData()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">onDestory() &#123;</span><br><span class=\"line\">    recycleData();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果没有在 <code>onDestory()</code> 中及时释放某些资源，可能还会导致内存泄漏，这是第一个问题。</p>\n<p>第二个问题，Android 系统可能会在内存不足的情况下，回收了 <code>Activity</code>，导致 <code>Activity</code> 重建时数据会丢失，对于这种情况，Android 提供了 <code>onSaveInstanceState</code> 中保存数据，在 <code>onRestoreInstanceState</code> 和 <code>onCreate</code> 中获取。类似下面这些伪代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">onSaveInstanceState(Bundle outState) &#123;</span><br><span class=\"line\"> \toutState.putData();   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">onRestoreInstanceState(Bundle outState) &#123;</span><br><span class=\"line\">    outState.getData();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">onCreate(Bundle savedInstanceState) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (savedInstanceState != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        savedInstanceState.getData();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这种方式除了重复的胶水代码以外，还存在 <code>Bundle</code> 存储只适用于支持序列化（Serializable 和 Parcelable）的少量数据，当然除了使用 Android SDK 提供的这种方案以外，我们也可以自己实现类似的方案，类似以下伪代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Data Repository</span></span><br><span class=\"line\">Map&lt;String,Data&gt; map;</span><br><span class=\"line\"></span><br><span class=\"line\">getData(String id) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (map.get(id) == <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">        <span class=\"type\">Data</span> <span class=\"variable\">data</span> <span class=\"operator\">=</span> createData();</span><br><span class=\"line\">        map.put(id,data);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> map.get(id);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">removeData(String id) &#123;</span><br><span class=\"line\">    map.removeByKey(id);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Activity</span></span><br><span class=\"line\">onCreate() &#123;</span><br><span class=\"line\">    getData(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">onDestory() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!isChangingConfigurations)&#123;</span><br><span class=\"line\">            removeData(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>看了上面解决思路后，我们再来看看 Google 提供的 <code>ViewModel</code>，它是如何解决上面提到的两个问题的。首先看下，<code>ViewModel</code> 的典型用法，来源于官方文档：</p>\n<p>首先定义一个 <code>MyViewModel</code> 继承于 <code>ViewModel</code>，这里使用 <code>LiveData</code> 作为数据源，这里我们只需要知道 <code>LiveData</code> 和 <code>RxJava</code> 是差不多的东西就可以了</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyViewModel</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ViewModel</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> MutableLiveData&lt;List&lt;User&gt;&gt; users;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> LiveData&lt;List&lt;User&gt;&gt; <span class=\"title function_\">getUsers</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (users == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            users = <span class=\"keyword\">new</span> <span class=\"title class_\">MutableLiveData</span>&lt;List&lt;User&gt;&gt;();</span><br><span class=\"line\">            loadUsers();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> users;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">loadUsers</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Do an asynchronous operation to fetch users.</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>定义好 <code>ViewModel</code> 之后，我们在 <code>Activity</code> 中使用它：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyActivity</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AppCompatActivity</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Create a ViewModel the first time the system calls an activity&#x27;s onCreate() method.</span></span><br><span class=\"line\">        <span class=\"comment\">// Re-created activities receive the same MyViewModel instance created by the first activity.</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">MyViewModel</span> <span class=\"variable\">model</span> <span class=\"operator\">=</span> ViewModelProviders.of(<span class=\"built_in\">this</span>).get(MyViewModel.class);</span><br><span class=\"line\">        model.getUsers().observe(<span class=\"built_in\">this</span>, users -&gt; &#123;</span><br><span class=\"line\">            <span class=\"comment\">// update UI</span></span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>我们先看下 <code>ViewModelProviders.of</code> 的函数签名：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Fragment fragment)</span>;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> FragmentActivity activity)</span>;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Fragment fragment, <span class=\"meta\">@Nullable</span> Factory factory)</span>;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> FragmentActivity activity,</span></span><br><span class=\"line\"><span class=\"params\">            <span class=\"meta\">@Nullable</span> Factory factory)</span>;</span><br></pre></td></tr></table></figure>\n\n<p>需要将当前 <code>Activity</code> 或 <code>Fragment</code> 作为参数，这也是 <code>ViewModel</code> 将数据与生命周期结合起来的地方。那具体也是如何实现的呢？</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                                             </span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                                          </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> FragmentActivity activity,               </span></span><br><span class=\"line\"><span class=\"params\">        <span class=\"meta\">@Nullable</span> Factory factory)</span> &#123;                                                 </span><br><span class=\"line\">    <span class=\"type\">Application</span> <span class=\"variable\">application</span> <span class=\"operator\">=</span> checkApplication(activity);                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (factory == <span class=\"literal\">null</span>) &#123;                                                           </span><br><span class=\"line\">        factory = ViewModelProvider.AndroidViewModelFactory.getInstance(application);</span><br><span class=\"line\">    &#125;                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ViewModelProvider</span>(activity.getViewModelStore(), factory);             </span><br><span class=\"line\">&#125;                                                                                    </span><br></pre></td></tr></table></figure>\n\n<p><code>factory</code> 顾名思义就是 <code>ViewModel</code> 的工厂类，这里默认使用 <code>AndroidViewModelFactory</code> 最后返回 <code>ViewModelProvider</code> 实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ViewModelProvider</span></span><br><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                                                 </span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                                              </span><br><span class=\"line\"><span class=\"keyword\">public</span> &lt;T <span class=\"keyword\">extends</span> <span class=\"title class_\">ViewModel</span>&gt; T <span class=\"title function_\">get</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> String key, <span class=\"meta\">@NonNull</span> Class&lt;T&gt; modelClass)</span> &#123;  </span><br><span class=\"line\">    <span class=\"type\">ViewModel</span> <span class=\"variable\">viewModel</span> <span class=\"operator\">=</span> mViewModelStore.get(key);                                      </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (modelClass.isInstance(viewModel)) &#123;                                              </span><br><span class=\"line\">        <span class=\"comment\">//noinspection unchecked                                                         </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> (T) viewModel;                                                            </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                             </span><br><span class=\"line\">        <span class=\"comment\">//noinspection StatementWithEmptyBody                                            </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (viewModel != <span class=\"literal\">null</span>) &#123;                                                         </span><br><span class=\"line\">            <span class=\"comment\">// <span class=\"doctag\">TODO:</span> log a warning.                                                      </span></span><br><span class=\"line\">        &#125;                                                                                </span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">    viewModel = mFactory.create(modelClass);                                             </span><br><span class=\"line\">    mViewModelStore.put(key, viewModel);                                                 </span><br><span class=\"line\">    <span class=\"comment\">//noinspection unchecked                                                             </span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (T) viewModel;                                                                </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// AndroidViewModelFactory</span></span><br><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                                                   </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                  </span><br><span class=\"line\"><span class=\"keyword\">public</span> &lt;T <span class=\"keyword\">extends</span> <span class=\"title class_\">ViewModel</span>&gt; T <span class=\"title function_\">create</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Class&lt;T&gt; modelClass)</span> &#123;                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (AndroidViewModel.class.isAssignableFrom(modelClass)) &#123;                             </span><br><span class=\"line\">        <span class=\"comment\">//noinspection TryWithIdenticalCatches                                             </span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;                                                                              </span><br><span class=\"line\">            <span class=\"keyword\">return</span> modelClass.getConstructor(Application.class).newInstance(mApplication); </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException e) &#123;                                                </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Cannot create an instance of &quot;</span> + modelClass, e);   </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IllegalAccessException e) &#123;                                               </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Cannot create an instance of &quot;</span> + modelClass, e);   </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InstantiationException e) &#123;                                               </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Cannot create an instance of &quot;</span> + modelClass, e);   </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InvocationTargetException e) &#123;                                            </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Cannot create an instance of &quot;</span> + modelClass, e);   </span><br><span class=\"line\">        &#125;                                                                                  </span><br><span class=\"line\">    &#125;                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.create(modelClass);                                                       </span><br><span class=\"line\">&#125;                                                                                          </span><br></pre></td></tr></table></figure>\n\n<p>我们将以上两段代码合起来看，其实逻辑是比较清晰的：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/viewmodel/ViewModelProvider%23create.png?x-oss-process=style/doc-img\" alt=\"ViewModelProvider#create\"></p>\n<p><code>Factor</code> 的实现可以通过反射来实现，比如默认的 <code>AndroidViewModelFactory</code> 会优先调用使用 <code>Application</code> 作为参数的构造方法，来创建实例。所以，如果自定义的 <code>ViewModel</code> 构造方法有其他参数，就需要自定义 <code>Factor</code></p>\n<p>而 <code>ViewModelStore</code> 则是 <code>Activity</code> 重建时还能拥有之前数据的保障。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> HashMap&lt;String, ViewModel&gt; mMap = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();                  </span><br><span class=\"line\">                                                                                  </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">put</span><span class=\"params\">(String key, ViewModel viewModel)</span> &#123;                                 </span><br><span class=\"line\">    <span class=\"type\">ViewModel</span> <span class=\"variable\">oldViewModel</span> <span class=\"operator\">=</span> mMap.put(key, viewModel);                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldViewModel != <span class=\"literal\">null</span>) &#123;                                                   </span><br><span class=\"line\">        oldViewModel.onCleared();                                                 </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">&#125;                                                                                 </span><br><span class=\"line\">                                                                                  </span><br><span class=\"line\"><span class=\"keyword\">final</span> ViewModel <span class=\"title function_\">get</span><span class=\"params\">(String key)</span> &#123;                                                 </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mMap.get(key);                                                         </span><br><span class=\"line\">&#125;                                                                                 </span><br><span class=\"line\">                                                                                  </span><br><span class=\"line\"><span class=\"comment\">/**                                                                               </span></span><br><span class=\"line\"><span class=\"comment\"> *  Clears internal storage and notifies ViewModels that they are no longer used. </span></span><br><span class=\"line\"><span class=\"comment\"> */</span>                                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">clear</span><span class=\"params\">()</span> &#123;                                                       </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (ViewModel vm : mMap.values()) &#123;                                          </span><br><span class=\"line\">        vm.onCleared();                                                           </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    mMap.clear();                                                                 </span><br><span class=\"line\">&#125;                                                                                 </span><br></pre></td></tr></table></figure>\n\n<p><code>ViewModelStore</code> 的源码很短，可以看到其实就是使用 <code>HashMap</code> 作为数据载体。既然有使用，那就需要清理操作，可以看到有个 <code>clear</code> 它会清除 <code>HashMap</code> 中的缓存数据。我们首先看下 <code>ViewModelProvider</code> 中的 <code>mViewModelStore</code> 是在哪里赋值的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ViewModelProvider</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> ViewModelStoreOwner owner, <span class=\"meta\">@NonNull</span> Factory factory)</span> &#123; </span><br><span class=\"line\">    <span class=\"built_in\">this</span>(owner.getViewModelStore(), factory);                                            </span><br><span class=\"line\">&#125;                                                                                        </span><br><span class=\"line\">                                                                                                                                                                             </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ViewModelProvider</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> ViewModelStore store, <span class=\"meta\">@NonNull</span> Factory factory)</span> &#123;      </span><br><span class=\"line\">    mFactory = factory;                                                                  </span><br><span class=\"line\">    <span class=\"built_in\">this</span>.mViewModelStore = store;                                                        </span><br><span class=\"line\">&#125;                                                                                        </span><br></pre></td></tr></table></figure>\n\n<p>通过 <code>ViewModelStoreOwner.getViewModelStore</code> 获取 <code>ViewModelStore</code> 实例对象，而 <code>ViewModelStoreOwner</code> 实际就是我们调用 <code>ViewModelProviders.of</code> 中传递的 <code>FragmentActivity</code> 和 <code>Fragment</code></p>\n<blockquote>\n<p><code>FragmentActivity</code> 中会通过 <code>onRetainNonConfigurationInstance</code> 和 <code>getLastNonConfigurationInstance</code> 去保持 <code>Activity</code> 因为屏幕旋转等配置发生改变而导致重建时，数据的唯一性</p>\n</blockquote>\n<p>而 <code>Fragment</code> 和 <code>FragmentActivity</code> 会在 <code>onDestory</code> 时判断是否需要调用 <code>ViewModelStore.clear</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                            </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onDestroy</span><span class=\"params\">()</span> &#123;                                         </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onDestroy();                                               </span><br><span class=\"line\">                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mViewModelStore != <span class=\"literal\">null</span> &amp;&amp; !isChangingConfigurations()) &#123;    </span><br><span class=\"line\">        mViewModelStore.clear();                                     </span><br><span class=\"line\">    &#125;                                                                </span><br><span class=\"line\">                                                                     </span><br><span class=\"line\">    mFragments.dispatchDestroy();                                    </span><br><span class=\"line\">&#125;                                                                    </span><br></pre></td></tr></table></figure>\n\n<p>讲完 <code>ViewModelStore</code> 的缓存功能之后，我们再来看下，<code>ViewModelProvider.of</code> 不同签名的方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                         </span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                      </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Fragment fragment)</span> &#123; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> of(fragment, <span class=\"literal\">null</span>);                                   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                                    </span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                                 </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> FragmentActivity activity)</span> &#123;    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> of(activity, <span class=\"literal\">null</span>);                                              </span><br><span class=\"line\">&#125;                                                                           </span><br></pre></td></tr></table></figure>\n\n<p>这里需要注意的是，<code>ViewModel</code> 在不同作用域下的实例，首先，<code>FragmentActivity</code> 和 <code>Fragment</code> 都实现了 <code>ViewModelStoreOwner</code> 即它们都有各自的 <code>ViewModelStore</code> 简单来说，如果想在 <code>Fragment</code> 中获取依附的 <code>Activity</code> 的 <code>ViewModel</code> 实例，那需要使用 <code>of(FragmentActivity)</code> 的方法，这也是一种 <code>Activity</code> 和 <code>Fragment</code> 之间通信的好方式。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>现在我们来比较下自定义实现的方案和 <code>ViewModel</code> ，可以发现其实核心思想是共通，首先我们需要一个保存于 <code>Activity</code> 和 <code>Fragment</code> 生命周期之外的存储空间，在 <code>ViewModel</code> 中是 <code>ViewModelStore</code>，其次我们需要在 <code>Activity</code> 和 <code>Fragment</code> 对应的生命周期中，去初始化和清理这个 <code>ViewModelStore</code></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>首先祝大家在新的一年中，身体健康，心想事成。</p>\n<p>算了下，去年技术类博客写了 15 篇，看下数量还算比较满意，可是基本都是前半年写的，那时候刚刚下定决心要好好写博客，后半年因为工作上还有自己偷懒心理，基本都没怎么写了，真是惭愧。</p>\n<p>不过经过去年写了这些文章，慢慢也学习到了一些写技术文章上的技巧，希望今年能方得始终，提升文章的质量。</p>\n<h3 id=\"关于-Jetpack\"><a href=\"#关于-Jetpack\" class=\"headerlink\" title=\"关于 Jetpack\"></a>关于 Jetpack</h3><p>相信已经有不少人对 Google 推出的 Jetpack 系列组件都有所耳闻，现在网上已经有不少的分析文章了，涵盖了用法和源码解析，所以我就不重复造轮子，在这个系列文章中，不会涉及使用教程等，只写一些个人的使用体会，也当作给自己做笔记。</p>\n<h3 id=\"关于本文\"><a href=\"#关于本文\" class=\"headerlink\" title=\"关于本文\"></a>关于本文</h3><p>这篇文章主要讲 Jetpack 中的 ViewModel</p>\n<h3 id=\"ViewModel\"><a href=\"#ViewModel\" class=\"headerlink\" title=\"ViewModel\"></a>ViewModel</h3><blockquote>\n<p>The <a href=\"https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html\"><code>ViewModel</code></a> class is designed to store and manage UI-related data in a lifecycle conscious way. </p>\n</blockquote>\n<p>简而言之，就是在生命周期中管理数据。说到生命周期，我们都知道 Android 中 <code>Activity</code> 和 <code>Fragment</code> 都有各自对应的生命周期，比如 <code>Activity</code>，它的生命周期如下图：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/activity_lifecycle.png?x-oss-process=style/doc-img\" alt=\"activity_lifecycle\"></p>\n<p>通常我们会在 <code>onCreate()</code> 初始化数据，在 <code>onResume()</code> 中展示数据，<code>onDestroy()</code> 中释放数据，类似下面这些伪代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">onCreate() &#123;</span><br><span class=\"line\">    initData();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">onResume() &#123;</span><br><span class=\"line\">    displayData()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">onDestory() &#123;</span><br><span class=\"line\">    recycleData();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果没有在 <code>onDestory()</code> 中及时释放某些资源，可能还会导致内存泄漏，这是第一个问题。</p>\n<p>第二个问题，Android 系统可能会在内存不足的情况下，回收了 <code>Activity</code>，导致 <code>Activity</code> 重建时数据会丢失，对于这种情况，Android 提供了 <code>onSaveInstanceState</code> 中保存数据，在 <code>onRestoreInstanceState</code> 和 <code>onCreate</code> 中获取。类似下面这些伪代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">onSaveInstanceState(Bundle outState) &#123;</span><br><span class=\"line\"> \toutState.putData();   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">onRestoreInstanceState(Bundle outState) &#123;</span><br><span class=\"line\">    outState.getData();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">onCreate(Bundle savedInstanceState) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (savedInstanceState != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        savedInstanceState.getData();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这种方式除了重复的胶水代码以外，还存在 <code>Bundle</code> 存储只适用于支持序列化（Serializable 和 Parcelable）的少量数据，当然除了使用 Android SDK 提供的这种方案以外，我们也可以自己实现类似的方案，类似以下伪代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Data Repository</span></span><br><span class=\"line\">Map&lt;String,Data&gt; map;</span><br><span class=\"line\"></span><br><span class=\"line\">getData(String id) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (map.get(id) == <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">        <span class=\"type\">Data</span> <span class=\"variable\">data</span> <span class=\"operator\">=</span> createData();</span><br><span class=\"line\">        map.put(id,data);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> map.get(id);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">removeData(String id) &#123;</span><br><span class=\"line\">    map.removeByKey(id);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Activity</span></span><br><span class=\"line\">onCreate() &#123;</span><br><span class=\"line\">    getData(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">onDestory() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!isChangingConfigurations)&#123;</span><br><span class=\"line\">            removeData(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>看了上面解决思路后，我们再来看看 Google 提供的 <code>ViewModel</code>，它是如何解决上面提到的两个问题的。首先看下，<code>ViewModel</code> 的典型用法，来源于官方文档：</p>\n<p>首先定义一个 <code>MyViewModel</code> 继承于 <code>ViewModel</code>，这里使用 <code>LiveData</code> 作为数据源，这里我们只需要知道 <code>LiveData</code> 和 <code>RxJava</code> 是差不多的东西就可以了</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyViewModel</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ViewModel</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> MutableLiveData&lt;List&lt;User&gt;&gt; users;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> LiveData&lt;List&lt;User&gt;&gt; <span class=\"title function_\">getUsers</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (users == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            users = <span class=\"keyword\">new</span> <span class=\"title class_\">MutableLiveData</span>&lt;List&lt;User&gt;&gt;();</span><br><span class=\"line\">            loadUsers();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> users;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">loadUsers</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Do an asynchronous operation to fetch users.</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>定义好 <code>ViewModel</code> 之后，我们在 <code>Activity</code> 中使用它：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyActivity</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AppCompatActivity</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Create a ViewModel the first time the system calls an activity&#x27;s onCreate() method.</span></span><br><span class=\"line\">        <span class=\"comment\">// Re-created activities receive the same MyViewModel instance created by the first activity.</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">MyViewModel</span> <span class=\"variable\">model</span> <span class=\"operator\">=</span> ViewModelProviders.of(<span class=\"built_in\">this</span>).get(MyViewModel.class);</span><br><span class=\"line\">        model.getUsers().observe(<span class=\"built_in\">this</span>, users -&gt; &#123;</span><br><span class=\"line\">            <span class=\"comment\">// update UI</span></span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>我们先看下 <code>ViewModelProviders.of</code> 的函数签名：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Fragment fragment)</span>;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> FragmentActivity activity)</span>;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Fragment fragment, <span class=\"meta\">@Nullable</span> Factory factory)</span>;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> FragmentActivity activity,</span></span><br><span class=\"line\"><span class=\"params\">            <span class=\"meta\">@Nullable</span> Factory factory)</span>;</span><br></pre></td></tr></table></figure>\n\n<p>需要将当前 <code>Activity</code> 或 <code>Fragment</code> 作为参数，这也是 <code>ViewModel</code> 将数据与生命周期结合起来的地方。那具体也是如何实现的呢？</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                                             </span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                                          </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> FragmentActivity activity,               </span></span><br><span class=\"line\"><span class=\"params\">        <span class=\"meta\">@Nullable</span> Factory factory)</span> &#123;                                                 </span><br><span class=\"line\">    <span class=\"type\">Application</span> <span class=\"variable\">application</span> <span class=\"operator\">=</span> checkApplication(activity);                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (factory == <span class=\"literal\">null</span>) &#123;                                                           </span><br><span class=\"line\">        factory = ViewModelProvider.AndroidViewModelFactory.getInstance(application);</span><br><span class=\"line\">    &#125;                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ViewModelProvider</span>(activity.getViewModelStore(), factory);             </span><br><span class=\"line\">&#125;                                                                                    </span><br></pre></td></tr></table></figure>\n\n<p><code>factory</code> 顾名思义就是 <code>ViewModel</code> 的工厂类，这里默认使用 <code>AndroidViewModelFactory</code> 最后返回 <code>ViewModelProvider</code> 实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ViewModelProvider</span></span><br><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                                                 </span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                                              </span><br><span class=\"line\"><span class=\"keyword\">public</span> &lt;T <span class=\"keyword\">extends</span> <span class=\"title class_\">ViewModel</span>&gt; T <span class=\"title function_\">get</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> String key, <span class=\"meta\">@NonNull</span> Class&lt;T&gt; modelClass)</span> &#123;  </span><br><span class=\"line\">    <span class=\"type\">ViewModel</span> <span class=\"variable\">viewModel</span> <span class=\"operator\">=</span> mViewModelStore.get(key);                                      </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (modelClass.isInstance(viewModel)) &#123;                                              </span><br><span class=\"line\">        <span class=\"comment\">//noinspection unchecked                                                         </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> (T) viewModel;                                                            </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                             </span><br><span class=\"line\">        <span class=\"comment\">//noinspection StatementWithEmptyBody                                            </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (viewModel != <span class=\"literal\">null</span>) &#123;                                                         </span><br><span class=\"line\">            <span class=\"comment\">// <span class=\"doctag\">TODO:</span> log a warning.                                                      </span></span><br><span class=\"line\">        &#125;                                                                                </span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">    viewModel = mFactory.create(modelClass);                                             </span><br><span class=\"line\">    mViewModelStore.put(key, viewModel);                                                 </span><br><span class=\"line\">    <span class=\"comment\">//noinspection unchecked                                                             </span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (T) viewModel;                                                                </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// AndroidViewModelFactory</span></span><br><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                                                   </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                  </span><br><span class=\"line\"><span class=\"keyword\">public</span> &lt;T <span class=\"keyword\">extends</span> <span class=\"title class_\">ViewModel</span>&gt; T <span class=\"title function_\">create</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Class&lt;T&gt; modelClass)</span> &#123;                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (AndroidViewModel.class.isAssignableFrom(modelClass)) &#123;                             </span><br><span class=\"line\">        <span class=\"comment\">//noinspection TryWithIdenticalCatches                                             </span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;                                                                              </span><br><span class=\"line\">            <span class=\"keyword\">return</span> modelClass.getConstructor(Application.class).newInstance(mApplication); </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException e) &#123;                                                </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Cannot create an instance of &quot;</span> + modelClass, e);   </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IllegalAccessException e) &#123;                                               </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Cannot create an instance of &quot;</span> + modelClass, e);   </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InstantiationException e) &#123;                                               </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Cannot create an instance of &quot;</span> + modelClass, e);   </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InvocationTargetException e) &#123;                                            </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Cannot create an instance of &quot;</span> + modelClass, e);   </span><br><span class=\"line\">        &#125;                                                                                  </span><br><span class=\"line\">    &#125;                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.create(modelClass);                                                       </span><br><span class=\"line\">&#125;                                                                                          </span><br></pre></td></tr></table></figure>\n\n<p>我们将以上两段代码合起来看，其实逻辑是比较清晰的：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/viewmodel/ViewModelProvider%23create.png?x-oss-process=style/doc-img\" alt=\"ViewModelProvider#create\"></p>\n<p><code>Factor</code> 的实现可以通过反射来实现，比如默认的 <code>AndroidViewModelFactory</code> 会优先调用使用 <code>Application</code> 作为参数的构造方法，来创建实例。所以，如果自定义的 <code>ViewModel</code> 构造方法有其他参数，就需要自定义 <code>Factor</code></p>\n<p>而 <code>ViewModelStore</code> 则是 <code>Activity</code> 重建时还能拥有之前数据的保障。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> HashMap&lt;String, ViewModel&gt; mMap = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();                  </span><br><span class=\"line\">                                                                                  </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">put</span><span class=\"params\">(String key, ViewModel viewModel)</span> &#123;                                 </span><br><span class=\"line\">    <span class=\"type\">ViewModel</span> <span class=\"variable\">oldViewModel</span> <span class=\"operator\">=</span> mMap.put(key, viewModel);                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldViewModel != <span class=\"literal\">null</span>) &#123;                                                   </span><br><span class=\"line\">        oldViewModel.onCleared();                                                 </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">&#125;                                                                                 </span><br><span class=\"line\">                                                                                  </span><br><span class=\"line\"><span class=\"keyword\">final</span> ViewModel <span class=\"title function_\">get</span><span class=\"params\">(String key)</span> &#123;                                                 </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mMap.get(key);                                                         </span><br><span class=\"line\">&#125;                                                                                 </span><br><span class=\"line\">                                                                                  </span><br><span class=\"line\"><span class=\"comment\">/**                                                                               </span></span><br><span class=\"line\"><span class=\"comment\"> *  Clears internal storage and notifies ViewModels that they are no longer used. </span></span><br><span class=\"line\"><span class=\"comment\"> */</span>                                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">clear</span><span class=\"params\">()</span> &#123;                                                       </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (ViewModel vm : mMap.values()) &#123;                                          </span><br><span class=\"line\">        vm.onCleared();                                                           </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    mMap.clear();                                                                 </span><br><span class=\"line\">&#125;                                                                                 </span><br></pre></td></tr></table></figure>\n\n<p><code>ViewModelStore</code> 的源码很短，可以看到其实就是使用 <code>HashMap</code> 作为数据载体。既然有使用，那就需要清理操作，可以看到有个 <code>clear</code> 它会清除 <code>HashMap</code> 中的缓存数据。我们首先看下 <code>ViewModelProvider</code> 中的 <code>mViewModelStore</code> 是在哪里赋值的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ViewModelProvider</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> ViewModelStoreOwner owner, <span class=\"meta\">@NonNull</span> Factory factory)</span> &#123; </span><br><span class=\"line\">    <span class=\"built_in\">this</span>(owner.getViewModelStore(), factory);                                            </span><br><span class=\"line\">&#125;                                                                                        </span><br><span class=\"line\">                                                                                                                                                                             </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ViewModelProvider</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> ViewModelStore store, <span class=\"meta\">@NonNull</span> Factory factory)</span> &#123;      </span><br><span class=\"line\">    mFactory = factory;                                                                  </span><br><span class=\"line\">    <span class=\"built_in\">this</span>.mViewModelStore = store;                                                        </span><br><span class=\"line\">&#125;                                                                                        </span><br></pre></td></tr></table></figure>\n\n<p>通过 <code>ViewModelStoreOwner.getViewModelStore</code> 获取 <code>ViewModelStore</code> 实例对象，而 <code>ViewModelStoreOwner</code> 实际就是我们调用 <code>ViewModelProviders.of</code> 中传递的 <code>FragmentActivity</code> 和 <code>Fragment</code></p>\n<blockquote>\n<p><code>FragmentActivity</code> 中会通过 <code>onRetainNonConfigurationInstance</code> 和 <code>getLastNonConfigurationInstance</code> 去保持 <code>Activity</code> 因为屏幕旋转等配置发生改变而导致重建时，数据的唯一性</p>\n</blockquote>\n<p>而 <code>Fragment</code> 和 <code>FragmentActivity</code> 会在 <code>onDestory</code> 时判断是否需要调用 <code>ViewModelStore.clear</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                            </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onDestroy</span><span class=\"params\">()</span> &#123;                                         </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onDestroy();                                               </span><br><span class=\"line\">                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mViewModelStore != <span class=\"literal\">null</span> &amp;&amp; !isChangingConfigurations()) &#123;    </span><br><span class=\"line\">        mViewModelStore.clear();                                     </span><br><span class=\"line\">    &#125;                                                                </span><br><span class=\"line\">                                                                     </span><br><span class=\"line\">    mFragments.dispatchDestroy();                                    </span><br><span class=\"line\">&#125;                                                                    </span><br></pre></td></tr></table></figure>\n\n<p>讲完 <code>ViewModelStore</code> 的缓存功能之后，我们再来看下，<code>ViewModelProvider.of</code> 不同签名的方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                         </span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                      </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Fragment fragment)</span> &#123; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> of(fragment, <span class=\"literal\">null</span>);                                   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                                    </span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                                 </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ViewModelProvider <span class=\"title function_\">of</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> FragmentActivity activity)</span> &#123;    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> of(activity, <span class=\"literal\">null</span>);                                              </span><br><span class=\"line\">&#125;                                                                           </span><br></pre></td></tr></table></figure>\n\n<p>这里需要注意的是，<code>ViewModel</code> 在不同作用域下的实例，首先，<code>FragmentActivity</code> 和 <code>Fragment</code> 都实现了 <code>ViewModelStoreOwner</code> 即它们都有各自的 <code>ViewModelStore</code> 简单来说，如果想在 <code>Fragment</code> 中获取依附的 <code>Activity</code> 的 <code>ViewModel</code> 实例，那需要使用 <code>of(FragmentActivity)</code> 的方法，这也是一种 <code>Activity</code> 和 <code>Fragment</code> 之间通信的好方式。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>现在我们来比较下自定义实现的方案和 <code>ViewModel</code> ，可以发现其实核心思想是共通，首先我们需要一个保存于 <code>Activity</code> 和 <code>Fragment</code> 生命周期之外的存储空间，在 <code>ViewModel</code> 中是 <code>ViewModelStore</code>，其次我们需要在 <code>Activity</code> 和 <code>Fragment</code> 对应的生命周期中，去初始化和清理这个 <code>ViewModelStore</code></p>\n"},{"title":"LeetCode 5: Longest Palindromic Substring","date":"2019-12-12T06:35:50.000Z","_content":"\n### 题目描述\n\n给定一个字符串 `s`，找到 `s` 中最长的回文子串。你可以假设 `s` 的最大长度为 1000。\n\n### 解题思路\n\n* 中心扩展算法\n\n  计算以字符串中的每一个字符为中心，向两边扩展的最长回文串。\n\n  以字符串 \"babad\" 为例，第一个字符 'b'，以它为中心的最长回文串就是它本身，再看第二个字符 'a'，以它为中心的最长回文串是 \"bab\"。\n\n  代码如下：\n\n  ``` java\n      public String longestPalindrome2(String s) {\n          if (s.length() < 2) {\n              return s;\n          }\n          int[] ret = new int[2];\n          for (int i = 0; i < s.length(); i++) {\n              loop(ret, i, s);\n          }\n          return s.substring(ret[0], ret[1]);\n      }\n  \n      private void loop(int[] ret, int low, String s) {\n          int high = low;\n          // Code 1\n          while (high < s.length() - 1 && s.charAt(high + 1) == s.charAt(low)) high++;\n          while (high < s.length() && low >= 0 && s.charAt(low) == s.charAt(high)) {\n              high++;\n              low--;\n          }\n          if (high - low - 1 > ret[1] - ret[0]) {\n              ret[0] = low + 1;\n              ret[1] = high;\n          }\n      }\n  ```\n\n  Code 1 处是考虑偶数回文串的情况，比如 \"aa\" 这种也是回文串，只要是相同字符，不管有多少位都是回文串。\n\n  | 空间复杂度 | 时间复杂度   |\n  | ---------- | ------------ |\n  | O(1)       | O($$N ^ 2$$) |\n\n  \n\n* 动态规划\n\n  使用一个二维数组来缓存回文串的判断，`dp[i][j]` 表示从下标 i 到 j 的字符串是否为回文串。\n\n  状态转移方程如下：\n\n  ``` java\n  dp[i][j] = dp[i+1][j-1] && S(i) == S(j)\n  ```\n\n  代码如下：\n\n  ``` java\n      public String longestPalindrome(String s) {\n  \n          if (s.length() < 2) {\n              return s;\n          }\n  \n          String max = s.substring(0, 1);\n          boolean[][] dp = new boolean[s.length()][s.length()];\n          for (int i = s.length() - 1; i > -1; i--) {\n              for (int j = i; j < s.length(); j++) {\n                // Code 1\n                  dp[i][j] = (s.charAt(i) == s.charAt(j))\n                          && (j - i < 3 || dp[i + 1][j - 1]);\n                  if (dp[i][j] && j - i + 1 > max.length()) {\n                      max = s.substring(i, j + 1);\n                  }\n              }\n          }\n          return max;\n      }\n  ```\n\n  Code 1 代码处中的 `j - i < 3` 是考虑 \"a\"、\"aa\" 和 \"aba\" 这些情况。\n\n  | 空间复杂度 | 时间复杂度 |\n  | ---------- | ---------- |\n  | O($$N^2$$) | O($$N^2$$) |\n\n  \n\n* Manacher 算法\n\n  这里有篇详细介绍的文章，可移步：[最长回文子串——Manacher 算法](https://segmentfault.com/a/1190000003914228)\n\n  相对于前面两种解法，Manacher 算法有以下优点：\n\n  * 通过在字符间插入特殊字符，使得字符串的长度变成奇数，不会影响最终结果，但不用考虑偶数回文串的情况\n  * 复用已经计算好的结果\n  \n  代码如下：\n  \n  ``` java\n  public String longestPalindrome(String s) {\n          if (s.length() < 2) {\n              return s;\n          }\n          StringBuilder builder = new StringBuilder();\n          builder.append(\"#\");\n          for (int i = 0; i < s.length(); i++) {\n              builder.append(s, i, i + 1);\n              builder.append(\"#\");\n          }\n          s = builder.toString();\n          // 下标为 i 的字符为中点的最长回文串的半径\n          int[] dp = new int[s.length()];\n          builder.delete(0, builder.length());\n  \t\t\t\t\n    \t\t\t// 计算过的区域\n          int maxRight = 0;\n          int maxLen = 0;\n          // maxRight 对应的回文串的中点\n          int pos = 0;\n  \n          for (int i = 0; i < s.length(); i++) {\n  \n              if (i < maxRight) {\n                // 2 * pos - i 表示，i 关于 pos 对称的点\n                  dp[i] = Math.min(dp[2 * pos - i], maxRight - i + 1);\n              } else {\n                // 默认值为 1\n                  dp[i] = 1;\n              }\n  \n              while (i + dp[i] < s.length() && i - dp[i] >= 0 && s.charAt(i + dp[i]) == s.charAt(i - dp[i])) {\n                // 中点扩散\n                  dp[i] += 1;\n              }\n  \n              if (i + dp[i] - 1 > maxRight) {\n                  maxRight = i + dp[i] - 1;\n                  pos = i;\n              }\n  \n              maxLen = Math.max(maxLen, dp[i]);\n              if (maxLen == dp[i]) {\n                  if (builder.length() > 0) {\n                      builder.delete(0, builder.length());\n                  }\n                  builder.append(s, i - dp[i] + 1, i + dp[i]);\n              }\n  \n          }\n  \n          return builder.toString().replace(\"#\", \"\");\n  \n      }\n  ```\n  \n  | 空间复杂度 | 时间复杂度 |\n  | ---------- | ---------- |\n  | O($$N$$) | O($$N$$) |\n  \n  \n  \n  \n  \n  ","source":"_posts/LeetCode-5-Longest-Palindromic-Substring.md","raw":"---\ntitle: 'LeetCode 5: Longest Palindromic Substring'\ndate: 2019-12-12 14:35:50\ncategories: LeetCode\ntags:\n---\n\n### 题目描述\n\n给定一个字符串 `s`，找到 `s` 中最长的回文子串。你可以假设 `s` 的最大长度为 1000。\n\n### 解题思路\n\n* 中心扩展算法\n\n  计算以字符串中的每一个字符为中心，向两边扩展的最长回文串。\n\n  以字符串 \"babad\" 为例，第一个字符 'b'，以它为中心的最长回文串就是它本身，再看第二个字符 'a'，以它为中心的最长回文串是 \"bab\"。\n\n  代码如下：\n\n  ``` java\n      public String longestPalindrome2(String s) {\n          if (s.length() < 2) {\n              return s;\n          }\n          int[] ret = new int[2];\n          for (int i = 0; i < s.length(); i++) {\n              loop(ret, i, s);\n          }\n          return s.substring(ret[0], ret[1]);\n      }\n  \n      private void loop(int[] ret, int low, String s) {\n          int high = low;\n          // Code 1\n          while (high < s.length() - 1 && s.charAt(high + 1) == s.charAt(low)) high++;\n          while (high < s.length() && low >= 0 && s.charAt(low) == s.charAt(high)) {\n              high++;\n              low--;\n          }\n          if (high - low - 1 > ret[1] - ret[0]) {\n              ret[0] = low + 1;\n              ret[1] = high;\n          }\n      }\n  ```\n\n  Code 1 处是考虑偶数回文串的情况，比如 \"aa\" 这种也是回文串，只要是相同字符，不管有多少位都是回文串。\n\n  | 空间复杂度 | 时间复杂度   |\n  | ---------- | ------------ |\n  | O(1)       | O($$N ^ 2$$) |\n\n  \n\n* 动态规划\n\n  使用一个二维数组来缓存回文串的判断，`dp[i][j]` 表示从下标 i 到 j 的字符串是否为回文串。\n\n  状态转移方程如下：\n\n  ``` java\n  dp[i][j] = dp[i+1][j-1] && S(i) == S(j)\n  ```\n\n  代码如下：\n\n  ``` java\n      public String longestPalindrome(String s) {\n  \n          if (s.length() < 2) {\n              return s;\n          }\n  \n          String max = s.substring(0, 1);\n          boolean[][] dp = new boolean[s.length()][s.length()];\n          for (int i = s.length() - 1; i > -1; i--) {\n              for (int j = i; j < s.length(); j++) {\n                // Code 1\n                  dp[i][j] = (s.charAt(i) == s.charAt(j))\n                          && (j - i < 3 || dp[i + 1][j - 1]);\n                  if (dp[i][j] && j - i + 1 > max.length()) {\n                      max = s.substring(i, j + 1);\n                  }\n              }\n          }\n          return max;\n      }\n  ```\n\n  Code 1 代码处中的 `j - i < 3` 是考虑 \"a\"、\"aa\" 和 \"aba\" 这些情况。\n\n  | 空间复杂度 | 时间复杂度 |\n  | ---------- | ---------- |\n  | O($$N^2$$) | O($$N^2$$) |\n\n  \n\n* Manacher 算法\n\n  这里有篇详细介绍的文章，可移步：[最长回文子串——Manacher 算法](https://segmentfault.com/a/1190000003914228)\n\n  相对于前面两种解法，Manacher 算法有以下优点：\n\n  * 通过在字符间插入特殊字符，使得字符串的长度变成奇数，不会影响最终结果，但不用考虑偶数回文串的情况\n  * 复用已经计算好的结果\n  \n  代码如下：\n  \n  ``` java\n  public String longestPalindrome(String s) {\n          if (s.length() < 2) {\n              return s;\n          }\n          StringBuilder builder = new StringBuilder();\n          builder.append(\"#\");\n          for (int i = 0; i < s.length(); i++) {\n              builder.append(s, i, i + 1);\n              builder.append(\"#\");\n          }\n          s = builder.toString();\n          // 下标为 i 的字符为中点的最长回文串的半径\n          int[] dp = new int[s.length()];\n          builder.delete(0, builder.length());\n  \t\t\t\t\n    \t\t\t// 计算过的区域\n          int maxRight = 0;\n          int maxLen = 0;\n          // maxRight 对应的回文串的中点\n          int pos = 0;\n  \n          for (int i = 0; i < s.length(); i++) {\n  \n              if (i < maxRight) {\n                // 2 * pos - i 表示，i 关于 pos 对称的点\n                  dp[i] = Math.min(dp[2 * pos - i], maxRight - i + 1);\n              } else {\n                // 默认值为 1\n                  dp[i] = 1;\n              }\n  \n              while (i + dp[i] < s.length() && i - dp[i] >= 0 && s.charAt(i + dp[i]) == s.charAt(i - dp[i])) {\n                // 中点扩散\n                  dp[i] += 1;\n              }\n  \n              if (i + dp[i] - 1 > maxRight) {\n                  maxRight = i + dp[i] - 1;\n                  pos = i;\n              }\n  \n              maxLen = Math.max(maxLen, dp[i]);\n              if (maxLen == dp[i]) {\n                  if (builder.length() > 0) {\n                      builder.delete(0, builder.length());\n                  }\n                  builder.append(s, i - dp[i] + 1, i + dp[i]);\n              }\n  \n          }\n  \n          return builder.toString().replace(\"#\", \"\");\n  \n      }\n  ```\n  \n  | 空间复杂度 | 时间复杂度 |\n  | ---------- | ---------- |\n  | O($$N$$) | O($$N$$) |\n  \n  \n  \n  \n  \n  ","slug":"LeetCode-5-Longest-Palindromic-Substring","published":1,"updated":"2022-06-15T11:19:32.321Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrld000afho6fuvvh4ob","content":"<h3 id=\"题目描述\"><a href=\"#题目描述\" class=\"headerlink\" title=\"题目描述\"></a>题目描述</h3><p>给定一个字符串 <code>s</code>，找到 <code>s</code> 中最长的回文子串。你可以假设 <code>s</code> 的最大长度为 1000。</p>\n<h3 id=\"解题思路\"><a href=\"#解题思路\" class=\"headerlink\" title=\"解题思路\"></a>解题思路</h3><ul>\n<li><p>中心扩展算法</p>\n<p>计算以字符串中的每一个字符为中心，向两边扩展的最长回文串。</p>\n<p>以字符串 “babad” 为例，第一个字符 ‘b’，以它为中心的最长回文串就是它本身，再看第二个字符 ‘a’，以它为中心的最长回文串是 “bab”。</p>\n<p>代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> String <span class=\"title function_\">longestPalindrome2</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (s.length() &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"type\">int</span>[] ret = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[<span class=\"number\">2</span>];</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class=\"line\">        loop(ret, i, s);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s.substring(ret[<span class=\"number\">0</span>], ret[<span class=\"number\">1</span>]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">loop</span><span class=\"params\">(<span class=\"type\">int</span>[] ret, <span class=\"type\">int</span> low, String s)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">high</span> <span class=\"operator\">=</span> low;</span><br><span class=\"line\">    <span class=\"comment\">// Code 1</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (high &lt; s.length() - <span class=\"number\">1</span> &amp;&amp; s.charAt(high + <span class=\"number\">1</span>) == s.charAt(low)) high++;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (high &lt; s.length() &amp;&amp; low &gt;= <span class=\"number\">0</span> &amp;&amp; s.charAt(low) == s.charAt(high)) &#123;</span><br><span class=\"line\">        high++;</span><br><span class=\"line\">        low--;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (high - low - <span class=\"number\">1</span> &gt; ret[<span class=\"number\">1</span>] - ret[<span class=\"number\">0</span>]) &#123;</span><br><span class=\"line\">        ret[<span class=\"number\">0</span>] = low + <span class=\"number\">1</span>;</span><br><span class=\"line\">        ret[<span class=\"number\">1</span>] = high;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Code 1 处是考虑偶数回文串的情况，比如 “aa” 这种也是回文串，只要是相同字符，不管有多少位都是回文串。</p>\n<table>\n<thead>\n<tr>\n<th>空间复杂度</th>\n<th>时间复杂度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>O(1)</td>\n<td>O($$N ^ 2$$)</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>动态规划</p>\n<p>使用一个二维数组来缓存回文串的判断，<code>dp[i][j]</code> 表示从下标 i 到 j 的字符串是否为回文串。</p>\n<p>状态转移方程如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dp[i][j] = dp[i+<span class=\"number\">1</span>][j-<span class=\"number\">1</span>] &amp;&amp; S(i) == S(j)</span><br></pre></td></tr></table></figure>\n\n<p>代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> String <span class=\"title function_\">longestPalindrome</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (s.length() &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">max</span> <span class=\"operator\">=</span> s.substring(<span class=\"number\">0</span>, <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"type\">boolean</span>[][] dp = <span class=\"keyword\">new</span> <span class=\"title class_\">boolean</span>[s.length()][s.length()];</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> s.length() - <span class=\"number\">1</span>; i &gt; -<span class=\"number\">1</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> i; j &lt; s.length(); j++) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// Code 1</span></span><br><span class=\"line\">            dp[i][j] = (s.charAt(i) == s.charAt(j))</span><br><span class=\"line\">                    &amp;&amp; (j - i &lt; <span class=\"number\">3</span> || dp[i + <span class=\"number\">1</span>][j - <span class=\"number\">1</span>]);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (dp[i][j] &amp;&amp; j - i + <span class=\"number\">1</span> &gt; max.length()) &#123;</span><br><span class=\"line\">                max = s.substring(i, j + <span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> max;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Code 1 代码处中的 <code>j - i &lt; 3</code> 是考虑 “a”、”aa” 和 “aba” 这些情况。</p>\n<table>\n<thead>\n<tr>\n<th>空间复杂度</th>\n<th>时间复杂度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>O($$N^2$$)</td>\n<td>O($$N^2$$)</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>Manacher 算法</p>\n<p>这里有篇详细介绍的文章，可移步：<a href=\"https://segmentfault.com/a/1190000003914228\">最长回文子串——Manacher 算法</a></p>\n<p>相对于前面两种解法，Manacher 算法有以下优点：</p>\n<ul>\n<li>通过在字符间插入特殊字符，使得字符串的长度变成奇数，不会影响最终结果，但不用考虑偶数回文串的情况</li>\n<li>复用已经计算好的结果</li>\n</ul>\n<p>代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> String <span class=\"title function_\">longestPalindrome</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (s.length() &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> s;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">StringBuilder</span> <span class=\"variable\">builder</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">StringBuilder</span>();</span><br><span class=\"line\">        builder.append(<span class=\"string\">&quot;#&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class=\"line\">            builder.append(s, i, i + <span class=\"number\">1</span>);</span><br><span class=\"line\">            builder.append(<span class=\"string\">&quot;#&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        s = builder.toString();</span><br><span class=\"line\">        <span class=\"comment\">// 下标为 i 的字符为中点的最长回文串的半径</span></span><br><span class=\"line\">        <span class=\"type\">int</span>[] dp = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[s.length()];</span><br><span class=\"line\">        builder.delete(<span class=\"number\">0</span>, builder.length());</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">  \t\t\t<span class=\"comment\">// 计算过的区域</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">maxRight</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">maxLen</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"comment\">// maxRight 对应的回文串的中点</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">pos</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i &lt; maxRight) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 2 * pos - i 表示，i 关于 pos 对称的点</span></span><br><span class=\"line\">                dp[i] = Math.min(dp[<span class=\"number\">2</span> * pos - i], maxRight - i + <span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 默认值为 1</span></span><br><span class=\"line\">                dp[i] = <span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span> (i + dp[i] &lt; s.length() &amp;&amp; i - dp[i] &gt;= <span class=\"number\">0</span> &amp;&amp; s.charAt(i + dp[i]) == s.charAt(i - dp[i])) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 中点扩散</span></span><br><span class=\"line\">                dp[i] += <span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i + dp[i] - <span class=\"number\">1</span> &gt; maxRight) &#123;</span><br><span class=\"line\">                maxRight = i + dp[i] - <span class=\"number\">1</span>;</span><br><span class=\"line\">                pos = i;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            maxLen = Math.max(maxLen, dp[i]);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (maxLen == dp[i]) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (builder.length() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    builder.delete(<span class=\"number\">0</span>, builder.length());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                builder.append(s, i - dp[i] + <span class=\"number\">1</span>, i + dp[i]);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> builder.toString().replace(<span class=\"string\">&quot;#&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>空间复杂度</th>\n<th>时间复杂度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>O($$N$$)</td>\n<td>O($$N$$)</td>\n</tr>\n</tbody></table>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"题目描述\"><a href=\"#题目描述\" class=\"headerlink\" title=\"题目描述\"></a>题目描述</h3><p>给定一个字符串 <code>s</code>，找到 <code>s</code> 中最长的回文子串。你可以假设 <code>s</code> 的最大长度为 1000。</p>\n<h3 id=\"解题思路\"><a href=\"#解题思路\" class=\"headerlink\" title=\"解题思路\"></a>解题思路</h3><ul>\n<li><p>中心扩展算法</p>\n<p>计算以字符串中的每一个字符为中心，向两边扩展的最长回文串。</p>\n<p>以字符串 “babad” 为例，第一个字符 ‘b’，以它为中心的最长回文串就是它本身，再看第二个字符 ‘a’，以它为中心的最长回文串是 “bab”。</p>\n<p>代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> String <span class=\"title function_\">longestPalindrome2</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (s.length() &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"type\">int</span>[] ret = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[<span class=\"number\">2</span>];</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class=\"line\">        loop(ret, i, s);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s.substring(ret[<span class=\"number\">0</span>], ret[<span class=\"number\">1</span>]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">loop</span><span class=\"params\">(<span class=\"type\">int</span>[] ret, <span class=\"type\">int</span> low, String s)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">high</span> <span class=\"operator\">=</span> low;</span><br><span class=\"line\">    <span class=\"comment\">// Code 1</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (high &lt; s.length() - <span class=\"number\">1</span> &amp;&amp; s.charAt(high + <span class=\"number\">1</span>) == s.charAt(low)) high++;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (high &lt; s.length() &amp;&amp; low &gt;= <span class=\"number\">0</span> &amp;&amp; s.charAt(low) == s.charAt(high)) &#123;</span><br><span class=\"line\">        high++;</span><br><span class=\"line\">        low--;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (high - low - <span class=\"number\">1</span> &gt; ret[<span class=\"number\">1</span>] - ret[<span class=\"number\">0</span>]) &#123;</span><br><span class=\"line\">        ret[<span class=\"number\">0</span>] = low + <span class=\"number\">1</span>;</span><br><span class=\"line\">        ret[<span class=\"number\">1</span>] = high;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Code 1 处是考虑偶数回文串的情况，比如 “aa” 这种也是回文串，只要是相同字符，不管有多少位都是回文串。</p>\n<table>\n<thead>\n<tr>\n<th>空间复杂度</th>\n<th>时间复杂度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>O(1)</td>\n<td>O($$N ^ 2$$)</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>动态规划</p>\n<p>使用一个二维数组来缓存回文串的判断，<code>dp[i][j]</code> 表示从下标 i 到 j 的字符串是否为回文串。</p>\n<p>状态转移方程如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dp[i][j] = dp[i+<span class=\"number\">1</span>][j-<span class=\"number\">1</span>] &amp;&amp; S(i) == S(j)</span><br></pre></td></tr></table></figure>\n\n<p>代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> String <span class=\"title function_\">longestPalindrome</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (s.length() &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">max</span> <span class=\"operator\">=</span> s.substring(<span class=\"number\">0</span>, <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"type\">boolean</span>[][] dp = <span class=\"keyword\">new</span> <span class=\"title class_\">boolean</span>[s.length()][s.length()];</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> s.length() - <span class=\"number\">1</span>; i &gt; -<span class=\"number\">1</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> i; j &lt; s.length(); j++) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// Code 1</span></span><br><span class=\"line\">            dp[i][j] = (s.charAt(i) == s.charAt(j))</span><br><span class=\"line\">                    &amp;&amp; (j - i &lt; <span class=\"number\">3</span> || dp[i + <span class=\"number\">1</span>][j - <span class=\"number\">1</span>]);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (dp[i][j] &amp;&amp; j - i + <span class=\"number\">1</span> &gt; max.length()) &#123;</span><br><span class=\"line\">                max = s.substring(i, j + <span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> max;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Code 1 代码处中的 <code>j - i &lt; 3</code> 是考虑 “a”、”aa” 和 “aba” 这些情况。</p>\n<table>\n<thead>\n<tr>\n<th>空间复杂度</th>\n<th>时间复杂度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>O($$N^2$$)</td>\n<td>O($$N^2$$)</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>Manacher 算法</p>\n<p>这里有篇详细介绍的文章，可移步：<a href=\"https://segmentfault.com/a/1190000003914228\">最长回文子串——Manacher 算法</a></p>\n<p>相对于前面两种解法，Manacher 算法有以下优点：</p>\n<ul>\n<li>通过在字符间插入特殊字符，使得字符串的长度变成奇数，不会影响最终结果，但不用考虑偶数回文串的情况</li>\n<li>复用已经计算好的结果</li>\n</ul>\n<p>代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> String <span class=\"title function_\">longestPalindrome</span><span class=\"params\">(String s)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (s.length() &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> s;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">StringBuilder</span> <span class=\"variable\">builder</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">StringBuilder</span>();</span><br><span class=\"line\">        builder.append(<span class=\"string\">&quot;#&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class=\"line\">            builder.append(s, i, i + <span class=\"number\">1</span>);</span><br><span class=\"line\">            builder.append(<span class=\"string\">&quot;#&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        s = builder.toString();</span><br><span class=\"line\">        <span class=\"comment\">// 下标为 i 的字符为中点的最长回文串的半径</span></span><br><span class=\"line\">        <span class=\"type\">int</span>[] dp = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[s.length()];</span><br><span class=\"line\">        builder.delete(<span class=\"number\">0</span>, builder.length());</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">  \t\t\t<span class=\"comment\">// 计算过的区域</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">maxRight</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">maxLen</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"comment\">// maxRight 对应的回文串的中点</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">pos</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i &lt; maxRight) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 2 * pos - i 表示，i 关于 pos 对称的点</span></span><br><span class=\"line\">                dp[i] = Math.min(dp[<span class=\"number\">2</span> * pos - i], maxRight - i + <span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 默认值为 1</span></span><br><span class=\"line\">                dp[i] = <span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span> (i + dp[i] &lt; s.length() &amp;&amp; i - dp[i] &gt;= <span class=\"number\">0</span> &amp;&amp; s.charAt(i + dp[i]) == s.charAt(i - dp[i])) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 中点扩散</span></span><br><span class=\"line\">                dp[i] += <span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i + dp[i] - <span class=\"number\">1</span> &gt; maxRight) &#123;</span><br><span class=\"line\">                maxRight = i + dp[i] - <span class=\"number\">1</span>;</span><br><span class=\"line\">                pos = i;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            maxLen = Math.max(maxLen, dp[i]);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (maxLen == dp[i]) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (builder.length() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    builder.delete(<span class=\"number\">0</span>, builder.length());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                builder.append(s, i - dp[i] + <span class=\"number\">1</span>, i + dp[i]);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> builder.toString().replace(<span class=\"string\">&quot;#&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>空间复杂度</th>\n<th>时间复杂度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>O($$N$$)</td>\n<td>O($$N$$)</td>\n</tr>\n</tbody></table>\n</li>\n</ul>\n"},{"title":"Looper中的死循环","date":"2019-04-24T23:35:09.000Z","_content":"\nHandler 应该是每个 Android 开发同学都非常熟悉的组件了，和大部分的 GUI 程序类似，Android 上的 UI 绘制只允许在单个线程上进行。这也是 Google 提供了 Handler 的原因之一，为了方便在其他线程使用 Handler 来通知 UI 线程更新。关于 Handler 的使用和源码解析不是本文的主题，网上已经有很多不错的文章了。本文的主题是探讨下 Looper 类中的 `loop()` 方法。\n\n我们知道，`loop()` 实质上是在一个无限的 `for` 循环中，从 `MessageQueue` 中不断地取出消息，再交由对应的 `Handler` 进行分发。这里实际上就涉及到了三个问题：\n\n1. 为什么要是死循环？\n2. 既然是死循环，那为什么不会阻塞应用？\n3. 这种死循环，会不会非常消耗资源？\n\n在写这篇文章之前，我也从网上看到很多答案，大致上是说，Handler 基于 Epoll 模型实现，只有在有新消息进来时，才会重新唤醒等待的线程，这里指 UI 线程。当时并没有去深究这些答案，觉得好像说的挺对的。实际上，这些答案确实是对的，但并没有回答完整，只回答了上面的第三个问题。\n\n当我在 Java 程序上，仿照 Handler 实现了一个简易版本的 Handler，这是我实现的 `loop()`：\n\n```java\npublic static void loop() {                                              \n    if (sThreadLocal.get() == null) {                                    \n        throw new IllegalStateException(\"must call prepare() before\");   \n    }                                                                    \n    final Looper curLooper = sThreadLocal.get();                         \n    while (true) {                                                       \n        Message message = curLooper.messageQueue.next();                 \n        if (message == null) {                                           \n            // error                                                     \n            System.out.println(\"message is null\");                       \n            return;                                                      \n        }                                                                \n        message.target.dispatchMessage(message);                         \n    }                                                                    \n}                                                                        \n```\n\n大家不用去深究每个方法的具体实现，从命名理解即可，和 Android 版的 Handler 一样，在一个死循环中，不断从 MessageQueue 中取出消息。但当我使用以下代码执行时，却发现完全按预期那样打印，\n\n```java\npublic static void main(String[] args) {\n        ExecutorService service = Executors.newFixedThreadPool(10);\n        Looper.prepare();\n        Looper.loop();\n        Handler handler = new Handler() {\n            @Override\n            protected void handleMessage(Message msg) {\n                System.out.println(Thread.currentThread().getName() + \": handle \" + msg.getData());\n            }\n        };\n        service.execute(() -> handler.sendMessage(new Message(\"Hello World\")));\n}\n```\n\n`loop()` 方法阻塞了当前线程，无法执行后面的代码。也就是说，Android Handler 应该也是这样的效果的。有疑惑的同学可以尝试以下代码，可以发现 \"After\" 不会被打印的。\n\n```kotlin\nval thread = Thread(Runnable {      \n    println(\"Before\")               \n    Looper.prepare()                \n    Looper.loop()                   \n    println(\"After\")                \n})                                  \nthread.start()                      \n```\n\n为了一探究竟，我们看下执行主线程的 `Looper.loop()` 方法执行，它位于 `ActivityThread.main()` 方法中，和普通的 Java 程序一样，Android 的入口也是 `main()` 方法，执行该方法的线程就是我们说的主线程，即 UI 线程。\n\n```java\n                                                                                                                                  \nLooper.prepareMainLooper();                                                          \n                                                                                                                                                                 \nActivityThread thread = new ActivityThread();                                        \nthread.attach(false, startSeq);                                                      \n                                                                                     \nif (sMainThreadHandler == null) {                                                    \n    sMainThreadHandler = thread.getHandler();                                        \n}                                                                                    \n                                                                                                                                                                                                                                                        \n                                    \nLooper.loop();                                                                       \n                                                                                     \nthrow new RuntimeException(\"Main thread loop unexpectedly exited\");                  \n```\n\n这段代码位于 `main()` 方法的最后，注意最后一句 `throw new RuntimeException(\"Main thread loop unexpectedly exited\");` 也就是说，`Looper.loop()` 之后一般情况下并不会执行到那里。\n\n接下来，就可以来回答第一个问题了，为什么是死循环？我们知道应用在执行完任务后就会退出，但 Android 应用开始运行后，即使没任务也应该保持执行，所以使用死循环来使得应用不结束。\n\n第二个问题，为什么不会阻塞应用。其实是会的，更确切地说，是阻塞了主线程。但 Android 的 UI 事件都是通过 Handler 来调度的，比如启动 Activity，Activity 的生命周期调用等等，这一块有兴趣的同学，可以去看下 Activity 的启动流程，具体可以看看 `ActivityThread.H` 这个类。\n\n### 总结\n\n总结下上面我们讨论的，`Looper.loop()` 方法开始执行后，会阻塞了当前执行的线程，主线程也是这样，这样做的原因之一是，保持当前应用执行不退出。 ","source":"_posts/Looper中的死循环.md","raw":"---\ntitle: Looper中的死循环\ndate: 2019-04-25 07:35:09\ncategories: Android\ntags:\n---\n\nHandler 应该是每个 Android 开发同学都非常熟悉的组件了，和大部分的 GUI 程序类似，Android 上的 UI 绘制只允许在单个线程上进行。这也是 Google 提供了 Handler 的原因之一，为了方便在其他线程使用 Handler 来通知 UI 线程更新。关于 Handler 的使用和源码解析不是本文的主题，网上已经有很多不错的文章了。本文的主题是探讨下 Looper 类中的 `loop()` 方法。\n\n我们知道，`loop()` 实质上是在一个无限的 `for` 循环中，从 `MessageQueue` 中不断地取出消息，再交由对应的 `Handler` 进行分发。这里实际上就涉及到了三个问题：\n\n1. 为什么要是死循环？\n2. 既然是死循环，那为什么不会阻塞应用？\n3. 这种死循环，会不会非常消耗资源？\n\n在写这篇文章之前，我也从网上看到很多答案，大致上是说，Handler 基于 Epoll 模型实现，只有在有新消息进来时，才会重新唤醒等待的线程，这里指 UI 线程。当时并没有去深究这些答案，觉得好像说的挺对的。实际上，这些答案确实是对的，但并没有回答完整，只回答了上面的第三个问题。\n\n当我在 Java 程序上，仿照 Handler 实现了一个简易版本的 Handler，这是我实现的 `loop()`：\n\n```java\npublic static void loop() {                                              \n    if (sThreadLocal.get() == null) {                                    \n        throw new IllegalStateException(\"must call prepare() before\");   \n    }                                                                    \n    final Looper curLooper = sThreadLocal.get();                         \n    while (true) {                                                       \n        Message message = curLooper.messageQueue.next();                 \n        if (message == null) {                                           \n            // error                                                     \n            System.out.println(\"message is null\");                       \n            return;                                                      \n        }                                                                \n        message.target.dispatchMessage(message);                         \n    }                                                                    \n}                                                                        \n```\n\n大家不用去深究每个方法的具体实现，从命名理解即可，和 Android 版的 Handler 一样，在一个死循环中，不断从 MessageQueue 中取出消息。但当我使用以下代码执行时，却发现完全按预期那样打印，\n\n```java\npublic static void main(String[] args) {\n        ExecutorService service = Executors.newFixedThreadPool(10);\n        Looper.prepare();\n        Looper.loop();\n        Handler handler = new Handler() {\n            @Override\n            protected void handleMessage(Message msg) {\n                System.out.println(Thread.currentThread().getName() + \": handle \" + msg.getData());\n            }\n        };\n        service.execute(() -> handler.sendMessage(new Message(\"Hello World\")));\n}\n```\n\n`loop()` 方法阻塞了当前线程，无法执行后面的代码。也就是说，Android Handler 应该也是这样的效果的。有疑惑的同学可以尝试以下代码，可以发现 \"After\" 不会被打印的。\n\n```kotlin\nval thread = Thread(Runnable {      \n    println(\"Before\")               \n    Looper.prepare()                \n    Looper.loop()                   \n    println(\"After\")                \n})                                  \nthread.start()                      \n```\n\n为了一探究竟，我们看下执行主线程的 `Looper.loop()` 方法执行，它位于 `ActivityThread.main()` 方法中，和普通的 Java 程序一样，Android 的入口也是 `main()` 方法，执行该方法的线程就是我们说的主线程，即 UI 线程。\n\n```java\n                                                                                                                                  \nLooper.prepareMainLooper();                                                          \n                                                                                                                                                                 \nActivityThread thread = new ActivityThread();                                        \nthread.attach(false, startSeq);                                                      \n                                                                                     \nif (sMainThreadHandler == null) {                                                    \n    sMainThreadHandler = thread.getHandler();                                        \n}                                                                                    \n                                                                                                                                                                                                                                                        \n                                    \nLooper.loop();                                                                       \n                                                                                     \nthrow new RuntimeException(\"Main thread loop unexpectedly exited\");                  \n```\n\n这段代码位于 `main()` 方法的最后，注意最后一句 `throw new RuntimeException(\"Main thread loop unexpectedly exited\");` 也就是说，`Looper.loop()` 之后一般情况下并不会执行到那里。\n\n接下来，就可以来回答第一个问题了，为什么是死循环？我们知道应用在执行完任务后就会退出，但 Android 应用开始运行后，即使没任务也应该保持执行，所以使用死循环来使得应用不结束。\n\n第二个问题，为什么不会阻塞应用。其实是会的，更确切地说，是阻塞了主线程。但 Android 的 UI 事件都是通过 Handler 来调度的，比如启动 Activity，Activity 的生命周期调用等等，这一块有兴趣的同学，可以去看下 Activity 的启动流程，具体可以看看 `ActivityThread.H` 这个类。\n\n### 总结\n\n总结下上面我们讨论的，`Looper.loop()` 方法开始执行后，会阻塞了当前执行的线程，主线程也是这样，这样做的原因之一是，保持当前应用执行不退出。 ","slug":"Looper中的死循环","published":1,"updated":"2022-06-15T11:19:32.322Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrle000bfho667klhlun","content":"<p>Handler 应该是每个 Android 开发同学都非常熟悉的组件了，和大部分的 GUI 程序类似，Android 上的 UI 绘制只允许在单个线程上进行。这也是 Google 提供了 Handler 的原因之一，为了方便在其他线程使用 Handler 来通知 UI 线程更新。关于 Handler 的使用和源码解析不是本文的主题，网上已经有很多不错的文章了。本文的主题是探讨下 Looper 类中的 <code>loop()</code> 方法。</p>\n<p>我们知道，<code>loop()</code> 实质上是在一个无限的 <code>for</code> 循环中，从 <code>MessageQueue</code> 中不断地取出消息，再交由对应的 <code>Handler</code> 进行分发。这里实际上就涉及到了三个问题：</p>\n<ol>\n<li>为什么要是死循环？</li>\n<li>既然是死循环，那为什么不会阻塞应用？</li>\n<li>这种死循环，会不会非常消耗资源？</li>\n</ol>\n<p>在写这篇文章之前，我也从网上看到很多答案，大致上是说，Handler 基于 Epoll 模型实现，只有在有新消息进来时，才会重新唤醒等待的线程，这里指 UI 线程。当时并没有去深究这些答案，觉得好像说的挺对的。实际上，这些答案确实是对的，但并没有回答完整，只回答了上面的第三个问题。</p>\n<p>当我在 Java 程序上，仿照 Handler 实现了一个简易版本的 Handler，这是我实现的 <code>loop()</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">loop</span><span class=\"params\">()</span> &#123;                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (sThreadLocal.get() == <span class=\"literal\">null</span>) &#123;                                    </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(<span class=\"string\">&quot;must call prepare() before&quot;</span>);   </span><br><span class=\"line\">    &#125;                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">Looper</span> <span class=\"variable\">curLooper</span> <span class=\"operator\">=</span> sThreadLocal.get();                         </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;                                                       </span><br><span class=\"line\">        <span class=\"type\">Message</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> curLooper.messageQueue.next();                 </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (message == <span class=\"literal\">null</span>) &#123;                                           </span><br><span class=\"line\">            <span class=\"comment\">// error                                                     </span></span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;message is null&quot;</span>);                       </span><br><span class=\"line\">            <span class=\"keyword\">return</span>;                                                      </span><br><span class=\"line\">        &#125;                                                                </span><br><span class=\"line\">        message.target.dispatchMessage(message);                         </span><br><span class=\"line\">    &#125;                                                                    </span><br><span class=\"line\">&#125;                                                                        </span><br></pre></td></tr></table></figure>\n\n<p>大家不用去深究每个方法的具体实现，从命名理解即可，和 Android 版的 Handler 一样，在一个死循环中，不断从 MessageQueue 中取出消息。但当我使用以下代码执行时，却发现完全按预期那样打印，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">ExecutorService</span> <span class=\"variable\">service</span> <span class=\"operator\">=</span> Executors.newFixedThreadPool(<span class=\"number\">10</span>);</span><br><span class=\"line\">        Looper.prepare();</span><br><span class=\"line\">        Looper.loop();</span><br><span class=\"line\">        <span class=\"type\">Handler</span> <span class=\"variable\">handler</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Handler</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handleMessage</span><span class=\"params\">(Message msg)</span> &#123;</span><br><span class=\"line\">                System.out.println(Thread.currentThread().getName() + <span class=\"string\">&quot;: handle &quot;</span> + msg.getData());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        service.execute(() -&gt; handler.sendMessage(<span class=\"keyword\">new</span> <span class=\"title class_\">Message</span>(<span class=\"string\">&quot;Hello World&quot;</span>)));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>loop()</code> 方法阻塞了当前线程，无法执行后面的代码。也就是说，Android Handler 应该也是这样的效果的。有疑惑的同学可以尝试以下代码，可以发现 “After” 不会被打印的。</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">val</span> thread = Thread(Runnable &#123;      </span><br><span class=\"line\">    println(<span class=\"string\">&quot;Before&quot;</span>)               </span><br><span class=\"line\">    Looper.prepare()                </span><br><span class=\"line\">    Looper.loop()                   </span><br><span class=\"line\">    println(<span class=\"string\">&quot;After&quot;</span>)                </span><br><span class=\"line\">&#125;)                                  </span><br><span class=\"line\">thread.start()                      </span><br></pre></td></tr></table></figure>\n\n<p>为了一探究竟，我们看下执行主线程的 <code>Looper.loop()</code> 方法执行，它位于 <code>ActivityThread.main()</code> 方法中，和普通的 Java 程序一样，Android 的入口也是 <code>main()</code> 方法，执行该方法的线程就是我们说的主线程，即 UI 线程。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                                                                                                                                  </span><br><span class=\"line\">Looper.prepareMainLooper();                                                          </span><br><span class=\"line\">                                                                                                                                                                 </span><br><span class=\"line\"><span class=\"type\">ActivityThread</span> <span class=\"variable\">thread</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ActivityThread</span>();                                        </span><br><span class=\"line\">thread.attach(<span class=\"literal\">false</span>, startSeq);                                                      </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\"><span class=\"keyword\">if</span> (sMainThreadHandler == <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">    sMainThreadHandler = thread.getHandler();                                        </span><br><span class=\"line\">&#125;                                                                                    </span><br><span class=\"line\">                                                                                                                                                                                                                                                        </span><br><span class=\"line\">                                    </span><br><span class=\"line\">Looper.loop();                                                                       </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Main thread loop unexpectedly exited&quot;</span>);                  </span><br></pre></td></tr></table></figure>\n\n<p>这段代码位于 <code>main()</code> 方法的最后，注意最后一句 <code>throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</code> 也就是说，<code>Looper.loop()</code> 之后一般情况下并不会执行到那里。</p>\n<p>接下来，就可以来回答第一个问题了，为什么是死循环？我们知道应用在执行完任务后就会退出，但 Android 应用开始运行后，即使没任务也应该保持执行，所以使用死循环来使得应用不结束。</p>\n<p>第二个问题，为什么不会阻塞应用。其实是会的，更确切地说，是阻塞了主线程。但 Android 的 UI 事件都是通过 Handler 来调度的，比如启动 Activity，Activity 的生命周期调用等等，这一块有兴趣的同学，可以去看下 Activity 的启动流程，具体可以看看 <code>ActivityThread.H</code> 这个类。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>总结下上面我们讨论的，<code>Looper.loop()</code> 方法开始执行后，会阻塞了当前执行的线程，主线程也是这样，这样做的原因之一是，保持当前应用执行不退出。 </p>\n","site":{"data":{}},"excerpt":"","more":"<p>Handler 应该是每个 Android 开发同学都非常熟悉的组件了，和大部分的 GUI 程序类似，Android 上的 UI 绘制只允许在单个线程上进行。这也是 Google 提供了 Handler 的原因之一，为了方便在其他线程使用 Handler 来通知 UI 线程更新。关于 Handler 的使用和源码解析不是本文的主题，网上已经有很多不错的文章了。本文的主题是探讨下 Looper 类中的 <code>loop()</code> 方法。</p>\n<p>我们知道，<code>loop()</code> 实质上是在一个无限的 <code>for</code> 循环中，从 <code>MessageQueue</code> 中不断地取出消息，再交由对应的 <code>Handler</code> 进行分发。这里实际上就涉及到了三个问题：</p>\n<ol>\n<li>为什么要是死循环？</li>\n<li>既然是死循环，那为什么不会阻塞应用？</li>\n<li>这种死循环，会不会非常消耗资源？</li>\n</ol>\n<p>在写这篇文章之前，我也从网上看到很多答案，大致上是说，Handler 基于 Epoll 模型实现，只有在有新消息进来时，才会重新唤醒等待的线程，这里指 UI 线程。当时并没有去深究这些答案，觉得好像说的挺对的。实际上，这些答案确实是对的，但并没有回答完整，只回答了上面的第三个问题。</p>\n<p>当我在 Java 程序上，仿照 Handler 实现了一个简易版本的 Handler，这是我实现的 <code>loop()</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">loop</span><span class=\"params\">()</span> &#123;                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (sThreadLocal.get() == <span class=\"literal\">null</span>) &#123;                                    </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(<span class=\"string\">&quot;must call prepare() before&quot;</span>);   </span><br><span class=\"line\">    &#125;                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">Looper</span> <span class=\"variable\">curLooper</span> <span class=\"operator\">=</span> sThreadLocal.get();                         </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;                                                       </span><br><span class=\"line\">        <span class=\"type\">Message</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> curLooper.messageQueue.next();                 </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (message == <span class=\"literal\">null</span>) &#123;                                           </span><br><span class=\"line\">            <span class=\"comment\">// error                                                     </span></span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;message is null&quot;</span>);                       </span><br><span class=\"line\">            <span class=\"keyword\">return</span>;                                                      </span><br><span class=\"line\">        &#125;                                                                </span><br><span class=\"line\">        message.target.dispatchMessage(message);                         </span><br><span class=\"line\">    &#125;                                                                    </span><br><span class=\"line\">&#125;                                                                        </span><br></pre></td></tr></table></figure>\n\n<p>大家不用去深究每个方法的具体实现，从命名理解即可，和 Android 版的 Handler 一样，在一个死循环中，不断从 MessageQueue 中取出消息。但当我使用以下代码执行时，却发现完全按预期那样打印，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">ExecutorService</span> <span class=\"variable\">service</span> <span class=\"operator\">=</span> Executors.newFixedThreadPool(<span class=\"number\">10</span>);</span><br><span class=\"line\">        Looper.prepare();</span><br><span class=\"line\">        Looper.loop();</span><br><span class=\"line\">        <span class=\"type\">Handler</span> <span class=\"variable\">handler</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Handler</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handleMessage</span><span class=\"params\">(Message msg)</span> &#123;</span><br><span class=\"line\">                System.out.println(Thread.currentThread().getName() + <span class=\"string\">&quot;: handle &quot;</span> + msg.getData());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        service.execute(() -&gt; handler.sendMessage(<span class=\"keyword\">new</span> <span class=\"title class_\">Message</span>(<span class=\"string\">&quot;Hello World&quot;</span>)));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>loop()</code> 方法阻塞了当前线程，无法执行后面的代码。也就是说，Android Handler 应该也是这样的效果的。有疑惑的同学可以尝试以下代码，可以发现 “After” 不会被打印的。</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">val</span> thread = Thread(Runnable &#123;      </span><br><span class=\"line\">    println(<span class=\"string\">&quot;Before&quot;</span>)               </span><br><span class=\"line\">    Looper.prepare()                </span><br><span class=\"line\">    Looper.loop()                   </span><br><span class=\"line\">    println(<span class=\"string\">&quot;After&quot;</span>)                </span><br><span class=\"line\">&#125;)                                  </span><br><span class=\"line\">thread.start()                      </span><br></pre></td></tr></table></figure>\n\n<p>为了一探究竟，我们看下执行主线程的 <code>Looper.loop()</code> 方法执行，它位于 <code>ActivityThread.main()</code> 方法中，和普通的 Java 程序一样，Android 的入口也是 <code>main()</code> 方法，执行该方法的线程就是我们说的主线程，即 UI 线程。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                                                                                                                                  </span><br><span class=\"line\">Looper.prepareMainLooper();                                                          </span><br><span class=\"line\">                                                                                                                                                                 </span><br><span class=\"line\"><span class=\"type\">ActivityThread</span> <span class=\"variable\">thread</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ActivityThread</span>();                                        </span><br><span class=\"line\">thread.attach(<span class=\"literal\">false</span>, startSeq);                                                      </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\"><span class=\"keyword\">if</span> (sMainThreadHandler == <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">    sMainThreadHandler = thread.getHandler();                                        </span><br><span class=\"line\">&#125;                                                                                    </span><br><span class=\"line\">                                                                                                                                                                                                                                                        </span><br><span class=\"line\">                                    </span><br><span class=\"line\">Looper.loop();                                                                       </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Main thread loop unexpectedly exited&quot;</span>);                  </span><br></pre></td></tr></table></figure>\n\n<p>这段代码位于 <code>main()</code> 方法的最后，注意最后一句 <code>throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</code> 也就是说，<code>Looper.loop()</code> 之后一般情况下并不会执行到那里。</p>\n<p>接下来，就可以来回答第一个问题了，为什么是死循环？我们知道应用在执行完任务后就会退出，但 Android 应用开始运行后，即使没任务也应该保持执行，所以使用死循环来使得应用不结束。</p>\n<p>第二个问题，为什么不会阻塞应用。其实是会的，更确切地说，是阻塞了主线程。但 Android 的 UI 事件都是通过 Handler 来调度的，比如启动 Activity，Activity 的生命周期调用等等，这一块有兴趣的同学，可以去看下 Activity 的启动流程，具体可以看看 <code>ActivityThread.H</code> 这个类。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>总结下上面我们讨论的，<code>Looper.loop()</code> 方法开始执行后，会阻塞了当前执行的线程，主线程也是这样，这样做的原因之一是，保持当前应用执行不退出。 </p>\n"},{"title":"scoped_model源码解析","date":"2019-05-06T14:13:54.000Z","_content":"\n### 参考\n\n* [ephemeral-vs-app](https://flutter.dev/docs/development/data-and-backend/state-mgmt/ephemeral-vs-app)\n* [inheritedwidget-inheritedmodel]([http://juju.one/inheritedwidget-inheritedmodel/](http://juju.one/inheritedwidget-inheritedmodel/)\n\n\n\n[scoped_model](https://pub.dartlang.org/packages/scoped_model) 是 Google 推荐使用的应用状态管理库（Simple app state management），当然，除了它，还有其他选择，比如 Redux，Rx，hooks 等等。\n\n### 临时状态和应用状态\n\n我们说 scoped_model 用于**应用状态**管理，是因为除了**应用状态（app state）**以外，还有临时状态（ephemeral state）。\n\n#### 临时状态\n\n也可以称为 UI 状态或者本地状态，是一种可以包含在单个 widget 的状态。\n\n比如以下定义：\n\n* `PageView` 当前的页面\n* 动画当前的进度\n* `BottomNavigationBar` 当前选中项\n\n使用临时状态，我们不需要使用状态管理，只需要一个 `StatefulWidget`。\n\n#### 应用状态\n\n需要在应用中多个组件之间共享，而且在不同的用户会话之间保持，这就是应用状态，有时候也称为共享状态。\n\n比如以下定义：\n\n* 用户偏好设置\n* 登录信息\n* 通知栏功能\n* 购物车功能\n* 已读未读功能\n\n\n\n临时状态和应用状态之间没有非常明确的界限，比如你可能需要持久化保存 `BottomNavigationBar` 的选中项，那它就不是临时状态了，而是应用状态。如果你愿意，你甚至可以不用任何状态管理库，只使用 `State` 和 `setState()` 来管理应用所有的状态。\n\n### scoped_model\n\nscoped_model 由三个部分组成，`ScopedModel`、`ScopedModelDescendant` 和 `Model`。\n\n#### Model\n\n`Model` 是定义一个数据模型的基类，它继承了 `Listenable`，提供了 `notifyListeners()` 方法来通知组件需要更新。\n\n``` dart\n@protected                                                                  \nvoid notifyListeners() {                                                    \n  // We schedule a microtask to debounce multiple changes that can occur    \n  // all at once.                     \n  if (_microtaskVersion == _version) {\n    // 去抖\n    _microtaskVersion++; \n    // 安排一个 Microtask 任务\n    scheduleMicrotask(() {                                                  \n      _version++;                                                           \n      _microtaskVersion = _version;                                         \n                                                                            \n      // Convert the Set to a List before executing each listener. This     \n      // prevents errors that can arise if a listener removes itself during \n      // invocation!                                                        \n      _listeners.toList().forEach((VoidCallback listener) => listener());   \n    });                                                                     \n  }                                                                         \n}                                                                           \n```\n\n> 关于 Microtask：这涉及到 dart 的单线程模型，这里我们只需要知道，它的优先级比 event 要高，会先执行。\n>\n> 关于更多信息，可以查看 [event-loop](https://webdev.dartlang.org/articles/performance/event-loop#darts-event-loop-and-queues)\n\n#### ScopedModel\n\n在定义一个 `Model` 后，我们需要再定义一个 `ScopedModel` 作为 root widget，它有两个参数，一个是 `model` 即我们上面定义的 `Model` 实例，另外一个是 `child`，则是我们定义的 widget。`ScopedModel` 是一个 `StetelessWidget`，我们看下它的 `build()` 方法：\n\n``` dart\n@override                                                                     \nWidget build(BuildContext context) {                                          \n  return AnimatedBuilder(                                                     \n    animation: model,                                                         \n    builder: (context, _) => _InheritedModel<T>(model: model, child: child),  \n  );                                                                          \n}                                                                             \n```\n\n`AnimatedBuilder` 是一个用于构建动画的 widget，它的 `animation` 参数是一个 `Listenable` 类：\n\n``` dart\nabstract class Listenable {                                                          \n  /// Abstract const constructor. This constructor enables subclasses to provide     \n  /// const constructors so that they can be used in const expressions.              \n  const Listenable();                                                                \n                                                                                     \n  /// Return a [Listenable] that triggers when any of the given [Listenable]s        \n  /// themselves trigger.                                                            \n  ///                                                                                \n  /// The list must not be changed after this method has been called. Doing so       \n  /// will lead to memory leaks or exceptions.                                       \n  ///                                                                                \n  /// The list may contain nulls; they are ignored.                                  \n  factory Listenable.merge(List<Listenable> listenables) = _MergingListenable;       \n                                                                                     \n  /// Register a closure to be called when the object notifies its listeners.        \n  void addListener(VoidCallback listener);                                           \n                                                                                     \n  /// Remove a previously registered closure from the list of closures that the      \n  /// object notifies.                                                               \n  void removeListener(VoidCallback listener);                                        \n}                                                                                    \n```\n\n`AnimatedBuilder` 会调用 `addListener()` 方法添加一个监听者，然后调用 `setState()` 方法进行 rebuild。从上面可知，`Model` 继承 `Listenable` 类。这也是为什么在修改值后需要调用 `notifyListeners()` 的原因。\n\n再看下 `builder` 参数，它实际上返回了一个 `_InheritedModel` 实例：\n\n``` dart\nclass _InheritedModel<T extends Model> extends InheritedWidget {     \n  final T model;                                                     \n  final int version;                                                 \n                                                                     \n  _InheritedModel({Key key, Widget child, T model})                  \n      : this.model = model,                                          \n        this.version = model._version,                               \n        super(key: key, child: child);                               \n                                                                     \n  @override                                                          \n  bool updateShouldNotify(_InheritedModel<T> oldWidget) =>           \n      (oldWidget.version != version);                                \n}                                                                    \n```\n\n`InheritedWidget` 是 `scoped_model` 的核心。\n\n##### InheritedWidget\n\n`InheritedWidget` 可以在组件树中有效的传递和共享数据。将 `InheritedWidget` 作为 root widget，child widget 可以通过 `inheritFromWidgetOfExactType()` 方法返回距离它最近的 `InheritedWidget` 实例，同时也将它注册到 `InheritedWidget` 中，当 `InheritedWidget` 的数据发生变化时，child widget 也会随之 rebuild。\n\n当 `InheritedWidget` rebuild 时，会调用 `updateShouldNotify()` 方法来决定是否重建 child widget。\n\n继续看 `ScopedModel`，它使用 `version` 来判断是否需要通知 child widget 更新：\n\n``` dart\n@override                                                          \nbool updateShouldNotify(_InheritedModel<T> oldWidget) =>           \n      (oldWidget.version != version); \n```\n\n当我们调用 `Model` 的 `notifyListeners()` 方法时，`version` 就会自增。\n\n#### ScopedModelDescendant\n\n`ScopedModelDescendant` 是一个工具类，用于获取指定类型的 `Model`，当 `Model` 更新时，会重新执行 `build()` 方法：\n\n``` dart\n@override                                                            \nWidget build(BuildContext context) {                                 \n  return builder(                                                    \n    context,                                                         \n    child,                                                           \n    ScopedModel.of<T>(context, rebuildOnChange: rebuildOnChange),    \n  );                                                                 \n}\n\n\nstatic T of<T extends Model>(                       \n  BuildContext context, {                           \n  bool rebuildOnChange = false,                     \n}) {                                                \n  final Type type = _type<_InheritedModel<T>>();    \n  \n  // 最终也是使用 inheritFromWidgetOfExactType 或 ancestorWidgetOfExactType\n  Widget widget = rebuildOnChange                   \n      ? context.inheritFromWidgetOfExactType(type)  \n      : context.ancestorWidgetOfExactType(type);    \n                                                    \n  if (widget == null) {                             \n    throw new ScopedModelError();                   \n  } else {                                          \n    return (widget as _InheritedModel<T>).model;    \n  }                                                 \n}                                                   \n                                                    \nstatic Type _type<T>() => T;                        \n```\n\n注意到，在调用 `ScopedModel.of()` 方法时，有个 `rebuildOnChange` 参数，表示当 `Model` 更新时，是否需要 rebuild。当设置为 `false` 时，会使用 `ancestorWidgetOfExactType()` 方法去获取最近的 `InheritedWidget`，和 `inheritFromWidgetOfExactType()` 方法的区别是，`inheritFromWidgetOfExactType` 在获取的同时会注册到 `InheritedWidget` 上。\n\n### 总结\n\n使用 `scoped_model`，我们首先定义一个 `Model`，这里面封装了对数据的操作，需要注意，数据改变后需要调用 `notifyListeners()` 方法。接着再将 `ScopedModel` 作为 root widget，传递一个 `Model` 实例，最后我们可以使用 `ScopedModelDescendant` 来响应数据的修改，也可以手动调用 `ScopedModel.of()` 方法来获取 `Model` 实例，调用这个方法，如果参数 `rebuildOnChange` 传递为 `true`，则同时会将当前 widget 注册到 `InheritedWidget` 上，当数据改变时，当前 widget 会重新构建。","source":"_posts/scoped-model源码解析.md","raw":"---\ntitle: scoped_model源码解析\ndate: 2019-05-06 22:13:54\ncategories: Flutter\ntags:\n---\n\n### 参考\n\n* [ephemeral-vs-app](https://flutter.dev/docs/development/data-and-backend/state-mgmt/ephemeral-vs-app)\n* [inheritedwidget-inheritedmodel]([http://juju.one/inheritedwidget-inheritedmodel/](http://juju.one/inheritedwidget-inheritedmodel/)\n\n\n\n[scoped_model](https://pub.dartlang.org/packages/scoped_model) 是 Google 推荐使用的应用状态管理库（Simple app state management），当然，除了它，还有其他选择，比如 Redux，Rx，hooks 等等。\n\n### 临时状态和应用状态\n\n我们说 scoped_model 用于**应用状态**管理，是因为除了**应用状态（app state）**以外，还有临时状态（ephemeral state）。\n\n#### 临时状态\n\n也可以称为 UI 状态或者本地状态，是一种可以包含在单个 widget 的状态。\n\n比如以下定义：\n\n* `PageView` 当前的页面\n* 动画当前的进度\n* `BottomNavigationBar` 当前选中项\n\n使用临时状态，我们不需要使用状态管理，只需要一个 `StatefulWidget`。\n\n#### 应用状态\n\n需要在应用中多个组件之间共享，而且在不同的用户会话之间保持，这就是应用状态，有时候也称为共享状态。\n\n比如以下定义：\n\n* 用户偏好设置\n* 登录信息\n* 通知栏功能\n* 购物车功能\n* 已读未读功能\n\n\n\n临时状态和应用状态之间没有非常明确的界限，比如你可能需要持久化保存 `BottomNavigationBar` 的选中项，那它就不是临时状态了，而是应用状态。如果你愿意，你甚至可以不用任何状态管理库，只使用 `State` 和 `setState()` 来管理应用所有的状态。\n\n### scoped_model\n\nscoped_model 由三个部分组成，`ScopedModel`、`ScopedModelDescendant` 和 `Model`。\n\n#### Model\n\n`Model` 是定义一个数据模型的基类，它继承了 `Listenable`，提供了 `notifyListeners()` 方法来通知组件需要更新。\n\n``` dart\n@protected                                                                  \nvoid notifyListeners() {                                                    \n  // We schedule a microtask to debounce multiple changes that can occur    \n  // all at once.                     \n  if (_microtaskVersion == _version) {\n    // 去抖\n    _microtaskVersion++; \n    // 安排一个 Microtask 任务\n    scheduleMicrotask(() {                                                  \n      _version++;                                                           \n      _microtaskVersion = _version;                                         \n                                                                            \n      // Convert the Set to a List before executing each listener. This     \n      // prevents errors that can arise if a listener removes itself during \n      // invocation!                                                        \n      _listeners.toList().forEach((VoidCallback listener) => listener());   \n    });                                                                     \n  }                                                                         \n}                                                                           \n```\n\n> 关于 Microtask：这涉及到 dart 的单线程模型，这里我们只需要知道，它的优先级比 event 要高，会先执行。\n>\n> 关于更多信息，可以查看 [event-loop](https://webdev.dartlang.org/articles/performance/event-loop#darts-event-loop-and-queues)\n\n#### ScopedModel\n\n在定义一个 `Model` 后，我们需要再定义一个 `ScopedModel` 作为 root widget，它有两个参数，一个是 `model` 即我们上面定义的 `Model` 实例，另外一个是 `child`，则是我们定义的 widget。`ScopedModel` 是一个 `StetelessWidget`，我们看下它的 `build()` 方法：\n\n``` dart\n@override                                                                     \nWidget build(BuildContext context) {                                          \n  return AnimatedBuilder(                                                     \n    animation: model,                                                         \n    builder: (context, _) => _InheritedModel<T>(model: model, child: child),  \n  );                                                                          \n}                                                                             \n```\n\n`AnimatedBuilder` 是一个用于构建动画的 widget，它的 `animation` 参数是一个 `Listenable` 类：\n\n``` dart\nabstract class Listenable {                                                          \n  /// Abstract const constructor. This constructor enables subclasses to provide     \n  /// const constructors so that they can be used in const expressions.              \n  const Listenable();                                                                \n                                                                                     \n  /// Return a [Listenable] that triggers when any of the given [Listenable]s        \n  /// themselves trigger.                                                            \n  ///                                                                                \n  /// The list must not be changed after this method has been called. Doing so       \n  /// will lead to memory leaks or exceptions.                                       \n  ///                                                                                \n  /// The list may contain nulls; they are ignored.                                  \n  factory Listenable.merge(List<Listenable> listenables) = _MergingListenable;       \n                                                                                     \n  /// Register a closure to be called when the object notifies its listeners.        \n  void addListener(VoidCallback listener);                                           \n                                                                                     \n  /// Remove a previously registered closure from the list of closures that the      \n  /// object notifies.                                                               \n  void removeListener(VoidCallback listener);                                        \n}                                                                                    \n```\n\n`AnimatedBuilder` 会调用 `addListener()` 方法添加一个监听者，然后调用 `setState()` 方法进行 rebuild。从上面可知，`Model` 继承 `Listenable` 类。这也是为什么在修改值后需要调用 `notifyListeners()` 的原因。\n\n再看下 `builder` 参数，它实际上返回了一个 `_InheritedModel` 实例：\n\n``` dart\nclass _InheritedModel<T extends Model> extends InheritedWidget {     \n  final T model;                                                     \n  final int version;                                                 \n                                                                     \n  _InheritedModel({Key key, Widget child, T model})                  \n      : this.model = model,                                          \n        this.version = model._version,                               \n        super(key: key, child: child);                               \n                                                                     \n  @override                                                          \n  bool updateShouldNotify(_InheritedModel<T> oldWidget) =>           \n      (oldWidget.version != version);                                \n}                                                                    \n```\n\n`InheritedWidget` 是 `scoped_model` 的核心。\n\n##### InheritedWidget\n\n`InheritedWidget` 可以在组件树中有效的传递和共享数据。将 `InheritedWidget` 作为 root widget，child widget 可以通过 `inheritFromWidgetOfExactType()` 方法返回距离它最近的 `InheritedWidget` 实例，同时也将它注册到 `InheritedWidget` 中，当 `InheritedWidget` 的数据发生变化时，child widget 也会随之 rebuild。\n\n当 `InheritedWidget` rebuild 时，会调用 `updateShouldNotify()` 方法来决定是否重建 child widget。\n\n继续看 `ScopedModel`，它使用 `version` 来判断是否需要通知 child widget 更新：\n\n``` dart\n@override                                                          \nbool updateShouldNotify(_InheritedModel<T> oldWidget) =>           \n      (oldWidget.version != version); \n```\n\n当我们调用 `Model` 的 `notifyListeners()` 方法时，`version` 就会自增。\n\n#### ScopedModelDescendant\n\n`ScopedModelDescendant` 是一个工具类，用于获取指定类型的 `Model`，当 `Model` 更新时，会重新执行 `build()` 方法：\n\n``` dart\n@override                                                            \nWidget build(BuildContext context) {                                 \n  return builder(                                                    \n    context,                                                         \n    child,                                                           \n    ScopedModel.of<T>(context, rebuildOnChange: rebuildOnChange),    \n  );                                                                 \n}\n\n\nstatic T of<T extends Model>(                       \n  BuildContext context, {                           \n  bool rebuildOnChange = false,                     \n}) {                                                \n  final Type type = _type<_InheritedModel<T>>();    \n  \n  // 最终也是使用 inheritFromWidgetOfExactType 或 ancestorWidgetOfExactType\n  Widget widget = rebuildOnChange                   \n      ? context.inheritFromWidgetOfExactType(type)  \n      : context.ancestorWidgetOfExactType(type);    \n                                                    \n  if (widget == null) {                             \n    throw new ScopedModelError();                   \n  } else {                                          \n    return (widget as _InheritedModel<T>).model;    \n  }                                                 \n}                                                   \n                                                    \nstatic Type _type<T>() => T;                        \n```\n\n注意到，在调用 `ScopedModel.of()` 方法时，有个 `rebuildOnChange` 参数，表示当 `Model` 更新时，是否需要 rebuild。当设置为 `false` 时，会使用 `ancestorWidgetOfExactType()` 方法去获取最近的 `InheritedWidget`，和 `inheritFromWidgetOfExactType()` 方法的区别是，`inheritFromWidgetOfExactType` 在获取的同时会注册到 `InheritedWidget` 上。\n\n### 总结\n\n使用 `scoped_model`，我们首先定义一个 `Model`，这里面封装了对数据的操作，需要注意，数据改变后需要调用 `notifyListeners()` 方法。接着再将 `ScopedModel` 作为 root widget，传递一个 `Model` 实例，最后我们可以使用 `ScopedModelDescendant` 来响应数据的修改，也可以手动调用 `ScopedModel.of()` 方法来获取 `Model` 实例，调用这个方法，如果参数 `rebuildOnChange` 传递为 `true`，则同时会将当前 widget 注册到 `InheritedWidget` 上，当数据改变时，当前 widget 会重新构建。","slug":"scoped-model源码解析","published":1,"updated":"2022-06-15T11:19:32.323Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrle000cfho6045h8yzw","content":"<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><ul>\n<li><a href=\"https://flutter.dev/docs/development/data-and-backend/state-mgmt/ephemeral-vs-app\">ephemeral-vs-app</a></li>\n<li><a href=\"%5Bhttp://juju.one/inheritedwidget-inheritedmodel/%5D(http://juju.one/inheritedwidget-inheritedmodel/\">inheritedwidget-inheritedmodel</a></li>\n</ul>\n<p><a href=\"https://pub.dartlang.org/packages/scoped_model\">scoped_model</a> 是 Google 推荐使用的应用状态管理库（Simple app state management），当然，除了它，还有其他选择，比如 Redux，Rx，hooks 等等。</p>\n<h3 id=\"临时状态和应用状态\"><a href=\"#临时状态和应用状态\" class=\"headerlink\" title=\"临时状态和应用状态\"></a>临时状态和应用状态</h3><p>我们说 scoped_model 用于<strong>应用状态</strong>管理，是因为除了<strong>应用状态（app state）</strong>以外，还有临时状态（ephemeral state）。</p>\n<h4 id=\"临时状态\"><a href=\"#临时状态\" class=\"headerlink\" title=\"临时状态\"></a>临时状态</h4><p>也可以称为 UI 状态或者本地状态，是一种可以包含在单个 widget 的状态。</p>\n<p>比如以下定义：</p>\n<ul>\n<li><code>PageView</code> 当前的页面</li>\n<li>动画当前的进度</li>\n<li><code>BottomNavigationBar</code> 当前选中项</li>\n</ul>\n<p>使用临时状态，我们不需要使用状态管理，只需要一个 <code>StatefulWidget</code>。</p>\n<h4 id=\"应用状态\"><a href=\"#应用状态\" class=\"headerlink\" title=\"应用状态\"></a>应用状态</h4><p>需要在应用中多个组件之间共享，而且在不同的用户会话之间保持，这就是应用状态，有时候也称为共享状态。</p>\n<p>比如以下定义：</p>\n<ul>\n<li>用户偏好设置</li>\n<li>登录信息</li>\n<li>通知栏功能</li>\n<li>购物车功能</li>\n<li>已读未读功能</li>\n</ul>\n<p>临时状态和应用状态之间没有非常明确的界限，比如你可能需要持久化保存 <code>BottomNavigationBar</code> 的选中项，那它就不是临时状态了，而是应用状态。如果你愿意，你甚至可以不用任何状态管理库，只使用 <code>State</code> 和 <code>setState()</code> 来管理应用所有的状态。</p>\n<h3 id=\"scoped-model\"><a href=\"#scoped-model\" class=\"headerlink\" title=\"scoped_model\"></a>scoped_model</h3><p>scoped_model 由三个部分组成，<code>ScopedModel</code>、<code>ScopedModelDescendant</code> 和 <code>Model</code>。</p>\n<h4 id=\"Model\"><a href=\"#Model\" class=\"headerlink\" title=\"Model\"></a>Model</h4><p><code>Model</code> 是定义一个数据模型的基类，它继承了 <code>Listenable</code>，提供了 <code>notifyListeners()</code> 方法来通知组件需要更新。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@protected</span>                                                                  </span><br><span class=\"line\"><span class=\"keyword\">void</span> notifyListeners() &#123;                                                    </span><br><span class=\"line\">  <span class=\"comment\">// We schedule a microtask to debounce multiple changes that can occur    </span></span><br><span class=\"line\">  <span class=\"comment\">// all at once.                     </span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_microtaskVersion == _version) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 去抖</span></span><br><span class=\"line\">    _microtaskVersion++; </span><br><span class=\"line\">    <span class=\"comment\">// 安排一个 Microtask 任务</span></span><br><span class=\"line\">    scheduleMicrotask(() &#123;                                                  </span><br><span class=\"line\">      _version++;                                                           </span><br><span class=\"line\">      _microtaskVersion = _version;                                         </span><br><span class=\"line\">                                                                            </span><br><span class=\"line\">      <span class=\"comment\">// Convert the Set to a List before executing each listener. This     </span></span><br><span class=\"line\">      <span class=\"comment\">// prevents errors that can arise if a listener removes itself during </span></span><br><span class=\"line\">      <span class=\"comment\">// invocation!                                                        </span></span><br><span class=\"line\">      _listeners.toList().forEach((VoidCallback listener) =&gt; listener());   </span><br><span class=\"line\">    &#125;);                                                                     </span><br><span class=\"line\">  &#125;                                                                         </span><br><span class=\"line\">&#125;                                                                           </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>关于 Microtask：这涉及到 dart 的单线程模型，这里我们只需要知道，它的优先级比 event 要高，会先执行。</p>\n<p>关于更多信息，可以查看 <a href=\"https://webdev.dartlang.org/articles/performance/event-loop#darts-event-loop-and-queues\">event-loop</a></p>\n</blockquote>\n<h4 id=\"ScopedModel\"><a href=\"#ScopedModel\" class=\"headerlink\" title=\"ScopedModel\"></a>ScopedModel</h4><p>在定义一个 <code>Model</code> 后，我们需要再定义一个 <code>ScopedModel</code> 作为 root widget，它有两个参数，一个是 <code>model</code> 即我们上面定义的 <code>Model</code> 实例，另外一个是 <code>child</code>，则是我们定义的 widget。<code>ScopedModel</code> 是一个 <code>StetelessWidget</code>，我们看下它的 <code>build()</code> 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                                     </span><br><span class=\"line\">Widget build(BuildContext context) &#123;                                          </span><br><span class=\"line\">  <span class=\"keyword\">return</span> AnimatedBuilder(                                                     </span><br><span class=\"line\">    animation: model,                                                         </span><br><span class=\"line\">    builder: (context, _) =&gt; _InheritedModel&lt;T&gt;(model: model, child: child),  </span><br><span class=\"line\">  );                                                                          </span><br><span class=\"line\">&#125;                                                                             </span><br></pre></td></tr></table></figure>\n\n<p><code>AnimatedBuilder</code> 是一个用于构建动画的 widget，它的 <code>animation</code> 参数是一个 <code>Listenable</code> 类：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Listenable</span> </span>&#123;                                                          </span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\">Abstract const constructor. This constructor enables subclasses to provide     </span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\">const constructors so that they can be used in const expressions.              </span></span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> Listenable();                                                                </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\">Return a [Listenable] that triggers when any of the given [Listenable]s        </span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\">themselves trigger.                                                            </span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">                                                                               </span></span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">The list must not be changed after this method has been called. Doing so       </span></span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">will lead to memory leaks or exceptions.                                       </span></span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">                                                                               </span></span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">The list may contain nulls; they are ignored.                                  </span></span></span></span><br><span class=\"line\">  <span class=\"keyword\">factory</span> Listenable.merge(<span class=\"built_in\">List</span>&lt;Listenable&gt; listenables) = _MergingListenable;       </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">Register a closure to be called when the object notifies its listeners.        </span></span></span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> addListener(VoidCallback listener);                                           </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">Remove a previously registered closure from the list of closures that the      </span></span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">object notifies.                                                               </span></span></span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> removeListener(VoidCallback listener);                                        </span><br><span class=\"line\">&#125;                                                                                    </span><br></pre></td></tr></table></figure>\n\n<p><code>AnimatedBuilder</code> 会调用 <code>addListener()</code> 方法添加一个监听者，然后调用 <code>setState()</code> 方法进行 rebuild。从上面可知，<code>Model</code> 继承 <code>Listenable</code> 类。这也是为什么在修改值后需要调用 <code>notifyListeners()</code> 的原因。</p>\n<p>再看下 <code>builder</code> 参数，它实际上返回了一个 <code>_InheritedModel</code> 实例：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">_InheritedModel</span>&lt;<span class=\"title\">T</span> <span class=\"keyword\">extends</span> <span class=\"title\">Model</span>&gt; <span class=\"keyword\">extends</span> <span class=\"title\">InheritedWidget</span> </span>&#123;     </span><br><span class=\"line\">  <span class=\"keyword\">final</span> T model;                                                     </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> version;                                                 </span><br><span class=\"line\">                                                                     </span><br><span class=\"line\">  _InheritedModel(&#123;Key key, Widget child, T model&#125;)                  </span><br><span class=\"line\">      : <span class=\"keyword\">this</span>.model = model,                                          </span><br><span class=\"line\">        <span class=\"keyword\">this</span>.version = model._version,                               </span><br><span class=\"line\">        <span class=\"keyword\">super</span>(key: key, child: child);                               </span><br><span class=\"line\">                                                                     </span><br><span class=\"line\">  <span class=\"meta\">@override</span>                                                          </span><br><span class=\"line\">  <span class=\"built_in\">bool</span> updateShouldNotify(_InheritedModel&lt;T&gt; oldWidget) =&gt;           </span><br><span class=\"line\">      (oldWidget.version != version);                                </span><br><span class=\"line\">&#125;                                                                    </span><br></pre></td></tr></table></figure>\n\n<p><code>InheritedWidget</code> 是 <code>scoped_model</code> 的核心。</p>\n<h5 id=\"InheritedWidget\"><a href=\"#InheritedWidget\" class=\"headerlink\" title=\"InheritedWidget\"></a>InheritedWidget</h5><p><code>InheritedWidget</code> 可以在组件树中有效的传递和共享数据。将 <code>InheritedWidget</code> 作为 root widget，child widget 可以通过 <code>inheritFromWidgetOfExactType()</code> 方法返回距离它最近的 <code>InheritedWidget</code> 实例，同时也将它注册到 <code>InheritedWidget</code> 中，当 <code>InheritedWidget</code> 的数据发生变化时，child widget 也会随之 rebuild。</p>\n<p>当 <code>InheritedWidget</code> rebuild 时，会调用 <code>updateShouldNotify()</code> 方法来决定是否重建 child widget。</p>\n<p>继续看 <code>ScopedModel</code>，它使用 <code>version</code> 来判断是否需要通知 child widget 更新：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                          </span><br><span class=\"line\"><span class=\"built_in\">bool</span> updateShouldNotify(_InheritedModel&lt;T&gt; oldWidget) =&gt;           </span><br><span class=\"line\">      (oldWidget.version != version); </span><br></pre></td></tr></table></figure>\n\n<p>当我们调用 <code>Model</code> 的 <code>notifyListeners()</code> 方法时，<code>version</code> 就会自增。</p>\n<h4 id=\"ScopedModelDescendant\"><a href=\"#ScopedModelDescendant\" class=\"headerlink\" title=\"ScopedModelDescendant\"></a>ScopedModelDescendant</h4><p><code>ScopedModelDescendant</code> 是一个工具类，用于获取指定类型的 <code>Model</code>，当 <code>Model</code> 更新时，会重新执行 <code>build()</code> 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                            </span><br><span class=\"line\">Widget build(BuildContext context) &#123;                                 </span><br><span class=\"line\">  <span class=\"keyword\">return</span> builder(                                                    </span><br><span class=\"line\">    context,                                                         </span><br><span class=\"line\">    child,                                                           </span><br><span class=\"line\">    ScopedModel.of&lt;T&gt;(context, rebuildOnChange: rebuildOnChange),    </span><br><span class=\"line\">  );                                                                 </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> T of&lt;T <span class=\"keyword\">extends</span> Model&gt;(                       </span><br><span class=\"line\">  BuildContext context, &#123;                           </span><br><span class=\"line\">  <span class=\"built_in\">bool</span> rebuildOnChange = <span class=\"keyword\">false</span>,                     </span><br><span class=\"line\">&#125;) &#123;                                                </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">Type</span> type = _type&lt;_InheritedModel&lt;T&gt;&gt;();    </span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// 最终也是使用 inheritFromWidgetOfExactType 或 ancestorWidgetOfExactType</span></span><br><span class=\"line\">  Widget widget = rebuildOnChange                   </span><br><span class=\"line\">      ? context.inheritFromWidgetOfExactType(type)  </span><br><span class=\"line\">      : context.ancestorWidgetOfExactType(type);    </span><br><span class=\"line\">                                                    </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (widget == <span class=\"keyword\">null</span>) &#123;                             </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ScopedModelError();                   </span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;                                          </span><br><span class=\"line\">    <span class=\"keyword\">return</span> (widget <span class=\"keyword\">as</span> _InheritedModel&lt;T&gt;).model;    </span><br><span class=\"line\">  &#125;                                                 </span><br><span class=\"line\">&#125;                                                   </span><br><span class=\"line\">                                                    </span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"built_in\">Type</span> _type&lt;T&gt;() =&gt; T;                        </span><br></pre></td></tr></table></figure>\n\n<p>注意到，在调用 <code>ScopedModel.of()</code> 方法时，有个 <code>rebuildOnChange</code> 参数，表示当 <code>Model</code> 更新时，是否需要 rebuild。当设置为 <code>false</code> 时，会使用 <code>ancestorWidgetOfExactType()</code> 方法去获取最近的 <code>InheritedWidget</code>，和 <code>inheritFromWidgetOfExactType()</code> 方法的区别是，<code>inheritFromWidgetOfExactType</code> 在获取的同时会注册到 <code>InheritedWidget</code> 上。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>使用 <code>scoped_model</code>，我们首先定义一个 <code>Model</code>，这里面封装了对数据的操作，需要注意，数据改变后需要调用 <code>notifyListeners()</code> 方法。接着再将 <code>ScopedModel</code> 作为 root widget，传递一个 <code>Model</code> 实例，最后我们可以使用 <code>ScopedModelDescendant</code> 来响应数据的修改，也可以手动调用 <code>ScopedModel.of()</code> 方法来获取 <code>Model</code> 实例，调用这个方法，如果参数 <code>rebuildOnChange</code> 传递为 <code>true</code>，则同时会将当前 widget 注册到 <code>InheritedWidget</code> 上，当数据改变时，当前 widget 会重新构建。</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><ul>\n<li><a href=\"https://flutter.dev/docs/development/data-and-backend/state-mgmt/ephemeral-vs-app\">ephemeral-vs-app</a></li>\n<li><a href=\"%5Bhttp://juju.one/inheritedwidget-inheritedmodel/%5D(http://juju.one/inheritedwidget-inheritedmodel/\">inheritedwidget-inheritedmodel</a></li>\n</ul>\n<p><a href=\"https://pub.dartlang.org/packages/scoped_model\">scoped_model</a> 是 Google 推荐使用的应用状态管理库（Simple app state management），当然，除了它，还有其他选择，比如 Redux，Rx，hooks 等等。</p>\n<h3 id=\"临时状态和应用状态\"><a href=\"#临时状态和应用状态\" class=\"headerlink\" title=\"临时状态和应用状态\"></a>临时状态和应用状态</h3><p>我们说 scoped_model 用于<strong>应用状态</strong>管理，是因为除了<strong>应用状态（app state）</strong>以外，还有临时状态（ephemeral state）。</p>\n<h4 id=\"临时状态\"><a href=\"#临时状态\" class=\"headerlink\" title=\"临时状态\"></a>临时状态</h4><p>也可以称为 UI 状态或者本地状态，是一种可以包含在单个 widget 的状态。</p>\n<p>比如以下定义：</p>\n<ul>\n<li><code>PageView</code> 当前的页面</li>\n<li>动画当前的进度</li>\n<li><code>BottomNavigationBar</code> 当前选中项</li>\n</ul>\n<p>使用临时状态，我们不需要使用状态管理，只需要一个 <code>StatefulWidget</code>。</p>\n<h4 id=\"应用状态\"><a href=\"#应用状态\" class=\"headerlink\" title=\"应用状态\"></a>应用状态</h4><p>需要在应用中多个组件之间共享，而且在不同的用户会话之间保持，这就是应用状态，有时候也称为共享状态。</p>\n<p>比如以下定义：</p>\n<ul>\n<li>用户偏好设置</li>\n<li>登录信息</li>\n<li>通知栏功能</li>\n<li>购物车功能</li>\n<li>已读未读功能</li>\n</ul>\n<p>临时状态和应用状态之间没有非常明确的界限，比如你可能需要持久化保存 <code>BottomNavigationBar</code> 的选中项，那它就不是临时状态了，而是应用状态。如果你愿意，你甚至可以不用任何状态管理库，只使用 <code>State</code> 和 <code>setState()</code> 来管理应用所有的状态。</p>\n<h3 id=\"scoped-model\"><a href=\"#scoped-model\" class=\"headerlink\" title=\"scoped_model\"></a>scoped_model</h3><p>scoped_model 由三个部分组成，<code>ScopedModel</code>、<code>ScopedModelDescendant</code> 和 <code>Model</code>。</p>\n<h4 id=\"Model\"><a href=\"#Model\" class=\"headerlink\" title=\"Model\"></a>Model</h4><p><code>Model</code> 是定义一个数据模型的基类，它继承了 <code>Listenable</code>，提供了 <code>notifyListeners()</code> 方法来通知组件需要更新。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@protected</span>                                                                  </span><br><span class=\"line\"><span class=\"keyword\">void</span> notifyListeners() &#123;                                                    </span><br><span class=\"line\">  <span class=\"comment\">// We schedule a microtask to debounce multiple changes that can occur    </span></span><br><span class=\"line\">  <span class=\"comment\">// all at once.                     </span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_microtaskVersion == _version) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 去抖</span></span><br><span class=\"line\">    _microtaskVersion++; </span><br><span class=\"line\">    <span class=\"comment\">// 安排一个 Microtask 任务</span></span><br><span class=\"line\">    scheduleMicrotask(() &#123;                                                  </span><br><span class=\"line\">      _version++;                                                           </span><br><span class=\"line\">      _microtaskVersion = _version;                                         </span><br><span class=\"line\">                                                                            </span><br><span class=\"line\">      <span class=\"comment\">// Convert the Set to a List before executing each listener. This     </span></span><br><span class=\"line\">      <span class=\"comment\">// prevents errors that can arise if a listener removes itself during </span></span><br><span class=\"line\">      <span class=\"comment\">// invocation!                                                        </span></span><br><span class=\"line\">      _listeners.toList().forEach((VoidCallback listener) =&gt; listener());   </span><br><span class=\"line\">    &#125;);                                                                     </span><br><span class=\"line\">  &#125;                                                                         </span><br><span class=\"line\">&#125;                                                                           </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>关于 Microtask：这涉及到 dart 的单线程模型，这里我们只需要知道，它的优先级比 event 要高，会先执行。</p>\n<p>关于更多信息，可以查看 <a href=\"https://webdev.dartlang.org/articles/performance/event-loop#darts-event-loop-and-queues\">event-loop</a></p>\n</blockquote>\n<h4 id=\"ScopedModel\"><a href=\"#ScopedModel\" class=\"headerlink\" title=\"ScopedModel\"></a>ScopedModel</h4><p>在定义一个 <code>Model</code> 后，我们需要再定义一个 <code>ScopedModel</code> 作为 root widget，它有两个参数，一个是 <code>model</code> 即我们上面定义的 <code>Model</code> 实例，另外一个是 <code>child</code>，则是我们定义的 widget。<code>ScopedModel</code> 是一个 <code>StetelessWidget</code>，我们看下它的 <code>build()</code> 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                                     </span><br><span class=\"line\">Widget build(BuildContext context) &#123;                                          </span><br><span class=\"line\">  <span class=\"keyword\">return</span> AnimatedBuilder(                                                     </span><br><span class=\"line\">    animation: model,                                                         </span><br><span class=\"line\">    builder: (context, _) =&gt; _InheritedModel&lt;T&gt;(model: model, child: child),  </span><br><span class=\"line\">  );                                                                          </span><br><span class=\"line\">&#125;                                                                             </span><br></pre></td></tr></table></figure>\n\n<p><code>AnimatedBuilder</code> 是一个用于构建动画的 widget，它的 <code>animation</code> 参数是一个 <code>Listenable</code> 类：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Listenable</span> </span>&#123;                                                          </span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\">Abstract const constructor. This constructor enables subclasses to provide     </span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\">const constructors so that they can be used in const expressions.              </span></span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> Listenable();                                                                </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\">Return a [Listenable] that triggers when any of the given [Listenable]s        </span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\">themselves trigger.                                                            </span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">                                                                               </span></span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">The list must not be changed after this method has been called. Doing so       </span></span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">will lead to memory leaks or exceptions.                                       </span></span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">                                                                               </span></span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">The list may contain nulls; they are ignored.                                  </span></span></span></span><br><span class=\"line\">  <span class=\"keyword\">factory</span> Listenable.merge(<span class=\"built_in\">List</span>&lt;Listenable&gt; listenables) = _MergingListenable;       </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">Register a closure to be called when the object notifies its listeners.        </span></span></span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> addListener(VoidCallback listener);                                           </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">Remove a previously registered closure from the list of closures that the      </span></span></span></span><br><span class=\"line\">  <span class=\"comment\">/// <span class=\"language-markdown\"><span class=\"code\">object notifies.                                                               </span></span></span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> removeListener(VoidCallback listener);                                        </span><br><span class=\"line\">&#125;                                                                                    </span><br></pre></td></tr></table></figure>\n\n<p><code>AnimatedBuilder</code> 会调用 <code>addListener()</code> 方法添加一个监听者，然后调用 <code>setState()</code> 方法进行 rebuild。从上面可知，<code>Model</code> 继承 <code>Listenable</code> 类。这也是为什么在修改值后需要调用 <code>notifyListeners()</code> 的原因。</p>\n<p>再看下 <code>builder</code> 参数，它实际上返回了一个 <code>_InheritedModel</code> 实例：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">_InheritedModel</span>&lt;<span class=\"title\">T</span> <span class=\"keyword\">extends</span> <span class=\"title\">Model</span>&gt; <span class=\"keyword\">extends</span> <span class=\"title\">InheritedWidget</span> </span>&#123;     </span><br><span class=\"line\">  <span class=\"keyword\">final</span> T model;                                                     </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> version;                                                 </span><br><span class=\"line\">                                                                     </span><br><span class=\"line\">  _InheritedModel(&#123;Key key, Widget child, T model&#125;)                  </span><br><span class=\"line\">      : <span class=\"keyword\">this</span>.model = model,                                          </span><br><span class=\"line\">        <span class=\"keyword\">this</span>.version = model._version,                               </span><br><span class=\"line\">        <span class=\"keyword\">super</span>(key: key, child: child);                               </span><br><span class=\"line\">                                                                     </span><br><span class=\"line\">  <span class=\"meta\">@override</span>                                                          </span><br><span class=\"line\">  <span class=\"built_in\">bool</span> updateShouldNotify(_InheritedModel&lt;T&gt; oldWidget) =&gt;           </span><br><span class=\"line\">      (oldWidget.version != version);                                </span><br><span class=\"line\">&#125;                                                                    </span><br></pre></td></tr></table></figure>\n\n<p><code>InheritedWidget</code> 是 <code>scoped_model</code> 的核心。</p>\n<h5 id=\"InheritedWidget\"><a href=\"#InheritedWidget\" class=\"headerlink\" title=\"InheritedWidget\"></a>InheritedWidget</h5><p><code>InheritedWidget</code> 可以在组件树中有效的传递和共享数据。将 <code>InheritedWidget</code> 作为 root widget，child widget 可以通过 <code>inheritFromWidgetOfExactType()</code> 方法返回距离它最近的 <code>InheritedWidget</code> 实例，同时也将它注册到 <code>InheritedWidget</code> 中，当 <code>InheritedWidget</code> 的数据发生变化时，child widget 也会随之 rebuild。</p>\n<p>当 <code>InheritedWidget</code> rebuild 时，会调用 <code>updateShouldNotify()</code> 方法来决定是否重建 child widget。</p>\n<p>继续看 <code>ScopedModel</code>，它使用 <code>version</code> 来判断是否需要通知 child widget 更新：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                          </span><br><span class=\"line\"><span class=\"built_in\">bool</span> updateShouldNotify(_InheritedModel&lt;T&gt; oldWidget) =&gt;           </span><br><span class=\"line\">      (oldWidget.version != version); </span><br></pre></td></tr></table></figure>\n\n<p>当我们调用 <code>Model</code> 的 <code>notifyListeners()</code> 方法时，<code>version</code> 就会自增。</p>\n<h4 id=\"ScopedModelDescendant\"><a href=\"#ScopedModelDescendant\" class=\"headerlink\" title=\"ScopedModelDescendant\"></a>ScopedModelDescendant</h4><p><code>ScopedModelDescendant</code> 是一个工具类，用于获取指定类型的 <code>Model</code>，当 <code>Model</code> 更新时，会重新执行 <code>build()</code> 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                            </span><br><span class=\"line\">Widget build(BuildContext context) &#123;                                 </span><br><span class=\"line\">  <span class=\"keyword\">return</span> builder(                                                    </span><br><span class=\"line\">    context,                                                         </span><br><span class=\"line\">    child,                                                           </span><br><span class=\"line\">    ScopedModel.of&lt;T&gt;(context, rebuildOnChange: rebuildOnChange),    </span><br><span class=\"line\">  );                                                                 </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> T of&lt;T <span class=\"keyword\">extends</span> Model&gt;(                       </span><br><span class=\"line\">  BuildContext context, &#123;                           </span><br><span class=\"line\">  <span class=\"built_in\">bool</span> rebuildOnChange = <span class=\"keyword\">false</span>,                     </span><br><span class=\"line\">&#125;) &#123;                                                </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">Type</span> type = _type&lt;_InheritedModel&lt;T&gt;&gt;();    </span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// 最终也是使用 inheritFromWidgetOfExactType 或 ancestorWidgetOfExactType</span></span><br><span class=\"line\">  Widget widget = rebuildOnChange                   </span><br><span class=\"line\">      ? context.inheritFromWidgetOfExactType(type)  </span><br><span class=\"line\">      : context.ancestorWidgetOfExactType(type);    </span><br><span class=\"line\">                                                    </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (widget == <span class=\"keyword\">null</span>) &#123;                             </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ScopedModelError();                   </span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;                                          </span><br><span class=\"line\">    <span class=\"keyword\">return</span> (widget <span class=\"keyword\">as</span> _InheritedModel&lt;T&gt;).model;    </span><br><span class=\"line\">  &#125;                                                 </span><br><span class=\"line\">&#125;                                                   </span><br><span class=\"line\">                                                    </span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"built_in\">Type</span> _type&lt;T&gt;() =&gt; T;                        </span><br></pre></td></tr></table></figure>\n\n<p>注意到，在调用 <code>ScopedModel.of()</code> 方法时，有个 <code>rebuildOnChange</code> 参数，表示当 <code>Model</code> 更新时，是否需要 rebuild。当设置为 <code>false</code> 时，会使用 <code>ancestorWidgetOfExactType()</code> 方法去获取最近的 <code>InheritedWidget</code>，和 <code>inheritFromWidgetOfExactType()</code> 方法的区别是，<code>inheritFromWidgetOfExactType</code> 在获取的同时会注册到 <code>InheritedWidget</code> 上。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>使用 <code>scoped_model</code>，我们首先定义一个 <code>Model</code>，这里面封装了对数据的操作，需要注意，数据改变后需要调用 <code>notifyListeners()</code> 方法。接着再将 <code>ScopedModel</code> 作为 root widget，传递一个 <code>Model</code> 实例，最后我们可以使用 <code>ScopedModelDescendant</code> 来响应数据的修改，也可以手动调用 <code>ScopedModel.of()</code> 方法来获取 <code>Model</code> 实例，调用这个方法，如果参数 <code>rebuildOnChange</code> 传递为 <code>true</code>，则同时会将当前 widget 注册到 <code>InheritedWidget</code> 上，当数据改变时，当前 widget 会重新构建。</p>\n"},{"title":"仿即刻Flutter版本","date":"2019-08-07T11:48:22.000Z","_content":"\n### 题外话\n\n即刻是我个人用的比较频繁的 APP 之一，但在我的手机一直有个 bug，播放视频时总是画面没有变化，需要手动推动下进度条才行，在更新了几个版本也没解决这个问题。再加上刚学了 Flutter，就尝试做了个 Flutter 版本的即刻，即刻页面比较多，所以没有完全开发完，只开发了首页的信息流，信息详情，视频播放等几个用的最多的页面。\n\n> 接口用的是即刻的接口和图标，**这里是为了学习，请勿用做其他用途，一切后果由自己承担，版权归即刻所有**\n\n\n因为我本身学习 Flutter 的时间也才几个月，所以代码质量还是有所欠缺的。\n\n最近即刻被暂停服务了，所以 API 也调用不了，只能看看之前录制的片段。\n\n源码地址：[today](https://github.com/LinXiaoTao/today)\n\n### 效果\n\n国际惯例，先实现的效果图：\n\n![jike](https://user-gold-cdn.xitu.io/2019/8/7/16c6aa0d7a121ba0?w=320&h=569&f=gif&s=8296263)\n\n这里面属首页的信息流最复杂，因为涉及了很多的样式，有几个花了时间实现的：\n\n- @ 人的效果，文字中有多个高亮显示的标签，点击可以跳转页面\n- 搜索栏和列表的嵌套滚动\n\n第二个花时间的是个人详情页面中，整体页面的嵌套滚动。\n\n### 实现\n\n首先看下项目的整体结构，这里面代码整体重构过一次，之前使用 ScopedModel，后面觉得不太灵活，又换了相对热门的 Bloc 架构。\n\n#### bloc\n\n这个目录存放整个应用所有的 bloc 文件，按功能模块划分，最外层有一个 `blocs` 用于导出所有的 bloc 文件，每个模块中有四个文件，分别是：\n\n- bloc.dart：导出当前模块的 bloc\n- xxx_event.dart：bloc 中的 event\n- xxx_state.dart：bloc 中的 state\n- xxx_bloc.dart：处理逻辑\n\n#### network\n\n网络层的代码在 network 目录下，用的是 [dio](https://github.com/flutterchina/dio) 框架，这个框架用起来比较方便，API 的封装有点类似 okhttp，这里也写了个拦截器 `BusinessInterceptor` 用于处理 token 信息。接口定义放在 `ApiRequest` 里面，相关的数据模型放在 `model` 目录下，用的是 [**json_serializable**](https://github.com/dart-lang/json_serializable/tree/master/json_annotation)。\n\n#### UI\n\n所有的页面存放在 ui 目录下，按功能模块划分，其中 `ui_base.dart` 存放一些基类，颜色常量等等。\n\n#### flutterw\n\n关于 Flutter 的版本问题，估计很多小伙伴也挺头疼的，特别是需要协作开发的。这里我自己写了一个类似 gradlew 的 flutterw，使用特定的版本的 Flutter 去编译，只需要将 flutter 改用为 flutterw 即可。\n\n> 关于 flutterw 的更多介绍：[解决Flutter版本不一致的flutterw](https://juejin.im/post/5d0c39326fb9a07ef63fe4b0)\n\n### 最后\n\n模仿的页面不多，但还是花了不少时间去写的，talk is cheap show me the code。","source":"_posts/仿即刻Flutter版本.md","raw":"---\ntitle: 仿即刻Flutter版本\ndate: 2019-08-07 19:48:22\ncategories: Flutter\ntags:\n---\n\n### 题外话\n\n即刻是我个人用的比较频繁的 APP 之一，但在我的手机一直有个 bug，播放视频时总是画面没有变化，需要手动推动下进度条才行，在更新了几个版本也没解决这个问题。再加上刚学了 Flutter，就尝试做了个 Flutter 版本的即刻，即刻页面比较多，所以没有完全开发完，只开发了首页的信息流，信息详情，视频播放等几个用的最多的页面。\n\n> 接口用的是即刻的接口和图标，**这里是为了学习，请勿用做其他用途，一切后果由自己承担，版权归即刻所有**\n\n\n因为我本身学习 Flutter 的时间也才几个月，所以代码质量还是有所欠缺的。\n\n最近即刻被暂停服务了，所以 API 也调用不了，只能看看之前录制的片段。\n\n源码地址：[today](https://github.com/LinXiaoTao/today)\n\n### 效果\n\n国际惯例，先实现的效果图：\n\n![jike](https://user-gold-cdn.xitu.io/2019/8/7/16c6aa0d7a121ba0?w=320&h=569&f=gif&s=8296263)\n\n这里面属首页的信息流最复杂，因为涉及了很多的样式，有几个花了时间实现的：\n\n- @ 人的效果，文字中有多个高亮显示的标签，点击可以跳转页面\n- 搜索栏和列表的嵌套滚动\n\n第二个花时间的是个人详情页面中，整体页面的嵌套滚动。\n\n### 实现\n\n首先看下项目的整体结构，这里面代码整体重构过一次，之前使用 ScopedModel，后面觉得不太灵活，又换了相对热门的 Bloc 架构。\n\n#### bloc\n\n这个目录存放整个应用所有的 bloc 文件，按功能模块划分，最外层有一个 `blocs` 用于导出所有的 bloc 文件，每个模块中有四个文件，分别是：\n\n- bloc.dart：导出当前模块的 bloc\n- xxx_event.dart：bloc 中的 event\n- xxx_state.dart：bloc 中的 state\n- xxx_bloc.dart：处理逻辑\n\n#### network\n\n网络层的代码在 network 目录下，用的是 [dio](https://github.com/flutterchina/dio) 框架，这个框架用起来比较方便，API 的封装有点类似 okhttp，这里也写了个拦截器 `BusinessInterceptor` 用于处理 token 信息。接口定义放在 `ApiRequest` 里面，相关的数据模型放在 `model` 目录下，用的是 [**json_serializable**](https://github.com/dart-lang/json_serializable/tree/master/json_annotation)。\n\n#### UI\n\n所有的页面存放在 ui 目录下，按功能模块划分，其中 `ui_base.dart` 存放一些基类，颜色常量等等。\n\n#### flutterw\n\n关于 Flutter 的版本问题，估计很多小伙伴也挺头疼的，特别是需要协作开发的。这里我自己写了一个类似 gradlew 的 flutterw，使用特定的版本的 Flutter 去编译，只需要将 flutter 改用为 flutterw 即可。\n\n> 关于 flutterw 的更多介绍：[解决Flutter版本不一致的flutterw](https://juejin.im/post/5d0c39326fb9a07ef63fe4b0)\n\n### 最后\n\n模仿的页面不多，但还是花了不少时间去写的，talk is cheap show me the code。","slug":"仿即刻Flutter版本","published":1,"updated":"2022-06-15T11:19:32.323Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlf000dfho6esc5592n","content":"<h3 id=\"题外话\"><a href=\"#题外话\" class=\"headerlink\" title=\"题外话\"></a>题外话</h3><p>即刻是我个人用的比较频繁的 APP 之一，但在我的手机一直有个 bug，播放视频时总是画面没有变化，需要手动推动下进度条才行，在更新了几个版本也没解决这个问题。再加上刚学了 Flutter，就尝试做了个 Flutter 版本的即刻，即刻页面比较多，所以没有完全开发完，只开发了首页的信息流，信息详情，视频播放等几个用的最多的页面。</p>\n<blockquote>\n<p>接口用的是即刻的接口和图标，<strong>这里是为了学习，请勿用做其他用途，一切后果由自己承担，版权归即刻所有</strong></p>\n</blockquote>\n<p>因为我本身学习 Flutter 的时间也才几个月，所以代码质量还是有所欠缺的。</p>\n<p>最近即刻被暂停服务了，所以 API 也调用不了，只能看看之前录制的片段。</p>\n<p>源码地址：<a href=\"https://github.com/LinXiaoTao/today\">today</a></p>\n<h3 id=\"效果\"><a href=\"#效果\" class=\"headerlink\" title=\"效果\"></a>效果</h3><p>国际惯例，先实现的效果图：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/7/16c6aa0d7a121ba0?w=320&h=569&f=gif&s=8296263\" alt=\"jike\"></p>\n<p>这里面属首页的信息流最复杂，因为涉及了很多的样式，有几个花了时间实现的：</p>\n<ul>\n<li>@ 人的效果，文字中有多个高亮显示的标签，点击可以跳转页面</li>\n<li>搜索栏和列表的嵌套滚动</li>\n</ul>\n<p>第二个花时间的是个人详情页面中，整体页面的嵌套滚动。</p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p>首先看下项目的整体结构，这里面代码整体重构过一次，之前使用 ScopedModel，后面觉得不太灵活，又换了相对热门的 Bloc 架构。</p>\n<h4 id=\"bloc\"><a href=\"#bloc\" class=\"headerlink\" title=\"bloc\"></a>bloc</h4><p>这个目录存放整个应用所有的 bloc 文件，按功能模块划分，最外层有一个 <code>blocs</code> 用于导出所有的 bloc 文件，每个模块中有四个文件，分别是：</p>\n<ul>\n<li>bloc.dart：导出当前模块的 bloc</li>\n<li>xxx_event.dart：bloc 中的 event</li>\n<li>xxx_state.dart：bloc 中的 state</li>\n<li>xxx_bloc.dart：处理逻辑</li>\n</ul>\n<h4 id=\"network\"><a href=\"#network\" class=\"headerlink\" title=\"network\"></a>network</h4><p>网络层的代码在 network 目录下，用的是 <a href=\"https://github.com/flutterchina/dio\">dio</a> 框架，这个框架用起来比较方便，API 的封装有点类似 okhttp，这里也写了个拦截器 <code>BusinessInterceptor</code> 用于处理 token 信息。接口定义放在 <code>ApiRequest</code> 里面，相关的数据模型放在 <code>model</code> 目录下，用的是 <a href=\"https://github.com/dart-lang/json_serializable/tree/master/json_annotation\"><strong>json_serializable</strong></a>。</p>\n<h4 id=\"UI\"><a href=\"#UI\" class=\"headerlink\" title=\"UI\"></a>UI</h4><p>所有的页面存放在 ui 目录下，按功能模块划分，其中 <code>ui_base.dart</code> 存放一些基类，颜色常量等等。</p>\n<h4 id=\"flutterw\"><a href=\"#flutterw\" class=\"headerlink\" title=\"flutterw\"></a>flutterw</h4><p>关于 Flutter 的版本问题，估计很多小伙伴也挺头疼的，特别是需要协作开发的。这里我自己写了一个类似 gradlew 的 flutterw，使用特定的版本的 Flutter 去编译，只需要将 flutter 改用为 flutterw 即可。</p>\n<blockquote>\n<p>关于 flutterw 的更多介绍：<a href=\"https://juejin.im/post/5d0c39326fb9a07ef63fe4b0\">解决Flutter版本不一致的flutterw</a></p>\n</blockquote>\n<h3 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h3><p>模仿的页面不多，但还是花了不少时间去写的，talk is cheap show me the code。</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"题外话\"><a href=\"#题外话\" class=\"headerlink\" title=\"题外话\"></a>题外话</h3><p>即刻是我个人用的比较频繁的 APP 之一，但在我的手机一直有个 bug，播放视频时总是画面没有变化，需要手动推动下进度条才行，在更新了几个版本也没解决这个问题。再加上刚学了 Flutter，就尝试做了个 Flutter 版本的即刻，即刻页面比较多，所以没有完全开发完，只开发了首页的信息流，信息详情，视频播放等几个用的最多的页面。</p>\n<blockquote>\n<p>接口用的是即刻的接口和图标，<strong>这里是为了学习，请勿用做其他用途，一切后果由自己承担，版权归即刻所有</strong></p>\n</blockquote>\n<p>因为我本身学习 Flutter 的时间也才几个月，所以代码质量还是有所欠缺的。</p>\n<p>最近即刻被暂停服务了，所以 API 也调用不了，只能看看之前录制的片段。</p>\n<p>源码地址：<a href=\"https://github.com/LinXiaoTao/today\">today</a></p>\n<h3 id=\"效果\"><a href=\"#效果\" class=\"headerlink\" title=\"效果\"></a>效果</h3><p>国际惯例，先实现的效果图：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/7/16c6aa0d7a121ba0?w=320&h=569&f=gif&s=8296263\" alt=\"jike\"></p>\n<p>这里面属首页的信息流最复杂，因为涉及了很多的样式，有几个花了时间实现的：</p>\n<ul>\n<li>@ 人的效果，文字中有多个高亮显示的标签，点击可以跳转页面</li>\n<li>搜索栏和列表的嵌套滚动</li>\n</ul>\n<p>第二个花时间的是个人详情页面中，整体页面的嵌套滚动。</p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p>首先看下项目的整体结构，这里面代码整体重构过一次，之前使用 ScopedModel，后面觉得不太灵活，又换了相对热门的 Bloc 架构。</p>\n<h4 id=\"bloc\"><a href=\"#bloc\" class=\"headerlink\" title=\"bloc\"></a>bloc</h4><p>这个目录存放整个应用所有的 bloc 文件，按功能模块划分，最外层有一个 <code>blocs</code> 用于导出所有的 bloc 文件，每个模块中有四个文件，分别是：</p>\n<ul>\n<li>bloc.dart：导出当前模块的 bloc</li>\n<li>xxx_event.dart：bloc 中的 event</li>\n<li>xxx_state.dart：bloc 中的 state</li>\n<li>xxx_bloc.dart：处理逻辑</li>\n</ul>\n<h4 id=\"network\"><a href=\"#network\" class=\"headerlink\" title=\"network\"></a>network</h4><p>网络层的代码在 network 目录下，用的是 <a href=\"https://github.com/flutterchina/dio\">dio</a> 框架，这个框架用起来比较方便，API 的封装有点类似 okhttp，这里也写了个拦截器 <code>BusinessInterceptor</code> 用于处理 token 信息。接口定义放在 <code>ApiRequest</code> 里面，相关的数据模型放在 <code>model</code> 目录下，用的是 <a href=\"https://github.com/dart-lang/json_serializable/tree/master/json_annotation\"><strong>json_serializable</strong></a>。</p>\n<h4 id=\"UI\"><a href=\"#UI\" class=\"headerlink\" title=\"UI\"></a>UI</h4><p>所有的页面存放在 ui 目录下，按功能模块划分，其中 <code>ui_base.dart</code> 存放一些基类，颜色常量等等。</p>\n<h4 id=\"flutterw\"><a href=\"#flutterw\" class=\"headerlink\" title=\"flutterw\"></a>flutterw</h4><p>关于 Flutter 的版本问题，估计很多小伙伴也挺头疼的，特别是需要协作开发的。这里我自己写了一个类似 gradlew 的 flutterw，使用特定的版本的 Flutter 去编译，只需要将 flutter 改用为 flutterw 即可。</p>\n<blockquote>\n<p>关于 flutterw 的更多介绍：<a href=\"https://juejin.im/post/5d0c39326fb9a07ef63fe4b0\">解决Flutter版本不一致的flutterw</a></p>\n</blockquote>\n<h3 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h3><p>模仿的页面不多，但还是花了不少时间去写的，talk is cheap show me the code。</p>\n"},{"title":"SparseArray源码解析","date":"2019-01-08T13:58:23.000Z","_content":"\n### 关于SparseArray\n\n`SparseArray` 是 Android SDK 提供的将 integers 映射到对象的容器。相对于 `HashMap` 更节省内存，因为它避免了 key 发生自动装箱，同时不用额外的对象来表示映射关系。\n\n`SparseArray` 使用二分查找来查询 key，这意味着，key 是有序存储的，而且不适用于大量数据的情况。通常情况下，它的查找比 `HashMap` 慢。\n\n为了提高性能，`SparseArray` 在删除 key 时，不会立即调整数据结构，而是将该条目标记为删除，在之后使用相同 key 时可以复用或者垃圾回收操作中进行调整。\n\n> 垃圾回收操作会发生在需要扩容、获取size 或者检索条目值时\n\n### 源码分析\n\n#### 构造函数\n\n`SparseArray` 有两个构造函数\n\n``` java\nprivate int[] mKeys;\nprivate Object[] mValues;\npublic SparseArray() {                                                  \n    this(10);                                                           \n}                                                                       \n                                                                                                                                            \npublic SparseArray(int initialCapacity) {                               \n    if (initialCapacity == 0) {                                         \n        mKeys = EmptyArray.INT;                                         \n        mValues = EmptyArray.OBJECT;                                    \n    } else {                                                            \n        mValues = ArrayUtils.newUnpaddedObjectArray(initialCapacity);   \n        mKeys = new int[mValues.length];                                \n    }                                                                   \n    mSize = 0;                                                          \n}                                                                       \n```\n\n如果使用不指定初始化容量，将使用默认 10，可以看到，`SparseArray` 内部使用两个数组来分别存储 key 和 value\n\n#### put\n\n如果 key 没有存在，则添加，否则进行替换操作\n\n``` java\npublic void put(int key, E value) {                                           \n    int i = ContainerHelpers.binarySearch(mKeys, mSize, key);                 \n                                                                              \n    if (i >= 0) { \n        // key 已经存在，替换\n        mValues[i] = value;                                                   \n    } else {\n        // key 不存在，取反获取 key 应该插入的下标\n        i = ~i;                                                               \n                                                                              \n        if (i < mSize && mValues[i] == DELETED) {\n            // 复用被标记为 DELETED 的条目\n            mKeys[i] = key;                                                   \n            mValues[i] = value;                                               \n            return;                                                           \n        }                                                                     \n                                                                              \n        if (mGarbage && mSize >= mKeys.length) { \n            // 需要扩容\n            gc();                                                             \n                                                                              \n            // Search again because indices may have changed.                 \n            i = ~ContainerHelpers.binarySearch(mKeys, mSize, key);            \n        }                                                                     \n        \n        // 插入新的条目\n        mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key);               \n        mValues = GrowingArrayUtils.insert(mValues, mSize, i, value);         \n        mSize++;                                                              \n    }                                                                         \n}\n\nstatic int binarySearch(int[] array, int size, int value) {       \n    int lo = 0;                                                   \n    int hi = size - 1;                                            \n                                                                  \n    while (lo <= hi) {                                            \n        final int mid = (lo + hi) >>> 1;                          \n        final int midVal = array[mid];                            \n                                                                  \n        if (midVal < value) {                                     \n            lo = mid + 1;                                         \n        } else if (midVal > value) {                              \n            hi = mid - 1;                                         \n        } else {                                                  \n            return mid;  // value found                           \n        }                                                         \n    }                                                             \n    return ~lo;  // value not present                             \n}                                                                 \n```\n\n`binarySearch` 就是二分查找算法的实现 ，需要注意的是，如果没有查找到，则返回 `~lo`\n\n> 这里的 `lo` 可以认为是，虽然没有查找到指定的值，但这是最接近的，换句话说，这个是指定值应该插入的位置\n>\n> 比如：在 1,2,3,4,6,7 查找 5，那么 `binarySearch` 将返回 `~4`\n\n#### get\n\nget 操作比较简单，同样的先二分查找 key，存在则返回，否则返回默认值\n\n``` java\npublic E get(int key, E valueIfKeyNotFound) {                 \n    int i = ContainerHelpers.binarySearch(mKeys, mSize, key); \n                                                              \n    if (i < 0 || mValues[i] == DELETED) {                     \n        return valueIfKeyNotFound;                            \n    } else {                                                  \n        return (E) mValues[i];                                \n    }                                                         \n}                                                             \n```\n\n#### remove\n\nremove 操作实际调用 `delete` 方法\n\n``` java\npublic void delete(int key) {                                   \n    int i = ContainerHelpers.binarySearch(mKeys, mSize, key);   \n                                                                \n    if (i >= 0) {                                               \n        if (mValues[i] != DELETED) {\n            // 只是标记为 DELETED\n            mValues[i] = DELETED;\n            // 需要回收\n            mGarbage = true;                                    \n        }                                                       \n    }                                                           \n}                                                               \n```\n\n#### size\n\n调用 `size` 之后，会先检查是否需要 `gc` 即回收操作\n\n``` java\npublic int size() {   \n    if (mGarbage) {   \n        gc();         \n    }                 \n                      \n    return mSize;     \n}                     \n```\n\n#### gc\n\n在调用 `size` 和涉及 index 相关的方法时，都会检查是否需要 `gc`，比如 `keyAt` 等\n\n``` java\nprivate void gc() {                                          \n    // Log.e(\"SparseArray\", \"gc start with \" + mSize);       \n                                                             \n    int n = mSize;                                           \n    int o = 0;                                               \n    int[] keys = mKeys;                                      \n    Object[] values = mValues;                               \n                                                             \n    for (int i = 0; i < n; i++) {\n        // 将没有标记为 DELETED 的条目移到新位置，清除 DELETED\n        Object val = values[i];                              \n                                                             \n        if (val != DELETED) {                                \n            if (i != o) {\n                keys[o] = keys[i];                           \n                values[o] = val;                             \n                values[i] = null;                            \n            }                                                \n                                                             \n            o++;                                             \n        }                                                    \n    }                                                        \n                                                             \n    mGarbage = false;                                        \n    mSize = o;                                               \n                                                             \n    // Log.e(\"SparseArray\", \"gc end with \" + mSize);         \n}                                                            \n```\n\n### 总结\n\n`SparseArray` 是用两个数组来分别存储 key 和 value，其中 key 是 `int[]` 避免了自动装箱，同时是升序的，所以查找 key 可以使用二分查找，相对于 `HashMap` 更省内存，但检索速度更慢。在数据量较少的情况下，可以使用 `SparseArray` 代替 `HashMap`\n\n","source":"_posts/SparseArray源码解析.md","raw":"---\ntitle: SparseArray源码解析\ndate: 2019-01-08 21:58:23\ncategories: Android\ntags:\n---\n\n### 关于SparseArray\n\n`SparseArray` 是 Android SDK 提供的将 integers 映射到对象的容器。相对于 `HashMap` 更节省内存，因为它避免了 key 发生自动装箱，同时不用额外的对象来表示映射关系。\n\n`SparseArray` 使用二分查找来查询 key，这意味着，key 是有序存储的，而且不适用于大量数据的情况。通常情况下，它的查找比 `HashMap` 慢。\n\n为了提高性能，`SparseArray` 在删除 key 时，不会立即调整数据结构，而是将该条目标记为删除，在之后使用相同 key 时可以复用或者垃圾回收操作中进行调整。\n\n> 垃圾回收操作会发生在需要扩容、获取size 或者检索条目值时\n\n### 源码分析\n\n#### 构造函数\n\n`SparseArray` 有两个构造函数\n\n``` java\nprivate int[] mKeys;\nprivate Object[] mValues;\npublic SparseArray() {                                                  \n    this(10);                                                           \n}                                                                       \n                                                                                                                                            \npublic SparseArray(int initialCapacity) {                               \n    if (initialCapacity == 0) {                                         \n        mKeys = EmptyArray.INT;                                         \n        mValues = EmptyArray.OBJECT;                                    \n    } else {                                                            \n        mValues = ArrayUtils.newUnpaddedObjectArray(initialCapacity);   \n        mKeys = new int[mValues.length];                                \n    }                                                                   \n    mSize = 0;                                                          \n}                                                                       \n```\n\n如果使用不指定初始化容量，将使用默认 10，可以看到，`SparseArray` 内部使用两个数组来分别存储 key 和 value\n\n#### put\n\n如果 key 没有存在，则添加，否则进行替换操作\n\n``` java\npublic void put(int key, E value) {                                           \n    int i = ContainerHelpers.binarySearch(mKeys, mSize, key);                 \n                                                                              \n    if (i >= 0) { \n        // key 已经存在，替换\n        mValues[i] = value;                                                   \n    } else {\n        // key 不存在，取反获取 key 应该插入的下标\n        i = ~i;                                                               \n                                                                              \n        if (i < mSize && mValues[i] == DELETED) {\n            // 复用被标记为 DELETED 的条目\n            mKeys[i] = key;                                                   \n            mValues[i] = value;                                               \n            return;                                                           \n        }                                                                     \n                                                                              \n        if (mGarbage && mSize >= mKeys.length) { \n            // 需要扩容\n            gc();                                                             \n                                                                              \n            // Search again because indices may have changed.                 \n            i = ~ContainerHelpers.binarySearch(mKeys, mSize, key);            \n        }                                                                     \n        \n        // 插入新的条目\n        mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key);               \n        mValues = GrowingArrayUtils.insert(mValues, mSize, i, value);         \n        mSize++;                                                              \n    }                                                                         \n}\n\nstatic int binarySearch(int[] array, int size, int value) {       \n    int lo = 0;                                                   \n    int hi = size - 1;                                            \n                                                                  \n    while (lo <= hi) {                                            \n        final int mid = (lo + hi) >>> 1;                          \n        final int midVal = array[mid];                            \n                                                                  \n        if (midVal < value) {                                     \n            lo = mid + 1;                                         \n        } else if (midVal > value) {                              \n            hi = mid - 1;                                         \n        } else {                                                  \n            return mid;  // value found                           \n        }                                                         \n    }                                                             \n    return ~lo;  // value not present                             \n}                                                                 \n```\n\n`binarySearch` 就是二分查找算法的实现 ，需要注意的是，如果没有查找到，则返回 `~lo`\n\n> 这里的 `lo` 可以认为是，虽然没有查找到指定的值，但这是最接近的，换句话说，这个是指定值应该插入的位置\n>\n> 比如：在 1,2,3,4,6,7 查找 5，那么 `binarySearch` 将返回 `~4`\n\n#### get\n\nget 操作比较简单，同样的先二分查找 key，存在则返回，否则返回默认值\n\n``` java\npublic E get(int key, E valueIfKeyNotFound) {                 \n    int i = ContainerHelpers.binarySearch(mKeys, mSize, key); \n                                                              \n    if (i < 0 || mValues[i] == DELETED) {                     \n        return valueIfKeyNotFound;                            \n    } else {                                                  \n        return (E) mValues[i];                                \n    }                                                         \n}                                                             \n```\n\n#### remove\n\nremove 操作实际调用 `delete` 方法\n\n``` java\npublic void delete(int key) {                                   \n    int i = ContainerHelpers.binarySearch(mKeys, mSize, key);   \n                                                                \n    if (i >= 0) {                                               \n        if (mValues[i] != DELETED) {\n            // 只是标记为 DELETED\n            mValues[i] = DELETED;\n            // 需要回收\n            mGarbage = true;                                    \n        }                                                       \n    }                                                           \n}                                                               \n```\n\n#### size\n\n调用 `size` 之后，会先检查是否需要 `gc` 即回收操作\n\n``` java\npublic int size() {   \n    if (mGarbage) {   \n        gc();         \n    }                 \n                      \n    return mSize;     \n}                     \n```\n\n#### gc\n\n在调用 `size` 和涉及 index 相关的方法时，都会检查是否需要 `gc`，比如 `keyAt` 等\n\n``` java\nprivate void gc() {                                          \n    // Log.e(\"SparseArray\", \"gc start with \" + mSize);       \n                                                             \n    int n = mSize;                                           \n    int o = 0;                                               \n    int[] keys = mKeys;                                      \n    Object[] values = mValues;                               \n                                                             \n    for (int i = 0; i < n; i++) {\n        // 将没有标记为 DELETED 的条目移到新位置，清除 DELETED\n        Object val = values[i];                              \n                                                             \n        if (val != DELETED) {                                \n            if (i != o) {\n                keys[o] = keys[i];                           \n                values[o] = val;                             \n                values[i] = null;                            \n            }                                                \n                                                             \n            o++;                                             \n        }                                                    \n    }                                                        \n                                                             \n    mGarbage = false;                                        \n    mSize = o;                                               \n                                                             \n    // Log.e(\"SparseArray\", \"gc end with \" + mSize);         \n}                                                            \n```\n\n### 总结\n\n`SparseArray` 是用两个数组来分别存储 key 和 value，其中 key 是 `int[]` 避免了自动装箱，同时是升序的，所以查找 key 可以使用二分查找，相对于 `HashMap` 更省内存，但检索速度更慢。在数据量较少的情况下，可以使用 `SparseArray` 代替 `HashMap`\n\n","slug":"SparseArray源码解析","published":1,"updated":"2022-06-15T11:19:32.322Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlf000efho6gjzhdjoq","content":"<h3 id=\"关于SparseArray\"><a href=\"#关于SparseArray\" class=\"headerlink\" title=\"关于SparseArray\"></a>关于SparseArray</h3><p><code>SparseArray</code> 是 Android SDK 提供的将 integers 映射到对象的容器。相对于 <code>HashMap</code> 更节省内存，因为它避免了 key 发生自动装箱，同时不用额外的对象来表示映射关系。</p>\n<p><code>SparseArray</code> 使用二分查找来查询 key，这意味着，key 是有序存储的，而且不适用于大量数据的情况。通常情况下，它的查找比 <code>HashMap</code> 慢。</p>\n<p>为了提高性能，<code>SparseArray</code> 在删除 key 时，不会立即调整数据结构，而是将该条目标记为删除，在之后使用相同 key 时可以复用或者垃圾回收操作中进行调整。</p>\n<blockquote>\n<p>垃圾回收操作会发生在需要扩容、获取size 或者检索条目值时</p>\n</blockquote>\n<h3 id=\"源码分析\"><a href=\"#源码分析\" class=\"headerlink\" title=\"源码分析\"></a>源码分析</h3><h4 id=\"构造函数\"><a href=\"#构造函数\" class=\"headerlink\" title=\"构造函数\"></a>构造函数</h4><p><code>SparseArray</code> 有两个构造函数</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span>[] mKeys;</span><br><span class=\"line\"><span class=\"keyword\">private</span> Object[] mValues;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">SparseArray</span><span class=\"params\">()</span> &#123;                                                  </span><br><span class=\"line\">    <span class=\"built_in\">this</span>(<span class=\"number\">10</span>);                                                           </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                                                                                            </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">SparseArray</span><span class=\"params\">(<span class=\"type\">int</span> initialCapacity)</span> &#123;                               </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (initialCapacity == <span class=\"number\">0</span>) &#123;                                         </span><br><span class=\"line\">        mKeys = EmptyArray.INT;                                         </span><br><span class=\"line\">        mValues = EmptyArray.OBJECT;                                    </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                            </span><br><span class=\"line\">        mValues = ArrayUtils.newUnpaddedObjectArray(initialCapacity);   </span><br><span class=\"line\">        mKeys = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[mValues.length];                                </span><br><span class=\"line\">    &#125;                                                                   </span><br><span class=\"line\">    mSize = <span class=\"number\">0</span>;                                                          </span><br><span class=\"line\">&#125;                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>如果使用不指定初始化容量，将使用默认 10，可以看到，<code>SparseArray</code> 内部使用两个数组来分别存储 key 和 value</p>\n<h4 id=\"put\"><a href=\"#put\" class=\"headerlink\" title=\"put\"></a>put</h4><p>如果 key 没有存在，则添加，否则进行替换操作</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">put</span><span class=\"params\">(<span class=\"type\">int</span> key, E value)</span> &#123;                                           </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> ContainerHelpers.binarySearch(mKeys, mSize, key);                 </span><br><span class=\"line\">                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i &gt;= <span class=\"number\">0</span>) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// key 已经存在，替换</span></span><br><span class=\"line\">        mValues[i] = value;                                                   </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// key 不存在，取反获取 key 应该插入的下标</span></span><br><span class=\"line\">        i = ~i;                                                               </span><br><span class=\"line\">                                                                              </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i &lt; mSize &amp;&amp; mValues[i] == DELETED) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 复用被标记为 DELETED 的条目</span></span><br><span class=\"line\">            mKeys[i] = key;                                                   </span><br><span class=\"line\">            mValues[i] = value;                                               </span><br><span class=\"line\">            <span class=\"keyword\">return</span>;                                                           </span><br><span class=\"line\">        &#125;                                                                     </span><br><span class=\"line\">                                                                              </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mGarbage &amp;&amp; mSize &gt;= mKeys.length) &#123; </span><br><span class=\"line\">            <span class=\"comment\">// 需要扩容</span></span><br><span class=\"line\">            gc();                                                             </span><br><span class=\"line\">                                                                              </span><br><span class=\"line\">            <span class=\"comment\">// Search again because indices may have changed.                 </span></span><br><span class=\"line\">            i = ~ContainerHelpers.binarySearch(mKeys, mSize, key);            </span><br><span class=\"line\">        &#125;                                                                     </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 插入新的条目</span></span><br><span class=\"line\">        mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key);               </span><br><span class=\"line\">        mValues = GrowingArrayUtils.insert(mValues, mSize, i, value);         </span><br><span class=\"line\">        mSize++;                                                              </span><br><span class=\"line\">    &#125;                                                                         </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">binarySearch</span><span class=\"params\">(<span class=\"type\">int</span>[] array, <span class=\"type\">int</span> size, <span class=\"type\">int</span> value)</span> &#123;       </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">lo</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;                                                   </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">hi</span> <span class=\"operator\">=</span> size - <span class=\"number\">1</span>;                                            </span><br><span class=\"line\">                                                                  </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (lo &lt;= hi) &#123;                                            </span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">mid</span> <span class=\"operator\">=</span> (lo + hi) &gt;&gt;&gt; <span class=\"number\">1</span>;                          </span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">midVal</span> <span class=\"operator\">=</span> array[mid];                            </span><br><span class=\"line\">                                                                  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (midVal &lt; value) &#123;                                     </span><br><span class=\"line\">            lo = mid + <span class=\"number\">1</span>;                                         </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (midVal &gt; value) &#123;                              </span><br><span class=\"line\">            hi = mid - <span class=\"number\">1</span>;                                         </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;                                                  </span><br><span class=\"line\">            <span class=\"keyword\">return</span> mid;  <span class=\"comment\">// value found                           </span></span><br><span class=\"line\">        &#125;                                                         </span><br><span class=\"line\">    &#125;                                                             </span><br><span class=\"line\">    <span class=\"keyword\">return</span> ~lo;  <span class=\"comment\">// value not present                             </span></span><br><span class=\"line\">&#125;                                                                 </span><br></pre></td></tr></table></figure>\n\n<p><code>binarySearch</code> 就是二分查找算法的实现 ，需要注意的是，如果没有查找到，则返回 <code>~lo</code></p>\n<blockquote>\n<p>这里的 <code>lo</code> 可以认为是，虽然没有查找到指定的值，但这是最接近的，换句话说，这个是指定值应该插入的位置</p>\n<p>比如：在 1,2,3,4,6,7 查找 5，那么 <code>binarySearch</code> 将返回 <code>~4</code></p>\n</blockquote>\n<h4 id=\"get\"><a href=\"#get\" class=\"headerlink\" title=\"get\"></a>get</h4><p>get 操作比较简单，同样的先二分查找 key，存在则返回，否则返回默认值</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> E <span class=\"title function_\">get</span><span class=\"params\">(<span class=\"type\">int</span> key, E valueIfKeyNotFound)</span> &#123;                 </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> ContainerHelpers.binarySearch(mKeys, mSize, key); </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i &lt; <span class=\"number\">0</span> || mValues[i] == DELETED) &#123;                     </span><br><span class=\"line\">        <span class=\"keyword\">return</span> valueIfKeyNotFound;                            </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                  </span><br><span class=\"line\">        <span class=\"keyword\">return</span> (E) mValues[i];                                </span><br><span class=\"line\">    &#125;                                                         </span><br><span class=\"line\">&#125;                                                             </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"remove\"><a href=\"#remove\" class=\"headerlink\" title=\"remove\"></a>remove</h4><p>remove 操作实际调用 <code>delete</code> 方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">delete</span><span class=\"params\">(<span class=\"type\">int</span> key)</span> &#123;                                   </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> ContainerHelpers.binarySearch(mKeys, mSize, key);   </span><br><span class=\"line\">                                                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i &gt;= <span class=\"number\">0</span>) &#123;                                               </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mValues[i] != DELETED) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 只是标记为 DELETED</span></span><br><span class=\"line\">            mValues[i] = DELETED;</span><br><span class=\"line\">            <span class=\"comment\">// 需要回收</span></span><br><span class=\"line\">            mGarbage = <span class=\"literal\">true</span>;                                    </span><br><span class=\"line\">        &#125;                                                       </span><br><span class=\"line\">    &#125;                                                           </span><br><span class=\"line\">&#125;                                                               </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"size\"><a href=\"#size\" class=\"headerlink\" title=\"size\"></a>size</h4><p>调用 <code>size</code> 之后，会先检查是否需要 <code>gc</code> 即回收操作</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">size</span><span class=\"params\">()</span> &#123;   </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mGarbage) &#123;   </span><br><span class=\"line\">        gc();         </span><br><span class=\"line\">    &#125;                 </span><br><span class=\"line\">                      </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mSize;     </span><br><span class=\"line\">&#125;                     </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"gc\"><a href=\"#gc\" class=\"headerlink\" title=\"gc\"></a>gc</h4><p>在调用 <code>size</code> 和涉及 index 相关的方法时，都会检查是否需要 <code>gc</code>，比如 <code>keyAt</code> 等</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">gc</span><span class=\"params\">()</span> &#123;                                          </span><br><span class=\"line\">    <span class=\"comment\">// Log.e(&quot;SparseArray&quot;, &quot;gc start with &quot; + mSize);       </span></span><br><span class=\"line\">                                                             </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> mSize;                                           </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">o</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;                                               </span><br><span class=\"line\">    <span class=\"type\">int</span>[] keys = mKeys;                                      </span><br><span class=\"line\">    Object[] values = mValues;                               </span><br><span class=\"line\">                                                             </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; n; i++) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 将没有标记为 DELETED 的条目移到新位置，清除 DELETED</span></span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">val</span> <span class=\"operator\">=</span> values[i];                              </span><br><span class=\"line\">                                                             </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (val != DELETED) &#123;                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i != o) &#123;</span><br><span class=\"line\">                keys[o] = keys[i];                           </span><br><span class=\"line\">                values[o] = val;                             </span><br><span class=\"line\">                values[i] = <span class=\"literal\">null</span>;                            </span><br><span class=\"line\">            &#125;                                                </span><br><span class=\"line\">                                                             </span><br><span class=\"line\">            o++;                                             </span><br><span class=\"line\">        &#125;                                                    </span><br><span class=\"line\">    &#125;                                                        </span><br><span class=\"line\">                                                             </span><br><span class=\"line\">    mGarbage = <span class=\"literal\">false</span>;                                        </span><br><span class=\"line\">    mSize = o;                                               </span><br><span class=\"line\">                                                             </span><br><span class=\"line\">    <span class=\"comment\">// Log.e(&quot;SparseArray&quot;, &quot;gc end with &quot; + mSize);         </span></span><br><span class=\"line\">&#125;                                                            </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p><code>SparseArray</code> 是用两个数组来分别存储 key 和 value，其中 key 是 <code>int[]</code> 避免了自动装箱，同时是升序的，所以查找 key 可以使用二分查找，相对于 <code>HashMap</code> 更省内存，但检索速度更慢。在数据量较少的情况下，可以使用 <code>SparseArray</code> 代替 <code>HashMap</code></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"关于SparseArray\"><a href=\"#关于SparseArray\" class=\"headerlink\" title=\"关于SparseArray\"></a>关于SparseArray</h3><p><code>SparseArray</code> 是 Android SDK 提供的将 integers 映射到对象的容器。相对于 <code>HashMap</code> 更节省内存，因为它避免了 key 发生自动装箱，同时不用额外的对象来表示映射关系。</p>\n<p><code>SparseArray</code> 使用二分查找来查询 key，这意味着，key 是有序存储的，而且不适用于大量数据的情况。通常情况下，它的查找比 <code>HashMap</code> 慢。</p>\n<p>为了提高性能，<code>SparseArray</code> 在删除 key 时，不会立即调整数据结构，而是将该条目标记为删除，在之后使用相同 key 时可以复用或者垃圾回收操作中进行调整。</p>\n<blockquote>\n<p>垃圾回收操作会发生在需要扩容、获取size 或者检索条目值时</p>\n</blockquote>\n<h3 id=\"源码分析\"><a href=\"#源码分析\" class=\"headerlink\" title=\"源码分析\"></a>源码分析</h3><h4 id=\"构造函数\"><a href=\"#构造函数\" class=\"headerlink\" title=\"构造函数\"></a>构造函数</h4><p><code>SparseArray</code> 有两个构造函数</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span>[] mKeys;</span><br><span class=\"line\"><span class=\"keyword\">private</span> Object[] mValues;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">SparseArray</span><span class=\"params\">()</span> &#123;                                                  </span><br><span class=\"line\">    <span class=\"built_in\">this</span>(<span class=\"number\">10</span>);                                                           </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                                                                                            </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">SparseArray</span><span class=\"params\">(<span class=\"type\">int</span> initialCapacity)</span> &#123;                               </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (initialCapacity == <span class=\"number\">0</span>) &#123;                                         </span><br><span class=\"line\">        mKeys = EmptyArray.INT;                                         </span><br><span class=\"line\">        mValues = EmptyArray.OBJECT;                                    </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                            </span><br><span class=\"line\">        mValues = ArrayUtils.newUnpaddedObjectArray(initialCapacity);   </span><br><span class=\"line\">        mKeys = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[mValues.length];                                </span><br><span class=\"line\">    &#125;                                                                   </span><br><span class=\"line\">    mSize = <span class=\"number\">0</span>;                                                          </span><br><span class=\"line\">&#125;                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>如果使用不指定初始化容量，将使用默认 10，可以看到，<code>SparseArray</code> 内部使用两个数组来分别存储 key 和 value</p>\n<h4 id=\"put\"><a href=\"#put\" class=\"headerlink\" title=\"put\"></a>put</h4><p>如果 key 没有存在，则添加，否则进行替换操作</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">put</span><span class=\"params\">(<span class=\"type\">int</span> key, E value)</span> &#123;                                           </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> ContainerHelpers.binarySearch(mKeys, mSize, key);                 </span><br><span class=\"line\">                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i &gt;= <span class=\"number\">0</span>) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// key 已经存在，替换</span></span><br><span class=\"line\">        mValues[i] = value;                                                   </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// key 不存在，取反获取 key 应该插入的下标</span></span><br><span class=\"line\">        i = ~i;                                                               </span><br><span class=\"line\">                                                                              </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i &lt; mSize &amp;&amp; mValues[i] == DELETED) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 复用被标记为 DELETED 的条目</span></span><br><span class=\"line\">            mKeys[i] = key;                                                   </span><br><span class=\"line\">            mValues[i] = value;                                               </span><br><span class=\"line\">            <span class=\"keyword\">return</span>;                                                           </span><br><span class=\"line\">        &#125;                                                                     </span><br><span class=\"line\">                                                                              </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mGarbage &amp;&amp; mSize &gt;= mKeys.length) &#123; </span><br><span class=\"line\">            <span class=\"comment\">// 需要扩容</span></span><br><span class=\"line\">            gc();                                                             </span><br><span class=\"line\">                                                                              </span><br><span class=\"line\">            <span class=\"comment\">// Search again because indices may have changed.                 </span></span><br><span class=\"line\">            i = ~ContainerHelpers.binarySearch(mKeys, mSize, key);            </span><br><span class=\"line\">        &#125;                                                                     </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 插入新的条目</span></span><br><span class=\"line\">        mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key);               </span><br><span class=\"line\">        mValues = GrowingArrayUtils.insert(mValues, mSize, i, value);         </span><br><span class=\"line\">        mSize++;                                                              </span><br><span class=\"line\">    &#125;                                                                         </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">binarySearch</span><span class=\"params\">(<span class=\"type\">int</span>[] array, <span class=\"type\">int</span> size, <span class=\"type\">int</span> value)</span> &#123;       </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">lo</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;                                                   </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">hi</span> <span class=\"operator\">=</span> size - <span class=\"number\">1</span>;                                            </span><br><span class=\"line\">                                                                  </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (lo &lt;= hi) &#123;                                            </span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">mid</span> <span class=\"operator\">=</span> (lo + hi) &gt;&gt;&gt; <span class=\"number\">1</span>;                          </span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">midVal</span> <span class=\"operator\">=</span> array[mid];                            </span><br><span class=\"line\">                                                                  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (midVal &lt; value) &#123;                                     </span><br><span class=\"line\">            lo = mid + <span class=\"number\">1</span>;                                         </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (midVal &gt; value) &#123;                              </span><br><span class=\"line\">            hi = mid - <span class=\"number\">1</span>;                                         </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;                                                  </span><br><span class=\"line\">            <span class=\"keyword\">return</span> mid;  <span class=\"comment\">// value found                           </span></span><br><span class=\"line\">        &#125;                                                         </span><br><span class=\"line\">    &#125;                                                             </span><br><span class=\"line\">    <span class=\"keyword\">return</span> ~lo;  <span class=\"comment\">// value not present                             </span></span><br><span class=\"line\">&#125;                                                                 </span><br></pre></td></tr></table></figure>\n\n<p><code>binarySearch</code> 就是二分查找算法的实现 ，需要注意的是，如果没有查找到，则返回 <code>~lo</code></p>\n<blockquote>\n<p>这里的 <code>lo</code> 可以认为是，虽然没有查找到指定的值，但这是最接近的，换句话说，这个是指定值应该插入的位置</p>\n<p>比如：在 1,2,3,4,6,7 查找 5，那么 <code>binarySearch</code> 将返回 <code>~4</code></p>\n</blockquote>\n<h4 id=\"get\"><a href=\"#get\" class=\"headerlink\" title=\"get\"></a>get</h4><p>get 操作比较简单，同样的先二分查找 key，存在则返回，否则返回默认值</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> E <span class=\"title function_\">get</span><span class=\"params\">(<span class=\"type\">int</span> key, E valueIfKeyNotFound)</span> &#123;                 </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> ContainerHelpers.binarySearch(mKeys, mSize, key); </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i &lt; <span class=\"number\">0</span> || mValues[i] == DELETED) &#123;                     </span><br><span class=\"line\">        <span class=\"keyword\">return</span> valueIfKeyNotFound;                            </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                  </span><br><span class=\"line\">        <span class=\"keyword\">return</span> (E) mValues[i];                                </span><br><span class=\"line\">    &#125;                                                         </span><br><span class=\"line\">&#125;                                                             </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"remove\"><a href=\"#remove\" class=\"headerlink\" title=\"remove\"></a>remove</h4><p>remove 操作实际调用 <code>delete</code> 方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">delete</span><span class=\"params\">(<span class=\"type\">int</span> key)</span> &#123;                                   </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> ContainerHelpers.binarySearch(mKeys, mSize, key);   </span><br><span class=\"line\">                                                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i &gt;= <span class=\"number\">0</span>) &#123;                                               </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mValues[i] != DELETED) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 只是标记为 DELETED</span></span><br><span class=\"line\">            mValues[i] = DELETED;</span><br><span class=\"line\">            <span class=\"comment\">// 需要回收</span></span><br><span class=\"line\">            mGarbage = <span class=\"literal\">true</span>;                                    </span><br><span class=\"line\">        &#125;                                                       </span><br><span class=\"line\">    &#125;                                                           </span><br><span class=\"line\">&#125;                                                               </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"size\"><a href=\"#size\" class=\"headerlink\" title=\"size\"></a>size</h4><p>调用 <code>size</code> 之后，会先检查是否需要 <code>gc</code> 即回收操作</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">size</span><span class=\"params\">()</span> &#123;   </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mGarbage) &#123;   </span><br><span class=\"line\">        gc();         </span><br><span class=\"line\">    &#125;                 </span><br><span class=\"line\">                      </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mSize;     </span><br><span class=\"line\">&#125;                     </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"gc\"><a href=\"#gc\" class=\"headerlink\" title=\"gc\"></a>gc</h4><p>在调用 <code>size</code> 和涉及 index 相关的方法时，都会检查是否需要 <code>gc</code>，比如 <code>keyAt</code> 等</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">gc</span><span class=\"params\">()</span> &#123;                                          </span><br><span class=\"line\">    <span class=\"comment\">// Log.e(&quot;SparseArray&quot;, &quot;gc start with &quot; + mSize);       </span></span><br><span class=\"line\">                                                             </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> mSize;                                           </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">o</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;                                               </span><br><span class=\"line\">    <span class=\"type\">int</span>[] keys = mKeys;                                      </span><br><span class=\"line\">    Object[] values = mValues;                               </span><br><span class=\"line\">                                                             </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; n; i++) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 将没有标记为 DELETED 的条目移到新位置，清除 DELETED</span></span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">val</span> <span class=\"operator\">=</span> values[i];                              </span><br><span class=\"line\">                                                             </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (val != DELETED) &#123;                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i != o) &#123;</span><br><span class=\"line\">                keys[o] = keys[i];                           </span><br><span class=\"line\">                values[o] = val;                             </span><br><span class=\"line\">                values[i] = <span class=\"literal\">null</span>;                            </span><br><span class=\"line\">            &#125;                                                </span><br><span class=\"line\">                                                             </span><br><span class=\"line\">            o++;                                             </span><br><span class=\"line\">        &#125;                                                    </span><br><span class=\"line\">    &#125;                                                        </span><br><span class=\"line\">                                                             </span><br><span class=\"line\">    mGarbage = <span class=\"literal\">false</span>;                                        </span><br><span class=\"line\">    mSize = o;                                               </span><br><span class=\"line\">                                                             </span><br><span class=\"line\">    <span class=\"comment\">// Log.e(&quot;SparseArray&quot;, &quot;gc end with &quot; + mSize);         </span></span><br><span class=\"line\">&#125;                                                            </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p><code>SparseArray</code> 是用两个数组来分别存储 key 和 value，其中 key 是 <code>int[]</code> 避免了自动装箱，同时是升序的，所以查找 key 可以使用二分查找，相对于 <code>HashMap</code> 更省内存，但检索速度更慢。在数据量较少的情况下，可以使用 <code>SparseArray</code> 代替 <code>HashMap</code></p>\n"},{"title":"Hello World","_content":"## 面朝大海，春暖花开\n\n从明天起，做一个幸福的人\n\n喂马、劈柴、周游世界\n\n从明天起，关心粮食和蔬菜\n\n我有一所房子，面朝大海，春暖花开\n\n\n\n从明天起，和每一个亲人通信\n\n告诉他们我的幸福\n\n那幸福的闪电告诉我的\n\n我将告诉每一个人\n\n\n\n给每一条河每一座山取一个温暖的名字\n\n陌生人，我也为你祝福\n\n愿你有一个灿烂的前程\n\n愿你有情人总成眷属\n\n愿你在尘世获得幸福\n\n我只愿面朝大海，春暖花开\n","source":"_posts/hello-world.md","raw":"---\ntitle: Hello World\ncategories: 随笔\n---\n## 面朝大海，春暖花开\n\n从明天起，做一个幸福的人\n\n喂马、劈柴、周游世界\n\n从明天起，关心粮食和蔬菜\n\n我有一所房子，面朝大海，春暖花开\n\n\n\n从明天起，和每一个亲人通信\n\n告诉他们我的幸福\n\n那幸福的闪电告诉我的\n\n我将告诉每一个人\n\n\n\n给每一条河每一座山取一个温暖的名字\n\n陌生人，我也为你祝福\n\n愿你有一个灿烂的前程\n\n愿你有情人总成眷属\n\n愿你在尘世获得幸福\n\n我只愿面朝大海，春暖花开\n","slug":"hello-world","published":1,"date":"2022-06-15T11:19:32.322Z","updated":"2022-06-15T11:19:32.322Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlg000ffho67kkj4pxu","content":"<h2 id=\"面朝大海，春暖花开\"><a href=\"#面朝大海，春暖花开\" class=\"headerlink\" title=\"面朝大海，春暖花开\"></a>面朝大海，春暖花开</h2><p>从明天起，做一个幸福的人</p>\n<p>喂马、劈柴、周游世界</p>\n<p>从明天起，关心粮食和蔬菜</p>\n<p>我有一所房子，面朝大海，春暖花开</p>\n<p>从明天起，和每一个亲人通信</p>\n<p>告诉他们我的幸福</p>\n<p>那幸福的闪电告诉我的</p>\n<p>我将告诉每一个人</p>\n<p>给每一条河每一座山取一个温暖的名字</p>\n<p>陌生人，我也为你祝福</p>\n<p>愿你有一个灿烂的前程</p>\n<p>愿你有情人总成眷属</p>\n<p>愿你在尘世获得幸福</p>\n<p>我只愿面朝大海，春暖花开</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"面朝大海，春暖花开\"><a href=\"#面朝大海，春暖花开\" class=\"headerlink\" title=\"面朝大海，春暖花开\"></a>面朝大海，春暖花开</h2><p>从明天起，做一个幸福的人</p>\n<p>喂马、劈柴、周游世界</p>\n<p>从明天起，关心粮食和蔬菜</p>\n<p>我有一所房子，面朝大海，春暖花开</p>\n<p>从明天起，和每一个亲人通信</p>\n<p>告诉他们我的幸福</p>\n<p>那幸福的闪电告诉我的</p>\n<p>我将告诉每一个人</p>\n<p>给每一条河每一座山取一个温暖的名字</p>\n<p>陌生人，我也为你祝福</p>\n<p>愿你有一个灿烂的前程</p>\n<p>愿你有情人总成眷属</p>\n<p>愿你在尘世获得幸福</p>\n<p>我只愿面朝大海，春暖花开</p>\n"},{"title":"性能优化第一步","date":"2018-04-19T03:37:45.000Z","_content":"\n## 感谢\n\n[cpu-profiler](https://developer.android.com/studio/profile/cpu-profiler.html)\n\n## 前言\n\n对于有一定 Android 应用开发经验的同学来说，性能优化是避不开的话题，一般来说，Android 上我们常说的性能优化包括，内存优化和界面优化，当然还有电量优化、网络优化等等。性能优化知识的学习是一个长期的过程，也不可能通过一两篇文章就能说的清楚，需要在具有相关的理论知识的前提下，同时在日常开发中加以实践，才能在这方面的工作中得心应手。\n\n同时作者也并不是这方面的大牛，还处于入门学习的阶段，所以也会遇到初学者经常碰到的问题，其中，我个人认为阻碍初学者在这方面深入学习的一个原因是，大部分的文章都偏向于理论知识和工具使用说明，很多同学包括作者在看完这些文章，都有着似懂非懂的感觉，只记住了工具的名称，但等到自己去实际使用时，却不知道如何下手。这也是这个系列文章存在的意义，希望能通过实际例子去使用工具，从而能掌握工具基本的使用，之后在实际开发中，通过经常使用来达到得心应手的地步。\n\n## 例子\n\n作者最近刚接手一个新项目，在首页列表滑动时就感到有点不顺畅，特别是在滑动到有 ViewPager 部分的时候，如果是熟悉的项目，可能会第一时间会去检查代码，但前面说到这个是刚接手的项目，同时首页的代码逻辑比较复杂，不花点时间熟悉下代码可能很难找出问题来，那在这种情况下，我们就只能通过外部工具来检查，快速定位问题。\n\nAndroid Studio 提供了一个非常好用的工具：Android Profiler，基本可以满足大部分的场景了。所以下面的分析我们都基于 Android Profiler。\n\n为了更直观的观察问题，我创建了个 Demo，里面包含了问题代码，首先我们先通过两个 gif 图来看下，没有问题代码之前和加了问题代码之后的运行情况：\n\n![正常](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/source.gif?x-oss-process=style/doc-img)\n\n![问题代码](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/low.gif?x-oss-process=style/doc-img)\n\n上面的 gif 图中，我们先开启了 [GPU 呈现模式分析](https://github.com/LinXiaoTao/notes/blob/master/android/topic/performance/rendering/profile-gpu.md) 后面的文章中我们会说到这个，现在只需要了解横坐标表示应用绘制渲染的每一帧，纵坐标表示每一帧绘制渲染的时间，绿线表示 16.6 ms，也就是要想保持应用能够流畅使用，我们应该让页面绘制渲染时间尽量位于绿线之下。\n\n从第一张动图中可以看到页面每一帧的绘制渲染时间都基本处于绿线之下，而第二章动图加了问题代码之后，出现了不少帧出现了绘制渲染时间过长的情况。\n\n接下来，我们可以使用 Android Profiler 来对应用进行分析，在这个例子中，我们只使用 [cpu-profiler](https://developer.android.com/studio/profile/cpu-profiler.html) 功能。具体介绍可以看官方文档，下面就官方提供的图片简单说下：\n\n![cpu-profiler](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/cpu_profiler_L2-2X.png?x-oss-process=style/doc-img)\n\n这是 cpu-profiler 的主界面，具体各个部分的说明可以阅读官方文档，我们只需要知道这里记录了各个线程的活动状态：\n\n* 绿色：表示线程处于活动状态或准备使用 CPU。 即，它正在“运行中”或处于“可运行”状态。\n* 黄色：表示线程处于活动状态，但它正在等待一个 I/O 操作（如磁盘或网络 I/O），然后才能完成它的工作。\n* 灰色：表示线程正在休眠且没有消耗任何 CPU 时间。 当线程需要访问尚不可用的资源时偶尔会发生这种情况。 线程进入自主休眠或内核将此线程置于休眠状态，直到所需的资源可用。\n\n可以看到标记 5 为一个记录按钮，用于开始和停止记录[函数跟踪](https://developer.android.com/studio/profile/cpu-profiler.html#method_traces)。这个是我们这篇文章所要着重讲的功能，接下来我们看下函数跟踪的功能面板，图片同样来源于官方文档：\n\n![method-traces](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/cpu_profiler_L3-2X.png?x-oss-process=style/doc-img)\n\n使用方式很简单，先点击记录按钮，接着在应用上操作一小会，接着再次按下按钮，结束记录。上图则是记录后的面版：\n\n* 标记 1和标记 2 表示这次函数跟踪的时间段\n* 标记 3 表示函数跟踪的结果，具体展示跟标记 4 所选的展示标签有关\n* 标记 4 则是不同的展示标签\n* 标记 5 则是函数调用的时间信息：\n  * Wall clock time: 壁钟时间信息表示实际经过的时间\n  * Thread time: 线程时间信息表示实际经过的时间减去线程没有消耗 CPU 资源的任意时间部分。 对于任何给定函数，其线程时间始终少于或等于其壁钟时间。 使用线程时间可以让您更好地了解线程的实际 CPU 使用率中有多少是给定函数消耗的\n\n标记 4 中包含的标签包括：Call Chart、Flame Chart、Top Down 和 Bottom Up，具体的含义可以阅读[官方文档](https://developer.android.com/studio/profile/cpu-profiler.html#method_traces)，这里我们同样只是简单解释下：\n\n* Call Chart：函数调用情况的图形化界面。从上至下表示父函数和子函数的调用情况。\n\n  > 这里我们的父函数指的是，调用其他函数的函数，而被调用的函数称为该父函数的子函数。\n\n  ![call-chart](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/call-chart.png?x-oss-process=style/doc-img)\n\n  可以看到，应用的执行开始于 `ZygoteInit.main()` 其中系统 API 的调用表示为橙色，第三方 API 包括 Java 的调用表示为蓝色，应用自有函数的调用表示为绿色。\n\n* Flame Chart：提供一个倒置的调用图表，其汇总相同的调用堆栈，简单来说就是将 Call Chart 倒置过来\n\n  ![flame-chart](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/flame-chart.png?x-oss-process=style/doc-img)\n\n* Top Down：显示一个函数调用列表，在该列表中展开函数节点会被调用的子函数\n\n  ![top-down](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/top-down.png?x-oss-process=style/doc-img)\n\n* Bottom Up：显示一个函数调用列表，在该列表中展开函数节点将显示函数的父函数\n\n  ![bottom-up](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/bottom-up.png?x-oss-process=style/doc-img)\n\n简单了解每个选项的功能后，我们针对上面的 demo 来实践下，这里我们选择 bottom up 选项，从上面图看出，每个函数所展示的信息有：Total（函数总共花费的时间）、%（所占的百分比）、Self（函数自身花费的时间）、%（所占的百分比）、Children（函数所调用的子函数花费的时间），%（所占百分比）。可以看到 `main()` `run()` 这些方法的时间主要都是花费在调用子函数上。那么我们先找出本身最耗时的方法，使用 Self 进行排序：\n\n![max-self-method](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/max-self-method.png?x-oss-process=style/doc-img)\n\n很清楚的看出， `setConfiguration()` 函数是除了 `nativePollOnce()` 之外最耗时的函数，而 `nativePollOnce()` 是系统函数，是 Handle 用于阻塞获取栈中下一个执行的消息，具体可以看另外一篇文章，[Android消息机制-Handler](https://linxiaotao.github.io/2018/03/23/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-Handler/) 所以这个函数我们这里不需要关心它，所以我们打开 `setConfiguration()` 的父函数调用链，可以发现最终指到我们应用自身的函数，即 `MainActivity.getResources()` 这时候，我们就可以找到对应的类和函数，也可以使用快捷跳转方式：\t**Jump To Source**，我们看下具体的函数实现：\n\n``` java\n@Override                                                     \npublic Resources getResources() {                             \n    Resources res = super.getResources();                     \n    Configuration config = new Configuration();               \n    config.setToDefaults();                                   \n    res.updateConfiguration(config, res.getDisplayMetrics()); \n    return res;                                               \n}                                                             \n```\n\n从代码中可以看出，耗时函数就出在 `res.updateConfiguration()`，而 `getResources()` 会在比如 View 的构造函数中或者 inflate 布局时候被调用，我们上面的例子实现的是，使用 ViewPager 去实现图片滑动浏览的效果，ViewPager 在滑动的时候会调用 `instantiateItem()` 函数去生成新的 item：\n\n``` java\n@NonNull                                                                                                         \n@Override                                                                                                        \npublic Object instantiateItem(@NonNull ViewGroup container, int position) {                                      \n    final TextView childView = (TextView) View.inflate(container.getContext(), R.layout.item_image, null);       \n    childView.setText(String.valueOf(position));                                                                 \n    container.addView(childView);                                                                                \n    return childView;                                                                                            \n}                                                                                                                \n```\n\n这里会调用 `inflate()` 从 xml 布局文件中构建 View，而这个函数又会调用 `getResources()` 函数，最终调用到 `setConfiguration()` 上，这也是我们之所以在滑动的时候，会出现卡顿的原因。\n\n## 小结\n\n在上面的例子上，我们不需要去纠结为什么要重载 `getResources()` 而是通过这个例子达到能简单使用 cpu-profiler 的目的。\n\n当然你也可以使用其他工具来检查，比如 [method-trace](https://developer.android.com/studio/profile/am-methodtrace.html) 等等，但最终目的是一样的，找到耗时函数，从而去优化它。\n\n","source":"_posts/性能优化第一步.md","raw":"---\ntitle: 性能优化第一步\ndate: 2018-04-19 11:37:45\ncategories: Android\ntags: 性能优化\n---\n\n## 感谢\n\n[cpu-profiler](https://developer.android.com/studio/profile/cpu-profiler.html)\n\n## 前言\n\n对于有一定 Android 应用开发经验的同学来说，性能优化是避不开的话题，一般来说，Android 上我们常说的性能优化包括，内存优化和界面优化，当然还有电量优化、网络优化等等。性能优化知识的学习是一个长期的过程，也不可能通过一两篇文章就能说的清楚，需要在具有相关的理论知识的前提下，同时在日常开发中加以实践，才能在这方面的工作中得心应手。\n\n同时作者也并不是这方面的大牛，还处于入门学习的阶段，所以也会遇到初学者经常碰到的问题，其中，我个人认为阻碍初学者在这方面深入学习的一个原因是，大部分的文章都偏向于理论知识和工具使用说明，很多同学包括作者在看完这些文章，都有着似懂非懂的感觉，只记住了工具的名称，但等到自己去实际使用时，却不知道如何下手。这也是这个系列文章存在的意义，希望能通过实际例子去使用工具，从而能掌握工具基本的使用，之后在实际开发中，通过经常使用来达到得心应手的地步。\n\n## 例子\n\n作者最近刚接手一个新项目，在首页列表滑动时就感到有点不顺畅，特别是在滑动到有 ViewPager 部分的时候，如果是熟悉的项目，可能会第一时间会去检查代码，但前面说到这个是刚接手的项目，同时首页的代码逻辑比较复杂，不花点时间熟悉下代码可能很难找出问题来，那在这种情况下，我们就只能通过外部工具来检查，快速定位问题。\n\nAndroid Studio 提供了一个非常好用的工具：Android Profiler，基本可以满足大部分的场景了。所以下面的分析我们都基于 Android Profiler。\n\n为了更直观的观察问题，我创建了个 Demo，里面包含了问题代码，首先我们先通过两个 gif 图来看下，没有问题代码之前和加了问题代码之后的运行情况：\n\n![正常](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/source.gif?x-oss-process=style/doc-img)\n\n![问题代码](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/low.gif?x-oss-process=style/doc-img)\n\n上面的 gif 图中，我们先开启了 [GPU 呈现模式分析](https://github.com/LinXiaoTao/notes/blob/master/android/topic/performance/rendering/profile-gpu.md) 后面的文章中我们会说到这个，现在只需要了解横坐标表示应用绘制渲染的每一帧，纵坐标表示每一帧绘制渲染的时间，绿线表示 16.6 ms，也就是要想保持应用能够流畅使用，我们应该让页面绘制渲染时间尽量位于绿线之下。\n\n从第一张动图中可以看到页面每一帧的绘制渲染时间都基本处于绿线之下，而第二章动图加了问题代码之后，出现了不少帧出现了绘制渲染时间过长的情况。\n\n接下来，我们可以使用 Android Profiler 来对应用进行分析，在这个例子中，我们只使用 [cpu-profiler](https://developer.android.com/studio/profile/cpu-profiler.html) 功能。具体介绍可以看官方文档，下面就官方提供的图片简单说下：\n\n![cpu-profiler](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/cpu_profiler_L2-2X.png?x-oss-process=style/doc-img)\n\n这是 cpu-profiler 的主界面，具体各个部分的说明可以阅读官方文档，我们只需要知道这里记录了各个线程的活动状态：\n\n* 绿色：表示线程处于活动状态或准备使用 CPU。 即，它正在“运行中”或处于“可运行”状态。\n* 黄色：表示线程处于活动状态，但它正在等待一个 I/O 操作（如磁盘或网络 I/O），然后才能完成它的工作。\n* 灰色：表示线程正在休眠且没有消耗任何 CPU 时间。 当线程需要访问尚不可用的资源时偶尔会发生这种情况。 线程进入自主休眠或内核将此线程置于休眠状态，直到所需的资源可用。\n\n可以看到标记 5 为一个记录按钮，用于开始和停止记录[函数跟踪](https://developer.android.com/studio/profile/cpu-profiler.html#method_traces)。这个是我们这篇文章所要着重讲的功能，接下来我们看下函数跟踪的功能面板，图片同样来源于官方文档：\n\n![method-traces](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/cpu_profiler_L3-2X.png?x-oss-process=style/doc-img)\n\n使用方式很简单，先点击记录按钮，接着在应用上操作一小会，接着再次按下按钮，结束记录。上图则是记录后的面版：\n\n* 标记 1和标记 2 表示这次函数跟踪的时间段\n* 标记 3 表示函数跟踪的结果，具体展示跟标记 4 所选的展示标签有关\n* 标记 4 则是不同的展示标签\n* 标记 5 则是函数调用的时间信息：\n  * Wall clock time: 壁钟时间信息表示实际经过的时间\n  * Thread time: 线程时间信息表示实际经过的时间减去线程没有消耗 CPU 资源的任意时间部分。 对于任何给定函数，其线程时间始终少于或等于其壁钟时间。 使用线程时间可以让您更好地了解线程的实际 CPU 使用率中有多少是给定函数消耗的\n\n标记 4 中包含的标签包括：Call Chart、Flame Chart、Top Down 和 Bottom Up，具体的含义可以阅读[官方文档](https://developer.android.com/studio/profile/cpu-profiler.html#method_traces)，这里我们同样只是简单解释下：\n\n* Call Chart：函数调用情况的图形化界面。从上至下表示父函数和子函数的调用情况。\n\n  > 这里我们的父函数指的是，调用其他函数的函数，而被调用的函数称为该父函数的子函数。\n\n  ![call-chart](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/call-chart.png?x-oss-process=style/doc-img)\n\n  可以看到，应用的执行开始于 `ZygoteInit.main()` 其中系统 API 的调用表示为橙色，第三方 API 包括 Java 的调用表示为蓝色，应用自有函数的调用表示为绿色。\n\n* Flame Chart：提供一个倒置的调用图表，其汇总相同的调用堆栈，简单来说就是将 Call Chart 倒置过来\n\n  ![flame-chart](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/flame-chart.png?x-oss-process=style/doc-img)\n\n* Top Down：显示一个函数调用列表，在该列表中展开函数节点会被调用的子函数\n\n  ![top-down](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/top-down.png?x-oss-process=style/doc-img)\n\n* Bottom Up：显示一个函数调用列表，在该列表中展开函数节点将显示函数的父函数\n\n  ![bottom-up](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/bottom-up.png?x-oss-process=style/doc-img)\n\n简单了解每个选项的功能后，我们针对上面的 demo 来实践下，这里我们选择 bottom up 选项，从上面图看出，每个函数所展示的信息有：Total（函数总共花费的时间）、%（所占的百分比）、Self（函数自身花费的时间）、%（所占的百分比）、Children（函数所调用的子函数花费的时间），%（所占百分比）。可以看到 `main()` `run()` 这些方法的时间主要都是花费在调用子函数上。那么我们先找出本身最耗时的方法，使用 Self 进行排序：\n\n![max-self-method](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/max-self-method.png?x-oss-process=style/doc-img)\n\n很清楚的看出， `setConfiguration()` 函数是除了 `nativePollOnce()` 之外最耗时的函数，而 `nativePollOnce()` 是系统函数，是 Handle 用于阻塞获取栈中下一个执行的消息，具体可以看另外一篇文章，[Android消息机制-Handler](https://linxiaotao.github.io/2018/03/23/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-Handler/) 所以这个函数我们这里不需要关心它，所以我们打开 `setConfiguration()` 的父函数调用链，可以发现最终指到我们应用自身的函数，即 `MainActivity.getResources()` 这时候，我们就可以找到对应的类和函数，也可以使用快捷跳转方式：\t**Jump To Source**，我们看下具体的函数实现：\n\n``` java\n@Override                                                     \npublic Resources getResources() {                             \n    Resources res = super.getResources();                     \n    Configuration config = new Configuration();               \n    config.setToDefaults();                                   \n    res.updateConfiguration(config, res.getDisplayMetrics()); \n    return res;                                               \n}                                                             \n```\n\n从代码中可以看出，耗时函数就出在 `res.updateConfiguration()`，而 `getResources()` 会在比如 View 的构造函数中或者 inflate 布局时候被调用，我们上面的例子实现的是，使用 ViewPager 去实现图片滑动浏览的效果，ViewPager 在滑动的时候会调用 `instantiateItem()` 函数去生成新的 item：\n\n``` java\n@NonNull                                                                                                         \n@Override                                                                                                        \npublic Object instantiateItem(@NonNull ViewGroup container, int position) {                                      \n    final TextView childView = (TextView) View.inflate(container.getContext(), R.layout.item_image, null);       \n    childView.setText(String.valueOf(position));                                                                 \n    container.addView(childView);                                                                                \n    return childView;                                                                                            \n}                                                                                                                \n```\n\n这里会调用 `inflate()` 从 xml 布局文件中构建 View，而这个函数又会调用 `getResources()` 函数，最终调用到 `setConfiguration()` 上，这也是我们之所以在滑动的时候，会出现卡顿的原因。\n\n## 小结\n\n在上面的例子上，我们不需要去纠结为什么要重载 `getResources()` 而是通过这个例子达到能简单使用 cpu-profiler 的目的。\n\n当然你也可以使用其他工具来检查，比如 [method-trace](https://developer.android.com/studio/profile/am-methodtrace.html) 等等，但最终目的是一样的，找到耗时函数，从而去优化它。\n\n","slug":"性能优化第一步","published":1,"updated":"2022-06-15T11:19:32.324Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlg000gfho6azn98ds1","content":"<h2 id=\"感谢\"><a href=\"#感谢\" class=\"headerlink\" title=\"感谢\"></a>感谢</h2><p><a href=\"https://developer.android.com/studio/profile/cpu-profiler.html\">cpu-profiler</a></p>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>对于有一定 Android 应用开发经验的同学来说，性能优化是避不开的话题，一般来说，Android 上我们常说的性能优化包括，内存优化和界面优化，当然还有电量优化、网络优化等等。性能优化知识的学习是一个长期的过程，也不可能通过一两篇文章就能说的清楚，需要在具有相关的理论知识的前提下，同时在日常开发中加以实践，才能在这方面的工作中得心应手。</p>\n<p>同时作者也并不是这方面的大牛，还处于入门学习的阶段，所以也会遇到初学者经常碰到的问题，其中，我个人认为阻碍初学者在这方面深入学习的一个原因是，大部分的文章都偏向于理论知识和工具使用说明，很多同学包括作者在看完这些文章，都有着似懂非懂的感觉，只记住了工具的名称，但等到自己去实际使用时，却不知道如何下手。这也是这个系列文章存在的意义，希望能通过实际例子去使用工具，从而能掌握工具基本的使用，之后在实际开发中，通过经常使用来达到得心应手的地步。</p>\n<h2 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h2><p>作者最近刚接手一个新项目，在首页列表滑动时就感到有点不顺畅，特别是在滑动到有 ViewPager 部分的时候，如果是熟悉的项目，可能会第一时间会去检查代码，但前面说到这个是刚接手的项目，同时首页的代码逻辑比较复杂，不花点时间熟悉下代码可能很难找出问题来，那在这种情况下，我们就只能通过外部工具来检查，快速定位问题。</p>\n<p>Android Studio 提供了一个非常好用的工具：Android Profiler，基本可以满足大部分的场景了。所以下面的分析我们都基于 Android Profiler。</p>\n<p>为了更直观的观察问题，我创建了个 Demo，里面包含了问题代码，首先我们先通过两个 gif 图来看下，没有问题代码之前和加了问题代码之后的运行情况：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/source.gif?x-oss-process=style/doc-img\" alt=\"正常\"></p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/low.gif?x-oss-process=style/doc-img\" alt=\"问题代码\"></p>\n<p>上面的 gif 图中，我们先开启了 <a href=\"https://github.com/LinXiaoTao/notes/blob/master/android/topic/performance/rendering/profile-gpu.md\">GPU 呈现模式分析</a> 后面的文章中我们会说到这个，现在只需要了解横坐标表示应用绘制渲染的每一帧，纵坐标表示每一帧绘制渲染的时间，绿线表示 16.6 ms，也就是要想保持应用能够流畅使用，我们应该让页面绘制渲染时间尽量位于绿线之下。</p>\n<p>从第一张动图中可以看到页面每一帧的绘制渲染时间都基本处于绿线之下，而第二章动图加了问题代码之后，出现了不少帧出现了绘制渲染时间过长的情况。</p>\n<p>接下来，我们可以使用 Android Profiler 来对应用进行分析，在这个例子中，我们只使用 <a href=\"https://developer.android.com/studio/profile/cpu-profiler.html\">cpu-profiler</a> 功能。具体介绍可以看官方文档，下面就官方提供的图片简单说下：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/cpu_profiler_L2-2X.png?x-oss-process=style/doc-img\" alt=\"cpu-profiler\"></p>\n<p>这是 cpu-profiler 的主界面，具体各个部分的说明可以阅读官方文档，我们只需要知道这里记录了各个线程的活动状态：</p>\n<ul>\n<li>绿色：表示线程处于活动状态或准备使用 CPU。 即，它正在“运行中”或处于“可运行”状态。</li>\n<li>黄色：表示线程处于活动状态，但它正在等待一个 I&#x2F;O 操作（如磁盘或网络 I&#x2F;O），然后才能完成它的工作。</li>\n<li>灰色：表示线程正在休眠且没有消耗任何 CPU 时间。 当线程需要访问尚不可用的资源时偶尔会发生这种情况。 线程进入自主休眠或内核将此线程置于休眠状态，直到所需的资源可用。</li>\n</ul>\n<p>可以看到标记 5 为一个记录按钮，用于开始和停止记录<a href=\"https://developer.android.com/studio/profile/cpu-profiler.html#method_traces\">函数跟踪</a>。这个是我们这篇文章所要着重讲的功能，接下来我们看下函数跟踪的功能面板，图片同样来源于官方文档：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/cpu_profiler_L3-2X.png?x-oss-process=style/doc-img\" alt=\"method-traces\"></p>\n<p>使用方式很简单，先点击记录按钮，接着在应用上操作一小会，接着再次按下按钮，结束记录。上图则是记录后的面版：</p>\n<ul>\n<li>标记 1和标记 2 表示这次函数跟踪的时间段</li>\n<li>标记 3 表示函数跟踪的结果，具体展示跟标记 4 所选的展示标签有关</li>\n<li>标记 4 则是不同的展示标签</li>\n<li>标记 5 则是函数调用的时间信息：<ul>\n<li>Wall clock time: 壁钟时间信息表示实际经过的时间</li>\n<li>Thread time: 线程时间信息表示实际经过的时间减去线程没有消耗 CPU 资源的任意时间部分。 对于任何给定函数，其线程时间始终少于或等于其壁钟时间。 使用线程时间可以让您更好地了解线程的实际 CPU 使用率中有多少是给定函数消耗的</li>\n</ul>\n</li>\n</ul>\n<p>标记 4 中包含的标签包括：Call Chart、Flame Chart、Top Down 和 Bottom Up，具体的含义可以阅读<a href=\"https://developer.android.com/studio/profile/cpu-profiler.html#method_traces\">官方文档</a>，这里我们同样只是简单解释下：</p>\n<ul>\n<li><p>Call Chart：函数调用情况的图形化界面。从上至下表示父函数和子函数的调用情况。</p>\n<blockquote>\n<p>这里我们的父函数指的是，调用其他函数的函数，而被调用的函数称为该父函数的子函数。</p>\n</blockquote>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/call-chart.png?x-oss-process=style/doc-img\" alt=\"call-chart\"></p>\n<p>可以看到，应用的执行开始于 <code>ZygoteInit.main()</code> 其中系统 API 的调用表示为橙色，第三方 API 包括 Java 的调用表示为蓝色，应用自有函数的调用表示为绿色。</p>\n</li>\n<li><p>Flame Chart：提供一个倒置的调用图表，其汇总相同的调用堆栈，简单来说就是将 Call Chart 倒置过来</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/flame-chart.png?x-oss-process=style/doc-img\" alt=\"flame-chart\"></p>\n</li>\n<li><p>Top Down：显示一个函数调用列表，在该列表中展开函数节点会被调用的子函数</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/top-down.png?x-oss-process=style/doc-img\" alt=\"top-down\"></p>\n</li>\n<li><p>Bottom Up：显示一个函数调用列表，在该列表中展开函数节点将显示函数的父函数</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/bottom-up.png?x-oss-process=style/doc-img\" alt=\"bottom-up\"></p>\n</li>\n</ul>\n<p>简单了解每个选项的功能后，我们针对上面的 demo 来实践下，这里我们选择 bottom up 选项，从上面图看出，每个函数所展示的信息有：Total（函数总共花费的时间）、%（所占的百分比）、Self（函数自身花费的时间）、%（所占的百分比）、Children（函数所调用的子函数花费的时间），%（所占百分比）。可以看到 <code>main()</code> <code>run()</code> 这些方法的时间主要都是花费在调用子函数上。那么我们先找出本身最耗时的方法，使用 Self 进行排序：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/max-self-method.png?x-oss-process=style/doc-img\" alt=\"max-self-method\"></p>\n<p>很清楚的看出， <code>setConfiguration()</code> 函数是除了 <code>nativePollOnce()</code> 之外最耗时的函数，而 <code>nativePollOnce()</code> 是系统函数，是 Handle 用于阻塞获取栈中下一个执行的消息，具体可以看另外一篇文章，<a href=\"https://linxiaotao.github.io/2018/03/23/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-Handler/\">Android消息机制-Handler</a> 所以这个函数我们这里不需要关心它，所以我们打开 <code>setConfiguration()</code> 的父函数调用链，可以发现最终指到我们应用自身的函数，即 <code>MainActivity.getResources()</code> 这时候，我们就可以找到对应的类和函数，也可以使用快捷跳转方式：\t<strong>Jump To Source</strong>，我们看下具体的函数实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                     </span><br><span class=\"line\"><span class=\"keyword\">public</span> Resources <span class=\"title function_\">getResources</span><span class=\"params\">()</span> &#123;                             </span><br><span class=\"line\">    <span class=\"type\">Resources</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> <span class=\"built_in\">super</span>.getResources();                     </span><br><span class=\"line\">    <span class=\"type\">Configuration</span> <span class=\"variable\">config</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Configuration</span>();               </span><br><span class=\"line\">    config.setToDefaults();                                   </span><br><span class=\"line\">    res.updateConfiguration(config, res.getDisplayMetrics()); </span><br><span class=\"line\">    <span class=\"keyword\">return</span> res;                                               </span><br><span class=\"line\">&#125;                                                             </span><br></pre></td></tr></table></figure>\n\n<p>从代码中可以看出，耗时函数就出在 <code>res.updateConfiguration()</code>，而 <code>getResources()</code> 会在比如 View 的构造函数中或者 inflate 布局时候被调用，我们上面的例子实现的是，使用 ViewPager 去实现图片滑动浏览的效果，ViewPager 在滑动的时候会调用 <code>instantiateItem()</code> 函数去生成新的 item：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                                                                         </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                                        </span><br><span class=\"line\"><span class=\"keyword\">public</span> Object <span class=\"title function_\">instantiateItem</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> ViewGroup container, <span class=\"type\">int</span> position)</span> &#123;                                      </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">TextView</span> <span class=\"variable\">childView</span> <span class=\"operator\">=</span> (TextView) View.inflate(container.getContext(), R.layout.item_image, <span class=\"literal\">null</span>);       </span><br><span class=\"line\">    childView.setText(String.valueOf(position));                                                                 </span><br><span class=\"line\">    container.addView(childView);                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">return</span> childView;                                                                                            </span><br><span class=\"line\">&#125;                                                                                                                </span><br></pre></td></tr></table></figure>\n\n<p>这里会调用 <code>inflate()</code> 从 xml 布局文件中构建 View，而这个函数又会调用 <code>getResources()</code> 函数，最终调用到 <code>setConfiguration()</code> 上，这也是我们之所以在滑动的时候，会出现卡顿的原因。</p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><p>在上面的例子上，我们不需要去纠结为什么要重载 <code>getResources()</code> 而是通过这个例子达到能简单使用 cpu-profiler 的目的。</p>\n<p>当然你也可以使用其他工具来检查，比如 <a href=\"https://developer.android.com/studio/profile/am-methodtrace.html\">method-trace</a> 等等，但最终目的是一样的，找到耗时函数，从而去优化它。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"感谢\"><a href=\"#感谢\" class=\"headerlink\" title=\"感谢\"></a>感谢</h2><p><a href=\"https://developer.android.com/studio/profile/cpu-profiler.html\">cpu-profiler</a></p>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>对于有一定 Android 应用开发经验的同学来说，性能优化是避不开的话题，一般来说，Android 上我们常说的性能优化包括，内存优化和界面优化，当然还有电量优化、网络优化等等。性能优化知识的学习是一个长期的过程，也不可能通过一两篇文章就能说的清楚，需要在具有相关的理论知识的前提下，同时在日常开发中加以实践，才能在这方面的工作中得心应手。</p>\n<p>同时作者也并不是这方面的大牛，还处于入门学习的阶段，所以也会遇到初学者经常碰到的问题，其中，我个人认为阻碍初学者在这方面深入学习的一个原因是，大部分的文章都偏向于理论知识和工具使用说明，很多同学包括作者在看完这些文章，都有着似懂非懂的感觉，只记住了工具的名称，但等到自己去实际使用时，却不知道如何下手。这也是这个系列文章存在的意义，希望能通过实际例子去使用工具，从而能掌握工具基本的使用，之后在实际开发中，通过经常使用来达到得心应手的地步。</p>\n<h2 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h2><p>作者最近刚接手一个新项目，在首页列表滑动时就感到有点不顺畅，特别是在滑动到有 ViewPager 部分的时候，如果是熟悉的项目，可能会第一时间会去检查代码，但前面说到这个是刚接手的项目，同时首页的代码逻辑比较复杂，不花点时间熟悉下代码可能很难找出问题来，那在这种情况下，我们就只能通过外部工具来检查，快速定位问题。</p>\n<p>Android Studio 提供了一个非常好用的工具：Android Profiler，基本可以满足大部分的场景了。所以下面的分析我们都基于 Android Profiler。</p>\n<p>为了更直观的观察问题，我创建了个 Demo，里面包含了问题代码，首先我们先通过两个 gif 图来看下，没有问题代码之前和加了问题代码之后的运行情况：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/source.gif?x-oss-process=style/doc-img\" alt=\"正常\"></p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/low.gif?x-oss-process=style/doc-img\" alt=\"问题代码\"></p>\n<p>上面的 gif 图中，我们先开启了 <a href=\"https://github.com/LinXiaoTao/notes/blob/master/android/topic/performance/rendering/profile-gpu.md\">GPU 呈现模式分析</a> 后面的文章中我们会说到这个，现在只需要了解横坐标表示应用绘制渲染的每一帧，纵坐标表示每一帧绘制渲染的时间，绿线表示 16.6 ms，也就是要想保持应用能够流畅使用，我们应该让页面绘制渲染时间尽量位于绿线之下。</p>\n<p>从第一张动图中可以看到页面每一帧的绘制渲染时间都基本处于绿线之下，而第二章动图加了问题代码之后，出现了不少帧出现了绘制渲染时间过长的情况。</p>\n<p>接下来，我们可以使用 Android Profiler 来对应用进行分析，在这个例子中，我们只使用 <a href=\"https://developer.android.com/studio/profile/cpu-profiler.html\">cpu-profiler</a> 功能。具体介绍可以看官方文档，下面就官方提供的图片简单说下：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/cpu_profiler_L2-2X.png?x-oss-process=style/doc-img\" alt=\"cpu-profiler\"></p>\n<p>这是 cpu-profiler 的主界面，具体各个部分的说明可以阅读官方文档，我们只需要知道这里记录了各个线程的活动状态：</p>\n<ul>\n<li>绿色：表示线程处于活动状态或准备使用 CPU。 即，它正在“运行中”或处于“可运行”状态。</li>\n<li>黄色：表示线程处于活动状态，但它正在等待一个 I&#x2F;O 操作（如磁盘或网络 I&#x2F;O），然后才能完成它的工作。</li>\n<li>灰色：表示线程正在休眠且没有消耗任何 CPU 时间。 当线程需要访问尚不可用的资源时偶尔会发生这种情况。 线程进入自主休眠或内核将此线程置于休眠状态，直到所需的资源可用。</li>\n</ul>\n<p>可以看到标记 5 为一个记录按钮，用于开始和停止记录<a href=\"https://developer.android.com/studio/profile/cpu-profiler.html#method_traces\">函数跟踪</a>。这个是我们这篇文章所要着重讲的功能，接下来我们看下函数跟踪的功能面板，图片同样来源于官方文档：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/cpu_profiler_L3-2X.png?x-oss-process=style/doc-img\" alt=\"method-traces\"></p>\n<p>使用方式很简单，先点击记录按钮，接着在应用上操作一小会，接着再次按下按钮，结束记录。上图则是记录后的面版：</p>\n<ul>\n<li>标记 1和标记 2 表示这次函数跟踪的时间段</li>\n<li>标记 3 表示函数跟踪的结果，具体展示跟标记 4 所选的展示标签有关</li>\n<li>标记 4 则是不同的展示标签</li>\n<li>标记 5 则是函数调用的时间信息：<ul>\n<li>Wall clock time: 壁钟时间信息表示实际经过的时间</li>\n<li>Thread time: 线程时间信息表示实际经过的时间减去线程没有消耗 CPU 资源的任意时间部分。 对于任何给定函数，其线程时间始终少于或等于其壁钟时间。 使用线程时间可以让您更好地了解线程的实际 CPU 使用率中有多少是给定函数消耗的</li>\n</ul>\n</li>\n</ul>\n<p>标记 4 中包含的标签包括：Call Chart、Flame Chart、Top Down 和 Bottom Up，具体的含义可以阅读<a href=\"https://developer.android.com/studio/profile/cpu-profiler.html#method_traces\">官方文档</a>，这里我们同样只是简单解释下：</p>\n<ul>\n<li><p>Call Chart：函数调用情况的图形化界面。从上至下表示父函数和子函数的调用情况。</p>\n<blockquote>\n<p>这里我们的父函数指的是，调用其他函数的函数，而被调用的函数称为该父函数的子函数。</p>\n</blockquote>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/call-chart.png?x-oss-process=style/doc-img\" alt=\"call-chart\"></p>\n<p>可以看到，应用的执行开始于 <code>ZygoteInit.main()</code> 其中系统 API 的调用表示为橙色，第三方 API 包括 Java 的调用表示为蓝色，应用自有函数的调用表示为绿色。</p>\n</li>\n<li><p>Flame Chart：提供一个倒置的调用图表，其汇总相同的调用堆栈，简单来说就是将 Call Chart 倒置过来</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/flame-chart.png?x-oss-process=style/doc-img\" alt=\"flame-chart\"></p>\n</li>\n<li><p>Top Down：显示一个函数调用列表，在该列表中展开函数节点会被调用的子函数</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/top-down.png?x-oss-process=style/doc-img\" alt=\"top-down\"></p>\n</li>\n<li><p>Bottom Up：显示一个函数调用列表，在该列表中展开函数节点将显示函数的父函数</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/bottom-up.png?x-oss-process=style/doc-img\" alt=\"bottom-up\"></p>\n</li>\n</ul>\n<p>简单了解每个选项的功能后，我们针对上面的 demo 来实践下，这里我们选择 bottom up 选项，从上面图看出，每个函数所展示的信息有：Total（函数总共花费的时间）、%（所占的百分比）、Self（函数自身花费的时间）、%（所占的百分比）、Children（函数所调用的子函数花费的时间），%（所占百分比）。可以看到 <code>main()</code> <code>run()</code> 这些方法的时间主要都是花费在调用子函数上。那么我们先找出本身最耗时的方法，使用 Self 进行排序：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/max-self-method.png?x-oss-process=style/doc-img\" alt=\"max-self-method\"></p>\n<p>很清楚的看出， <code>setConfiguration()</code> 函数是除了 <code>nativePollOnce()</code> 之外最耗时的函数，而 <code>nativePollOnce()</code> 是系统函数，是 Handle 用于阻塞获取栈中下一个执行的消息，具体可以看另外一篇文章，<a href=\"https://linxiaotao.github.io/2018/03/23/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-Handler/\">Android消息机制-Handler</a> 所以这个函数我们这里不需要关心它，所以我们打开 <code>setConfiguration()</code> 的父函数调用链，可以发现最终指到我们应用自身的函数，即 <code>MainActivity.getResources()</code> 这时候，我们就可以找到对应的类和函数，也可以使用快捷跳转方式：\t<strong>Jump To Source</strong>，我们看下具体的函数实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                     </span><br><span class=\"line\"><span class=\"keyword\">public</span> Resources <span class=\"title function_\">getResources</span><span class=\"params\">()</span> &#123;                             </span><br><span class=\"line\">    <span class=\"type\">Resources</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> <span class=\"built_in\">super</span>.getResources();                     </span><br><span class=\"line\">    <span class=\"type\">Configuration</span> <span class=\"variable\">config</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Configuration</span>();               </span><br><span class=\"line\">    config.setToDefaults();                                   </span><br><span class=\"line\">    res.updateConfiguration(config, res.getDisplayMetrics()); </span><br><span class=\"line\">    <span class=\"keyword\">return</span> res;                                               </span><br><span class=\"line\">&#125;                                                             </span><br></pre></td></tr></table></figure>\n\n<p>从代码中可以看出，耗时函数就出在 <code>res.updateConfiguration()</code>，而 <code>getResources()</code> 会在比如 View 的构造函数中或者 inflate 布局时候被调用，我们上面的例子实现的是，使用 ViewPager 去实现图片滑动浏览的效果，ViewPager 在滑动的时候会调用 <code>instantiateItem()</code> 函数去生成新的 item：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@NonNull</span>                                                                                                         </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                                        </span><br><span class=\"line\"><span class=\"keyword\">public</span> Object <span class=\"title function_\">instantiateItem</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> ViewGroup container, <span class=\"type\">int</span> position)</span> &#123;                                      </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">TextView</span> <span class=\"variable\">childView</span> <span class=\"operator\">=</span> (TextView) View.inflate(container.getContext(), R.layout.item_image, <span class=\"literal\">null</span>);       </span><br><span class=\"line\">    childView.setText(String.valueOf(position));                                                                 </span><br><span class=\"line\">    container.addView(childView);                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">return</span> childView;                                                                                            </span><br><span class=\"line\">&#125;                                                                                                                </span><br></pre></td></tr></table></figure>\n\n<p>这里会调用 <code>inflate()</code> 从 xml 布局文件中构建 View，而这个函数又会调用 <code>getResources()</code> 函数，最终调用到 <code>setConfiguration()</code> 上，这也是我们之所以在滑动的时候，会出现卡顿的原因。</p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><p>在上面的例子上，我们不需要去纠结为什么要重载 <code>getResources()</code> 而是通过这个例子达到能简单使用 cpu-profiler 的目的。</p>\n<p>当然你也可以使用其他工具来检查，比如 <a href=\"https://developer.android.com/studio/profile/am-methodtrace.html\">method-trace</a> 等等，但最终目的是一样的，找到耗时函数，从而去优化它。</p>\n"},{"title":"解决Flutter版本不一致的flutterw","date":"2019-06-21T11:47:20.000Z","_content":"\n### 参考\n\n[Flutter 混合开发组件化与工程化架构](https://mp.weixin.qq.com/s/NK0RMuXM2_AJmAbnnvv9SA)\n\n### 前言\n开发 Flutter 应用的同学都知道，有个痛点就是如果是团队协作开发的话，就会存在使用的 Flutter 版本不一致的问题，就算只是个人开发，如果需要用 ci 打包的话，打包机上的版本也需要去保持一致，比如 A 同学在开发时，发现 Flutter 低版本有个 bug，升级到高版本就可以解决，但 B 同学并没有同步升级，这就导致在两方打出来的包不一样，如果这个 bug 不明显，那这里就会有很大的隐患，使用 ci 同理。\n\n### gradlew\n\n如果有使用 gradle 的同学会知道，在使用 gradle 构建应用时，会推荐使用 gradlew，这样会使用在 gradle-wrapper.properties 中配置的 gradle 版本，这就是解决了 gradle 版本差异的问题。\n\n### flutterw\n\n同理，我们也可以仿 gradle 这种做法写一个 flutterw 的脚本，我们用 flutterw 来代替 flutter 命令。\n首先我们先在 wrapper 目录下创建一个 flutter-wrapper.properties\n```\ndistributionUrl=https://github.com/flutter/flutter.git\nflutterVersion=1.6.6\nflutterChannel=dev\nandroidDir=.android\niosDir=.ios\n```\n上面三个不用解释，androidDir 和 iosDir 是用于指定在哪里生成 `flutter.sdk` 和 `FLUTTER_ROOT` 的配置，将 sdk 目录指向我们的固定版本的 Flutter SDK。接下来我们就可以使用 flutterw 来代替 flutter。\n\n![flutterw](https://user-gold-cdn.xitu.io/2019/6/21/16b77d5a2508de18?w=1212&h=470&f=png&s=859752)\n\n### 原理\n\nflutterw 的实现并不麻烦，首先我们从 flutter-wrapper.properties 读取配置，判断是否需要下载 Flutter SDK，我们会将 SDK 下载在 .flutter 目录下，接着判断是否需要切换版本，然后将我们的参数传递给 flutter 脚本，最后设置 SDK 目录。\n\n### 源码\n\n[github](https://github.com/LinXiaoTao/flutterw)\n\n这里我只实现了 sh 脚本，bat 版本后面有空再实现了，或者哪位大佬实现下，提个 PR，感激不尽。","source":"_posts/解决Flutter版本不一致的flutterw.md","raw":"---\ntitle: 解决Flutter版本不一致的flutterw\ndate: 2019-06-21 19:47:20\ncategories: Flutter\ntags:\n---\n\n### 参考\n\n[Flutter 混合开发组件化与工程化架构](https://mp.weixin.qq.com/s/NK0RMuXM2_AJmAbnnvv9SA)\n\n### 前言\n开发 Flutter 应用的同学都知道，有个痛点就是如果是团队协作开发的话，就会存在使用的 Flutter 版本不一致的问题，就算只是个人开发，如果需要用 ci 打包的话，打包机上的版本也需要去保持一致，比如 A 同学在开发时，发现 Flutter 低版本有个 bug，升级到高版本就可以解决，但 B 同学并没有同步升级，这就导致在两方打出来的包不一样，如果这个 bug 不明显，那这里就会有很大的隐患，使用 ci 同理。\n\n### gradlew\n\n如果有使用 gradle 的同学会知道，在使用 gradle 构建应用时，会推荐使用 gradlew，这样会使用在 gradle-wrapper.properties 中配置的 gradle 版本，这就是解决了 gradle 版本差异的问题。\n\n### flutterw\n\n同理，我们也可以仿 gradle 这种做法写一个 flutterw 的脚本，我们用 flutterw 来代替 flutter 命令。\n首先我们先在 wrapper 目录下创建一个 flutter-wrapper.properties\n```\ndistributionUrl=https://github.com/flutter/flutter.git\nflutterVersion=1.6.6\nflutterChannel=dev\nandroidDir=.android\niosDir=.ios\n```\n上面三个不用解释，androidDir 和 iosDir 是用于指定在哪里生成 `flutter.sdk` 和 `FLUTTER_ROOT` 的配置，将 sdk 目录指向我们的固定版本的 Flutter SDK。接下来我们就可以使用 flutterw 来代替 flutter。\n\n![flutterw](https://user-gold-cdn.xitu.io/2019/6/21/16b77d5a2508de18?w=1212&h=470&f=png&s=859752)\n\n### 原理\n\nflutterw 的实现并不麻烦，首先我们从 flutter-wrapper.properties 读取配置，判断是否需要下载 Flutter SDK，我们会将 SDK 下载在 .flutter 目录下，接着判断是否需要切换版本，然后将我们的参数传递给 flutter 脚本，最后设置 SDK 目录。\n\n### 源码\n\n[github](https://github.com/LinXiaoTao/flutterw)\n\n这里我只实现了 sh 脚本，bat 版本后面有空再实现了，或者哪位大佬实现下，提个 PR，感激不尽。","slug":"解决Flutter版本不一致的flutterw","published":1,"updated":"2022-06-15T11:19:32.328Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlh000hfho6b4si8fy1","content":"<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><p><a href=\"https://mp.weixin.qq.com/s/NK0RMuXM2_AJmAbnnvv9SA\">Flutter 混合开发组件化与工程化架构</a></p>\n<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>开发 Flutter 应用的同学都知道，有个痛点就是如果是团队协作开发的话，就会存在使用的 Flutter 版本不一致的问题，就算只是个人开发，如果需要用 ci 打包的话，打包机上的版本也需要去保持一致，比如 A 同学在开发时，发现 Flutter 低版本有个 bug，升级到高版本就可以解决，但 B 同学并没有同步升级，这就导致在两方打出来的包不一样，如果这个 bug 不明显，那这里就会有很大的隐患，使用 ci 同理。</p>\n<h3 id=\"gradlew\"><a href=\"#gradlew\" class=\"headerlink\" title=\"gradlew\"></a>gradlew</h3><p>如果有使用 gradle 的同学会知道，在使用 gradle 构建应用时，会推荐使用 gradlew，这样会使用在 gradle-wrapper.properties 中配置的 gradle 版本，这就是解决了 gradle 版本差异的问题。</p>\n<h3 id=\"flutterw\"><a href=\"#flutterw\" class=\"headerlink\" title=\"flutterw\"></a>flutterw</h3><p>同理，我们也可以仿 gradle 这种做法写一个 flutterw 的脚本，我们用 flutterw 来代替 flutter 命令。<br>首先我们先在 wrapper 目录下创建一个 flutter-wrapper.properties</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">distributionUrl=https://github.com/flutter/flutter.git</span><br><span class=\"line\">flutterVersion=1.6.6</span><br><span class=\"line\">flutterChannel=dev</span><br><span class=\"line\">androidDir=.android</span><br><span class=\"line\">iosDir=.ios</span><br></pre></td></tr></table></figure>\n<p>上面三个不用解释，androidDir 和 iosDir 是用于指定在哪里生成 <code>flutter.sdk</code> 和 <code>FLUTTER_ROOT</code> 的配置，将 sdk 目录指向我们的固定版本的 Flutter SDK。接下来我们就可以使用 flutterw 来代替 flutter。</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/6/21/16b77d5a2508de18?w=1212&h=470&f=png&s=859752\" alt=\"flutterw\"></p>\n<h3 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h3><p>flutterw 的实现并不麻烦，首先我们从 flutter-wrapper.properties 读取配置，判断是否需要下载 Flutter SDK，我们会将 SDK 下载在 .flutter 目录下，接着判断是否需要切换版本，然后将我们的参数传递给 flutter 脚本，最后设置 SDK 目录。</p>\n<h3 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h3><p><a href=\"https://github.com/LinXiaoTao/flutterw\">github</a></p>\n<p>这里我只实现了 sh 脚本，bat 版本后面有空再实现了，或者哪位大佬实现下，提个 PR，感激不尽。</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><p><a href=\"https://mp.weixin.qq.com/s/NK0RMuXM2_AJmAbnnvv9SA\">Flutter 混合开发组件化与工程化架构</a></p>\n<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>开发 Flutter 应用的同学都知道，有个痛点就是如果是团队协作开发的话，就会存在使用的 Flutter 版本不一致的问题，就算只是个人开发，如果需要用 ci 打包的话，打包机上的版本也需要去保持一致，比如 A 同学在开发时，发现 Flutter 低版本有个 bug，升级到高版本就可以解决，但 B 同学并没有同步升级，这就导致在两方打出来的包不一样，如果这个 bug 不明显，那这里就会有很大的隐患，使用 ci 同理。</p>\n<h3 id=\"gradlew\"><a href=\"#gradlew\" class=\"headerlink\" title=\"gradlew\"></a>gradlew</h3><p>如果有使用 gradle 的同学会知道，在使用 gradle 构建应用时，会推荐使用 gradlew，这样会使用在 gradle-wrapper.properties 中配置的 gradle 版本，这就是解决了 gradle 版本差异的问题。</p>\n<h3 id=\"flutterw\"><a href=\"#flutterw\" class=\"headerlink\" title=\"flutterw\"></a>flutterw</h3><p>同理，我们也可以仿 gradle 这种做法写一个 flutterw 的脚本，我们用 flutterw 来代替 flutter 命令。<br>首先我们先在 wrapper 目录下创建一个 flutter-wrapper.properties</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">distributionUrl=https://github.com/flutter/flutter.git</span><br><span class=\"line\">flutterVersion=1.6.6</span><br><span class=\"line\">flutterChannel=dev</span><br><span class=\"line\">androidDir=.android</span><br><span class=\"line\">iosDir=.ios</span><br></pre></td></tr></table></figure>\n<p>上面三个不用解释，androidDir 和 iosDir 是用于指定在哪里生成 <code>flutter.sdk</code> 和 <code>FLUTTER_ROOT</code> 的配置，将 sdk 目录指向我们的固定版本的 Flutter SDK。接下来我们就可以使用 flutterw 来代替 flutter。</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/6/21/16b77d5a2508de18?w=1212&h=470&f=png&s=859752\" alt=\"flutterw\"></p>\n<h3 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h3><p>flutterw 的实现并不麻烦，首先我们从 flutter-wrapper.properties 读取配置，判断是否需要下载 Flutter SDK，我们会将 SDK 下载在 .flutter 目录下，接着判断是否需要切换版本，然后将我们的参数传递给 flutter 脚本，最后设置 SDK 目录。</p>\n<h3 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h3><p><a href=\"https://github.com/LinXiaoTao/flutterw\">github</a></p>\n<p>这里我只实现了 sh 脚本，bat 版本后面有空再实现了，或者哪位大佬实现下，提个 PR，感激不尽。</p>\n"},{"title":"灵活使用位运算符","date":"2018-09-08T07:26:00.000Z","_content":"\n### 复习\n\n#### 移位运算\n\n* \"<<\" 左移：右边空出的位上补 0，相当于乘以 2\n* \">>\" 右移：左边空出的位上，如果正数，则补 0，否则，可能补 0 或者 1，取决于计算机系统。正数情况下，相当于除以 2\n* \">>>\" 无符号右移：左边空出的位上一律补上 0，相当于除以 2\n\n#### 位运算符\n\n* & 与运算符：两个操作数相同位上同时为 1，结果数相同位上才为 1\n* | 或运算符：两个操作数相同位上只要有一个为 1，结果数相同位上就为 1\n* ^ 异或运算符：两个操作数相同位上不相同，结果数相同位上才为 1\n\n### 灵活使用\n\n#### 状态管理\n\n1. 清除特定位（即设置为 0）\n\n   mask 特定位为 0，其他位为 1：s = s & mask\n\n2. 获取指定位\n\n   mask 特定位为 1，其他位为 0：r = s & mask\n\n3. 设置特定位（即设置为 1）\n\n   mask 特定位为 1，其他位为 0：s = s | mask\n\n4. 特定位取反\n\n   mask 特定位置为 1,其他位为 0：s = s ^ mask\n\n#### 交换变量\n\na ^= b;\n\nb ^= a;\n\na ^= b;\n\n#### 判断奇偶\n\na & 1 = 0 偶数\n\na & 1 = 1 奇数\n\n#### 取模\n\na % (2^n) = a & (2^n -1);\n\n2^n - 1 刚好是最高位 1 变成 0，剩下的低位 0 变成 1","source":"_posts/灵活使用位运算符.md","raw":"---\ntitle: 灵活使用位运算符\ndate: 2018-09-08 15:26:00\ncategories: Java\ntags:\n---\n\n### 复习\n\n#### 移位运算\n\n* \"<<\" 左移：右边空出的位上补 0，相当于乘以 2\n* \">>\" 右移：左边空出的位上，如果正数，则补 0，否则，可能补 0 或者 1，取决于计算机系统。正数情况下，相当于除以 2\n* \">>>\" 无符号右移：左边空出的位上一律补上 0，相当于除以 2\n\n#### 位运算符\n\n* & 与运算符：两个操作数相同位上同时为 1，结果数相同位上才为 1\n* | 或运算符：两个操作数相同位上只要有一个为 1，结果数相同位上就为 1\n* ^ 异或运算符：两个操作数相同位上不相同，结果数相同位上才为 1\n\n### 灵活使用\n\n#### 状态管理\n\n1. 清除特定位（即设置为 0）\n\n   mask 特定位为 0，其他位为 1：s = s & mask\n\n2. 获取指定位\n\n   mask 特定位为 1，其他位为 0：r = s & mask\n\n3. 设置特定位（即设置为 1）\n\n   mask 特定位为 1，其他位为 0：s = s | mask\n\n4. 特定位取反\n\n   mask 特定位置为 1,其他位为 0：s = s ^ mask\n\n#### 交换变量\n\na ^= b;\n\nb ^= a;\n\na ^= b;\n\n#### 判断奇偶\n\na & 1 = 0 偶数\n\na & 1 = 1 奇数\n\n#### 取模\n\na % (2^n) = a & (2^n -1);\n\n2^n - 1 刚好是最高位 1 变成 0，剩下的低位 0 变成 1","slug":"灵活使用位运算符","published":1,"updated":"2022-06-15T11:19:32.327Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlh000ifho66xeyfq4z","content":"<h3 id=\"复习\"><a href=\"#复习\" class=\"headerlink\" title=\"复习\"></a>复习</h3><h4 id=\"移位运算\"><a href=\"#移位运算\" class=\"headerlink\" title=\"移位运算\"></a>移位运算</h4><ul>\n<li>“&lt;&lt;” 左移：右边空出的位上补 0，相当于乘以 2</li>\n<li>“&gt;&gt;” 右移：左边空出的位上，如果正数，则补 0，否则，可能补 0 或者 1，取决于计算机系统。正数情况下，相当于除以 2</li>\n<li>“&gt;&gt;&gt;” 无符号右移：左边空出的位上一律补上 0，相当于除以 2</li>\n</ul>\n<h4 id=\"位运算符\"><a href=\"#位运算符\" class=\"headerlink\" title=\"位运算符\"></a>位运算符</h4><ul>\n<li>&amp; 与运算符：两个操作数相同位上同时为 1，结果数相同位上才为 1</li>\n<li>| 或运算符：两个操作数相同位上只要有一个为 1，结果数相同位上就为 1</li>\n<li>^ 异或运算符：两个操作数相同位上不相同，结果数相同位上才为 1</li>\n</ul>\n<h3 id=\"灵活使用\"><a href=\"#灵活使用\" class=\"headerlink\" title=\"灵活使用\"></a>灵活使用</h3><h4 id=\"状态管理\"><a href=\"#状态管理\" class=\"headerlink\" title=\"状态管理\"></a>状态管理</h4><ol>\n<li><p>清除特定位（即设置为 0）</p>\n<p>mask 特定位为 0，其他位为 1：s &#x3D; s &amp; mask</p>\n</li>\n<li><p>获取指定位</p>\n<p>mask 特定位为 1，其他位为 0：r &#x3D; s &amp; mask</p>\n</li>\n<li><p>设置特定位（即设置为 1）</p>\n<p>mask 特定位为 1，其他位为 0：s &#x3D; s | mask</p>\n</li>\n<li><p>特定位取反</p>\n<p>mask 特定位置为 1,其他位为 0：s &#x3D; s ^ mask</p>\n</li>\n</ol>\n<h4 id=\"交换变量\"><a href=\"#交换变量\" class=\"headerlink\" title=\"交换变量\"></a>交换变量</h4><p>a ^&#x3D; b;</p>\n<p>b ^&#x3D; a;</p>\n<p>a ^&#x3D; b;</p>\n<h4 id=\"判断奇偶\"><a href=\"#判断奇偶\" class=\"headerlink\" title=\"判断奇偶\"></a>判断奇偶</h4><p>a &amp; 1 &#x3D; 0 偶数</p>\n<p>a &amp; 1 &#x3D; 1 奇数</p>\n<h4 id=\"取模\"><a href=\"#取模\" class=\"headerlink\" title=\"取模\"></a>取模</h4><p>a % (2^n) &#x3D; a &amp; (2^n -1);</p>\n<p>2^n - 1 刚好是最高位 1 变成 0，剩下的低位 0 变成 1</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"复习\"><a href=\"#复习\" class=\"headerlink\" title=\"复习\"></a>复习</h3><h4 id=\"移位运算\"><a href=\"#移位运算\" class=\"headerlink\" title=\"移位运算\"></a>移位运算</h4><ul>\n<li>“&lt;&lt;” 左移：右边空出的位上补 0，相当于乘以 2</li>\n<li>“&gt;&gt;” 右移：左边空出的位上，如果正数，则补 0，否则，可能补 0 或者 1，取决于计算机系统。正数情况下，相当于除以 2</li>\n<li>“&gt;&gt;&gt;” 无符号右移：左边空出的位上一律补上 0，相当于除以 2</li>\n</ul>\n<h4 id=\"位运算符\"><a href=\"#位运算符\" class=\"headerlink\" title=\"位运算符\"></a>位运算符</h4><ul>\n<li>&amp; 与运算符：两个操作数相同位上同时为 1，结果数相同位上才为 1</li>\n<li>| 或运算符：两个操作数相同位上只要有一个为 1，结果数相同位上就为 1</li>\n<li>^ 异或运算符：两个操作数相同位上不相同，结果数相同位上才为 1</li>\n</ul>\n<h3 id=\"灵活使用\"><a href=\"#灵活使用\" class=\"headerlink\" title=\"灵活使用\"></a>灵活使用</h3><h4 id=\"状态管理\"><a href=\"#状态管理\" class=\"headerlink\" title=\"状态管理\"></a>状态管理</h4><ol>\n<li><p>清除特定位（即设置为 0）</p>\n<p>mask 特定位为 0，其他位为 1：s &#x3D; s &amp; mask</p>\n</li>\n<li><p>获取指定位</p>\n<p>mask 特定位为 1，其他位为 0：r &#x3D; s &amp; mask</p>\n</li>\n<li><p>设置特定位（即设置为 1）</p>\n<p>mask 特定位为 1，其他位为 0：s &#x3D; s | mask</p>\n</li>\n<li><p>特定位取反</p>\n<p>mask 特定位置为 1,其他位为 0：s &#x3D; s ^ mask</p>\n</li>\n</ol>\n<h4 id=\"交换变量\"><a href=\"#交换变量\" class=\"headerlink\" title=\"交换变量\"></a>交换变量</h4><p>a ^&#x3D; b;</p>\n<p>b ^&#x3D; a;</p>\n<p>a ^&#x3D; b;</p>\n<h4 id=\"判断奇偶\"><a href=\"#判断奇偶\" class=\"headerlink\" title=\"判断奇偶\"></a>判断奇偶</h4><p>a &amp; 1 &#x3D; 0 偶数</p>\n<p>a &amp; 1 &#x3D; 1 奇数</p>\n<h4 id=\"取模\"><a href=\"#取模\" class=\"headerlink\" title=\"取模\"></a>取模</h4><p>a % (2^n) &#x3D; a &amp; (2^n -1);</p>\n<p>2^n - 1 刚好是最高位 1 变成 0，剩下的低位 0 变成 1</p>\n"},{"title":"AppPlugin中的Task-第一篇","date":"2018-11-12T02:26:03.000Z","_content":"\n### 前言\n\n在使用 Android Studio 以后，基本新的 Android 项目都是用 Gradle 作为构建工具，关于 Gradle 的介绍不在本文范畴，当新建一个 Android 项目时，默认只会有个 module 使用`com.android.application` 插件，Gradle 的核心在于 task，即从 java 源文件和资源文件编译成 apk 文件（编译过程），就是由一系列的 task 组成，task 可以相互依赖，比如最基本的 `Task.dependsOn()`，所以理解 Android 编译过程就是理解各个 task 的作用。\n\n> 本文涉及的源码：\n>\n> * com.android.tools.build:gradle:3.1.4\n> * gradle-api-4.4\n\n### AppPlugin\n\n`com.android.application` 的源码位于 `com.android.build.gradle.AppPlugin`，AppPlugin 继承于 BasePlugin，BasePlugin 封装了大部分通用的逻辑：\n\n``` java\n@Override                                                                                \npublic void apply(@NonNull Project project) {                                            \n    \n    // 省略初始化步骤\n    \n    if (!projectOptions.get(BooleanOption.ENABLE_NEW_DSL_AND_API)) {\n        // 不使用新的 DSL API\n        TaskInputHelper.enableBypass();                                                  \n        \n        // threadRecorder 用于记录执行时间\n        \n        // configureProject 配置项目\n        threadRecorder.record(                                                           \n                ExecutionType.BASE_PLUGIN_PROJECT_CONFIGURE,                             \n                project.getPath(),                                                       \n                null,                                                                    \n                this::configureProject);                                                 \n        \n        // configureExtension 配置 Extension 后，我们才能使用 android {} 进行配置\n        threadRecorder.record(                                                           \n                ExecutionType.BASE_PLUGIN_PROJECT_BASE_EXTENSION_CREATION,               \n                project.getPath(),                                                       \n                null,                                                                    \n                this::configureExtension);                                               \n        \n        // createTasks 本文的重点，创建必须的 task\n        threadRecorder.record(                                                           \n                ExecutionType.BASE_PLUGIN_PROJECT_TASKS_CREATION,                        \n                project.getPath(),                                                       \n                null,                                                                    \n                this::createTasks);                                                      \n    } else {                                                                             \n         // 省略                   \n    }                                                                                    \n}                                                                                        \n```\n\n``` java\nprivate void createTasks() {\n    \n    // createTasksBeforeEvaluate\n    threadRecorder.record(                                                   \n            ExecutionType.TASK_MANAGER_CREATE_TASKS,                         \n            project.getPath(),                                               \n            null,                                                            \n            () -> taskManager.createTasksBeforeEvaluate());                  \n    \n    // afterEvaluate 执行\n    project.afterEvaluate(                                                   \n            project ->                                                       \n                    threadRecorder.record(                                   \n                            ExecutionType.BASE_PLUGIN_CREATE_ANDROID_TASKS,  \n                            project.getPath(),                               \n                            null,                                            \n                            () -> createAndroidTasks(false)));               \n}                                                                            \n```\n\n从 `createTasks()` 可以看到，`createAndroidTasks()` 是在 `afterEvaluate()` 中执行的，evaluate 是 Gradle  一个执行的过程\n\n> Gradle 编译的三个阶段：Initialization、Configuration、Execution。具体可以阅读 [build_lifecycle](https://docs.gradle.org/current/userguide/build_lifecycle.html)\n\n`createAndroidTasks()` 这个方法较长，但是我们关心的是 `VariantManager.createAndroidTasks()`\n\n``` java\npublic void createAndroidTasks() {                                                    \n    variantFactory.validateModel(this);                                               \n    variantFactory.preVariantWork(project);                                           \n                                                                                      \n    if (variantScopes.isEmpty()) {\n        // 创建 variantScopes\n        recorder.record(                                                              \n                ExecutionType.VARIANT_MANAGER_CREATE_VARIANTS,                        \n                project.getPath(),                                                    \n                null /*variantName*/,                                                 \n                this::populateVariantDataList);                                       \n    }                                                                                 \n                                                                                      \n    // Create top level test tasks.                                                   \n    recorder.record(                                                                  \n            ExecutionType.VARIANT_MANAGER_CREATE_TESTS_TASKS,                         \n            project.getPath(),                                                        \n            null /*variantName*/,                                                     \n            () -> taskManager.createTopLevelTestTasks(!productFlavors.isEmpty()));    \n                                                                                      \n                                                                                      \n                                                                                      \n    for (final VariantScope variantScope : variantScopes) {\n        // 为每个 variant 生成各自的 task\n        recorder.record(                                                              \n                ExecutionType.VARIANT_MANAGER_CREATE_TASKS_FOR_VARIANT,               \n                project.getPath(),                                                    \n                variantScope.getFullVariantName(),                                    \n                () -> createTasksForVariantData(variantScope));                       \n    }                                                                                 \n                                                                                      \n    taskManager.createReportTasks(variantScopes);                                     \n}                                                                                     \n```\n\n调用 `populateVariantDataList()` 来生成 VariantScopes，它是由 ProductFlavors、BuildType、VariantType 组合\n\n``` java\npublic void createTasksForVariantData(final VariantScope variantScope) {                                              \n    final BaseVariantData variantData = variantScope.getVariantData();                                                \n    final VariantType variantType = variantData.getType();                                                            \n                                                                                                                      \n    final GradleVariantConfiguration variantConfig = variantScope.getVariantConfiguration();                          \n                                                                                                                      \n    final BuildTypeData buildTypeData = buildTypes.get(variantConfig.getBuildType().getName());                       \n    if (buildTypeData.getAssembleTask() == null) {\n        // 创建 BuildType 的 assemble task\n        // 比如 assembleDebug 和 assembleRelease\n        buildTypeData.setAssembleTask(taskManager.createAssembleTask(buildTypeData));                                 \n    }                                                                                                                 \n                                                                                                                      \n    // Add dependency of assemble task on assemble build type task.\n    // assemble 依赖于 assembleDebug 和 assembleRelease\n    taskManager                                                                                                       \n            .getTaskFactory()                                                                                         \n            .configure(                                                                                               \n                    \"assemble\",                                                                                       \n                    task -> {                                                                                         \n                        assert buildTypeData.getAssembleTask() != null;                                               \n                        task.dependsOn(buildTypeData.getAssembleTask().getName());                                    \n                    });                                                                                               \n    \n    // 根据 variant 创建 assemble task\n    createAssembleTaskForVariantData(variantData);                                                                    \n    if (variantType.isForTesting()) {                                                                                 \n         // 省略代码                                                                       \n    } else {\n        // 根据 variant 创建 task\n        taskManager.createTasksForVariantScope(variantScope);                                                         \n    }                                                                                                                 \n}                                                                                                                     \n```\n\nassemble task 用于将源文件编译为最终产物，比如 jar、aar、apk 等，在 `createTasksForVariantData()` 中会生成对应 BuildType 的 assemble task，比如 `assembleDebug` 和 `assembleRelease` ，接着设置 `assemble` 依赖于这两个 task，最后根据 variant 生成对应的 assemble task，比如 `assembleTestDebug`\n\n``` java\nprivate void createAssembleTaskForVariantData(final BaseVariantData variantData) {                      \n    final VariantScope variantScope = variantData.getScope();                                           \n    if (variantData.getType().isForTesting()) {                                                         \n        variantScope.setAssembleTask(taskManager.createAssembleTask(variantData));                      \n    } else {                                                                                            \n        BuildTypeData buildTypeData =                                                                   \n                buildTypes.get(variantData.getVariantConfiguration().getBuildType().getName());         \n                                                                                                        \n        Preconditions.checkNotNull(buildTypeData.getAssembleTask());                                    \n                                                                                                        \n        if (productFlavors.isEmpty()) {                                                                 \n            // Reuse assemble task for build type if there is no product flavor.                        \n            variantScope.setAssembleTask(buildTypeData.getAssembleTask());                              \n                                                                                                        \n            variantData.addTask(                                                                        \n                    TaskContainer.TaskKind.ASSEMBLE, buildTypeData.getAssembleTask());                  \n        } else {\n            // 根据 variant 创建对应的 assemble task，比如 assembleTesDebug\n            variantScope.setAssembleTask(taskManager.createAssembleTask(variantData));                  \n                                                                                                        \n            // setup the task dependencies                                                              \n            // build type\n            // build type assemble task 依赖于 具体的 assemble task\n            buildTypeData.getAssembleTask().dependsOn(variantScope.getAssembleTask());                  \n                                                                                                        \n            // each flavor                                                                              \n            GradleVariantConfiguration variantConfig = variantData.getVariantConfiguration();           \n            for (CoreProductFlavor flavor : variantConfig.getProductFlavors()) {                        \n                ProductFlavorData productFlavorData = productFlavors.get(flavor.getName());             \n                                                                                                        \n                DefaultTask flavorAssembleTask = productFlavorData.getAssembleTask();                   \n                if (flavorAssembleTask == null) {\n                    // 创建 flavor 的 assemble task\n                    // 比如 assembleTes\n                    flavorAssembleTask = taskManager.createAssembleTask(productFlavorData);             \n                    productFlavorData.setAssembleTask(flavorAssembleTask);                              \n                }\n                // flavor assemble task 依赖于具体的 assemble task\n                flavorAssembleTask.dependsOn(variantScope.getAssembleTask());                           \n            }                                                                                           \n                                                                                                        \n            // assembleTask for this flavor(dimension), created on demand if needed.                    \n            if (variantConfig.getProductFlavors().size() > 1) {                                         \n                final String name = StringHelper.capitalize(variantConfig.getFlavorName());             \n                final String variantAssembleTaskName =                                                  \n                        StringHelper.appendCapitalized(\"assemble\", name);                               \n                if (!taskManager.getTaskFactory().containsKey(variantAssembleTaskName)) {               \n                    Task task = taskManager.getTaskFactory().create(variantAssembleTaskName);           \n                    task.setDescription(\"Assembles all builds for flavor combination: \" + name);        \n                    task.setGroup(\"Build\");                                                             \n                    task.dependsOn(variantScope.getAssembleTask().getName());                           \n                }                                                                                       \n                taskManager                                                                             \n                        .getTaskFactory()                                                               \n                        .configure(                                                                     \n                                \"assemble\", task1 -> task1.dependsOn(variantAssembleTaskName));         \n            }                                                                                           \n        }                                                                                               \n    }                                                                                                   \n}                                                                                                       \n```\n\n上面会生成包括 BuildType、Flavor、BuildType + Flavor + VariantType 的 assemble task，同时 task 之间存在依赖关系：`assemble > buildType/flavor > 具体 ` \n\n![assemble-task-demo](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/assemble-task-demo.png?x-oss-process=style/doc-img)\n\n除了上面所说的 assemble task，还将生成以下 task：\n\n| task                                            | impl                                | dependsOn                                                    |\n| ----------------------------------------------- | ----------------------------------- | ------------------------------------------------------------ |\n| assemble{variant}                               | DefaultTask                         | compile{variant}Sources，package{variant}                    |\n| pre{variant}Build                               | AppPreBuildTask                     | preBuild，extractProguardFiles(可能)                         |\n| extractProguardFiles                            | ExtractProguardFiles                |                                                              |\n| generate{variant}Sources                        | DefaultTask                         | compile{variant}Renderscript，generate{variant}BuildConfig，bundle{variant}Resources，compile{variant}Aidl |\n| generate{variant}Resources                      | DefaultTask                         | generate{variant}ResValues，compile{variant}Renderscript     |\n| generate{variant}Assets                         | DefaultTask                         | compile{variant}Shaders                                      |\n| compile{variant}Sources                         | DefaultTask                         | compile{variant}Ndk，compile{variant}JavaWithJavac           |\n| check{variant}Manifest                          | CheckManifest                       | pre{variant}Build                                            |\n| write{variant}ApplicationId                     | ApplicationIdIdWriteTask            |                                                              |\n| mainApkListPersistence{variant}                 | MainApkListPersistence              |                                                              |\n| reportBuildArtifacts{variant}                   | BuildArtifactReportTask             |                                                              |\n| create{variant}CompatibleScreenManifests        | CompatibleScreensManifest           |                                                              |\n| process{variant}Manifest                        | MergeManifests                      | check{variant}Manifest                                       |\n| generate{variant}ResValues                      | GenerateResValues                   |                                                              |\n| compile{variant}Renderscript                    | RenderscriptCompile                 | pre{variant}Build                                            |\n| merge{variant}Resources                         | MergeResources                      | generate{variant}Resources                                   |\n| merge{variant}Shaders                           | MergeSourceSetFolders               |                                                              |\n| compile{variant}Shaders                         | ShaderCompile                       | merge{variant}Shaders                                        |\n| merge{variant}Assets                            | MergeSourceSetFolders               | generate{variant}Assets                                      |\n| generate{variant}BuildConfig                    | GenerateBuildConfig                 | check{variant}Manifest                                       |\n| splitsDiscoveryTask{variant}                    | SplitsDiscovery                     |                                                              |\n| process{variant}JavaRes                         | Sync                                | pre{variant}Build                                            |\n| process{variant}Resources                       | LinkApplicationAndroidResourcesTask |                                                              |\n| bundle{variant}Resources                        | LinkAndroidResForBundleTask         |                                                              |\n| compile{variant}Aidl                            | AidlCompile                         | pre{variant}Build                                            |\n| compile{variant}Ndk                             | NdkCompile                          | pre{variant}Build                                            |\n| merge{variant}JniLibFolders                     | MergeSourceSetFolders               | generate{variant}Assets                                      |\n| javaPreCompile{variant}                         | JavaPreCompileTask                  | pre{variant}Build                                            |\n| compile{variant}JavaWithJavac                   | AndroidJavaCompile                  | generate{variant}Sources                                     |\n| bundleAppClasses{variant}                       | Jar                                 |                                                              |\n| transformResourcesWithMergeJavaResFor{variant}  | TransformTask                       |                                                              |\n| transformClassesWithMultidexlistFor{variant}    | TransformTask                       |                                                              |\n| transformClassesWithDexBuilderFor{variant}      | TransformTask                       |                                                              |\n| transformDexArchiveWithDexMergerFor{variant}    | TransformTask                       | transformClassesWithMultidexlistFor{variant}                 |\n| preparePUBLISHED_JAVA_RES{variant}ForPublishing | PipelineToPublicationTask           |                                                              |\n| package{variant}                                | PackageApplication                  | merge{variant}Assets，process{variant}Resources，validateSigning{variant}，compile{variant}JavaWithJavac |\n| validateSigning{variant}                        | ValidateSigningTask                 |                                                              |\n| install{variant}                                | InstallVariantTask                  | assemble{variant}                                            |\n| uninstall{variant}                              | UninstallTask                       |                                                              |\n| lint{variant}                                   | LintPerVariantTask                  |                                                              |\n\n以 `assembleProdRelease` 命令，依次执行的 task：\n\n> prod 是 product flavor\n\n```\npreBuild\nextractProguardFiles\npreProdReleaseBuild\ncompileProdReleaseRenderscript\ncheckProdReleaseManifest\ngenerateProdReleaseBuildConfig\nprepareLintJar\nmainApkListPersistenceProdRelease\ngenerateProdReleaseResValues\ngenerateProdReleaseResources\ncompileProdReleaseAidl\ncreateProdReleaseCompatibleScreenManifests\nprocessProdReleaseManifest\nmergeProdReleaseResources  // 合并资源\nsplitsDiscoveryTaskProdRelease\nprocessProdReleaseResources\ngenerateProdReleaseSources\njavaPreCompileProdRelease\ncompileProdReleaseJavaWithJavac // javac\ncompileProdReleaseNdk\ncompileProdReleaseSources\nmergeProdReleaseShaders\ncompileProdReleaseShaders\ngenerateProdReleaseAssets\nmergeProdReleaseAssets\ntransformClassesWithComponentCodeForProdRelease \nprocessProdReleaseJavaRes\ntransformResourcesWithMergeJavaResForProdRelease\ntransformClassesAndResourcesWithProguardForProdRelease // 混淆\ntransformClassesWithMultidexlistForProdRelease\ntransformClassesWithDexForProdRelease\t\t\t\t// dex\ntransformClassesWithShrinkResForProdRelease\nmergeProdReleaseJniLibFolders\ntransformNativeLibsWithMergeJniLibsForProdRelease\nvalidateSigningProdRelease\npackageProdRelease\n```\n\n接下来分析下比较重要的几个 task\n\n> 接下来的分析，因为对应的源码比较复杂，所以只会简短介绍结果，没有详细过程，推荐 debug 整个流程\n\n### CompileJavaWithJavac\n\n首先找到执行的 AndroidJavaCompile\n\n``` java\n// AndroidJavaCompile.java\n@Override                                                                                       \nprotected void compile(IncrementalTaskInputs inputs) {                                          \n    // compileSdkVersion >= 24，需要使用 jdk1.8                                                     \n    if (isPostN()) {                                                                            \n        if (!JavaVersion.current().isJava8Compatible()) {                                       \n            throw new RuntimeException(\"compileSdkVersion '\" + compileSdkVersion + \"' requires \"\n                    + \"JDK 1.8 or later to compile.\");                                          \n        }                                                                                       \n    }                                                                                           \n    \n    // 处理注解处理器，在之前 task 会将使用 annotationProcessor 标示的注解处理器写入到 annotationProcessors.json 中\n    processAnalytics();                                                                         \n                                                                                                \n    // Create directory for output of annotation processor.                                     \n    FileUtils.mkdirs(annotationProcessorOutputFolder);                                          \n                                                                                                \n    mInstantRunBuildContext.startRecording(InstantRunBuildContext.TaskType.JAVAC);\n    // 调用 JavaCompile.compile\n    super.compile(inputs);                                                                      \n    mInstantRunBuildContext.stopRecording(InstantRunBuildContext.TaskType.JAVAC);               \n}                                                                                               \n```\n\n``` java\n// JavaCompile.java\n@TaskAction                                                                                                                                                                                                                                                                                                           \nprotected void compile(IncrementalTaskInputs inputs) {\n    // 是否为增量编译\n    if (!this.compileOptions.isIncremental()) {\n        this.compile();                                                                                                                                                                                                                                                                                               \n    } else {                                                                                                                                                                                                                                                                                                          \n        DefaultJavaCompileSpec spec = this.createSpec();                                                                                                                                                                                                                                                              \n        CompileCaches compileCaches = this.createCompileCaches();                                                                                                                                                                                                                                                     \n        IncrementalCompilerFactory factory = new IncrementalCompilerFactory(this.getFileOperations(), this.getStreamHasher(), this.getCachingFileHasher(), this.getPath(), this.createCompiler(spec), this.source, compileCaches, (IncrementalTaskInputsInternal)inputs, this.getEffectiveAnnotationProcessorPath()); \n        Compiler<JavaCompileSpec> compiler = factory.createCompiler();                                                                                                                                                                                                                                                \n        this.performCompilation(spec, compiler);                                                                                                                                                                                                                                                                      \n    }                                                                                                                                                                                                                                                                                                                 \n}                                                                                                                                                                                                                                                                                                                     \n```\n\n不管是增量编译还是全量编译，最后都会调用 `performCompilation`\n\n``` java\nprivate void performCompilation(JavaCompileSpec spec, Compiler<JavaCompileSpec> compiler) {\n\t// 执行编译\n    WorkResult result = compiler.execute(spec);                                             \n    this.setDidWork(result.getDidWork());                                                   \n}                                                                                           \n```\n\nCompiler 采用**装饰者设计模式**，最外层是 `CleaningJavaCompilerSupport` 会先删除编译目录，再调用 `JdkJavaCompiler` 执行 `javac` 过程，具体为，创建一个 `JavacTaskImpl` 然后 JavacTask 会调用 `com.sun.tools.javac.main.Main` 进行处理，其中创建 JavacTask 的任务是由 `JavacTool` 完成\n\n","source":"_posts/AppPlugin中的Task-第一篇.md","raw":"---\ntitle: AppPlugin中的Task-第一篇\ndate: 2018-11-12 10:26:03\ncategories: Gradle\ntags:\n---\n\n### 前言\n\n在使用 Android Studio 以后，基本新的 Android 项目都是用 Gradle 作为构建工具，关于 Gradle 的介绍不在本文范畴，当新建一个 Android 项目时，默认只会有个 module 使用`com.android.application` 插件，Gradle 的核心在于 task，即从 java 源文件和资源文件编译成 apk 文件（编译过程），就是由一系列的 task 组成，task 可以相互依赖，比如最基本的 `Task.dependsOn()`，所以理解 Android 编译过程就是理解各个 task 的作用。\n\n> 本文涉及的源码：\n>\n> * com.android.tools.build:gradle:3.1.4\n> * gradle-api-4.4\n\n### AppPlugin\n\n`com.android.application` 的源码位于 `com.android.build.gradle.AppPlugin`，AppPlugin 继承于 BasePlugin，BasePlugin 封装了大部分通用的逻辑：\n\n``` java\n@Override                                                                                \npublic void apply(@NonNull Project project) {                                            \n    \n    // 省略初始化步骤\n    \n    if (!projectOptions.get(BooleanOption.ENABLE_NEW_DSL_AND_API)) {\n        // 不使用新的 DSL API\n        TaskInputHelper.enableBypass();                                                  \n        \n        // threadRecorder 用于记录执行时间\n        \n        // configureProject 配置项目\n        threadRecorder.record(                                                           \n                ExecutionType.BASE_PLUGIN_PROJECT_CONFIGURE,                             \n                project.getPath(),                                                       \n                null,                                                                    \n                this::configureProject);                                                 \n        \n        // configureExtension 配置 Extension 后，我们才能使用 android {} 进行配置\n        threadRecorder.record(                                                           \n                ExecutionType.BASE_PLUGIN_PROJECT_BASE_EXTENSION_CREATION,               \n                project.getPath(),                                                       \n                null,                                                                    \n                this::configureExtension);                                               \n        \n        // createTasks 本文的重点，创建必须的 task\n        threadRecorder.record(                                                           \n                ExecutionType.BASE_PLUGIN_PROJECT_TASKS_CREATION,                        \n                project.getPath(),                                                       \n                null,                                                                    \n                this::createTasks);                                                      \n    } else {                                                                             \n         // 省略                   \n    }                                                                                    \n}                                                                                        \n```\n\n``` java\nprivate void createTasks() {\n    \n    // createTasksBeforeEvaluate\n    threadRecorder.record(                                                   \n            ExecutionType.TASK_MANAGER_CREATE_TASKS,                         \n            project.getPath(),                                               \n            null,                                                            \n            () -> taskManager.createTasksBeforeEvaluate());                  \n    \n    // afterEvaluate 执行\n    project.afterEvaluate(                                                   \n            project ->                                                       \n                    threadRecorder.record(                                   \n                            ExecutionType.BASE_PLUGIN_CREATE_ANDROID_TASKS,  \n                            project.getPath(),                               \n                            null,                                            \n                            () -> createAndroidTasks(false)));               \n}                                                                            \n```\n\n从 `createTasks()` 可以看到，`createAndroidTasks()` 是在 `afterEvaluate()` 中执行的，evaluate 是 Gradle  一个执行的过程\n\n> Gradle 编译的三个阶段：Initialization、Configuration、Execution。具体可以阅读 [build_lifecycle](https://docs.gradle.org/current/userguide/build_lifecycle.html)\n\n`createAndroidTasks()` 这个方法较长，但是我们关心的是 `VariantManager.createAndroidTasks()`\n\n``` java\npublic void createAndroidTasks() {                                                    \n    variantFactory.validateModel(this);                                               \n    variantFactory.preVariantWork(project);                                           \n                                                                                      \n    if (variantScopes.isEmpty()) {\n        // 创建 variantScopes\n        recorder.record(                                                              \n                ExecutionType.VARIANT_MANAGER_CREATE_VARIANTS,                        \n                project.getPath(),                                                    \n                null /*variantName*/,                                                 \n                this::populateVariantDataList);                                       \n    }                                                                                 \n                                                                                      \n    // Create top level test tasks.                                                   \n    recorder.record(                                                                  \n            ExecutionType.VARIANT_MANAGER_CREATE_TESTS_TASKS,                         \n            project.getPath(),                                                        \n            null /*variantName*/,                                                     \n            () -> taskManager.createTopLevelTestTasks(!productFlavors.isEmpty()));    \n                                                                                      \n                                                                                      \n                                                                                      \n    for (final VariantScope variantScope : variantScopes) {\n        // 为每个 variant 生成各自的 task\n        recorder.record(                                                              \n                ExecutionType.VARIANT_MANAGER_CREATE_TASKS_FOR_VARIANT,               \n                project.getPath(),                                                    \n                variantScope.getFullVariantName(),                                    \n                () -> createTasksForVariantData(variantScope));                       \n    }                                                                                 \n                                                                                      \n    taskManager.createReportTasks(variantScopes);                                     \n}                                                                                     \n```\n\n调用 `populateVariantDataList()` 来生成 VariantScopes，它是由 ProductFlavors、BuildType、VariantType 组合\n\n``` java\npublic void createTasksForVariantData(final VariantScope variantScope) {                                              \n    final BaseVariantData variantData = variantScope.getVariantData();                                                \n    final VariantType variantType = variantData.getType();                                                            \n                                                                                                                      \n    final GradleVariantConfiguration variantConfig = variantScope.getVariantConfiguration();                          \n                                                                                                                      \n    final BuildTypeData buildTypeData = buildTypes.get(variantConfig.getBuildType().getName());                       \n    if (buildTypeData.getAssembleTask() == null) {\n        // 创建 BuildType 的 assemble task\n        // 比如 assembleDebug 和 assembleRelease\n        buildTypeData.setAssembleTask(taskManager.createAssembleTask(buildTypeData));                                 \n    }                                                                                                                 \n                                                                                                                      \n    // Add dependency of assemble task on assemble build type task.\n    // assemble 依赖于 assembleDebug 和 assembleRelease\n    taskManager                                                                                                       \n            .getTaskFactory()                                                                                         \n            .configure(                                                                                               \n                    \"assemble\",                                                                                       \n                    task -> {                                                                                         \n                        assert buildTypeData.getAssembleTask() != null;                                               \n                        task.dependsOn(buildTypeData.getAssembleTask().getName());                                    \n                    });                                                                                               \n    \n    // 根据 variant 创建 assemble task\n    createAssembleTaskForVariantData(variantData);                                                                    \n    if (variantType.isForTesting()) {                                                                                 \n         // 省略代码                                                                       \n    } else {\n        // 根据 variant 创建 task\n        taskManager.createTasksForVariantScope(variantScope);                                                         \n    }                                                                                                                 \n}                                                                                                                     \n```\n\nassemble task 用于将源文件编译为最终产物，比如 jar、aar、apk 等，在 `createTasksForVariantData()` 中会生成对应 BuildType 的 assemble task，比如 `assembleDebug` 和 `assembleRelease` ，接着设置 `assemble` 依赖于这两个 task，最后根据 variant 生成对应的 assemble task，比如 `assembleTestDebug`\n\n``` java\nprivate void createAssembleTaskForVariantData(final BaseVariantData variantData) {                      \n    final VariantScope variantScope = variantData.getScope();                                           \n    if (variantData.getType().isForTesting()) {                                                         \n        variantScope.setAssembleTask(taskManager.createAssembleTask(variantData));                      \n    } else {                                                                                            \n        BuildTypeData buildTypeData =                                                                   \n                buildTypes.get(variantData.getVariantConfiguration().getBuildType().getName());         \n                                                                                                        \n        Preconditions.checkNotNull(buildTypeData.getAssembleTask());                                    \n                                                                                                        \n        if (productFlavors.isEmpty()) {                                                                 \n            // Reuse assemble task for build type if there is no product flavor.                        \n            variantScope.setAssembleTask(buildTypeData.getAssembleTask());                              \n                                                                                                        \n            variantData.addTask(                                                                        \n                    TaskContainer.TaskKind.ASSEMBLE, buildTypeData.getAssembleTask());                  \n        } else {\n            // 根据 variant 创建对应的 assemble task，比如 assembleTesDebug\n            variantScope.setAssembleTask(taskManager.createAssembleTask(variantData));                  \n                                                                                                        \n            // setup the task dependencies                                                              \n            // build type\n            // build type assemble task 依赖于 具体的 assemble task\n            buildTypeData.getAssembleTask().dependsOn(variantScope.getAssembleTask());                  \n                                                                                                        \n            // each flavor                                                                              \n            GradleVariantConfiguration variantConfig = variantData.getVariantConfiguration();           \n            for (CoreProductFlavor flavor : variantConfig.getProductFlavors()) {                        \n                ProductFlavorData productFlavorData = productFlavors.get(flavor.getName());             \n                                                                                                        \n                DefaultTask flavorAssembleTask = productFlavorData.getAssembleTask();                   \n                if (flavorAssembleTask == null) {\n                    // 创建 flavor 的 assemble task\n                    // 比如 assembleTes\n                    flavorAssembleTask = taskManager.createAssembleTask(productFlavorData);             \n                    productFlavorData.setAssembleTask(flavorAssembleTask);                              \n                }\n                // flavor assemble task 依赖于具体的 assemble task\n                flavorAssembleTask.dependsOn(variantScope.getAssembleTask());                           \n            }                                                                                           \n                                                                                                        \n            // assembleTask for this flavor(dimension), created on demand if needed.                    \n            if (variantConfig.getProductFlavors().size() > 1) {                                         \n                final String name = StringHelper.capitalize(variantConfig.getFlavorName());             \n                final String variantAssembleTaskName =                                                  \n                        StringHelper.appendCapitalized(\"assemble\", name);                               \n                if (!taskManager.getTaskFactory().containsKey(variantAssembleTaskName)) {               \n                    Task task = taskManager.getTaskFactory().create(variantAssembleTaskName);           \n                    task.setDescription(\"Assembles all builds for flavor combination: \" + name);        \n                    task.setGroup(\"Build\");                                                             \n                    task.dependsOn(variantScope.getAssembleTask().getName());                           \n                }                                                                                       \n                taskManager                                                                             \n                        .getTaskFactory()                                                               \n                        .configure(                                                                     \n                                \"assemble\", task1 -> task1.dependsOn(variantAssembleTaskName));         \n            }                                                                                           \n        }                                                                                               \n    }                                                                                                   \n}                                                                                                       \n```\n\n上面会生成包括 BuildType、Flavor、BuildType + Flavor + VariantType 的 assemble task，同时 task 之间存在依赖关系：`assemble > buildType/flavor > 具体 ` \n\n![assemble-task-demo](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/assemble-task-demo.png?x-oss-process=style/doc-img)\n\n除了上面所说的 assemble task，还将生成以下 task：\n\n| task                                            | impl                                | dependsOn                                                    |\n| ----------------------------------------------- | ----------------------------------- | ------------------------------------------------------------ |\n| assemble{variant}                               | DefaultTask                         | compile{variant}Sources，package{variant}                    |\n| pre{variant}Build                               | AppPreBuildTask                     | preBuild，extractProguardFiles(可能)                         |\n| extractProguardFiles                            | ExtractProguardFiles                |                                                              |\n| generate{variant}Sources                        | DefaultTask                         | compile{variant}Renderscript，generate{variant}BuildConfig，bundle{variant}Resources，compile{variant}Aidl |\n| generate{variant}Resources                      | DefaultTask                         | generate{variant}ResValues，compile{variant}Renderscript     |\n| generate{variant}Assets                         | DefaultTask                         | compile{variant}Shaders                                      |\n| compile{variant}Sources                         | DefaultTask                         | compile{variant}Ndk，compile{variant}JavaWithJavac           |\n| check{variant}Manifest                          | CheckManifest                       | pre{variant}Build                                            |\n| write{variant}ApplicationId                     | ApplicationIdIdWriteTask            |                                                              |\n| mainApkListPersistence{variant}                 | MainApkListPersistence              |                                                              |\n| reportBuildArtifacts{variant}                   | BuildArtifactReportTask             |                                                              |\n| create{variant}CompatibleScreenManifests        | CompatibleScreensManifest           |                                                              |\n| process{variant}Manifest                        | MergeManifests                      | check{variant}Manifest                                       |\n| generate{variant}ResValues                      | GenerateResValues                   |                                                              |\n| compile{variant}Renderscript                    | RenderscriptCompile                 | pre{variant}Build                                            |\n| merge{variant}Resources                         | MergeResources                      | generate{variant}Resources                                   |\n| merge{variant}Shaders                           | MergeSourceSetFolders               |                                                              |\n| compile{variant}Shaders                         | ShaderCompile                       | merge{variant}Shaders                                        |\n| merge{variant}Assets                            | MergeSourceSetFolders               | generate{variant}Assets                                      |\n| generate{variant}BuildConfig                    | GenerateBuildConfig                 | check{variant}Manifest                                       |\n| splitsDiscoveryTask{variant}                    | SplitsDiscovery                     |                                                              |\n| process{variant}JavaRes                         | Sync                                | pre{variant}Build                                            |\n| process{variant}Resources                       | LinkApplicationAndroidResourcesTask |                                                              |\n| bundle{variant}Resources                        | LinkAndroidResForBundleTask         |                                                              |\n| compile{variant}Aidl                            | AidlCompile                         | pre{variant}Build                                            |\n| compile{variant}Ndk                             | NdkCompile                          | pre{variant}Build                                            |\n| merge{variant}JniLibFolders                     | MergeSourceSetFolders               | generate{variant}Assets                                      |\n| javaPreCompile{variant}                         | JavaPreCompileTask                  | pre{variant}Build                                            |\n| compile{variant}JavaWithJavac                   | AndroidJavaCompile                  | generate{variant}Sources                                     |\n| bundleAppClasses{variant}                       | Jar                                 |                                                              |\n| transformResourcesWithMergeJavaResFor{variant}  | TransformTask                       |                                                              |\n| transformClassesWithMultidexlistFor{variant}    | TransformTask                       |                                                              |\n| transformClassesWithDexBuilderFor{variant}      | TransformTask                       |                                                              |\n| transformDexArchiveWithDexMergerFor{variant}    | TransformTask                       | transformClassesWithMultidexlistFor{variant}                 |\n| preparePUBLISHED_JAVA_RES{variant}ForPublishing | PipelineToPublicationTask           |                                                              |\n| package{variant}                                | PackageApplication                  | merge{variant}Assets，process{variant}Resources，validateSigning{variant}，compile{variant}JavaWithJavac |\n| validateSigning{variant}                        | ValidateSigningTask                 |                                                              |\n| install{variant}                                | InstallVariantTask                  | assemble{variant}                                            |\n| uninstall{variant}                              | UninstallTask                       |                                                              |\n| lint{variant}                                   | LintPerVariantTask                  |                                                              |\n\n以 `assembleProdRelease` 命令，依次执行的 task：\n\n> prod 是 product flavor\n\n```\npreBuild\nextractProguardFiles\npreProdReleaseBuild\ncompileProdReleaseRenderscript\ncheckProdReleaseManifest\ngenerateProdReleaseBuildConfig\nprepareLintJar\nmainApkListPersistenceProdRelease\ngenerateProdReleaseResValues\ngenerateProdReleaseResources\ncompileProdReleaseAidl\ncreateProdReleaseCompatibleScreenManifests\nprocessProdReleaseManifest\nmergeProdReleaseResources  // 合并资源\nsplitsDiscoveryTaskProdRelease\nprocessProdReleaseResources\ngenerateProdReleaseSources\njavaPreCompileProdRelease\ncompileProdReleaseJavaWithJavac // javac\ncompileProdReleaseNdk\ncompileProdReleaseSources\nmergeProdReleaseShaders\ncompileProdReleaseShaders\ngenerateProdReleaseAssets\nmergeProdReleaseAssets\ntransformClassesWithComponentCodeForProdRelease \nprocessProdReleaseJavaRes\ntransformResourcesWithMergeJavaResForProdRelease\ntransformClassesAndResourcesWithProguardForProdRelease // 混淆\ntransformClassesWithMultidexlistForProdRelease\ntransformClassesWithDexForProdRelease\t\t\t\t// dex\ntransformClassesWithShrinkResForProdRelease\nmergeProdReleaseJniLibFolders\ntransformNativeLibsWithMergeJniLibsForProdRelease\nvalidateSigningProdRelease\npackageProdRelease\n```\n\n接下来分析下比较重要的几个 task\n\n> 接下来的分析，因为对应的源码比较复杂，所以只会简短介绍结果，没有详细过程，推荐 debug 整个流程\n\n### CompileJavaWithJavac\n\n首先找到执行的 AndroidJavaCompile\n\n``` java\n// AndroidJavaCompile.java\n@Override                                                                                       \nprotected void compile(IncrementalTaskInputs inputs) {                                          \n    // compileSdkVersion >= 24，需要使用 jdk1.8                                                     \n    if (isPostN()) {                                                                            \n        if (!JavaVersion.current().isJava8Compatible()) {                                       \n            throw new RuntimeException(\"compileSdkVersion '\" + compileSdkVersion + \"' requires \"\n                    + \"JDK 1.8 or later to compile.\");                                          \n        }                                                                                       \n    }                                                                                           \n    \n    // 处理注解处理器，在之前 task 会将使用 annotationProcessor 标示的注解处理器写入到 annotationProcessors.json 中\n    processAnalytics();                                                                         \n                                                                                                \n    // Create directory for output of annotation processor.                                     \n    FileUtils.mkdirs(annotationProcessorOutputFolder);                                          \n                                                                                                \n    mInstantRunBuildContext.startRecording(InstantRunBuildContext.TaskType.JAVAC);\n    // 调用 JavaCompile.compile\n    super.compile(inputs);                                                                      \n    mInstantRunBuildContext.stopRecording(InstantRunBuildContext.TaskType.JAVAC);               \n}                                                                                               \n```\n\n``` java\n// JavaCompile.java\n@TaskAction                                                                                                                                                                                                                                                                                                           \nprotected void compile(IncrementalTaskInputs inputs) {\n    // 是否为增量编译\n    if (!this.compileOptions.isIncremental()) {\n        this.compile();                                                                                                                                                                                                                                                                                               \n    } else {                                                                                                                                                                                                                                                                                                          \n        DefaultJavaCompileSpec spec = this.createSpec();                                                                                                                                                                                                                                                              \n        CompileCaches compileCaches = this.createCompileCaches();                                                                                                                                                                                                                                                     \n        IncrementalCompilerFactory factory = new IncrementalCompilerFactory(this.getFileOperations(), this.getStreamHasher(), this.getCachingFileHasher(), this.getPath(), this.createCompiler(spec), this.source, compileCaches, (IncrementalTaskInputsInternal)inputs, this.getEffectiveAnnotationProcessorPath()); \n        Compiler<JavaCompileSpec> compiler = factory.createCompiler();                                                                                                                                                                                                                                                \n        this.performCompilation(spec, compiler);                                                                                                                                                                                                                                                                      \n    }                                                                                                                                                                                                                                                                                                                 \n}                                                                                                                                                                                                                                                                                                                     \n```\n\n不管是增量编译还是全量编译，最后都会调用 `performCompilation`\n\n``` java\nprivate void performCompilation(JavaCompileSpec spec, Compiler<JavaCompileSpec> compiler) {\n\t// 执行编译\n    WorkResult result = compiler.execute(spec);                                             \n    this.setDidWork(result.getDidWork());                                                   \n}                                                                                           \n```\n\nCompiler 采用**装饰者设计模式**，最外层是 `CleaningJavaCompilerSupport` 会先删除编译目录，再调用 `JdkJavaCompiler` 执行 `javac` 过程，具体为，创建一个 `JavacTaskImpl` 然后 JavacTask 会调用 `com.sun.tools.javac.main.Main` 进行处理，其中创建 JavacTask 的任务是由 `JavacTool` 完成\n\n","slug":"AppPlugin中的Task-第一篇","published":1,"updated":"2022-06-15T11:19:32.315Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrll000jfho67bppbhe4","content":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>在使用 Android Studio 以后，基本新的 Android 项目都是用 Gradle 作为构建工具，关于 Gradle 的介绍不在本文范畴，当新建一个 Android 项目时，默认只会有个 module 使用<code>com.android.application</code> 插件，Gradle 的核心在于 task，即从 java 源文件和资源文件编译成 apk 文件（编译过程），就是由一系列的 task 组成，task 可以相互依赖，比如最基本的 <code>Task.dependsOn()</code>，所以理解 Android 编译过程就是理解各个 task 的作用。</p>\n<blockquote>\n<p>本文涉及的源码：</p>\n<ul>\n<li>com.android.tools.build:gradle:3.1.4</li>\n<li>gradle-api-4.4</li>\n</ul>\n</blockquote>\n<h3 id=\"AppPlugin\"><a href=\"#AppPlugin\" class=\"headerlink\" title=\"AppPlugin\"></a>AppPlugin</h3><p><code>com.android.application</code> 的源码位于 <code>com.android.build.gradle.AppPlugin</code>，AppPlugin 继承于 BasePlugin，BasePlugin 封装了大部分通用的逻辑：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">apply</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Project project)</span> &#123;                                            </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 省略初始化步骤</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!projectOptions.get(BooleanOption.ENABLE_NEW_DSL_AND_API)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 不使用新的 DSL API</span></span><br><span class=\"line\">        TaskInputHelper.enableBypass();                                                  </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// threadRecorder 用于记录执行时间</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// configureProject 配置项目</span></span><br><span class=\"line\">        threadRecorder.record(                                                           </span><br><span class=\"line\">                ExecutionType.BASE_PLUGIN_PROJECT_CONFIGURE,                             </span><br><span class=\"line\">                project.getPath(),                                                       </span><br><span class=\"line\">                <span class=\"literal\">null</span>,                                                                    </span><br><span class=\"line\">                <span class=\"built_in\">this</span>::configureProject);                                                 </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// configureExtension 配置 Extension 后，我们才能使用 android &#123;&#125; 进行配置</span></span><br><span class=\"line\">        threadRecorder.record(                                                           </span><br><span class=\"line\">                ExecutionType.BASE_PLUGIN_PROJECT_BASE_EXTENSION_CREATION,               </span><br><span class=\"line\">                project.getPath(),                                                       </span><br><span class=\"line\">                <span class=\"literal\">null</span>,                                                                    </span><br><span class=\"line\">                <span class=\"built_in\">this</span>::configureExtension);                                               </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// createTasks 本文的重点，创建必须的 task</span></span><br><span class=\"line\">        threadRecorder.record(                                                           </span><br><span class=\"line\">                ExecutionType.BASE_PLUGIN_PROJECT_TASKS_CREATION,                        </span><br><span class=\"line\">                project.getPath(),                                                       </span><br><span class=\"line\">                <span class=\"literal\">null</span>,                                                                    </span><br><span class=\"line\">                <span class=\"built_in\">this</span>::createTasks);                                                      </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                             </span><br><span class=\"line\">         <span class=\"comment\">// 省略                   </span></span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">&#125;                                                                                        </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">createTasks</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// createTasksBeforeEvaluate</span></span><br><span class=\"line\">    threadRecorder.record(                                                   </span><br><span class=\"line\">            ExecutionType.TASK_MANAGER_CREATE_TASKS,                         </span><br><span class=\"line\">            project.getPath(),                                               </span><br><span class=\"line\">            <span class=\"literal\">null</span>,                                                            </span><br><span class=\"line\">            () -&gt; taskManager.createTasksBeforeEvaluate());                  </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// afterEvaluate 执行</span></span><br><span class=\"line\">    project.afterEvaluate(                                                   </span><br><span class=\"line\">            project -&gt;                                                       </span><br><span class=\"line\">                    threadRecorder.record(                                   </span><br><span class=\"line\">                            ExecutionType.BASE_PLUGIN_CREATE_ANDROID_TASKS,  </span><br><span class=\"line\">                            project.getPath(),                               </span><br><span class=\"line\">                            <span class=\"literal\">null</span>,                                            </span><br><span class=\"line\">                            () -&gt; createAndroidTasks(<span class=\"literal\">false</span>)));               </span><br><span class=\"line\">&#125;                                                                            </span><br></pre></td></tr></table></figure>\n\n<p>从 <code>createTasks()</code> 可以看到，<code>createAndroidTasks()</code> 是在 <code>afterEvaluate()</code> 中执行的，evaluate 是 Gradle  一个执行的过程</p>\n<blockquote>\n<p>Gradle 编译的三个阶段：Initialization、Configuration、Execution。具体可以阅读 <a href=\"https://docs.gradle.org/current/userguide/build_lifecycle.html\">build_lifecycle</a></p>\n</blockquote>\n<p><code>createAndroidTasks()</code> 这个方法较长，但是我们关心的是 <code>VariantManager.createAndroidTasks()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">createAndroidTasks</span><span class=\"params\">()</span> &#123;                                                    </span><br><span class=\"line\">    variantFactory.validateModel(<span class=\"built_in\">this</span>);                                               </span><br><span class=\"line\">    variantFactory.preVariantWork(project);                                           </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (variantScopes.isEmpty()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 variantScopes</span></span><br><span class=\"line\">        recorder.record(                                                              </span><br><span class=\"line\">                ExecutionType.VARIANT_MANAGER_CREATE_VARIANTS,                        </span><br><span class=\"line\">                project.getPath(),                                                    </span><br><span class=\"line\">                <span class=\"literal\">null</span> <span class=\"comment\">/*variantName*/</span>,                                                 </span><br><span class=\"line\">                <span class=\"built_in\">this</span>::populateVariantDataList);                                       </span><br><span class=\"line\">    &#125;                                                                                 </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">    <span class=\"comment\">// Create top level test tasks.                                                   </span></span><br><span class=\"line\">    recorder.record(                                                                  </span><br><span class=\"line\">            ExecutionType.VARIANT_MANAGER_CREATE_TESTS_TASKS,                         </span><br><span class=\"line\">            project.getPath(),                                                        </span><br><span class=\"line\">            <span class=\"literal\">null</span> <span class=\"comment\">/*variantName*/</span>,                                                     </span><br><span class=\"line\">            () -&gt; taskManager.createTopLevelTestTasks(!productFlavors.isEmpty()));    </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">final</span> VariantScope variantScope : variantScopes) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 为每个 variant 生成各自的 task</span></span><br><span class=\"line\">        recorder.record(                                                              </span><br><span class=\"line\">                ExecutionType.VARIANT_MANAGER_CREATE_TASKS_FOR_VARIANT,               </span><br><span class=\"line\">                project.getPath(),                                                    </span><br><span class=\"line\">                variantScope.getFullVariantName(),                                    </span><br><span class=\"line\">                () -&gt; createTasksForVariantData(variantScope));                       </span><br><span class=\"line\">    &#125;                                                                                 </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">    taskManager.createReportTasks(variantScopes);                                     </span><br><span class=\"line\">&#125;                                                                                     </span><br></pre></td></tr></table></figure>\n\n<p>调用 <code>populateVariantDataList()</code> 来生成 VariantScopes，它是由 ProductFlavors、BuildType、VariantType 组合</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">createTasksForVariantData</span><span class=\"params\">(<span class=\"keyword\">final</span> VariantScope variantScope)</span> &#123;                                              </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">BaseVariantData</span> <span class=\"variable\">variantData</span> <span class=\"operator\">=</span> variantScope.getVariantData();                                                </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">VariantType</span> <span class=\"variable\">variantType</span> <span class=\"operator\">=</span> variantData.getType();                                                            </span><br><span class=\"line\">                                                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">GradleVariantConfiguration</span> <span class=\"variable\">variantConfig</span> <span class=\"operator\">=</span> variantScope.getVariantConfiguration();                          </span><br><span class=\"line\">                                                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">BuildTypeData</span> <span class=\"variable\">buildTypeData</span> <span class=\"operator\">=</span> buildTypes.get(variantConfig.getBuildType().getName());                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildTypeData.getAssembleTask() == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 BuildType 的 assemble task</span></span><br><span class=\"line\">        <span class=\"comment\">// 比如 assembleDebug 和 assembleRelease</span></span><br><span class=\"line\">        buildTypeData.setAssembleTask(taskManager.createAssembleTask(buildTypeData));                                 </span><br><span class=\"line\">    &#125;                                                                                                                 </span><br><span class=\"line\">                                                                                                                      </span><br><span class=\"line\">    <span class=\"comment\">// Add dependency of assemble task on assemble build type task.</span></span><br><span class=\"line\">    <span class=\"comment\">// assemble 依赖于 assembleDebug 和 assembleRelease</span></span><br><span class=\"line\">    taskManager                                                                                                       </span><br><span class=\"line\">            .getTaskFactory()                                                                                         </span><br><span class=\"line\">            .configure(                                                                                               </span><br><span class=\"line\">                    <span class=\"string\">&quot;assemble&quot;</span>,                                                                                       </span><br><span class=\"line\">                    task -&gt; &#123;                                                                                         </span><br><span class=\"line\">                        <span class=\"keyword\">assert</span> buildTypeData.getAssembleTask() != <span class=\"literal\">null</span>;                                               </span><br><span class=\"line\">                        task.dependsOn(buildTypeData.getAssembleTask().getName());                                    </span><br><span class=\"line\">                    &#125;);                                                                                               </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 根据 variant 创建 assemble task</span></span><br><span class=\"line\">    createAssembleTaskForVariantData(variantData);                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (variantType.isForTesting()) &#123;                                                                                 </span><br><span class=\"line\">         <span class=\"comment\">// 省略代码                                                                       </span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 根据 variant 创建 task</span></span><br><span class=\"line\">        taskManager.createTasksForVariantScope(variantScope);                                                         </span><br><span class=\"line\">    &#125;                                                                                                                 </span><br><span class=\"line\">&#125;                                                                                                                     </span><br></pre></td></tr></table></figure>\n\n<p>assemble task 用于将源文件编译为最终产物，比如 jar、aar、apk 等，在 <code>createTasksForVariantData()</code> 中会生成对应 BuildType 的 assemble task，比如 <code>assembleDebug</code> 和 <code>assembleRelease</code> ，接着设置 <code>assemble</code> 依赖于这两个 task，最后根据 variant 生成对应的 assemble task，比如 <code>assembleTestDebug</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">createAssembleTaskForVariantData</span><span class=\"params\">(<span class=\"keyword\">final</span> BaseVariantData variantData)</span> &#123;                      </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">VariantScope</span> <span class=\"variable\">variantScope</span> <span class=\"operator\">=</span> variantData.getScope();                                           </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (variantData.getType().isForTesting()) &#123;                                                         </span><br><span class=\"line\">        variantScope.setAssembleTask(taskManager.createAssembleTask(variantData));                      </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                                            </span><br><span class=\"line\">        <span class=\"type\">BuildTypeData</span> <span class=\"variable\">buildTypeData</span> <span class=\"operator\">=</span>                                                                   </span><br><span class=\"line\">                buildTypes.get(variantData.getVariantConfiguration().getBuildType().getName());         </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">        Preconditions.checkNotNull(buildTypeData.getAssembleTask());                                    </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (productFlavors.isEmpty()) &#123;                                                                 </span><br><span class=\"line\">            <span class=\"comment\">// Reuse assemble task for build type if there is no product flavor.                        </span></span><br><span class=\"line\">            variantScope.setAssembleTask(buildTypeData.getAssembleTask());                              </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">            variantData.addTask(                                                                        </span><br><span class=\"line\">                    TaskContainer.TaskKind.ASSEMBLE, buildTypeData.getAssembleTask());                  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 根据 variant 创建对应的 assemble task，比如 assembleTesDebug</span></span><br><span class=\"line\">            variantScope.setAssembleTask(taskManager.createAssembleTask(variantData));                  </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">            <span class=\"comment\">// setup the task dependencies                                                              </span></span><br><span class=\"line\">            <span class=\"comment\">// build type</span></span><br><span class=\"line\">            <span class=\"comment\">// build type assemble task 依赖于 具体的 assemble task</span></span><br><span class=\"line\">            buildTypeData.getAssembleTask().dependsOn(variantScope.getAssembleTask());                  </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">            <span class=\"comment\">// each flavor                                                                              </span></span><br><span class=\"line\">            <span class=\"type\">GradleVariantConfiguration</span> <span class=\"variable\">variantConfig</span> <span class=\"operator\">=</span> variantData.getVariantConfiguration();           </span><br><span class=\"line\">            <span class=\"keyword\">for</span> (CoreProductFlavor flavor : variantConfig.getProductFlavors()) &#123;                        </span><br><span class=\"line\">                <span class=\"type\">ProductFlavorData</span> <span class=\"variable\">productFlavorData</span> <span class=\"operator\">=</span> productFlavors.get(flavor.getName());             </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">                <span class=\"type\">DefaultTask</span> <span class=\"variable\">flavorAssembleTask</span> <span class=\"operator\">=</span> productFlavorData.getAssembleTask();                   </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (flavorAssembleTask == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 创建 flavor 的 assemble task</span></span><br><span class=\"line\">                    <span class=\"comment\">// 比如 assembleTes</span></span><br><span class=\"line\">                    flavorAssembleTask = taskManager.createAssembleTask(productFlavorData);             </span><br><span class=\"line\">                    productFlavorData.setAssembleTask(flavorAssembleTask);                              </span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">// flavor assemble task 依赖于具体的 assemble task</span></span><br><span class=\"line\">                flavorAssembleTask.dependsOn(variantScope.getAssembleTask());                           </span><br><span class=\"line\">            &#125;                                                                                           </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">            <span class=\"comment\">// assembleTask for this flavor(dimension), created on demand if needed.                    </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (variantConfig.getProductFlavors().size() &gt; <span class=\"number\">1</span>) &#123;                                         </span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">name</span> <span class=\"operator\">=</span> StringHelper.capitalize(variantConfig.getFlavorName());             </span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">variantAssembleTaskName</span> <span class=\"operator\">=</span>                                                  </span><br><span class=\"line\">                        StringHelper.appendCapitalized(<span class=\"string\">&quot;assemble&quot;</span>, name);                               </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!taskManager.getTaskFactory().containsKey(variantAssembleTaskName)) &#123;               </span><br><span class=\"line\">                    <span class=\"type\">Task</span> <span class=\"variable\">task</span> <span class=\"operator\">=</span> taskManager.getTaskFactory().create(variantAssembleTaskName);           </span><br><span class=\"line\">                    task.setDescription(<span class=\"string\">&quot;Assembles all builds for flavor combination: &quot;</span> + name);        </span><br><span class=\"line\">                    task.setGroup(<span class=\"string\">&quot;Build&quot;</span>);                                                             </span><br><span class=\"line\">                    task.dependsOn(variantScope.getAssembleTask().getName());                           </span><br><span class=\"line\">                &#125;                                                                                       </span><br><span class=\"line\">                taskManager                                                                             </span><br><span class=\"line\">                        .getTaskFactory()                                                               </span><br><span class=\"line\">                        .configure(                                                                     </span><br><span class=\"line\">                                <span class=\"string\">&quot;assemble&quot;</span>, task1 -&gt; task1.dependsOn(variantAssembleTaskName));         </span><br><span class=\"line\">            &#125;                                                                                           </span><br><span class=\"line\">        &#125;                                                                                               </span><br><span class=\"line\">    &#125;                                                                                                   </span><br><span class=\"line\">&#125;                                                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>上面会生成包括 BuildType、Flavor、BuildType + Flavor + VariantType 的 assemble task，同时 task 之间存在依赖关系：<code>assemble &gt; buildType/flavor &gt; 具体 </code> </p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/assemble-task-demo.png?x-oss-process=style/doc-img\" alt=\"assemble-task-demo\"></p>\n<p>除了上面所说的 assemble task，还将生成以下 task：</p>\n<table>\n<thead>\n<tr>\n<th>task</th>\n<th>impl</th>\n<th>dependsOn</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>assemble{variant}</td>\n<td>DefaultTask</td>\n<td>compile{variant}Sources，package{variant}</td>\n</tr>\n<tr>\n<td>pre{variant}Build</td>\n<td>AppPreBuildTask</td>\n<td>preBuild，extractProguardFiles(可能)</td>\n</tr>\n<tr>\n<td>extractProguardFiles</td>\n<td>ExtractProguardFiles</td>\n<td></td>\n</tr>\n<tr>\n<td>generate{variant}Sources</td>\n<td>DefaultTask</td>\n<td>compile{variant}Renderscript，generate{variant}BuildConfig，bundle{variant}Resources，compile{variant}Aidl</td>\n</tr>\n<tr>\n<td>generate{variant}Resources</td>\n<td>DefaultTask</td>\n<td>generate{variant}ResValues，compile{variant}Renderscript</td>\n</tr>\n<tr>\n<td>generate{variant}Assets</td>\n<td>DefaultTask</td>\n<td>compile{variant}Shaders</td>\n</tr>\n<tr>\n<td>compile{variant}Sources</td>\n<td>DefaultTask</td>\n<td>compile{variant}Ndk，compile{variant}JavaWithJavac</td>\n</tr>\n<tr>\n<td>check{variant}Manifest</td>\n<td>CheckManifest</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>write{variant}ApplicationId</td>\n<td>ApplicationIdIdWriteTask</td>\n<td></td>\n</tr>\n<tr>\n<td>mainApkListPersistence{variant}</td>\n<td>MainApkListPersistence</td>\n<td></td>\n</tr>\n<tr>\n<td>reportBuildArtifacts{variant}</td>\n<td>BuildArtifactReportTask</td>\n<td></td>\n</tr>\n<tr>\n<td>create{variant}CompatibleScreenManifests</td>\n<td>CompatibleScreensManifest</td>\n<td></td>\n</tr>\n<tr>\n<td>process{variant}Manifest</td>\n<td>MergeManifests</td>\n<td>check{variant}Manifest</td>\n</tr>\n<tr>\n<td>generate{variant}ResValues</td>\n<td>GenerateResValues</td>\n<td></td>\n</tr>\n<tr>\n<td>compile{variant}Renderscript</td>\n<td>RenderscriptCompile</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>merge{variant}Resources</td>\n<td>MergeResources</td>\n<td>generate{variant}Resources</td>\n</tr>\n<tr>\n<td>merge{variant}Shaders</td>\n<td>MergeSourceSetFolders</td>\n<td></td>\n</tr>\n<tr>\n<td>compile{variant}Shaders</td>\n<td>ShaderCompile</td>\n<td>merge{variant}Shaders</td>\n</tr>\n<tr>\n<td>merge{variant}Assets</td>\n<td>MergeSourceSetFolders</td>\n<td>generate{variant}Assets</td>\n</tr>\n<tr>\n<td>generate{variant}BuildConfig</td>\n<td>GenerateBuildConfig</td>\n<td>check{variant}Manifest</td>\n</tr>\n<tr>\n<td>splitsDiscoveryTask{variant}</td>\n<td>SplitsDiscovery</td>\n<td></td>\n</tr>\n<tr>\n<td>process{variant}JavaRes</td>\n<td>Sync</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>process{variant}Resources</td>\n<td>LinkApplicationAndroidResourcesTask</td>\n<td></td>\n</tr>\n<tr>\n<td>bundle{variant}Resources</td>\n<td>LinkAndroidResForBundleTask</td>\n<td></td>\n</tr>\n<tr>\n<td>compile{variant}Aidl</td>\n<td>AidlCompile</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>compile{variant}Ndk</td>\n<td>NdkCompile</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>merge{variant}JniLibFolders</td>\n<td>MergeSourceSetFolders</td>\n<td>generate{variant}Assets</td>\n</tr>\n<tr>\n<td>javaPreCompile{variant}</td>\n<td>JavaPreCompileTask</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>compile{variant}JavaWithJavac</td>\n<td>AndroidJavaCompile</td>\n<td>generate{variant}Sources</td>\n</tr>\n<tr>\n<td>bundleAppClasses{variant}</td>\n<td>Jar</td>\n<td></td>\n</tr>\n<tr>\n<td>transformResourcesWithMergeJavaResFor{variant}</td>\n<td>TransformTask</td>\n<td></td>\n</tr>\n<tr>\n<td>transformClassesWithMultidexlistFor{variant}</td>\n<td>TransformTask</td>\n<td></td>\n</tr>\n<tr>\n<td>transformClassesWithDexBuilderFor{variant}</td>\n<td>TransformTask</td>\n<td></td>\n</tr>\n<tr>\n<td>transformDexArchiveWithDexMergerFor{variant}</td>\n<td>TransformTask</td>\n<td>transformClassesWithMultidexlistFor{variant}</td>\n</tr>\n<tr>\n<td>preparePUBLISHED_JAVA_RES{variant}ForPublishing</td>\n<td>PipelineToPublicationTask</td>\n<td></td>\n</tr>\n<tr>\n<td>package{variant}</td>\n<td>PackageApplication</td>\n<td>merge{variant}Assets，process{variant}Resources，validateSigning{variant}，compile{variant}JavaWithJavac</td>\n</tr>\n<tr>\n<td>validateSigning{variant}</td>\n<td>ValidateSigningTask</td>\n<td></td>\n</tr>\n<tr>\n<td>install{variant}</td>\n<td>InstallVariantTask</td>\n<td>assemble{variant}</td>\n</tr>\n<tr>\n<td>uninstall{variant}</td>\n<td>UninstallTask</td>\n<td></td>\n</tr>\n<tr>\n<td>lint{variant}</td>\n<td>LintPerVariantTask</td>\n<td></td>\n</tr>\n</tbody></table>\n<p>以 <code>assembleProdRelease</code> 命令，依次执行的 task：</p>\n<blockquote>\n<p>prod 是 product flavor</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">preBuild</span><br><span class=\"line\">extractProguardFiles</span><br><span class=\"line\">preProdReleaseBuild</span><br><span class=\"line\">compileProdReleaseRenderscript</span><br><span class=\"line\">checkProdReleaseManifest</span><br><span class=\"line\">generateProdReleaseBuildConfig</span><br><span class=\"line\">prepareLintJar</span><br><span class=\"line\">mainApkListPersistenceProdRelease</span><br><span class=\"line\">generateProdReleaseResValues</span><br><span class=\"line\">generateProdReleaseResources</span><br><span class=\"line\">compileProdReleaseAidl</span><br><span class=\"line\">createProdReleaseCompatibleScreenManifests</span><br><span class=\"line\">processProdReleaseManifest</span><br><span class=\"line\">mergeProdReleaseResources  // 合并资源</span><br><span class=\"line\">splitsDiscoveryTaskProdRelease</span><br><span class=\"line\">processProdReleaseResources</span><br><span class=\"line\">generateProdReleaseSources</span><br><span class=\"line\">javaPreCompileProdRelease</span><br><span class=\"line\">compileProdReleaseJavaWithJavac // javac</span><br><span class=\"line\">compileProdReleaseNdk</span><br><span class=\"line\">compileProdReleaseSources</span><br><span class=\"line\">mergeProdReleaseShaders</span><br><span class=\"line\">compileProdReleaseShaders</span><br><span class=\"line\">generateProdReleaseAssets</span><br><span class=\"line\">mergeProdReleaseAssets</span><br><span class=\"line\">transformClassesWithComponentCodeForProdRelease </span><br><span class=\"line\">processProdReleaseJavaRes</span><br><span class=\"line\">transformResourcesWithMergeJavaResForProdRelease</span><br><span class=\"line\">transformClassesAndResourcesWithProguardForProdRelease // 混淆</span><br><span class=\"line\">transformClassesWithMultidexlistForProdRelease</span><br><span class=\"line\">transformClassesWithDexForProdRelease\t\t\t\t// dex</span><br><span class=\"line\">transformClassesWithShrinkResForProdRelease</span><br><span class=\"line\">mergeProdReleaseJniLibFolders</span><br><span class=\"line\">transformNativeLibsWithMergeJniLibsForProdRelease</span><br><span class=\"line\">validateSigningProdRelease</span><br><span class=\"line\">packageProdRelease</span><br></pre></td></tr></table></figure>\n\n<p>接下来分析下比较重要的几个 task</p>\n<blockquote>\n<p>接下来的分析，因为对应的源码比较复杂，所以只会简短介绍结果，没有详细过程，推荐 debug 整个流程</p>\n</blockquote>\n<h3 id=\"CompileJavaWithJavac\"><a href=\"#CompileJavaWithJavac\" class=\"headerlink\" title=\"CompileJavaWithJavac\"></a>CompileJavaWithJavac</h3><p>首先找到执行的 AndroidJavaCompile</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// AndroidJavaCompile.java</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">compile</span><span class=\"params\">(IncrementalTaskInputs inputs)</span> &#123;                                          </span><br><span class=\"line\">    <span class=\"comment\">// compileSdkVersion &gt;= 24，需要使用 jdk1.8                                                     </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isPostN()) &#123;                                                                            </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!JavaVersion.current().isJava8Compatible()) &#123;                                       </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;compileSdkVersion &#x27;&quot;</span> + compileSdkVersion + <span class=\"string\">&quot;&#x27; requires &quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot;JDK 1.8 or later to compile.&quot;</span>);                                          </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 处理注解处理器，在之前 task 会将使用 annotationProcessor 标示的注解处理器写入到 annotationProcessors.json 中</span></span><br><span class=\"line\">    processAnalytics();                                                                         </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">    <span class=\"comment\">// Create directory for output of annotation processor.                                     </span></span><br><span class=\"line\">    FileUtils.mkdirs(annotationProcessorOutputFolder);                                          </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">    mInstantRunBuildContext.startRecording(InstantRunBuildContext.TaskType.JAVAC);</span><br><span class=\"line\">    <span class=\"comment\">// 调用 JavaCompile.compile</span></span><br><span class=\"line\">    <span class=\"built_in\">super</span>.compile(inputs);                                                                      </span><br><span class=\"line\">    mInstantRunBuildContext.stopRecording(InstantRunBuildContext.TaskType.JAVAC);               </span><br><span class=\"line\">&#125;                                                                                               </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// JavaCompile.java</span></span><br><span class=\"line\"><span class=\"meta\">@TaskAction</span>                                                                                                                                                                                                                                                                                                           </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">compile</span><span class=\"params\">(IncrementalTaskInputs inputs)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 是否为增量编译</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">this</span>.compileOptions.isIncremental()) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.compile();                                                                                                                                                                                                                                                                                               </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                                                                                                                                                                                                                                                          </span><br><span class=\"line\">        <span class=\"type\">DefaultJavaCompileSpec</span> <span class=\"variable\">spec</span> <span class=\"operator\">=</span> <span class=\"built_in\">this</span>.createSpec();                                                                                                                                                                                                                                                              </span><br><span class=\"line\">        <span class=\"type\">CompileCaches</span> <span class=\"variable\">compileCaches</span> <span class=\"operator\">=</span> <span class=\"built_in\">this</span>.createCompileCaches();                                                                                                                                                                                                                                                     </span><br><span class=\"line\">        <span class=\"type\">IncrementalCompilerFactory</span> <span class=\"variable\">factory</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IncrementalCompilerFactory</span>(<span class=\"built_in\">this</span>.getFileOperations(), <span class=\"built_in\">this</span>.getStreamHasher(), <span class=\"built_in\">this</span>.getCachingFileHasher(), <span class=\"built_in\">this</span>.getPath(), <span class=\"built_in\">this</span>.createCompiler(spec), <span class=\"built_in\">this</span>.source, compileCaches, (IncrementalTaskInputsInternal)inputs, <span class=\"built_in\">this</span>.getEffectiveAnnotationProcessorPath()); </span><br><span class=\"line\">        Compiler&lt;JavaCompileSpec&gt; compiler = factory.createCompiler();                                                                                                                                                                                                                                                </span><br><span class=\"line\">        <span class=\"built_in\">this</span>.performCompilation(spec, compiler);                                                                                                                                                                                                                                                                      </span><br><span class=\"line\">    &#125;                                                                                                                                                                                                                                                                                                                 </span><br><span class=\"line\">&#125;                                                                                                                                                                                                                                                                                                                     </span><br></pre></td></tr></table></figure>\n\n<p>不管是增量编译还是全量编译，最后都会调用 <code>performCompilation</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performCompilation</span><span class=\"params\">(JavaCompileSpec spec, Compiler&lt;JavaCompileSpec&gt; compiler)</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 执行编译</span></span><br><span class=\"line\">    <span class=\"type\">WorkResult</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> compiler.execute(spec);                                             </span><br><span class=\"line\">    <span class=\"built_in\">this</span>.setDidWork(result.getDidWork());                                                   </span><br><span class=\"line\">&#125;                                                                                           </span><br></pre></td></tr></table></figure>\n\n<p>Compiler 采用<strong>装饰者设计模式</strong>，最外层是 <code>CleaningJavaCompilerSupport</code> 会先删除编译目录，再调用 <code>JdkJavaCompiler</code> 执行 <code>javac</code> 过程，具体为，创建一个 <code>JavacTaskImpl</code> 然后 JavacTask 会调用 <code>com.sun.tools.javac.main.Main</code> 进行处理，其中创建 JavacTask 的任务是由 <code>JavacTool</code> 完成</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>在使用 Android Studio 以后，基本新的 Android 项目都是用 Gradle 作为构建工具，关于 Gradle 的介绍不在本文范畴，当新建一个 Android 项目时，默认只会有个 module 使用<code>com.android.application</code> 插件，Gradle 的核心在于 task，即从 java 源文件和资源文件编译成 apk 文件（编译过程），就是由一系列的 task 组成，task 可以相互依赖，比如最基本的 <code>Task.dependsOn()</code>，所以理解 Android 编译过程就是理解各个 task 的作用。</p>\n<blockquote>\n<p>本文涉及的源码：</p>\n<ul>\n<li>com.android.tools.build:gradle:3.1.4</li>\n<li>gradle-api-4.4</li>\n</ul>\n</blockquote>\n<h3 id=\"AppPlugin\"><a href=\"#AppPlugin\" class=\"headerlink\" title=\"AppPlugin\"></a>AppPlugin</h3><p><code>com.android.application</code> 的源码位于 <code>com.android.build.gradle.AppPlugin</code>，AppPlugin 继承于 BasePlugin，BasePlugin 封装了大部分通用的逻辑：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">apply</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Project project)</span> &#123;                                            </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 省略初始化步骤</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!projectOptions.get(BooleanOption.ENABLE_NEW_DSL_AND_API)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 不使用新的 DSL API</span></span><br><span class=\"line\">        TaskInputHelper.enableBypass();                                                  </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// threadRecorder 用于记录执行时间</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// configureProject 配置项目</span></span><br><span class=\"line\">        threadRecorder.record(                                                           </span><br><span class=\"line\">                ExecutionType.BASE_PLUGIN_PROJECT_CONFIGURE,                             </span><br><span class=\"line\">                project.getPath(),                                                       </span><br><span class=\"line\">                <span class=\"literal\">null</span>,                                                                    </span><br><span class=\"line\">                <span class=\"built_in\">this</span>::configureProject);                                                 </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// configureExtension 配置 Extension 后，我们才能使用 android &#123;&#125; 进行配置</span></span><br><span class=\"line\">        threadRecorder.record(                                                           </span><br><span class=\"line\">                ExecutionType.BASE_PLUGIN_PROJECT_BASE_EXTENSION_CREATION,               </span><br><span class=\"line\">                project.getPath(),                                                       </span><br><span class=\"line\">                <span class=\"literal\">null</span>,                                                                    </span><br><span class=\"line\">                <span class=\"built_in\">this</span>::configureExtension);                                               </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// createTasks 本文的重点，创建必须的 task</span></span><br><span class=\"line\">        threadRecorder.record(                                                           </span><br><span class=\"line\">                ExecutionType.BASE_PLUGIN_PROJECT_TASKS_CREATION,                        </span><br><span class=\"line\">                project.getPath(),                                                       </span><br><span class=\"line\">                <span class=\"literal\">null</span>,                                                                    </span><br><span class=\"line\">                <span class=\"built_in\">this</span>::createTasks);                                                      </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                             </span><br><span class=\"line\">         <span class=\"comment\">// 省略                   </span></span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">&#125;                                                                                        </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">createTasks</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// createTasksBeforeEvaluate</span></span><br><span class=\"line\">    threadRecorder.record(                                                   </span><br><span class=\"line\">            ExecutionType.TASK_MANAGER_CREATE_TASKS,                         </span><br><span class=\"line\">            project.getPath(),                                               </span><br><span class=\"line\">            <span class=\"literal\">null</span>,                                                            </span><br><span class=\"line\">            () -&gt; taskManager.createTasksBeforeEvaluate());                  </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// afterEvaluate 执行</span></span><br><span class=\"line\">    project.afterEvaluate(                                                   </span><br><span class=\"line\">            project -&gt;                                                       </span><br><span class=\"line\">                    threadRecorder.record(                                   </span><br><span class=\"line\">                            ExecutionType.BASE_PLUGIN_CREATE_ANDROID_TASKS,  </span><br><span class=\"line\">                            project.getPath(),                               </span><br><span class=\"line\">                            <span class=\"literal\">null</span>,                                            </span><br><span class=\"line\">                            () -&gt; createAndroidTasks(<span class=\"literal\">false</span>)));               </span><br><span class=\"line\">&#125;                                                                            </span><br></pre></td></tr></table></figure>\n\n<p>从 <code>createTasks()</code> 可以看到，<code>createAndroidTasks()</code> 是在 <code>afterEvaluate()</code> 中执行的，evaluate 是 Gradle  一个执行的过程</p>\n<blockquote>\n<p>Gradle 编译的三个阶段：Initialization、Configuration、Execution。具体可以阅读 <a href=\"https://docs.gradle.org/current/userguide/build_lifecycle.html\">build_lifecycle</a></p>\n</blockquote>\n<p><code>createAndroidTasks()</code> 这个方法较长，但是我们关心的是 <code>VariantManager.createAndroidTasks()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">createAndroidTasks</span><span class=\"params\">()</span> &#123;                                                    </span><br><span class=\"line\">    variantFactory.validateModel(<span class=\"built_in\">this</span>);                                               </span><br><span class=\"line\">    variantFactory.preVariantWork(project);                                           </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (variantScopes.isEmpty()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 variantScopes</span></span><br><span class=\"line\">        recorder.record(                                                              </span><br><span class=\"line\">                ExecutionType.VARIANT_MANAGER_CREATE_VARIANTS,                        </span><br><span class=\"line\">                project.getPath(),                                                    </span><br><span class=\"line\">                <span class=\"literal\">null</span> <span class=\"comment\">/*variantName*/</span>,                                                 </span><br><span class=\"line\">                <span class=\"built_in\">this</span>::populateVariantDataList);                                       </span><br><span class=\"line\">    &#125;                                                                                 </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">    <span class=\"comment\">// Create top level test tasks.                                                   </span></span><br><span class=\"line\">    recorder.record(                                                                  </span><br><span class=\"line\">            ExecutionType.VARIANT_MANAGER_CREATE_TESTS_TASKS,                         </span><br><span class=\"line\">            project.getPath(),                                                        </span><br><span class=\"line\">            <span class=\"literal\">null</span> <span class=\"comment\">/*variantName*/</span>,                                                     </span><br><span class=\"line\">            () -&gt; taskManager.createTopLevelTestTasks(!productFlavors.isEmpty()));    </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">final</span> VariantScope variantScope : variantScopes) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 为每个 variant 生成各自的 task</span></span><br><span class=\"line\">        recorder.record(                                                              </span><br><span class=\"line\">                ExecutionType.VARIANT_MANAGER_CREATE_TASKS_FOR_VARIANT,               </span><br><span class=\"line\">                project.getPath(),                                                    </span><br><span class=\"line\">                variantScope.getFullVariantName(),                                    </span><br><span class=\"line\">                () -&gt; createTasksForVariantData(variantScope));                       </span><br><span class=\"line\">    &#125;                                                                                 </span><br><span class=\"line\">                                                                                      </span><br><span class=\"line\">    taskManager.createReportTasks(variantScopes);                                     </span><br><span class=\"line\">&#125;                                                                                     </span><br></pre></td></tr></table></figure>\n\n<p>调用 <code>populateVariantDataList()</code> 来生成 VariantScopes，它是由 ProductFlavors、BuildType、VariantType 组合</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">createTasksForVariantData</span><span class=\"params\">(<span class=\"keyword\">final</span> VariantScope variantScope)</span> &#123;                                              </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">BaseVariantData</span> <span class=\"variable\">variantData</span> <span class=\"operator\">=</span> variantScope.getVariantData();                                                </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">VariantType</span> <span class=\"variable\">variantType</span> <span class=\"operator\">=</span> variantData.getType();                                                            </span><br><span class=\"line\">                                                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">GradleVariantConfiguration</span> <span class=\"variable\">variantConfig</span> <span class=\"operator\">=</span> variantScope.getVariantConfiguration();                          </span><br><span class=\"line\">                                                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">BuildTypeData</span> <span class=\"variable\">buildTypeData</span> <span class=\"operator\">=</span> buildTypes.get(variantConfig.getBuildType().getName());                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildTypeData.getAssembleTask() == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 BuildType 的 assemble task</span></span><br><span class=\"line\">        <span class=\"comment\">// 比如 assembleDebug 和 assembleRelease</span></span><br><span class=\"line\">        buildTypeData.setAssembleTask(taskManager.createAssembleTask(buildTypeData));                                 </span><br><span class=\"line\">    &#125;                                                                                                                 </span><br><span class=\"line\">                                                                                                                      </span><br><span class=\"line\">    <span class=\"comment\">// Add dependency of assemble task on assemble build type task.</span></span><br><span class=\"line\">    <span class=\"comment\">// assemble 依赖于 assembleDebug 和 assembleRelease</span></span><br><span class=\"line\">    taskManager                                                                                                       </span><br><span class=\"line\">            .getTaskFactory()                                                                                         </span><br><span class=\"line\">            .configure(                                                                                               </span><br><span class=\"line\">                    <span class=\"string\">&quot;assemble&quot;</span>,                                                                                       </span><br><span class=\"line\">                    task -&gt; &#123;                                                                                         </span><br><span class=\"line\">                        <span class=\"keyword\">assert</span> buildTypeData.getAssembleTask() != <span class=\"literal\">null</span>;                                               </span><br><span class=\"line\">                        task.dependsOn(buildTypeData.getAssembleTask().getName());                                    </span><br><span class=\"line\">                    &#125;);                                                                                               </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 根据 variant 创建 assemble task</span></span><br><span class=\"line\">    createAssembleTaskForVariantData(variantData);                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (variantType.isForTesting()) &#123;                                                                                 </span><br><span class=\"line\">         <span class=\"comment\">// 省略代码                                                                       </span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 根据 variant 创建 task</span></span><br><span class=\"line\">        taskManager.createTasksForVariantScope(variantScope);                                                         </span><br><span class=\"line\">    &#125;                                                                                                                 </span><br><span class=\"line\">&#125;                                                                                                                     </span><br></pre></td></tr></table></figure>\n\n<p>assemble task 用于将源文件编译为最终产物，比如 jar、aar、apk 等，在 <code>createTasksForVariantData()</code> 中会生成对应 BuildType 的 assemble task，比如 <code>assembleDebug</code> 和 <code>assembleRelease</code> ，接着设置 <code>assemble</code> 依赖于这两个 task，最后根据 variant 生成对应的 assemble task，比如 <code>assembleTestDebug</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">createAssembleTaskForVariantData</span><span class=\"params\">(<span class=\"keyword\">final</span> BaseVariantData variantData)</span> &#123;                      </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">VariantScope</span> <span class=\"variable\">variantScope</span> <span class=\"operator\">=</span> variantData.getScope();                                           </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (variantData.getType().isForTesting()) &#123;                                                         </span><br><span class=\"line\">        variantScope.setAssembleTask(taskManager.createAssembleTask(variantData));                      </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                                            </span><br><span class=\"line\">        <span class=\"type\">BuildTypeData</span> <span class=\"variable\">buildTypeData</span> <span class=\"operator\">=</span>                                                                   </span><br><span class=\"line\">                buildTypes.get(variantData.getVariantConfiguration().getBuildType().getName());         </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">        Preconditions.checkNotNull(buildTypeData.getAssembleTask());                                    </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (productFlavors.isEmpty()) &#123;                                                                 </span><br><span class=\"line\">            <span class=\"comment\">// Reuse assemble task for build type if there is no product flavor.                        </span></span><br><span class=\"line\">            variantScope.setAssembleTask(buildTypeData.getAssembleTask());                              </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">            variantData.addTask(                                                                        </span><br><span class=\"line\">                    TaskContainer.TaskKind.ASSEMBLE, buildTypeData.getAssembleTask());                  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 根据 variant 创建对应的 assemble task，比如 assembleTesDebug</span></span><br><span class=\"line\">            variantScope.setAssembleTask(taskManager.createAssembleTask(variantData));                  </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">            <span class=\"comment\">// setup the task dependencies                                                              </span></span><br><span class=\"line\">            <span class=\"comment\">// build type</span></span><br><span class=\"line\">            <span class=\"comment\">// build type assemble task 依赖于 具体的 assemble task</span></span><br><span class=\"line\">            buildTypeData.getAssembleTask().dependsOn(variantScope.getAssembleTask());                  </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">            <span class=\"comment\">// each flavor                                                                              </span></span><br><span class=\"line\">            <span class=\"type\">GradleVariantConfiguration</span> <span class=\"variable\">variantConfig</span> <span class=\"operator\">=</span> variantData.getVariantConfiguration();           </span><br><span class=\"line\">            <span class=\"keyword\">for</span> (CoreProductFlavor flavor : variantConfig.getProductFlavors()) &#123;                        </span><br><span class=\"line\">                <span class=\"type\">ProductFlavorData</span> <span class=\"variable\">productFlavorData</span> <span class=\"operator\">=</span> productFlavors.get(flavor.getName());             </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">                <span class=\"type\">DefaultTask</span> <span class=\"variable\">flavorAssembleTask</span> <span class=\"operator\">=</span> productFlavorData.getAssembleTask();                   </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (flavorAssembleTask == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 创建 flavor 的 assemble task</span></span><br><span class=\"line\">                    <span class=\"comment\">// 比如 assembleTes</span></span><br><span class=\"line\">                    flavorAssembleTask = taskManager.createAssembleTask(productFlavorData);             </span><br><span class=\"line\">                    productFlavorData.setAssembleTask(flavorAssembleTask);                              </span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">// flavor assemble task 依赖于具体的 assemble task</span></span><br><span class=\"line\">                flavorAssembleTask.dependsOn(variantScope.getAssembleTask());                           </span><br><span class=\"line\">            &#125;                                                                                           </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">            <span class=\"comment\">// assembleTask for this flavor(dimension), created on demand if needed.                    </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (variantConfig.getProductFlavors().size() &gt; <span class=\"number\">1</span>) &#123;                                         </span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">name</span> <span class=\"operator\">=</span> StringHelper.capitalize(variantConfig.getFlavorName());             </span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">variantAssembleTaskName</span> <span class=\"operator\">=</span>                                                  </span><br><span class=\"line\">                        StringHelper.appendCapitalized(<span class=\"string\">&quot;assemble&quot;</span>, name);                               </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!taskManager.getTaskFactory().containsKey(variantAssembleTaskName)) &#123;               </span><br><span class=\"line\">                    <span class=\"type\">Task</span> <span class=\"variable\">task</span> <span class=\"operator\">=</span> taskManager.getTaskFactory().create(variantAssembleTaskName);           </span><br><span class=\"line\">                    task.setDescription(<span class=\"string\">&quot;Assembles all builds for flavor combination: &quot;</span> + name);        </span><br><span class=\"line\">                    task.setGroup(<span class=\"string\">&quot;Build&quot;</span>);                                                             </span><br><span class=\"line\">                    task.dependsOn(variantScope.getAssembleTask().getName());                           </span><br><span class=\"line\">                &#125;                                                                                       </span><br><span class=\"line\">                taskManager                                                                             </span><br><span class=\"line\">                        .getTaskFactory()                                                               </span><br><span class=\"line\">                        .configure(                                                                     </span><br><span class=\"line\">                                <span class=\"string\">&quot;assemble&quot;</span>, task1 -&gt; task1.dependsOn(variantAssembleTaskName));         </span><br><span class=\"line\">            &#125;                                                                                           </span><br><span class=\"line\">        &#125;                                                                                               </span><br><span class=\"line\">    &#125;                                                                                                   </span><br><span class=\"line\">&#125;                                                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>上面会生成包括 BuildType、Flavor、BuildType + Flavor + VariantType 的 assemble task，同时 task 之间存在依赖关系：<code>assemble &gt; buildType/flavor &gt; 具体 </code> </p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/assemble-task-demo.png?x-oss-process=style/doc-img\" alt=\"assemble-task-demo\"></p>\n<p>除了上面所说的 assemble task，还将生成以下 task：</p>\n<table>\n<thead>\n<tr>\n<th>task</th>\n<th>impl</th>\n<th>dependsOn</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>assemble{variant}</td>\n<td>DefaultTask</td>\n<td>compile{variant}Sources，package{variant}</td>\n</tr>\n<tr>\n<td>pre{variant}Build</td>\n<td>AppPreBuildTask</td>\n<td>preBuild，extractProguardFiles(可能)</td>\n</tr>\n<tr>\n<td>extractProguardFiles</td>\n<td>ExtractProguardFiles</td>\n<td></td>\n</tr>\n<tr>\n<td>generate{variant}Sources</td>\n<td>DefaultTask</td>\n<td>compile{variant}Renderscript，generate{variant}BuildConfig，bundle{variant}Resources，compile{variant}Aidl</td>\n</tr>\n<tr>\n<td>generate{variant}Resources</td>\n<td>DefaultTask</td>\n<td>generate{variant}ResValues，compile{variant}Renderscript</td>\n</tr>\n<tr>\n<td>generate{variant}Assets</td>\n<td>DefaultTask</td>\n<td>compile{variant}Shaders</td>\n</tr>\n<tr>\n<td>compile{variant}Sources</td>\n<td>DefaultTask</td>\n<td>compile{variant}Ndk，compile{variant}JavaWithJavac</td>\n</tr>\n<tr>\n<td>check{variant}Manifest</td>\n<td>CheckManifest</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>write{variant}ApplicationId</td>\n<td>ApplicationIdIdWriteTask</td>\n<td></td>\n</tr>\n<tr>\n<td>mainApkListPersistence{variant}</td>\n<td>MainApkListPersistence</td>\n<td></td>\n</tr>\n<tr>\n<td>reportBuildArtifacts{variant}</td>\n<td>BuildArtifactReportTask</td>\n<td></td>\n</tr>\n<tr>\n<td>create{variant}CompatibleScreenManifests</td>\n<td>CompatibleScreensManifest</td>\n<td></td>\n</tr>\n<tr>\n<td>process{variant}Manifest</td>\n<td>MergeManifests</td>\n<td>check{variant}Manifest</td>\n</tr>\n<tr>\n<td>generate{variant}ResValues</td>\n<td>GenerateResValues</td>\n<td></td>\n</tr>\n<tr>\n<td>compile{variant}Renderscript</td>\n<td>RenderscriptCompile</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>merge{variant}Resources</td>\n<td>MergeResources</td>\n<td>generate{variant}Resources</td>\n</tr>\n<tr>\n<td>merge{variant}Shaders</td>\n<td>MergeSourceSetFolders</td>\n<td></td>\n</tr>\n<tr>\n<td>compile{variant}Shaders</td>\n<td>ShaderCompile</td>\n<td>merge{variant}Shaders</td>\n</tr>\n<tr>\n<td>merge{variant}Assets</td>\n<td>MergeSourceSetFolders</td>\n<td>generate{variant}Assets</td>\n</tr>\n<tr>\n<td>generate{variant}BuildConfig</td>\n<td>GenerateBuildConfig</td>\n<td>check{variant}Manifest</td>\n</tr>\n<tr>\n<td>splitsDiscoveryTask{variant}</td>\n<td>SplitsDiscovery</td>\n<td></td>\n</tr>\n<tr>\n<td>process{variant}JavaRes</td>\n<td>Sync</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>process{variant}Resources</td>\n<td>LinkApplicationAndroidResourcesTask</td>\n<td></td>\n</tr>\n<tr>\n<td>bundle{variant}Resources</td>\n<td>LinkAndroidResForBundleTask</td>\n<td></td>\n</tr>\n<tr>\n<td>compile{variant}Aidl</td>\n<td>AidlCompile</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>compile{variant}Ndk</td>\n<td>NdkCompile</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>merge{variant}JniLibFolders</td>\n<td>MergeSourceSetFolders</td>\n<td>generate{variant}Assets</td>\n</tr>\n<tr>\n<td>javaPreCompile{variant}</td>\n<td>JavaPreCompileTask</td>\n<td>pre{variant}Build</td>\n</tr>\n<tr>\n<td>compile{variant}JavaWithJavac</td>\n<td>AndroidJavaCompile</td>\n<td>generate{variant}Sources</td>\n</tr>\n<tr>\n<td>bundleAppClasses{variant}</td>\n<td>Jar</td>\n<td></td>\n</tr>\n<tr>\n<td>transformResourcesWithMergeJavaResFor{variant}</td>\n<td>TransformTask</td>\n<td></td>\n</tr>\n<tr>\n<td>transformClassesWithMultidexlistFor{variant}</td>\n<td>TransformTask</td>\n<td></td>\n</tr>\n<tr>\n<td>transformClassesWithDexBuilderFor{variant}</td>\n<td>TransformTask</td>\n<td></td>\n</tr>\n<tr>\n<td>transformDexArchiveWithDexMergerFor{variant}</td>\n<td>TransformTask</td>\n<td>transformClassesWithMultidexlistFor{variant}</td>\n</tr>\n<tr>\n<td>preparePUBLISHED_JAVA_RES{variant}ForPublishing</td>\n<td>PipelineToPublicationTask</td>\n<td></td>\n</tr>\n<tr>\n<td>package{variant}</td>\n<td>PackageApplication</td>\n<td>merge{variant}Assets，process{variant}Resources，validateSigning{variant}，compile{variant}JavaWithJavac</td>\n</tr>\n<tr>\n<td>validateSigning{variant}</td>\n<td>ValidateSigningTask</td>\n<td></td>\n</tr>\n<tr>\n<td>install{variant}</td>\n<td>InstallVariantTask</td>\n<td>assemble{variant}</td>\n</tr>\n<tr>\n<td>uninstall{variant}</td>\n<td>UninstallTask</td>\n<td></td>\n</tr>\n<tr>\n<td>lint{variant}</td>\n<td>LintPerVariantTask</td>\n<td></td>\n</tr>\n</tbody></table>\n<p>以 <code>assembleProdRelease</code> 命令，依次执行的 task：</p>\n<blockquote>\n<p>prod 是 product flavor</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">preBuild</span><br><span class=\"line\">extractProguardFiles</span><br><span class=\"line\">preProdReleaseBuild</span><br><span class=\"line\">compileProdReleaseRenderscript</span><br><span class=\"line\">checkProdReleaseManifest</span><br><span class=\"line\">generateProdReleaseBuildConfig</span><br><span class=\"line\">prepareLintJar</span><br><span class=\"line\">mainApkListPersistenceProdRelease</span><br><span class=\"line\">generateProdReleaseResValues</span><br><span class=\"line\">generateProdReleaseResources</span><br><span class=\"line\">compileProdReleaseAidl</span><br><span class=\"line\">createProdReleaseCompatibleScreenManifests</span><br><span class=\"line\">processProdReleaseManifest</span><br><span class=\"line\">mergeProdReleaseResources  // 合并资源</span><br><span class=\"line\">splitsDiscoveryTaskProdRelease</span><br><span class=\"line\">processProdReleaseResources</span><br><span class=\"line\">generateProdReleaseSources</span><br><span class=\"line\">javaPreCompileProdRelease</span><br><span class=\"line\">compileProdReleaseJavaWithJavac // javac</span><br><span class=\"line\">compileProdReleaseNdk</span><br><span class=\"line\">compileProdReleaseSources</span><br><span class=\"line\">mergeProdReleaseShaders</span><br><span class=\"line\">compileProdReleaseShaders</span><br><span class=\"line\">generateProdReleaseAssets</span><br><span class=\"line\">mergeProdReleaseAssets</span><br><span class=\"line\">transformClassesWithComponentCodeForProdRelease </span><br><span class=\"line\">processProdReleaseJavaRes</span><br><span class=\"line\">transformResourcesWithMergeJavaResForProdRelease</span><br><span class=\"line\">transformClassesAndResourcesWithProguardForProdRelease // 混淆</span><br><span class=\"line\">transformClassesWithMultidexlistForProdRelease</span><br><span class=\"line\">transformClassesWithDexForProdRelease\t\t\t\t// dex</span><br><span class=\"line\">transformClassesWithShrinkResForProdRelease</span><br><span class=\"line\">mergeProdReleaseJniLibFolders</span><br><span class=\"line\">transformNativeLibsWithMergeJniLibsForProdRelease</span><br><span class=\"line\">validateSigningProdRelease</span><br><span class=\"line\">packageProdRelease</span><br></pre></td></tr></table></figure>\n\n<p>接下来分析下比较重要的几个 task</p>\n<blockquote>\n<p>接下来的分析，因为对应的源码比较复杂，所以只会简短介绍结果，没有详细过程，推荐 debug 整个流程</p>\n</blockquote>\n<h3 id=\"CompileJavaWithJavac\"><a href=\"#CompileJavaWithJavac\" class=\"headerlink\" title=\"CompileJavaWithJavac\"></a>CompileJavaWithJavac</h3><p>首先找到执行的 AndroidJavaCompile</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// AndroidJavaCompile.java</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">compile</span><span class=\"params\">(IncrementalTaskInputs inputs)</span> &#123;                                          </span><br><span class=\"line\">    <span class=\"comment\">// compileSdkVersion &gt;= 24，需要使用 jdk1.8                                                     </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isPostN()) &#123;                                                                            </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!JavaVersion.current().isJava8Compatible()) &#123;                                       </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;compileSdkVersion &#x27;&quot;</span> + compileSdkVersion + <span class=\"string\">&quot;&#x27; requires &quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot;JDK 1.8 or later to compile.&quot;</span>);                                          </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 处理注解处理器，在之前 task 会将使用 annotationProcessor 标示的注解处理器写入到 annotationProcessors.json 中</span></span><br><span class=\"line\">    processAnalytics();                                                                         </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">    <span class=\"comment\">// Create directory for output of annotation processor.                                     </span></span><br><span class=\"line\">    FileUtils.mkdirs(annotationProcessorOutputFolder);                                          </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">    mInstantRunBuildContext.startRecording(InstantRunBuildContext.TaskType.JAVAC);</span><br><span class=\"line\">    <span class=\"comment\">// 调用 JavaCompile.compile</span></span><br><span class=\"line\">    <span class=\"built_in\">super</span>.compile(inputs);                                                                      </span><br><span class=\"line\">    mInstantRunBuildContext.stopRecording(InstantRunBuildContext.TaskType.JAVAC);               </span><br><span class=\"line\">&#125;                                                                                               </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// JavaCompile.java</span></span><br><span class=\"line\"><span class=\"meta\">@TaskAction</span>                                                                                                                                                                                                                                                                                                           </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">compile</span><span class=\"params\">(IncrementalTaskInputs inputs)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 是否为增量编译</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">this</span>.compileOptions.isIncremental()) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.compile();                                                                                                                                                                                                                                                                                               </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                                                                                                                                                                                                                                                          </span><br><span class=\"line\">        <span class=\"type\">DefaultJavaCompileSpec</span> <span class=\"variable\">spec</span> <span class=\"operator\">=</span> <span class=\"built_in\">this</span>.createSpec();                                                                                                                                                                                                                                                              </span><br><span class=\"line\">        <span class=\"type\">CompileCaches</span> <span class=\"variable\">compileCaches</span> <span class=\"operator\">=</span> <span class=\"built_in\">this</span>.createCompileCaches();                                                                                                                                                                                                                                                     </span><br><span class=\"line\">        <span class=\"type\">IncrementalCompilerFactory</span> <span class=\"variable\">factory</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IncrementalCompilerFactory</span>(<span class=\"built_in\">this</span>.getFileOperations(), <span class=\"built_in\">this</span>.getStreamHasher(), <span class=\"built_in\">this</span>.getCachingFileHasher(), <span class=\"built_in\">this</span>.getPath(), <span class=\"built_in\">this</span>.createCompiler(spec), <span class=\"built_in\">this</span>.source, compileCaches, (IncrementalTaskInputsInternal)inputs, <span class=\"built_in\">this</span>.getEffectiveAnnotationProcessorPath()); </span><br><span class=\"line\">        Compiler&lt;JavaCompileSpec&gt; compiler = factory.createCompiler();                                                                                                                                                                                                                                                </span><br><span class=\"line\">        <span class=\"built_in\">this</span>.performCompilation(spec, compiler);                                                                                                                                                                                                                                                                      </span><br><span class=\"line\">    &#125;                                                                                                                                                                                                                                                                                                                 </span><br><span class=\"line\">&#125;                                                                                                                                                                                                                                                                                                                     </span><br></pre></td></tr></table></figure>\n\n<p>不管是增量编译还是全量编译，最后都会调用 <code>performCompilation</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performCompilation</span><span class=\"params\">(JavaCompileSpec spec, Compiler&lt;JavaCompileSpec&gt; compiler)</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 执行编译</span></span><br><span class=\"line\">    <span class=\"type\">WorkResult</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> compiler.execute(spec);                                             </span><br><span class=\"line\">    <span class=\"built_in\">this</span>.setDidWork(result.getDidWork());                                                   </span><br><span class=\"line\">&#125;                                                                                           </span><br></pre></td></tr></table></figure>\n\n<p>Compiler 采用<strong>装饰者设计模式</strong>，最外层是 <code>CleaningJavaCompilerSupport</code> 会先删除编译目录，再调用 <code>JdkJavaCompiler</code> 执行 <code>javac</code> 过程，具体为，创建一个 <code>JavacTaskImpl</code> 然后 JavacTask 会调用 <code>com.sun.tools.javac.main.Main</code> 进行处理，其中创建 JavacTask 的任务是由 <code>JavacTool</code> 完成</p>\n"},{"title":"Flutter ListView 源码分析","date":"2019-06-17T11:45:51.000Z","_content":"\n### 前言\n\n不得不说，Flutter 绘制 UI 的速度和原生根本不是一个量级的，Flutter 要快的多了，比如常用的 `ListView` 控件，原生写的话，比如 Android，如果不封装的话，需要一个 `Adapter`、`ViewHolder`，再加个 xml 布局文件，而 Flutter 可能就几十行。\n\n对于越常用的控件，越要熟悉它的原理。Flutter 中的 `ScrollView` 家族，成员的划分其实和 Android 还是非常类似的，除了 `ListView`、`GridView`，还有 `CustomScrollView` 和 `NestedScrollView`。今天我们要讲主角就是 `ListView`。\n\n### ListView\n\n`ListView` 和 `GridView` 都继承于 `BoxScrollView`，但这里并不是绘制和布局的地方，Flutter 和原生不太一样，以 Android 为例，Android 上绘制和布局的单位是 `View` 和 `ViewGroup`，Flutter 则要复杂一点，首先我们用的最多的是各种 `Widget`，比如 `ListView`，但 `Widget` 可以理解为一个配置描述文件，比如以下代码：\n\n```dart\nContainer {\n  width: 100,\n  height: 100,\n  color: Colors.white,\n}\n```\n\n这里描述了我们需要一个宽高为 100，颜色为白色的容器，最后真正去绘制的是 `RenderObject`。而在 `Widget` 和 `RenderObject` 之间还有个 `Element`，它的职责是，将我们配置的 Widget Tree 转换成 Element Tree，`Element` 是对 `Widget` 的进一步抽象，`Element` 有两个子类，一个是 `RenderObjectElement`，它持有 `RenderObject`，还有一个 `ComponentElement` ，用于组合多个 `RenderObjectElement`。这个是 Flutter UI 的核心，要理解好这三个类。\n\n回到我们的主题上来，我们前面说到 `ListView` 继承于 `BoxScrollView`，而 `BoxScrollView` 又继承于 `ScrollView`，`ScrollView` 是一个 `StatelessWidget`，它依靠 `Scrollable` 实现滚动效果，而滚动容器中的 `Widget`，称为 slivers。sliver 用于消费滚动事件。\n\n```dart\n@override                                                              \nWidget build(BuildContext context) {\n  // slivers\n  final List<Widget> slivers = buildSlivers(context);                  \n  final AxisDirection axisDirection = getDirection(context);           \n                                                                       \n  // 省略                                                          \n  return primary && scrollController != null                           \n    ? PrimaryScrollController.none(child: scrollable)                  \n    : scrollable;                                                      \n}                                                                      \n```\n\n`BoxScrollView` 实现了 `buildSlivers()`，它只有一个 sliver，也就是滚动容器中，只有一个消费者。这里又是通过调用 `buildChildLayout` 抽象方法创建。\n\n```dart\n@override                                                                         \nList<Widget> buildSlivers(BuildContext context) {\n  // buildChildLayout\n  Widget sliver = buildChildLayout(context);                                      \n  EdgeInsetsGeometry effectivePadding = padding;                                  \n  // 省略            \n  return <Widget>[ sliver ];                                                      \n}                                                                                 \n```\n\n最后我们的 `ListView` 就实现了 `buildChildLayout()`：\n\n```dart\n@override                                        \nWidget buildChildLayout(BuildContext context) {  \n  if (itemExtent != null) { \n    // 如果子项是固定高度的\n    return SliverFixedExtentList(                \n      delegate: childrenDelegate,                \n      itemExtent: itemExtent,                    \n    );                                           \n  }\n  // 默认情况\n  return SliverList(delegate: childrenDelegate); \n}                                                \n```\n\n`SliverList` 是一个 `RenderObjectWidget`，上面我们也说到了，最终绘制和布局都是交与 `RenderObject` 去实现的。`ListView` 也不例外：\n\n```dart\n@override                                                     \nRenderSliverList createRenderObject(BuildContext context) {   \n  final SliverMultiBoxAdaptorElement element = context;       \n  return RenderSliverList(childManager: element);             \n}                                                             \n```\n\n`RenderSliverList` 是 `ListView` 的核心实现，也是我们本文的重点。\n\n### RenderSliverList\n\n有过 Android 自定义控件经验的同学会知道，当我们自定义一个控件时，一般会涉及这几个步骤：measure 和 draw，如果是自定义 `ViewGroup` 还会涉及 layout 过程，Flutter 也不例外，但它将 measure 和 layout 合并到 layout，draw 称为 paint。虽然叫法不一样，但作用是一样的。系统会调用 `performLayout()` 会执行测量和布局，`RenderSliverList` 主要涉及布局操作，所以我们主要看下这个方法即可。\n\n`performLayout()` 代码比较长，所以我们会省略一些非核心代码。\n\n```dart\nfinal double scrollOffset = constraints.scrollOffset + constraints.cacheOrigin;\nassert(scrollOffset >= 0.0);                                                   \nfinal double remainingExtent = constraints.remainingCacheExtent;               \nassert(remainingExtent >= 0.0);                                                \nfinal double targetEndScrollOffset = scrollOffset + remainingExtent;           \nfinal BoxConstraints childConstraints = constraints.asBoxConstraints();        \n```\n\n`scrollOffset` 表示已滚动的偏移量，`cacheOrigin` 表示预布局的相对位置。为了更好的视觉效果，`ListView` 会在可见范围内增加预布局的区域，这里表示下一次滚动即将展示的区域，称为 `cacheExtent`。这个值可以配置，默认为 250。\n\n```dart\n// viewport.dart\ndouble get cacheExtent => _cacheExtent;                       \ndouble _cacheExtent;                                          \nset cacheExtent(double value) {                               \n  value = value ?? RenderAbstractViewport.defaultCacheExtent; \n  assert(value != null);                                      \n  if (value == _cacheExtent)                                  \n    return;                                                   \n  _cacheExtent = value;                                       \n  markNeedsLayout();                                          \n}\n\nstatic const double defaultCacheExtent = 250.0;\n```\n\n`remainingCacheExtent` 是当前该 sliver 可使用的偏移量，这里包含了预布局的区域。这里我们用一张非常粗糙的图片来解释下。\n![flutter_listview_1](https://user-gold-cdn.xitu.io/2019/6/17/16b646bfbfd7ca4b?w=2976&h=3968&f=jpeg&s=1164921)\n\nC 区域表示我们的屏幕，这里我们认为是可见区域，实际情况下，可能还要更小，因为 `ListView` 可能有些 `padding`、`magin` 或者其他布局等。B 区域有两个分别表示头部的预布局和底部的预布局区域，它的值就是我们设置的 `cacheExtent`，A 区域回收区域。\n\n```dart\nfinal double scrollOffset = constraints.scrollOffset + constraints.cacheOrigin;\n```\n\n这里的 `constraints.scrollOffset` 就是 A + B，即可不见区域。`constraints.cacheOrigin` 在这里，如果使用默认值，它等于 -250，意思就是说 B 的区域高度有 250，所以它完全不可见时，它的相对位置 y 值就是 -250，这里算出的 `scrollOffset` 其实就是开始布局的起始位置，如果 `cacheExtent = 0`，那么它会从 C 的顶部开始布局，即 `constraints.scrollOffset` 否则就是 `constraints.scrollOffset + constraints.cacheOrigin`。\n\n```dart\n if (firstChild == null) {\n   // 如果没有 children\n   if (!addInitialChild()) {                                                              \n     // There are no children.                                                            \n     geometry = SliverGeometry.zero;                                                      \n     childManager.didFinishLayout();                                                      \n     return;                                                                              \n   }                                                                                      \n }                                                                                        \n                                                                                          \n // 至少存在一个 children\n // leading 头部，trailing 尾部\n RenderBox leadingChildWithLayout, trailingChildWithLayout;                               \n                                                                                          \n // Find the last child that is at or before the scrollOffset.                            \n RenderBox earliestUsefulChild = firstChild;                                              \n for (double earliestScrollOffset = childScrollOffset(earliestUsefulChild);               \n earliestScrollOffset > scrollOffset;                                                     \n earliestScrollOffset = childScrollOffset(earliestUsefulChild)) { \n   // 在头部插入新的 children                             \n   earliestUsefulChild =                                                                  \n       insertAndLayoutLeadingChild(childConstraints, parentUsesSize: true);               \n                                                                                          \n   if (earliestUsefulChild == null) {\n     final SliverMultiBoxAdaptorParentData childParentData = firstChild                   \n         .parentData;                                                                     \n     childParentData.layoutOffset = 0.0;                                                  \n                                                                                          \n     if (scrollOffset == 0.0) {                                                           \n       earliestUsefulChild = firstChild;                                                  \n       leadingChildWithLayout = earliestUsefulChild;                                      \n       trailingChildWithLayout ??= earliestUsefulChild;                                   \n       break;                                                                             \n     } else {                                                                             \n       // We ran out of children before reaching the scroll offset.                       \n       // We must inform our parent that this sliver cannot fulfill                       \n       // its contract and that we need a scroll offset correction.                       \n       geometry = SliverGeometry(                                                         \n         scrollOffsetCorrection: -scrollOffset,                                           \n       );                                                                                 \n       return;                                                                            \n     }                                                                                    \n   }                                                                                      \n                                                                                          \n   final double firstChildScrollOffset = earliestScrollOffset -                           \n       paintExtentOf(firstChild);                                                         \n   if (firstChildScrollOffset < -precisionErrorTolerance) {                               \n     // 双精度错误                                               \n   }                                                                                      \n                                                                                          \n   final SliverMultiBoxAdaptorParentData childParentData = earliestUsefulChild            \n       .parentData;\n   // 更新 parentData\n   childParentData.layoutOffset = firstChildScrollOffset;                                 \n   assert(earliestUsefulChild == firstChild); \n   // 更新头尾\n   leadingChildWithLayout = earliestUsefulChild;                                          \n   trailingChildWithLayout ??= earliestUsefulChild;                                       \n }                                                                                        \n                                                                                          \n```\n\n上面的代码是处理以下这种情况，即 `earliestScrollOffset > scrollOffset`，即头部的 children 和 `scrollOffset` 之间有空间，没有填充。画个简单的图形。\n![flutter_listview_2](https://user-gold-cdn.xitu.io/2019/6/17/16b646e1abfea9ed?w=2976&h=3968&f=jpeg&s=1088673)\n\n这块区域就是 needLayout。当从下向上滚动时候，就是这里在进行布局。\n\n```dart\nbool inLayoutRange = true;                                                          \nRenderBox child = earliestUsefulChild;                                              \nint index = indexOf(child);\n// endScrollOffset 表示当前已经布局 children 的偏移量\ndouble endScrollOffset = childScrollOffset(child) + paintExtentOf(child);           \nbool advance() {                                                                    \n  assert(child != null);                                                            \n  if (child == trailingChildWithLayout)                                             \n    inLayoutRange = false;                                                          \n  child = childAfter(child);                                                        \n  if (child == null)                                                                \n    inLayoutRange = false;                                                          \n  index += 1;                                                                       \n  if (!inLayoutRange) {                                                             \n    if (child == null || indexOf(child) != index) {\n      // 需要布局新的 children，在尾部插入一个新的\n      child = insertAndLayoutChild(childConstraints,                                \n        after: trailingChildWithLayout,                                             \n        parentUsesSize: true,                                                       \n      );                                                                            \n      if (child == null) {                                                          \n        // We have run out of children.                                             \n        return false;                                                               \n      }                                                                             \n    } else {                                                                        \n      // Lay out the child.                                                         \n      child.layout(childConstraints, parentUsesSize: true);                         \n    }                                                                               \n    trailingChildWithLayout = child;                                                \n  }                                                                                 \n  assert(child != null);                                                            \n  final SliverMultiBoxAdaptorParentData childParentData = child.parentData;         \n  childParentData.layoutOffset = endScrollOffset;                                   \n  assert(childParentData.index == index);\n  // 更新 endScrollOffset，用当前 child 的偏移量 + child 所需要的范围\n  endScrollOffset = childScrollOffset(child) + paintExtentOf(child);                \n  return true;                                                                      \n}                                                                                   \n```\n\n```dart\n// Find the first child that ends after the scroll offset.                                  \nwhile (endScrollOffset < scrollOffset) {\n  // 记录需要回收的项目\n  leadingGarbage += 1;                                                                      \n  if (!advance()) {                                                                         \n    assert(leadingGarbage == childCount);                                                   \n    assert(child == null);                                                                  \n    // we want to make sure we keep the last child around so we know the end scroll offset  \n    collectGarbage(leadingGarbage - 1, 0);                                                  \n    assert(firstChild == lastChild);                                                        \n    final double extent = childScrollOffset(lastChild) +                                    \n        paintExtentOf(lastChild);                                                           \n    geometry = SliverGeometry(                                                              \n      scrollExtent: extent,                                                                 \n      paintExtent: 0.0,                                                                     \n      maxPaintExtent: extent,                                                               \n    );                                                                                      \n    return;                                                                                 \n  }                                                                                         \n}                                                                                           \n```\n\n不在可见视图，不在缓存区域的，记录头部需要回收的。\n\n```dart\n// Now find the first child that ends after our end.    \nwhile (endScrollOffset < targetEndScrollOffset) {       \n  if (!advance()) {                                     \n    reachedEnd = true;                                  \n    break;                                              \n  }                                                     \n}                                                       \n```\n\n从上往下滚动时，调用 `advance()` 不断在底部插入新的 child。\n\n```dart\n// Finally count up all the remaining children and label them as garbage.    \nif (child != null) {                                                         \n  child = childAfter(child);                                                 \n  while (child != null) {                                                    \n    trailingGarbage += 1;                                                    \n    child = childAfter(child);                                               \n  }                                                                          \n}\n// 回收\ncollectGarbage(leadingGarbage, trailingGarbage); \n```\n\n记录尾部需要回收的，全部一起回收。上图中用 nedd grabage 标记的区域。\n\n```dart\ndouble estimatedMaxScrollOffset;                                         \nif (reachedEnd) {\n  // 没有 child 需要布局了\n  estimatedMaxScrollOffset = endScrollOffset;                            \n} else {                                                                 \n  estimatedMaxScrollOffset = childManager.estimateMaxScrollOffset(       \n    constraints,                                                         \n    firstIndex: indexOf(firstChild),                                     \n    lastIndex: indexOf(lastChild),                                       \n    leadingScrollOffset: childScrollOffset(firstChild),                  \n    trailingScrollOffset: endScrollOffset,                               \n  );                                                                     \n  assert(estimatedMaxScrollOffset >=                                     \n      endScrollOffset - childScrollOffset(firstChild));                  \n}                                                                        \nfinal double paintExtent = calculatePaintOffset(                         \n  constraints,                                                           \n  from: childScrollOffset(firstChild),                                   \n  to: endScrollOffset,                                                   \n);                                                                       \nfinal double cacheExtent = calculateCacheOffset(                         \n  constraints,                                                           \n  from: childScrollOffset(firstChild),                                   \n  to: endScrollOffset,                                                   \n);                                                                       \nfinal double targetEndScrollOffsetForPaint = constraints.scrollOffset +  \n    constraints.remainingPaintExtent;\n// 反馈布局消费请求\ngeometry = SliverGeometry(                                               \n  scrollExtent: estimatedMaxScrollOffset,                                \n  paintExtent: paintExtent,                                              \n  cacheExtent: cacheExtent,                                              \n  maxPaintExtent: estimatedMaxScrollOffset,                              \n  // Conservative to avoid flickering away the clip during scroll.       \n  hasVisualOverflow: endScrollOffset > targetEndScrollOffsetForPaint ||  \n      constraints.scrollOffset > 0.0,                                    \n);\n\n// 布局结束\nchildManager.didFinishLayout(); \n```\n\n### 总结\n\n在分析完 `ListView` 的布局流程后，可以发现整个流程还是比较清晰的。\n\n1. 需要布局的区域包括可见区域和缓存区域\n2. 在布局区域以外的进行回收","source":"_posts/Flutter-ListView-源码分析.md","raw":"---\ntitle: Flutter ListView 源码分析\ndate: 2019-06-17 19:45:51\ncategories: Flutter\ntags: \n---\n\n### 前言\n\n不得不说，Flutter 绘制 UI 的速度和原生根本不是一个量级的，Flutter 要快的多了，比如常用的 `ListView` 控件，原生写的话，比如 Android，如果不封装的话，需要一个 `Adapter`、`ViewHolder`，再加个 xml 布局文件，而 Flutter 可能就几十行。\n\n对于越常用的控件，越要熟悉它的原理。Flutter 中的 `ScrollView` 家族，成员的划分其实和 Android 还是非常类似的，除了 `ListView`、`GridView`，还有 `CustomScrollView` 和 `NestedScrollView`。今天我们要讲主角就是 `ListView`。\n\n### ListView\n\n`ListView` 和 `GridView` 都继承于 `BoxScrollView`，但这里并不是绘制和布局的地方，Flutter 和原生不太一样，以 Android 为例，Android 上绘制和布局的单位是 `View` 和 `ViewGroup`，Flutter 则要复杂一点，首先我们用的最多的是各种 `Widget`，比如 `ListView`，但 `Widget` 可以理解为一个配置描述文件，比如以下代码：\n\n```dart\nContainer {\n  width: 100,\n  height: 100,\n  color: Colors.white,\n}\n```\n\n这里描述了我们需要一个宽高为 100，颜色为白色的容器，最后真正去绘制的是 `RenderObject`。而在 `Widget` 和 `RenderObject` 之间还有个 `Element`，它的职责是，将我们配置的 Widget Tree 转换成 Element Tree，`Element` 是对 `Widget` 的进一步抽象，`Element` 有两个子类，一个是 `RenderObjectElement`，它持有 `RenderObject`，还有一个 `ComponentElement` ，用于组合多个 `RenderObjectElement`。这个是 Flutter UI 的核心，要理解好这三个类。\n\n回到我们的主题上来，我们前面说到 `ListView` 继承于 `BoxScrollView`，而 `BoxScrollView` 又继承于 `ScrollView`，`ScrollView` 是一个 `StatelessWidget`，它依靠 `Scrollable` 实现滚动效果，而滚动容器中的 `Widget`，称为 slivers。sliver 用于消费滚动事件。\n\n```dart\n@override                                                              \nWidget build(BuildContext context) {\n  // slivers\n  final List<Widget> slivers = buildSlivers(context);                  \n  final AxisDirection axisDirection = getDirection(context);           \n                                                                       \n  // 省略                                                          \n  return primary && scrollController != null                           \n    ? PrimaryScrollController.none(child: scrollable)                  \n    : scrollable;                                                      \n}                                                                      \n```\n\n`BoxScrollView` 实现了 `buildSlivers()`，它只有一个 sliver，也就是滚动容器中，只有一个消费者。这里又是通过调用 `buildChildLayout` 抽象方法创建。\n\n```dart\n@override                                                                         \nList<Widget> buildSlivers(BuildContext context) {\n  // buildChildLayout\n  Widget sliver = buildChildLayout(context);                                      \n  EdgeInsetsGeometry effectivePadding = padding;                                  \n  // 省略            \n  return <Widget>[ sliver ];                                                      \n}                                                                                 \n```\n\n最后我们的 `ListView` 就实现了 `buildChildLayout()`：\n\n```dart\n@override                                        \nWidget buildChildLayout(BuildContext context) {  \n  if (itemExtent != null) { \n    // 如果子项是固定高度的\n    return SliverFixedExtentList(                \n      delegate: childrenDelegate,                \n      itemExtent: itemExtent,                    \n    );                                           \n  }\n  // 默认情况\n  return SliverList(delegate: childrenDelegate); \n}                                                \n```\n\n`SliverList` 是一个 `RenderObjectWidget`，上面我们也说到了，最终绘制和布局都是交与 `RenderObject` 去实现的。`ListView` 也不例外：\n\n```dart\n@override                                                     \nRenderSliverList createRenderObject(BuildContext context) {   \n  final SliverMultiBoxAdaptorElement element = context;       \n  return RenderSliverList(childManager: element);             \n}                                                             \n```\n\n`RenderSliverList` 是 `ListView` 的核心实现，也是我们本文的重点。\n\n### RenderSliverList\n\n有过 Android 自定义控件经验的同学会知道，当我们自定义一个控件时，一般会涉及这几个步骤：measure 和 draw，如果是自定义 `ViewGroup` 还会涉及 layout 过程，Flutter 也不例外，但它将 measure 和 layout 合并到 layout，draw 称为 paint。虽然叫法不一样，但作用是一样的。系统会调用 `performLayout()` 会执行测量和布局，`RenderSliverList` 主要涉及布局操作，所以我们主要看下这个方法即可。\n\n`performLayout()` 代码比较长，所以我们会省略一些非核心代码。\n\n```dart\nfinal double scrollOffset = constraints.scrollOffset + constraints.cacheOrigin;\nassert(scrollOffset >= 0.0);                                                   \nfinal double remainingExtent = constraints.remainingCacheExtent;               \nassert(remainingExtent >= 0.0);                                                \nfinal double targetEndScrollOffset = scrollOffset + remainingExtent;           \nfinal BoxConstraints childConstraints = constraints.asBoxConstraints();        \n```\n\n`scrollOffset` 表示已滚动的偏移量，`cacheOrigin` 表示预布局的相对位置。为了更好的视觉效果，`ListView` 会在可见范围内增加预布局的区域，这里表示下一次滚动即将展示的区域，称为 `cacheExtent`。这个值可以配置，默认为 250。\n\n```dart\n// viewport.dart\ndouble get cacheExtent => _cacheExtent;                       \ndouble _cacheExtent;                                          \nset cacheExtent(double value) {                               \n  value = value ?? RenderAbstractViewport.defaultCacheExtent; \n  assert(value != null);                                      \n  if (value == _cacheExtent)                                  \n    return;                                                   \n  _cacheExtent = value;                                       \n  markNeedsLayout();                                          \n}\n\nstatic const double defaultCacheExtent = 250.0;\n```\n\n`remainingCacheExtent` 是当前该 sliver 可使用的偏移量，这里包含了预布局的区域。这里我们用一张非常粗糙的图片来解释下。\n![flutter_listview_1](https://user-gold-cdn.xitu.io/2019/6/17/16b646bfbfd7ca4b?w=2976&h=3968&f=jpeg&s=1164921)\n\nC 区域表示我们的屏幕，这里我们认为是可见区域，实际情况下，可能还要更小，因为 `ListView` 可能有些 `padding`、`magin` 或者其他布局等。B 区域有两个分别表示头部的预布局和底部的预布局区域，它的值就是我们设置的 `cacheExtent`，A 区域回收区域。\n\n```dart\nfinal double scrollOffset = constraints.scrollOffset + constraints.cacheOrigin;\n```\n\n这里的 `constraints.scrollOffset` 就是 A + B，即可不见区域。`constraints.cacheOrigin` 在这里，如果使用默认值，它等于 -250，意思就是说 B 的区域高度有 250，所以它完全不可见时，它的相对位置 y 值就是 -250，这里算出的 `scrollOffset` 其实就是开始布局的起始位置，如果 `cacheExtent = 0`，那么它会从 C 的顶部开始布局，即 `constraints.scrollOffset` 否则就是 `constraints.scrollOffset + constraints.cacheOrigin`。\n\n```dart\n if (firstChild == null) {\n   // 如果没有 children\n   if (!addInitialChild()) {                                                              \n     // There are no children.                                                            \n     geometry = SliverGeometry.zero;                                                      \n     childManager.didFinishLayout();                                                      \n     return;                                                                              \n   }                                                                                      \n }                                                                                        \n                                                                                          \n // 至少存在一个 children\n // leading 头部，trailing 尾部\n RenderBox leadingChildWithLayout, trailingChildWithLayout;                               \n                                                                                          \n // Find the last child that is at or before the scrollOffset.                            \n RenderBox earliestUsefulChild = firstChild;                                              \n for (double earliestScrollOffset = childScrollOffset(earliestUsefulChild);               \n earliestScrollOffset > scrollOffset;                                                     \n earliestScrollOffset = childScrollOffset(earliestUsefulChild)) { \n   // 在头部插入新的 children                             \n   earliestUsefulChild =                                                                  \n       insertAndLayoutLeadingChild(childConstraints, parentUsesSize: true);               \n                                                                                          \n   if (earliestUsefulChild == null) {\n     final SliverMultiBoxAdaptorParentData childParentData = firstChild                   \n         .parentData;                                                                     \n     childParentData.layoutOffset = 0.0;                                                  \n                                                                                          \n     if (scrollOffset == 0.0) {                                                           \n       earliestUsefulChild = firstChild;                                                  \n       leadingChildWithLayout = earliestUsefulChild;                                      \n       trailingChildWithLayout ??= earliestUsefulChild;                                   \n       break;                                                                             \n     } else {                                                                             \n       // We ran out of children before reaching the scroll offset.                       \n       // We must inform our parent that this sliver cannot fulfill                       \n       // its contract and that we need a scroll offset correction.                       \n       geometry = SliverGeometry(                                                         \n         scrollOffsetCorrection: -scrollOffset,                                           \n       );                                                                                 \n       return;                                                                            \n     }                                                                                    \n   }                                                                                      \n                                                                                          \n   final double firstChildScrollOffset = earliestScrollOffset -                           \n       paintExtentOf(firstChild);                                                         \n   if (firstChildScrollOffset < -precisionErrorTolerance) {                               \n     // 双精度错误                                               \n   }                                                                                      \n                                                                                          \n   final SliverMultiBoxAdaptorParentData childParentData = earliestUsefulChild            \n       .parentData;\n   // 更新 parentData\n   childParentData.layoutOffset = firstChildScrollOffset;                                 \n   assert(earliestUsefulChild == firstChild); \n   // 更新头尾\n   leadingChildWithLayout = earliestUsefulChild;                                          \n   trailingChildWithLayout ??= earliestUsefulChild;                                       \n }                                                                                        \n                                                                                          \n```\n\n上面的代码是处理以下这种情况，即 `earliestScrollOffset > scrollOffset`，即头部的 children 和 `scrollOffset` 之间有空间，没有填充。画个简单的图形。\n![flutter_listview_2](https://user-gold-cdn.xitu.io/2019/6/17/16b646e1abfea9ed?w=2976&h=3968&f=jpeg&s=1088673)\n\n这块区域就是 needLayout。当从下向上滚动时候，就是这里在进行布局。\n\n```dart\nbool inLayoutRange = true;                                                          \nRenderBox child = earliestUsefulChild;                                              \nint index = indexOf(child);\n// endScrollOffset 表示当前已经布局 children 的偏移量\ndouble endScrollOffset = childScrollOffset(child) + paintExtentOf(child);           \nbool advance() {                                                                    \n  assert(child != null);                                                            \n  if (child == trailingChildWithLayout)                                             \n    inLayoutRange = false;                                                          \n  child = childAfter(child);                                                        \n  if (child == null)                                                                \n    inLayoutRange = false;                                                          \n  index += 1;                                                                       \n  if (!inLayoutRange) {                                                             \n    if (child == null || indexOf(child) != index) {\n      // 需要布局新的 children，在尾部插入一个新的\n      child = insertAndLayoutChild(childConstraints,                                \n        after: trailingChildWithLayout,                                             \n        parentUsesSize: true,                                                       \n      );                                                                            \n      if (child == null) {                                                          \n        // We have run out of children.                                             \n        return false;                                                               \n      }                                                                             \n    } else {                                                                        \n      // Lay out the child.                                                         \n      child.layout(childConstraints, parentUsesSize: true);                         \n    }                                                                               \n    trailingChildWithLayout = child;                                                \n  }                                                                                 \n  assert(child != null);                                                            \n  final SliverMultiBoxAdaptorParentData childParentData = child.parentData;         \n  childParentData.layoutOffset = endScrollOffset;                                   \n  assert(childParentData.index == index);\n  // 更新 endScrollOffset，用当前 child 的偏移量 + child 所需要的范围\n  endScrollOffset = childScrollOffset(child) + paintExtentOf(child);                \n  return true;                                                                      \n}                                                                                   \n```\n\n```dart\n// Find the first child that ends after the scroll offset.                                  \nwhile (endScrollOffset < scrollOffset) {\n  // 记录需要回收的项目\n  leadingGarbage += 1;                                                                      \n  if (!advance()) {                                                                         \n    assert(leadingGarbage == childCount);                                                   \n    assert(child == null);                                                                  \n    // we want to make sure we keep the last child around so we know the end scroll offset  \n    collectGarbage(leadingGarbage - 1, 0);                                                  \n    assert(firstChild == lastChild);                                                        \n    final double extent = childScrollOffset(lastChild) +                                    \n        paintExtentOf(lastChild);                                                           \n    geometry = SliverGeometry(                                                              \n      scrollExtent: extent,                                                                 \n      paintExtent: 0.0,                                                                     \n      maxPaintExtent: extent,                                                               \n    );                                                                                      \n    return;                                                                                 \n  }                                                                                         \n}                                                                                           \n```\n\n不在可见视图，不在缓存区域的，记录头部需要回收的。\n\n```dart\n// Now find the first child that ends after our end.    \nwhile (endScrollOffset < targetEndScrollOffset) {       \n  if (!advance()) {                                     \n    reachedEnd = true;                                  \n    break;                                              \n  }                                                     \n}                                                       \n```\n\n从上往下滚动时，调用 `advance()` 不断在底部插入新的 child。\n\n```dart\n// Finally count up all the remaining children and label them as garbage.    \nif (child != null) {                                                         \n  child = childAfter(child);                                                 \n  while (child != null) {                                                    \n    trailingGarbage += 1;                                                    \n    child = childAfter(child);                                               \n  }                                                                          \n}\n// 回收\ncollectGarbage(leadingGarbage, trailingGarbage); \n```\n\n记录尾部需要回收的，全部一起回收。上图中用 nedd grabage 标记的区域。\n\n```dart\ndouble estimatedMaxScrollOffset;                                         \nif (reachedEnd) {\n  // 没有 child 需要布局了\n  estimatedMaxScrollOffset = endScrollOffset;                            \n} else {                                                                 \n  estimatedMaxScrollOffset = childManager.estimateMaxScrollOffset(       \n    constraints,                                                         \n    firstIndex: indexOf(firstChild),                                     \n    lastIndex: indexOf(lastChild),                                       \n    leadingScrollOffset: childScrollOffset(firstChild),                  \n    trailingScrollOffset: endScrollOffset,                               \n  );                                                                     \n  assert(estimatedMaxScrollOffset >=                                     \n      endScrollOffset - childScrollOffset(firstChild));                  \n}                                                                        \nfinal double paintExtent = calculatePaintOffset(                         \n  constraints,                                                           \n  from: childScrollOffset(firstChild),                                   \n  to: endScrollOffset,                                                   \n);                                                                       \nfinal double cacheExtent = calculateCacheOffset(                         \n  constraints,                                                           \n  from: childScrollOffset(firstChild),                                   \n  to: endScrollOffset,                                                   \n);                                                                       \nfinal double targetEndScrollOffsetForPaint = constraints.scrollOffset +  \n    constraints.remainingPaintExtent;\n// 反馈布局消费请求\ngeometry = SliverGeometry(                                               \n  scrollExtent: estimatedMaxScrollOffset,                                \n  paintExtent: paintExtent,                                              \n  cacheExtent: cacheExtent,                                              \n  maxPaintExtent: estimatedMaxScrollOffset,                              \n  // Conservative to avoid flickering away the clip during scroll.       \n  hasVisualOverflow: endScrollOffset > targetEndScrollOffsetForPaint ||  \n      constraints.scrollOffset > 0.0,                                    \n);\n\n// 布局结束\nchildManager.didFinishLayout(); \n```\n\n### 总结\n\n在分析完 `ListView` 的布局流程后，可以发现整个流程还是比较清晰的。\n\n1. 需要布局的区域包括可见区域和缓存区域\n2. 在布局区域以外的进行回收","slug":"Flutter-ListView-源码分析","published":1,"updated":"2022-06-15T11:19:32.316Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlq000mfho690mv50uo","content":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>不得不说，Flutter 绘制 UI 的速度和原生根本不是一个量级的，Flutter 要快的多了，比如常用的 <code>ListView</code> 控件，原生写的话，比如 Android，如果不封装的话，需要一个 <code>Adapter</code>、<code>ViewHolder</code>，再加个 xml 布局文件，而 Flutter 可能就几十行。</p>\n<p>对于越常用的控件，越要熟悉它的原理。Flutter 中的 <code>ScrollView</code> 家族，成员的划分其实和 Android 还是非常类似的，除了 <code>ListView</code>、<code>GridView</code>，还有 <code>CustomScrollView</code> 和 <code>NestedScrollView</code>。今天我们要讲主角就是 <code>ListView</code>。</p>\n<h3 id=\"ListView\"><a href=\"#ListView\" class=\"headerlink\" title=\"ListView\"></a>ListView</h3><p><code>ListView</code> 和 <code>GridView</code> 都继承于 <code>BoxScrollView</code>，但这里并不是绘制和布局的地方，Flutter 和原生不太一样，以 Android 为例，Android 上绘制和布局的单位是 <code>View</code> 和 <code>ViewGroup</code>，Flutter 则要复杂一点，首先我们用的最多的是各种 <code>Widget</code>，比如 <code>ListView</code>，但 <code>Widget</code> 可以理解为一个配置描述文件，比如以下代码：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Container &#123;</span><br><span class=\"line\">  width: <span class=\"number\">100</span>,</span><br><span class=\"line\">  height: <span class=\"number\">100</span>,</span><br><span class=\"line\">  color: Colors.white,</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里描述了我们需要一个宽高为 100，颜色为白色的容器，最后真正去绘制的是 <code>RenderObject</code>。而在 <code>Widget</code> 和 <code>RenderObject</code> 之间还有个 <code>Element</code>，它的职责是，将我们配置的 Widget Tree 转换成 Element Tree，<code>Element</code> 是对 <code>Widget</code> 的进一步抽象，<code>Element</code> 有两个子类，一个是 <code>RenderObjectElement</code>，它持有 <code>RenderObject</code>，还有一个 <code>ComponentElement</code> ，用于组合多个 <code>RenderObjectElement</code>。这个是 Flutter UI 的核心，要理解好这三个类。</p>\n<p>回到我们的主题上来，我们前面说到 <code>ListView</code> 继承于 <code>BoxScrollView</code>，而 <code>BoxScrollView</code> 又继承于 <code>ScrollView</code>，<code>ScrollView</code> 是一个 <code>StatelessWidget</code>，它依靠 <code>Scrollable</code> 实现滚动效果，而滚动容器中的 <code>Widget</code>，称为 slivers。sliver 用于消费滚动事件。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                              </span><br><span class=\"line\">Widget build(BuildContext context) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// slivers</span></span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">List</span>&lt;Widget&gt; slivers = buildSlivers(context);                  </span><br><span class=\"line\">  <span class=\"keyword\">final</span> AxisDirection axisDirection = getDirection(context);           </span><br><span class=\"line\">                                                                       </span><br><span class=\"line\">  <span class=\"comment\">// 省略                                                          </span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> primary &amp;&amp; scrollController != <span class=\"keyword\">null</span>                           </span><br><span class=\"line\">    ? PrimaryScrollController.none(child: scrollable)                  </span><br><span class=\"line\">    : scrollable;                                                      </span><br><span class=\"line\">&#125;                                                                      </span><br></pre></td></tr></table></figure>\n\n<p><code>BoxScrollView</code> 实现了 <code>buildSlivers()</code>，它只有一个 sliver，也就是滚动容器中，只有一个消费者。这里又是通过调用 <code>buildChildLayout</code> 抽象方法创建。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                                         </span><br><span class=\"line\"><span class=\"built_in\">List</span>&lt;Widget&gt; buildSlivers(BuildContext context) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// buildChildLayout</span></span><br><span class=\"line\">  Widget sliver = buildChildLayout(context);                                      </span><br><span class=\"line\">  EdgeInsetsGeometry effectivePadding = padding;                                  </span><br><span class=\"line\">  <span class=\"comment\">// 省略            </span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &lt;Widget&gt;[ sliver ];                                                      </span><br><span class=\"line\">&#125;                                                                                 </span><br></pre></td></tr></table></figure>\n\n<p>最后我们的 <code>ListView</code> 就实现了 <code>buildChildLayout()</code>：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                        </span><br><span class=\"line\">Widget buildChildLayout(BuildContext context) &#123;  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (itemExtent != <span class=\"keyword\">null</span>) &#123; </span><br><span class=\"line\">    <span class=\"comment\">// 如果子项是固定高度的</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> SliverFixedExtentList(                </span><br><span class=\"line\">      delegate: childrenDelegate,                </span><br><span class=\"line\">      itemExtent: itemExtent,                    </span><br><span class=\"line\">    );                                           </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// 默认情况</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> SliverList(delegate: childrenDelegate); </span><br><span class=\"line\">&#125;                                                </span><br></pre></td></tr></table></figure>\n\n<p><code>SliverList</code> 是一个 <code>RenderObjectWidget</code>，上面我们也说到了，最终绘制和布局都是交与 <code>RenderObject</code> 去实现的。<code>ListView</code> 也不例外：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                     </span><br><span class=\"line\">RenderSliverList createRenderObject(BuildContext context) &#123;   </span><br><span class=\"line\">  <span class=\"keyword\">final</span> SliverMultiBoxAdaptorElement element = context;       </span><br><span class=\"line\">  <span class=\"keyword\">return</span> RenderSliverList(childManager: element);             </span><br><span class=\"line\">&#125;                                                             </span><br></pre></td></tr></table></figure>\n\n<p><code>RenderSliverList</code> 是 <code>ListView</code> 的核心实现，也是我们本文的重点。</p>\n<h3 id=\"RenderSliverList\"><a href=\"#RenderSliverList\" class=\"headerlink\" title=\"RenderSliverList\"></a>RenderSliverList</h3><p>有过 Android 自定义控件经验的同学会知道，当我们自定义一个控件时，一般会涉及这几个步骤：measure 和 draw，如果是自定义 <code>ViewGroup</code> 还会涉及 layout 过程，Flutter 也不例外，但它将 measure 和 layout 合并到 layout，draw 称为 paint。虽然叫法不一样，但作用是一样的。系统会调用 <code>performLayout()</code> 会执行测量和布局，<code>RenderSliverList</code> 主要涉及布局操作，所以我们主要看下这个方法即可。</p>\n<p><code>performLayout()</code> 代码比较长，所以我们会省略一些非核心代码。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> scrollOffset = constraints.scrollOffset + constraints.cacheOrigin;</span><br><span class=\"line\"><span class=\"keyword\">assert</span>(scrollOffset &gt;= <span class=\"number\">0.0</span>);                                                   </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> remainingExtent = constraints.remainingCacheExtent;               </span><br><span class=\"line\"><span class=\"keyword\">assert</span>(remainingExtent &gt;= <span class=\"number\">0.0</span>);                                                </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> targetEndScrollOffset = scrollOffset + remainingExtent;           </span><br><span class=\"line\"><span class=\"keyword\">final</span> BoxConstraints childConstraints = constraints.asBoxConstraints();        </span><br></pre></td></tr></table></figure>\n\n<p><code>scrollOffset</code> 表示已滚动的偏移量，<code>cacheOrigin</code> 表示预布局的相对位置。为了更好的视觉效果，<code>ListView</code> 会在可见范围内增加预布局的区域，这里表示下一次滚动即将展示的区域，称为 <code>cacheExtent</code>。这个值可以配置，默认为 250。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// viewport.dart</span></span><br><span class=\"line\"><span class=\"built_in\">double</span> <span class=\"keyword\">get</span> cacheExtent =&gt; _cacheExtent;                       </span><br><span class=\"line\"><span class=\"built_in\">double</span> _cacheExtent;                                          </span><br><span class=\"line\"><span class=\"keyword\">set</span> cacheExtent(<span class=\"built_in\">double</span> value) &#123;                               </span><br><span class=\"line\">  value = value ?? RenderAbstractViewport.defaultCacheExtent; </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(value != <span class=\"keyword\">null</span>);                                      </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (value == _cacheExtent)                                  </span><br><span class=\"line\">    <span class=\"keyword\">return</span>;                                                   </span><br><span class=\"line\">  _cacheExtent = value;                                       </span><br><span class=\"line\">  markNeedsLayout();                                          </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">const</span> <span class=\"built_in\">double</span> defaultCacheExtent = <span class=\"number\">250.0</span>;</span><br></pre></td></tr></table></figure>\n\n<p><code>remainingCacheExtent</code> 是当前该 sliver 可使用的偏移量，这里包含了预布局的区域。这里我们用一张非常粗糙的图片来解释下。<br><img src=\"https://user-gold-cdn.xitu.io/2019/6/17/16b646bfbfd7ca4b?w=2976&h=3968&f=jpeg&s=1164921\" alt=\"flutter_listview_1\"></p>\n<p>C 区域表示我们的屏幕，这里我们认为是可见区域，实际情况下，可能还要更小，因为 <code>ListView</code> 可能有些 <code>padding</code>、<code>magin</code> 或者其他布局等。B 区域有两个分别表示头部的预布局和底部的预布局区域，它的值就是我们设置的 <code>cacheExtent</code>，A 区域回收区域。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> scrollOffset = constraints.scrollOffset + constraints.cacheOrigin;</span><br></pre></td></tr></table></figure>\n\n<p>这里的 <code>constraints.scrollOffset</code> 就是 A + B，即可不见区域。<code>constraints.cacheOrigin</code> 在这里，如果使用默认值，它等于 -250，意思就是说 B 的区域高度有 250，所以它完全不可见时，它的相对位置 y 值就是 -250，这里算出的 <code>scrollOffset</code> 其实就是开始布局的起始位置，如果 <code>cacheExtent = 0</code>，那么它会从 C 的顶部开始布局，即 <code>constraints.scrollOffset</code> 否则就是 <code>constraints.scrollOffset + constraints.cacheOrigin</code>。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (firstChild == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 如果没有 children</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!addInitialChild()) &#123;                                                              </span><br><span class=\"line\">    <span class=\"comment\">// There are no children.                                                            </span></span><br><span class=\"line\">    geometry = SliverGeometry.zero;                                                      </span><br><span class=\"line\">    childManager.didFinishLayout();                                                      </span><br><span class=\"line\">    <span class=\"keyword\">return</span>;                                                                              </span><br><span class=\"line\">  &#125;                                                                                      </span><br><span class=\"line\">&#125;                                                                                        </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\"><span class=\"comment\">// 至少存在一个 children</span></span><br><span class=\"line\"><span class=\"comment\">// leading 头部，trailing 尾部</span></span><br><span class=\"line\">RenderBox leadingChildWithLayout, trailingChildWithLayout;                               </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\"><span class=\"comment\">// Find the last child that is at or before the scrollOffset.                            </span></span><br><span class=\"line\">RenderBox earliestUsefulChild = firstChild;                                              </span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"built_in\">double</span> earliestScrollOffset = childScrollOffset(earliestUsefulChild);               </span><br><span class=\"line\">earliestScrollOffset &gt; scrollOffset;                                                     </span><br><span class=\"line\">earliestScrollOffset = childScrollOffset(earliestUsefulChild)) &#123; </span><br><span class=\"line\">  <span class=\"comment\">// 在头部插入新的 children                             </span></span><br><span class=\"line\">  earliestUsefulChild =                                                                  </span><br><span class=\"line\">      insertAndLayoutLeadingChild(childConstraints, parentUsesSize: <span class=\"keyword\">true</span>);               </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (earliestUsefulChild == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> SliverMultiBoxAdaptorParentData childParentData = firstChild                   </span><br><span class=\"line\">        .parentData;                                                                     </span><br><span class=\"line\">    childParentData.layoutOffset = <span class=\"number\">0.0</span>;                                                  </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (scrollOffset == <span class=\"number\">0.0</span>) &#123;                                                           </span><br><span class=\"line\">      earliestUsefulChild = firstChild;                                                  </span><br><span class=\"line\">      leadingChildWithLayout = earliestUsefulChild;                                      </span><br><span class=\"line\">      trailingChildWithLayout ??= earliestUsefulChild;                                   </span><br><span class=\"line\">      <span class=\"keyword\">break</span>;                                                                             </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                             </span><br><span class=\"line\">      <span class=\"comment\">// We ran out of children before reaching the scroll offset.                       </span></span><br><span class=\"line\">      <span class=\"comment\">// We must inform our parent that this sliver cannot fulfill                       </span></span><br><span class=\"line\">      <span class=\"comment\">// its contract and that we need a scroll offset correction.                       </span></span><br><span class=\"line\">      geometry = SliverGeometry(                                                         </span><br><span class=\"line\">        scrollOffsetCorrection: -scrollOffset,                                           </span><br><span class=\"line\">      );                                                                                 </span><br><span class=\"line\">      <span class=\"keyword\">return</span>;                                                                            </span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">  &#125;                                                                                      </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">double</span> firstChildScrollOffset = earliestScrollOffset -                           </span><br><span class=\"line\">      paintExtentOf(firstChild);                                                         </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (firstChildScrollOffset &lt; -precisionErrorTolerance) &#123;                               </span><br><span class=\"line\">    <span class=\"comment\">// 双精度错误                                               </span></span><br><span class=\"line\">  &#125;                                                                                      </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">  <span class=\"keyword\">final</span> SliverMultiBoxAdaptorParentData childParentData = earliestUsefulChild            </span><br><span class=\"line\">      .parentData;</span><br><span class=\"line\">  <span class=\"comment\">// 更新 parentData</span></span><br><span class=\"line\">  childParentData.layoutOffset = firstChildScrollOffset;                                 </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(earliestUsefulChild == firstChild); </span><br><span class=\"line\">  <span class=\"comment\">// 更新头尾</span></span><br><span class=\"line\">  leadingChildWithLayout = earliestUsefulChild;                                          </span><br><span class=\"line\">  trailingChildWithLayout ??= earliestUsefulChild;                                       </span><br><span class=\"line\">&#125;                                                                                        </span><br><span class=\"line\">                                                                                         </span><br></pre></td></tr></table></figure>\n\n<p>上面的代码是处理以下这种情况，即 <code>earliestScrollOffset &gt; scrollOffset</code>，即头部的 children 和 <code>scrollOffset</code> 之间有空间，没有填充。画个简单的图形。<br><img src=\"https://user-gold-cdn.xitu.io/2019/6/17/16b646e1abfea9ed?w=2976&h=3968&f=jpeg&s=1088673\" alt=\"flutter_listview_2\"></p>\n<p>这块区域就是 needLayout。当从下向上滚动时候，就是这里在进行布局。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">bool</span> inLayoutRange = <span class=\"keyword\">true</span>;                                                          </span><br><span class=\"line\">RenderBox child = earliestUsefulChild;                                              </span><br><span class=\"line\"><span class=\"built_in\">int</span> index = indexOf(child);</span><br><span class=\"line\"><span class=\"comment\">// endScrollOffset 表示当前已经布局 children 的偏移量</span></span><br><span class=\"line\"><span class=\"built_in\">double</span> endScrollOffset = childScrollOffset(child) + paintExtentOf(child);           </span><br><span class=\"line\"><span class=\"built_in\">bool</span> advance() &#123;                                                                    </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(child != <span class=\"keyword\">null</span>);                                                            </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (child == trailingChildWithLayout)                                             </span><br><span class=\"line\">    inLayoutRange = <span class=\"keyword\">false</span>;                                                          </span><br><span class=\"line\">  child = childAfter(child);                                                        </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (child == <span class=\"keyword\">null</span>)                                                                </span><br><span class=\"line\">    inLayoutRange = <span class=\"keyword\">false</span>;                                                          </span><br><span class=\"line\">  index += <span class=\"number\">1</span>;                                                                       </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!inLayoutRange) &#123;                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child == <span class=\"keyword\">null</span> || indexOf(child) != index) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 需要布局新的 children，在尾部插入一个新的</span></span><br><span class=\"line\">      child = insertAndLayoutChild(childConstraints,                                </span><br><span class=\"line\">        after: trailingChildWithLayout,                                             </span><br><span class=\"line\">        parentUsesSize: <span class=\"keyword\">true</span>,                                                       </span><br><span class=\"line\">      );                                                                            </span><br><span class=\"line\">      <span class=\"keyword\">if</span> (child == <span class=\"keyword\">null</span>) &#123;                                                          </span><br><span class=\"line\">        <span class=\"comment\">// We have run out of children.                                             </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;                                                               </span><br><span class=\"line\">      &#125;                                                                             </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                        </span><br><span class=\"line\">      <span class=\"comment\">// Lay out the child.                                                         </span></span><br><span class=\"line\">      child.layout(childConstraints, parentUsesSize: <span class=\"keyword\">true</span>);                         </span><br><span class=\"line\">    &#125;                                                                               </span><br><span class=\"line\">    trailingChildWithLayout = child;                                                </span><br><span class=\"line\">  &#125;                                                                                 </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(child != <span class=\"keyword\">null</span>);                                                            </span><br><span class=\"line\">  <span class=\"keyword\">final</span> SliverMultiBoxAdaptorParentData childParentData = child.parentData;         </span><br><span class=\"line\">  childParentData.layoutOffset = endScrollOffset;                                   </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(childParentData.index == index);</span><br><span class=\"line\">  <span class=\"comment\">// 更新 endScrollOffset，用当前 child 的偏移量 + child 所需要的范围</span></span><br><span class=\"line\">  endScrollOffset = childScrollOffset(child) + paintExtentOf(child);                </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;                                                                      </span><br><span class=\"line\">&#125;                                                                                   </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Find the first child that ends after the scroll offset.                                  </span></span><br><span class=\"line\"><span class=\"keyword\">while</span> (endScrollOffset &lt; scrollOffset) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 记录需要回收的项目</span></span><br><span class=\"line\">  leadingGarbage += <span class=\"number\">1</span>;                                                                      </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!advance()) &#123;                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">assert</span>(leadingGarbage == childCount);                                                   </span><br><span class=\"line\">    <span class=\"keyword\">assert</span>(child == <span class=\"keyword\">null</span>);                                                                  </span><br><span class=\"line\">    <span class=\"comment\">// we want to make sure we keep the last child around so we know the end scroll offset  </span></span><br><span class=\"line\">    collectGarbage(leadingGarbage - <span class=\"number\">1</span>, <span class=\"number\">0</span>);                                                  </span><br><span class=\"line\">    <span class=\"keyword\">assert</span>(firstChild == lastChild);                                                        </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"built_in\">double</span> extent = childScrollOffset(lastChild) +                                    </span><br><span class=\"line\">        paintExtentOf(lastChild);                                                           </span><br><span class=\"line\">    geometry = SliverGeometry(                                                              </span><br><span class=\"line\">      scrollExtent: extent,                                                                 </span><br><span class=\"line\">      paintExtent: <span class=\"number\">0.0</span>,                                                                     </span><br><span class=\"line\">      maxPaintExtent: extent,                                                               </span><br><span class=\"line\">    );                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">return</span>;                                                                                 </span><br><span class=\"line\">  &#125;                                                                                         </span><br><span class=\"line\">&#125;                                                                                           </span><br></pre></td></tr></table></figure>\n\n<p>不在可见视图，不在缓存区域的，记录头部需要回收的。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Now find the first child that ends after our end.    </span></span><br><span class=\"line\"><span class=\"keyword\">while</span> (endScrollOffset &lt; targetEndScrollOffset) &#123;       </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!advance()) &#123;                                     </span><br><span class=\"line\">    reachedEnd = <span class=\"keyword\">true</span>;                                  </span><br><span class=\"line\">    <span class=\"keyword\">break</span>;                                              </span><br><span class=\"line\">  &#125;                                                     </span><br><span class=\"line\">&#125;                                                       </span><br></pre></td></tr></table></figure>\n\n<p>从上往下滚动时，调用 <code>advance()</code> 不断在底部插入新的 child。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Finally count up all the remaining children and label them as garbage.    </span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (child != <span class=\"keyword\">null</span>) &#123;                                                         </span><br><span class=\"line\">  child = childAfter(child);                                                 </span><br><span class=\"line\">  <span class=\"keyword\">while</span> (child != <span class=\"keyword\">null</span>) &#123;                                                    </span><br><span class=\"line\">    trailingGarbage += <span class=\"number\">1</span>;                                                    </span><br><span class=\"line\">    child = childAfter(child);                                               </span><br><span class=\"line\">  &#125;                                                                          </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 回收</span></span><br><span class=\"line\">collectGarbage(leadingGarbage, trailingGarbage); </span><br></pre></td></tr></table></figure>\n\n<p>记录尾部需要回收的，全部一起回收。上图中用 nedd grabage 标记的区域。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">double</span> estimatedMaxScrollOffset;                                         </span><br><span class=\"line\"><span class=\"keyword\">if</span> (reachedEnd) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 没有 child 需要布局了</span></span><br><span class=\"line\">  estimatedMaxScrollOffset = endScrollOffset;                            </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;                                                                 </span><br><span class=\"line\">  estimatedMaxScrollOffset = childManager.estimateMaxScrollOffset(       </span><br><span class=\"line\">    constraints,                                                         </span><br><span class=\"line\">    firstIndex: indexOf(firstChild),                                     </span><br><span class=\"line\">    lastIndex: indexOf(lastChild),                                       </span><br><span class=\"line\">    leadingScrollOffset: childScrollOffset(firstChild),                  </span><br><span class=\"line\">    trailingScrollOffset: endScrollOffset,                               </span><br><span class=\"line\">  );                                                                     </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(estimatedMaxScrollOffset &gt;=                                     </span><br><span class=\"line\">      endScrollOffset - childScrollOffset(firstChild));                  </span><br><span class=\"line\">&#125;                                                                        </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> paintExtent = calculatePaintOffset(                         </span><br><span class=\"line\">  constraints,                                                           </span><br><span class=\"line\">  from: childScrollOffset(firstChild),                                   </span><br><span class=\"line\">  to: endScrollOffset,                                                   </span><br><span class=\"line\">);                                                                       </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> cacheExtent = calculateCacheOffset(                         </span><br><span class=\"line\">  constraints,                                                           </span><br><span class=\"line\">  from: childScrollOffset(firstChild),                                   </span><br><span class=\"line\">  to: endScrollOffset,                                                   </span><br><span class=\"line\">);                                                                       </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> targetEndScrollOffsetForPaint = constraints.scrollOffset +  </span><br><span class=\"line\">    constraints.remainingPaintExtent;</span><br><span class=\"line\"><span class=\"comment\">// 反馈布局消费请求</span></span><br><span class=\"line\">geometry = SliverGeometry(                                               </span><br><span class=\"line\">  scrollExtent: estimatedMaxScrollOffset,                                </span><br><span class=\"line\">  paintExtent: paintExtent,                                              </span><br><span class=\"line\">  cacheExtent: cacheExtent,                                              </span><br><span class=\"line\">  maxPaintExtent: estimatedMaxScrollOffset,                              </span><br><span class=\"line\">  <span class=\"comment\">// Conservative to avoid flickering away the clip during scroll.       </span></span><br><span class=\"line\">  hasVisualOverflow: endScrollOffset &gt; targetEndScrollOffsetForPaint ||  </span><br><span class=\"line\">      constraints.scrollOffset &gt; <span class=\"number\">0.0</span>,                                    </span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 布局结束</span></span><br><span class=\"line\">childManager.didFinishLayout(); </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>在分析完 <code>ListView</code> 的布局流程后，可以发现整个流程还是比较清晰的。</p>\n<ol>\n<li>需要布局的区域包括可见区域和缓存区域</li>\n<li>在布局区域以外的进行回收</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>不得不说，Flutter 绘制 UI 的速度和原生根本不是一个量级的，Flutter 要快的多了，比如常用的 <code>ListView</code> 控件，原生写的话，比如 Android，如果不封装的话，需要一个 <code>Adapter</code>、<code>ViewHolder</code>，再加个 xml 布局文件，而 Flutter 可能就几十行。</p>\n<p>对于越常用的控件，越要熟悉它的原理。Flutter 中的 <code>ScrollView</code> 家族，成员的划分其实和 Android 还是非常类似的，除了 <code>ListView</code>、<code>GridView</code>，还有 <code>CustomScrollView</code> 和 <code>NestedScrollView</code>。今天我们要讲主角就是 <code>ListView</code>。</p>\n<h3 id=\"ListView\"><a href=\"#ListView\" class=\"headerlink\" title=\"ListView\"></a>ListView</h3><p><code>ListView</code> 和 <code>GridView</code> 都继承于 <code>BoxScrollView</code>，但这里并不是绘制和布局的地方，Flutter 和原生不太一样，以 Android 为例，Android 上绘制和布局的单位是 <code>View</code> 和 <code>ViewGroup</code>，Flutter 则要复杂一点，首先我们用的最多的是各种 <code>Widget</code>，比如 <code>ListView</code>，但 <code>Widget</code> 可以理解为一个配置描述文件，比如以下代码：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Container &#123;</span><br><span class=\"line\">  width: <span class=\"number\">100</span>,</span><br><span class=\"line\">  height: <span class=\"number\">100</span>,</span><br><span class=\"line\">  color: Colors.white,</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里描述了我们需要一个宽高为 100，颜色为白色的容器，最后真正去绘制的是 <code>RenderObject</code>。而在 <code>Widget</code> 和 <code>RenderObject</code> 之间还有个 <code>Element</code>，它的职责是，将我们配置的 Widget Tree 转换成 Element Tree，<code>Element</code> 是对 <code>Widget</code> 的进一步抽象，<code>Element</code> 有两个子类，一个是 <code>RenderObjectElement</code>，它持有 <code>RenderObject</code>，还有一个 <code>ComponentElement</code> ，用于组合多个 <code>RenderObjectElement</code>。这个是 Flutter UI 的核心，要理解好这三个类。</p>\n<p>回到我们的主题上来，我们前面说到 <code>ListView</code> 继承于 <code>BoxScrollView</code>，而 <code>BoxScrollView</code> 又继承于 <code>ScrollView</code>，<code>ScrollView</code> 是一个 <code>StatelessWidget</code>，它依靠 <code>Scrollable</code> 实现滚动效果，而滚动容器中的 <code>Widget</code>，称为 slivers。sliver 用于消费滚动事件。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                              </span><br><span class=\"line\">Widget build(BuildContext context) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// slivers</span></span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">List</span>&lt;Widget&gt; slivers = buildSlivers(context);                  </span><br><span class=\"line\">  <span class=\"keyword\">final</span> AxisDirection axisDirection = getDirection(context);           </span><br><span class=\"line\">                                                                       </span><br><span class=\"line\">  <span class=\"comment\">// 省略                                                          </span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> primary &amp;&amp; scrollController != <span class=\"keyword\">null</span>                           </span><br><span class=\"line\">    ? PrimaryScrollController.none(child: scrollable)                  </span><br><span class=\"line\">    : scrollable;                                                      </span><br><span class=\"line\">&#125;                                                                      </span><br></pre></td></tr></table></figure>\n\n<p><code>BoxScrollView</code> 实现了 <code>buildSlivers()</code>，它只有一个 sliver，也就是滚动容器中，只有一个消费者。这里又是通过调用 <code>buildChildLayout</code> 抽象方法创建。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                                         </span><br><span class=\"line\"><span class=\"built_in\">List</span>&lt;Widget&gt; buildSlivers(BuildContext context) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// buildChildLayout</span></span><br><span class=\"line\">  Widget sliver = buildChildLayout(context);                                      </span><br><span class=\"line\">  EdgeInsetsGeometry effectivePadding = padding;                                  </span><br><span class=\"line\">  <span class=\"comment\">// 省略            </span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &lt;Widget&gt;[ sliver ];                                                      </span><br><span class=\"line\">&#125;                                                                                 </span><br></pre></td></tr></table></figure>\n\n<p>最后我们的 <code>ListView</code> 就实现了 <code>buildChildLayout()</code>：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                        </span><br><span class=\"line\">Widget buildChildLayout(BuildContext context) &#123;  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (itemExtent != <span class=\"keyword\">null</span>) &#123; </span><br><span class=\"line\">    <span class=\"comment\">// 如果子项是固定高度的</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> SliverFixedExtentList(                </span><br><span class=\"line\">      delegate: childrenDelegate,                </span><br><span class=\"line\">      itemExtent: itemExtent,                    </span><br><span class=\"line\">    );                                           </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// 默认情况</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> SliverList(delegate: childrenDelegate); </span><br><span class=\"line\">&#125;                                                </span><br></pre></td></tr></table></figure>\n\n<p><code>SliverList</code> 是一个 <code>RenderObjectWidget</code>，上面我们也说到了，最终绘制和布局都是交与 <code>RenderObject</code> 去实现的。<code>ListView</code> 也不例外：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                     </span><br><span class=\"line\">RenderSliverList createRenderObject(BuildContext context) &#123;   </span><br><span class=\"line\">  <span class=\"keyword\">final</span> SliverMultiBoxAdaptorElement element = context;       </span><br><span class=\"line\">  <span class=\"keyword\">return</span> RenderSliverList(childManager: element);             </span><br><span class=\"line\">&#125;                                                             </span><br></pre></td></tr></table></figure>\n\n<p><code>RenderSliverList</code> 是 <code>ListView</code> 的核心实现，也是我们本文的重点。</p>\n<h3 id=\"RenderSliverList\"><a href=\"#RenderSliverList\" class=\"headerlink\" title=\"RenderSliverList\"></a>RenderSliverList</h3><p>有过 Android 自定义控件经验的同学会知道，当我们自定义一个控件时，一般会涉及这几个步骤：measure 和 draw，如果是自定义 <code>ViewGroup</code> 还会涉及 layout 过程，Flutter 也不例外，但它将 measure 和 layout 合并到 layout，draw 称为 paint。虽然叫法不一样，但作用是一样的。系统会调用 <code>performLayout()</code> 会执行测量和布局，<code>RenderSliverList</code> 主要涉及布局操作，所以我们主要看下这个方法即可。</p>\n<p><code>performLayout()</code> 代码比较长，所以我们会省略一些非核心代码。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> scrollOffset = constraints.scrollOffset + constraints.cacheOrigin;</span><br><span class=\"line\"><span class=\"keyword\">assert</span>(scrollOffset &gt;= <span class=\"number\">0.0</span>);                                                   </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> remainingExtent = constraints.remainingCacheExtent;               </span><br><span class=\"line\"><span class=\"keyword\">assert</span>(remainingExtent &gt;= <span class=\"number\">0.0</span>);                                                </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> targetEndScrollOffset = scrollOffset + remainingExtent;           </span><br><span class=\"line\"><span class=\"keyword\">final</span> BoxConstraints childConstraints = constraints.asBoxConstraints();        </span><br></pre></td></tr></table></figure>\n\n<p><code>scrollOffset</code> 表示已滚动的偏移量，<code>cacheOrigin</code> 表示预布局的相对位置。为了更好的视觉效果，<code>ListView</code> 会在可见范围内增加预布局的区域，这里表示下一次滚动即将展示的区域，称为 <code>cacheExtent</code>。这个值可以配置，默认为 250。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// viewport.dart</span></span><br><span class=\"line\"><span class=\"built_in\">double</span> <span class=\"keyword\">get</span> cacheExtent =&gt; _cacheExtent;                       </span><br><span class=\"line\"><span class=\"built_in\">double</span> _cacheExtent;                                          </span><br><span class=\"line\"><span class=\"keyword\">set</span> cacheExtent(<span class=\"built_in\">double</span> value) &#123;                               </span><br><span class=\"line\">  value = value ?? RenderAbstractViewport.defaultCacheExtent; </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(value != <span class=\"keyword\">null</span>);                                      </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (value == _cacheExtent)                                  </span><br><span class=\"line\">    <span class=\"keyword\">return</span>;                                                   </span><br><span class=\"line\">  _cacheExtent = value;                                       </span><br><span class=\"line\">  markNeedsLayout();                                          </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">const</span> <span class=\"built_in\">double</span> defaultCacheExtent = <span class=\"number\">250.0</span>;</span><br></pre></td></tr></table></figure>\n\n<p><code>remainingCacheExtent</code> 是当前该 sliver 可使用的偏移量，这里包含了预布局的区域。这里我们用一张非常粗糙的图片来解释下。<br><img src=\"https://user-gold-cdn.xitu.io/2019/6/17/16b646bfbfd7ca4b?w=2976&h=3968&f=jpeg&s=1164921\" alt=\"flutter_listview_1\"></p>\n<p>C 区域表示我们的屏幕，这里我们认为是可见区域，实际情况下，可能还要更小，因为 <code>ListView</code> 可能有些 <code>padding</code>、<code>magin</code> 或者其他布局等。B 区域有两个分别表示头部的预布局和底部的预布局区域，它的值就是我们设置的 <code>cacheExtent</code>，A 区域回收区域。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> scrollOffset = constraints.scrollOffset + constraints.cacheOrigin;</span><br></pre></td></tr></table></figure>\n\n<p>这里的 <code>constraints.scrollOffset</code> 就是 A + B，即可不见区域。<code>constraints.cacheOrigin</code> 在这里，如果使用默认值，它等于 -250，意思就是说 B 的区域高度有 250，所以它完全不可见时，它的相对位置 y 值就是 -250，这里算出的 <code>scrollOffset</code> 其实就是开始布局的起始位置，如果 <code>cacheExtent = 0</code>，那么它会从 C 的顶部开始布局，即 <code>constraints.scrollOffset</code> 否则就是 <code>constraints.scrollOffset + constraints.cacheOrigin</code>。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (firstChild == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 如果没有 children</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!addInitialChild()) &#123;                                                              </span><br><span class=\"line\">    <span class=\"comment\">// There are no children.                                                            </span></span><br><span class=\"line\">    geometry = SliverGeometry.zero;                                                      </span><br><span class=\"line\">    childManager.didFinishLayout();                                                      </span><br><span class=\"line\">    <span class=\"keyword\">return</span>;                                                                              </span><br><span class=\"line\">  &#125;                                                                                      </span><br><span class=\"line\">&#125;                                                                                        </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\"><span class=\"comment\">// 至少存在一个 children</span></span><br><span class=\"line\"><span class=\"comment\">// leading 头部，trailing 尾部</span></span><br><span class=\"line\">RenderBox leadingChildWithLayout, trailingChildWithLayout;                               </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\"><span class=\"comment\">// Find the last child that is at or before the scrollOffset.                            </span></span><br><span class=\"line\">RenderBox earliestUsefulChild = firstChild;                                              </span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"built_in\">double</span> earliestScrollOffset = childScrollOffset(earliestUsefulChild);               </span><br><span class=\"line\">earliestScrollOffset &gt; scrollOffset;                                                     </span><br><span class=\"line\">earliestScrollOffset = childScrollOffset(earliestUsefulChild)) &#123; </span><br><span class=\"line\">  <span class=\"comment\">// 在头部插入新的 children                             </span></span><br><span class=\"line\">  earliestUsefulChild =                                                                  </span><br><span class=\"line\">      insertAndLayoutLeadingChild(childConstraints, parentUsesSize: <span class=\"keyword\">true</span>);               </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (earliestUsefulChild == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> SliverMultiBoxAdaptorParentData childParentData = firstChild                   </span><br><span class=\"line\">        .parentData;                                                                     </span><br><span class=\"line\">    childParentData.layoutOffset = <span class=\"number\">0.0</span>;                                                  </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (scrollOffset == <span class=\"number\">0.0</span>) &#123;                                                           </span><br><span class=\"line\">      earliestUsefulChild = firstChild;                                                  </span><br><span class=\"line\">      leadingChildWithLayout = earliestUsefulChild;                                      </span><br><span class=\"line\">      trailingChildWithLayout ??= earliestUsefulChild;                                   </span><br><span class=\"line\">      <span class=\"keyword\">break</span>;                                                                             </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                             </span><br><span class=\"line\">      <span class=\"comment\">// We ran out of children before reaching the scroll offset.                       </span></span><br><span class=\"line\">      <span class=\"comment\">// We must inform our parent that this sliver cannot fulfill                       </span></span><br><span class=\"line\">      <span class=\"comment\">// its contract and that we need a scroll offset correction.                       </span></span><br><span class=\"line\">      geometry = SliverGeometry(                                                         </span><br><span class=\"line\">        scrollOffsetCorrection: -scrollOffset,                                           </span><br><span class=\"line\">      );                                                                                 </span><br><span class=\"line\">      <span class=\"keyword\">return</span>;                                                                            </span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">  &#125;                                                                                      </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">double</span> firstChildScrollOffset = earliestScrollOffset -                           </span><br><span class=\"line\">      paintExtentOf(firstChild);                                                         </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (firstChildScrollOffset &lt; -precisionErrorTolerance) &#123;                               </span><br><span class=\"line\">    <span class=\"comment\">// 双精度错误                                               </span></span><br><span class=\"line\">  &#125;                                                                                      </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">  <span class=\"keyword\">final</span> SliverMultiBoxAdaptorParentData childParentData = earliestUsefulChild            </span><br><span class=\"line\">      .parentData;</span><br><span class=\"line\">  <span class=\"comment\">// 更新 parentData</span></span><br><span class=\"line\">  childParentData.layoutOffset = firstChildScrollOffset;                                 </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(earliestUsefulChild == firstChild); </span><br><span class=\"line\">  <span class=\"comment\">// 更新头尾</span></span><br><span class=\"line\">  leadingChildWithLayout = earliestUsefulChild;                                          </span><br><span class=\"line\">  trailingChildWithLayout ??= earliestUsefulChild;                                       </span><br><span class=\"line\">&#125;                                                                                        </span><br><span class=\"line\">                                                                                         </span><br></pre></td></tr></table></figure>\n\n<p>上面的代码是处理以下这种情况，即 <code>earliestScrollOffset &gt; scrollOffset</code>，即头部的 children 和 <code>scrollOffset</code> 之间有空间，没有填充。画个简单的图形。<br><img src=\"https://user-gold-cdn.xitu.io/2019/6/17/16b646e1abfea9ed?w=2976&h=3968&f=jpeg&s=1088673\" alt=\"flutter_listview_2\"></p>\n<p>这块区域就是 needLayout。当从下向上滚动时候，就是这里在进行布局。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">bool</span> inLayoutRange = <span class=\"keyword\">true</span>;                                                          </span><br><span class=\"line\">RenderBox child = earliestUsefulChild;                                              </span><br><span class=\"line\"><span class=\"built_in\">int</span> index = indexOf(child);</span><br><span class=\"line\"><span class=\"comment\">// endScrollOffset 表示当前已经布局 children 的偏移量</span></span><br><span class=\"line\"><span class=\"built_in\">double</span> endScrollOffset = childScrollOffset(child) + paintExtentOf(child);           </span><br><span class=\"line\"><span class=\"built_in\">bool</span> advance() &#123;                                                                    </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(child != <span class=\"keyword\">null</span>);                                                            </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (child == trailingChildWithLayout)                                             </span><br><span class=\"line\">    inLayoutRange = <span class=\"keyword\">false</span>;                                                          </span><br><span class=\"line\">  child = childAfter(child);                                                        </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (child == <span class=\"keyword\">null</span>)                                                                </span><br><span class=\"line\">    inLayoutRange = <span class=\"keyword\">false</span>;                                                          </span><br><span class=\"line\">  index += <span class=\"number\">1</span>;                                                                       </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!inLayoutRange) &#123;                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (child == <span class=\"keyword\">null</span> || indexOf(child) != index) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 需要布局新的 children，在尾部插入一个新的</span></span><br><span class=\"line\">      child = insertAndLayoutChild(childConstraints,                                </span><br><span class=\"line\">        after: trailingChildWithLayout,                                             </span><br><span class=\"line\">        parentUsesSize: <span class=\"keyword\">true</span>,                                                       </span><br><span class=\"line\">      );                                                                            </span><br><span class=\"line\">      <span class=\"keyword\">if</span> (child == <span class=\"keyword\">null</span>) &#123;                                                          </span><br><span class=\"line\">        <span class=\"comment\">// We have run out of children.                                             </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;                                                               </span><br><span class=\"line\">      &#125;                                                                             </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                        </span><br><span class=\"line\">      <span class=\"comment\">// Lay out the child.                                                         </span></span><br><span class=\"line\">      child.layout(childConstraints, parentUsesSize: <span class=\"keyword\">true</span>);                         </span><br><span class=\"line\">    &#125;                                                                               </span><br><span class=\"line\">    trailingChildWithLayout = child;                                                </span><br><span class=\"line\">  &#125;                                                                                 </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(child != <span class=\"keyword\">null</span>);                                                            </span><br><span class=\"line\">  <span class=\"keyword\">final</span> SliverMultiBoxAdaptorParentData childParentData = child.parentData;         </span><br><span class=\"line\">  childParentData.layoutOffset = endScrollOffset;                                   </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(childParentData.index == index);</span><br><span class=\"line\">  <span class=\"comment\">// 更新 endScrollOffset，用当前 child 的偏移量 + child 所需要的范围</span></span><br><span class=\"line\">  endScrollOffset = childScrollOffset(child) + paintExtentOf(child);                </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;                                                                      </span><br><span class=\"line\">&#125;                                                                                   </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Find the first child that ends after the scroll offset.                                  </span></span><br><span class=\"line\"><span class=\"keyword\">while</span> (endScrollOffset &lt; scrollOffset) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 记录需要回收的项目</span></span><br><span class=\"line\">  leadingGarbage += <span class=\"number\">1</span>;                                                                      </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!advance()) &#123;                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">assert</span>(leadingGarbage == childCount);                                                   </span><br><span class=\"line\">    <span class=\"keyword\">assert</span>(child == <span class=\"keyword\">null</span>);                                                                  </span><br><span class=\"line\">    <span class=\"comment\">// we want to make sure we keep the last child around so we know the end scroll offset  </span></span><br><span class=\"line\">    collectGarbage(leadingGarbage - <span class=\"number\">1</span>, <span class=\"number\">0</span>);                                                  </span><br><span class=\"line\">    <span class=\"keyword\">assert</span>(firstChild == lastChild);                                                        </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"built_in\">double</span> extent = childScrollOffset(lastChild) +                                    </span><br><span class=\"line\">        paintExtentOf(lastChild);                                                           </span><br><span class=\"line\">    geometry = SliverGeometry(                                                              </span><br><span class=\"line\">      scrollExtent: extent,                                                                 </span><br><span class=\"line\">      paintExtent: <span class=\"number\">0.0</span>,                                                                     </span><br><span class=\"line\">      maxPaintExtent: extent,                                                               </span><br><span class=\"line\">    );                                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">return</span>;                                                                                 </span><br><span class=\"line\">  &#125;                                                                                         </span><br><span class=\"line\">&#125;                                                                                           </span><br></pre></td></tr></table></figure>\n\n<p>不在可见视图，不在缓存区域的，记录头部需要回收的。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Now find the first child that ends after our end.    </span></span><br><span class=\"line\"><span class=\"keyword\">while</span> (endScrollOffset &lt; targetEndScrollOffset) &#123;       </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!advance()) &#123;                                     </span><br><span class=\"line\">    reachedEnd = <span class=\"keyword\">true</span>;                                  </span><br><span class=\"line\">    <span class=\"keyword\">break</span>;                                              </span><br><span class=\"line\">  &#125;                                                     </span><br><span class=\"line\">&#125;                                                       </span><br></pre></td></tr></table></figure>\n\n<p>从上往下滚动时，调用 <code>advance()</code> 不断在底部插入新的 child。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Finally count up all the remaining children and label them as garbage.    </span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (child != <span class=\"keyword\">null</span>) &#123;                                                         </span><br><span class=\"line\">  child = childAfter(child);                                                 </span><br><span class=\"line\">  <span class=\"keyword\">while</span> (child != <span class=\"keyword\">null</span>) &#123;                                                    </span><br><span class=\"line\">    trailingGarbage += <span class=\"number\">1</span>;                                                    </span><br><span class=\"line\">    child = childAfter(child);                                               </span><br><span class=\"line\">  &#125;                                                                          </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 回收</span></span><br><span class=\"line\">collectGarbage(leadingGarbage, trailingGarbage); </span><br></pre></td></tr></table></figure>\n\n<p>记录尾部需要回收的，全部一起回收。上图中用 nedd grabage 标记的区域。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">double</span> estimatedMaxScrollOffset;                                         </span><br><span class=\"line\"><span class=\"keyword\">if</span> (reachedEnd) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 没有 child 需要布局了</span></span><br><span class=\"line\">  estimatedMaxScrollOffset = endScrollOffset;                            </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;                                                                 </span><br><span class=\"line\">  estimatedMaxScrollOffset = childManager.estimateMaxScrollOffset(       </span><br><span class=\"line\">    constraints,                                                         </span><br><span class=\"line\">    firstIndex: indexOf(firstChild),                                     </span><br><span class=\"line\">    lastIndex: indexOf(lastChild),                                       </span><br><span class=\"line\">    leadingScrollOffset: childScrollOffset(firstChild),                  </span><br><span class=\"line\">    trailingScrollOffset: endScrollOffset,                               </span><br><span class=\"line\">  );                                                                     </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(estimatedMaxScrollOffset &gt;=                                     </span><br><span class=\"line\">      endScrollOffset - childScrollOffset(firstChild));                  </span><br><span class=\"line\">&#125;                                                                        </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> paintExtent = calculatePaintOffset(                         </span><br><span class=\"line\">  constraints,                                                           </span><br><span class=\"line\">  from: childScrollOffset(firstChild),                                   </span><br><span class=\"line\">  to: endScrollOffset,                                                   </span><br><span class=\"line\">);                                                                       </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> cacheExtent = calculateCacheOffset(                         </span><br><span class=\"line\">  constraints,                                                           </span><br><span class=\"line\">  from: childScrollOffset(firstChild),                                   </span><br><span class=\"line\">  to: endScrollOffset,                                                   </span><br><span class=\"line\">);                                                                       </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">double</span> targetEndScrollOffsetForPaint = constraints.scrollOffset +  </span><br><span class=\"line\">    constraints.remainingPaintExtent;</span><br><span class=\"line\"><span class=\"comment\">// 反馈布局消费请求</span></span><br><span class=\"line\">geometry = SliverGeometry(                                               </span><br><span class=\"line\">  scrollExtent: estimatedMaxScrollOffset,                                </span><br><span class=\"line\">  paintExtent: paintExtent,                                              </span><br><span class=\"line\">  cacheExtent: cacheExtent,                                              </span><br><span class=\"line\">  maxPaintExtent: estimatedMaxScrollOffset,                              </span><br><span class=\"line\">  <span class=\"comment\">// Conservative to avoid flickering away the clip during scroll.       </span></span><br><span class=\"line\">  hasVisualOverflow: endScrollOffset &gt; targetEndScrollOffsetForPaint ||  </span><br><span class=\"line\">      constraints.scrollOffset &gt; <span class=\"number\">0.0</span>,                                    </span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 布局结束</span></span><br><span class=\"line\">childManager.didFinishLayout(); </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>在分析完 <code>ListView</code> 的布局流程后，可以发现整个流程还是比较清晰的。</p>\n<ol>\n<li>需要布局的区域包括可见区域和缓存区域</li>\n<li>在布局区域以外的进行回收</li>\n</ol>\n"},{"title":"Gradle多项目实践","date":"2018-05-08T10:58:17.000Z","_content":"\n## 前言\n\n上篇文章中，我们说到了 [Gradle多项目构建](https://linxiaotao.github.io/2018/04/29/Gradle%E5%A4%9A%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/) 的一些知识点，但这些总归只是纸上谈兵，今天我们在实际项目中通过之前学到的知识去改造下项目的 Gradle 构建脚本，充分利用 Gradle 带来的好处。\n\n虽然使用 Gradle 作为构建工具已经有一段时间了，但很多同学对它还是很陌生的，基本都是沿用 Android Studio 默认生成的配置，用的比较多的可能也只是 `dependencies` 配置，从不同的 `repositories` 去下载依赖，可能在需要实现一些自定义配置的时候，就去 google 后照搬代码，对其配置参数也是似懂非懂，出了问题不知道如何下手解决，所以这篇文章的主要目的是，实践 Gradle 在 Android 上的运用，对 Gradle 的使用有基本认识。\n\n[项目源码](https://github.com/LinXiaoTao/GradleCaseProject)\n\n## 改造开始\n\n### Gradle 知识\n\n我们先看下 Android Studio 默认帮我们生成的配置代码：\n\n``` groovy\napply plugin: 'com.android.application'\n\nandroid {\n    // android 构建配置\n}\n\ndependencies {\n \t// 依赖配置\n}\n\n```\n\n先简单讲下上面各部分的配置含义，首先我们知道如果不先 `apply plugin: 'com.android.application'` 就不会有 `android` 配置选项，那么这个配置选项具体是什么内容呢？我们可以通过源码了解下，`com.android.application` 这个插件就是我们在根目录下的 *build.gradle* 中导入的：\n\n``` groovy\nbuildscript {\n    repositories {\n        // 构建脚本依赖源地址\n    }\n    dependencies {\n        classpath 'com.android.tools.build:gradle:3.1.2'\n    }\n}\n```\n\n对 Gradle Plugin 有点了解的同学都知道，Gradle Plugin 需要定义到 *META-INF* 中，浏览 *gradle-3.1.2.jar*，*META-INF* 目录如下：\n\n```\n├── MANIFEST.MF\n├── gradle-plugins\n│   ├── android-library.properties\n│   ├── android-reporting.properties\n│   ├── android.properties\n│   ├── com.android.application.properties\n│   ├── com.android.atom.properties\n│   ├── com.android.bundle.properties\n│   ├── com.android.debug.structure.properties\n│   ├── com.android.feature.properties\n│   ├── com.android.instantapp.properties\n│   ├── com.android.library.properties\n│   ├── com.android.lint.properties\n│   └── com.android.test.properties\n```\n\n这里对应的是提供的各个插件的配置，比如 *com.android.application.properties* 就表示 `com.android.application` 插件，其他也是一样，properties 的名称表示插件的名称。*com.android.application.properties* 的内容如下：\n\n```\nimplementation-class=com.android.build.gradle.AppPlugin\n```\n\n`com.android.build.gradle.AppPlugin` 这个类就是 Application Plugin 的源码。阅读 AppPlugin 源码，我们可以看到这一段：\n\n``` groovy\n\t@NonNull\n    @Override\n    protected BaseExtension createExtension(\n            @NonNull Project project,\n            @NonNull ProjectOptions projectOptions,\n            @NonNull AndroidBuilder androidBuilder,\n            @NonNull SdkHandler sdkHandler,\n            @NonNull NamedDomainObjectContainer<BuildType> buildTypeContainer,\n            @NonNull NamedDomainObjectContainer<ProductFlavor> productFlavorContainer,\n            @NonNull NamedDomainObjectContainer<SigningConfig> signingConfigContainer,\n            @NonNull NamedDomainObjectContainer<BaseVariantOutput> buildOutputs,\n            @NonNull SourceSetManager sourceSetManager,\n            @NonNull ExtraModelInfo extraModelInfo) {\n        return project.getExtensions()\n                .create(\n                        \"android\",\n                        AppExtension.class,\n                        project,\n                        projectOptions,\n                        androidBuilder,\n                        sdkHandler,\n                        buildTypeContainer,\n                        productFlavorContainer,\n                        signingConfigContainer,\n                        buildOutputs,\n                        sourceSetManager,\n                        extraModelInfo);\n    }\n```\n\n首先我们先通过 API 文档了解下 [project.extensions](https://docs.gradle.org/current/dsl/org.gradle.api.Project.html) 的定义：\n\n```\n定义：\n\tExtensionContainer extensions (read-only)\n说明：\n\tAllows adding DSL extensions to the project. Useful for plugin authors.\n\t允许向项目添加 DSL 扩展，对插件作者很有用\n```\n\n接着我们看下 [`ExtensionContainer.create`](https://docs.gradle.org/current/javadoc/org/gradle/api/plugins/ExtensionContainer.html#create-java.lang.String-java.lang.Class-java.lang.Object...-) 方法的定义：\n\n```\n定义：\n\t<T> T create(String name,Class<T> type,Object... constructionArguments)\n说明：\n\tCreates and adds a new extension to this container. A new instance of the given type will be created using the given constructionArguments. The extension will be exposed as type unless the extension itself declares a preferred public type via the HasPublicType protocol. The new instance will have been dynamically made ExtensionAware, which means that you can cast it to ExtensionAware.\n\t向项目创建并且添加一个新的扩展。通过给定的 type 创建一个新的实例，使用给定的 constructionArguments 构造函数参数。可以通过 HasPublicType 接口声明对外开放的类型，否则整个扩展将对外开放。新的实例将动态生成为 \nExtensionAware，这意味着你可以将它转换成 ExtensionAware\n```\n\n现在我们可以知道，为什么在引入 `com.android.application` 之后才能使用 `android` 配置块，这也意味着，`android` 所能提供的配置依赖于 `AppExtension` 这个类。\n\n这里我们简单就 `defaultConfig` 这个做下分析，先看下这个类在 `AppExtension` 中的配置，因为 `AppExtension` 直接调用超类 `TestedExtension` 的构造方法，而 `TestedExtension` 又会调用超类 `BaseExtension` 所以我们直接看到 `BaseExtension`：\n\n``` java\nprivate final DefaultConfig defaultConfig;\n\ndefaultConfig = objectFactory.newInstance(\n                        DefaultConfig.class,\n                        BuilderConstants.MAIN,\n                        project,\n                        objectFactory,\n                        extraModelInfo.getDeprecationReporter(),\n                        project.getLogger());\n```\n\n这里我们先不关心 `objectFactory.newInstance` 只需要知道，当我们在 `android` 配置块中，配置 `defaultConfig` 实质上也是，对 `DefaultConfig` 的配置，而 `DefaultConfig` 又继承于 `DefaultProductFlavor`，相关的配置同时也是 `DefaultProductFlavor` 的成员属性：\n\n> DefaultProductFlavor 位于 `builder-3.1.2.jar`\n>\n> Android Gradle Plugin 相关代码分别位于 `gradle-3.1.2.jar`、`gradle-api-3.1.2.jar`、`gradle-core-3.1.2.jar`\n>\n> 如果想查看源码，则下载 sources 包，比如 [builder-3.1.2-sources.jar](https://dl.google.com/dl/android/maven2/com/android/tools/build/builder/3.1.2/builder-3.1.2-sources.jar)，其他 jar 下载方法类似\n>\n> 心好累，各种继承。。。\n\n``` java\npublic class DefaultProductFlavor extends BaseConfigImpl implements ProductFlavor {\n    private static final long serialVersionUID = 1L;\n\n    @NonNull\n    private final String mName;\n    @Nullable\n    private String mDimension;\n    @Nullable\n    private ApiVersion mMinSdkVersion;\n    @Nullable\n    private ApiVersion mTargetSdkVersion;\n    @Nullable\n    private Integer mMaxSdkVersion;\n    @Nullable\n    private Integer mRenderscriptTargetApi;\n    @Nullable\n    private Boolean mRenderscriptSupportModeEnabled;\n    @Nullable\n    private Boolean mRenderscriptSupportModeBlasEnabled;\n    @Nullable\n    private Boolean mRenderscriptNdkModeEnabled;\n    @Nullable\n    private Integer mVersionCode;\n    @Nullable\n    private String mVersionName;\n    @Nullable\n    private String mApplicationId;\n    @Nullable\n    private String mTestApplicationId;\n    @Nullable\n    private String mTestInstrumentationRunner;\n    @NonNull\n    private Map<String, String> mTestInstrumentationRunnerArguments = Maps.newHashMap();\n    @Nullable\n    private Boolean mTestHandleProfiling;\n    @Nullable\n    private Boolean mTestFunctionalTest;\n    @Nullable\n    private SigningConfig mSigningConfig;\n    @Nullable\n    private Set<String> mResourceConfiguration;\n    @NonNull\n    private DefaultVectorDrawablesOptions mVectorDrawablesOptions;\n    @Nullable\n    private Boolean mWearAppUnbundled;\n}\n```\n\n### 重复配置处理\n\n当我们项目不止只有一个 app module 时，那么在其他 module 中，例如下面这些配置都需要去配置下：\n\n``` groovy\ndefaultConfig {\n        minSdkVersion 21\n        targetSdkVersion 27\n        versionCode 1\n        versionName \"1.0\"\n\n        testInstrumentationRunner \"android.support.test.runner.AndroidJUnitRunner\"\n\n    }\n```\n\n这样就显得很繁琐又不灵活，比如现在很多项目都开始进行组件化，有的 module 有时候是 `com.android.application`，有的时候又是  `com.android.library` 这样又得根据条件写两套配置，如果其中一个更改了，还得去挨个 module 中更改。\n\n而利用 Gradle 多项目构建，我们可以将这些重复配置都统一处理，还可以根据属性自动导入不同的 plugin。首先为了统一管理各种版本号，我们先新建一个 *constants.gradle* 将一些常量写入到 ext 中：\n\n``` groovy\nproject.ext {\n    compileSdkVersion = 27\n    \n    minSdkVersion = 21\n    \n    targetSdkVersion = 27\n    \n    versionCode = 1\n    \n    versionName = \"1.0\"\n}\n```\n\n>  ext 实际上是 [ExtraPropertiesExtension](https://docs.gradle.org/current/dsl/org.gradle.api.plugins.ExtraPropertiesExtension.html) 类型，它类似 map，可以存储 key/value 键值对。ext 也是扩展的一种，可以通过 `project.extensions.getByName('ext')` 获取实例，所有的 [`ExtensionAware`](https://docs.gradle.org/current/dsl/org.gradle.api.plugins.ExtensionAware.html) 都拥有一个 `ext`，而 Project 又是继承于  `ExtensionAware`\n\n接着我们在各个 module 中创建一个 `gradle.properties` ，这个文件默认会被读取，在其中定义一个属性 `isApplication`，根据这个属性导入不同的 plugin：\n\n``` groovy\n// library module\nisApplication=false\n\n// application module\nisApplication=true\n```\n\n接着创建 *init.gradle*，在 `subprojects` 中配置，这里的配置对所有的子项目都会生效：\n\n``` groovy\nsubprojects {\n    if (project.isApplication.toBoolean()) {\n        // 当前 module 导入 application plugin\n        project.plugins.apply(\"com.android.application\")\n    } else {\n        project.plugins.apply(\"com.android.library\")\n    }\n}\n```\n\n> 这里有点地方需要注意下，因为属性的获取都是通过 String 类型，所以我们需要明确使用 `toBoolean()` 去转化成布尔值\n\n最后要想使得这些 gradle 文件生效，需要将它们 apply 进去，因为 Gradle 默认只会识别 `build.gradle`，还记得我们在 [Gradle多项目构建](https://linxiaotao.github.io/2018/04/29/Gradle%E5%A4%9A%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/) 中说到，*Gradle 是边读取边执行的* ，这意味着你需要在使用到 `android` 构建块之前，将 plugin apply 进去，所以我们将这些 gradle 文件在根目录的 *build.gradle* 中 apply，因为默认根目录的优先级最高：\n\n``` groovy\n// constants.gradle 需要在 init.gradle，因为 init.gradle 后面会使用到 constants.gradle 中定义的值，理由如上\napply from: 'gradle/constants.gradle'\napply from: 'gradle/init.gradle'\n```\n\n我们将 module 下 *build.gradle* 中的 apply 代码删除，重新同步下，可以发现 `android` 配置块依然生效，这意味着，我们 apply plugin 操作成功了。\n\n在处理完 plugin 之后，我们可以将 `android` 配置块中的重复配置也在 *init.gradle* 中去配置：\n\n``` groovy\nsubprojects {\n    if (project.isApplication.toBoolean()) {\n        // 当前 module 导入 application plugin\n        project.plugins.apply(\"com.android.application\")\n    } else {\n        project.plugins.apply(\"com.android.library\")\n    }\n    android {\n        compileSdkVersion rootProject.ext['compileSdkVersion']\n        defaultConfig {\n            minSdkVersion rootProject.ext['minSdkVersion']\n            targetSdkVersion rootProject.ext['targetSdkVersion']\n            versionCode rootProject.ext['versionCode']\n            versionName rootProject.ext['versionName']\n            testInstrumentationRunner \"android.support.test.runner.AndroidJUnitRunner\"\n        }\n        buildTypes {\n            release {\n                minifyEnabled false\n                proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'\n            }\n        }\n    }\n\n}\n```\n\n是不是非常方便，这样统一的配置你只需要写一次，不只是 `android` 配置块可以这么处理，其他的配置也可以这么处理。\n\n### 依赖管理\n\n一般情况下，我们会在各个 module 下去编写所需的依赖配置，比如通过 `implementation 'com.android.support:appcompat-v7:27.1.1'` 去从 maven 中心仓库或者 jcenter 中下载依赖，但这样有个不好的地方就是依赖配置太分散了，只能到每个 module 目录中的 *build.gradle* 去管理，如果我们将这个写到统一的 Gradle 构建脚本中，是不是会更好点，我们同样创建个 *dependencies.gradle*，将共同的依赖写到 `subprojects` ，特有的依赖写到单独的项目配置中，同样这个文件需要在根目录的 *build.gradle* 中 apply：\n\n``` groovy\nsubprojects {\n    dependencies {\n        testImplementation rootProject.ext.dependencies['junit']\n        androidTestImplementation rootProject.ext.dependencies['runner']\n        androidTestImplementation rootProject.ext.dependencies['espresso-core']\n    }\n}\n\nproject(':mylibrary') {\n    dependencies {\n        api fileTree(dir: 'libs', include: ['*.jar'])\n        api rootProject.ext.dependencies['appcompat-v7']\n        api rootProject.ext.dependencies['constraint-layout']\n    }\n}\n\nproject(':app') {\n    dependencies {\n        implementation fileTree(dir: 'libs', include: ['*.jar'])\n        implementation project(\":mylibrary\")\n    }\n}\n```\n\n我们可以将共同的依赖写到 `subprojects` 块，单独项目的配置写到各自的配置块下。\n\n现在我们再来解决另外一个常见的问题：依赖冲突，比如不同的依赖项各自又依赖于同一个库的不同版本，默认 [Gradle 会用这个重复库的最高版本](https://docs.gradle.org/current/userguide/troubleshooting_dependency_resolution.html#sub:version_conflicts)，但如果你配置了 `resolutionStrategy.failOnVersionConflict()` 即当出现版本冲突则失败，或者版本选择不合适，等等，就会出现依赖冲突问题。\n\n我们通过个例子来证实默认的处理策略，我们在 app 模块中去依赖  `com.android.support:design:27.1.1` 和 `com.android.support:recyclerview-v7:26.1.0` ，而 `design` 会自动去依赖 `com.android.support:recyclerview-v7:27.1.1`，依赖关系我们可以通过 `./gradlew :app:dependencies` 这个 Task 去查看，这里我们只查看 *releaseCompileClasspath* 依赖配置中 `design` 和 `recyclerview` 的情况：\n\n```\n+--- project :mylibrary\n|    \\--- com.android.support:design:27.1.1\n|         +--- com.android.support:support-v4:27.1.1\n|         |    +--- com.android.support:support-compat:27.1.1 (*)\n|         |    +--- com.android.support:support-media-compat:27.1.1\n|         |    |    +--- com.android.support:support-annotations:27.1.1\n|         |    |    \\--- com.android.support:support-compat:27.1.1 (*)\n|         |    +--- com.android.support:support-core-utils:27.1.1 (*)\n|         |    +--- com.android.support:support-core-ui:27.1.1 (*)\n|         |    \\--- com.android.support:support-fragment:27.1.1 (*)\n|         +--- com.android.support:appcompat-v7:27.1.1 (*)\n|         +--- com.android.support:recyclerview-v7:27.1.1\n|         |    +--- com.android.support:support-annotations:27.1.1\n|         |    +--- com.android.support:support-compat:27.1.1 (*)\n|         |    \\--- com.android.support:support-core-ui:27.1.1 (*)\n|         \\--- com.android.support:transition:27.1.1\n|              +--- com.android.support:support-annotations:27.1.1\n|              \\--- com.android.support:support-compat:27.1.1 (*)\n\\--- com.android.support:recyclerview-v7:26.1.0 -> 27.1.1 (*)\n```\n\n可以看到我们依赖的 26.1.0 已经被替换成 27.1.1，如果这是我们想要的结果，那就很理想，但是如果我们想要去定义依赖冲突的策略呢？同样的，Gradle 也提供了相应的 API。\n\n还是上面的例子，如果我们不想要使用 `design` 中的 `recyclerview` 而想要我们单独依赖的 `recyclerview-v7:26.1.1` 这里我们有几种方式解决：\n\n1. 不传递依赖\n\n   ``` groovy\n   api(rootProject.ext.dependencies['design']) {\n               transitive = false\n   }\n   ```\n\n2. 强制使用当前版本\n\n   ``` groovy\n   implementation(rootProject.ext.dependencies['recyclerview']) {\n               force = true\n   }\n   ```\n\n其他的解决方案可以参考[官方文档](https://docs.gradle.org/current/userguide/introduction_dependency_management.html)\n\n这里我们使用 Gradle 提供的 [resolutionStrategy](https://docs.gradle.org/current/userguide/customizing_dependency_resolution_behavior.html) 方案： \n\n``` groovy\nsubprojects {\n    configurations.all {\n        resolutionStrategy {\n            force rootProject.ext.dependencies['recyclerview']\n        }\n    }\n}\n```\n\n`configurations` 表示当前项目的依赖配置容器，`configurations.all` 表示当前项目的所有依赖配置，上面的配置表示，遍历当前项目的所有依赖配置，设置其依赖解决策略为 **强制使用指定的版本**\n\n## 改造结束\n\n现在我们再来对比下，默认生成的构建配置和改造后的构建配置：\n\n``` groovy\napply plugin: 'com.android.application'\n\nandroid {\n    compileSdkVersion 27\n    defaultConfig {\n        applicationId \"com.example.leo.gradlecaseproject\"\n        minSdkVersion 21\n        targetSdkVersion 27\n        versionCode 1\n        versionName \"1.0\"\n        testInstrumentationRunner \"android.support.test.runner.AndroidJUnitRunner\"\n    }\n    buildTypes {\n        release {\n            minifyEnabled false\n            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'\n        }\n    }\n}\n\ndependencies {\n    implementation fileTree(dir: 'libs', include: ['*.jar'])\n    implementation 'com.android.support:appcompat-v7:27.1.1'\n    implementation 'com.android.support.constraint:constraint-layout:1.1.0'\n    testImplementation 'junit:junit:4.12'\n    androidTestImplementation 'com.android.support.test:runner:1.0.2'\n    androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2'\n}\n\n```\n\n``` groovy\nandroid {\n    defaultConfig {\n        applicationId \"com.example.leo.gradlecaseproject\"\n    }\n}\n```\n\n是不是简洁了不少，重复的配置项我们交给统一的配置文件去做，依赖配置也是如此，包括依赖冲突的解决策略，但是 Gradle 能实现的不仅仅如此，还有强大的自定义 Gradle Plugin 我们还没讲到。\n\n## 总结\n\n通过这篇文章，不仅仅是教会大家如何去编写简单的 Gradle 构建脚本，更重要的想让大家对 Gradle 有个初步的认识，知道 Gradle 的配置块是如何生成的，更多知识可以通过[官方文档](https://docs.gradle.org/current/userguide/userguide.html)去获取。","source":"_posts/Gradle多项目实践.md","raw":"---\ntitle: Gradle多项目实践\ndate: 2018-05-08 18:58:17\ncategories: Gradle\ntags:\n---\n\n## 前言\n\n上篇文章中，我们说到了 [Gradle多项目构建](https://linxiaotao.github.io/2018/04/29/Gradle%E5%A4%9A%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/) 的一些知识点，但这些总归只是纸上谈兵，今天我们在实际项目中通过之前学到的知识去改造下项目的 Gradle 构建脚本，充分利用 Gradle 带来的好处。\n\n虽然使用 Gradle 作为构建工具已经有一段时间了，但很多同学对它还是很陌生的，基本都是沿用 Android Studio 默认生成的配置，用的比较多的可能也只是 `dependencies` 配置，从不同的 `repositories` 去下载依赖，可能在需要实现一些自定义配置的时候，就去 google 后照搬代码，对其配置参数也是似懂非懂，出了问题不知道如何下手解决，所以这篇文章的主要目的是，实践 Gradle 在 Android 上的运用，对 Gradle 的使用有基本认识。\n\n[项目源码](https://github.com/LinXiaoTao/GradleCaseProject)\n\n## 改造开始\n\n### Gradle 知识\n\n我们先看下 Android Studio 默认帮我们生成的配置代码：\n\n``` groovy\napply plugin: 'com.android.application'\n\nandroid {\n    // android 构建配置\n}\n\ndependencies {\n \t// 依赖配置\n}\n\n```\n\n先简单讲下上面各部分的配置含义，首先我们知道如果不先 `apply plugin: 'com.android.application'` 就不会有 `android` 配置选项，那么这个配置选项具体是什么内容呢？我们可以通过源码了解下，`com.android.application` 这个插件就是我们在根目录下的 *build.gradle* 中导入的：\n\n``` groovy\nbuildscript {\n    repositories {\n        // 构建脚本依赖源地址\n    }\n    dependencies {\n        classpath 'com.android.tools.build:gradle:3.1.2'\n    }\n}\n```\n\n对 Gradle Plugin 有点了解的同学都知道，Gradle Plugin 需要定义到 *META-INF* 中，浏览 *gradle-3.1.2.jar*，*META-INF* 目录如下：\n\n```\n├── MANIFEST.MF\n├── gradle-plugins\n│   ├── android-library.properties\n│   ├── android-reporting.properties\n│   ├── android.properties\n│   ├── com.android.application.properties\n│   ├── com.android.atom.properties\n│   ├── com.android.bundle.properties\n│   ├── com.android.debug.structure.properties\n│   ├── com.android.feature.properties\n│   ├── com.android.instantapp.properties\n│   ├── com.android.library.properties\n│   ├── com.android.lint.properties\n│   └── com.android.test.properties\n```\n\n这里对应的是提供的各个插件的配置，比如 *com.android.application.properties* 就表示 `com.android.application` 插件，其他也是一样，properties 的名称表示插件的名称。*com.android.application.properties* 的内容如下：\n\n```\nimplementation-class=com.android.build.gradle.AppPlugin\n```\n\n`com.android.build.gradle.AppPlugin` 这个类就是 Application Plugin 的源码。阅读 AppPlugin 源码，我们可以看到这一段：\n\n``` groovy\n\t@NonNull\n    @Override\n    protected BaseExtension createExtension(\n            @NonNull Project project,\n            @NonNull ProjectOptions projectOptions,\n            @NonNull AndroidBuilder androidBuilder,\n            @NonNull SdkHandler sdkHandler,\n            @NonNull NamedDomainObjectContainer<BuildType> buildTypeContainer,\n            @NonNull NamedDomainObjectContainer<ProductFlavor> productFlavorContainer,\n            @NonNull NamedDomainObjectContainer<SigningConfig> signingConfigContainer,\n            @NonNull NamedDomainObjectContainer<BaseVariantOutput> buildOutputs,\n            @NonNull SourceSetManager sourceSetManager,\n            @NonNull ExtraModelInfo extraModelInfo) {\n        return project.getExtensions()\n                .create(\n                        \"android\",\n                        AppExtension.class,\n                        project,\n                        projectOptions,\n                        androidBuilder,\n                        sdkHandler,\n                        buildTypeContainer,\n                        productFlavorContainer,\n                        signingConfigContainer,\n                        buildOutputs,\n                        sourceSetManager,\n                        extraModelInfo);\n    }\n```\n\n首先我们先通过 API 文档了解下 [project.extensions](https://docs.gradle.org/current/dsl/org.gradle.api.Project.html) 的定义：\n\n```\n定义：\n\tExtensionContainer extensions (read-only)\n说明：\n\tAllows adding DSL extensions to the project. Useful for plugin authors.\n\t允许向项目添加 DSL 扩展，对插件作者很有用\n```\n\n接着我们看下 [`ExtensionContainer.create`](https://docs.gradle.org/current/javadoc/org/gradle/api/plugins/ExtensionContainer.html#create-java.lang.String-java.lang.Class-java.lang.Object...-) 方法的定义：\n\n```\n定义：\n\t<T> T create(String name,Class<T> type,Object... constructionArguments)\n说明：\n\tCreates and adds a new extension to this container. A new instance of the given type will be created using the given constructionArguments. The extension will be exposed as type unless the extension itself declares a preferred public type via the HasPublicType protocol. The new instance will have been dynamically made ExtensionAware, which means that you can cast it to ExtensionAware.\n\t向项目创建并且添加一个新的扩展。通过给定的 type 创建一个新的实例，使用给定的 constructionArguments 构造函数参数。可以通过 HasPublicType 接口声明对外开放的类型，否则整个扩展将对外开放。新的实例将动态生成为 \nExtensionAware，这意味着你可以将它转换成 ExtensionAware\n```\n\n现在我们可以知道，为什么在引入 `com.android.application` 之后才能使用 `android` 配置块，这也意味着，`android` 所能提供的配置依赖于 `AppExtension` 这个类。\n\n这里我们简单就 `defaultConfig` 这个做下分析，先看下这个类在 `AppExtension` 中的配置，因为 `AppExtension` 直接调用超类 `TestedExtension` 的构造方法，而 `TestedExtension` 又会调用超类 `BaseExtension` 所以我们直接看到 `BaseExtension`：\n\n``` java\nprivate final DefaultConfig defaultConfig;\n\ndefaultConfig = objectFactory.newInstance(\n                        DefaultConfig.class,\n                        BuilderConstants.MAIN,\n                        project,\n                        objectFactory,\n                        extraModelInfo.getDeprecationReporter(),\n                        project.getLogger());\n```\n\n这里我们先不关心 `objectFactory.newInstance` 只需要知道，当我们在 `android` 配置块中，配置 `defaultConfig` 实质上也是，对 `DefaultConfig` 的配置，而 `DefaultConfig` 又继承于 `DefaultProductFlavor`，相关的配置同时也是 `DefaultProductFlavor` 的成员属性：\n\n> DefaultProductFlavor 位于 `builder-3.1.2.jar`\n>\n> Android Gradle Plugin 相关代码分别位于 `gradle-3.1.2.jar`、`gradle-api-3.1.2.jar`、`gradle-core-3.1.2.jar`\n>\n> 如果想查看源码，则下载 sources 包，比如 [builder-3.1.2-sources.jar](https://dl.google.com/dl/android/maven2/com/android/tools/build/builder/3.1.2/builder-3.1.2-sources.jar)，其他 jar 下载方法类似\n>\n> 心好累，各种继承。。。\n\n``` java\npublic class DefaultProductFlavor extends BaseConfigImpl implements ProductFlavor {\n    private static final long serialVersionUID = 1L;\n\n    @NonNull\n    private final String mName;\n    @Nullable\n    private String mDimension;\n    @Nullable\n    private ApiVersion mMinSdkVersion;\n    @Nullable\n    private ApiVersion mTargetSdkVersion;\n    @Nullable\n    private Integer mMaxSdkVersion;\n    @Nullable\n    private Integer mRenderscriptTargetApi;\n    @Nullable\n    private Boolean mRenderscriptSupportModeEnabled;\n    @Nullable\n    private Boolean mRenderscriptSupportModeBlasEnabled;\n    @Nullable\n    private Boolean mRenderscriptNdkModeEnabled;\n    @Nullable\n    private Integer mVersionCode;\n    @Nullable\n    private String mVersionName;\n    @Nullable\n    private String mApplicationId;\n    @Nullable\n    private String mTestApplicationId;\n    @Nullable\n    private String mTestInstrumentationRunner;\n    @NonNull\n    private Map<String, String> mTestInstrumentationRunnerArguments = Maps.newHashMap();\n    @Nullable\n    private Boolean mTestHandleProfiling;\n    @Nullable\n    private Boolean mTestFunctionalTest;\n    @Nullable\n    private SigningConfig mSigningConfig;\n    @Nullable\n    private Set<String> mResourceConfiguration;\n    @NonNull\n    private DefaultVectorDrawablesOptions mVectorDrawablesOptions;\n    @Nullable\n    private Boolean mWearAppUnbundled;\n}\n```\n\n### 重复配置处理\n\n当我们项目不止只有一个 app module 时，那么在其他 module 中，例如下面这些配置都需要去配置下：\n\n``` groovy\ndefaultConfig {\n        minSdkVersion 21\n        targetSdkVersion 27\n        versionCode 1\n        versionName \"1.0\"\n\n        testInstrumentationRunner \"android.support.test.runner.AndroidJUnitRunner\"\n\n    }\n```\n\n这样就显得很繁琐又不灵活，比如现在很多项目都开始进行组件化，有的 module 有时候是 `com.android.application`，有的时候又是  `com.android.library` 这样又得根据条件写两套配置，如果其中一个更改了，还得去挨个 module 中更改。\n\n而利用 Gradle 多项目构建，我们可以将这些重复配置都统一处理，还可以根据属性自动导入不同的 plugin。首先为了统一管理各种版本号，我们先新建一个 *constants.gradle* 将一些常量写入到 ext 中：\n\n``` groovy\nproject.ext {\n    compileSdkVersion = 27\n    \n    minSdkVersion = 21\n    \n    targetSdkVersion = 27\n    \n    versionCode = 1\n    \n    versionName = \"1.0\"\n}\n```\n\n>  ext 实际上是 [ExtraPropertiesExtension](https://docs.gradle.org/current/dsl/org.gradle.api.plugins.ExtraPropertiesExtension.html) 类型，它类似 map，可以存储 key/value 键值对。ext 也是扩展的一种，可以通过 `project.extensions.getByName('ext')` 获取实例，所有的 [`ExtensionAware`](https://docs.gradle.org/current/dsl/org.gradle.api.plugins.ExtensionAware.html) 都拥有一个 `ext`，而 Project 又是继承于  `ExtensionAware`\n\n接着我们在各个 module 中创建一个 `gradle.properties` ，这个文件默认会被读取，在其中定义一个属性 `isApplication`，根据这个属性导入不同的 plugin：\n\n``` groovy\n// library module\nisApplication=false\n\n// application module\nisApplication=true\n```\n\n接着创建 *init.gradle*，在 `subprojects` 中配置，这里的配置对所有的子项目都会生效：\n\n``` groovy\nsubprojects {\n    if (project.isApplication.toBoolean()) {\n        // 当前 module 导入 application plugin\n        project.plugins.apply(\"com.android.application\")\n    } else {\n        project.plugins.apply(\"com.android.library\")\n    }\n}\n```\n\n> 这里有点地方需要注意下，因为属性的获取都是通过 String 类型，所以我们需要明确使用 `toBoolean()` 去转化成布尔值\n\n最后要想使得这些 gradle 文件生效，需要将它们 apply 进去，因为 Gradle 默认只会识别 `build.gradle`，还记得我们在 [Gradle多项目构建](https://linxiaotao.github.io/2018/04/29/Gradle%E5%A4%9A%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/) 中说到，*Gradle 是边读取边执行的* ，这意味着你需要在使用到 `android` 构建块之前，将 plugin apply 进去，所以我们将这些 gradle 文件在根目录的 *build.gradle* 中 apply，因为默认根目录的优先级最高：\n\n``` groovy\n// constants.gradle 需要在 init.gradle，因为 init.gradle 后面会使用到 constants.gradle 中定义的值，理由如上\napply from: 'gradle/constants.gradle'\napply from: 'gradle/init.gradle'\n```\n\n我们将 module 下 *build.gradle* 中的 apply 代码删除，重新同步下，可以发现 `android` 配置块依然生效，这意味着，我们 apply plugin 操作成功了。\n\n在处理完 plugin 之后，我们可以将 `android` 配置块中的重复配置也在 *init.gradle* 中去配置：\n\n``` groovy\nsubprojects {\n    if (project.isApplication.toBoolean()) {\n        // 当前 module 导入 application plugin\n        project.plugins.apply(\"com.android.application\")\n    } else {\n        project.plugins.apply(\"com.android.library\")\n    }\n    android {\n        compileSdkVersion rootProject.ext['compileSdkVersion']\n        defaultConfig {\n            minSdkVersion rootProject.ext['minSdkVersion']\n            targetSdkVersion rootProject.ext['targetSdkVersion']\n            versionCode rootProject.ext['versionCode']\n            versionName rootProject.ext['versionName']\n            testInstrumentationRunner \"android.support.test.runner.AndroidJUnitRunner\"\n        }\n        buildTypes {\n            release {\n                minifyEnabled false\n                proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'\n            }\n        }\n    }\n\n}\n```\n\n是不是非常方便，这样统一的配置你只需要写一次，不只是 `android` 配置块可以这么处理，其他的配置也可以这么处理。\n\n### 依赖管理\n\n一般情况下，我们会在各个 module 下去编写所需的依赖配置，比如通过 `implementation 'com.android.support:appcompat-v7:27.1.1'` 去从 maven 中心仓库或者 jcenter 中下载依赖，但这样有个不好的地方就是依赖配置太分散了，只能到每个 module 目录中的 *build.gradle* 去管理，如果我们将这个写到统一的 Gradle 构建脚本中，是不是会更好点，我们同样创建个 *dependencies.gradle*，将共同的依赖写到 `subprojects` ，特有的依赖写到单独的项目配置中，同样这个文件需要在根目录的 *build.gradle* 中 apply：\n\n``` groovy\nsubprojects {\n    dependencies {\n        testImplementation rootProject.ext.dependencies['junit']\n        androidTestImplementation rootProject.ext.dependencies['runner']\n        androidTestImplementation rootProject.ext.dependencies['espresso-core']\n    }\n}\n\nproject(':mylibrary') {\n    dependencies {\n        api fileTree(dir: 'libs', include: ['*.jar'])\n        api rootProject.ext.dependencies['appcompat-v7']\n        api rootProject.ext.dependencies['constraint-layout']\n    }\n}\n\nproject(':app') {\n    dependencies {\n        implementation fileTree(dir: 'libs', include: ['*.jar'])\n        implementation project(\":mylibrary\")\n    }\n}\n```\n\n我们可以将共同的依赖写到 `subprojects` 块，单独项目的配置写到各自的配置块下。\n\n现在我们再来解决另外一个常见的问题：依赖冲突，比如不同的依赖项各自又依赖于同一个库的不同版本，默认 [Gradle 会用这个重复库的最高版本](https://docs.gradle.org/current/userguide/troubleshooting_dependency_resolution.html#sub:version_conflicts)，但如果你配置了 `resolutionStrategy.failOnVersionConflict()` 即当出现版本冲突则失败，或者版本选择不合适，等等，就会出现依赖冲突问题。\n\n我们通过个例子来证实默认的处理策略，我们在 app 模块中去依赖  `com.android.support:design:27.1.1` 和 `com.android.support:recyclerview-v7:26.1.0` ，而 `design` 会自动去依赖 `com.android.support:recyclerview-v7:27.1.1`，依赖关系我们可以通过 `./gradlew :app:dependencies` 这个 Task 去查看，这里我们只查看 *releaseCompileClasspath* 依赖配置中 `design` 和 `recyclerview` 的情况：\n\n```\n+--- project :mylibrary\n|    \\--- com.android.support:design:27.1.1\n|         +--- com.android.support:support-v4:27.1.1\n|         |    +--- com.android.support:support-compat:27.1.1 (*)\n|         |    +--- com.android.support:support-media-compat:27.1.1\n|         |    |    +--- com.android.support:support-annotations:27.1.1\n|         |    |    \\--- com.android.support:support-compat:27.1.1 (*)\n|         |    +--- com.android.support:support-core-utils:27.1.1 (*)\n|         |    +--- com.android.support:support-core-ui:27.1.1 (*)\n|         |    \\--- com.android.support:support-fragment:27.1.1 (*)\n|         +--- com.android.support:appcompat-v7:27.1.1 (*)\n|         +--- com.android.support:recyclerview-v7:27.1.1\n|         |    +--- com.android.support:support-annotations:27.1.1\n|         |    +--- com.android.support:support-compat:27.1.1 (*)\n|         |    \\--- com.android.support:support-core-ui:27.1.1 (*)\n|         \\--- com.android.support:transition:27.1.1\n|              +--- com.android.support:support-annotations:27.1.1\n|              \\--- com.android.support:support-compat:27.1.1 (*)\n\\--- com.android.support:recyclerview-v7:26.1.0 -> 27.1.1 (*)\n```\n\n可以看到我们依赖的 26.1.0 已经被替换成 27.1.1，如果这是我们想要的结果，那就很理想，但是如果我们想要去定义依赖冲突的策略呢？同样的，Gradle 也提供了相应的 API。\n\n还是上面的例子，如果我们不想要使用 `design` 中的 `recyclerview` 而想要我们单独依赖的 `recyclerview-v7:26.1.1` 这里我们有几种方式解决：\n\n1. 不传递依赖\n\n   ``` groovy\n   api(rootProject.ext.dependencies['design']) {\n               transitive = false\n   }\n   ```\n\n2. 强制使用当前版本\n\n   ``` groovy\n   implementation(rootProject.ext.dependencies['recyclerview']) {\n               force = true\n   }\n   ```\n\n其他的解决方案可以参考[官方文档](https://docs.gradle.org/current/userguide/introduction_dependency_management.html)\n\n这里我们使用 Gradle 提供的 [resolutionStrategy](https://docs.gradle.org/current/userguide/customizing_dependency_resolution_behavior.html) 方案： \n\n``` groovy\nsubprojects {\n    configurations.all {\n        resolutionStrategy {\n            force rootProject.ext.dependencies['recyclerview']\n        }\n    }\n}\n```\n\n`configurations` 表示当前项目的依赖配置容器，`configurations.all` 表示当前项目的所有依赖配置，上面的配置表示，遍历当前项目的所有依赖配置，设置其依赖解决策略为 **强制使用指定的版本**\n\n## 改造结束\n\n现在我们再来对比下，默认生成的构建配置和改造后的构建配置：\n\n``` groovy\napply plugin: 'com.android.application'\n\nandroid {\n    compileSdkVersion 27\n    defaultConfig {\n        applicationId \"com.example.leo.gradlecaseproject\"\n        minSdkVersion 21\n        targetSdkVersion 27\n        versionCode 1\n        versionName \"1.0\"\n        testInstrumentationRunner \"android.support.test.runner.AndroidJUnitRunner\"\n    }\n    buildTypes {\n        release {\n            minifyEnabled false\n            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'\n        }\n    }\n}\n\ndependencies {\n    implementation fileTree(dir: 'libs', include: ['*.jar'])\n    implementation 'com.android.support:appcompat-v7:27.1.1'\n    implementation 'com.android.support.constraint:constraint-layout:1.1.0'\n    testImplementation 'junit:junit:4.12'\n    androidTestImplementation 'com.android.support.test:runner:1.0.2'\n    androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2'\n}\n\n```\n\n``` groovy\nandroid {\n    defaultConfig {\n        applicationId \"com.example.leo.gradlecaseproject\"\n    }\n}\n```\n\n是不是简洁了不少，重复的配置项我们交给统一的配置文件去做，依赖配置也是如此，包括依赖冲突的解决策略，但是 Gradle 能实现的不仅仅如此，还有强大的自定义 Gradle Plugin 我们还没讲到。\n\n## 总结\n\n通过这篇文章，不仅仅是教会大家如何去编写简单的 Gradle 构建脚本，更重要的想让大家对 Gradle 有个初步的认识，知道 Gradle 的配置块是如何生成的，更多知识可以通过[官方文档](https://docs.gradle.org/current/userguide/userguide.html)去获取。","slug":"Gradle多项目实践","published":1,"updated":"2022-06-15T11:19:32.316Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlr000nfho6bysr5y6m","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>上篇文章中，我们说到了 <a href=\"https://linxiaotao.github.io/2018/04/29/Gradle%E5%A4%9A%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/\">Gradle多项目构建</a> 的一些知识点，但这些总归只是纸上谈兵，今天我们在实际项目中通过之前学到的知识去改造下项目的 Gradle 构建脚本，充分利用 Gradle 带来的好处。</p>\n<p>虽然使用 Gradle 作为构建工具已经有一段时间了，但很多同学对它还是很陌生的，基本都是沿用 Android Studio 默认生成的配置，用的比较多的可能也只是 <code>dependencies</code> 配置，从不同的 <code>repositories</code> 去下载依赖，可能在需要实现一些自定义配置的时候，就去 google 后照搬代码，对其配置参数也是似懂非懂，出了问题不知道如何下手解决，所以这篇文章的主要目的是，实践 Gradle 在 Android 上的运用，对 Gradle 的使用有基本认识。</p>\n<p><a href=\"https://github.com/LinXiaoTao/GradleCaseProject\">项目源码</a></p>\n<h2 id=\"改造开始\"><a href=\"#改造开始\" class=\"headerlink\" title=\"改造开始\"></a>改造开始</h2><h3 id=\"Gradle-知识\"><a href=\"#Gradle-知识\" class=\"headerlink\" title=\"Gradle 知识\"></a>Gradle 知识</h3><p>我们先看下 Android Studio 默认帮我们生成的配置代码：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;com.android.application&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">android &#123;</span><br><span class=\"line\">    <span class=\"comment\">// android 构建配置</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">dependencies &#123;</span><br><span class=\"line\"> \t<span class=\"comment\">// 依赖配置</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>先简单讲下上面各部分的配置含义，首先我们知道如果不先 <code>apply plugin: &#39;com.android.application&#39;</code> 就不会有 <code>android</code> 配置选项，那么这个配置选项具体是什么内容呢？我们可以通过源码了解下，<code>com.android.application</code> 这个插件就是我们在根目录下的 <em>build.gradle</em> 中导入的：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">buildscript &#123;</span><br><span class=\"line\">    repositories &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 构建脚本依赖源地址</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    dependencies &#123;</span><br><span class=\"line\">        classpath <span class=\"string\">&#x27;com.android.tools.build:gradle:3.1.2&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>对 Gradle Plugin 有点了解的同学都知道，Gradle Plugin 需要定义到 <em>META-INF</em> 中，浏览 <em>gradle-3.1.2.jar</em>，<em>META-INF</em> 目录如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── MANIFEST.MF</span><br><span class=\"line\">├── gradle-plugins</span><br><span class=\"line\">│   ├── android-library.properties</span><br><span class=\"line\">│   ├── android-reporting.properties</span><br><span class=\"line\">│   ├── android.properties</span><br><span class=\"line\">│   ├── com.android.application.properties</span><br><span class=\"line\">│   ├── com.android.atom.properties</span><br><span class=\"line\">│   ├── com.android.bundle.properties</span><br><span class=\"line\">│   ├── com.android.debug.structure.properties</span><br><span class=\"line\">│   ├── com.android.feature.properties</span><br><span class=\"line\">│   ├── com.android.instantapp.properties</span><br><span class=\"line\">│   ├── com.android.library.properties</span><br><span class=\"line\">│   ├── com.android.lint.properties</span><br><span class=\"line\">│   └── com.android.test.properties</span><br></pre></td></tr></table></figure>\n\n<p>这里对应的是提供的各个插件的配置，比如 <em>com.android.application.properties</em> 就表示 <code>com.android.application</code> 插件，其他也是一样，properties 的名称表示插件的名称。<em>com.android.application.properties</em> 的内容如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation-class=com.android.build.gradle.AppPlugin</span><br></pre></td></tr></table></figure>\n\n<p><code>com.android.build.gradle.AppPlugin</code> 这个类就是 Application Plugin 的源码。阅读 AppPlugin 源码，我们可以看到这一段：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@NonNull</span></span><br><span class=\"line\">   <span class=\"meta\">@Override</span></span><br><span class=\"line\">   <span class=\"keyword\">protected</span> BaseExtension createExtension(</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> Project project,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> ProjectOptions projectOptions,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> AndroidBuilder androidBuilder,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> SdkHandler sdkHandler,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> NamedDomainObjectContainer&lt;BuildType&gt; buildTypeContainer,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> NamedDomainObjectContainer&lt;ProductFlavor&gt; productFlavorContainer,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> NamedDomainObjectContainer&lt;SigningConfig&gt; signingConfigContainer,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> NamedDomainObjectContainer&lt;BaseVariantOutput&gt; buildOutputs,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> SourceSetManager sourceSetManager,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> ExtraModelInfo extraModelInfo) &#123;</span><br><span class=\"line\">       <span class=\"keyword\">return</span> project.getExtensions()</span><br><span class=\"line\">               .create(</span><br><span class=\"line\">                       <span class=\"string\">&quot;android&quot;</span>,</span><br><span class=\"line\">                       AppExtension.<span class=\"keyword\">class</span>,</span><br><span class=\"line\">                       project,</span><br><span class=\"line\">                       projectOptions,</span><br><span class=\"line\">                       androidBuilder,</span><br><span class=\"line\">                       sdkHandler,</span><br><span class=\"line\">                       buildTypeContainer,</span><br><span class=\"line\">                       productFlavorContainer,</span><br><span class=\"line\">                       signingConfigContainer,</span><br><span class=\"line\">                       buildOutputs,</span><br><span class=\"line\">                       sourceSetManager,</span><br><span class=\"line\">                       extraModelInfo);</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先我们先通过 API 文档了解下 <a href=\"https://docs.gradle.org/current/dsl/org.gradle.api.Project.html\">project.extensions</a> 的定义：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">定义：</span><br><span class=\"line\">\tExtensionContainer extensions (read-only)</span><br><span class=\"line\">说明：</span><br><span class=\"line\">\tAllows adding DSL extensions to the project. Useful for plugin authors.</span><br><span class=\"line\">\t允许向项目添加 DSL 扩展，对插件作者很有用</span><br></pre></td></tr></table></figure>\n\n<p>接着我们看下 <a href=\"https://docs.gradle.org/current/javadoc/org/gradle/api/plugins/ExtensionContainer.html#create-java.lang.String-java.lang.Class-java.lang.Object...-\"><code>ExtensionContainer.create</code></a> 方法的定义：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">定义：</span><br><span class=\"line\">\t&lt;T&gt; T create(String name,Class&lt;T&gt; type,Object... constructionArguments)</span><br><span class=\"line\">说明：</span><br><span class=\"line\">\tCreates and adds a new extension to this container. A new instance of the given type will be created using the given constructionArguments. The extension will be exposed as type unless the extension itself declares a preferred public type via the HasPublicType protocol. The new instance will have been dynamically made ExtensionAware, which means that you can cast it to ExtensionAware.</span><br><span class=\"line\">\t向项目创建并且添加一个新的扩展。通过给定的 type 创建一个新的实例，使用给定的 constructionArguments 构造函数参数。可以通过 HasPublicType 接口声明对外开放的类型，否则整个扩展将对外开放。新的实例将动态生成为 </span><br><span class=\"line\">ExtensionAware，这意味着你可以将它转换成 ExtensionAware</span><br></pre></td></tr></table></figure>\n\n<p>现在我们可以知道，为什么在引入 <code>com.android.application</code> 之后才能使用 <code>android</code> 配置块，这也意味着，<code>android</code> 所能提供的配置依赖于 <code>AppExtension</code> 这个类。</p>\n<p>这里我们简单就 <code>defaultConfig</code> 这个做下分析，先看下这个类在 <code>AppExtension</code> 中的配置，因为 <code>AppExtension</code> 直接调用超类 <code>TestedExtension</code> 的构造方法，而 <code>TestedExtension</code> 又会调用超类 <code>BaseExtension</code> 所以我们直接看到 <code>BaseExtension</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> DefaultConfig defaultConfig;</span><br><span class=\"line\"></span><br><span class=\"line\">defaultConfig = objectFactory.newInstance(</span><br><span class=\"line\">                        DefaultConfig.class,</span><br><span class=\"line\">                        BuilderConstants.MAIN,</span><br><span class=\"line\">                        project,</span><br><span class=\"line\">                        objectFactory,</span><br><span class=\"line\">                        extraModelInfo.getDeprecationReporter(),</span><br><span class=\"line\">                        project.getLogger());</span><br></pre></td></tr></table></figure>\n\n<p>这里我们先不关心 <code>objectFactory.newInstance</code> 只需要知道，当我们在 <code>android</code> 配置块中，配置 <code>defaultConfig</code> 实质上也是，对 <code>DefaultConfig</code> 的配置，而 <code>DefaultConfig</code> 又继承于 <code>DefaultProductFlavor</code>，相关的配置同时也是 <code>DefaultProductFlavor</code> 的成员属性：</p>\n<blockquote>\n<p>DefaultProductFlavor 位于 <code>builder-3.1.2.jar</code></p>\n<p>Android Gradle Plugin 相关代码分别位于 <code>gradle-3.1.2.jar</code>、<code>gradle-api-3.1.2.jar</code>、<code>gradle-core-3.1.2.jar</code></p>\n<p>如果想查看源码，则下载 sources 包，比如 <a href=\"https://dl.google.com/dl/android/maven2/com/android/tools/build/builder/3.1.2/builder-3.1.2-sources.jar\">builder-3.1.2-sources.jar</a>，其他 jar 下载方法类似</p>\n<p>心好累，各种继承。。。</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DefaultProductFlavor</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">BaseConfigImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">ProductFlavor</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">1L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@NonNull</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String mName;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String mDimension;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ApiVersion mMinSdkVersion;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ApiVersion mTargetSdkVersion;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer mMaxSdkVersion;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer mRenderscriptTargetApi;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mRenderscriptSupportModeEnabled;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mRenderscriptSupportModeBlasEnabled;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mRenderscriptNdkModeEnabled;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer mVersionCode;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String mVersionName;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String mApplicationId;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String mTestApplicationId;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String mTestInstrumentationRunner;</span><br><span class=\"line\">    <span class=\"meta\">@NonNull</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String, String&gt; mTestInstrumentationRunnerArguments = Maps.newHashMap();</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mTestHandleProfiling;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mTestFunctionalTest;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> SigningConfig mSigningConfig;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Set&lt;String&gt; mResourceConfiguration;</span><br><span class=\"line\">    <span class=\"meta\">@NonNull</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> DefaultVectorDrawablesOptions mVectorDrawablesOptions;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mWearAppUnbundled;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"重复配置处理\"><a href=\"#重复配置处理\" class=\"headerlink\" title=\"重复配置处理\"></a>重复配置处理</h3><p>当我们项目不止只有一个 app module 时，那么在其他 module 中，例如下面这些配置都需要去配置下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">defaultConfig &#123;</span><br><span class=\"line\">        minSdkVersion <span class=\"number\">21</span></span><br><span class=\"line\">        targetSdkVersion <span class=\"number\">27</span></span><br><span class=\"line\">        versionCode <span class=\"number\">1</span></span><br><span class=\"line\">        versionName <span class=\"string\">&quot;1.0&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        testInstrumentationRunner <span class=\"string\">&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>这样就显得很繁琐又不灵活，比如现在很多项目都开始进行组件化，有的 module 有时候是 <code>com.android.application</code>，有的时候又是  <code>com.android.library</code> 这样又得根据条件写两套配置，如果其中一个更改了，还得去挨个 module 中更改。</p>\n<p>而利用 Gradle 多项目构建，我们可以将这些重复配置都统一处理，还可以根据属性自动导入不同的 plugin。首先为了统一管理各种版本号，我们先新建一个 <em>constants.gradle</em> 将一些常量写入到 ext 中：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.ext &#123;</span><br><span class=\"line\">    compileSdkVersion = <span class=\"number\">27</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    minSdkVersion = <span class=\"number\">21</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    targetSdkVersion = <span class=\"number\">27</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    versionCode = <span class=\"number\">1</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    versionName = <span class=\"string\">&quot;1.0&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p> ext 实际上是 <a href=\"https://docs.gradle.org/current/dsl/org.gradle.api.plugins.ExtraPropertiesExtension.html\">ExtraPropertiesExtension</a> 类型，它类似 map，可以存储 key&#x2F;value 键值对。ext 也是扩展的一种，可以通过 <code>project.extensions.getByName(&#39;ext&#39;)</code> 获取实例，所有的 <a href=\"https://docs.gradle.org/current/dsl/org.gradle.api.plugins.ExtensionAware.html\"><code>ExtensionAware</code></a> 都拥有一个 <code>ext</code>，而 Project 又是继承于  <code>ExtensionAware</code></p>\n</blockquote>\n<p>接着我们在各个 module 中创建一个 <code>gradle.properties</code> ，这个文件默认会被读取，在其中定义一个属性 <code>isApplication</code>，根据这个属性导入不同的 plugin：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// library module</span></span><br><span class=\"line\">isApplication=<span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// application module</span></span><br><span class=\"line\">isApplication=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p>接着创建 <em>init.gradle</em>，在 <code>subprojects</code> 中配置，这里的配置对所有的子项目都会生效：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">subprojects &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (project.isApplication.toBoolean()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前 module 导入 application plugin</span></span><br><span class=\"line\">        project.plugins.apply(<span class=\"string\">&quot;com.android.application&quot;</span>)</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        project.plugins.apply(<span class=\"string\">&quot;com.android.library&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里有点地方需要注意下，因为属性的获取都是通过 String 类型，所以我们需要明确使用 <code>toBoolean()</code> 去转化成布尔值</p>\n</blockquote>\n<p>最后要想使得这些 gradle 文件生效，需要将它们 apply 进去，因为 Gradle 默认只会识别 <code>build.gradle</code>，还记得我们在 <a href=\"https://linxiaotao.github.io/2018/04/29/Gradle%E5%A4%9A%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/\">Gradle多项目构建</a> 中说到，<em>Gradle 是边读取边执行的</em> ，这意味着你需要在使用到 <code>android</code> 构建块之前，将 plugin apply 进去，所以我们将这些 gradle 文件在根目录的 <em>build.gradle</em> 中 apply，因为默认根目录的优先级最高：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// constants.gradle 需要在 init.gradle，因为 init.gradle 后面会使用到 constants.gradle 中定义的值，理由如上</span></span><br><span class=\"line\">apply <span class=\"attr\">from:</span> <span class=\"string\">&#x27;gradle/constants.gradle&#x27;</span></span><br><span class=\"line\">apply <span class=\"attr\">from:</span> <span class=\"string\">&#x27;gradle/init.gradle&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>我们将 module 下 <em>build.gradle</em> 中的 apply 代码删除，重新同步下，可以发现 <code>android</code> 配置块依然生效，这意味着，我们 apply plugin 操作成功了。</p>\n<p>在处理完 plugin 之后，我们可以将 <code>android</code> 配置块中的重复配置也在 <em>init.gradle</em> 中去配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">subprojects &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (project.isApplication.toBoolean()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前 module 导入 application plugin</span></span><br><span class=\"line\">        project.plugins.apply(<span class=\"string\">&quot;com.android.application&quot;</span>)</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        project.plugins.apply(<span class=\"string\">&quot;com.android.library&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    android &#123;</span><br><span class=\"line\">        compileSdkVersion rootProject.ext[<span class=\"string\">&#x27;compileSdkVersion&#x27;</span>]</span><br><span class=\"line\">        defaultConfig &#123;</span><br><span class=\"line\">            minSdkVersion rootProject.ext[<span class=\"string\">&#x27;minSdkVersion&#x27;</span>]</span><br><span class=\"line\">            targetSdkVersion rootProject.ext[<span class=\"string\">&#x27;targetSdkVersion&#x27;</span>]</span><br><span class=\"line\">            versionCode rootProject.ext[<span class=\"string\">&#x27;versionCode&#x27;</span>]</span><br><span class=\"line\">            versionName rootProject.ext[<span class=\"string\">&#x27;versionName&#x27;</span>]</span><br><span class=\"line\">            testInstrumentationRunner <span class=\"string\">&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        buildTypes &#123;</span><br><span class=\"line\">            release &#123;</span><br><span class=\"line\">                minifyEnabled <span class=\"literal\">false</span></span><br><span class=\"line\">                proguardFiles getDefaultProguardFile(<span class=\"string\">&#x27;proguard-android.txt&#x27;</span>), <span class=\"string\">&#x27;proguard-rules.pro&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>是不是非常方便，这样统一的配置你只需要写一次，不只是 <code>android</code> 配置块可以这么处理，其他的配置也可以这么处理。</p>\n<h3 id=\"依赖管理\"><a href=\"#依赖管理\" class=\"headerlink\" title=\"依赖管理\"></a>依赖管理</h3><p>一般情况下，我们会在各个 module 下去编写所需的依赖配置，比如通过 <code>implementation &#39;com.android.support:appcompat-v7:27.1.1&#39;</code> 去从 maven 中心仓库或者 jcenter 中下载依赖，但这样有个不好的地方就是依赖配置太分散了，只能到每个 module 目录中的 <em>build.gradle</em> 去管理，如果我们将这个写到统一的 Gradle 构建脚本中，是不是会更好点，我们同样创建个 <em>dependencies.gradle</em>，将共同的依赖写到 <code>subprojects</code> ，特有的依赖写到单独的项目配置中，同样这个文件需要在根目录的 <em>build.gradle</em> 中 apply：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">subprojects &#123;</span><br><span class=\"line\">    dependencies &#123;</span><br><span class=\"line\">        testImplementation rootProject.ext.dependencies[<span class=\"string\">&#x27;junit&#x27;</span>]</span><br><span class=\"line\">        androidTestImplementation rootProject.ext.dependencies[<span class=\"string\">&#x27;runner&#x27;</span>]</span><br><span class=\"line\">        androidTestImplementation rootProject.ext.dependencies[<span class=\"string\">&#x27;espresso-core&#x27;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">project(<span class=\"string\">&#x27;:mylibrary&#x27;</span>) &#123;</span><br><span class=\"line\">    dependencies &#123;</span><br><span class=\"line\">        api fileTree(<span class=\"attr\">dir:</span> <span class=\"string\">&#x27;libs&#x27;</span>, <span class=\"attr\">include:</span> [<span class=\"string\">&#x27;*.jar&#x27;</span>])</span><br><span class=\"line\">        api rootProject.ext.dependencies[<span class=\"string\">&#x27;appcompat-v7&#x27;</span>]</span><br><span class=\"line\">        api rootProject.ext.dependencies[<span class=\"string\">&#x27;constraint-layout&#x27;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">project(<span class=\"string\">&#x27;:app&#x27;</span>) &#123;</span><br><span class=\"line\">    dependencies &#123;</span><br><span class=\"line\">        implementation fileTree(<span class=\"attr\">dir:</span> <span class=\"string\">&#x27;libs&#x27;</span>, <span class=\"attr\">include:</span> [<span class=\"string\">&#x27;*.jar&#x27;</span>])</span><br><span class=\"line\">        implementation project(<span class=\"string\">&quot;:mylibrary&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>我们可以将共同的依赖写到 <code>subprojects</code> 块，单独项目的配置写到各自的配置块下。</p>\n<p>现在我们再来解决另外一个常见的问题：依赖冲突，比如不同的依赖项各自又依赖于同一个库的不同版本，默认 <a href=\"https://docs.gradle.org/current/userguide/troubleshooting_dependency_resolution.html#sub:version_conflicts\">Gradle 会用这个重复库的最高版本</a>，但如果你配置了 <code>resolutionStrategy.failOnVersionConflict()</code> 即当出现版本冲突则失败，或者版本选择不合适，等等，就会出现依赖冲突问题。</p>\n<p>我们通过个例子来证实默认的处理策略，我们在 app 模块中去依赖  <code>com.android.support:design:27.1.1</code> 和 <code>com.android.support:recyclerview-v7:26.1.0</code> ，而 <code>design</code> 会自动去依赖 <code>com.android.support:recyclerview-v7:27.1.1</code>，依赖关系我们可以通过 <code>./gradlew :app:dependencies</code> 这个 Task 去查看，这里我们只查看 <em>releaseCompileClasspath</em> 依赖配置中 <code>design</code> 和 <code>recyclerview</code> 的情况：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+--- project :mylibrary</span><br><span class=\"line\">|    \\--- com.android.support:design:27.1.1</span><br><span class=\"line\">|         +--- com.android.support:support-v4:27.1.1</span><br><span class=\"line\">|         |    +--- com.android.support:support-compat:27.1.1 (*)</span><br><span class=\"line\">|         |    +--- com.android.support:support-media-compat:27.1.1</span><br><span class=\"line\">|         |    |    +--- com.android.support:support-annotations:27.1.1</span><br><span class=\"line\">|         |    |    \\--- com.android.support:support-compat:27.1.1 (*)</span><br><span class=\"line\">|         |    +--- com.android.support:support-core-utils:27.1.1 (*)</span><br><span class=\"line\">|         |    +--- com.android.support:support-core-ui:27.1.1 (*)</span><br><span class=\"line\">|         |    \\--- com.android.support:support-fragment:27.1.1 (*)</span><br><span class=\"line\">|         +--- com.android.support:appcompat-v7:27.1.1 (*)</span><br><span class=\"line\">|         +--- com.android.support:recyclerview-v7:27.1.1</span><br><span class=\"line\">|         |    +--- com.android.support:support-annotations:27.1.1</span><br><span class=\"line\">|         |    +--- com.android.support:support-compat:27.1.1 (*)</span><br><span class=\"line\">|         |    \\--- com.android.support:support-core-ui:27.1.1 (*)</span><br><span class=\"line\">|         \\--- com.android.support:transition:27.1.1</span><br><span class=\"line\">|              +--- com.android.support:support-annotations:27.1.1</span><br><span class=\"line\">|              \\--- com.android.support:support-compat:27.1.1 (*)</span><br><span class=\"line\">\\--- com.android.support:recyclerview-v7:26.1.0 -&gt; 27.1.1 (*)</span><br></pre></td></tr></table></figure>\n\n<p>可以看到我们依赖的 26.1.0 已经被替换成 27.1.1，如果这是我们想要的结果，那就很理想，但是如果我们想要去定义依赖冲突的策略呢？同样的，Gradle 也提供了相应的 API。</p>\n<p>还是上面的例子，如果我们不想要使用 <code>design</code> 中的 <code>recyclerview</code> 而想要我们单独依赖的 <code>recyclerview-v7:26.1.1</code> 这里我们有几种方式解决：</p>\n<ol>\n<li><p>不传递依赖</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">api(rootProject.ext.dependencies[<span class=\"string\">&#x27;design&#x27;</span>]) &#123;</span><br><span class=\"line\">            transitive = <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>强制使用当前版本</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation(rootProject.ext.dependencies[<span class=\"string\">&#x27;recyclerview&#x27;</span>]) &#123;</span><br><span class=\"line\">            force = <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>其他的解决方案可以参考<a href=\"https://docs.gradle.org/current/userguide/introduction_dependency_management.html\">官方文档</a></p>\n<p>这里我们使用 Gradle 提供的 <a href=\"https://docs.gradle.org/current/userguide/customizing_dependency_resolution_behavior.html\">resolutionStrategy</a> 方案： </p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">subprojects &#123;</span><br><span class=\"line\">    configurations.all &#123;</span><br><span class=\"line\">        resolutionStrategy &#123;</span><br><span class=\"line\">            force rootProject.ext.dependencies[<span class=\"string\">&#x27;recyclerview&#x27;</span>]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>configurations</code> 表示当前项目的依赖配置容器，<code>configurations.all</code> 表示当前项目的所有依赖配置，上面的配置表示，遍历当前项目的所有依赖配置，设置其依赖解决策略为 <strong>强制使用指定的版本</strong></p>\n<h2 id=\"改造结束\"><a href=\"#改造结束\" class=\"headerlink\" title=\"改造结束\"></a>改造结束</h2><p>现在我们再来对比下，默认生成的构建配置和改造后的构建配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;com.android.application&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">android &#123;</span><br><span class=\"line\">    compileSdkVersion <span class=\"number\">27</span></span><br><span class=\"line\">    defaultConfig &#123;</span><br><span class=\"line\">        applicationId <span class=\"string\">&quot;com.example.leo.gradlecaseproject&quot;</span></span><br><span class=\"line\">        minSdkVersion <span class=\"number\">21</span></span><br><span class=\"line\">        targetSdkVersion <span class=\"number\">27</span></span><br><span class=\"line\">        versionCode <span class=\"number\">1</span></span><br><span class=\"line\">        versionName <span class=\"string\">&quot;1.0&quot;</span></span><br><span class=\"line\">        testInstrumentationRunner <span class=\"string\">&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    buildTypes &#123;</span><br><span class=\"line\">        release &#123;</span><br><span class=\"line\">            minifyEnabled <span class=\"literal\">false</span></span><br><span class=\"line\">            proguardFiles getDefaultProguardFile(<span class=\"string\">&#x27;proguard-android.txt&#x27;</span>), <span class=\"string\">&#x27;proguard-rules.pro&#x27;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">dependencies &#123;</span><br><span class=\"line\">    implementation fileTree(<span class=\"attr\">dir:</span> <span class=\"string\">&#x27;libs&#x27;</span>, <span class=\"attr\">include:</span> [<span class=\"string\">&#x27;*.jar&#x27;</span>])</span><br><span class=\"line\">    implementation <span class=\"string\">&#x27;com.android.support:appcompat-v7:27.1.1&#x27;</span></span><br><span class=\"line\">    implementation <span class=\"string\">&#x27;com.android.support.constraint:constraint-layout:1.1.0&#x27;</span></span><br><span class=\"line\">    testImplementation <span class=\"string\">&#x27;junit:junit:4.12&#x27;</span></span><br><span class=\"line\">    androidTestImplementation <span class=\"string\">&#x27;com.android.support.test:runner:1.0.2&#x27;</span></span><br><span class=\"line\">    androidTestImplementation <span class=\"string\">&#x27;com.android.support.test.espresso:espresso-core:3.0.2&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">android &#123;</span><br><span class=\"line\">    defaultConfig &#123;</span><br><span class=\"line\">        applicationId <span class=\"string\">&quot;com.example.leo.gradlecaseproject&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>是不是简洁了不少，重复的配置项我们交给统一的配置文件去做，依赖配置也是如此，包括依赖冲突的解决策略，但是 Gradle 能实现的不仅仅如此，还有强大的自定义 Gradle Plugin 我们还没讲到。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过这篇文章，不仅仅是教会大家如何去编写简单的 Gradle 构建脚本，更重要的想让大家对 Gradle 有个初步的认识，知道 Gradle 的配置块是如何生成的，更多知识可以通过<a href=\"https://docs.gradle.org/current/userguide/userguide.html\">官方文档</a>去获取。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>上篇文章中，我们说到了 <a href=\"https://linxiaotao.github.io/2018/04/29/Gradle%E5%A4%9A%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/\">Gradle多项目构建</a> 的一些知识点，但这些总归只是纸上谈兵，今天我们在实际项目中通过之前学到的知识去改造下项目的 Gradle 构建脚本，充分利用 Gradle 带来的好处。</p>\n<p>虽然使用 Gradle 作为构建工具已经有一段时间了，但很多同学对它还是很陌生的，基本都是沿用 Android Studio 默认生成的配置，用的比较多的可能也只是 <code>dependencies</code> 配置，从不同的 <code>repositories</code> 去下载依赖，可能在需要实现一些自定义配置的时候，就去 google 后照搬代码，对其配置参数也是似懂非懂，出了问题不知道如何下手解决，所以这篇文章的主要目的是，实践 Gradle 在 Android 上的运用，对 Gradle 的使用有基本认识。</p>\n<p><a href=\"https://github.com/LinXiaoTao/GradleCaseProject\">项目源码</a></p>\n<h2 id=\"改造开始\"><a href=\"#改造开始\" class=\"headerlink\" title=\"改造开始\"></a>改造开始</h2><h3 id=\"Gradle-知识\"><a href=\"#Gradle-知识\" class=\"headerlink\" title=\"Gradle 知识\"></a>Gradle 知识</h3><p>我们先看下 Android Studio 默认帮我们生成的配置代码：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;com.android.application&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">android &#123;</span><br><span class=\"line\">    <span class=\"comment\">// android 构建配置</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">dependencies &#123;</span><br><span class=\"line\"> \t<span class=\"comment\">// 依赖配置</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>先简单讲下上面各部分的配置含义，首先我们知道如果不先 <code>apply plugin: &#39;com.android.application&#39;</code> 就不会有 <code>android</code> 配置选项，那么这个配置选项具体是什么内容呢？我们可以通过源码了解下，<code>com.android.application</code> 这个插件就是我们在根目录下的 <em>build.gradle</em> 中导入的：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">buildscript &#123;</span><br><span class=\"line\">    repositories &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 构建脚本依赖源地址</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    dependencies &#123;</span><br><span class=\"line\">        classpath <span class=\"string\">&#x27;com.android.tools.build:gradle:3.1.2&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>对 Gradle Plugin 有点了解的同学都知道，Gradle Plugin 需要定义到 <em>META-INF</em> 中，浏览 <em>gradle-3.1.2.jar</em>，<em>META-INF</em> 目录如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── MANIFEST.MF</span><br><span class=\"line\">├── gradle-plugins</span><br><span class=\"line\">│   ├── android-library.properties</span><br><span class=\"line\">│   ├── android-reporting.properties</span><br><span class=\"line\">│   ├── android.properties</span><br><span class=\"line\">│   ├── com.android.application.properties</span><br><span class=\"line\">│   ├── com.android.atom.properties</span><br><span class=\"line\">│   ├── com.android.bundle.properties</span><br><span class=\"line\">│   ├── com.android.debug.structure.properties</span><br><span class=\"line\">│   ├── com.android.feature.properties</span><br><span class=\"line\">│   ├── com.android.instantapp.properties</span><br><span class=\"line\">│   ├── com.android.library.properties</span><br><span class=\"line\">│   ├── com.android.lint.properties</span><br><span class=\"line\">│   └── com.android.test.properties</span><br></pre></td></tr></table></figure>\n\n<p>这里对应的是提供的各个插件的配置，比如 <em>com.android.application.properties</em> 就表示 <code>com.android.application</code> 插件，其他也是一样，properties 的名称表示插件的名称。<em>com.android.application.properties</em> 的内容如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation-class=com.android.build.gradle.AppPlugin</span><br></pre></td></tr></table></figure>\n\n<p><code>com.android.build.gradle.AppPlugin</code> 这个类就是 Application Plugin 的源码。阅读 AppPlugin 源码，我们可以看到这一段：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@NonNull</span></span><br><span class=\"line\">   <span class=\"meta\">@Override</span></span><br><span class=\"line\">   <span class=\"keyword\">protected</span> BaseExtension createExtension(</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> Project project,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> ProjectOptions projectOptions,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> AndroidBuilder androidBuilder,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> SdkHandler sdkHandler,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> NamedDomainObjectContainer&lt;BuildType&gt; buildTypeContainer,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> NamedDomainObjectContainer&lt;ProductFlavor&gt; productFlavorContainer,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> NamedDomainObjectContainer&lt;SigningConfig&gt; signingConfigContainer,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> NamedDomainObjectContainer&lt;BaseVariantOutput&gt; buildOutputs,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> SourceSetManager sourceSetManager,</span><br><span class=\"line\">           <span class=\"meta\">@NonNull</span> ExtraModelInfo extraModelInfo) &#123;</span><br><span class=\"line\">       <span class=\"keyword\">return</span> project.getExtensions()</span><br><span class=\"line\">               .create(</span><br><span class=\"line\">                       <span class=\"string\">&quot;android&quot;</span>,</span><br><span class=\"line\">                       AppExtension.<span class=\"keyword\">class</span>,</span><br><span class=\"line\">                       project,</span><br><span class=\"line\">                       projectOptions,</span><br><span class=\"line\">                       androidBuilder,</span><br><span class=\"line\">                       sdkHandler,</span><br><span class=\"line\">                       buildTypeContainer,</span><br><span class=\"line\">                       productFlavorContainer,</span><br><span class=\"line\">                       signingConfigContainer,</span><br><span class=\"line\">                       buildOutputs,</span><br><span class=\"line\">                       sourceSetManager,</span><br><span class=\"line\">                       extraModelInfo);</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先我们先通过 API 文档了解下 <a href=\"https://docs.gradle.org/current/dsl/org.gradle.api.Project.html\">project.extensions</a> 的定义：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">定义：</span><br><span class=\"line\">\tExtensionContainer extensions (read-only)</span><br><span class=\"line\">说明：</span><br><span class=\"line\">\tAllows adding DSL extensions to the project. Useful for plugin authors.</span><br><span class=\"line\">\t允许向项目添加 DSL 扩展，对插件作者很有用</span><br></pre></td></tr></table></figure>\n\n<p>接着我们看下 <a href=\"https://docs.gradle.org/current/javadoc/org/gradle/api/plugins/ExtensionContainer.html#create-java.lang.String-java.lang.Class-java.lang.Object...-\"><code>ExtensionContainer.create</code></a> 方法的定义：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">定义：</span><br><span class=\"line\">\t&lt;T&gt; T create(String name,Class&lt;T&gt; type,Object... constructionArguments)</span><br><span class=\"line\">说明：</span><br><span class=\"line\">\tCreates and adds a new extension to this container. A new instance of the given type will be created using the given constructionArguments. The extension will be exposed as type unless the extension itself declares a preferred public type via the HasPublicType protocol. The new instance will have been dynamically made ExtensionAware, which means that you can cast it to ExtensionAware.</span><br><span class=\"line\">\t向项目创建并且添加一个新的扩展。通过给定的 type 创建一个新的实例，使用给定的 constructionArguments 构造函数参数。可以通过 HasPublicType 接口声明对外开放的类型，否则整个扩展将对外开放。新的实例将动态生成为 </span><br><span class=\"line\">ExtensionAware，这意味着你可以将它转换成 ExtensionAware</span><br></pre></td></tr></table></figure>\n\n<p>现在我们可以知道，为什么在引入 <code>com.android.application</code> 之后才能使用 <code>android</code> 配置块，这也意味着，<code>android</code> 所能提供的配置依赖于 <code>AppExtension</code> 这个类。</p>\n<p>这里我们简单就 <code>defaultConfig</code> 这个做下分析，先看下这个类在 <code>AppExtension</code> 中的配置，因为 <code>AppExtension</code> 直接调用超类 <code>TestedExtension</code> 的构造方法，而 <code>TestedExtension</code> 又会调用超类 <code>BaseExtension</code> 所以我们直接看到 <code>BaseExtension</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> DefaultConfig defaultConfig;</span><br><span class=\"line\"></span><br><span class=\"line\">defaultConfig = objectFactory.newInstance(</span><br><span class=\"line\">                        DefaultConfig.class,</span><br><span class=\"line\">                        BuilderConstants.MAIN,</span><br><span class=\"line\">                        project,</span><br><span class=\"line\">                        objectFactory,</span><br><span class=\"line\">                        extraModelInfo.getDeprecationReporter(),</span><br><span class=\"line\">                        project.getLogger());</span><br></pre></td></tr></table></figure>\n\n<p>这里我们先不关心 <code>objectFactory.newInstance</code> 只需要知道，当我们在 <code>android</code> 配置块中，配置 <code>defaultConfig</code> 实质上也是，对 <code>DefaultConfig</code> 的配置，而 <code>DefaultConfig</code> 又继承于 <code>DefaultProductFlavor</code>，相关的配置同时也是 <code>DefaultProductFlavor</code> 的成员属性：</p>\n<blockquote>\n<p>DefaultProductFlavor 位于 <code>builder-3.1.2.jar</code></p>\n<p>Android Gradle Plugin 相关代码分别位于 <code>gradle-3.1.2.jar</code>、<code>gradle-api-3.1.2.jar</code>、<code>gradle-core-3.1.2.jar</code></p>\n<p>如果想查看源码，则下载 sources 包，比如 <a href=\"https://dl.google.com/dl/android/maven2/com/android/tools/build/builder/3.1.2/builder-3.1.2-sources.jar\">builder-3.1.2-sources.jar</a>，其他 jar 下载方法类似</p>\n<p>心好累，各种继承。。。</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DefaultProductFlavor</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">BaseConfigImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">ProductFlavor</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">1L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@NonNull</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String mName;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String mDimension;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ApiVersion mMinSdkVersion;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ApiVersion mTargetSdkVersion;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer mMaxSdkVersion;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer mRenderscriptTargetApi;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mRenderscriptSupportModeEnabled;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mRenderscriptSupportModeBlasEnabled;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mRenderscriptNdkModeEnabled;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer mVersionCode;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String mVersionName;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String mApplicationId;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String mTestApplicationId;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String mTestInstrumentationRunner;</span><br><span class=\"line\">    <span class=\"meta\">@NonNull</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String, String&gt; mTestInstrumentationRunnerArguments = Maps.newHashMap();</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mTestHandleProfiling;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mTestFunctionalTest;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> SigningConfig mSigningConfig;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Set&lt;String&gt; mResourceConfiguration;</span><br><span class=\"line\">    <span class=\"meta\">@NonNull</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> DefaultVectorDrawablesOptions mVectorDrawablesOptions;</span><br><span class=\"line\">    <span class=\"meta\">@Nullable</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Boolean mWearAppUnbundled;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"重复配置处理\"><a href=\"#重复配置处理\" class=\"headerlink\" title=\"重复配置处理\"></a>重复配置处理</h3><p>当我们项目不止只有一个 app module 时，那么在其他 module 中，例如下面这些配置都需要去配置下：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">defaultConfig &#123;</span><br><span class=\"line\">        minSdkVersion <span class=\"number\">21</span></span><br><span class=\"line\">        targetSdkVersion <span class=\"number\">27</span></span><br><span class=\"line\">        versionCode <span class=\"number\">1</span></span><br><span class=\"line\">        versionName <span class=\"string\">&quot;1.0&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        testInstrumentationRunner <span class=\"string\">&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>这样就显得很繁琐又不灵活，比如现在很多项目都开始进行组件化，有的 module 有时候是 <code>com.android.application</code>，有的时候又是  <code>com.android.library</code> 这样又得根据条件写两套配置，如果其中一个更改了，还得去挨个 module 中更改。</p>\n<p>而利用 Gradle 多项目构建，我们可以将这些重复配置都统一处理，还可以根据属性自动导入不同的 plugin。首先为了统一管理各种版本号，我们先新建一个 <em>constants.gradle</em> 将一些常量写入到 ext 中：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.ext &#123;</span><br><span class=\"line\">    compileSdkVersion = <span class=\"number\">27</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    minSdkVersion = <span class=\"number\">21</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    targetSdkVersion = <span class=\"number\">27</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    versionCode = <span class=\"number\">1</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    versionName = <span class=\"string\">&quot;1.0&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p> ext 实际上是 <a href=\"https://docs.gradle.org/current/dsl/org.gradle.api.plugins.ExtraPropertiesExtension.html\">ExtraPropertiesExtension</a> 类型，它类似 map，可以存储 key&#x2F;value 键值对。ext 也是扩展的一种，可以通过 <code>project.extensions.getByName(&#39;ext&#39;)</code> 获取实例，所有的 <a href=\"https://docs.gradle.org/current/dsl/org.gradle.api.plugins.ExtensionAware.html\"><code>ExtensionAware</code></a> 都拥有一个 <code>ext</code>，而 Project 又是继承于  <code>ExtensionAware</code></p>\n</blockquote>\n<p>接着我们在各个 module 中创建一个 <code>gradle.properties</code> ，这个文件默认会被读取，在其中定义一个属性 <code>isApplication</code>，根据这个属性导入不同的 plugin：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// library module</span></span><br><span class=\"line\">isApplication=<span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// application module</span></span><br><span class=\"line\">isApplication=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p>接着创建 <em>init.gradle</em>，在 <code>subprojects</code> 中配置，这里的配置对所有的子项目都会生效：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">subprojects &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (project.isApplication.toBoolean()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前 module 导入 application plugin</span></span><br><span class=\"line\">        project.plugins.apply(<span class=\"string\">&quot;com.android.application&quot;</span>)</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        project.plugins.apply(<span class=\"string\">&quot;com.android.library&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里有点地方需要注意下，因为属性的获取都是通过 String 类型，所以我们需要明确使用 <code>toBoolean()</code> 去转化成布尔值</p>\n</blockquote>\n<p>最后要想使得这些 gradle 文件生效，需要将它们 apply 进去，因为 Gradle 默认只会识别 <code>build.gradle</code>，还记得我们在 <a href=\"https://linxiaotao.github.io/2018/04/29/Gradle%E5%A4%9A%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/\">Gradle多项目构建</a> 中说到，<em>Gradle 是边读取边执行的</em> ，这意味着你需要在使用到 <code>android</code> 构建块之前，将 plugin apply 进去，所以我们将这些 gradle 文件在根目录的 <em>build.gradle</em> 中 apply，因为默认根目录的优先级最高：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// constants.gradle 需要在 init.gradle，因为 init.gradle 后面会使用到 constants.gradle 中定义的值，理由如上</span></span><br><span class=\"line\">apply <span class=\"attr\">from:</span> <span class=\"string\">&#x27;gradle/constants.gradle&#x27;</span></span><br><span class=\"line\">apply <span class=\"attr\">from:</span> <span class=\"string\">&#x27;gradle/init.gradle&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>我们将 module 下 <em>build.gradle</em> 中的 apply 代码删除，重新同步下，可以发现 <code>android</code> 配置块依然生效，这意味着，我们 apply plugin 操作成功了。</p>\n<p>在处理完 plugin 之后，我们可以将 <code>android</code> 配置块中的重复配置也在 <em>init.gradle</em> 中去配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">subprojects &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (project.isApplication.toBoolean()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前 module 导入 application plugin</span></span><br><span class=\"line\">        project.plugins.apply(<span class=\"string\">&quot;com.android.application&quot;</span>)</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        project.plugins.apply(<span class=\"string\">&quot;com.android.library&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    android &#123;</span><br><span class=\"line\">        compileSdkVersion rootProject.ext[<span class=\"string\">&#x27;compileSdkVersion&#x27;</span>]</span><br><span class=\"line\">        defaultConfig &#123;</span><br><span class=\"line\">            minSdkVersion rootProject.ext[<span class=\"string\">&#x27;minSdkVersion&#x27;</span>]</span><br><span class=\"line\">            targetSdkVersion rootProject.ext[<span class=\"string\">&#x27;targetSdkVersion&#x27;</span>]</span><br><span class=\"line\">            versionCode rootProject.ext[<span class=\"string\">&#x27;versionCode&#x27;</span>]</span><br><span class=\"line\">            versionName rootProject.ext[<span class=\"string\">&#x27;versionName&#x27;</span>]</span><br><span class=\"line\">            testInstrumentationRunner <span class=\"string\">&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        buildTypes &#123;</span><br><span class=\"line\">            release &#123;</span><br><span class=\"line\">                minifyEnabled <span class=\"literal\">false</span></span><br><span class=\"line\">                proguardFiles getDefaultProguardFile(<span class=\"string\">&#x27;proguard-android.txt&#x27;</span>), <span class=\"string\">&#x27;proguard-rules.pro&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>是不是非常方便，这样统一的配置你只需要写一次，不只是 <code>android</code> 配置块可以这么处理，其他的配置也可以这么处理。</p>\n<h3 id=\"依赖管理\"><a href=\"#依赖管理\" class=\"headerlink\" title=\"依赖管理\"></a>依赖管理</h3><p>一般情况下，我们会在各个 module 下去编写所需的依赖配置，比如通过 <code>implementation &#39;com.android.support:appcompat-v7:27.1.1&#39;</code> 去从 maven 中心仓库或者 jcenter 中下载依赖，但这样有个不好的地方就是依赖配置太分散了，只能到每个 module 目录中的 <em>build.gradle</em> 去管理，如果我们将这个写到统一的 Gradle 构建脚本中，是不是会更好点，我们同样创建个 <em>dependencies.gradle</em>，将共同的依赖写到 <code>subprojects</code> ，特有的依赖写到单独的项目配置中，同样这个文件需要在根目录的 <em>build.gradle</em> 中 apply：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">subprojects &#123;</span><br><span class=\"line\">    dependencies &#123;</span><br><span class=\"line\">        testImplementation rootProject.ext.dependencies[<span class=\"string\">&#x27;junit&#x27;</span>]</span><br><span class=\"line\">        androidTestImplementation rootProject.ext.dependencies[<span class=\"string\">&#x27;runner&#x27;</span>]</span><br><span class=\"line\">        androidTestImplementation rootProject.ext.dependencies[<span class=\"string\">&#x27;espresso-core&#x27;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">project(<span class=\"string\">&#x27;:mylibrary&#x27;</span>) &#123;</span><br><span class=\"line\">    dependencies &#123;</span><br><span class=\"line\">        api fileTree(<span class=\"attr\">dir:</span> <span class=\"string\">&#x27;libs&#x27;</span>, <span class=\"attr\">include:</span> [<span class=\"string\">&#x27;*.jar&#x27;</span>])</span><br><span class=\"line\">        api rootProject.ext.dependencies[<span class=\"string\">&#x27;appcompat-v7&#x27;</span>]</span><br><span class=\"line\">        api rootProject.ext.dependencies[<span class=\"string\">&#x27;constraint-layout&#x27;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">project(<span class=\"string\">&#x27;:app&#x27;</span>) &#123;</span><br><span class=\"line\">    dependencies &#123;</span><br><span class=\"line\">        implementation fileTree(<span class=\"attr\">dir:</span> <span class=\"string\">&#x27;libs&#x27;</span>, <span class=\"attr\">include:</span> [<span class=\"string\">&#x27;*.jar&#x27;</span>])</span><br><span class=\"line\">        implementation project(<span class=\"string\">&quot;:mylibrary&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>我们可以将共同的依赖写到 <code>subprojects</code> 块，单独项目的配置写到各自的配置块下。</p>\n<p>现在我们再来解决另外一个常见的问题：依赖冲突，比如不同的依赖项各自又依赖于同一个库的不同版本，默认 <a href=\"https://docs.gradle.org/current/userguide/troubleshooting_dependency_resolution.html#sub:version_conflicts\">Gradle 会用这个重复库的最高版本</a>，但如果你配置了 <code>resolutionStrategy.failOnVersionConflict()</code> 即当出现版本冲突则失败，或者版本选择不合适，等等，就会出现依赖冲突问题。</p>\n<p>我们通过个例子来证实默认的处理策略，我们在 app 模块中去依赖  <code>com.android.support:design:27.1.1</code> 和 <code>com.android.support:recyclerview-v7:26.1.0</code> ，而 <code>design</code> 会自动去依赖 <code>com.android.support:recyclerview-v7:27.1.1</code>，依赖关系我们可以通过 <code>./gradlew :app:dependencies</code> 这个 Task 去查看，这里我们只查看 <em>releaseCompileClasspath</em> 依赖配置中 <code>design</code> 和 <code>recyclerview</code> 的情况：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+--- project :mylibrary</span><br><span class=\"line\">|    \\--- com.android.support:design:27.1.1</span><br><span class=\"line\">|         +--- com.android.support:support-v4:27.1.1</span><br><span class=\"line\">|         |    +--- com.android.support:support-compat:27.1.1 (*)</span><br><span class=\"line\">|         |    +--- com.android.support:support-media-compat:27.1.1</span><br><span class=\"line\">|         |    |    +--- com.android.support:support-annotations:27.1.1</span><br><span class=\"line\">|         |    |    \\--- com.android.support:support-compat:27.1.1 (*)</span><br><span class=\"line\">|         |    +--- com.android.support:support-core-utils:27.1.1 (*)</span><br><span class=\"line\">|         |    +--- com.android.support:support-core-ui:27.1.1 (*)</span><br><span class=\"line\">|         |    \\--- com.android.support:support-fragment:27.1.1 (*)</span><br><span class=\"line\">|         +--- com.android.support:appcompat-v7:27.1.1 (*)</span><br><span class=\"line\">|         +--- com.android.support:recyclerview-v7:27.1.1</span><br><span class=\"line\">|         |    +--- com.android.support:support-annotations:27.1.1</span><br><span class=\"line\">|         |    +--- com.android.support:support-compat:27.1.1 (*)</span><br><span class=\"line\">|         |    \\--- com.android.support:support-core-ui:27.1.1 (*)</span><br><span class=\"line\">|         \\--- com.android.support:transition:27.1.1</span><br><span class=\"line\">|              +--- com.android.support:support-annotations:27.1.1</span><br><span class=\"line\">|              \\--- com.android.support:support-compat:27.1.1 (*)</span><br><span class=\"line\">\\--- com.android.support:recyclerview-v7:26.1.0 -&gt; 27.1.1 (*)</span><br></pre></td></tr></table></figure>\n\n<p>可以看到我们依赖的 26.1.0 已经被替换成 27.1.1，如果这是我们想要的结果，那就很理想，但是如果我们想要去定义依赖冲突的策略呢？同样的，Gradle 也提供了相应的 API。</p>\n<p>还是上面的例子，如果我们不想要使用 <code>design</code> 中的 <code>recyclerview</code> 而想要我们单独依赖的 <code>recyclerview-v7:26.1.1</code> 这里我们有几种方式解决：</p>\n<ol>\n<li><p>不传递依赖</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">api(rootProject.ext.dependencies[<span class=\"string\">&#x27;design&#x27;</span>]) &#123;</span><br><span class=\"line\">            transitive = <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>强制使用当前版本</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation(rootProject.ext.dependencies[<span class=\"string\">&#x27;recyclerview&#x27;</span>]) &#123;</span><br><span class=\"line\">            force = <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>其他的解决方案可以参考<a href=\"https://docs.gradle.org/current/userguide/introduction_dependency_management.html\">官方文档</a></p>\n<p>这里我们使用 Gradle 提供的 <a href=\"https://docs.gradle.org/current/userguide/customizing_dependency_resolution_behavior.html\">resolutionStrategy</a> 方案： </p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">subprojects &#123;</span><br><span class=\"line\">    configurations.all &#123;</span><br><span class=\"line\">        resolutionStrategy &#123;</span><br><span class=\"line\">            force rootProject.ext.dependencies[<span class=\"string\">&#x27;recyclerview&#x27;</span>]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>configurations</code> 表示当前项目的依赖配置容器，<code>configurations.all</code> 表示当前项目的所有依赖配置，上面的配置表示，遍历当前项目的所有依赖配置，设置其依赖解决策略为 <strong>强制使用指定的版本</strong></p>\n<h2 id=\"改造结束\"><a href=\"#改造结束\" class=\"headerlink\" title=\"改造结束\"></a>改造结束</h2><p>现在我们再来对比下，默认生成的构建配置和改造后的构建配置：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;com.android.application&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">android &#123;</span><br><span class=\"line\">    compileSdkVersion <span class=\"number\">27</span></span><br><span class=\"line\">    defaultConfig &#123;</span><br><span class=\"line\">        applicationId <span class=\"string\">&quot;com.example.leo.gradlecaseproject&quot;</span></span><br><span class=\"line\">        minSdkVersion <span class=\"number\">21</span></span><br><span class=\"line\">        targetSdkVersion <span class=\"number\">27</span></span><br><span class=\"line\">        versionCode <span class=\"number\">1</span></span><br><span class=\"line\">        versionName <span class=\"string\">&quot;1.0&quot;</span></span><br><span class=\"line\">        testInstrumentationRunner <span class=\"string\">&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    buildTypes &#123;</span><br><span class=\"line\">        release &#123;</span><br><span class=\"line\">            minifyEnabled <span class=\"literal\">false</span></span><br><span class=\"line\">            proguardFiles getDefaultProguardFile(<span class=\"string\">&#x27;proguard-android.txt&#x27;</span>), <span class=\"string\">&#x27;proguard-rules.pro&#x27;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">dependencies &#123;</span><br><span class=\"line\">    implementation fileTree(<span class=\"attr\">dir:</span> <span class=\"string\">&#x27;libs&#x27;</span>, <span class=\"attr\">include:</span> [<span class=\"string\">&#x27;*.jar&#x27;</span>])</span><br><span class=\"line\">    implementation <span class=\"string\">&#x27;com.android.support:appcompat-v7:27.1.1&#x27;</span></span><br><span class=\"line\">    implementation <span class=\"string\">&#x27;com.android.support.constraint:constraint-layout:1.1.0&#x27;</span></span><br><span class=\"line\">    testImplementation <span class=\"string\">&#x27;junit:junit:4.12&#x27;</span></span><br><span class=\"line\">    androidTestImplementation <span class=\"string\">&#x27;com.android.support.test:runner:1.0.2&#x27;</span></span><br><span class=\"line\">    androidTestImplementation <span class=\"string\">&#x27;com.android.support.test.espresso:espresso-core:3.0.2&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">android &#123;</span><br><span class=\"line\">    defaultConfig &#123;</span><br><span class=\"line\">        applicationId <span class=\"string\">&quot;com.example.leo.gradlecaseproject&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>是不是简洁了不少，重复的配置项我们交给统一的配置文件去做，依赖配置也是如此，包括依赖冲突的解决策略，但是 Gradle 能实现的不仅仅如此，还有强大的自定义 Gradle Plugin 我们还没讲到。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过这篇文章，不仅仅是教会大家如何去编写简单的 Gradle 构建脚本，更重要的想让大家对 Gradle 有个初步的认识，知道 Gradle 的配置块是如何生成的，更多知识可以通过<a href=\"https://docs.gradle.org/current/userguide/userguide.html\">官方文档</a>去获取。</p>\n"},{"title":"HashMap源码分析","date":"2018-11-07T03:39:06.000Z","_content":"\n### 构造方法\n\n从构造方法来看，我们可以指定初始化容量（initialCapacity）和负载因子（loadFactor），其中 loadFactor 的默认值为 0.75，如果指定了 initialCapacity，就会计算容量阙值（threshold）：\n\n``` java\n// tableSizeFor 会计算一个大于或等于 initialCapacity 的 2 的 N 次方的值\nthis.threshold = tableSizeFor(initialCapacity);\n\nstatic final int tableSizeFor(int cap) {                                     \n    int n = cap - 1;                                                         \n    n |= n >>> 1;                                                            \n    n |= n >>> 2;                                                            \n    n |= n >>> 4;                                                            \n    n |= n >>> 8;                                                            \n    n |= n >>> 16;                                                           \n    return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1; \n}                                                                            \n```\n\n> initialCapacity 只会在构造函数中用到，用于计算 threshold\n\n### put 操作\n\n当调用 `put(key,value)` 的时候：\n\n``` java\npublic V put(K key, V value) {\n    return putVal(hash(key), key, value, false, true);\n}\n\nstatic final int hash(Object key) {\n    int h;\n    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);\n}\n```\n\n首先会根据 key 调用 `hash()` 计算哈希值，可以看到 `hash()` 中我们不仅使用 `key.hashCode()` 还将哈希值无符号右移 16 位再做一次异或操作\n\n> 在 HashMap 中，容量（capacity）是 2 的 N 次方，所以在**取余**的时候，可以用 `key & (capacity - 1)` 来代替，当 capacity 较小时，参与计算的位也比较少，比如，使用默认初始化容量 1<<4（即 16），那么计算下标：`key & (0x1111)` 参与计算的位只有 4 位，发生碰撞的概率也比较大\n\n``` java\nfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent,                  \n               boolean evict) {                                                 \n    Node<K,V>[] tab; Node<K,V> p; int n, i;                                     \n    if ((tab = table) == null || (n = tab.length) == 0) // 当 table 为空时候，需要调用 resize()                         \n        n = (tab = resize()).length;                                            \n    if ((p = tab[i = (n - 1) & hash]) == null)  // 如果当前对应 Node 为空，直接添加新的 Node 即可                                  \n        tab[i] = newNode(hash, key, value, null);                               \n    else {                                                                      \n        Node<K,V> e; K k;                                                       \n        if (p.hash == hash &&                                                   \n            ((k = p.key) == key || (key != null && key.equals(k))))  // 如果 Head Node 为结果           \n            e = p;                                                              \n        else if (p instanceof TreeNode)    // 如果是红黑树                                     \n            e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);     \n        else {\n            // 遍历链表\n            for (int binCount = 0; ; ++binCount) {                              \n                if ((e = p.next) == null) {\n                    // 如果没有找到匹配的 Node，添加一个新的 Node\n                    p.next = newNode(hash, key, value, null);                   \n                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st \n                        // 转换为红黑树\n                        treeifyBin(tab, hash);                                  \n                    break;                                                      \n                }                                                               \n                if (e.hash == hash &&                                           \n                    ((k = e.key) == key || (key != null && key.equals(k)))) // 找到已存在的 Node    \n                    break;                                                      \n                p = e;                                                          \n            }                                                                   \n        }                                                                       \n        if (e != null) { // existing mapping for key\n            // key 对应的 Node 已存在\n            V oldValue = e.value;                                               \n            if (!onlyIfAbsent || oldValue == null)                              \n                e.value = value;                                                \n            afterNodeAccess(e);                                                 \n            return oldValue;                                                    \n        }                                                                       \n    }\n    // 添加新的 Node，modCount 改变\n    ++modCount;                                                                 \n    if (++size > threshold) // size 大于阙值，需要扩容                                                     \n        resize();                                                               \n    afterNodeInsertion(evict);                                                  \n    return null;                                                                \n}                                                                               \n```\n\n如果 table 为空的时候，会先调用 `resize()` 来做初始化\n\n``` java\nfinal Node<K,V>[] resize() {                                                    \n    Node<K,V>[] oldTab = table;                                                 \n    int oldCap = (oldTab == null) ? 0 : oldTab.length;                          \n    int oldThr = threshold;                                                     \n    int newCap, newThr = 0;                                                     \n    if (oldCap > 0) {\n        // 如果为扩容操作\n        if (oldCap >= MAXIMUM_CAPACITY) {                                       \n            threshold = Integer.MAX_VALUE;                                      \n            return oldTab;                                                      \n        }\n        else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY &&                   \n                 oldCap >= DEFAULT_INITIAL_CAPACITY)\n            // capacity 左移一位，双倍\n            // 调用 resize 初始化的时候，会将 capacity 设置为默认值 16\n            newThr = oldThr << 1; // double threshold                           \n    }                                                                           \n    else if (oldThr > 0) // initial capacity was placed in threshold\n        // 当使用指定 capacity 的构造方法时，会使用 tableSizeFor 初始化 threshold，2 的 N 次方\n        newCap = oldThr;                                                        \n    else {               // zero initial threshold signifies using defaults\n        // 初始化\n        newCap = DEFAULT_INITIAL_CAPACITY;                                      \n        newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);         \n    }                                                                           \n    if (newThr == 0) {\n        // 计算 threshold = capacity * loadFactor\n        float ft = (float)newCap * loadFactor;                                  \n        newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?   \n                  (int)ft : Integer.MAX_VALUE);                                 \n    }                                                                           \n    threshold = newThr;                                                         \n    @SuppressWarnings({\"rawtypes\",\"unchecked\"})\n    // 创建新的 table\n        Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];                     \n    table = newTab;                                                             \n    if (oldTab != null) {\n        // 拷贝旧的 table\n        for (int j = 0; j < oldCap; ++j) {                                      \n            Node<K,V> e;                                                        \n            if ((e = oldTab[j]) != null) {                                      \n                oldTab[j] = null;                                               \n                if (e.next == null) // 如果只有一个 Node                                             \n                    newTab[e.hash & (newCap - 1)] = e;                          \n                else if (e instanceof TreeNode)  // 如果为红黑树                               \n                    ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);          \n                else { // preserve order  保持顺序\n                    // 旧下标的链表\n                    Node<K,V> loHead = null, loTail = null;                     \n                    // 新下标（oldIndex + oldCapacity）的链表\n                    Node<K,V> hiHead = null, hiTail = null;                     \n                    Node<K,V> next;                                             \n                    do {                                                        \n                        next = e.next;                                          \n                        if ((e.hash & oldCap) == 0) {                           \n                            if (loTail == null)                                 \n                                loHead = e;                                     \n                            else                                                \n                                loTail.next = e;                                \n                            loTail = e;                                         \n                        }                                                       \n                        else {                                                  \n                            if (hiTail == null)                                 \n                                hiHead = e;                                     \n                            else                                                \n                                hiTail.next = e;                                \n                            hiTail = e;                                         \n                        }                                                       \n                    } while ((e = next) != null);                               \n                    if (loTail != null) {                                       \n                        loTail.next = null;                                     \n                        newTab[j] = loHead;                                     \n                    }                                                           \n                    if (hiTail != null) {                                       \n                        hiTail.next = null;                                     \n                        newTab[j + oldCap] = hiHead;                            \n                    }                                                           \n                }                                                               \n            }                                                                   \n        }                                                                       \n    }                                                                           \n    return newTab;                                                              \n}                                                                               \n```\n\n`resize()` 时如果需要扩容，会发生 table 拷贝，如果 Head Node 存储数据结构为链表时，会保持原来链表的顺序，同时使用两个新的链表去保存，一个链表为旧下标位置，一个链表为 旧下标+旧容量 位置\n\n> 新下标要么为旧值，要么为旧值 + 旧容量，根据 (hash & oldCap == 0)，如果为 1，表示旧值+ 旧容量，因为容量为 2 的 N 次方，当 hash(key) 中和 capacity 的最高 1 位相对应的位为 1，则新容量时这个位会更新为 1，即添加 oldCap\n>\n> 举个例子：hash(key) = 17 即 0x10001，容量为 16，下标为 `hash(key) & (cap - 1) = 1` ，扩容后，新容量为 32，下标为 `hash(key) & (cap - 1) = 17`\n\n在查找是否存在 key 对应的值时，先判断引用是否相等，否则，如果 key 不为 null，则调用 `equals()` 去比较 \n\n```java\n((k = p.key) == key || (key != null && key.equals(k)))\n```\n\n### remove 操作\n\n根据 key 删除键值队，同样的先对 key 进行 hash ，再调用 `removeNode()`\n\n``` java\nfinal Node<K,V> removeNode(int hash, Object key, Object value,                 \n                           boolean matchValue, boolean movable) {              \n    Node<K,V>[] tab; Node<K,V> p; int n, index;                                \n    if ((tab = table) != null && (n = tab.length) > 0 &&                       \n        (p = tab[index = (n - 1) & hash]) != null) {                           \n        Node<K,V> node = null, e; K k; V v;                                    \n        if (p.hash == hash &&                                                  \n            ((k = p.key) == key || (key != null && key.equals(k))))    // 如果头部节点 即为需要删除的节点         \n            node = p;                                                          \n        else if ((e = p.next) != null) {                                       \n            if (p instanceof TreeNode)                                         \n                node = ((TreeNode<K,V>)p).getTreeNode(hash, key);    // 红黑树节点          \n            else {                                                             \n                do {                                                           \n                    if (e.hash == hash &&                                      \n                        ((k = e.key) == key ||                                 \n                         (key != null && key.equals(k)))) {                    \n                        node = e;                                              \n                        break;                                                 \n                    }                                                          \n                    p = e;                                                     \n                } while ((e = e.next) != null);                                \n            }                                                                  \n        }                                                                      \n        if (node != null && (!matchValue || (v = node.value) == value ||       \n                             (value != null && value.equals(v)))) {\n            // 存在需要删除的节点\n            if (node instanceof TreeNode)                                      \n                ((TreeNode<K,V>)node).removeTreeNode(this, tab, movable);  // 红黑树    \n            else if (node == p)         // 删除节点为头部节点                                       \n                tab[index] = node.next;                                        \n            else                        // p 为删除节点的父节点                                       \n                p.next = node.next;                                            \n            ++modCount;                                                        \n            --size;                                                            \n            afterNodeRemoval(node);                                            \n            return node;                                                       \n        }                                                                      \n    }                                                                          \n    return null;                                                               \n}                                                                              \n```\n\n\n\n","source":"_posts/HashMap源码分析.md","raw":"---\ntitle: HashMap源码分析\ndate: 2018-11-07 11:39:06\ncategories: Java\ntags:\n---\n\n### 构造方法\n\n从构造方法来看，我们可以指定初始化容量（initialCapacity）和负载因子（loadFactor），其中 loadFactor 的默认值为 0.75，如果指定了 initialCapacity，就会计算容量阙值（threshold）：\n\n``` java\n// tableSizeFor 会计算一个大于或等于 initialCapacity 的 2 的 N 次方的值\nthis.threshold = tableSizeFor(initialCapacity);\n\nstatic final int tableSizeFor(int cap) {                                     \n    int n = cap - 1;                                                         \n    n |= n >>> 1;                                                            \n    n |= n >>> 2;                                                            \n    n |= n >>> 4;                                                            \n    n |= n >>> 8;                                                            \n    n |= n >>> 16;                                                           \n    return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1; \n}                                                                            \n```\n\n> initialCapacity 只会在构造函数中用到，用于计算 threshold\n\n### put 操作\n\n当调用 `put(key,value)` 的时候：\n\n``` java\npublic V put(K key, V value) {\n    return putVal(hash(key), key, value, false, true);\n}\n\nstatic final int hash(Object key) {\n    int h;\n    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);\n}\n```\n\n首先会根据 key 调用 `hash()` 计算哈希值，可以看到 `hash()` 中我们不仅使用 `key.hashCode()` 还将哈希值无符号右移 16 位再做一次异或操作\n\n> 在 HashMap 中，容量（capacity）是 2 的 N 次方，所以在**取余**的时候，可以用 `key & (capacity - 1)` 来代替，当 capacity 较小时，参与计算的位也比较少，比如，使用默认初始化容量 1<<4（即 16），那么计算下标：`key & (0x1111)` 参与计算的位只有 4 位，发生碰撞的概率也比较大\n\n``` java\nfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent,                  \n               boolean evict) {                                                 \n    Node<K,V>[] tab; Node<K,V> p; int n, i;                                     \n    if ((tab = table) == null || (n = tab.length) == 0) // 当 table 为空时候，需要调用 resize()                         \n        n = (tab = resize()).length;                                            \n    if ((p = tab[i = (n - 1) & hash]) == null)  // 如果当前对应 Node 为空，直接添加新的 Node 即可                                  \n        tab[i] = newNode(hash, key, value, null);                               \n    else {                                                                      \n        Node<K,V> e; K k;                                                       \n        if (p.hash == hash &&                                                   \n            ((k = p.key) == key || (key != null && key.equals(k))))  // 如果 Head Node 为结果           \n            e = p;                                                              \n        else if (p instanceof TreeNode)    // 如果是红黑树                                     \n            e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);     \n        else {\n            // 遍历链表\n            for (int binCount = 0; ; ++binCount) {                              \n                if ((e = p.next) == null) {\n                    // 如果没有找到匹配的 Node，添加一个新的 Node\n                    p.next = newNode(hash, key, value, null);                   \n                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st \n                        // 转换为红黑树\n                        treeifyBin(tab, hash);                                  \n                    break;                                                      \n                }                                                               \n                if (e.hash == hash &&                                           \n                    ((k = e.key) == key || (key != null && key.equals(k)))) // 找到已存在的 Node    \n                    break;                                                      \n                p = e;                                                          \n            }                                                                   \n        }                                                                       \n        if (e != null) { // existing mapping for key\n            // key 对应的 Node 已存在\n            V oldValue = e.value;                                               \n            if (!onlyIfAbsent || oldValue == null)                              \n                e.value = value;                                                \n            afterNodeAccess(e);                                                 \n            return oldValue;                                                    \n        }                                                                       \n    }\n    // 添加新的 Node，modCount 改变\n    ++modCount;                                                                 \n    if (++size > threshold) // size 大于阙值，需要扩容                                                     \n        resize();                                                               \n    afterNodeInsertion(evict);                                                  \n    return null;                                                                \n}                                                                               \n```\n\n如果 table 为空的时候，会先调用 `resize()` 来做初始化\n\n``` java\nfinal Node<K,V>[] resize() {                                                    \n    Node<K,V>[] oldTab = table;                                                 \n    int oldCap = (oldTab == null) ? 0 : oldTab.length;                          \n    int oldThr = threshold;                                                     \n    int newCap, newThr = 0;                                                     \n    if (oldCap > 0) {\n        // 如果为扩容操作\n        if (oldCap >= MAXIMUM_CAPACITY) {                                       \n            threshold = Integer.MAX_VALUE;                                      \n            return oldTab;                                                      \n        }\n        else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY &&                   \n                 oldCap >= DEFAULT_INITIAL_CAPACITY)\n            // capacity 左移一位，双倍\n            // 调用 resize 初始化的时候，会将 capacity 设置为默认值 16\n            newThr = oldThr << 1; // double threshold                           \n    }                                                                           \n    else if (oldThr > 0) // initial capacity was placed in threshold\n        // 当使用指定 capacity 的构造方法时，会使用 tableSizeFor 初始化 threshold，2 的 N 次方\n        newCap = oldThr;                                                        \n    else {               // zero initial threshold signifies using defaults\n        // 初始化\n        newCap = DEFAULT_INITIAL_CAPACITY;                                      \n        newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);         \n    }                                                                           \n    if (newThr == 0) {\n        // 计算 threshold = capacity * loadFactor\n        float ft = (float)newCap * loadFactor;                                  \n        newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?   \n                  (int)ft : Integer.MAX_VALUE);                                 \n    }                                                                           \n    threshold = newThr;                                                         \n    @SuppressWarnings({\"rawtypes\",\"unchecked\"})\n    // 创建新的 table\n        Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];                     \n    table = newTab;                                                             \n    if (oldTab != null) {\n        // 拷贝旧的 table\n        for (int j = 0; j < oldCap; ++j) {                                      \n            Node<K,V> e;                                                        \n            if ((e = oldTab[j]) != null) {                                      \n                oldTab[j] = null;                                               \n                if (e.next == null) // 如果只有一个 Node                                             \n                    newTab[e.hash & (newCap - 1)] = e;                          \n                else if (e instanceof TreeNode)  // 如果为红黑树                               \n                    ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);          \n                else { // preserve order  保持顺序\n                    // 旧下标的链表\n                    Node<K,V> loHead = null, loTail = null;                     \n                    // 新下标（oldIndex + oldCapacity）的链表\n                    Node<K,V> hiHead = null, hiTail = null;                     \n                    Node<K,V> next;                                             \n                    do {                                                        \n                        next = e.next;                                          \n                        if ((e.hash & oldCap) == 0) {                           \n                            if (loTail == null)                                 \n                                loHead = e;                                     \n                            else                                                \n                                loTail.next = e;                                \n                            loTail = e;                                         \n                        }                                                       \n                        else {                                                  \n                            if (hiTail == null)                                 \n                                hiHead = e;                                     \n                            else                                                \n                                hiTail.next = e;                                \n                            hiTail = e;                                         \n                        }                                                       \n                    } while ((e = next) != null);                               \n                    if (loTail != null) {                                       \n                        loTail.next = null;                                     \n                        newTab[j] = loHead;                                     \n                    }                                                           \n                    if (hiTail != null) {                                       \n                        hiTail.next = null;                                     \n                        newTab[j + oldCap] = hiHead;                            \n                    }                                                           \n                }                                                               \n            }                                                                   \n        }                                                                       \n    }                                                                           \n    return newTab;                                                              \n}                                                                               \n```\n\n`resize()` 时如果需要扩容，会发生 table 拷贝，如果 Head Node 存储数据结构为链表时，会保持原来链表的顺序，同时使用两个新的链表去保存，一个链表为旧下标位置，一个链表为 旧下标+旧容量 位置\n\n> 新下标要么为旧值，要么为旧值 + 旧容量，根据 (hash & oldCap == 0)，如果为 1，表示旧值+ 旧容量，因为容量为 2 的 N 次方，当 hash(key) 中和 capacity 的最高 1 位相对应的位为 1，则新容量时这个位会更新为 1，即添加 oldCap\n>\n> 举个例子：hash(key) = 17 即 0x10001，容量为 16，下标为 `hash(key) & (cap - 1) = 1` ，扩容后，新容量为 32，下标为 `hash(key) & (cap - 1) = 17`\n\n在查找是否存在 key 对应的值时，先判断引用是否相等，否则，如果 key 不为 null，则调用 `equals()` 去比较 \n\n```java\n((k = p.key) == key || (key != null && key.equals(k)))\n```\n\n### remove 操作\n\n根据 key 删除键值队，同样的先对 key 进行 hash ，再调用 `removeNode()`\n\n``` java\nfinal Node<K,V> removeNode(int hash, Object key, Object value,                 \n                           boolean matchValue, boolean movable) {              \n    Node<K,V>[] tab; Node<K,V> p; int n, index;                                \n    if ((tab = table) != null && (n = tab.length) > 0 &&                       \n        (p = tab[index = (n - 1) & hash]) != null) {                           \n        Node<K,V> node = null, e; K k; V v;                                    \n        if (p.hash == hash &&                                                  \n            ((k = p.key) == key || (key != null && key.equals(k))))    // 如果头部节点 即为需要删除的节点         \n            node = p;                                                          \n        else if ((e = p.next) != null) {                                       \n            if (p instanceof TreeNode)                                         \n                node = ((TreeNode<K,V>)p).getTreeNode(hash, key);    // 红黑树节点          \n            else {                                                             \n                do {                                                           \n                    if (e.hash == hash &&                                      \n                        ((k = e.key) == key ||                                 \n                         (key != null && key.equals(k)))) {                    \n                        node = e;                                              \n                        break;                                                 \n                    }                                                          \n                    p = e;                                                     \n                } while ((e = e.next) != null);                                \n            }                                                                  \n        }                                                                      \n        if (node != null && (!matchValue || (v = node.value) == value ||       \n                             (value != null && value.equals(v)))) {\n            // 存在需要删除的节点\n            if (node instanceof TreeNode)                                      \n                ((TreeNode<K,V>)node).removeTreeNode(this, tab, movable);  // 红黑树    \n            else if (node == p)         // 删除节点为头部节点                                       \n                tab[index] = node.next;                                        \n            else                        // p 为删除节点的父节点                                       \n                p.next = node.next;                                            \n            ++modCount;                                                        \n            --size;                                                            \n            afterNodeRemoval(node);                                            \n            return node;                                                       \n        }                                                                      \n    }                                                                          \n    return null;                                                               \n}                                                                              \n```\n\n\n\n","slug":"HashMap源码分析","published":1,"updated":"2022-06-15T11:19:32.319Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlu000qfho621tbapsn","content":"<h3 id=\"构造方法\"><a href=\"#构造方法\" class=\"headerlink\" title=\"构造方法\"></a>构造方法</h3><p>从构造方法来看，我们可以指定初始化容量（initialCapacity）和负载因子（loadFactor），其中 loadFactor 的默认值为 0.75，如果指定了 initialCapacity，就会计算容量阙值（threshold）：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// tableSizeFor 会计算一个大于或等于 initialCapacity 的 2 的 N 次方的值</span></span><br><span class=\"line\"><span class=\"built_in\">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"title function_\">tableSizeFor</span><span class=\"params\">(<span class=\"type\">int</span> cap)</span> &#123;                                     </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> cap - <span class=\"number\">1</span>;                                                         </span><br><span class=\"line\">    n |= n &gt;&gt;&gt; <span class=\"number\">1</span>;                                                            </span><br><span class=\"line\">    n |= n &gt;&gt;&gt; <span class=\"number\">2</span>;                                                            </span><br><span class=\"line\">    n |= n &gt;&gt;&gt; <span class=\"number\">4</span>;                                                            </span><br><span class=\"line\">    n |= n &gt;&gt;&gt; <span class=\"number\">8</span>;                                                            </span><br><span class=\"line\">    n |= n &gt;&gt;&gt; <span class=\"number\">16</span>;                                                           </span><br><span class=\"line\">    <span class=\"keyword\">return</span> (n &lt; <span class=\"number\">0</span>) ? <span class=\"number\">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class=\"number\">1</span>; </span><br><span class=\"line\">&#125;                                                                            </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>initialCapacity 只会在构造函数中用到，用于计算 threshold</p>\n</blockquote>\n<h3 id=\"put-操作\"><a href=\"#put-操作\" class=\"headerlink\" title=\"put 操作\"></a>put 操作</h3><p>当调用 <code>put(key,value)</code> 的时候：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> V <span class=\"title function_\">put</span><span class=\"params\">(K key, V value)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> putVal(hash(key), key, value, <span class=\"literal\">false</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"title function_\">hash</span><span class=\"params\">(Object key)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> h;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (key == <span class=\"literal\">null</span>) ? <span class=\"number\">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class=\"number\">16</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先会根据 key 调用 <code>hash()</code> 计算哈希值，可以看到 <code>hash()</code> 中我们不仅使用 <code>key.hashCode()</code> 还将哈希值无符号右移 16 位再做一次异或操作</p>\n<blockquote>\n<p>在 HashMap 中，容量（capacity）是 2 的 N 次方，所以在<strong>取余</strong>的时候，可以用 <code>key &amp; (capacity - 1)</code> 来代替，当 capacity 较小时，参与计算的位也比较少，比如，使用默认初始化容量 1&lt;&lt;4（即 16），那么计算下标：<code>key &amp; (0x1111)</code> 参与计算的位只有 4 位，发生碰撞的概率也比较大</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> V <span class=\"title function_\">putVal</span><span class=\"params\">(<span class=\"type\">int</span> hash, K key, V value, <span class=\"type\">boolean</span> onlyIfAbsent,                  </span></span><br><span class=\"line\"><span class=\"params\">               <span class=\"type\">boolean</span> evict)</span> &#123;                                                 </span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class=\"type\">int</span> n, i;                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) == <span class=\"literal\">null</span> || (n = tab.length) == <span class=\"number\">0</span>) <span class=\"comment\">// 当 table 为空时候，需要调用 resize()                         </span></span><br><span class=\"line\">        n = (tab = resize()).length;                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((p = tab[i = (n - <span class=\"number\">1</span>) &amp; hash]) == <span class=\"literal\">null</span>)  <span class=\"comment\">// 如果当前对应 Node 为空，直接添加新的 Node 即可                                  </span></span><br><span class=\"line\">        tab[i] = newNode(hash, key, value, <span class=\"literal\">null</span>);                               </span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;                                                                      </span><br><span class=\"line\">        Node&lt;K,V&gt; e; K k;                                                       </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;                                                   </span><br><span class=\"line\">            ((k = p.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))  <span class=\"comment\">// 如果 Head Node 为结果           </span></span><br><span class=\"line\">            e = p;                                                              </span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> TreeNode)    <span class=\"comment\">// 如果是红黑树                                     </span></span><br><span class=\"line\">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class=\"built_in\">this</span>, tab, hash, key, value);     </span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 遍历链表</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">binCount</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; ; ++binCount) &#123;                              </span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((e = p.next) == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 如果没有找到匹配的 Node，添加一个新的 Node</span></span><br><span class=\"line\">                    p.next = newNode(hash, key, value, <span class=\"literal\">null</span>);                   </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class=\"number\">1</span>) <span class=\"comment\">// -1 for 1st </span></span><br><span class=\"line\">                        <span class=\"comment\">// 转换为红黑树</span></span><br><span class=\"line\">                        treeifyBin(tab, hash);                                  </span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                                                      </span><br><span class=\"line\">                &#125;                                                               </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;                                           </span><br><span class=\"line\">                    ((k = e.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k)))) <span class=\"comment\">// 找到已存在的 Node    </span></span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                                                      </span><br><span class=\"line\">                p = e;                                                          </span><br><span class=\"line\">            &#125;                                                                   </span><br><span class=\"line\">        &#125;                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e != <span class=\"literal\">null</span>) &#123; <span class=\"comment\">// existing mapping for key</span></span><br><span class=\"line\">            <span class=\"comment\">// key 对应的 Node 已存在</span></span><br><span class=\"line\">            <span class=\"type\">V</span> <span class=\"variable\">oldValue</span> <span class=\"operator\">=</span> e.value;                                               </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!onlyIfAbsent || oldValue == <span class=\"literal\">null</span>)                              </span><br><span class=\"line\">                e.value = value;                                                </span><br><span class=\"line\">            afterNodeAccess(e);                                                 </span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldValue;                                                    </span><br><span class=\"line\">        &#125;                                                                       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 添加新的 Node，modCount 改变</span></span><br><span class=\"line\">    ++modCount;                                                                 </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (++size &gt; threshold) <span class=\"comment\">// size 大于阙值，需要扩容                                                     </span></span><br><span class=\"line\">        resize();                                                               </span><br><span class=\"line\">    afterNodeInsertion(evict);                                                  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;                                                                </span><br><span class=\"line\">&#125;                                                                               </span><br></pre></td></tr></table></figure>\n\n<p>如果 table 为空的时候，会先调用 <code>resize()</code> 来做初始化</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt;[] resize() &#123;                                                    </span><br><span class=\"line\">    Node&lt;K,V&gt;[] oldTab = table;                                                 </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldCap</span> <span class=\"operator\">=</span> (oldTab == <span class=\"literal\">null</span>) ? <span class=\"number\">0</span> : oldTab.length;                          </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldThr</span> <span class=\"operator\">=</span> threshold;                                                     </span><br><span class=\"line\">    <span class=\"type\">int</span> newCap, newThr = <span class=\"number\">0</span>;                                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldCap &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果为扩容操作</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;                                       </span><br><span class=\"line\">            threshold = Integer.MAX_VALUE;                                      </span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldTab;                                                      </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((newCap = oldCap &lt;&lt; <span class=\"number\">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;                   </span><br><span class=\"line\">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class=\"line\">            <span class=\"comment\">// capacity 左移一位，双倍</span></span><br><span class=\"line\">            <span class=\"comment\">// 调用 resize 初始化的时候，会将 capacity 设置为默认值 16</span></span><br><span class=\"line\">            newThr = oldThr &lt;&lt; <span class=\"number\">1</span>; <span class=\"comment\">// double threshold                           </span></span><br><span class=\"line\">    &#125;                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (oldThr &gt; <span class=\"number\">0</span>) <span class=\"comment\">// initial capacity was placed in threshold</span></span><br><span class=\"line\">        <span class=\"comment\">// 当使用指定 capacity 的构造方法时，会使用 tableSizeFor 初始化 threshold，2 的 N 次方</span></span><br><span class=\"line\">        newCap = oldThr;                                                        </span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;               <span class=\"comment\">// zero initial threshold signifies using defaults</span></span><br><span class=\"line\">        <span class=\"comment\">// 初始化</span></span><br><span class=\"line\">        newCap = DEFAULT_INITIAL_CAPACITY;                                      </span><br><span class=\"line\">        newThr = (<span class=\"type\">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);         </span><br><span class=\"line\">    &#125;                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newThr == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 计算 threshold = capacity * loadFactor</span></span><br><span class=\"line\">        <span class=\"type\">float</span> <span class=\"variable\">ft</span> <span class=\"operator\">=</span> (<span class=\"type\">float</span>)newCap * loadFactor;                                  </span><br><span class=\"line\">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class=\"type\">float</span>)MAXIMUM_CAPACITY ?   </span><br><span class=\"line\">                  (<span class=\"type\">int</span>)ft : Integer.MAX_VALUE);                                 </span><br><span class=\"line\">    &#125;                                                                           </span><br><span class=\"line\">    threshold = newThr;                                                         </span><br><span class=\"line\">    <span class=\"meta\">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class=\"line\">    <span class=\"comment\">// 创建新的 table</span></span><br><span class=\"line\">        Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class=\"keyword\">new</span> <span class=\"title class_\">Node</span>[newCap];                     </span><br><span class=\"line\">    table = newTab;                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldTab != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 拷贝旧的 table</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; j &lt; oldCap; ++j) &#123;                                      </span><br><span class=\"line\">            Node&lt;K,V&gt; e;                                                        </span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((e = oldTab[j]) != <span class=\"literal\">null</span>) &#123;                                      </span><br><span class=\"line\">                oldTab[j] = <span class=\"literal\">null</span>;                                               </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.next == <span class=\"literal\">null</span>) <span class=\"comment\">// 如果只有一个 Node                                             </span></span><br><span class=\"line\">                    newTab[e.hash &amp; (newCap - <span class=\"number\">1</span>)] = e;                          </span><br><span class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> TreeNode)  <span class=\"comment\">// 如果为红黑树                               </span></span><br><span class=\"line\">                    ((TreeNode&lt;K,V&gt;)e).split(<span class=\"built_in\">this</span>, newTab, j, oldCap);          </span><br><span class=\"line\">                <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// preserve order  保持顺序</span></span><br><span class=\"line\">                    <span class=\"comment\">// 旧下标的链表</span></span><br><span class=\"line\">                    Node&lt;K,V&gt; loHead = <span class=\"literal\">null</span>, loTail = <span class=\"literal\">null</span>;                     </span><br><span class=\"line\">                    <span class=\"comment\">// 新下标（oldIndex + oldCapacity）的链表</span></span><br><span class=\"line\">                    Node&lt;K,V&gt; hiHead = <span class=\"literal\">null</span>, hiTail = <span class=\"literal\">null</span>;                     </span><br><span class=\"line\">                    Node&lt;K,V&gt; next;                                             </span><br><span class=\"line\">                    <span class=\"keyword\">do</span> &#123;                                                        </span><br><span class=\"line\">                        next = e.next;                                          </span><br><span class=\"line\">                        <span class=\"keyword\">if</span> ((e.hash &amp; oldCap) == <span class=\"number\">0</span>) &#123;                           </span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (loTail == <span class=\"literal\">null</span>)                                 </span><br><span class=\"line\">                                loHead = e;                                     </span><br><span class=\"line\">                            <span class=\"keyword\">else</span>                                                </span><br><span class=\"line\">                                loTail.next = e;                                </span><br><span class=\"line\">                            loTail = e;                                         </span><br><span class=\"line\">                        &#125;                                                       </span><br><span class=\"line\">                        <span class=\"keyword\">else</span> &#123;                                                  </span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (hiTail == <span class=\"literal\">null</span>)                                 </span><br><span class=\"line\">                                hiHead = e;                                     </span><br><span class=\"line\">                            <span class=\"keyword\">else</span>                                                </span><br><span class=\"line\">                                hiTail.next = e;                                </span><br><span class=\"line\">                            hiTail = e;                                         </span><br><span class=\"line\">                        &#125;                                                       </span><br><span class=\"line\">                    &#125; <span class=\"keyword\">while</span> ((e = next) != <span class=\"literal\">null</span>);                               </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (loTail != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">                        loTail.next = <span class=\"literal\">null</span>;                                     </span><br><span class=\"line\">                        newTab[j] = loHead;                                     </span><br><span class=\"line\">                    &#125;                                                           </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (hiTail != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">                        hiTail.next = <span class=\"literal\">null</span>;                                     </span><br><span class=\"line\">                        newTab[j + oldCap] = hiHead;                            </span><br><span class=\"line\">                    &#125;                                                           </span><br><span class=\"line\">                &#125;                                                               </span><br><span class=\"line\">            &#125;                                                                   </span><br><span class=\"line\">        &#125;                                                                       </span><br><span class=\"line\">    &#125;                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">return</span> newTab;                                                              </span><br><span class=\"line\">&#125;                                                                               </span><br></pre></td></tr></table></figure>\n\n<p><code>resize()</code> 时如果需要扩容，会发生 table 拷贝，如果 Head Node 存储数据结构为链表时，会保持原来链表的顺序，同时使用两个新的链表去保存，一个链表为旧下标位置，一个链表为 旧下标+旧容量 位置</p>\n<blockquote>\n<p>新下标要么为旧值，要么为旧值 + 旧容量，根据 (hash &amp; oldCap &#x3D;&#x3D; 0)，如果为 1，表示旧值+ 旧容量，因为容量为 2 的 N 次方，当 hash(key) 中和 capacity 的最高 1 位相对应的位为 1，则新容量时这个位会更新为 1，即添加 oldCap</p>\n<p>举个例子：hash(key) &#x3D; 17 即 0x10001，容量为 16，下标为 <code>hash(key) &amp; (cap - 1) = 1</code> ，扩容后，新容量为 32，下标为 <code>hash(key) &amp; (cap - 1) = 17</code></p>\n</blockquote>\n<p>在查找是否存在 key 对应的值时，先判断引用是否相等，否则，如果 key 不为 null，则调用 <code>equals()</code> 去比较 </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">((k = p.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k)))</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"remove-操作\"><a href=\"#remove-操作\" class=\"headerlink\" title=\"remove 操作\"></a>remove 操作</h3><p>根据 key 删除键值队，同样的先对 key 进行 hash ，再调用 <code>removeNode()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt; <span class=\"title function_\">removeNode</span><span class=\"params\">(<span class=\"type\">int</span> hash, Object key, Object value,                 </span></span><br><span class=\"line\"><span class=\"params\">                           <span class=\"type\">boolean</span> matchValue, <span class=\"type\">boolean</span> movable)</span> &#123;              </span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class=\"type\">int</span> n, index;                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) != <span class=\"literal\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span> &amp;&amp;                       </span><br><span class=\"line\">        (p = tab[index = (n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"literal\">null</span>) &#123;                           </span><br><span class=\"line\">        Node&lt;K,V&gt; node = <span class=\"literal\">null</span>, e; K k; V v;                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;                                                  </span><br><span class=\"line\">            ((k = p.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))    <span class=\"comment\">// 如果头部节点 即为需要删除的节点         </span></span><br><span class=\"line\">            node = p;                                                          </span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((e = p.next) != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> TreeNode)                                         </span><br><span class=\"line\">                node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);    <span class=\"comment\">// 红黑树节点          </span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;                                                             </span><br><span class=\"line\">                <span class=\"keyword\">do</span> &#123;                                                           </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;                                      </span><br><span class=\"line\">                        ((k = e.key) == key ||                                 </span><br><span class=\"line\">                         (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k)))) &#123;                    </span><br><span class=\"line\">                        node = e;                                              </span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;                                                 </span><br><span class=\"line\">                    &#125;                                                          </span><br><span class=\"line\">                    p = e;                                                     </span><br><span class=\"line\">                &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"literal\">null</span>);                                </span><br><span class=\"line\">            &#125;                                                                  </span><br><span class=\"line\">        &#125;                                                                      </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (node != <span class=\"literal\">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||       </span><br><span class=\"line\">                             (value != <span class=\"literal\">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 存在需要删除的节点</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (node <span class=\"keyword\">instanceof</span> TreeNode)                                      </span><br><span class=\"line\">                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class=\"built_in\">this</span>, tab, movable);  <span class=\"comment\">// 红黑树    </span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (node == p)         <span class=\"comment\">// 删除节点为头部节点                                       </span></span><br><span class=\"line\">                tab[index] = node.next;                                        </span><br><span class=\"line\">            <span class=\"keyword\">else</span>                        <span class=\"comment\">// p 为删除节点的父节点                                       </span></span><br><span class=\"line\">                p.next = node.next;                                            </span><br><span class=\"line\">            ++modCount;                                                        </span><br><span class=\"line\">            --size;                                                            </span><br><span class=\"line\">            afterNodeRemoval(node);                                            </span><br><span class=\"line\">            <span class=\"keyword\">return</span> node;                                                       </span><br><span class=\"line\">        &#125;                                                                      </span><br><span class=\"line\">    &#125;                                                                          </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;                                                               </span><br><span class=\"line\">&#125;                                                                              </span><br></pre></td></tr></table></figure>\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"构造方法\"><a href=\"#构造方法\" class=\"headerlink\" title=\"构造方法\"></a>构造方法</h3><p>从构造方法来看，我们可以指定初始化容量（initialCapacity）和负载因子（loadFactor），其中 loadFactor 的默认值为 0.75，如果指定了 initialCapacity，就会计算容量阙值（threshold）：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// tableSizeFor 会计算一个大于或等于 initialCapacity 的 2 的 N 次方的值</span></span><br><span class=\"line\"><span class=\"built_in\">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"title function_\">tableSizeFor</span><span class=\"params\">(<span class=\"type\">int</span> cap)</span> &#123;                                     </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> cap - <span class=\"number\">1</span>;                                                         </span><br><span class=\"line\">    n |= n &gt;&gt;&gt; <span class=\"number\">1</span>;                                                            </span><br><span class=\"line\">    n |= n &gt;&gt;&gt; <span class=\"number\">2</span>;                                                            </span><br><span class=\"line\">    n |= n &gt;&gt;&gt; <span class=\"number\">4</span>;                                                            </span><br><span class=\"line\">    n |= n &gt;&gt;&gt; <span class=\"number\">8</span>;                                                            </span><br><span class=\"line\">    n |= n &gt;&gt;&gt; <span class=\"number\">16</span>;                                                           </span><br><span class=\"line\">    <span class=\"keyword\">return</span> (n &lt; <span class=\"number\">0</span>) ? <span class=\"number\">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class=\"number\">1</span>; </span><br><span class=\"line\">&#125;                                                                            </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>initialCapacity 只会在构造函数中用到，用于计算 threshold</p>\n</blockquote>\n<h3 id=\"put-操作\"><a href=\"#put-操作\" class=\"headerlink\" title=\"put 操作\"></a>put 操作</h3><p>当调用 <code>put(key,value)</code> 的时候：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> V <span class=\"title function_\">put</span><span class=\"params\">(K key, V value)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> putVal(hash(key), key, value, <span class=\"literal\">false</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"title function_\">hash</span><span class=\"params\">(Object key)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> h;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (key == <span class=\"literal\">null</span>) ? <span class=\"number\">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class=\"number\">16</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先会根据 key 调用 <code>hash()</code> 计算哈希值，可以看到 <code>hash()</code> 中我们不仅使用 <code>key.hashCode()</code> 还将哈希值无符号右移 16 位再做一次异或操作</p>\n<blockquote>\n<p>在 HashMap 中，容量（capacity）是 2 的 N 次方，所以在<strong>取余</strong>的时候，可以用 <code>key &amp; (capacity - 1)</code> 来代替，当 capacity 较小时，参与计算的位也比较少，比如，使用默认初始化容量 1&lt;&lt;4（即 16），那么计算下标：<code>key &amp; (0x1111)</code> 参与计算的位只有 4 位，发生碰撞的概率也比较大</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> V <span class=\"title function_\">putVal</span><span class=\"params\">(<span class=\"type\">int</span> hash, K key, V value, <span class=\"type\">boolean</span> onlyIfAbsent,                  </span></span><br><span class=\"line\"><span class=\"params\">               <span class=\"type\">boolean</span> evict)</span> &#123;                                                 </span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class=\"type\">int</span> n, i;                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) == <span class=\"literal\">null</span> || (n = tab.length) == <span class=\"number\">0</span>) <span class=\"comment\">// 当 table 为空时候，需要调用 resize()                         </span></span><br><span class=\"line\">        n = (tab = resize()).length;                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((p = tab[i = (n - <span class=\"number\">1</span>) &amp; hash]) == <span class=\"literal\">null</span>)  <span class=\"comment\">// 如果当前对应 Node 为空，直接添加新的 Node 即可                                  </span></span><br><span class=\"line\">        tab[i] = newNode(hash, key, value, <span class=\"literal\">null</span>);                               </span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;                                                                      </span><br><span class=\"line\">        Node&lt;K,V&gt; e; K k;                                                       </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;                                                   </span><br><span class=\"line\">            ((k = p.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))  <span class=\"comment\">// 如果 Head Node 为结果           </span></span><br><span class=\"line\">            e = p;                                                              </span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> TreeNode)    <span class=\"comment\">// 如果是红黑树                                     </span></span><br><span class=\"line\">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class=\"built_in\">this</span>, tab, hash, key, value);     </span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 遍历链表</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">binCount</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; ; ++binCount) &#123;                              </span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((e = p.next) == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 如果没有找到匹配的 Node，添加一个新的 Node</span></span><br><span class=\"line\">                    p.next = newNode(hash, key, value, <span class=\"literal\">null</span>);                   </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class=\"number\">1</span>) <span class=\"comment\">// -1 for 1st </span></span><br><span class=\"line\">                        <span class=\"comment\">// 转换为红黑树</span></span><br><span class=\"line\">                        treeifyBin(tab, hash);                                  </span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                                                      </span><br><span class=\"line\">                &#125;                                                               </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;                                           </span><br><span class=\"line\">                    ((k = e.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k)))) <span class=\"comment\">// 找到已存在的 Node    </span></span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                                                      </span><br><span class=\"line\">                p = e;                                                          </span><br><span class=\"line\">            &#125;                                                                   </span><br><span class=\"line\">        &#125;                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e != <span class=\"literal\">null</span>) &#123; <span class=\"comment\">// existing mapping for key</span></span><br><span class=\"line\">            <span class=\"comment\">// key 对应的 Node 已存在</span></span><br><span class=\"line\">            <span class=\"type\">V</span> <span class=\"variable\">oldValue</span> <span class=\"operator\">=</span> e.value;                                               </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!onlyIfAbsent || oldValue == <span class=\"literal\">null</span>)                              </span><br><span class=\"line\">                e.value = value;                                                </span><br><span class=\"line\">            afterNodeAccess(e);                                                 </span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldValue;                                                    </span><br><span class=\"line\">        &#125;                                                                       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 添加新的 Node，modCount 改变</span></span><br><span class=\"line\">    ++modCount;                                                                 </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (++size &gt; threshold) <span class=\"comment\">// size 大于阙值，需要扩容                                                     </span></span><br><span class=\"line\">        resize();                                                               </span><br><span class=\"line\">    afterNodeInsertion(evict);                                                  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;                                                                </span><br><span class=\"line\">&#125;                                                                               </span><br></pre></td></tr></table></figure>\n\n<p>如果 table 为空的时候，会先调用 <code>resize()</code> 来做初始化</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt;[] resize() &#123;                                                    </span><br><span class=\"line\">    Node&lt;K,V&gt;[] oldTab = table;                                                 </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldCap</span> <span class=\"operator\">=</span> (oldTab == <span class=\"literal\">null</span>) ? <span class=\"number\">0</span> : oldTab.length;                          </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">oldThr</span> <span class=\"operator\">=</span> threshold;                                                     </span><br><span class=\"line\">    <span class=\"type\">int</span> newCap, newThr = <span class=\"number\">0</span>;                                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldCap &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果为扩容操作</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;                                       </span><br><span class=\"line\">            threshold = Integer.MAX_VALUE;                                      </span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldTab;                                                      </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((newCap = oldCap &lt;&lt; <span class=\"number\">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;                   </span><br><span class=\"line\">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class=\"line\">            <span class=\"comment\">// capacity 左移一位，双倍</span></span><br><span class=\"line\">            <span class=\"comment\">// 调用 resize 初始化的时候，会将 capacity 设置为默认值 16</span></span><br><span class=\"line\">            newThr = oldThr &lt;&lt; <span class=\"number\">1</span>; <span class=\"comment\">// double threshold                           </span></span><br><span class=\"line\">    &#125;                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (oldThr &gt; <span class=\"number\">0</span>) <span class=\"comment\">// initial capacity was placed in threshold</span></span><br><span class=\"line\">        <span class=\"comment\">// 当使用指定 capacity 的构造方法时，会使用 tableSizeFor 初始化 threshold，2 的 N 次方</span></span><br><span class=\"line\">        newCap = oldThr;                                                        </span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;               <span class=\"comment\">// zero initial threshold signifies using defaults</span></span><br><span class=\"line\">        <span class=\"comment\">// 初始化</span></span><br><span class=\"line\">        newCap = DEFAULT_INITIAL_CAPACITY;                                      </span><br><span class=\"line\">        newThr = (<span class=\"type\">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);         </span><br><span class=\"line\">    &#125;                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newThr == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 计算 threshold = capacity * loadFactor</span></span><br><span class=\"line\">        <span class=\"type\">float</span> <span class=\"variable\">ft</span> <span class=\"operator\">=</span> (<span class=\"type\">float</span>)newCap * loadFactor;                                  </span><br><span class=\"line\">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class=\"type\">float</span>)MAXIMUM_CAPACITY ?   </span><br><span class=\"line\">                  (<span class=\"type\">int</span>)ft : Integer.MAX_VALUE);                                 </span><br><span class=\"line\">    &#125;                                                                           </span><br><span class=\"line\">    threshold = newThr;                                                         </span><br><span class=\"line\">    <span class=\"meta\">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class=\"line\">    <span class=\"comment\">// 创建新的 table</span></span><br><span class=\"line\">        Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class=\"keyword\">new</span> <span class=\"title class_\">Node</span>[newCap];                     </span><br><span class=\"line\">    table = newTab;                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldTab != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 拷贝旧的 table</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; j &lt; oldCap; ++j) &#123;                                      </span><br><span class=\"line\">            Node&lt;K,V&gt; e;                                                        </span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((e = oldTab[j]) != <span class=\"literal\">null</span>) &#123;                                      </span><br><span class=\"line\">                oldTab[j] = <span class=\"literal\">null</span>;                                               </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.next == <span class=\"literal\">null</span>) <span class=\"comment\">// 如果只有一个 Node                                             </span></span><br><span class=\"line\">                    newTab[e.hash &amp; (newCap - <span class=\"number\">1</span>)] = e;                          </span><br><span class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> TreeNode)  <span class=\"comment\">// 如果为红黑树                               </span></span><br><span class=\"line\">                    ((TreeNode&lt;K,V&gt;)e).split(<span class=\"built_in\">this</span>, newTab, j, oldCap);          </span><br><span class=\"line\">                <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// preserve order  保持顺序</span></span><br><span class=\"line\">                    <span class=\"comment\">// 旧下标的链表</span></span><br><span class=\"line\">                    Node&lt;K,V&gt; loHead = <span class=\"literal\">null</span>, loTail = <span class=\"literal\">null</span>;                     </span><br><span class=\"line\">                    <span class=\"comment\">// 新下标（oldIndex + oldCapacity）的链表</span></span><br><span class=\"line\">                    Node&lt;K,V&gt; hiHead = <span class=\"literal\">null</span>, hiTail = <span class=\"literal\">null</span>;                     </span><br><span class=\"line\">                    Node&lt;K,V&gt; next;                                             </span><br><span class=\"line\">                    <span class=\"keyword\">do</span> &#123;                                                        </span><br><span class=\"line\">                        next = e.next;                                          </span><br><span class=\"line\">                        <span class=\"keyword\">if</span> ((e.hash &amp; oldCap) == <span class=\"number\">0</span>) &#123;                           </span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (loTail == <span class=\"literal\">null</span>)                                 </span><br><span class=\"line\">                                loHead = e;                                     </span><br><span class=\"line\">                            <span class=\"keyword\">else</span>                                                </span><br><span class=\"line\">                                loTail.next = e;                                </span><br><span class=\"line\">                            loTail = e;                                         </span><br><span class=\"line\">                        &#125;                                                       </span><br><span class=\"line\">                        <span class=\"keyword\">else</span> &#123;                                                  </span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (hiTail == <span class=\"literal\">null</span>)                                 </span><br><span class=\"line\">                                hiHead = e;                                     </span><br><span class=\"line\">                            <span class=\"keyword\">else</span>                                                </span><br><span class=\"line\">                                hiTail.next = e;                                </span><br><span class=\"line\">                            hiTail = e;                                         </span><br><span class=\"line\">                        &#125;                                                       </span><br><span class=\"line\">                    &#125; <span class=\"keyword\">while</span> ((e = next) != <span class=\"literal\">null</span>);                               </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (loTail != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">                        loTail.next = <span class=\"literal\">null</span>;                                     </span><br><span class=\"line\">                        newTab[j] = loHead;                                     </span><br><span class=\"line\">                    &#125;                                                           </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (hiTail != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">                        hiTail.next = <span class=\"literal\">null</span>;                                     </span><br><span class=\"line\">                        newTab[j + oldCap] = hiHead;                            </span><br><span class=\"line\">                    &#125;                                                           </span><br><span class=\"line\">                &#125;                                                               </span><br><span class=\"line\">            &#125;                                                                   </span><br><span class=\"line\">        &#125;                                                                       </span><br><span class=\"line\">    &#125;                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">return</span> newTab;                                                              </span><br><span class=\"line\">&#125;                                                                               </span><br></pre></td></tr></table></figure>\n\n<p><code>resize()</code> 时如果需要扩容，会发生 table 拷贝，如果 Head Node 存储数据结构为链表时，会保持原来链表的顺序，同时使用两个新的链表去保存，一个链表为旧下标位置，一个链表为 旧下标+旧容量 位置</p>\n<blockquote>\n<p>新下标要么为旧值，要么为旧值 + 旧容量，根据 (hash &amp; oldCap &#x3D;&#x3D; 0)，如果为 1，表示旧值+ 旧容量，因为容量为 2 的 N 次方，当 hash(key) 中和 capacity 的最高 1 位相对应的位为 1，则新容量时这个位会更新为 1，即添加 oldCap</p>\n<p>举个例子：hash(key) &#x3D; 17 即 0x10001，容量为 16，下标为 <code>hash(key) &amp; (cap - 1) = 1</code> ，扩容后，新容量为 32，下标为 <code>hash(key) &amp; (cap - 1) = 17</code></p>\n</blockquote>\n<p>在查找是否存在 key 对应的值时，先判断引用是否相等，否则，如果 key 不为 null，则调用 <code>equals()</code> 去比较 </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">((k = p.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k)))</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"remove-操作\"><a href=\"#remove-操作\" class=\"headerlink\" title=\"remove 操作\"></a>remove 操作</h3><p>根据 key 删除键值队，同样的先对 key 进行 hash ，再调用 <code>removeNode()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt; <span class=\"title function_\">removeNode</span><span class=\"params\">(<span class=\"type\">int</span> hash, Object key, Object value,                 </span></span><br><span class=\"line\"><span class=\"params\">                           <span class=\"type\">boolean</span> matchValue, <span class=\"type\">boolean</span> movable)</span> &#123;              </span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class=\"type\">int</span> n, index;                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) != <span class=\"literal\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span> &amp;&amp;                       </span><br><span class=\"line\">        (p = tab[index = (n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"literal\">null</span>) &#123;                           </span><br><span class=\"line\">        Node&lt;K,V&gt; node = <span class=\"literal\">null</span>, e; K k; V v;                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;                                                  </span><br><span class=\"line\">            ((k = p.key) == key || (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k))))    <span class=\"comment\">// 如果头部节点 即为需要删除的节点         </span></span><br><span class=\"line\">            node = p;                                                          </span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((e = p.next) != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> TreeNode)                                         </span><br><span class=\"line\">                node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);    <span class=\"comment\">// 红黑树节点          </span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;                                                             </span><br><span class=\"line\">                <span class=\"keyword\">do</span> &#123;                                                           </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;                                      </span><br><span class=\"line\">                        ((k = e.key) == key ||                                 </span><br><span class=\"line\">                         (key != <span class=\"literal\">null</span> &amp;&amp; key.equals(k)))) &#123;                    </span><br><span class=\"line\">                        node = e;                                              </span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;                                                 </span><br><span class=\"line\">                    &#125;                                                          </span><br><span class=\"line\">                    p = e;                                                     </span><br><span class=\"line\">                &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"literal\">null</span>);                                </span><br><span class=\"line\">            &#125;                                                                  </span><br><span class=\"line\">        &#125;                                                                      </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (node != <span class=\"literal\">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||       </span><br><span class=\"line\">                             (value != <span class=\"literal\">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 存在需要删除的节点</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (node <span class=\"keyword\">instanceof</span> TreeNode)                                      </span><br><span class=\"line\">                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class=\"built_in\">this</span>, tab, movable);  <span class=\"comment\">// 红黑树    </span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (node == p)         <span class=\"comment\">// 删除节点为头部节点                                       </span></span><br><span class=\"line\">                tab[index] = node.next;                                        </span><br><span class=\"line\">            <span class=\"keyword\">else</span>                        <span class=\"comment\">// p 为删除节点的父节点                                       </span></span><br><span class=\"line\">                p.next = node.next;                                            </span><br><span class=\"line\">            ++modCount;                                                        </span><br><span class=\"line\">            --size;                                                            </span><br><span class=\"line\">            afterNodeRemoval(node);                                            </span><br><span class=\"line\">            <span class=\"keyword\">return</span> node;                                                       </span><br><span class=\"line\">        &#125;                                                                      </span><br><span class=\"line\">    &#125;                                                                          </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;                                                               </span><br><span class=\"line\">&#125;                                                                              </span><br></pre></td></tr></table></figure>\n\n\n\n"},{"title":"Jetpack中的LiveData","date":"2019-02-05T06:54:08.000Z","_content":"\n### 关于LiveData\n\n`LiveData` 是一种可观察的数据持有类，下面是常用的写法：\n\n``` kotlin\nclass DataViewModel(application: Application) : AndroidViewModel(application) {\n\n    val dataSource: LiveData<String> = MutableLiveData()\n\n    fun postValue(text: String? = \"Hello World\") {\n        (dataSource as MutableLiveData).postValue(text)\n    }\n}\n\nviewModel.dataSource.observe(this, object : Observer<String> {\n\n            override fun onChanged(t: String?) {\n                println(\"onChange: ${t}\")\n            }\n\n})\n```\n\n一般情况下，`LiveData` 和 `ViewModel` 都是搭配使用的，可以在 `Activity` 和 `Fragment` 范围内提供复用，并处理因配置发生改变，而重建的情况。\n\n> 关于 `ViewModel` 更详细的理解，可以阅读之前的文章：[Jetpack中的ViewModel](https://linxiaotao.github.io/2019/01/05/Jetpack%E4%B8%AD%E7%9A%84ViewModel/)\n\n如果了解过 [RxJava](https://github.com/ReactiveX/RxJava) 的同学，对这种**观察者**的设计模式应该有点了解，`LiveData` 也是同样的思想，不过和 RxJava 不同的是：`LiveData` 使用 `Lifecycle` 将数据源和 `Activity` 和 `Fragment` 的生命周期结合起来，避免内存泄漏等情况。这个特性也是本文的重点。\n\n> 关于 Lifecycle 更详细的理解，可以阅读之前的文章：[Jetpack中的Lifecycle](https://linxiaotao.github.io/2019/01/14/Jetpack%E4%B8%AD%E7%9A%84Lifecycle/)\n\n建议在阅读以下内容时，先理解下 `Lifecycle`，因为 `LiveData` 能感应 `Activity` 和 `Fragment` 的生命周期就是基于 `Lifecycle` 实现的。\n\n### 源码解析\n\n#### 各个模块的作用\n\n在理解源码之前，我们先理清组成 `LiveData` 各个模块的作用。\n\n##### LiveData\n\n`LiveData` 表示一个可观察的数据源。在 `LiveData` 的设计中，它被设计为一个纯粹的数据源，对外只提供了：\n\n* observe(LifecycleOwner,Observer)\n\n  表示注册一个观察者（`Observer`），这里同时需要提供一个 `LifecycleOwner` 用于提供 `Lifecycle`\n\n* observeForever(Observer)\n\n  功能和 `observe(LifecycleOwner,Observer)` 类似，但缺少感应生命周期的功能\n\n* removeObserver(Observer) 和 removeObservers(LifecycleOwner)\n\n  表示删除观察者，后者则是删除同个 `LifecycleOwner` 范围的 `Observer`\n\n* getValue()\n\n  表示获取当前值\n\n* hasObservers()\n\n  表示是否存在 `Observer`\n\n* hasActiveObservers()\n\n  表示是否存在活动的 `Observer`，至于怎么去定义为活动的，后面会讲到\n\n`LiveData` 是一个纯粹的数据源，不包含添加数据的公开 API，只能通过使用 `MutableLiveData` 去添加数据\n\n> 这是一种不错的设计理念，单个组件功能越纯粹，代码的耦合度就越低。\n\n##### Observer\n\n`Observer` 表示观察者，响应数据发生变化。API 也非常简单：`onChange(T)`，这里需要注意的是：`onChange()` 中数据可以为 `NULL`，这和 `RxJava2` 的设计是不一样的，这个很难说，哪个设计更优。但根据 [JakeWharton](https://github.com/JakeWharton) 的回答是：It's not RxJava's choice, it's in the reactive streams spec.\n\n> 关于 `RxJava2` 不能传递 `NULL` 的讨论，可以参考这篇[文章](https://github.com/ReactiveX/RxJava/issues/4644)\n\n#### observe\n\n调用 `LiveData.observe(LifecycleOwner,Observer)` 去注册一个订阅者：\n\n``` java\n@MainThread                                                                                 \npublic void observe(@NonNull LifecycleOwner owner, @NonNull Observer<? super T> observer) {\n    // 注意，只能主线程调用\n    assertMainThread(\"observe\");                                                            \n    if (owner.getLifecycle().getCurrentState() == DESTROYED) {                              \n        // ignore                                                                           \n        return;                                                                             \n    }\n    // 使用 LifecycleBoundObserver 包装类\n    LifecycleBoundObserver wrapper = new LifecycleBoundObserver(owner, observer);\n    // mObservers 为 Map<Observer,ObserverWrapper>\n    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);                   \n    if (existing != null && !existing.isAttachedTo(owner)) {\n        // 存在不同 LifecycleOwner 但相同 observer，抛异常\n        throw new IllegalArgumentException(\"Cannot add the same observer\"                   \n                + \" with different lifecycles\");                                            \n    }                                                                                       \n    if (existing != null) {                                                                 \n        return;                                                                             \n    }                                                                                       \n    owner.getLifecycle().addObserver(wrapper);                                              \n}\n\n// LifecycleBoundObserver\n@Override                                     \nboolean isAttachedTo(LifecycleOwner owner) {  \n    return mOwner == owner;                   \n}                                             \n```\n\n`LifecycleBoundObserver` 实现了 `GenericLifecycleObserver` 接口，用于响应 `Activity` 和 `Fragment` 的生命周期\n\n``` java\nclass LifecycleBoundObserver extends ObserverWrapper implements GenericLifecycleObserver {   \n    @NonNull                                                                                 \n    final LifecycleOwner mOwner;                                                             \n                                                                                             \n    LifecycleBoundObserver(@NonNull LifecycleOwner owner, Observer<? super T> observer) {    \n        super(observer);                                                                     \n        mOwner = owner;                                                                      \n    }                                                                                        \n                                                                                             \n    @Override                                                                                \n    boolean shouldBeActive() { \n        // 检测是否为活动状态\n        return mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);                   \n    }                                                                                        \n                                                                                             \n    @Override                                                                                \n    public void onStateChanged(LifecycleOwner source, Lifecycle.Event event) {               \n        if (mOwner.getLifecycle().getCurrentState() == DESTROYED) {\n            // DESTROYED 时移除 observer\n            removeObserver(mObserver);                                                       \n            return;                                                                          \n        }                                                                                    \n        activeStateChanged(shouldBeActive());                                                \n    }                                                                                        \n                                                                                             \n    @Override                                                                                \n    boolean isAttachedTo(LifecycleOwner owner) {\n        // 判断是否为同个 LifecycleOwner\n        return mOwner == owner;                                                              \n    }                                                                                        \n                                                                                             \n    @Override                                                                                \n    void detachObserver() {\n        // 1.removeObserver\n        // 2. lifecycle state 没有在 started 之后，或者已经是 destoryed\n        // 以上两种情况会调用 detachObserver\n        // 从 Lifecycle 中移除 observer\n        mOwner.getLifecycle().removeObserver(this);                                          \n    }                                                                                        \n} \n\nprivate abstract class ObserverWrapper {                                             \n    final Observer<? super T> mObserver;                                             \n    boolean mActive;                                                                 \n    int mLastVersion = START_VERSION;                                                \n                                                                                     \n    ObserverWrapper(Observer<? super T> observer) {                                  \n        mObserver = observer;                                                        \n    }                                                                                \n                                                                                     \n    abstract boolean shouldBeActive();                                               \n                                                                                     \n    boolean isAttachedTo(LifecycleOwner owner) {                                     \n        return false;                                                                \n    }                                                                                \n                                                                                     \n    void detachObserver() {                                                          \n    }                                                                                \n                                                                                     \n    void activeStateChanged(boolean newActive) {\n        // 当活动状态发生变化时\n        if (newActive == mActive) {                                                  \n            return;                                                                  \n        }                                                                            \n        // immediately set active state, so we'd never dispatch anything to inactive \n        // owner                                                                     \n        mActive = newActive;\n        // 是否为不活动状态\n        boolean wasInactive = LiveData.this.mActiveCount == 0; \n        // 当前活动个数统计\n        LiveData.this.mActiveCount += mActive ? 1 : -1;                              \n        if (wasInactive && mActive) {\n            // 不活动 -> 活动\n            onActive();                                                              \n        }                                                                            \n        if (LiveData.this.mActiveCount == 0 && !mActive) {\n            // 活动 -> 不活动\n            onInactive();                                                            \n        }                                                                            \n        if (mActive) { \n            // 当前为活动状态，分发当前 observer\n            dispatchingValue(this);                                                  \n        }                                                                            \n    }                                                                                \n}                                                                                    \n```\n\n当调用 `observe()` 会根据当前是否为活跃状态，分发当前值。\n\n#### postValue 和 setValue\n\n当在非主线程调用时，使用 `postValue()`，相关源码如下：\n\n``` java\nprotected void postValue(T value) {                                       \n    boolean postTask;                                                     \n    synchronized (mDataLock) {\n        // 当前是否存在需要分发的值\n        postTask = mPendingData == NOT_SET;  \n        // 多次调用，只会分发最后一次的值\n        mPendingData = value;                                             \n    }                                                                     \n    if (!postTask) {\n        // 已存在正在分发的任务\n        return;                                                           \n    }                                                                     \n    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);  \n}\n```\n\n这里需要注意的是，当分发数据的任务还没结束时，多次调用 `postValue` 只会分发最后一次的值，同一时间只会存在一个 `PostValueRunnable`\n\n``` java\nprivate final Runnable mPostValueRunnable = new Runnable() { \n    @Override                                                \n    public void run() {                                      \n        Object newValue;                                     \n        synchronized (mDataLock) {                           \n            newValue = mPendingData; \n            // 设置为 NOT_SET\n            mPendingData = NOT_SET;                          \n        }                                                    \n        //noinspection unchecked \n        // 再调用 setValue\n        setValue((T) newValue);                              \n    }                                                        \n}; \n\n@MainThread                                         \nprotected void setValue(T value) {\n    // 只能在主线程调用\n    assertMainThread(\"setValue\"); \n    // 使用 version 记录\n    mVersion++; \n    // 当前值\n    mData = value;  \n    // 分发\n    dispatchingValue(null);                         \n} \n\nvoid dispatchingValue(@Nullable ObserverWrapper initiator) {                           \n    if (mDispatchingValue) {\n        // 正在分发中\n        mDispatchInvalidated = true;                                                   \n        return;                                                                        \n    }                                                                                  \n    mDispatchingValue = true;                                                          \n    do {                                                                               \n        mDispatchInvalidated = false;                                                  \n        if (initiator != null) {\n            // 初始分发\n            considerNotify(initiator);                                                 \n            initiator = null;                                                          \n        } else {\n            // 升序迭代，调用 considerNotify\n            for (Iterator<Map.Entry<Observer<? super T>, ObserverWrapper>> iterator =  \n                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) {        \n                considerNotify(iterator.next().getValue());                            \n                if (mDispatchInvalidated) {\n                    // 分发过程中，有新的数据需要分发\n                    break;                                                             \n                }                                                                      \n            }                                                                          \n        }                                                                              \n    } while (mDispatchInvalidated);                                                    \n    mDispatchingValue = false;                                                         \n}                                                                                      \n```\n\n如果有阅读过 [Jetpack中的Lifecycle](https://linxiaotao.github.io/2019/01/14/Jetpack%E4%B8%AD%E7%9A%84Lifecycle/) 这篇文章的话，可以很快看出，分发值的处理和 `Lifecycle` 有类似的地方，即在分发过程中，有新的值开始分发这种 case，都是采用中断当前的分发，推迟到下一次遍历时，分发新的值。\n\n``` java\nprivate void considerNotify(ObserverWrapper observer) {                                         \n    if (!observer.mActive) { \n        // 当前 observer 为非活动状态\n        return;                                                                                 \n    }                                                                                           \n    // Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.  \n    //                                                                                          \n    // we still first check observer.active to keep it as the entrance for events. So even if   \n    // the observer moved to an active state, if we've not received that event, we better not   \n    // notify for a more predictable notification order.\n    // 可能存在已经是非活动状态，但没有接收到的 case\n    // 检测是否为活动状态\n    if (!observer.shouldBeActive()) {\n        // 非活动状态，mActive 和 shouldBeActive 不一致，通知 activeStateChanged\n        observer.activeStateChanged(false);                                                     \n        return;                                                                                 \n    }                                                                                           \n    if (observer.mLastVersion >= mVersion) { \n        // 当重新变为活动状态时，会分发当前值，避免重复值\n        return;                                                                                 \n    }                                                                                           \n    observer.mLastVersion = mVersion;                                                           \n    //noinspection unchecked                                                                    \n    observer.mObserver.onChanged((T) mData);                                                    \n}                                                                                               \n```\n\n需要注意的是，`setValue` 和 `postValue` 方法都是 `protected`，所以当我们想实现一个 LiveData 时，需要使用 MutableLiveData，源码很简单，就是将这两个方法修改为 `public`。\n\n> 这种实现思路有利于数据的不可变性。上游使用 MutableLiveData 分发数据，下游使用 LiveData 消费数据。\n\n如果使用过 RxJava 类似库的同学可能会觉得跟 LiveData 很像，同样是监听者模式。不一样的是，RxJava 提供了很多操作符，类似 `map`、`zip` 等，还有线程调度的 `observeOn` 和 `subscribeOn`。LiveData 没有线程调度的功能，它数据分发只在主线程上进行，没有线程锁等开销。除此之前，LiveData 只提供了 `map` 和 `switchMap` 的实现，但提供了 `MediatorLiveData` 去实现自己需要的操作符。\n\n#### Transformations\n\nTransformations 中有 `map` 和 `switchMap` 的实现。\n\n``` java\n@MainThread  \npublic static <X, Y> LiveData<Y> map(                              \n        @NonNull LiveData<X> source,                               \n        @NonNull final Function<X, Y> mapFunction) {\n    final MediatorLiveData<Y> result = new MediatorLiveData<>();   \n    result.addSource(source, new Observer<X>() {                   \n        @Override                                                  \n        public void onChanged(@Nullable X x) {\n            // 对源数据进行转化\n            result.setValue(mapFunction.apply(x));                 \n        }                                                          \n    });                                                            \n    return result;                                                 \n} \n\n@MainThread  \npublic static <X, Y> LiveData<Y> switchMap(                            \n        @NonNull LiveData<X> source,                                   \n        @NonNull final Function<X, LiveData<Y>> switchMapFunction) {   \n    final MediatorLiveData<Y> result = new MediatorLiveData<>();       \n    result.addSource(source, new Observer<X>() {                       \n        LiveData<Y> mSource;                                           \n                                                                       \n        @Override                                                      \n        public void onChanged(@Nullable X x) {\n            // 将发射出来的每个数据都转换成新的 LiveData，再接收\n            LiveData<Y> newLiveData = switchMapFunction.apply(x);      \n            if (mSource == newLiveData) {                              \n                return;                                                \n            }                                                          \n            if (mSource != null) {                                     \n                result.removeSource(mSource);                          \n            }                                                          \n            mSource = newLiveData;                                     \n            if (mSource != null) {                                     \n                result.addSource(mSource, new Observer<Y>() {          \n                    @Override                                          \n                    public void onChanged(@Nullable Y y) {             \n                        result.setValue(y);                            \n                    }                                                  \n                });                                                    \n            }                                                          \n        }                                                              \n    });                                                                \n    return result;                                                     \n}                                                                      \n```\n\nMediatorLiveData 可以监听多个 LiveData，这里我们简单看下它的源码：\n\n``` java\n@MainThread                                                                                       \npublic <S> void addSource(@NonNull LiveData<S> source, @NonNull Observer<? super S> onChanged) {  \n    Source<S> e = new Source<>(source, onChanged);                                                \n    Source<?> existing = mSources.putIfAbsent(source, e);                                         \n    if (existing != null && existing.mObserver != onChanged) {                                    \n        throw new IllegalArgumentException(                                                       \n                \"This source was already added with the different observer\");                     \n    }                                                                                             \n    if (existing != null) {                                                                       \n        return;                                                                                   \n    }                                                                                             \n    if (hasActiveObservers()) { \n        // 存在活动的 observer，开始监听 source livedata\n        e.plug();                                                                                 \n    }                                                                                             \n}                                                                                                 \n\n@MainThread                                                     \npublic <S> void removeSource(@NonNull LiveData<S> toRemote) {   \n    Source<?> source = mSources.remove(toRemote);               \n    if (source != null) { \n        // 删除监听\t\n        source.unplug();                                        \n    }                                                           \n}                                                               \n\n@CallSuper                                                         \n@Override                                                          \nprotected void onActive() {                                        \n    for (Map.Entry<LiveData<?>, Source<?>> source : mSources) { \n        // 重新监听\n        source.getValue().plug();                                  \n    }                                                              \n}                                                                  \n                                                                   \n@CallSuper                                                         \n@Override                                                          \nprotected void onInactive() {                                      \n    for (Map.Entry<LiveData<?>, Source<?>> source : mSources) {\n        // 暂时删除监听\n        source.getValue().unplug();                                \n    }                                                              \n}                                                                  \n\nprivate static class Source<V> implements Observer<V> {                    \n    final LiveData<V> mLiveData;                                           \n    final Observer<? super V> mObserver;                                   \n    int mVersion = START_VERSION;                                          \n                                                                           \n    Source(LiveData<V> liveData, final Observer<? super V> observer) {     \n        mLiveData = liveData;                                              \n        mObserver = observer;                                              \n    }                                                                      \n                                                                           \n    void plug() { \n        // 这里可以使用 observeForever，因为会在 onActive 和 onInactive 两个方法中处理，能响应页面的生命周期\n        mLiveData.observeForever(this);                                    \n    }                                                                      \n                                                                           \n    void unplug() {                                                        \n        mLiveData.removeObserver(this);                                    \n    }                                                                      \n                                                                           \n    @Override                                                              \n    public void onChanged(@Nullable V v) {                                 \n        if (mVersion != mLiveData.getVersion()) {                          \n            mVersion = mLiveData.getVersion();                             \n            mObserver.onChanged(v);                                        \n        }                                                                  \n    }                                                                      \n}                                                                          \n```\n\n### 总结\n\nLiveData 可以算是 RxJava 的简化版本，它最大的好处就是和 Lifecycle 结合起来使用，不需要手动处理监听。第二个是，将数据分发操作封闭在主线程，减少线程同步锁的损耗，更适合 Android 日常开发场景。","source":"_posts/Jetpack中的LiveData.md","raw":"---\ntitle: Jetpack中的LiveData\ndate: 2019-02-05 14:54:08\ncategories: Android\ntags: Jetpack\n---\n\n### 关于LiveData\n\n`LiveData` 是一种可观察的数据持有类，下面是常用的写法：\n\n``` kotlin\nclass DataViewModel(application: Application) : AndroidViewModel(application) {\n\n    val dataSource: LiveData<String> = MutableLiveData()\n\n    fun postValue(text: String? = \"Hello World\") {\n        (dataSource as MutableLiveData).postValue(text)\n    }\n}\n\nviewModel.dataSource.observe(this, object : Observer<String> {\n\n            override fun onChanged(t: String?) {\n                println(\"onChange: ${t}\")\n            }\n\n})\n```\n\n一般情况下，`LiveData` 和 `ViewModel` 都是搭配使用的，可以在 `Activity` 和 `Fragment` 范围内提供复用，并处理因配置发生改变，而重建的情况。\n\n> 关于 `ViewModel` 更详细的理解，可以阅读之前的文章：[Jetpack中的ViewModel](https://linxiaotao.github.io/2019/01/05/Jetpack%E4%B8%AD%E7%9A%84ViewModel/)\n\n如果了解过 [RxJava](https://github.com/ReactiveX/RxJava) 的同学，对这种**观察者**的设计模式应该有点了解，`LiveData` 也是同样的思想，不过和 RxJava 不同的是：`LiveData` 使用 `Lifecycle` 将数据源和 `Activity` 和 `Fragment` 的生命周期结合起来，避免内存泄漏等情况。这个特性也是本文的重点。\n\n> 关于 Lifecycle 更详细的理解，可以阅读之前的文章：[Jetpack中的Lifecycle](https://linxiaotao.github.io/2019/01/14/Jetpack%E4%B8%AD%E7%9A%84Lifecycle/)\n\n建议在阅读以下内容时，先理解下 `Lifecycle`，因为 `LiveData` 能感应 `Activity` 和 `Fragment` 的生命周期就是基于 `Lifecycle` 实现的。\n\n### 源码解析\n\n#### 各个模块的作用\n\n在理解源码之前，我们先理清组成 `LiveData` 各个模块的作用。\n\n##### LiveData\n\n`LiveData` 表示一个可观察的数据源。在 `LiveData` 的设计中，它被设计为一个纯粹的数据源，对外只提供了：\n\n* observe(LifecycleOwner,Observer)\n\n  表示注册一个观察者（`Observer`），这里同时需要提供一个 `LifecycleOwner` 用于提供 `Lifecycle`\n\n* observeForever(Observer)\n\n  功能和 `observe(LifecycleOwner,Observer)` 类似，但缺少感应生命周期的功能\n\n* removeObserver(Observer) 和 removeObservers(LifecycleOwner)\n\n  表示删除观察者，后者则是删除同个 `LifecycleOwner` 范围的 `Observer`\n\n* getValue()\n\n  表示获取当前值\n\n* hasObservers()\n\n  表示是否存在 `Observer`\n\n* hasActiveObservers()\n\n  表示是否存在活动的 `Observer`，至于怎么去定义为活动的，后面会讲到\n\n`LiveData` 是一个纯粹的数据源，不包含添加数据的公开 API，只能通过使用 `MutableLiveData` 去添加数据\n\n> 这是一种不错的设计理念，单个组件功能越纯粹，代码的耦合度就越低。\n\n##### Observer\n\n`Observer` 表示观察者，响应数据发生变化。API 也非常简单：`onChange(T)`，这里需要注意的是：`onChange()` 中数据可以为 `NULL`，这和 `RxJava2` 的设计是不一样的，这个很难说，哪个设计更优。但根据 [JakeWharton](https://github.com/JakeWharton) 的回答是：It's not RxJava's choice, it's in the reactive streams spec.\n\n> 关于 `RxJava2` 不能传递 `NULL` 的讨论，可以参考这篇[文章](https://github.com/ReactiveX/RxJava/issues/4644)\n\n#### observe\n\n调用 `LiveData.observe(LifecycleOwner,Observer)` 去注册一个订阅者：\n\n``` java\n@MainThread                                                                                 \npublic void observe(@NonNull LifecycleOwner owner, @NonNull Observer<? super T> observer) {\n    // 注意，只能主线程调用\n    assertMainThread(\"observe\");                                                            \n    if (owner.getLifecycle().getCurrentState() == DESTROYED) {                              \n        // ignore                                                                           \n        return;                                                                             \n    }\n    // 使用 LifecycleBoundObserver 包装类\n    LifecycleBoundObserver wrapper = new LifecycleBoundObserver(owner, observer);\n    // mObservers 为 Map<Observer,ObserverWrapper>\n    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);                   \n    if (existing != null && !existing.isAttachedTo(owner)) {\n        // 存在不同 LifecycleOwner 但相同 observer，抛异常\n        throw new IllegalArgumentException(\"Cannot add the same observer\"                   \n                + \" with different lifecycles\");                                            \n    }                                                                                       \n    if (existing != null) {                                                                 \n        return;                                                                             \n    }                                                                                       \n    owner.getLifecycle().addObserver(wrapper);                                              \n}\n\n// LifecycleBoundObserver\n@Override                                     \nboolean isAttachedTo(LifecycleOwner owner) {  \n    return mOwner == owner;                   \n}                                             \n```\n\n`LifecycleBoundObserver` 实现了 `GenericLifecycleObserver` 接口，用于响应 `Activity` 和 `Fragment` 的生命周期\n\n``` java\nclass LifecycleBoundObserver extends ObserverWrapper implements GenericLifecycleObserver {   \n    @NonNull                                                                                 \n    final LifecycleOwner mOwner;                                                             \n                                                                                             \n    LifecycleBoundObserver(@NonNull LifecycleOwner owner, Observer<? super T> observer) {    \n        super(observer);                                                                     \n        mOwner = owner;                                                                      \n    }                                                                                        \n                                                                                             \n    @Override                                                                                \n    boolean shouldBeActive() { \n        // 检测是否为活动状态\n        return mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);                   \n    }                                                                                        \n                                                                                             \n    @Override                                                                                \n    public void onStateChanged(LifecycleOwner source, Lifecycle.Event event) {               \n        if (mOwner.getLifecycle().getCurrentState() == DESTROYED) {\n            // DESTROYED 时移除 observer\n            removeObserver(mObserver);                                                       \n            return;                                                                          \n        }                                                                                    \n        activeStateChanged(shouldBeActive());                                                \n    }                                                                                        \n                                                                                             \n    @Override                                                                                \n    boolean isAttachedTo(LifecycleOwner owner) {\n        // 判断是否为同个 LifecycleOwner\n        return mOwner == owner;                                                              \n    }                                                                                        \n                                                                                             \n    @Override                                                                                \n    void detachObserver() {\n        // 1.removeObserver\n        // 2. lifecycle state 没有在 started 之后，或者已经是 destoryed\n        // 以上两种情况会调用 detachObserver\n        // 从 Lifecycle 中移除 observer\n        mOwner.getLifecycle().removeObserver(this);                                          \n    }                                                                                        \n} \n\nprivate abstract class ObserverWrapper {                                             \n    final Observer<? super T> mObserver;                                             \n    boolean mActive;                                                                 \n    int mLastVersion = START_VERSION;                                                \n                                                                                     \n    ObserverWrapper(Observer<? super T> observer) {                                  \n        mObserver = observer;                                                        \n    }                                                                                \n                                                                                     \n    abstract boolean shouldBeActive();                                               \n                                                                                     \n    boolean isAttachedTo(LifecycleOwner owner) {                                     \n        return false;                                                                \n    }                                                                                \n                                                                                     \n    void detachObserver() {                                                          \n    }                                                                                \n                                                                                     \n    void activeStateChanged(boolean newActive) {\n        // 当活动状态发生变化时\n        if (newActive == mActive) {                                                  \n            return;                                                                  \n        }                                                                            \n        // immediately set active state, so we'd never dispatch anything to inactive \n        // owner                                                                     \n        mActive = newActive;\n        // 是否为不活动状态\n        boolean wasInactive = LiveData.this.mActiveCount == 0; \n        // 当前活动个数统计\n        LiveData.this.mActiveCount += mActive ? 1 : -1;                              \n        if (wasInactive && mActive) {\n            // 不活动 -> 活动\n            onActive();                                                              \n        }                                                                            \n        if (LiveData.this.mActiveCount == 0 && !mActive) {\n            // 活动 -> 不活动\n            onInactive();                                                            \n        }                                                                            \n        if (mActive) { \n            // 当前为活动状态，分发当前 observer\n            dispatchingValue(this);                                                  \n        }                                                                            \n    }                                                                                \n}                                                                                    \n```\n\n当调用 `observe()` 会根据当前是否为活跃状态，分发当前值。\n\n#### postValue 和 setValue\n\n当在非主线程调用时，使用 `postValue()`，相关源码如下：\n\n``` java\nprotected void postValue(T value) {                                       \n    boolean postTask;                                                     \n    synchronized (mDataLock) {\n        // 当前是否存在需要分发的值\n        postTask = mPendingData == NOT_SET;  \n        // 多次调用，只会分发最后一次的值\n        mPendingData = value;                                             \n    }                                                                     \n    if (!postTask) {\n        // 已存在正在分发的任务\n        return;                                                           \n    }                                                                     \n    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);  \n}\n```\n\n这里需要注意的是，当分发数据的任务还没结束时，多次调用 `postValue` 只会分发最后一次的值，同一时间只会存在一个 `PostValueRunnable`\n\n``` java\nprivate final Runnable mPostValueRunnable = new Runnable() { \n    @Override                                                \n    public void run() {                                      \n        Object newValue;                                     \n        synchronized (mDataLock) {                           \n            newValue = mPendingData; \n            // 设置为 NOT_SET\n            mPendingData = NOT_SET;                          \n        }                                                    \n        //noinspection unchecked \n        // 再调用 setValue\n        setValue((T) newValue);                              \n    }                                                        \n}; \n\n@MainThread                                         \nprotected void setValue(T value) {\n    // 只能在主线程调用\n    assertMainThread(\"setValue\"); \n    // 使用 version 记录\n    mVersion++; \n    // 当前值\n    mData = value;  \n    // 分发\n    dispatchingValue(null);                         \n} \n\nvoid dispatchingValue(@Nullable ObserverWrapper initiator) {                           \n    if (mDispatchingValue) {\n        // 正在分发中\n        mDispatchInvalidated = true;                                                   \n        return;                                                                        \n    }                                                                                  \n    mDispatchingValue = true;                                                          \n    do {                                                                               \n        mDispatchInvalidated = false;                                                  \n        if (initiator != null) {\n            // 初始分发\n            considerNotify(initiator);                                                 \n            initiator = null;                                                          \n        } else {\n            // 升序迭代，调用 considerNotify\n            for (Iterator<Map.Entry<Observer<? super T>, ObserverWrapper>> iterator =  \n                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) {        \n                considerNotify(iterator.next().getValue());                            \n                if (mDispatchInvalidated) {\n                    // 分发过程中，有新的数据需要分发\n                    break;                                                             \n                }                                                                      \n            }                                                                          \n        }                                                                              \n    } while (mDispatchInvalidated);                                                    \n    mDispatchingValue = false;                                                         \n}                                                                                      \n```\n\n如果有阅读过 [Jetpack中的Lifecycle](https://linxiaotao.github.io/2019/01/14/Jetpack%E4%B8%AD%E7%9A%84Lifecycle/) 这篇文章的话，可以很快看出，分发值的处理和 `Lifecycle` 有类似的地方，即在分发过程中，有新的值开始分发这种 case，都是采用中断当前的分发，推迟到下一次遍历时，分发新的值。\n\n``` java\nprivate void considerNotify(ObserverWrapper observer) {                                         \n    if (!observer.mActive) { \n        // 当前 observer 为非活动状态\n        return;                                                                                 \n    }                                                                                           \n    // Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.  \n    //                                                                                          \n    // we still first check observer.active to keep it as the entrance for events. So even if   \n    // the observer moved to an active state, if we've not received that event, we better not   \n    // notify for a more predictable notification order.\n    // 可能存在已经是非活动状态，但没有接收到的 case\n    // 检测是否为活动状态\n    if (!observer.shouldBeActive()) {\n        // 非活动状态，mActive 和 shouldBeActive 不一致，通知 activeStateChanged\n        observer.activeStateChanged(false);                                                     \n        return;                                                                                 \n    }                                                                                           \n    if (observer.mLastVersion >= mVersion) { \n        // 当重新变为活动状态时，会分发当前值，避免重复值\n        return;                                                                                 \n    }                                                                                           \n    observer.mLastVersion = mVersion;                                                           \n    //noinspection unchecked                                                                    \n    observer.mObserver.onChanged((T) mData);                                                    \n}                                                                                               \n```\n\n需要注意的是，`setValue` 和 `postValue` 方法都是 `protected`，所以当我们想实现一个 LiveData 时，需要使用 MutableLiveData，源码很简单，就是将这两个方法修改为 `public`。\n\n> 这种实现思路有利于数据的不可变性。上游使用 MutableLiveData 分发数据，下游使用 LiveData 消费数据。\n\n如果使用过 RxJava 类似库的同学可能会觉得跟 LiveData 很像，同样是监听者模式。不一样的是，RxJava 提供了很多操作符，类似 `map`、`zip` 等，还有线程调度的 `observeOn` 和 `subscribeOn`。LiveData 没有线程调度的功能，它数据分发只在主线程上进行，没有线程锁等开销。除此之前，LiveData 只提供了 `map` 和 `switchMap` 的实现，但提供了 `MediatorLiveData` 去实现自己需要的操作符。\n\n#### Transformations\n\nTransformations 中有 `map` 和 `switchMap` 的实现。\n\n``` java\n@MainThread  \npublic static <X, Y> LiveData<Y> map(                              \n        @NonNull LiveData<X> source,                               \n        @NonNull final Function<X, Y> mapFunction) {\n    final MediatorLiveData<Y> result = new MediatorLiveData<>();   \n    result.addSource(source, new Observer<X>() {                   \n        @Override                                                  \n        public void onChanged(@Nullable X x) {\n            // 对源数据进行转化\n            result.setValue(mapFunction.apply(x));                 \n        }                                                          \n    });                                                            \n    return result;                                                 \n} \n\n@MainThread  \npublic static <X, Y> LiveData<Y> switchMap(                            \n        @NonNull LiveData<X> source,                                   \n        @NonNull final Function<X, LiveData<Y>> switchMapFunction) {   \n    final MediatorLiveData<Y> result = new MediatorLiveData<>();       \n    result.addSource(source, new Observer<X>() {                       \n        LiveData<Y> mSource;                                           \n                                                                       \n        @Override                                                      \n        public void onChanged(@Nullable X x) {\n            // 将发射出来的每个数据都转换成新的 LiveData，再接收\n            LiveData<Y> newLiveData = switchMapFunction.apply(x);      \n            if (mSource == newLiveData) {                              \n                return;                                                \n            }                                                          \n            if (mSource != null) {                                     \n                result.removeSource(mSource);                          \n            }                                                          \n            mSource = newLiveData;                                     \n            if (mSource != null) {                                     \n                result.addSource(mSource, new Observer<Y>() {          \n                    @Override                                          \n                    public void onChanged(@Nullable Y y) {             \n                        result.setValue(y);                            \n                    }                                                  \n                });                                                    \n            }                                                          \n        }                                                              \n    });                                                                \n    return result;                                                     \n}                                                                      \n```\n\nMediatorLiveData 可以监听多个 LiveData，这里我们简单看下它的源码：\n\n``` java\n@MainThread                                                                                       \npublic <S> void addSource(@NonNull LiveData<S> source, @NonNull Observer<? super S> onChanged) {  \n    Source<S> e = new Source<>(source, onChanged);                                                \n    Source<?> existing = mSources.putIfAbsent(source, e);                                         \n    if (existing != null && existing.mObserver != onChanged) {                                    \n        throw new IllegalArgumentException(                                                       \n                \"This source was already added with the different observer\");                     \n    }                                                                                             \n    if (existing != null) {                                                                       \n        return;                                                                                   \n    }                                                                                             \n    if (hasActiveObservers()) { \n        // 存在活动的 observer，开始监听 source livedata\n        e.plug();                                                                                 \n    }                                                                                             \n}                                                                                                 \n\n@MainThread                                                     \npublic <S> void removeSource(@NonNull LiveData<S> toRemote) {   \n    Source<?> source = mSources.remove(toRemote);               \n    if (source != null) { \n        // 删除监听\t\n        source.unplug();                                        \n    }                                                           \n}                                                               \n\n@CallSuper                                                         \n@Override                                                          \nprotected void onActive() {                                        \n    for (Map.Entry<LiveData<?>, Source<?>> source : mSources) { \n        // 重新监听\n        source.getValue().plug();                                  \n    }                                                              \n}                                                                  \n                                                                   \n@CallSuper                                                         \n@Override                                                          \nprotected void onInactive() {                                      \n    for (Map.Entry<LiveData<?>, Source<?>> source : mSources) {\n        // 暂时删除监听\n        source.getValue().unplug();                                \n    }                                                              \n}                                                                  \n\nprivate static class Source<V> implements Observer<V> {                    \n    final LiveData<V> mLiveData;                                           \n    final Observer<? super V> mObserver;                                   \n    int mVersion = START_VERSION;                                          \n                                                                           \n    Source(LiveData<V> liveData, final Observer<? super V> observer) {     \n        mLiveData = liveData;                                              \n        mObserver = observer;                                              \n    }                                                                      \n                                                                           \n    void plug() { \n        // 这里可以使用 observeForever，因为会在 onActive 和 onInactive 两个方法中处理，能响应页面的生命周期\n        mLiveData.observeForever(this);                                    \n    }                                                                      \n                                                                           \n    void unplug() {                                                        \n        mLiveData.removeObserver(this);                                    \n    }                                                                      \n                                                                           \n    @Override                                                              \n    public void onChanged(@Nullable V v) {                                 \n        if (mVersion != mLiveData.getVersion()) {                          \n            mVersion = mLiveData.getVersion();                             \n            mObserver.onChanged(v);                                        \n        }                                                                  \n    }                                                                      \n}                                                                          \n```\n\n### 总结\n\nLiveData 可以算是 RxJava 的简化版本，它最大的好处就是和 Lifecycle 结合起来使用，不需要手动处理监听。第二个是，将数据分发操作封闭在主线程，减少线程同步锁的损耗，更适合 Android 日常开发场景。","slug":"Jetpack中的LiveData","published":1,"updated":"2022-06-15T11:19:32.320Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlv000rfho619rucoth","content":"<h3 id=\"关于LiveData\"><a href=\"#关于LiveData\" class=\"headerlink\" title=\"关于LiveData\"></a>关于LiveData</h3><p><code>LiveData</code> 是一种可观察的数据持有类，下面是常用的写法：</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DataViewModel</span></span>(application: Application) : AndroidViewModel(application) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">val</span> dataSource: LiveData&lt;String&gt; = MutableLiveData()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">postValue</span><span class=\"params\">(text: <span class=\"type\">String</span>? = <span class=\"string\">&quot;Hello World&quot;</span>)</span></span> &#123;</span><br><span class=\"line\">        (dataSource <span class=\"keyword\">as</span> MutableLiveData).postValue(text)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">viewModel.dataSource.observe(<span class=\"keyword\">this</span>, <span class=\"keyword\">object</span> : Observer&lt;String&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">onChanged</span><span class=\"params\">(t: <span class=\"type\">String</span>?)</span></span> &#123;</span><br><span class=\"line\">                println(<span class=\"string\">&quot;onChange: <span class=\"subst\">$&#123;t&#125;</span>&quot;</span>)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>一般情况下，<code>LiveData</code> 和 <code>ViewModel</code> 都是搭配使用的，可以在 <code>Activity</code> 和 <code>Fragment</code> 范围内提供复用，并处理因配置发生改变，而重建的情况。</p>\n<blockquote>\n<p>关于 <code>ViewModel</code> 更详细的理解，可以阅读之前的文章：<a href=\"https://linxiaotao.github.io/2019/01/05/Jetpack%E4%B8%AD%E7%9A%84ViewModel/\">Jetpack中的ViewModel</a></p>\n</blockquote>\n<p>如果了解过 <a href=\"https://github.com/ReactiveX/RxJava\">RxJava</a> 的同学，对这种<strong>观察者</strong>的设计模式应该有点了解，<code>LiveData</code> 也是同样的思想，不过和 RxJava 不同的是：<code>LiveData</code> 使用 <code>Lifecycle</code> 将数据源和 <code>Activity</code> 和 <code>Fragment</code> 的生命周期结合起来，避免内存泄漏等情况。这个特性也是本文的重点。</p>\n<blockquote>\n<p>关于 Lifecycle 更详细的理解，可以阅读之前的文章：<a href=\"https://linxiaotao.github.io/2019/01/14/Jetpack%E4%B8%AD%E7%9A%84Lifecycle/\">Jetpack中的Lifecycle</a></p>\n</blockquote>\n<p>建议在阅读以下内容时，先理解下 <code>Lifecycle</code>，因为 <code>LiveData</code> 能感应 <code>Activity</code> 和 <code>Fragment</code> 的生命周期就是基于 <code>Lifecycle</code> 实现的。</p>\n<h3 id=\"源码解析\"><a href=\"#源码解析\" class=\"headerlink\" title=\"源码解析\"></a>源码解析</h3><h4 id=\"各个模块的作用\"><a href=\"#各个模块的作用\" class=\"headerlink\" title=\"各个模块的作用\"></a>各个模块的作用</h4><p>在理解源码之前，我们先理清组成 <code>LiveData</code> 各个模块的作用。</p>\n<h5 id=\"LiveData\"><a href=\"#LiveData\" class=\"headerlink\" title=\"LiveData\"></a>LiveData</h5><p><code>LiveData</code> 表示一个可观察的数据源。在 <code>LiveData</code> 的设计中，它被设计为一个纯粹的数据源，对外只提供了：</p>\n<ul>\n<li><p>observe(LifecycleOwner,Observer)</p>\n<p>表示注册一个观察者（<code>Observer</code>），这里同时需要提供一个 <code>LifecycleOwner</code> 用于提供 <code>Lifecycle</code></p>\n</li>\n<li><p>observeForever(Observer)</p>\n<p>功能和 <code>observe(LifecycleOwner,Observer)</code> 类似，但缺少感应生命周期的功能</p>\n</li>\n<li><p>removeObserver(Observer) 和 removeObservers(LifecycleOwner)</p>\n<p>表示删除观察者，后者则是删除同个 <code>LifecycleOwner</code> 范围的 <code>Observer</code></p>\n</li>\n<li><p>getValue()</p>\n<p>表示获取当前值</p>\n</li>\n<li><p>hasObservers()</p>\n<p>表示是否存在 <code>Observer</code></p>\n</li>\n<li><p>hasActiveObservers()</p>\n<p>表示是否存在活动的 <code>Observer</code>，至于怎么去定义为活动的，后面会讲到</p>\n</li>\n</ul>\n<p><code>LiveData</code> 是一个纯粹的数据源，不包含添加数据的公开 API，只能通过使用 <code>MutableLiveData</code> 去添加数据</p>\n<blockquote>\n<p>这是一种不错的设计理念，单个组件功能越纯粹，代码的耦合度就越低。</p>\n</blockquote>\n<h5 id=\"Observer\"><a href=\"#Observer\" class=\"headerlink\" title=\"Observer\"></a>Observer</h5><p><code>Observer</code> 表示观察者，响应数据发生变化。API 也非常简单：<code>onChange(T)</code>，这里需要注意的是：<code>onChange()</code> 中数据可以为 <code>NULL</code>，这和 <code>RxJava2</code> 的设计是不一样的，这个很难说，哪个设计更优。但根据 <a href=\"https://github.com/JakeWharton\">JakeWharton</a> 的回答是：It’s not RxJava’s choice, it’s in the reactive streams spec.</p>\n<blockquote>\n<p>关于 <code>RxJava2</code> 不能传递 <code>NULL</code> 的讨论，可以参考这篇<a href=\"https://github.com/ReactiveX/RxJava/issues/4644\">文章</a></p>\n</blockquote>\n<h4 id=\"observe\"><a href=\"#observe\" class=\"headerlink\" title=\"observe\"></a>observe</h4><p>调用 <code>LiveData.observe(LifecycleOwner,Observer)</code> 去注册一个订阅者：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                                                 </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">observe</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> LifecycleOwner owner, <span class=\"meta\">@NonNull</span> Observer&lt;? <span class=\"built_in\">super</span> T&gt; observer)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 注意，只能主线程调用</span></span><br><span class=\"line\">    assertMainThread(<span class=\"string\">&quot;observe&quot;</span>);                                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;                              </span><br><span class=\"line\">        <span class=\"comment\">// ignore                                                                           </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                             </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 使用 LifecycleBoundObserver 包装类</span></span><br><span class=\"line\">    <span class=\"type\">LifecycleBoundObserver</span> <span class=\"variable\">wrapper</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">LifecycleBoundObserver</span>(owner, observer);</span><br><span class=\"line\">    <span class=\"comment\">// mObservers 为 Map&lt;Observer,ObserverWrapper&gt;</span></span><br><span class=\"line\">    <span class=\"type\">ObserverWrapper</span> <span class=\"variable\">existing</span> <span class=\"operator\">=</span> mObservers.putIfAbsent(observer, wrapper);                   </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (existing != <span class=\"literal\">null</span> &amp;&amp; !existing.isAttachedTo(owner)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 存在不同 LifecycleOwner 但相同 observer，抛异常</span></span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Cannot add the same observer&quot;</span>                   </span><br><span class=\"line\">                + <span class=\"string\">&quot; with different lifecycles&quot;</span>);                                            </span><br><span class=\"line\">    &#125;                                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (existing != <span class=\"literal\">null</span>) &#123;                                                                 </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                             </span><br><span class=\"line\">    &#125;                                                                                       </span><br><span class=\"line\">    owner.getLifecycle().addObserver(wrapper);                                              </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// LifecycleBoundObserver</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                     </span><br><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"title function_\">isAttachedTo</span><span class=\"params\">(LifecycleOwner owner)</span> &#123;  </span><br><span class=\"line\">    <span class=\"type\">return</span> <span class=\"variable\">mOwner</span> <span class=\"operator\">=</span>= owner;                   </span><br><span class=\"line\">&#125;                                             </span><br></pre></td></tr></table></figure>\n\n<p><code>LifecycleBoundObserver</code> 实现了 <code>GenericLifecycleObserver</code> 接口，用于响应 <code>Activity</code> 和 <code>Fragment</code> 的生命周期</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">LifecycleBoundObserver</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ObserverWrapper</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">GenericLifecycleObserver</span> &#123;   </span><br><span class=\"line\">    <span class=\"meta\">@NonNull</span>                                                                                 </span><br><span class=\"line\">    <span class=\"keyword\">final</span> LifecycleOwner mOwner;                                                             </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    LifecycleBoundObserver(<span class=\"meta\">@NonNull</span> LifecycleOwner owner, Observer&lt;? <span class=\"built_in\">super</span> T&gt; observer) &#123;    </span><br><span class=\"line\">        <span class=\"built_in\">super</span>(observer);                                                                     </span><br><span class=\"line\">        mOwner = owner;                                                                      </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                                </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">shouldBeActive</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 检测是否为活动状态</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);                   </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onStateChanged</span><span class=\"params\">(LifecycleOwner source, Lifecycle.Event event)</span> &#123;               </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mOwner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// DESTROYED 时移除 observer</span></span><br><span class=\"line\">            removeObserver(mObserver);                                                       </span><br><span class=\"line\">            <span class=\"keyword\">return</span>;                                                                          </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        activeStateChanged(shouldBeActive());                                                </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                                </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isAttachedTo</span><span class=\"params\">(LifecycleOwner owner)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 判断是否为同个 LifecycleOwner</span></span><br><span class=\"line\">        <span class=\"type\">return</span> <span class=\"variable\">mOwner</span> <span class=\"operator\">=</span>= owner;                                                              </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">detachObserver</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 1.removeObserver</span></span><br><span class=\"line\">        <span class=\"comment\">// 2. lifecycle state 没有在 started 之后，或者已经是 destoryed</span></span><br><span class=\"line\">        <span class=\"comment\">// 以上两种情况会调用 detachObserver</span></span><br><span class=\"line\">        <span class=\"comment\">// 从 Lifecycle 中移除 observer</span></span><br><span class=\"line\">        mOwner.getLifecycle().removeObserver(<span class=\"built_in\">this</span>);                                          </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ObserverWrapper</span> &#123;                                             </span><br><span class=\"line\">    <span class=\"keyword\">final</span> Observer&lt;? <span class=\"built_in\">super</span> T&gt; mObserver;                                             </span><br><span class=\"line\">    <span class=\"type\">boolean</span> mActive;                                                                 </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">mLastVersion</span> <span class=\"operator\">=</span> START_VERSION;                                                </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">    ObserverWrapper(Observer&lt;? <span class=\"built_in\">super</span> T&gt; observer) &#123;                                  </span><br><span class=\"line\">        mObserver = observer;                                                        </span><br><span class=\"line\">    &#125;                                                                                </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">abstract</span> <span class=\"type\">boolean</span> <span class=\"title function_\">shouldBeActive</span><span class=\"params\">()</span>;                                               </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isAttachedTo</span><span class=\"params\">(LifecycleOwner owner)</span> &#123;                                     </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;                                                                </span><br><span class=\"line\">    &#125;                                                                                </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">detachObserver</span><span class=\"params\">()</span> &#123;                                                          </span><br><span class=\"line\">    &#125;                                                                                </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">activeStateChanged</span><span class=\"params\">(<span class=\"type\">boolean</span> newActive)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当活动状态发生变化时</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newActive == mActive) &#123;                                                  </span><br><span class=\"line\">            <span class=\"keyword\">return</span>;                                                                  </span><br><span class=\"line\">        &#125;                                                                            </span><br><span class=\"line\">        <span class=\"comment\">// immediately set active state, so we&#x27;d never dispatch anything to inactive </span></span><br><span class=\"line\">        <span class=\"comment\">// owner                                                                     </span></span><br><span class=\"line\">        mActive = newActive;</span><br><span class=\"line\">        <span class=\"comment\">// 是否为不活动状态</span></span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">wasInactive</span> <span class=\"operator\">=</span> LiveData.<span class=\"built_in\">this</span>.mActiveCount == <span class=\"number\">0</span>; </span><br><span class=\"line\">        <span class=\"comment\">// 当前活动个数统计</span></span><br><span class=\"line\">        LiveData.<span class=\"built_in\">this</span>.mActiveCount += mActive ? <span class=\"number\">1</span> : -<span class=\"number\">1</span>;                              </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (wasInactive &amp;&amp; mActive) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 不活动 -&gt; 活动</span></span><br><span class=\"line\">            onActive();                                                              </span><br><span class=\"line\">        &#125;                                                                            </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (LiveData.<span class=\"built_in\">this</span>.mActiveCount == <span class=\"number\">0</span> &amp;&amp; !mActive) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 活动 -&gt; 不活动</span></span><br><span class=\"line\">            onInactive();                                                            </span><br><span class=\"line\">        &#125;                                                                            </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mActive) &#123; </span><br><span class=\"line\">            <span class=\"comment\">// 当前为活动状态，分发当前 observer</span></span><br><span class=\"line\">            dispatchingValue(<span class=\"built_in\">this</span>);                                                  </span><br><span class=\"line\">        &#125;                                                                            </span><br><span class=\"line\">    &#125;                                                                                </span><br><span class=\"line\">&#125;                                                                                    </span><br></pre></td></tr></table></figure>\n\n<p>当调用 <code>observe()</code> 会根据当前是否为活跃状态，分发当前值。</p>\n<h4 id=\"postValue-和-setValue\"><a href=\"#postValue-和-setValue\" class=\"headerlink\" title=\"postValue 和 setValue\"></a>postValue 和 setValue</h4><p>当在非主线程调用时，使用 <code>postValue()</code>，相关源码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">postValue</span><span class=\"params\">(T value)</span> &#123;                                       </span><br><span class=\"line\">    <span class=\"type\">boolean</span> postTask;                                                     </span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (mDataLock) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前是否存在需要分发的值</span></span><br><span class=\"line\">        postTask = mPendingData == NOT_SET;  </span><br><span class=\"line\">        <span class=\"comment\">// 多次调用，只会分发最后一次的值</span></span><br><span class=\"line\">        mPendingData = value;                                             </span><br><span class=\"line\">    &#125;                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!postTask) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 已存在正在分发的任务</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                           </span><br><span class=\"line\">    &#125;                                                                     </span><br><span class=\"line\">    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里需要注意的是，当分发数据的任务还没结束时，多次调用 <code>postValue</code> 只会分发最后一次的值，同一时间只会存在一个 <code>PostValueRunnable</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">Runnable</span> <span class=\"variable\">mPostValueRunnable</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123; </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;                                      </span><br><span class=\"line\">        Object newValue;                                     </span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (mDataLock) &#123;                           </span><br><span class=\"line\">            newValue = mPendingData; </span><br><span class=\"line\">            <span class=\"comment\">// 设置为 NOT_SET</span></span><br><span class=\"line\">            mPendingData = NOT_SET;                          </span><br><span class=\"line\">        &#125;                                                    </span><br><span class=\"line\">        <span class=\"comment\">//noinspection unchecked </span></span><br><span class=\"line\">        <span class=\"comment\">// 再调用 setValue</span></span><br><span class=\"line\">        setValue((T) newValue);                              </span><br><span class=\"line\">    &#125;                                                        </span><br><span class=\"line\">&#125;; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                         </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setValue</span><span class=\"params\">(T value)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 只能在主线程调用</span></span><br><span class=\"line\">    assertMainThread(<span class=\"string\">&quot;setValue&quot;</span>); </span><br><span class=\"line\">    <span class=\"comment\">// 使用 version 记录</span></span><br><span class=\"line\">    mVersion++; </span><br><span class=\"line\">    <span class=\"comment\">// 当前值</span></span><br><span class=\"line\">    mData = value;  </span><br><span class=\"line\">    <span class=\"comment\">// 分发</span></span><br><span class=\"line\">    dispatchingValue(<span class=\"literal\">null</span>);                         </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">dispatchingValue</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> ObserverWrapper initiator)</span> &#123;                           </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDispatchingValue) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 正在分发中</span></span><br><span class=\"line\">        mDispatchInvalidated = <span class=\"literal\">true</span>;                                                   </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                        </span><br><span class=\"line\">    &#125;                                                                                  </span><br><span class=\"line\">    mDispatchingValue = <span class=\"literal\">true</span>;                                                          </span><br><span class=\"line\">    <span class=\"keyword\">do</span> &#123;                                                                               </span><br><span class=\"line\">        mDispatchInvalidated = <span class=\"literal\">false</span>;                                                  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (initiator != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 初始分发</span></span><br><span class=\"line\">            considerNotify(initiator);                                                 </span><br><span class=\"line\">            initiator = <span class=\"literal\">null</span>;                                                          </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 升序迭代，调用 considerNotify</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class=\"built_in\">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =  </span><br><span class=\"line\">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;        </span><br><span class=\"line\">                considerNotify(iterator.next().getValue());                            </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (mDispatchInvalidated) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 分发过程中，有新的数据需要分发</span></span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                                                             </span><br><span class=\"line\">                &#125;                                                                      </span><br><span class=\"line\">            &#125;                                                                          </span><br><span class=\"line\">        &#125;                                                                              </span><br><span class=\"line\">    &#125; <span class=\"keyword\">while</span> (mDispatchInvalidated);                                                    </span><br><span class=\"line\">    mDispatchingValue = <span class=\"literal\">false</span>;                                                         </span><br><span class=\"line\">&#125;                                                                                      </span><br></pre></td></tr></table></figure>\n\n<p>如果有阅读过 <a href=\"https://linxiaotao.github.io/2019/01/14/Jetpack%E4%B8%AD%E7%9A%84Lifecycle/\">Jetpack中的Lifecycle</a> 这篇文章的话，可以很快看出，分发值的处理和 <code>Lifecycle</code> 有类似的地方，即在分发过程中，有新的值开始分发这种 case，都是采用中断当前的分发，推迟到下一次遍历时，分发新的值。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">considerNotify</span><span class=\"params\">(ObserverWrapper observer)</span> &#123;                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!observer.mActive) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 当前 observer 为非活动状态</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                 </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">    <span class=\"comment\">// Check latest state b4 dispatch. Maybe it changed state but we didn&#x27;t get the event yet.  </span></span><br><span class=\"line\">    <span class=\"comment\">//                                                                                          </span></span><br><span class=\"line\">    <span class=\"comment\">// we still first check observer.active to keep it as the entrance for events. So even if   </span></span><br><span class=\"line\">    <span class=\"comment\">// the observer moved to an active state, if we&#x27;ve not received that event, we better not   </span></span><br><span class=\"line\">    <span class=\"comment\">// notify for a more predictable notification order.</span></span><br><span class=\"line\">    <span class=\"comment\">// 可能存在已经是非活动状态，但没有接收到的 case</span></span><br><span class=\"line\">    <span class=\"comment\">// 检测是否为活动状态</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!observer.shouldBeActive()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 非活动状态，mActive 和 shouldBeActive 不一致，通知 activeStateChanged</span></span><br><span class=\"line\">        observer.activeStateChanged(<span class=\"literal\">false</span>);                                                     </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                 </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (observer.mLastVersion &gt;= mVersion) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 当重新变为活动状态时，会分发当前值，避免重复值</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                 </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">    observer.mLastVersion = mVersion;                                                           </span><br><span class=\"line\">    <span class=\"comment\">//noinspection unchecked                                                                    </span></span><br><span class=\"line\">    observer.mObserver.onChanged((T) mData);                                                    </span><br><span class=\"line\">&#125;                                                                                               </span><br></pre></td></tr></table></figure>\n\n<p>需要注意的是，<code>setValue</code> 和 <code>postValue</code> 方法都是 <code>protected</code>，所以当我们想实现一个 LiveData 时，需要使用 MutableLiveData，源码很简单，就是将这两个方法修改为 <code>public</code>。</p>\n<blockquote>\n<p>这种实现思路有利于数据的不可变性。上游使用 MutableLiveData 分发数据，下游使用 LiveData 消费数据。</p>\n</blockquote>\n<p>如果使用过 RxJava 类似库的同学可能会觉得跟 LiveData 很像，同样是监听者模式。不一样的是，RxJava 提供了很多操作符，类似 <code>map</code>、<code>zip</code> 等，还有线程调度的 <code>observeOn</code> 和 <code>subscribeOn</code>。LiveData 没有线程调度的功能，它数据分发只在主线程上进行，没有线程锁等开销。除此之前，LiveData 只提供了 <code>map</code> 和 <code>switchMap</code> 的实现，但提供了 <code>MediatorLiveData</code> 去实现自己需要的操作符。</p>\n<h4 id=\"Transformations\"><a href=\"#Transformations\" class=\"headerlink\" title=\"Transformations\"></a>Transformations</h4><p>Transformations 中有 <code>map</code> 和 <code>switchMap</code> 的实现。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@MainThread</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;X, Y&gt; LiveData&lt;Y&gt; <span class=\"title function_\">map</span><span class=\"params\">(                              </span></span><br><span class=\"line\"><span class=\"params\">        <span class=\"meta\">@NonNull</span> LiveData&lt;X&gt; source,                               </span></span><br><span class=\"line\"><span class=\"params\">        <span class=\"meta\">@NonNull</span> <span class=\"keyword\">final</span> Function&lt;X, Y&gt; mapFunction)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> MediatorLiveData&lt;Y&gt; result = <span class=\"keyword\">new</span> <span class=\"title class_\">MediatorLiveData</span>&lt;&gt;();   </span><br><span class=\"line\">    result.addSource(source, <span class=\"keyword\">new</span> <span class=\"title class_\">Observer</span>&lt;X&gt;() &#123;                   </span><br><span class=\"line\">        <span class=\"meta\">@Override</span>                                                  </span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onChanged</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> X x)</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 对源数据进行转化</span></span><br><span class=\"line\">            result.setValue(mapFunction.apply(x));                 </span><br><span class=\"line\">        &#125;                                                          </span><br><span class=\"line\">    &#125;);                                                            </span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;                                                 </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;X, Y&gt; LiveData&lt;Y&gt; <span class=\"title function_\">switchMap</span><span class=\"params\">(                            </span></span><br><span class=\"line\"><span class=\"params\">        <span class=\"meta\">@NonNull</span> LiveData&lt;X&gt; source,                                   </span></span><br><span class=\"line\"><span class=\"params\">        <span class=\"meta\">@NonNull</span> <span class=\"keyword\">final</span> Function&lt;X, LiveData&lt;Y&gt;&gt; switchMapFunction)</span> &#123;   </span><br><span class=\"line\">    <span class=\"keyword\">final</span> MediatorLiveData&lt;Y&gt; result = <span class=\"keyword\">new</span> <span class=\"title class_\">MediatorLiveData</span>&lt;&gt;();       </span><br><span class=\"line\">    result.addSource(source, <span class=\"keyword\">new</span> <span class=\"title class_\">Observer</span>&lt;X&gt;() &#123;                       </span><br><span class=\"line\">        LiveData&lt;Y&gt; mSource;                                           </span><br><span class=\"line\">                                                                       </span><br><span class=\"line\">        <span class=\"meta\">@Override</span>                                                      </span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onChanged</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> X x)</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 将发射出来的每个数据都转换成新的 LiveData，再接收</span></span><br><span class=\"line\">            LiveData&lt;Y&gt; newLiveData = switchMapFunction.apply(x);      </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mSource == newLiveData) &#123;                              </span><br><span class=\"line\">                <span class=\"keyword\">return</span>;                                                </span><br><span class=\"line\">            &#125;                                                          </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mSource != <span class=\"literal\">null</span>) &#123;                                     </span><br><span class=\"line\">                result.removeSource(mSource);                          </span><br><span class=\"line\">            &#125;                                                          </span><br><span class=\"line\">            mSource = newLiveData;                                     </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mSource != <span class=\"literal\">null</span>) &#123;                                     </span><br><span class=\"line\">                result.addSource(mSource, <span class=\"keyword\">new</span> <span class=\"title class_\">Observer</span>&lt;Y&gt;() &#123;          </span><br><span class=\"line\">                    <span class=\"meta\">@Override</span>                                          </span><br><span class=\"line\">                    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onChanged</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> Y y)</span> &#123;             </span><br><span class=\"line\">                        result.setValue(y);                            </span><br><span class=\"line\">                    &#125;                                                  </span><br><span class=\"line\">                &#125;);                                                    </span><br><span class=\"line\">            &#125;                                                          </span><br><span class=\"line\">        &#125;                                                              </span><br><span class=\"line\">    &#125;);                                                                </span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;                                                     </span><br><span class=\"line\">&#125;                                                                      </span><br></pre></td></tr></table></figure>\n\n<p>MediatorLiveData 可以监听多个 LiveData，这里我们简单看下它的源码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">public</span> &lt;S&gt; <span class=\"keyword\">void</span> <span class=\"title function_\">addSource</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> LiveData&lt;S&gt; source, <span class=\"meta\">@NonNull</span> Observer&lt;? <span class=\"built_in\">super</span> S&gt; onChanged)</span> &#123;  </span><br><span class=\"line\">    Source&lt;S&gt; e = <span class=\"keyword\">new</span> <span class=\"title class_\">Source</span>&lt;&gt;(source, onChanged);                                                </span><br><span class=\"line\">    Source&lt;?&gt; existing = mSources.putIfAbsent(source, e);                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (existing != <span class=\"literal\">null</span> &amp;&amp; existing.mObserver != onChanged) &#123;                                    </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(                                                       </span><br><span class=\"line\">                <span class=\"string\">&quot;This source was already added with the different observer&quot;</span>);                     </span><br><span class=\"line\">    &#125;                                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (existing != <span class=\"literal\">null</span>) &#123;                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                   </span><br><span class=\"line\">    &#125;                                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasActiveObservers()) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 存在活动的 observer，开始监听 source livedata</span></span><br><span class=\"line\">        e.plug();                                                                                 </span><br><span class=\"line\">    &#125;                                                                                             </span><br><span class=\"line\">&#125;                                                                                                 </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                     </span><br><span class=\"line\"><span class=\"keyword\">public</span> &lt;S&gt; <span class=\"keyword\">void</span> <span class=\"title function_\">removeSource</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> LiveData&lt;S&gt; toRemote)</span> &#123;   </span><br><span class=\"line\">    Source&lt;?&gt; source = mSources.remove(toRemote);               </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (source != <span class=\"literal\">null</span>) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 删除监听\t</span></span><br><span class=\"line\">        source.unplug();                                        </span><br><span class=\"line\">    &#125;                                                           </span><br><span class=\"line\">&#125;                                                               </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@CallSuper</span>                                                         </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                          </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActive</span><span class=\"params\">()</span> &#123;                                        </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (Map.Entry&lt;LiveData&lt;?&gt;, Source&lt;?&gt;&gt; source : mSources) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 重新监听</span></span><br><span class=\"line\">        source.getValue().plug();                                  </span><br><span class=\"line\">    &#125;                                                              </span><br><span class=\"line\">&#125;                                                                  </span><br><span class=\"line\">                                                                   </span><br><span class=\"line\"><span class=\"meta\">@CallSuper</span>                                                         </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                          </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onInactive</span><span class=\"params\">()</span> &#123;                                      </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (Map.Entry&lt;LiveData&lt;?&gt;, Source&lt;?&gt;&gt; source : mSources) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 暂时删除监听</span></span><br><span class=\"line\">        source.getValue().unplug();                                </span><br><span class=\"line\">    &#125;                                                              </span><br><span class=\"line\">&#125;                                                                  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Source</span>&lt;V&gt; <span class=\"keyword\">implements</span> <span class=\"title class_\">Observer</span>&lt;V&gt; &#123;                    </span><br><span class=\"line\">    <span class=\"keyword\">final</span> LiveData&lt;V&gt; mLiveData;                                           </span><br><span class=\"line\">    <span class=\"keyword\">final</span> Observer&lt;? <span class=\"built_in\">super</span> V&gt; mObserver;                                   </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">mVersion</span> <span class=\"operator\">=</span> START_VERSION;                                          </span><br><span class=\"line\">                                                                           </span><br><span class=\"line\">    Source(LiveData&lt;V&gt; liveData, <span class=\"keyword\">final</span> Observer&lt;? <span class=\"built_in\">super</span> V&gt; observer) &#123;     </span><br><span class=\"line\">        mLiveData = liveData;                                              </span><br><span class=\"line\">        mObserver = observer;                                              </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">plug</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 这里可以使用 observeForever，因为会在 onActive 和 onInactive 两个方法中处理，能响应页面的生命周期</span></span><br><span class=\"line\">        mLiveData.observeForever(<span class=\"built_in\">this</span>);                                    </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">unplug</span><span class=\"params\">()</span> &#123;                                                        </span><br><span class=\"line\">        mLiveData.removeObserver(<span class=\"built_in\">this</span>);                                    </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">                                                                           </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                              </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onChanged</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> V v)</span> &#123;                                 </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mVersion != mLiveData.getVersion()) &#123;                          </span><br><span class=\"line\">            mVersion = mLiveData.getVersion();                             </span><br><span class=\"line\">            mObserver.onChanged(v);                                        </span><br><span class=\"line\">        &#125;                                                                  </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">&#125;                                                                          </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>LiveData 可以算是 RxJava 的简化版本，它最大的好处就是和 Lifecycle 结合起来使用，不需要手动处理监听。第二个是，将数据分发操作封闭在主线程，减少线程同步锁的损耗，更适合 Android 日常开发场景。</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"关于LiveData\"><a href=\"#关于LiveData\" class=\"headerlink\" title=\"关于LiveData\"></a>关于LiveData</h3><p><code>LiveData</code> 是一种可观察的数据持有类，下面是常用的写法：</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DataViewModel</span></span>(application: Application) : AndroidViewModel(application) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">val</span> dataSource: LiveData&lt;String&gt; = MutableLiveData()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">postValue</span><span class=\"params\">(text: <span class=\"type\">String</span>? = <span class=\"string\">&quot;Hello World&quot;</span>)</span></span> &#123;</span><br><span class=\"line\">        (dataSource <span class=\"keyword\">as</span> MutableLiveData).postValue(text)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">viewModel.dataSource.observe(<span class=\"keyword\">this</span>, <span class=\"keyword\">object</span> : Observer&lt;String&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">onChanged</span><span class=\"params\">(t: <span class=\"type\">String</span>?)</span></span> &#123;</span><br><span class=\"line\">                println(<span class=\"string\">&quot;onChange: <span class=\"subst\">$&#123;t&#125;</span>&quot;</span>)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>一般情况下，<code>LiveData</code> 和 <code>ViewModel</code> 都是搭配使用的，可以在 <code>Activity</code> 和 <code>Fragment</code> 范围内提供复用，并处理因配置发生改变，而重建的情况。</p>\n<blockquote>\n<p>关于 <code>ViewModel</code> 更详细的理解，可以阅读之前的文章：<a href=\"https://linxiaotao.github.io/2019/01/05/Jetpack%E4%B8%AD%E7%9A%84ViewModel/\">Jetpack中的ViewModel</a></p>\n</blockquote>\n<p>如果了解过 <a href=\"https://github.com/ReactiveX/RxJava\">RxJava</a> 的同学，对这种<strong>观察者</strong>的设计模式应该有点了解，<code>LiveData</code> 也是同样的思想，不过和 RxJava 不同的是：<code>LiveData</code> 使用 <code>Lifecycle</code> 将数据源和 <code>Activity</code> 和 <code>Fragment</code> 的生命周期结合起来，避免内存泄漏等情况。这个特性也是本文的重点。</p>\n<blockquote>\n<p>关于 Lifecycle 更详细的理解，可以阅读之前的文章：<a href=\"https://linxiaotao.github.io/2019/01/14/Jetpack%E4%B8%AD%E7%9A%84Lifecycle/\">Jetpack中的Lifecycle</a></p>\n</blockquote>\n<p>建议在阅读以下内容时，先理解下 <code>Lifecycle</code>，因为 <code>LiveData</code> 能感应 <code>Activity</code> 和 <code>Fragment</code> 的生命周期就是基于 <code>Lifecycle</code> 实现的。</p>\n<h3 id=\"源码解析\"><a href=\"#源码解析\" class=\"headerlink\" title=\"源码解析\"></a>源码解析</h3><h4 id=\"各个模块的作用\"><a href=\"#各个模块的作用\" class=\"headerlink\" title=\"各个模块的作用\"></a>各个模块的作用</h4><p>在理解源码之前，我们先理清组成 <code>LiveData</code> 各个模块的作用。</p>\n<h5 id=\"LiveData\"><a href=\"#LiveData\" class=\"headerlink\" title=\"LiveData\"></a>LiveData</h5><p><code>LiveData</code> 表示一个可观察的数据源。在 <code>LiveData</code> 的设计中，它被设计为一个纯粹的数据源，对外只提供了：</p>\n<ul>\n<li><p>observe(LifecycleOwner,Observer)</p>\n<p>表示注册一个观察者（<code>Observer</code>），这里同时需要提供一个 <code>LifecycleOwner</code> 用于提供 <code>Lifecycle</code></p>\n</li>\n<li><p>observeForever(Observer)</p>\n<p>功能和 <code>observe(LifecycleOwner,Observer)</code> 类似，但缺少感应生命周期的功能</p>\n</li>\n<li><p>removeObserver(Observer) 和 removeObservers(LifecycleOwner)</p>\n<p>表示删除观察者，后者则是删除同个 <code>LifecycleOwner</code> 范围的 <code>Observer</code></p>\n</li>\n<li><p>getValue()</p>\n<p>表示获取当前值</p>\n</li>\n<li><p>hasObservers()</p>\n<p>表示是否存在 <code>Observer</code></p>\n</li>\n<li><p>hasActiveObservers()</p>\n<p>表示是否存在活动的 <code>Observer</code>，至于怎么去定义为活动的，后面会讲到</p>\n</li>\n</ul>\n<p><code>LiveData</code> 是一个纯粹的数据源，不包含添加数据的公开 API，只能通过使用 <code>MutableLiveData</code> 去添加数据</p>\n<blockquote>\n<p>这是一种不错的设计理念，单个组件功能越纯粹，代码的耦合度就越低。</p>\n</blockquote>\n<h5 id=\"Observer\"><a href=\"#Observer\" class=\"headerlink\" title=\"Observer\"></a>Observer</h5><p><code>Observer</code> 表示观察者，响应数据发生变化。API 也非常简单：<code>onChange(T)</code>，这里需要注意的是：<code>onChange()</code> 中数据可以为 <code>NULL</code>，这和 <code>RxJava2</code> 的设计是不一样的，这个很难说，哪个设计更优。但根据 <a href=\"https://github.com/JakeWharton\">JakeWharton</a> 的回答是：It’s not RxJava’s choice, it’s in the reactive streams spec.</p>\n<blockquote>\n<p>关于 <code>RxJava2</code> 不能传递 <code>NULL</code> 的讨论，可以参考这篇<a href=\"https://github.com/ReactiveX/RxJava/issues/4644\">文章</a></p>\n</blockquote>\n<h4 id=\"observe\"><a href=\"#observe\" class=\"headerlink\" title=\"observe\"></a>observe</h4><p>调用 <code>LiveData.observe(LifecycleOwner,Observer)</code> 去注册一个订阅者：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                                                 </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">observe</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> LifecycleOwner owner, <span class=\"meta\">@NonNull</span> Observer&lt;? <span class=\"built_in\">super</span> T&gt; observer)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 注意，只能主线程调用</span></span><br><span class=\"line\">    assertMainThread(<span class=\"string\">&quot;observe&quot;</span>);                                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;                              </span><br><span class=\"line\">        <span class=\"comment\">// ignore                                                                           </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                             </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 使用 LifecycleBoundObserver 包装类</span></span><br><span class=\"line\">    <span class=\"type\">LifecycleBoundObserver</span> <span class=\"variable\">wrapper</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">LifecycleBoundObserver</span>(owner, observer);</span><br><span class=\"line\">    <span class=\"comment\">// mObservers 为 Map&lt;Observer,ObserverWrapper&gt;</span></span><br><span class=\"line\">    <span class=\"type\">ObserverWrapper</span> <span class=\"variable\">existing</span> <span class=\"operator\">=</span> mObservers.putIfAbsent(observer, wrapper);                   </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (existing != <span class=\"literal\">null</span> &amp;&amp; !existing.isAttachedTo(owner)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 存在不同 LifecycleOwner 但相同 observer，抛异常</span></span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Cannot add the same observer&quot;</span>                   </span><br><span class=\"line\">                + <span class=\"string\">&quot; with different lifecycles&quot;</span>);                                            </span><br><span class=\"line\">    &#125;                                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (existing != <span class=\"literal\">null</span>) &#123;                                                                 </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                             </span><br><span class=\"line\">    &#125;                                                                                       </span><br><span class=\"line\">    owner.getLifecycle().addObserver(wrapper);                                              </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// LifecycleBoundObserver</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                     </span><br><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"title function_\">isAttachedTo</span><span class=\"params\">(LifecycleOwner owner)</span> &#123;  </span><br><span class=\"line\">    <span class=\"type\">return</span> <span class=\"variable\">mOwner</span> <span class=\"operator\">=</span>= owner;                   </span><br><span class=\"line\">&#125;                                             </span><br></pre></td></tr></table></figure>\n\n<p><code>LifecycleBoundObserver</code> 实现了 <code>GenericLifecycleObserver</code> 接口，用于响应 <code>Activity</code> 和 <code>Fragment</code> 的生命周期</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">LifecycleBoundObserver</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ObserverWrapper</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">GenericLifecycleObserver</span> &#123;   </span><br><span class=\"line\">    <span class=\"meta\">@NonNull</span>                                                                                 </span><br><span class=\"line\">    <span class=\"keyword\">final</span> LifecycleOwner mOwner;                                                             </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    LifecycleBoundObserver(<span class=\"meta\">@NonNull</span> LifecycleOwner owner, Observer&lt;? <span class=\"built_in\">super</span> T&gt; observer) &#123;    </span><br><span class=\"line\">        <span class=\"built_in\">super</span>(observer);                                                                     </span><br><span class=\"line\">        mOwner = owner;                                                                      </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                                </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">shouldBeActive</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 检测是否为活动状态</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);                   </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onStateChanged</span><span class=\"params\">(LifecycleOwner source, Lifecycle.Event event)</span> &#123;               </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mOwner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// DESTROYED 时移除 observer</span></span><br><span class=\"line\">            removeObserver(mObserver);                                                       </span><br><span class=\"line\">            <span class=\"keyword\">return</span>;                                                                          </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        activeStateChanged(shouldBeActive());                                                </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                                </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isAttachedTo</span><span class=\"params\">(LifecycleOwner owner)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 判断是否为同个 LifecycleOwner</span></span><br><span class=\"line\">        <span class=\"type\">return</span> <span class=\"variable\">mOwner</span> <span class=\"operator\">=</span>= owner;                                                              </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">detachObserver</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 1.removeObserver</span></span><br><span class=\"line\">        <span class=\"comment\">// 2. lifecycle state 没有在 started 之后，或者已经是 destoryed</span></span><br><span class=\"line\">        <span class=\"comment\">// 以上两种情况会调用 detachObserver</span></span><br><span class=\"line\">        <span class=\"comment\">// 从 Lifecycle 中移除 observer</span></span><br><span class=\"line\">        mOwner.getLifecycle().removeObserver(<span class=\"built_in\">this</span>);                                          </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ObserverWrapper</span> &#123;                                             </span><br><span class=\"line\">    <span class=\"keyword\">final</span> Observer&lt;? <span class=\"built_in\">super</span> T&gt; mObserver;                                             </span><br><span class=\"line\">    <span class=\"type\">boolean</span> mActive;                                                                 </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">mLastVersion</span> <span class=\"operator\">=</span> START_VERSION;                                                </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">    ObserverWrapper(Observer&lt;? <span class=\"built_in\">super</span> T&gt; observer) &#123;                                  </span><br><span class=\"line\">        mObserver = observer;                                                        </span><br><span class=\"line\">    &#125;                                                                                </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">abstract</span> <span class=\"type\">boolean</span> <span class=\"title function_\">shouldBeActive</span><span class=\"params\">()</span>;                                               </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"title function_\">isAttachedTo</span><span class=\"params\">(LifecycleOwner owner)</span> &#123;                                     </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;                                                                </span><br><span class=\"line\">    &#125;                                                                                </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">detachObserver</span><span class=\"params\">()</span> &#123;                                                          </span><br><span class=\"line\">    &#125;                                                                                </span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">activeStateChanged</span><span class=\"params\">(<span class=\"type\">boolean</span> newActive)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当活动状态发生变化时</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newActive == mActive) &#123;                                                  </span><br><span class=\"line\">            <span class=\"keyword\">return</span>;                                                                  </span><br><span class=\"line\">        &#125;                                                                            </span><br><span class=\"line\">        <span class=\"comment\">// immediately set active state, so we&#x27;d never dispatch anything to inactive </span></span><br><span class=\"line\">        <span class=\"comment\">// owner                                                                     </span></span><br><span class=\"line\">        mActive = newActive;</span><br><span class=\"line\">        <span class=\"comment\">// 是否为不活动状态</span></span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">wasInactive</span> <span class=\"operator\">=</span> LiveData.<span class=\"built_in\">this</span>.mActiveCount == <span class=\"number\">0</span>; </span><br><span class=\"line\">        <span class=\"comment\">// 当前活动个数统计</span></span><br><span class=\"line\">        LiveData.<span class=\"built_in\">this</span>.mActiveCount += mActive ? <span class=\"number\">1</span> : -<span class=\"number\">1</span>;                              </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (wasInactive &amp;&amp; mActive) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 不活动 -&gt; 活动</span></span><br><span class=\"line\">            onActive();                                                              </span><br><span class=\"line\">        &#125;                                                                            </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (LiveData.<span class=\"built_in\">this</span>.mActiveCount == <span class=\"number\">0</span> &amp;&amp; !mActive) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 活动 -&gt; 不活动</span></span><br><span class=\"line\">            onInactive();                                                            </span><br><span class=\"line\">        &#125;                                                                            </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mActive) &#123; </span><br><span class=\"line\">            <span class=\"comment\">// 当前为活动状态，分发当前 observer</span></span><br><span class=\"line\">            dispatchingValue(<span class=\"built_in\">this</span>);                                                  </span><br><span class=\"line\">        &#125;                                                                            </span><br><span class=\"line\">    &#125;                                                                                </span><br><span class=\"line\">&#125;                                                                                    </span><br></pre></td></tr></table></figure>\n\n<p>当调用 <code>observe()</code> 会根据当前是否为活跃状态，分发当前值。</p>\n<h4 id=\"postValue-和-setValue\"><a href=\"#postValue-和-setValue\" class=\"headerlink\" title=\"postValue 和 setValue\"></a>postValue 和 setValue</h4><p>当在非主线程调用时，使用 <code>postValue()</code>，相关源码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">postValue</span><span class=\"params\">(T value)</span> &#123;                                       </span><br><span class=\"line\">    <span class=\"type\">boolean</span> postTask;                                                     </span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (mDataLock) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前是否存在需要分发的值</span></span><br><span class=\"line\">        postTask = mPendingData == NOT_SET;  </span><br><span class=\"line\">        <span class=\"comment\">// 多次调用，只会分发最后一次的值</span></span><br><span class=\"line\">        mPendingData = value;                                             </span><br><span class=\"line\">    &#125;                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!postTask) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 已存在正在分发的任务</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                           </span><br><span class=\"line\">    &#125;                                                                     </span><br><span class=\"line\">    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里需要注意的是，当分发数据的任务还没结束时，多次调用 <code>postValue</code> 只会分发最后一次的值，同一时间只会存在一个 <code>PostValueRunnable</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">Runnable</span> <span class=\"variable\">mPostValueRunnable</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123; </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;                                      </span><br><span class=\"line\">        Object newValue;                                     </span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (mDataLock) &#123;                           </span><br><span class=\"line\">            newValue = mPendingData; </span><br><span class=\"line\">            <span class=\"comment\">// 设置为 NOT_SET</span></span><br><span class=\"line\">            mPendingData = NOT_SET;                          </span><br><span class=\"line\">        &#125;                                                    </span><br><span class=\"line\">        <span class=\"comment\">//noinspection unchecked </span></span><br><span class=\"line\">        <span class=\"comment\">// 再调用 setValue</span></span><br><span class=\"line\">        setValue((T) newValue);                              </span><br><span class=\"line\">    &#125;                                                        </span><br><span class=\"line\">&#125;; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                         </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setValue</span><span class=\"params\">(T value)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 只能在主线程调用</span></span><br><span class=\"line\">    assertMainThread(<span class=\"string\">&quot;setValue&quot;</span>); </span><br><span class=\"line\">    <span class=\"comment\">// 使用 version 记录</span></span><br><span class=\"line\">    mVersion++; </span><br><span class=\"line\">    <span class=\"comment\">// 当前值</span></span><br><span class=\"line\">    mData = value;  </span><br><span class=\"line\">    <span class=\"comment\">// 分发</span></span><br><span class=\"line\">    dispatchingValue(<span class=\"literal\">null</span>);                         </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">dispatchingValue</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> ObserverWrapper initiator)</span> &#123;                           </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDispatchingValue) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 正在分发中</span></span><br><span class=\"line\">        mDispatchInvalidated = <span class=\"literal\">true</span>;                                                   </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                        </span><br><span class=\"line\">    &#125;                                                                                  </span><br><span class=\"line\">    mDispatchingValue = <span class=\"literal\">true</span>;                                                          </span><br><span class=\"line\">    <span class=\"keyword\">do</span> &#123;                                                                               </span><br><span class=\"line\">        mDispatchInvalidated = <span class=\"literal\">false</span>;                                                  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (initiator != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 初始分发</span></span><br><span class=\"line\">            considerNotify(initiator);                                                 </span><br><span class=\"line\">            initiator = <span class=\"literal\">null</span>;                                                          </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 升序迭代，调用 considerNotify</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class=\"built_in\">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =  </span><br><span class=\"line\">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;        </span><br><span class=\"line\">                considerNotify(iterator.next().getValue());                            </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (mDispatchInvalidated) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 分发过程中，有新的数据需要分发</span></span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                                                             </span><br><span class=\"line\">                &#125;                                                                      </span><br><span class=\"line\">            &#125;                                                                          </span><br><span class=\"line\">        &#125;                                                                              </span><br><span class=\"line\">    &#125; <span class=\"keyword\">while</span> (mDispatchInvalidated);                                                    </span><br><span class=\"line\">    mDispatchingValue = <span class=\"literal\">false</span>;                                                         </span><br><span class=\"line\">&#125;                                                                                      </span><br></pre></td></tr></table></figure>\n\n<p>如果有阅读过 <a href=\"https://linxiaotao.github.io/2019/01/14/Jetpack%E4%B8%AD%E7%9A%84Lifecycle/\">Jetpack中的Lifecycle</a> 这篇文章的话，可以很快看出，分发值的处理和 <code>Lifecycle</code> 有类似的地方，即在分发过程中，有新的值开始分发这种 case，都是采用中断当前的分发，推迟到下一次遍历时，分发新的值。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">considerNotify</span><span class=\"params\">(ObserverWrapper observer)</span> &#123;                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!observer.mActive) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 当前 observer 为非活动状态</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                 </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">    <span class=\"comment\">// Check latest state b4 dispatch. Maybe it changed state but we didn&#x27;t get the event yet.  </span></span><br><span class=\"line\">    <span class=\"comment\">//                                                                                          </span></span><br><span class=\"line\">    <span class=\"comment\">// we still first check observer.active to keep it as the entrance for events. So even if   </span></span><br><span class=\"line\">    <span class=\"comment\">// the observer moved to an active state, if we&#x27;ve not received that event, we better not   </span></span><br><span class=\"line\">    <span class=\"comment\">// notify for a more predictable notification order.</span></span><br><span class=\"line\">    <span class=\"comment\">// 可能存在已经是非活动状态，但没有接收到的 case</span></span><br><span class=\"line\">    <span class=\"comment\">// 检测是否为活动状态</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!observer.shouldBeActive()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 非活动状态，mActive 和 shouldBeActive 不一致，通知 activeStateChanged</span></span><br><span class=\"line\">        observer.activeStateChanged(<span class=\"literal\">false</span>);                                                     </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                 </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (observer.mLastVersion &gt;= mVersion) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 当重新变为活动状态时，会分发当前值，避免重复值</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                 </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">    observer.mLastVersion = mVersion;                                                           </span><br><span class=\"line\">    <span class=\"comment\">//noinspection unchecked                                                                    </span></span><br><span class=\"line\">    observer.mObserver.onChanged((T) mData);                                                    </span><br><span class=\"line\">&#125;                                                                                               </span><br></pre></td></tr></table></figure>\n\n<p>需要注意的是，<code>setValue</code> 和 <code>postValue</code> 方法都是 <code>protected</code>，所以当我们想实现一个 LiveData 时，需要使用 MutableLiveData，源码很简单，就是将这两个方法修改为 <code>public</code>。</p>\n<blockquote>\n<p>这种实现思路有利于数据的不可变性。上游使用 MutableLiveData 分发数据，下游使用 LiveData 消费数据。</p>\n</blockquote>\n<p>如果使用过 RxJava 类似库的同学可能会觉得跟 LiveData 很像，同样是监听者模式。不一样的是，RxJava 提供了很多操作符，类似 <code>map</code>、<code>zip</code> 等，还有线程调度的 <code>observeOn</code> 和 <code>subscribeOn</code>。LiveData 没有线程调度的功能，它数据分发只在主线程上进行，没有线程锁等开销。除此之前，LiveData 只提供了 <code>map</code> 和 <code>switchMap</code> 的实现，但提供了 <code>MediatorLiveData</code> 去实现自己需要的操作符。</p>\n<h4 id=\"Transformations\"><a href=\"#Transformations\" class=\"headerlink\" title=\"Transformations\"></a>Transformations</h4><p>Transformations 中有 <code>map</code> 和 <code>switchMap</code> 的实现。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@MainThread</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;X, Y&gt; LiveData&lt;Y&gt; <span class=\"title function_\">map</span><span class=\"params\">(                              </span></span><br><span class=\"line\"><span class=\"params\">        <span class=\"meta\">@NonNull</span> LiveData&lt;X&gt; source,                               </span></span><br><span class=\"line\"><span class=\"params\">        <span class=\"meta\">@NonNull</span> <span class=\"keyword\">final</span> Function&lt;X, Y&gt; mapFunction)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> MediatorLiveData&lt;Y&gt; result = <span class=\"keyword\">new</span> <span class=\"title class_\">MediatorLiveData</span>&lt;&gt;();   </span><br><span class=\"line\">    result.addSource(source, <span class=\"keyword\">new</span> <span class=\"title class_\">Observer</span>&lt;X&gt;() &#123;                   </span><br><span class=\"line\">        <span class=\"meta\">@Override</span>                                                  </span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onChanged</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> X x)</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 对源数据进行转化</span></span><br><span class=\"line\">            result.setValue(mapFunction.apply(x));                 </span><br><span class=\"line\">        &#125;                                                          </span><br><span class=\"line\">    &#125;);                                                            </span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;                                                 </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;X, Y&gt; LiveData&lt;Y&gt; <span class=\"title function_\">switchMap</span><span class=\"params\">(                            </span></span><br><span class=\"line\"><span class=\"params\">        <span class=\"meta\">@NonNull</span> LiveData&lt;X&gt; source,                                   </span></span><br><span class=\"line\"><span class=\"params\">        <span class=\"meta\">@NonNull</span> <span class=\"keyword\">final</span> Function&lt;X, LiveData&lt;Y&gt;&gt; switchMapFunction)</span> &#123;   </span><br><span class=\"line\">    <span class=\"keyword\">final</span> MediatorLiveData&lt;Y&gt; result = <span class=\"keyword\">new</span> <span class=\"title class_\">MediatorLiveData</span>&lt;&gt;();       </span><br><span class=\"line\">    result.addSource(source, <span class=\"keyword\">new</span> <span class=\"title class_\">Observer</span>&lt;X&gt;() &#123;                       </span><br><span class=\"line\">        LiveData&lt;Y&gt; mSource;                                           </span><br><span class=\"line\">                                                                       </span><br><span class=\"line\">        <span class=\"meta\">@Override</span>                                                      </span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onChanged</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> X x)</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 将发射出来的每个数据都转换成新的 LiveData，再接收</span></span><br><span class=\"line\">            LiveData&lt;Y&gt; newLiveData = switchMapFunction.apply(x);      </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mSource == newLiveData) &#123;                              </span><br><span class=\"line\">                <span class=\"keyword\">return</span>;                                                </span><br><span class=\"line\">            &#125;                                                          </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mSource != <span class=\"literal\">null</span>) &#123;                                     </span><br><span class=\"line\">                result.removeSource(mSource);                          </span><br><span class=\"line\">            &#125;                                                          </span><br><span class=\"line\">            mSource = newLiveData;                                     </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mSource != <span class=\"literal\">null</span>) &#123;                                     </span><br><span class=\"line\">                result.addSource(mSource, <span class=\"keyword\">new</span> <span class=\"title class_\">Observer</span>&lt;Y&gt;() &#123;          </span><br><span class=\"line\">                    <span class=\"meta\">@Override</span>                                          </span><br><span class=\"line\">                    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onChanged</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> Y y)</span> &#123;             </span><br><span class=\"line\">                        result.setValue(y);                            </span><br><span class=\"line\">                    &#125;                                                  </span><br><span class=\"line\">                &#125;);                                                    </span><br><span class=\"line\">            &#125;                                                          </span><br><span class=\"line\">        &#125;                                                              </span><br><span class=\"line\">    &#125;);                                                                </span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;                                                     </span><br><span class=\"line\">&#125;                                                                      </span><br></pre></td></tr></table></figure>\n\n<p>MediatorLiveData 可以监听多个 LiveData，这里我们简单看下它的源码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">public</span> &lt;S&gt; <span class=\"keyword\">void</span> <span class=\"title function_\">addSource</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> LiveData&lt;S&gt; source, <span class=\"meta\">@NonNull</span> Observer&lt;? <span class=\"built_in\">super</span> S&gt; onChanged)</span> &#123;  </span><br><span class=\"line\">    Source&lt;S&gt; e = <span class=\"keyword\">new</span> <span class=\"title class_\">Source</span>&lt;&gt;(source, onChanged);                                                </span><br><span class=\"line\">    Source&lt;?&gt; existing = mSources.putIfAbsent(source, e);                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (existing != <span class=\"literal\">null</span> &amp;&amp; existing.mObserver != onChanged) &#123;                                    </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(                                                       </span><br><span class=\"line\">                <span class=\"string\">&quot;This source was already added with the different observer&quot;</span>);                     </span><br><span class=\"line\">    &#125;                                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (existing != <span class=\"literal\">null</span>) &#123;                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                   </span><br><span class=\"line\">    &#125;                                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasActiveObservers()) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 存在活动的 observer，开始监听 source livedata</span></span><br><span class=\"line\">        e.plug();                                                                                 </span><br><span class=\"line\">    &#125;                                                                                             </span><br><span class=\"line\">&#125;                                                                                                 </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@MainThread</span>                                                     </span><br><span class=\"line\"><span class=\"keyword\">public</span> &lt;S&gt; <span class=\"keyword\">void</span> <span class=\"title function_\">removeSource</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> LiveData&lt;S&gt; toRemote)</span> &#123;   </span><br><span class=\"line\">    Source&lt;?&gt; source = mSources.remove(toRemote);               </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (source != <span class=\"literal\">null</span>) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 删除监听\t</span></span><br><span class=\"line\">        source.unplug();                                        </span><br><span class=\"line\">    &#125;                                                           </span><br><span class=\"line\">&#125;                                                               </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@CallSuper</span>                                                         </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                          </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActive</span><span class=\"params\">()</span> &#123;                                        </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (Map.Entry&lt;LiveData&lt;?&gt;, Source&lt;?&gt;&gt; source : mSources) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 重新监听</span></span><br><span class=\"line\">        source.getValue().plug();                                  </span><br><span class=\"line\">    &#125;                                                              </span><br><span class=\"line\">&#125;                                                                  </span><br><span class=\"line\">                                                                   </span><br><span class=\"line\"><span class=\"meta\">@CallSuper</span>                                                         </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                          </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onInactive</span><span class=\"params\">()</span> &#123;                                      </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (Map.Entry&lt;LiveData&lt;?&gt;, Source&lt;?&gt;&gt; source : mSources) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 暂时删除监听</span></span><br><span class=\"line\">        source.getValue().unplug();                                </span><br><span class=\"line\">    &#125;                                                              </span><br><span class=\"line\">&#125;                                                                  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Source</span>&lt;V&gt; <span class=\"keyword\">implements</span> <span class=\"title class_\">Observer</span>&lt;V&gt; &#123;                    </span><br><span class=\"line\">    <span class=\"keyword\">final</span> LiveData&lt;V&gt; mLiveData;                                           </span><br><span class=\"line\">    <span class=\"keyword\">final</span> Observer&lt;? <span class=\"built_in\">super</span> V&gt; mObserver;                                   </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">mVersion</span> <span class=\"operator\">=</span> START_VERSION;                                          </span><br><span class=\"line\">                                                                           </span><br><span class=\"line\">    Source(LiveData&lt;V&gt; liveData, <span class=\"keyword\">final</span> Observer&lt;? <span class=\"built_in\">super</span> V&gt; observer) &#123;     </span><br><span class=\"line\">        mLiveData = liveData;                                              </span><br><span class=\"line\">        mObserver = observer;                                              </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">plug</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 这里可以使用 observeForever，因为会在 onActive 和 onInactive 两个方法中处理，能响应页面的生命周期</span></span><br><span class=\"line\">        mLiveData.observeForever(<span class=\"built_in\">this</span>);                                    </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">unplug</span><span class=\"params\">()</span> &#123;                                                        </span><br><span class=\"line\">        mLiveData.removeObserver(<span class=\"built_in\">this</span>);                                    </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">                                                                           </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                              </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onChanged</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> V v)</span> &#123;                                 </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mVersion != mLiveData.getVersion()) &#123;                          </span><br><span class=\"line\">            mVersion = mLiveData.getVersion();                             </span><br><span class=\"line\">            mObserver.onChanged(v);                                        </span><br><span class=\"line\">        &#125;                                                                  </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">&#125;                                                                          </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>LiveData 可以算是 RxJava 的简化版本，它最大的好处就是和 Lifecycle 结合起来使用，不需要手动处理监听。第二个是，将数据分发操作封闭在主线程，减少线程同步锁的损耗，更适合 Android 日常开发场景。</p>\n"},{"title":"优化包大小-PNG部分","date":"2019-12-04T11:53:22.000Z","_content":"\n## 背景\n\nPNG 图片相对于 JPEG 图片来说，它是一种无损的图像存储格式，同时多了一条透明度通道，所以一般情况下，PNG 图片要比 JPEG 图片要大，并且 PNG 图片往往还是 APK 图片资源中的大头，所以优化 PNG 图片的大小，对于减小包的体积来说，是比较有回报的事情。\n\n> 关于 PNG 的 wiki：\n>\n> **便携式网络图形**（英语：**P**ortable **N**etwork **G**raphics，**PNG**）是一种[无损压缩](https://zh.wikipedia.org/wiki/无损压缩)的[位图](https://zh.wikipedia.org/wiki/位图)图形格式，支持索引、[灰度](https://zh.wikipedia.org/wiki/灰度)、[RGB](https://zh.wikipedia.org/wiki/RGB)三种颜色方案以及[Alpha通道](https://zh.wikipedia.org/wiki/Alpha通道)等特性。\n>\n> 关于 JPEG 的 wiki：\n>\n> **联合图像专家小组**（英语：**J**oint **P**hotographic **E**xperts **G**roup，缩写：**JPEG**）是一种针对照片影像而广泛使用的[有损压缩](https://zh.wikipedia.org/wiki/有损数据压缩)标准方法。\n\n## 常用的压缩算法\n\n关于 PNG 的压缩算法有很多，这里我们只说两种比较常用的：[Indexed_color](https://en.wikipedia.org/wiki/Indexed_color) 和 [Color_quantization](https://en.wikipedia.org/wiki/Color_quantization)。这两种也是 Google 在 Android 开发者网站上推荐的，具体可以看 [network-xfer](https://developer.android.com/topic/performance/network-xfer)。\n\n下面我们会简单说下这两种算法的大概原理，更深入的知识请移步 Google 或者 Wiki。\n\n### Indexed_color\n\n字面意思就是索引颜色，通过将具体的 ARGB 颜色存储转换成索引下表，来减少文件的大小。我们知道 ARGB 中，每个通道的存储都需要 8 位，也就是 1 字节，一个 ARGB 存储就需要 4 字节，而索引的存储只需要 1 字节。而索引指向的颜色会存放在一个叫 palette（调色板）的数组里面。\n\n> wiki 定义：\n>\n> 在计算中，**索引颜色**是一种以有限的方式管理[数字图像](https://en.wikipedia.org/wiki/Digital_image)颜色的技术，以节省计算机[内存](https://en.wikipedia.org/wiki/Computer_data_storage)和[文件存储空间](https://en.wikipedia.org/wiki/Hard_disk_drive)，同时加快显示刷新和文件传输的速度。它是[矢量量化压缩的](https://en.wikipedia.org/wiki/Vector_quantization#Use_in_data_compression)一种形式。\n\n图片来自于 wiki：\n\n![Indexed_color](https://user-gold-cdn.xitu.io/2019/12/4/16ed048e29449106?w=150&h=400&f=png&s=2151)\n\n这种算法很好，但也有缺点，调色板的大小通常只支持 4,16,256 这几种，也就是说最大不会超过 256 个，所以能应用这种算法的 PNG 图片中的颜色使用不能超过 256 个。\n\n### Color_quantization\n\n字面意思就是颜色矢量化，通过使用相似颜色来减少图像中使用的颜色种类，再配合调色板，来达到减少图片文件大小的目的，这是一种有损的压缩算法。\n\n图片来自于 wiki：\n\n这是使用标准的 24 位 RGB 颜色的图像： \n\n![24位RGB](https://user-gold-cdn.xitu.io/2019/12/4/16ed048e2746717e?w=250&h=200&f=png&s=83335)\n\n这是优化成只使用 16 种颜色的图像：\n\n![16种颜色](https://user-gold-cdn.xitu.io/2019/12/4/16ed048e299d4616?w=250&h=216&f=png&s=9121)\n\n这种算法的缺点就是质量有损，所以如何在质量和大小中间达到一个平衡点，这个至关重要。\n\n## 谈谈 AAPT\n\nAAPT 是 Android 的资源打包工具，我们常用的 R 文件就是用它生存的，除此之外，它还有压缩 PNG 图片的功能。AAPT 现在有 AAPT 和 AAPT2 了，默认我们都是说的是 AAPT2。\n\n> 关于 AAPT2 对于 PNG 图片的压缩知识，可以看下 Colt McAnlis 的这篇文章，[Smaller PNGs, and Android’s AAPT tool](https://medium.com/@duhroach/smaller-pngs-and-android-s-aapt-tool-4ce38a24019d)\n>\n> PS：作者就是 Android 性能宝典里面那个光头。。。\n\nAAPT2 对于 PNG 图片的压缩可以分为三个方面：\n\n* RGB 是否可以转化成灰度\n* 透明通道是否可以删除\n* 是不是最多只有 256 色（Indexed_color 优化）\n\n接下来，我们从源码入手，只看看上面所说的这几点吧。\n\n> 源码分析用的是 Android 6.0 也就是 marshmallow 的版本：\n>\n> https://android.googlesource.com/platform/frameworks/base/+/marshmallow-dev/tools/aapt2/Png.cpp\n\n对于 PNG 的分析代码位于 `analyze_image()` 这个方法中，国际惯例，删除一些不影响分析的代码。\n\n``` cpp\nstatic void analyze_image() {\n    int w = imageInfo.width;\n    int h = imageInfo.height;\n    uint32_t colors[256], col;\n    int num_colors = 0;\n    bool isOpaque = true;\n    bool isPalette = true;\n    bool isGrayscale = true;\n    // Scan the entire image and determine if:\n    // 1. Every pixel has R == G == B (grayscale)\n    // 2. Every pixel has A == 255 (opaque)\n    // 3. There are no more than 256 distinct RGBA colors\n    for (j = 0; j < h; j++) {\n        const png_byte* row = imageInfo.rows[j];\n        png_bytep out = outRows[j];\n        for (i = 0; i < w; i++) {\n            rr = *row++;\n            gg = *row++;\n            bb = *row++;\n            aa = *row++;\n            int odev = maxGrayDeviation;\n            maxGrayDeviation = MAX(ABS(rr - gg), maxGrayDeviation);\n            maxGrayDeviation = MAX(ABS(gg - bb), maxGrayDeviation);\n            maxGrayDeviation = MAX(ABS(bb - rr), maxGrayDeviation);\n          \n            // Check if image is really grayscale\n            if (isGrayscale) {\n                if (rr != gg || rr != bb) {\n                  // ==>> Code 1\n                    isGrayscale = false;\n                }\n            }\n            // Check if image is really opaque\n            if (isOpaque) {\n                if (aa != 0xff) {\n                  // ==>> Code 2\n                    isOpaque = false;\n                }\n            }\n            // Check if image is really <= 256 colors\n            if (isPalette) {\n                col = (uint32_t) ((rr << 24) | (gg << 16) | (bb << 8) | aa);\n                bool match = false;\n                for (idx = 0; idx < num_colors; idx++) {\n                    if (colors[idx] == col) {\n                        match = true;\n                        break;\n                    }\n                }\n                if (!match) {\n                    if (num_colors == 256) {\n                      // ==>> Code 3\n                        isPalette = false;\n                    } else {\n                        colors[num_colors++] = col;\n                    }\n                }\n            }\n        }\n    }\n    *paletteEntries = 0;\n    *hasTransparency = !isOpaque;\n    int bpp = isOpaque ? 3 : 4;\n    int paletteSize = w * h + bpp * num_colors;\n    \n    // Choose the best color type for the image.\n    // 1. Opaque gray - use COLOR_TYPE_GRAY at 1 byte/pixel\n    // 2. Gray + alpha - use COLOR_TYPE_PALETTE if the number of distinct combinations\n    //     is sufficiently small, otherwise use COLOR_TYPE_GRAY_ALPHA\n    // 3. RGB(A) - use COLOR_TYPE_PALETTE if the number of distinct colors is sufficiently\n    //     small, otherwise use COLOR_TYPE_RGB{_ALPHA}\n    if (isGrayscale) {\n        if (isOpaque) {\n          // ==>> Code 4\n            *colorType = PNG_COLOR_TYPE_GRAY; // 1 byte/pixel\n        } else {\n            // Use a simple heuristic to determine whether using a palette will\n            // save space versus using gray + alpha for each pixel.\n            // This doesn't take into account chunk overhead, filtering, LZ\n            // compression, etc.\n            if (isPalette && (paletteSize < 2 * w * h)) {\n              // ==>> Code 5\n                *colorType = PNG_COLOR_TYPE_PALETTE; // 1 byte/pixel + 4 bytes/color\n            } else {\n              // ==>> Code 6\n                *colorType = PNG_COLOR_TYPE_GRAY_ALPHA; // 2 bytes per pixel\n            }\n        }\n    } else if (isPalette && (paletteSize < bpp * w * h)) {\n      // ==>> Code 7\n        *colorType = PNG_COLOR_TYPE_PALETTE;\n    } else {\n        if (maxGrayDeviation <= grayscaleTolerance) {\n          // ==>> Code 8\n            *colorType = isOpaque ? PNG_COLOR_TYPE_GRAY : PNG_COLOR_TYPE_GRAY_ALPHA;\n        } else {\n          // ==>> Code 9\n            *colorType = isOpaque ? PNG_COLOR_TYPE_RGB : PNG_COLOR_TYPE_RGB_ALPHA;\n        }\n    }\n    \n}\n```\n\n首先定义了 3 个变量分别表示：isOpaque（是否不透明），isPalette（是否支持调色板），isGrayscale（是否可转化为灰度）。\n\n首先看 Code 1 处的代码：\n\n``` cpp\n                if (rr != gg || rr != bb) {\n                  // ==>> Code 1\n                    isGrayscale = false;\n                }\n```\n\n只有 RGB 三种通道的颜色都一样，才能转化成灰度。\n\nCode 2 处的代码是判断透明通道是否为 0，也就是是不是不透明：\n\n``` cpp\n                if (aa != 0xff) {\n                  // ==>> Code 2\n                    isOpaque = false;\n                }\n```\n\n而 Code 3 处则是判断是否可以用 256 色的调色板：\n\n``` cpp\n                if (!match) {\n                    if (num_colors == 256) {\n                      // ==>> Code 3\n                        isPalette = false;\n                    } else {\n                        colors[num_colors++] = col;\n                    }\n                }\n```\n\n`colors` 是一个数组，里面存放的是图片中已经出现的（不重复）颜色，当颜色的数量大于 256 即表示不支持调色板模式。\n\n然后根据这些条件，来判断使用哪种存储模式，AAPT 中支持的存储模式有以下几种：\n\n* PNG_COLOR_TYPE_PALETTE\n\n  使用调色板模式，最终图片的大小就是 一个像素 1 字节 + 调色板中一个颜色 4 字节\n\n* PNG_COLOR_TYPE_GRAY\n\n  灰度模式，这种是最节省的模式，一个像素 1 字节\n\n* PNG_COLOR_TYPE_GRAY_ALPHA\n\n  灰度模式，同时存在透明通道，一个像素 2 字节\n\n* PNG_COLOR_TYPE_RGB\n\n  RGB 模式，删除了透明通道，一个像素 3 字节\n\n* PNG_COLOR_TYPE_RGB_ALPHA\n\n  ARGB 模式，一个像素 4 字节\n\n### PNG_COLOR_TYPE_PALETTE\n\n要使用这种模式，需要满足以下两个条件，分别是 Code 5 和 Code 7：\n\nCode 5\n\n``` cpp\n if (isGrayscale) {\n        if (isOpaque) {\n        } else {\n          if (isPalette && (paletteSize < 2 * w * h)) {\n            // ==>> Code 5\n                *colorType = PNG_COLOR_TYPE_PALETTE; // 1 byte/pixel + 4 bytes/color\n            } \n        }\n }\n```\n\n在支持灰度模式的前提下，有透明通道，支持调色板模式，同时调色板的长度小于 `2 * w * h`。\n\nCode 7\n\n``` cpp\nif (isGrayscale) {\n  \n} else {\n  if (isPalette && (paletteSize < bpp * w * h)) {\n    // Code ==>> 7\n        *colorType = PNG_COLOR_TYPE_PALETTE;\n    }\n}\n```\n\n如果不支持灰度模式，但支持调色板，同时调色板长度小于 `bpp * w * h`，其中 `bpp` 的大小根据是否为不透明为决定：\n\n``` cpp\n    int bpp = isOpaque ? 3 : 4;\n```\n\n### PNG_COLOR_TYPE_GRAY\n\n要使用这种模式，需要满足支持灰度模式，同时不透明。代码位于 Code 4：\n\n``` cpp\n if (isGrayscale) {\n        if (isOpaque) {\n          // ==>> Code 4\n            *colorType = PNG_COLOR_TYPE_GRAY; // 1 byte/pixel\n        }\n }\n```\n\n###PNG_COLOR_TYPE_GRAY_ALPHA\n\n灰度，同时存在透明通道的模式。代码位于 Code 6 和 Code 8：\n\nCode 6\n\n``` cpp\n if (isGrayscale) {\n        if (isOpaque) {\n        } else {\n          if (isPalette && (paletteSize < 2 * w * h)) {\n            } else {\n            // ==>> Code 6\n            *colorType = PNG_COLOR_TYPE_GRAY_ALPHA; // 2 bytes per pixel\n          }\n        }\n }\n```\n\nCode 8\n\n``` cpp\nif (isGrayscale) {\n        \n    } else if (isPalette && (paletteSize < bpp * w * h)) {\n    } else {\n        if (maxGrayDeviation <= grayscaleTolerance) {\n          // ==>> Code 8\n            *colorType = isOpaque ? PNG_COLOR_TYPE_GRAY : PNG_COLOR_TYPE_GRAY_ALPHA;\n        } else {\n        }\n    }\n\n```\n\n`maxGrayDeviation` 是计算 RGB 通道直接的差值，如果小于 `grayscaleTolerance` 这个阙值，那么也可以转成灰度。\n\n### PNG_COLOR_TYPE_RGB\n\n不透明图片可以删除透明通道，代码位于 Code 9：\n\n``` cpp\nif (isGrayscale) {\n        \n    } else if (isPalette && (paletteSize < bpp * w * h)) {\n    } else {\n        if (maxGrayDeviation <= grayscaleTolerance) {\n        } else {\n          // ==>> Code 9\n                      *colorType = isOpaque ? PNG_COLOR_TYPE_RGB : PNG_COLOR_TYPE_RGB_ALPHA;\n        }\n    }\n\n\n```\n\n### PNG_COLOR_TYPE_RGB_ALPHA\n\n这个没什么好说的，最后的兜底模式。\n\n### 小结\n\nAAPT 对 PNG 的优化，主要是 Indexed_color 算法，这也是一种保守的选择，因为这种是无损的，如果我们想要更高的压缩率，可以使用一些其他的压缩工具，来集成到我们的编译打包流程中。\n\n## PNG 压缩工具对比\n\n首先，在我们选择其他 PNG 压缩工具其他，我们需要先禁用 AAPT 的默认压缩模式，因为对于 PNG 的压缩，并不是 1 + 1 > 2，可以通过以下代码关闭：\n\n``` groovy\nandroid {\n     aaptOptions {\n        cruncherEnabled = false\n    }\n}\n```\n\n现在常用的 PNG 压缩工具有 [pngcrush](http://pmt.sourceforge.net/pngcrush/)、[pngquant](https://pngquant.org/)、[zopfli](https://github.com/google/zopfli) 、[tinypng](https://tinypng.com) 等，这里我们就先不考虑 tinypng，因为这个只提供了 HTTP 接口的形式，并且有次数限制。\n\n### 使用 Gradle 集成\n\n为了将 PNG 压缩工具集成到 APK 的构建编译流程，我们使用 Gradle 来实现。作者当前使用 Android Gradle 插件版本为 3.5.0，在这个版本我们可以通过 `ApplicationVariant.allRawAndroidResources` 获取所有的资源目录。\n\n需要注意的是，我们这个 Task 需要在 MergeResources 这个 Task 之前执行，这样我们可以将压缩后的同名覆盖，再合并到 APK 文件中。\n\n``` groovy\nafterEvaluate {\n\n        applicationVariants.all { ApplicationVariant variant ->\n\n            if (variant.buildType.name != \"release\") {\n                return\n            }\n\n\n            def compressPngTask = task('compressPng')\n            compressPngTask.doLast {\n                List<File> allResource = []\n\n                variant.allRawAndroidResources.files.forEach { dir ->\n\n                    if (!dir.exists()) {\n                        return\n                    }\n\n                    if (dir.isFile()) {\n                        if (dir.name.endsWith(\".png\")) {\n                            allResource.add(file)\n                        }\n                    } else {\n                        dir.traverse { file ->\n                            if (file.name.endsWith(\".png\")) {\n                                allResource.add(file)\n                            }\n                        }\n                    }\n\n\n                }\n\n\n                allResource.forEach { file ->\n                    // kb\n                    def oldSize = file.size() / 1024f\n\n                    println \"path = ${file.path}\"\n                    try {\n                       // TODO 这里就是我们执行压缩的逻辑\n                    } catch (Throwable ignore) {\n                        println \"file: ${file.name} error: ${ignore.message}\"\n                    }\n\n\n                    println \"${file.name}: $oldSize KB ==> ${file.size() / 1024f} KB\"\n\n                }\n\n\n            }\n\n\n            Task mergeResourcesTask = variant.mergeResourcesProvider.get()\n            mergeResourcesTask.dependsOn(compressPngTask)\n        }\n\n\n    }\n```\n\n首先我们创建一个名为 compressPng 的 Task，这个 Task 的任务就是收集所有 PNG 文件路径，这里我们过滤掉 BuildType 不是 release 的 Variant，最后让 MergeResources Task 依赖于 compressPng Task。\n\n**记得先关掉 AAPT 默认的 PNG 压缩。**\n\n这里我们先记录下关闭 AAPT 默认 PNG 压缩后的 APK 文件大小，和使用默认 PNG 压缩后的 APK 文件大小：\n\n> 这里我找的是一个直播的项目，里面有比较多的图片资源文件，过滤了 JPEG 和 .9 图，大概有 1000多张 PNG 图片，只使用一个压缩线程。\n\n| 压缩工具 | APK 大小（MB） | 耗时   |\n| -------- | -------------- | ------ |\n| 无       | 81.9           | 29s    |\n| AAPT     | 78.9           | 1m 18s |\n\n### pngquant\n\n首先测试 pngquant，我们将pngquant 集成进去：\n\n``` groovy\n                        exec { ExecSpec spec ->\n                            spec.workingDir(project.file('.'))\n                            spec.commandLine(\"./pngquant\", \"--skip-if-larger\", \"--speed\", \"1\", \"--strip\", \"--nofs\", \"--force\", \"--output\", file.path, \"--\", file.path)\n                        }\n```\n\n这里我们用的基本都是默认配置：\n\n* --skip-if-larger 表示如果压缩后的图片更大了，就跳过\n* --speed 1 表示使用最慢的压缩速度，来换取更好的压缩质量\n* --strip 删除图片的一些元数据\n* --nofs 禁用 [Floyd–Steinberg dithering]([https://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering](https://en.wikipedia.org/wiki/Floyd–Steinberg_dithering)) 图像抖动处理\n* --force 覆盖源文件\n* --output 输出文件的路径\n\n先执行 Clean Task，再重新执行打包，最终结果如下：\n\n| 压缩工具 | APK 大小（MB） | 耗时   |\n| -------- | -------------- | ------ |\n| 无       | 81.9           | 29s    |\n| AAPT     | 78.9           | 32s    |\n| pngquant | 73.7           | 1m 18s |\n\n### zopflipng\n\n集成进去：\n\n``` groovy\n                        exec { ExecSpec spec ->\n                            spec.workingDir(new File('/Users/leo/Documents/projects/zopfli'))\n                            spec.commandLine(\"./zopflipng\", \"-y\", \"-m\", file.path, file.path)\n\n                        }\n```\n\n使用的也是基本配置：\n\n* -y 覆盖原文件，不需要询问\n* -m 尽可能多压缩，依赖于文件的大小\n\n先执行 Clean Task，再重新执行打包，最终结果如下：\n\n| 压缩工具  | APK 大小（MB） | 耗时    |\n| --------- | -------------- | ------- |\n| 无        | 81.9           | 29s     |\n| AAPT      | 78.9           | 32s     |\n| pngquant  | 73.7           | 1m 18s  |\n| zopflipng | 78             | 36m 17s |\n\n### pngcursh\n\n集成进去：\n\n``` groovy\n                        exec { ExecSpec spec ->\n                            spec.workingDir(new File('/Users/leo/Documents/projects/pngcrush-1.8.13'))\n                            spec.commandLine(\"./pngcrush\", \"-ow\",\"-reduce\", file.path)\n                        }\n```\n\n使用基本配置：\n\n* -ow 表示覆盖原文件\n* -reduce 减少无损颜色值的类型和位深度\n* -brute 尝试 176 种压缩方法\n\n先执行 Clean Task，再重新执行打包，最终结果如下：\n\n| 压缩工具  | APK 大小（MB） | 耗时    |\n| --------- | -------------- | ------- |\n| 无        | 81.9           | 29s     |\n| AAPT      | 78.9           | 32s     |\n| pngquant  | 73.7           | 1m 18s  |\n| zopflipng | 78             | 36m 17s |\n| pngcursh  | 78.7           | 13m 56s |\n\n### 小结\n\n虽然从结果上来看，pngquant 是最好的选择，但因为 pngcursh 这块使用的只是默认的压缩配置，而且 pngcursh 提供的参数是最多的，所以具体哪个更优，只能靠调参数了，众所周知，调参数也是技术活。\n\n## 总结\n\n推荐使用 WebP 和 SVG 来代替 PNG 和 JPEG 图片的使用，但有些三方库的图片是我们没办法控制的，这块就可以用 PNG 压缩工具来进行优化。至于如果平衡压缩率、压缩耗时，这就是要靠大家去调参数了。","source":"_posts/优化包大小-PNG部分.md","raw":"---\ntitle: 优化包大小-PNG部分\ndate: 2019-12-04 19:53:22\ncategories: Android\ntags: 性能优化\n---\n\n## 背景\n\nPNG 图片相对于 JPEG 图片来说，它是一种无损的图像存储格式，同时多了一条透明度通道，所以一般情况下，PNG 图片要比 JPEG 图片要大，并且 PNG 图片往往还是 APK 图片资源中的大头，所以优化 PNG 图片的大小，对于减小包的体积来说，是比较有回报的事情。\n\n> 关于 PNG 的 wiki：\n>\n> **便携式网络图形**（英语：**P**ortable **N**etwork **G**raphics，**PNG**）是一种[无损压缩](https://zh.wikipedia.org/wiki/无损压缩)的[位图](https://zh.wikipedia.org/wiki/位图)图形格式，支持索引、[灰度](https://zh.wikipedia.org/wiki/灰度)、[RGB](https://zh.wikipedia.org/wiki/RGB)三种颜色方案以及[Alpha通道](https://zh.wikipedia.org/wiki/Alpha通道)等特性。\n>\n> 关于 JPEG 的 wiki：\n>\n> **联合图像专家小组**（英语：**J**oint **P**hotographic **E**xperts **G**roup，缩写：**JPEG**）是一种针对照片影像而广泛使用的[有损压缩](https://zh.wikipedia.org/wiki/有损数据压缩)标准方法。\n\n## 常用的压缩算法\n\n关于 PNG 的压缩算法有很多，这里我们只说两种比较常用的：[Indexed_color](https://en.wikipedia.org/wiki/Indexed_color) 和 [Color_quantization](https://en.wikipedia.org/wiki/Color_quantization)。这两种也是 Google 在 Android 开发者网站上推荐的，具体可以看 [network-xfer](https://developer.android.com/topic/performance/network-xfer)。\n\n下面我们会简单说下这两种算法的大概原理，更深入的知识请移步 Google 或者 Wiki。\n\n### Indexed_color\n\n字面意思就是索引颜色，通过将具体的 ARGB 颜色存储转换成索引下表，来减少文件的大小。我们知道 ARGB 中，每个通道的存储都需要 8 位，也就是 1 字节，一个 ARGB 存储就需要 4 字节，而索引的存储只需要 1 字节。而索引指向的颜色会存放在一个叫 palette（调色板）的数组里面。\n\n> wiki 定义：\n>\n> 在计算中，**索引颜色**是一种以有限的方式管理[数字图像](https://en.wikipedia.org/wiki/Digital_image)颜色的技术，以节省计算机[内存](https://en.wikipedia.org/wiki/Computer_data_storage)和[文件存储空间](https://en.wikipedia.org/wiki/Hard_disk_drive)，同时加快显示刷新和文件传输的速度。它是[矢量量化压缩的](https://en.wikipedia.org/wiki/Vector_quantization#Use_in_data_compression)一种形式。\n\n图片来自于 wiki：\n\n![Indexed_color](https://user-gold-cdn.xitu.io/2019/12/4/16ed048e29449106?w=150&h=400&f=png&s=2151)\n\n这种算法很好，但也有缺点，调色板的大小通常只支持 4,16,256 这几种，也就是说最大不会超过 256 个，所以能应用这种算法的 PNG 图片中的颜色使用不能超过 256 个。\n\n### Color_quantization\n\n字面意思就是颜色矢量化，通过使用相似颜色来减少图像中使用的颜色种类，再配合调色板，来达到减少图片文件大小的目的，这是一种有损的压缩算法。\n\n图片来自于 wiki：\n\n这是使用标准的 24 位 RGB 颜色的图像： \n\n![24位RGB](https://user-gold-cdn.xitu.io/2019/12/4/16ed048e2746717e?w=250&h=200&f=png&s=83335)\n\n这是优化成只使用 16 种颜色的图像：\n\n![16种颜色](https://user-gold-cdn.xitu.io/2019/12/4/16ed048e299d4616?w=250&h=216&f=png&s=9121)\n\n这种算法的缺点就是质量有损，所以如何在质量和大小中间达到一个平衡点，这个至关重要。\n\n## 谈谈 AAPT\n\nAAPT 是 Android 的资源打包工具，我们常用的 R 文件就是用它生存的，除此之外，它还有压缩 PNG 图片的功能。AAPT 现在有 AAPT 和 AAPT2 了，默认我们都是说的是 AAPT2。\n\n> 关于 AAPT2 对于 PNG 图片的压缩知识，可以看下 Colt McAnlis 的这篇文章，[Smaller PNGs, and Android’s AAPT tool](https://medium.com/@duhroach/smaller-pngs-and-android-s-aapt-tool-4ce38a24019d)\n>\n> PS：作者就是 Android 性能宝典里面那个光头。。。\n\nAAPT2 对于 PNG 图片的压缩可以分为三个方面：\n\n* RGB 是否可以转化成灰度\n* 透明通道是否可以删除\n* 是不是最多只有 256 色（Indexed_color 优化）\n\n接下来，我们从源码入手，只看看上面所说的这几点吧。\n\n> 源码分析用的是 Android 6.0 也就是 marshmallow 的版本：\n>\n> https://android.googlesource.com/platform/frameworks/base/+/marshmallow-dev/tools/aapt2/Png.cpp\n\n对于 PNG 的分析代码位于 `analyze_image()` 这个方法中，国际惯例，删除一些不影响分析的代码。\n\n``` cpp\nstatic void analyze_image() {\n    int w = imageInfo.width;\n    int h = imageInfo.height;\n    uint32_t colors[256], col;\n    int num_colors = 0;\n    bool isOpaque = true;\n    bool isPalette = true;\n    bool isGrayscale = true;\n    // Scan the entire image and determine if:\n    // 1. Every pixel has R == G == B (grayscale)\n    // 2. Every pixel has A == 255 (opaque)\n    // 3. There are no more than 256 distinct RGBA colors\n    for (j = 0; j < h; j++) {\n        const png_byte* row = imageInfo.rows[j];\n        png_bytep out = outRows[j];\n        for (i = 0; i < w; i++) {\n            rr = *row++;\n            gg = *row++;\n            bb = *row++;\n            aa = *row++;\n            int odev = maxGrayDeviation;\n            maxGrayDeviation = MAX(ABS(rr - gg), maxGrayDeviation);\n            maxGrayDeviation = MAX(ABS(gg - bb), maxGrayDeviation);\n            maxGrayDeviation = MAX(ABS(bb - rr), maxGrayDeviation);\n          \n            // Check if image is really grayscale\n            if (isGrayscale) {\n                if (rr != gg || rr != bb) {\n                  // ==>> Code 1\n                    isGrayscale = false;\n                }\n            }\n            // Check if image is really opaque\n            if (isOpaque) {\n                if (aa != 0xff) {\n                  // ==>> Code 2\n                    isOpaque = false;\n                }\n            }\n            // Check if image is really <= 256 colors\n            if (isPalette) {\n                col = (uint32_t) ((rr << 24) | (gg << 16) | (bb << 8) | aa);\n                bool match = false;\n                for (idx = 0; idx < num_colors; idx++) {\n                    if (colors[idx] == col) {\n                        match = true;\n                        break;\n                    }\n                }\n                if (!match) {\n                    if (num_colors == 256) {\n                      // ==>> Code 3\n                        isPalette = false;\n                    } else {\n                        colors[num_colors++] = col;\n                    }\n                }\n            }\n        }\n    }\n    *paletteEntries = 0;\n    *hasTransparency = !isOpaque;\n    int bpp = isOpaque ? 3 : 4;\n    int paletteSize = w * h + bpp * num_colors;\n    \n    // Choose the best color type for the image.\n    // 1. Opaque gray - use COLOR_TYPE_GRAY at 1 byte/pixel\n    // 2. Gray + alpha - use COLOR_TYPE_PALETTE if the number of distinct combinations\n    //     is sufficiently small, otherwise use COLOR_TYPE_GRAY_ALPHA\n    // 3. RGB(A) - use COLOR_TYPE_PALETTE if the number of distinct colors is sufficiently\n    //     small, otherwise use COLOR_TYPE_RGB{_ALPHA}\n    if (isGrayscale) {\n        if (isOpaque) {\n          // ==>> Code 4\n            *colorType = PNG_COLOR_TYPE_GRAY; // 1 byte/pixel\n        } else {\n            // Use a simple heuristic to determine whether using a palette will\n            // save space versus using gray + alpha for each pixel.\n            // This doesn't take into account chunk overhead, filtering, LZ\n            // compression, etc.\n            if (isPalette && (paletteSize < 2 * w * h)) {\n              // ==>> Code 5\n                *colorType = PNG_COLOR_TYPE_PALETTE; // 1 byte/pixel + 4 bytes/color\n            } else {\n              // ==>> Code 6\n                *colorType = PNG_COLOR_TYPE_GRAY_ALPHA; // 2 bytes per pixel\n            }\n        }\n    } else if (isPalette && (paletteSize < bpp * w * h)) {\n      // ==>> Code 7\n        *colorType = PNG_COLOR_TYPE_PALETTE;\n    } else {\n        if (maxGrayDeviation <= grayscaleTolerance) {\n          // ==>> Code 8\n            *colorType = isOpaque ? PNG_COLOR_TYPE_GRAY : PNG_COLOR_TYPE_GRAY_ALPHA;\n        } else {\n          // ==>> Code 9\n            *colorType = isOpaque ? PNG_COLOR_TYPE_RGB : PNG_COLOR_TYPE_RGB_ALPHA;\n        }\n    }\n    \n}\n```\n\n首先定义了 3 个变量分别表示：isOpaque（是否不透明），isPalette（是否支持调色板），isGrayscale（是否可转化为灰度）。\n\n首先看 Code 1 处的代码：\n\n``` cpp\n                if (rr != gg || rr != bb) {\n                  // ==>> Code 1\n                    isGrayscale = false;\n                }\n```\n\n只有 RGB 三种通道的颜色都一样，才能转化成灰度。\n\nCode 2 处的代码是判断透明通道是否为 0，也就是是不是不透明：\n\n``` cpp\n                if (aa != 0xff) {\n                  // ==>> Code 2\n                    isOpaque = false;\n                }\n```\n\n而 Code 3 处则是判断是否可以用 256 色的调色板：\n\n``` cpp\n                if (!match) {\n                    if (num_colors == 256) {\n                      // ==>> Code 3\n                        isPalette = false;\n                    } else {\n                        colors[num_colors++] = col;\n                    }\n                }\n```\n\n`colors` 是一个数组，里面存放的是图片中已经出现的（不重复）颜色，当颜色的数量大于 256 即表示不支持调色板模式。\n\n然后根据这些条件，来判断使用哪种存储模式，AAPT 中支持的存储模式有以下几种：\n\n* PNG_COLOR_TYPE_PALETTE\n\n  使用调色板模式，最终图片的大小就是 一个像素 1 字节 + 调色板中一个颜色 4 字节\n\n* PNG_COLOR_TYPE_GRAY\n\n  灰度模式，这种是最节省的模式，一个像素 1 字节\n\n* PNG_COLOR_TYPE_GRAY_ALPHA\n\n  灰度模式，同时存在透明通道，一个像素 2 字节\n\n* PNG_COLOR_TYPE_RGB\n\n  RGB 模式，删除了透明通道，一个像素 3 字节\n\n* PNG_COLOR_TYPE_RGB_ALPHA\n\n  ARGB 模式，一个像素 4 字节\n\n### PNG_COLOR_TYPE_PALETTE\n\n要使用这种模式，需要满足以下两个条件，分别是 Code 5 和 Code 7：\n\nCode 5\n\n``` cpp\n if (isGrayscale) {\n        if (isOpaque) {\n        } else {\n          if (isPalette && (paletteSize < 2 * w * h)) {\n            // ==>> Code 5\n                *colorType = PNG_COLOR_TYPE_PALETTE; // 1 byte/pixel + 4 bytes/color\n            } \n        }\n }\n```\n\n在支持灰度模式的前提下，有透明通道，支持调色板模式，同时调色板的长度小于 `2 * w * h`。\n\nCode 7\n\n``` cpp\nif (isGrayscale) {\n  \n} else {\n  if (isPalette && (paletteSize < bpp * w * h)) {\n    // Code ==>> 7\n        *colorType = PNG_COLOR_TYPE_PALETTE;\n    }\n}\n```\n\n如果不支持灰度模式，但支持调色板，同时调色板长度小于 `bpp * w * h`，其中 `bpp` 的大小根据是否为不透明为决定：\n\n``` cpp\n    int bpp = isOpaque ? 3 : 4;\n```\n\n### PNG_COLOR_TYPE_GRAY\n\n要使用这种模式，需要满足支持灰度模式，同时不透明。代码位于 Code 4：\n\n``` cpp\n if (isGrayscale) {\n        if (isOpaque) {\n          // ==>> Code 4\n            *colorType = PNG_COLOR_TYPE_GRAY; // 1 byte/pixel\n        }\n }\n```\n\n###PNG_COLOR_TYPE_GRAY_ALPHA\n\n灰度，同时存在透明通道的模式。代码位于 Code 6 和 Code 8：\n\nCode 6\n\n``` cpp\n if (isGrayscale) {\n        if (isOpaque) {\n        } else {\n          if (isPalette && (paletteSize < 2 * w * h)) {\n            } else {\n            // ==>> Code 6\n            *colorType = PNG_COLOR_TYPE_GRAY_ALPHA; // 2 bytes per pixel\n          }\n        }\n }\n```\n\nCode 8\n\n``` cpp\nif (isGrayscale) {\n        \n    } else if (isPalette && (paletteSize < bpp * w * h)) {\n    } else {\n        if (maxGrayDeviation <= grayscaleTolerance) {\n          // ==>> Code 8\n            *colorType = isOpaque ? PNG_COLOR_TYPE_GRAY : PNG_COLOR_TYPE_GRAY_ALPHA;\n        } else {\n        }\n    }\n\n```\n\n`maxGrayDeviation` 是计算 RGB 通道直接的差值，如果小于 `grayscaleTolerance` 这个阙值，那么也可以转成灰度。\n\n### PNG_COLOR_TYPE_RGB\n\n不透明图片可以删除透明通道，代码位于 Code 9：\n\n``` cpp\nif (isGrayscale) {\n        \n    } else if (isPalette && (paletteSize < bpp * w * h)) {\n    } else {\n        if (maxGrayDeviation <= grayscaleTolerance) {\n        } else {\n          // ==>> Code 9\n                      *colorType = isOpaque ? PNG_COLOR_TYPE_RGB : PNG_COLOR_TYPE_RGB_ALPHA;\n        }\n    }\n\n\n```\n\n### PNG_COLOR_TYPE_RGB_ALPHA\n\n这个没什么好说的，最后的兜底模式。\n\n### 小结\n\nAAPT 对 PNG 的优化，主要是 Indexed_color 算法，这也是一种保守的选择，因为这种是无损的，如果我们想要更高的压缩率，可以使用一些其他的压缩工具，来集成到我们的编译打包流程中。\n\n## PNG 压缩工具对比\n\n首先，在我们选择其他 PNG 压缩工具其他，我们需要先禁用 AAPT 的默认压缩模式，因为对于 PNG 的压缩，并不是 1 + 1 > 2，可以通过以下代码关闭：\n\n``` groovy\nandroid {\n     aaptOptions {\n        cruncherEnabled = false\n    }\n}\n```\n\n现在常用的 PNG 压缩工具有 [pngcrush](http://pmt.sourceforge.net/pngcrush/)、[pngquant](https://pngquant.org/)、[zopfli](https://github.com/google/zopfli) 、[tinypng](https://tinypng.com) 等，这里我们就先不考虑 tinypng，因为这个只提供了 HTTP 接口的形式，并且有次数限制。\n\n### 使用 Gradle 集成\n\n为了将 PNG 压缩工具集成到 APK 的构建编译流程，我们使用 Gradle 来实现。作者当前使用 Android Gradle 插件版本为 3.5.0，在这个版本我们可以通过 `ApplicationVariant.allRawAndroidResources` 获取所有的资源目录。\n\n需要注意的是，我们这个 Task 需要在 MergeResources 这个 Task 之前执行，这样我们可以将压缩后的同名覆盖，再合并到 APK 文件中。\n\n``` groovy\nafterEvaluate {\n\n        applicationVariants.all { ApplicationVariant variant ->\n\n            if (variant.buildType.name != \"release\") {\n                return\n            }\n\n\n            def compressPngTask = task('compressPng')\n            compressPngTask.doLast {\n                List<File> allResource = []\n\n                variant.allRawAndroidResources.files.forEach { dir ->\n\n                    if (!dir.exists()) {\n                        return\n                    }\n\n                    if (dir.isFile()) {\n                        if (dir.name.endsWith(\".png\")) {\n                            allResource.add(file)\n                        }\n                    } else {\n                        dir.traverse { file ->\n                            if (file.name.endsWith(\".png\")) {\n                                allResource.add(file)\n                            }\n                        }\n                    }\n\n\n                }\n\n\n                allResource.forEach { file ->\n                    // kb\n                    def oldSize = file.size() / 1024f\n\n                    println \"path = ${file.path}\"\n                    try {\n                       // TODO 这里就是我们执行压缩的逻辑\n                    } catch (Throwable ignore) {\n                        println \"file: ${file.name} error: ${ignore.message}\"\n                    }\n\n\n                    println \"${file.name}: $oldSize KB ==> ${file.size() / 1024f} KB\"\n\n                }\n\n\n            }\n\n\n            Task mergeResourcesTask = variant.mergeResourcesProvider.get()\n            mergeResourcesTask.dependsOn(compressPngTask)\n        }\n\n\n    }\n```\n\n首先我们创建一个名为 compressPng 的 Task，这个 Task 的任务就是收集所有 PNG 文件路径，这里我们过滤掉 BuildType 不是 release 的 Variant，最后让 MergeResources Task 依赖于 compressPng Task。\n\n**记得先关掉 AAPT 默认的 PNG 压缩。**\n\n这里我们先记录下关闭 AAPT 默认 PNG 压缩后的 APK 文件大小，和使用默认 PNG 压缩后的 APK 文件大小：\n\n> 这里我找的是一个直播的项目，里面有比较多的图片资源文件，过滤了 JPEG 和 .9 图，大概有 1000多张 PNG 图片，只使用一个压缩线程。\n\n| 压缩工具 | APK 大小（MB） | 耗时   |\n| -------- | -------------- | ------ |\n| 无       | 81.9           | 29s    |\n| AAPT     | 78.9           | 1m 18s |\n\n### pngquant\n\n首先测试 pngquant，我们将pngquant 集成进去：\n\n``` groovy\n                        exec { ExecSpec spec ->\n                            spec.workingDir(project.file('.'))\n                            spec.commandLine(\"./pngquant\", \"--skip-if-larger\", \"--speed\", \"1\", \"--strip\", \"--nofs\", \"--force\", \"--output\", file.path, \"--\", file.path)\n                        }\n```\n\n这里我们用的基本都是默认配置：\n\n* --skip-if-larger 表示如果压缩后的图片更大了，就跳过\n* --speed 1 表示使用最慢的压缩速度，来换取更好的压缩质量\n* --strip 删除图片的一些元数据\n* --nofs 禁用 [Floyd–Steinberg dithering]([https://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering](https://en.wikipedia.org/wiki/Floyd–Steinberg_dithering)) 图像抖动处理\n* --force 覆盖源文件\n* --output 输出文件的路径\n\n先执行 Clean Task，再重新执行打包，最终结果如下：\n\n| 压缩工具 | APK 大小（MB） | 耗时   |\n| -------- | -------------- | ------ |\n| 无       | 81.9           | 29s    |\n| AAPT     | 78.9           | 32s    |\n| pngquant | 73.7           | 1m 18s |\n\n### zopflipng\n\n集成进去：\n\n``` groovy\n                        exec { ExecSpec spec ->\n                            spec.workingDir(new File('/Users/leo/Documents/projects/zopfli'))\n                            spec.commandLine(\"./zopflipng\", \"-y\", \"-m\", file.path, file.path)\n\n                        }\n```\n\n使用的也是基本配置：\n\n* -y 覆盖原文件，不需要询问\n* -m 尽可能多压缩，依赖于文件的大小\n\n先执行 Clean Task，再重新执行打包，最终结果如下：\n\n| 压缩工具  | APK 大小（MB） | 耗时    |\n| --------- | -------------- | ------- |\n| 无        | 81.9           | 29s     |\n| AAPT      | 78.9           | 32s     |\n| pngquant  | 73.7           | 1m 18s  |\n| zopflipng | 78             | 36m 17s |\n\n### pngcursh\n\n集成进去：\n\n``` groovy\n                        exec { ExecSpec spec ->\n                            spec.workingDir(new File('/Users/leo/Documents/projects/pngcrush-1.8.13'))\n                            spec.commandLine(\"./pngcrush\", \"-ow\",\"-reduce\", file.path)\n                        }\n```\n\n使用基本配置：\n\n* -ow 表示覆盖原文件\n* -reduce 减少无损颜色值的类型和位深度\n* -brute 尝试 176 种压缩方法\n\n先执行 Clean Task，再重新执行打包，最终结果如下：\n\n| 压缩工具  | APK 大小（MB） | 耗时    |\n| --------- | -------------- | ------- |\n| 无        | 81.9           | 29s     |\n| AAPT      | 78.9           | 32s     |\n| pngquant  | 73.7           | 1m 18s  |\n| zopflipng | 78             | 36m 17s |\n| pngcursh  | 78.7           | 13m 56s |\n\n### 小结\n\n虽然从结果上来看，pngquant 是最好的选择，但因为 pngcursh 这块使用的只是默认的压缩配置，而且 pngcursh 提供的参数是最多的，所以具体哪个更优，只能靠调参数了，众所周知，调参数也是技术活。\n\n## 总结\n\n推荐使用 WebP 和 SVG 来代替 PNG 和 JPEG 图片的使用，但有些三方库的图片是我们没办法控制的，这块就可以用 PNG 压缩工具来进行优化。至于如果平衡压缩率、压缩耗时，这就是要靠大家去调参数了。","slug":"优化包大小-PNG部分","published":1,"updated":"2022-06-15T11:19:32.323Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlv000tfho6cozy06fb","content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>PNG 图片相对于 JPEG 图片来说，它是一种无损的图像存储格式，同时多了一条透明度通道，所以一般情况下，PNG 图片要比 JPEG 图片要大，并且 PNG 图片往往还是 APK 图片资源中的大头，所以优化 PNG 图片的大小，对于减小包的体积来说，是比较有回报的事情。</p>\n<blockquote>\n<p>关于 PNG 的 wiki：</p>\n<p><strong>便携式网络图形</strong>（英语：<strong>P</strong>ortable <strong>N</strong>etwork <strong>G</strong>raphics，<strong>PNG</strong>）是一种<a href=\"https://zh.wikipedia.org/wiki/%E6%97%A0%E6%8D%9F%E5%8E%8B%E7%BC%A9\">无损压缩</a>的<a href=\"https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%9B%BE\">位图</a>图形格式，支持索引、<a href=\"https://zh.wikipedia.org/wiki/%E7%81%B0%E5%BA%A6\">灰度</a>、<a href=\"https://zh.wikipedia.org/wiki/RGB\">RGB</a>三种颜色方案以及<a href=\"https://zh.wikipedia.org/wiki/Alpha%E9%80%9A%E9%81%93\">Alpha通道</a>等特性。</p>\n<p>关于 JPEG 的 wiki：</p>\n<p><strong>联合图像专家小组</strong>（英语：<strong>J</strong>oint <strong>P</strong>hotographic <strong>E</strong>xperts <strong>G</strong>roup，缩写：<strong>JPEG</strong>）是一种针对照片影像而广泛使用的<a href=\"https://zh.wikipedia.org/wiki/%E6%9C%89%E6%8D%9F%E6%95%B0%E6%8D%AE%E5%8E%8B%E7%BC%A9\">有损压缩</a>标准方法。</p>\n</blockquote>\n<h2 id=\"常用的压缩算法\"><a href=\"#常用的压缩算法\" class=\"headerlink\" title=\"常用的压缩算法\"></a>常用的压缩算法</h2><p>关于 PNG 的压缩算法有很多，这里我们只说两种比较常用的：<a href=\"https://en.wikipedia.org/wiki/Indexed_color\">Indexed_color</a> 和 <a href=\"https://en.wikipedia.org/wiki/Color_quantization\">Color_quantization</a>。这两种也是 Google 在 Android 开发者网站上推荐的，具体可以看 <a href=\"https://developer.android.com/topic/performance/network-xfer\">network-xfer</a>。</p>\n<p>下面我们会简单说下这两种算法的大概原理，更深入的知识请移步 Google 或者 Wiki。</p>\n<h3 id=\"Indexed-color\"><a href=\"#Indexed-color\" class=\"headerlink\" title=\"Indexed_color\"></a>Indexed_color</h3><p>字面意思就是索引颜色，通过将具体的 ARGB 颜色存储转换成索引下表，来减少文件的大小。我们知道 ARGB 中，每个通道的存储都需要 8 位，也就是 1 字节，一个 ARGB 存储就需要 4 字节，而索引的存储只需要 1 字节。而索引指向的颜色会存放在一个叫 palette（调色板）的数组里面。</p>\n<blockquote>\n<p>wiki 定义：</p>\n<p>在计算中，<strong>索引颜色</strong>是一种以有限的方式管理<a href=\"https://en.wikipedia.org/wiki/Digital_image\">数字图像</a>颜色的技术，以节省计算机<a href=\"https://en.wikipedia.org/wiki/Computer_data_storage\">内存</a>和<a href=\"https://en.wikipedia.org/wiki/Hard_disk_drive\">文件存储空间</a>，同时加快显示刷新和文件传输的速度。它是<a href=\"https://en.wikipedia.org/wiki/Vector_quantization#Use_in_data_compression\">矢量量化压缩的</a>一种形式。</p>\n</blockquote>\n<p>图片来自于 wiki：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/12/4/16ed048e29449106?w=150&h=400&f=png&s=2151\" alt=\"Indexed_color\"></p>\n<p>这种算法很好，但也有缺点，调色板的大小通常只支持 4,16,256 这几种，也就是说最大不会超过 256 个，所以能应用这种算法的 PNG 图片中的颜色使用不能超过 256 个。</p>\n<h3 id=\"Color-quantization\"><a href=\"#Color-quantization\" class=\"headerlink\" title=\"Color_quantization\"></a>Color_quantization</h3><p>字面意思就是颜色矢量化，通过使用相似颜色来减少图像中使用的颜色种类，再配合调色板，来达到减少图片文件大小的目的，这是一种有损的压缩算法。</p>\n<p>图片来自于 wiki：</p>\n<p>这是使用标准的 24 位 RGB 颜色的图像： </p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/12/4/16ed048e2746717e?w=250&h=200&f=png&s=83335\" alt=\"24位RGB\"></p>\n<p>这是优化成只使用 16 种颜色的图像：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/12/4/16ed048e299d4616?w=250&h=216&f=png&s=9121\" alt=\"16种颜色\"></p>\n<p>这种算法的缺点就是质量有损，所以如何在质量和大小中间达到一个平衡点，这个至关重要。</p>\n<h2 id=\"谈谈-AAPT\"><a href=\"#谈谈-AAPT\" class=\"headerlink\" title=\"谈谈 AAPT\"></a>谈谈 AAPT</h2><p>AAPT 是 Android 的资源打包工具，我们常用的 R 文件就是用它生存的，除此之外，它还有压缩 PNG 图片的功能。AAPT 现在有 AAPT 和 AAPT2 了，默认我们都是说的是 AAPT2。</p>\n<blockquote>\n<p>关于 AAPT2 对于 PNG 图片的压缩知识，可以看下 Colt McAnlis 的这篇文章，<a href=\"https://medium.com/@duhroach/smaller-pngs-and-android-s-aapt-tool-4ce38a24019d\">Smaller PNGs, and Android’s AAPT tool</a></p>\n<p>PS：作者就是 Android 性能宝典里面那个光头。。。</p>\n</blockquote>\n<p>AAPT2 对于 PNG 图片的压缩可以分为三个方面：</p>\n<ul>\n<li>RGB 是否可以转化成灰度</li>\n<li>透明通道是否可以删除</li>\n<li>是不是最多只有 256 色（Indexed_color 优化）</li>\n</ul>\n<p>接下来，我们从源码入手，只看看上面所说的这几点吧。</p>\n<blockquote>\n<p>源码分析用的是 Android 6.0 也就是 marshmallow 的版本：</p>\n<p><a href=\"https://android.googlesource.com/platform/frameworks/base/+/marshmallow-dev/tools/aapt2/Png.cpp\">https://android.googlesource.com/platform/frameworks/base/+/marshmallow-dev/tools/aapt2/Png.cpp</a></p>\n</blockquote>\n<p>对于 PNG 的分析代码位于 <code>analyze_image()</code> 这个方法中，国际惯例，删除一些不影响分析的代码。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">analyze_image</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> w = imageInfo.width;</span><br><span class=\"line\">    <span class=\"type\">int</span> h = imageInfo.height;</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> colors[<span class=\"number\">256</span>], col;</span><br><span class=\"line\">    <span class=\"type\">int</span> num_colors = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"type\">bool</span> isOpaque = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"type\">bool</span> isPalette = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"type\">bool</span> isGrayscale = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"comment\">// Scan the entire image and determine if:</span></span><br><span class=\"line\">    <span class=\"comment\">// 1. Every pixel has R == G == B (grayscale)</span></span><br><span class=\"line\">    <span class=\"comment\">// 2. Every pixel has A == 255 (opaque)</span></span><br><span class=\"line\">    <span class=\"comment\">// 3. There are no more than 256 distinct RGBA colors</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (j = <span class=\"number\">0</span>; j &lt; h; j++) &#123;</span><br><span class=\"line\">        <span class=\"type\">const</span> png_byte* row = imageInfo.rows[j];</span><br><span class=\"line\">        png_bytep out = outRows[j];</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; w; i++) &#123;</span><br><span class=\"line\">            rr = *row++;</span><br><span class=\"line\">            gg = *row++;</span><br><span class=\"line\">            bb = *row++;</span><br><span class=\"line\">            aa = *row++;</span><br><span class=\"line\">            <span class=\"type\">int</span> odev = maxGrayDeviation;</span><br><span class=\"line\">            maxGrayDeviation = <span class=\"built_in\">MAX</span>(<span class=\"built_in\">ABS</span>(rr - gg), maxGrayDeviation);</span><br><span class=\"line\">            maxGrayDeviation = <span class=\"built_in\">MAX</span>(<span class=\"built_in\">ABS</span>(gg - bb), maxGrayDeviation);</span><br><span class=\"line\">            maxGrayDeviation = <span class=\"built_in\">MAX</span>(<span class=\"built_in\">ABS</span>(bb - rr), maxGrayDeviation);</span><br><span class=\"line\">          </span><br><span class=\"line\">            <span class=\"comment\">// Check if image is really grayscale</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (rr != gg || rr != bb) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// ==&gt;&gt; Code 1</span></span><br><span class=\"line\">                    isGrayscale = <span class=\"literal\">false</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// Check if image is really opaque</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isOpaque) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (aa != <span class=\"number\">0xff</span>) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// ==&gt;&gt; Code 2</span></span><br><span class=\"line\">                    isOpaque = <span class=\"literal\">false</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// Check if image is really &lt;= 256 colors</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isPalette) &#123;</span><br><span class=\"line\">                col = (<span class=\"type\">uint32_t</span>) ((rr &lt;&lt; <span class=\"number\">24</span>) | (gg &lt;&lt; <span class=\"number\">16</span>) | (bb &lt;&lt; <span class=\"number\">8</span>) | aa);</span><br><span class=\"line\">                <span class=\"type\">bool</span> match = <span class=\"literal\">false</span>;</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (idx = <span class=\"number\">0</span>; idx &lt; num_colors; idx++) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (colors[idx] == col) &#123;</span><br><span class=\"line\">                        match = <span class=\"literal\">true</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!match) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (num_colors == <span class=\"number\">256</span>) &#123;</span><br><span class=\"line\">                      <span class=\"comment\">// ==&gt;&gt; Code 3</span></span><br><span class=\"line\">                        isPalette = <span class=\"literal\">false</span>;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        colors[num_colors++] = col;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    *paletteEntries = <span class=\"number\">0</span>;</span><br><span class=\"line\">    *hasTransparency = !isOpaque;</span><br><span class=\"line\">    <span class=\"type\">int</span> bpp = isOpaque ? <span class=\"number\">3</span> : <span class=\"number\">4</span>;</span><br><span class=\"line\">    <span class=\"type\">int</span> paletteSize = w * h + bpp * num_colors;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// Choose the best color type for the image.</span></span><br><span class=\"line\">    <span class=\"comment\">// 1. Opaque gray - use COLOR_TYPE_GRAY at 1 byte/pixel</span></span><br><span class=\"line\">    <span class=\"comment\">// 2. Gray + alpha - use COLOR_TYPE_PALETTE if the number of distinct combinations</span></span><br><span class=\"line\">    <span class=\"comment\">//     is sufficiently small, otherwise use COLOR_TYPE_GRAY_ALPHA</span></span><br><span class=\"line\">    <span class=\"comment\">// 3. RGB(A) - use COLOR_TYPE_PALETTE if the number of distinct colors is sufficiently</span></span><br><span class=\"line\">    <span class=\"comment\">//     small, otherwise use COLOR_TYPE_RGB&#123;_ALPHA&#125;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isOpaque) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// ==&gt;&gt; Code 4</span></span><br><span class=\"line\">            *colorType = PNG_COLOR_TYPE_GRAY; <span class=\"comment\">// 1 byte/pixel</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Use a simple heuristic to determine whether using a palette will</span></span><br><span class=\"line\">            <span class=\"comment\">// save space versus using gray + alpha for each pixel.</span></span><br><span class=\"line\">            <span class=\"comment\">// This doesn&#x27;t take into account chunk overhead, filtering, LZ</span></span><br><span class=\"line\">            <span class=\"comment\">// compression, etc.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; <span class=\"number\">2</span> * w * h)) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// ==&gt;&gt; Code 5</span></span><br><span class=\"line\">                *colorType = PNG_COLOR_TYPE_PALETTE; <span class=\"comment\">// 1 byte/pixel + 4 bytes/color</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// ==&gt;&gt; Code 6</span></span><br><span class=\"line\">                *colorType = PNG_COLOR_TYPE_GRAY_ALPHA; <span class=\"comment\">// 2 bytes per pixel</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; bpp * w * h)) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ==&gt;&gt; Code 7</span></span><br><span class=\"line\">        *colorType = PNG_COLOR_TYPE_PALETTE;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (maxGrayDeviation &lt;= grayscaleTolerance) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// ==&gt;&gt; Code 8</span></span><br><span class=\"line\">            *colorType = isOpaque ? PNG_COLOR_TYPE_GRAY : PNG_COLOR_TYPE_GRAY_ALPHA;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// ==&gt;&gt; Code 9</span></span><br><span class=\"line\">            *colorType = isOpaque ? PNG_COLOR_TYPE_RGB : PNG_COLOR_TYPE_RGB_ALPHA;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先定义了 3 个变量分别表示：isOpaque（是否不透明），isPalette（是否支持调色板），isGrayscale（是否可转化为灰度）。</p>\n<p>首先看 Code 1 处的代码：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (rr != gg || rr != bb) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ==&gt;&gt; Code 1</span></span><br><span class=\"line\">    isGrayscale = <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>只有 RGB 三种通道的颜色都一样，才能转化成灰度。</p>\n<p>Code 2 处的代码是判断透明通道是否为 0，也就是是不是不透明：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (aa != <span class=\"number\">0xff</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ==&gt;&gt; Code 2</span></span><br><span class=\"line\">    isOpaque = <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>而 Code 3 处则是判断是否可以用 256 色的调色板：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!match) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (num_colors == <span class=\"number\">256</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ==&gt;&gt; Code 3</span></span><br><span class=\"line\">        isPalette = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        colors[num_colors++] = col;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>colors</code> 是一个数组，里面存放的是图片中已经出现的（不重复）颜色，当颜色的数量大于 256 即表示不支持调色板模式。</p>\n<p>然后根据这些条件，来判断使用哪种存储模式，AAPT 中支持的存储模式有以下几种：</p>\n<ul>\n<li><p>PNG_COLOR_TYPE_PALETTE</p>\n<p>使用调色板模式，最终图片的大小就是 一个像素 1 字节 + 调色板中一个颜色 4 字节</p>\n</li>\n<li><p>PNG_COLOR_TYPE_GRAY</p>\n<p>灰度模式，这种是最节省的模式，一个像素 1 字节</p>\n</li>\n<li><p>PNG_COLOR_TYPE_GRAY_ALPHA</p>\n<p>灰度模式，同时存在透明通道，一个像素 2 字节</p>\n</li>\n<li><p>PNG_COLOR_TYPE_RGB</p>\n<p>RGB 模式，删除了透明通道，一个像素 3 字节</p>\n</li>\n<li><p>PNG_COLOR_TYPE_RGB_ALPHA</p>\n<p>ARGB 模式，一个像素 4 字节</p>\n</li>\n</ul>\n<h3 id=\"PNG-COLOR-TYPE-PALETTE\"><a href=\"#PNG-COLOR-TYPE-PALETTE\" class=\"headerlink\" title=\"PNG_COLOR_TYPE_PALETTE\"></a>PNG_COLOR_TYPE_PALETTE</h3><p>要使用这种模式，需要满足以下两个条件，分别是 Code 5 和 Code 7：</p>\n<p>Code 5</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (isOpaque) &#123;</span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; <span class=\"number\">2</span> * w * h)) &#123;</span><br><span class=\"line\">           <span class=\"comment\">// ==&gt;&gt; Code 5</span></span><br><span class=\"line\">               *colorType = PNG_COLOR_TYPE_PALETTE; <span class=\"comment\">// 1 byte/pixel + 4 bytes/color</span></span><br><span class=\"line\">           &#125; </span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在支持灰度模式的前提下，有透明通道，支持调色板模式，同时调色板的长度小于 <code>2 * w * h</code>。</p>\n<p>Code 7</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; bpp * w * h)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Code ==&gt;&gt; 7</span></span><br><span class=\"line\">        *colorType = PNG_COLOR_TYPE_PALETTE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果不支持灰度模式，但支持调色板，同时调色板长度小于 <code>bpp * w * h</code>，其中 <code>bpp</code> 的大小根据是否为不透明为决定：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> bpp = isOpaque ? <span class=\"number\">3</span> : <span class=\"number\">4</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"PNG-COLOR-TYPE-GRAY\"><a href=\"#PNG-COLOR-TYPE-GRAY\" class=\"headerlink\" title=\"PNG_COLOR_TYPE_GRAY\"></a>PNG_COLOR_TYPE_GRAY</h3><p>要使用这种模式，需要满足支持灰度模式，同时不透明。代码位于 Code 4：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (isOpaque) &#123;</span><br><span class=\"line\">         <span class=\"comment\">// ==&gt;&gt; Code 4</span></span><br><span class=\"line\">           *colorType = PNG_COLOR_TYPE_GRAY; <span class=\"comment\">// 1 byte/pixel</span></span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>###PNG_COLOR_TYPE_GRAY_ALPHA</p>\n<p>灰度，同时存在透明通道的模式。代码位于 Code 6 和 Code 8：</p>\n<p>Code 6</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (isOpaque) &#123;</span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; <span class=\"number\">2</span> * w * h)) &#123;</span><br><span class=\"line\">           &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">           <span class=\"comment\">// ==&gt;&gt; Code 6</span></span><br><span class=\"line\">           *colorType = PNG_COLOR_TYPE_GRAY_ALPHA; <span class=\"comment\">// 2 bytes per pixel</span></span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Code 8</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; bpp * w * h)) &#123;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (maxGrayDeviation &lt;= grayscaleTolerance) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// ==&gt;&gt; Code 8</span></span><br><span class=\"line\">            *colorType = isOpaque ? PNG_COLOR_TYPE_GRAY : PNG_COLOR_TYPE_GRAY_ALPHA;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><code>maxGrayDeviation</code> 是计算 RGB 通道直接的差值，如果小于 <code>grayscaleTolerance</code> 这个阙值，那么也可以转成灰度。</p>\n<h3 id=\"PNG-COLOR-TYPE-RGB\"><a href=\"#PNG-COLOR-TYPE-RGB\" class=\"headerlink\" title=\"PNG_COLOR_TYPE_RGB\"></a>PNG_COLOR_TYPE_RGB</h3><p>不透明图片可以删除透明通道，代码位于 Code 9：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; bpp * w * h)) &#123;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (maxGrayDeviation &lt;= grayscaleTolerance) &#123;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// ==&gt;&gt; Code 9</span></span><br><span class=\"line\">                      *colorType = isOpaque ? PNG_COLOR_TYPE_RGB : PNG_COLOR_TYPE_RGB_ALPHA;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"PNG-COLOR-TYPE-RGB-ALPHA\"><a href=\"#PNG-COLOR-TYPE-RGB-ALPHA\" class=\"headerlink\" title=\"PNG_COLOR_TYPE_RGB_ALPHA\"></a>PNG_COLOR_TYPE_RGB_ALPHA</h3><p>这个没什么好说的，最后的兜底模式。</p>\n<h3 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h3><p>AAPT 对 PNG 的优化，主要是 Indexed_color 算法，这也是一种保守的选择，因为这种是无损的，如果我们想要更高的压缩率，可以使用一些其他的压缩工具，来集成到我们的编译打包流程中。</p>\n<h2 id=\"PNG-压缩工具对比\"><a href=\"#PNG-压缩工具对比\" class=\"headerlink\" title=\"PNG 压缩工具对比\"></a>PNG 压缩工具对比</h2><p>首先，在我们选择其他 PNG 压缩工具其他，我们需要先禁用 AAPT 的默认压缩模式，因为对于 PNG 的压缩，并不是 1 + 1 &gt; 2，可以通过以下代码关闭：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">android &#123;</span><br><span class=\"line\">     aaptOptions &#123;</span><br><span class=\"line\">        cruncherEnabled = <span class=\"literal\">false</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>现在常用的 PNG 压缩工具有 <a href=\"http://pmt.sourceforge.net/pngcrush/\">pngcrush</a>、<a href=\"https://pngquant.org/\">pngquant</a>、<a href=\"https://github.com/google/zopfli\">zopfli</a> 、<a href=\"https://tinypng.com/\">tinypng</a> 等，这里我们就先不考虑 tinypng，因为这个只提供了 HTTP 接口的形式，并且有次数限制。</p>\n<h3 id=\"使用-Gradle-集成\"><a href=\"#使用-Gradle-集成\" class=\"headerlink\" title=\"使用 Gradle 集成\"></a>使用 Gradle 集成</h3><p>为了将 PNG 压缩工具集成到 APK 的构建编译流程，我们使用 Gradle 来实现。作者当前使用 Android Gradle 插件版本为 3.5.0，在这个版本我们可以通过 <code>ApplicationVariant.allRawAndroidResources</code> 获取所有的资源目录。</p>\n<p>需要注意的是，我们这个 Task 需要在 MergeResources 这个 Task 之前执行，这样我们可以将压缩后的同名覆盖，再合并到 APK 文件中。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">afterEvaluate &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        applicationVariants.all &#123; ApplicationVariant variant -&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (variant.buildType.name != <span class=\"string\">&quot;release&quot;</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">def</span> compressPngTask = task(<span class=\"string\">&#x27;compressPng&#x27;</span>)</span><br><span class=\"line\">            compressPngTask.doLast &#123;</span><br><span class=\"line\">                List&lt;File&gt; allResource = []</span><br><span class=\"line\"></span><br><span class=\"line\">                variant.allRawAndroidResources.files.forEach &#123; dir -&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!dir.exists()) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (dir.isFile()) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (dir.name.endsWith(<span class=\"string\">&quot;.png&quot;</span>)) &#123;</span><br><span class=\"line\">                            allResource.add(file)</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        dir.traverse &#123; file -&gt;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (file.name.endsWith(<span class=\"string\">&quot;.png&quot;</span>)) &#123;</span><br><span class=\"line\">                                allResource.add(file)</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">                allResource.forEach &#123; file -&gt;</span><br><span class=\"line\">                    <span class=\"comment\">// kb</span></span><br><span class=\"line\">                    <span class=\"keyword\">def</span> oldSize = file.size() / <span class=\"number\">1024</span>f</span><br><span class=\"line\"></span><br><span class=\"line\">                    println <span class=\"string\">&quot;path = $&#123;file.path&#125;&quot;</span></span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                       <span class=\"comment\">// TODO 这里就是我们执行压缩的逻辑</span></span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (Throwable ignore) &#123;</span><br><span class=\"line\">                        println <span class=\"string\">&quot;file: $&#123;file.name&#125; error: $&#123;ignore.message&#125;&quot;</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">                    println <span class=\"string\">&quot;$&#123;file.name&#125;: $oldSize KB ==&gt; $&#123;file.size() / 1024f&#125; KB&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            Task mergeResourcesTask = variant.mergeResourcesProvider.get()</span><br><span class=\"line\">            mergeResourcesTask.dependsOn(compressPngTask)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先我们创建一个名为 compressPng 的 Task，这个 Task 的任务就是收集所有 PNG 文件路径，这里我们过滤掉 BuildType 不是 release 的 Variant，最后让 MergeResources Task 依赖于 compressPng Task。</p>\n<p><strong>记得先关掉 AAPT 默认的 PNG 压缩。</strong></p>\n<p>这里我们先记录下关闭 AAPT 默认 PNG 压缩后的 APK 文件大小，和使用默认 PNG 压缩后的 APK 文件大小：</p>\n<blockquote>\n<p>这里我找的是一个直播的项目，里面有比较多的图片资源文件，过滤了 JPEG 和 .9 图，大概有 1000多张 PNG 图片，只使用一个压缩线程。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>压缩工具</th>\n<th>APK 大小（MB）</th>\n<th>耗时</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>无</td>\n<td>81.9</td>\n<td>29s</td>\n</tr>\n<tr>\n<td>AAPT</td>\n<td>78.9</td>\n<td>1m 18s</td>\n</tr>\n</tbody></table>\n<h3 id=\"pngquant\"><a href=\"#pngquant\" class=\"headerlink\" title=\"pngquant\"></a>pngquant</h3><p>首先测试 pngquant，我们将pngquant 集成进去：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exec &#123; ExecSpec spec -&gt;</span><br><span class=\"line\">    spec.workingDir(project.file(<span class=\"string\">&#x27;.&#x27;</span>))</span><br><span class=\"line\">    spec.commandLine(<span class=\"string\">&quot;./pngquant&quot;</span>, <span class=\"string\">&quot;--skip-if-larger&quot;</span>, <span class=\"string\">&quot;--speed&quot;</span>, <span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;--strip&quot;</span>, <span class=\"string\">&quot;--nofs&quot;</span>, <span class=\"string\">&quot;--force&quot;</span>, <span class=\"string\">&quot;--output&quot;</span>, file.path, <span class=\"string\">&quot;--&quot;</span>, file.path)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里我们用的基本都是默认配置：</p>\n<ul>\n<li>–skip-if-larger 表示如果压缩后的图片更大了，就跳过</li>\n<li>–speed 1 表示使用最慢的压缩速度，来换取更好的压缩质量</li>\n<li>–strip 删除图片的一些元数据</li>\n<li>–nofs 禁用 <a href=\"%5Bhttps://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering%5D(https://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering)\">Floyd–Steinberg dithering</a> 图像抖动处理</li>\n<li>–force 覆盖源文件</li>\n<li>–output 输出文件的路径</li>\n</ul>\n<p>先执行 Clean Task，再重新执行打包，最终结果如下：</p>\n<table>\n<thead>\n<tr>\n<th>压缩工具</th>\n<th>APK 大小（MB）</th>\n<th>耗时</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>无</td>\n<td>81.9</td>\n<td>29s</td>\n</tr>\n<tr>\n<td>AAPT</td>\n<td>78.9</td>\n<td>32s</td>\n</tr>\n<tr>\n<td>pngquant</td>\n<td>73.7</td>\n<td>1m 18s</td>\n</tr>\n</tbody></table>\n<h3 id=\"zopflipng\"><a href=\"#zopflipng\" class=\"headerlink\" title=\"zopflipng\"></a>zopflipng</h3><p>集成进去：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exec &#123; ExecSpec spec -&gt;</span><br><span class=\"line\">    spec.workingDir(<span class=\"keyword\">new</span> File(<span class=\"string\">&#x27;/Users/leo/Documents/projects/zopfli&#x27;</span>))</span><br><span class=\"line\">    spec.commandLine(<span class=\"string\">&quot;./zopflipng&quot;</span>, <span class=\"string\">&quot;-y&quot;</span>, <span class=\"string\">&quot;-m&quot;</span>, file.path, file.path)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>使用的也是基本配置：</p>\n<ul>\n<li>-y 覆盖原文件，不需要询问</li>\n<li>-m 尽可能多压缩，依赖于文件的大小</li>\n</ul>\n<p>先执行 Clean Task，再重新执行打包，最终结果如下：</p>\n<table>\n<thead>\n<tr>\n<th>压缩工具</th>\n<th>APK 大小（MB）</th>\n<th>耗时</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>无</td>\n<td>81.9</td>\n<td>29s</td>\n</tr>\n<tr>\n<td>AAPT</td>\n<td>78.9</td>\n<td>32s</td>\n</tr>\n<tr>\n<td>pngquant</td>\n<td>73.7</td>\n<td>1m 18s</td>\n</tr>\n<tr>\n<td>zopflipng</td>\n<td>78</td>\n<td>36m 17s</td>\n</tr>\n</tbody></table>\n<h3 id=\"pngcursh\"><a href=\"#pngcursh\" class=\"headerlink\" title=\"pngcursh\"></a>pngcursh</h3><p>集成进去：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exec &#123; ExecSpec spec -&gt;</span><br><span class=\"line\">    spec.workingDir(<span class=\"keyword\">new</span> File(<span class=\"string\">&#x27;/Users/leo/Documents/projects/pngcrush-1.8.13&#x27;</span>))</span><br><span class=\"line\">    spec.commandLine(<span class=\"string\">&quot;./pngcrush&quot;</span>, <span class=\"string\">&quot;-ow&quot;</span>,<span class=\"string\">&quot;-reduce&quot;</span>, file.path)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>使用基本配置：</p>\n<ul>\n<li>-ow 表示覆盖原文件</li>\n<li>-reduce 减少无损颜色值的类型和位深度</li>\n<li>-brute 尝试 176 种压缩方法</li>\n</ul>\n<p>先执行 Clean Task，再重新执行打包，最终结果如下：</p>\n<table>\n<thead>\n<tr>\n<th>压缩工具</th>\n<th>APK 大小（MB）</th>\n<th>耗时</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>无</td>\n<td>81.9</td>\n<td>29s</td>\n</tr>\n<tr>\n<td>AAPT</td>\n<td>78.9</td>\n<td>32s</td>\n</tr>\n<tr>\n<td>pngquant</td>\n<td>73.7</td>\n<td>1m 18s</td>\n</tr>\n<tr>\n<td>zopflipng</td>\n<td>78</td>\n<td>36m 17s</td>\n</tr>\n<tr>\n<td>pngcursh</td>\n<td>78.7</td>\n<td>13m 56s</td>\n</tr>\n</tbody></table>\n<h3 id=\"小结-1\"><a href=\"#小结-1\" class=\"headerlink\" title=\"小结\"></a>小结</h3><p>虽然从结果上来看，pngquant 是最好的选择，但因为 pngcursh 这块使用的只是默认的压缩配置，而且 pngcursh 提供的参数是最多的，所以具体哪个更优，只能靠调参数了，众所周知，调参数也是技术活。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>推荐使用 WebP 和 SVG 来代替 PNG 和 JPEG 图片的使用，但有些三方库的图片是我们没办法控制的，这块就可以用 PNG 压缩工具来进行优化。至于如果平衡压缩率、压缩耗时，这就是要靠大家去调参数了。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>PNG 图片相对于 JPEG 图片来说，它是一种无损的图像存储格式，同时多了一条透明度通道，所以一般情况下，PNG 图片要比 JPEG 图片要大，并且 PNG 图片往往还是 APK 图片资源中的大头，所以优化 PNG 图片的大小，对于减小包的体积来说，是比较有回报的事情。</p>\n<blockquote>\n<p>关于 PNG 的 wiki：</p>\n<p><strong>便携式网络图形</strong>（英语：<strong>P</strong>ortable <strong>N</strong>etwork <strong>G</strong>raphics，<strong>PNG</strong>）是一种<a href=\"https://zh.wikipedia.org/wiki/%E6%97%A0%E6%8D%9F%E5%8E%8B%E7%BC%A9\">无损压缩</a>的<a href=\"https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%9B%BE\">位图</a>图形格式，支持索引、<a href=\"https://zh.wikipedia.org/wiki/%E7%81%B0%E5%BA%A6\">灰度</a>、<a href=\"https://zh.wikipedia.org/wiki/RGB\">RGB</a>三种颜色方案以及<a href=\"https://zh.wikipedia.org/wiki/Alpha%E9%80%9A%E9%81%93\">Alpha通道</a>等特性。</p>\n<p>关于 JPEG 的 wiki：</p>\n<p><strong>联合图像专家小组</strong>（英语：<strong>J</strong>oint <strong>P</strong>hotographic <strong>E</strong>xperts <strong>G</strong>roup，缩写：<strong>JPEG</strong>）是一种针对照片影像而广泛使用的<a href=\"https://zh.wikipedia.org/wiki/%E6%9C%89%E6%8D%9F%E6%95%B0%E6%8D%AE%E5%8E%8B%E7%BC%A9\">有损压缩</a>标准方法。</p>\n</blockquote>\n<h2 id=\"常用的压缩算法\"><a href=\"#常用的压缩算法\" class=\"headerlink\" title=\"常用的压缩算法\"></a>常用的压缩算法</h2><p>关于 PNG 的压缩算法有很多，这里我们只说两种比较常用的：<a href=\"https://en.wikipedia.org/wiki/Indexed_color\">Indexed_color</a> 和 <a href=\"https://en.wikipedia.org/wiki/Color_quantization\">Color_quantization</a>。这两种也是 Google 在 Android 开发者网站上推荐的，具体可以看 <a href=\"https://developer.android.com/topic/performance/network-xfer\">network-xfer</a>。</p>\n<p>下面我们会简单说下这两种算法的大概原理，更深入的知识请移步 Google 或者 Wiki。</p>\n<h3 id=\"Indexed-color\"><a href=\"#Indexed-color\" class=\"headerlink\" title=\"Indexed_color\"></a>Indexed_color</h3><p>字面意思就是索引颜色，通过将具体的 ARGB 颜色存储转换成索引下表，来减少文件的大小。我们知道 ARGB 中，每个通道的存储都需要 8 位，也就是 1 字节，一个 ARGB 存储就需要 4 字节，而索引的存储只需要 1 字节。而索引指向的颜色会存放在一个叫 palette（调色板）的数组里面。</p>\n<blockquote>\n<p>wiki 定义：</p>\n<p>在计算中，<strong>索引颜色</strong>是一种以有限的方式管理<a href=\"https://en.wikipedia.org/wiki/Digital_image\">数字图像</a>颜色的技术，以节省计算机<a href=\"https://en.wikipedia.org/wiki/Computer_data_storage\">内存</a>和<a href=\"https://en.wikipedia.org/wiki/Hard_disk_drive\">文件存储空间</a>，同时加快显示刷新和文件传输的速度。它是<a href=\"https://en.wikipedia.org/wiki/Vector_quantization#Use_in_data_compression\">矢量量化压缩的</a>一种形式。</p>\n</blockquote>\n<p>图片来自于 wiki：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/12/4/16ed048e29449106?w=150&h=400&f=png&s=2151\" alt=\"Indexed_color\"></p>\n<p>这种算法很好，但也有缺点，调色板的大小通常只支持 4,16,256 这几种，也就是说最大不会超过 256 个，所以能应用这种算法的 PNG 图片中的颜色使用不能超过 256 个。</p>\n<h3 id=\"Color-quantization\"><a href=\"#Color-quantization\" class=\"headerlink\" title=\"Color_quantization\"></a>Color_quantization</h3><p>字面意思就是颜色矢量化，通过使用相似颜色来减少图像中使用的颜色种类，再配合调色板，来达到减少图片文件大小的目的，这是一种有损的压缩算法。</p>\n<p>图片来自于 wiki：</p>\n<p>这是使用标准的 24 位 RGB 颜色的图像： </p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/12/4/16ed048e2746717e?w=250&h=200&f=png&s=83335\" alt=\"24位RGB\"></p>\n<p>这是优化成只使用 16 种颜色的图像：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/12/4/16ed048e299d4616?w=250&h=216&f=png&s=9121\" alt=\"16种颜色\"></p>\n<p>这种算法的缺点就是质量有损，所以如何在质量和大小中间达到一个平衡点，这个至关重要。</p>\n<h2 id=\"谈谈-AAPT\"><a href=\"#谈谈-AAPT\" class=\"headerlink\" title=\"谈谈 AAPT\"></a>谈谈 AAPT</h2><p>AAPT 是 Android 的资源打包工具，我们常用的 R 文件就是用它生存的，除此之外，它还有压缩 PNG 图片的功能。AAPT 现在有 AAPT 和 AAPT2 了，默认我们都是说的是 AAPT2。</p>\n<blockquote>\n<p>关于 AAPT2 对于 PNG 图片的压缩知识，可以看下 Colt McAnlis 的这篇文章，<a href=\"https://medium.com/@duhroach/smaller-pngs-and-android-s-aapt-tool-4ce38a24019d\">Smaller PNGs, and Android’s AAPT tool</a></p>\n<p>PS：作者就是 Android 性能宝典里面那个光头。。。</p>\n</blockquote>\n<p>AAPT2 对于 PNG 图片的压缩可以分为三个方面：</p>\n<ul>\n<li>RGB 是否可以转化成灰度</li>\n<li>透明通道是否可以删除</li>\n<li>是不是最多只有 256 色（Indexed_color 优化）</li>\n</ul>\n<p>接下来，我们从源码入手，只看看上面所说的这几点吧。</p>\n<blockquote>\n<p>源码分析用的是 Android 6.0 也就是 marshmallow 的版本：</p>\n<p><a href=\"https://android.googlesource.com/platform/frameworks/base/+/marshmallow-dev/tools/aapt2/Png.cpp\">https://android.googlesource.com/platform/frameworks/base/+/marshmallow-dev/tools/aapt2/Png.cpp</a></p>\n</blockquote>\n<p>对于 PNG 的分析代码位于 <code>analyze_image()</code> 这个方法中，国际惯例，删除一些不影响分析的代码。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">analyze_image</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> w = imageInfo.width;</span><br><span class=\"line\">    <span class=\"type\">int</span> h = imageInfo.height;</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> colors[<span class=\"number\">256</span>], col;</span><br><span class=\"line\">    <span class=\"type\">int</span> num_colors = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"type\">bool</span> isOpaque = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"type\">bool</span> isPalette = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"type\">bool</span> isGrayscale = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"comment\">// Scan the entire image and determine if:</span></span><br><span class=\"line\">    <span class=\"comment\">// 1. Every pixel has R == G == B (grayscale)</span></span><br><span class=\"line\">    <span class=\"comment\">// 2. Every pixel has A == 255 (opaque)</span></span><br><span class=\"line\">    <span class=\"comment\">// 3. There are no more than 256 distinct RGBA colors</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (j = <span class=\"number\">0</span>; j &lt; h; j++) &#123;</span><br><span class=\"line\">        <span class=\"type\">const</span> png_byte* row = imageInfo.rows[j];</span><br><span class=\"line\">        png_bytep out = outRows[j];</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; w; i++) &#123;</span><br><span class=\"line\">            rr = *row++;</span><br><span class=\"line\">            gg = *row++;</span><br><span class=\"line\">            bb = *row++;</span><br><span class=\"line\">            aa = *row++;</span><br><span class=\"line\">            <span class=\"type\">int</span> odev = maxGrayDeviation;</span><br><span class=\"line\">            maxGrayDeviation = <span class=\"built_in\">MAX</span>(<span class=\"built_in\">ABS</span>(rr - gg), maxGrayDeviation);</span><br><span class=\"line\">            maxGrayDeviation = <span class=\"built_in\">MAX</span>(<span class=\"built_in\">ABS</span>(gg - bb), maxGrayDeviation);</span><br><span class=\"line\">            maxGrayDeviation = <span class=\"built_in\">MAX</span>(<span class=\"built_in\">ABS</span>(bb - rr), maxGrayDeviation);</span><br><span class=\"line\">          </span><br><span class=\"line\">            <span class=\"comment\">// Check if image is really grayscale</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (rr != gg || rr != bb) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// ==&gt;&gt; Code 1</span></span><br><span class=\"line\">                    isGrayscale = <span class=\"literal\">false</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// Check if image is really opaque</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isOpaque) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (aa != <span class=\"number\">0xff</span>) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// ==&gt;&gt; Code 2</span></span><br><span class=\"line\">                    isOpaque = <span class=\"literal\">false</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// Check if image is really &lt;= 256 colors</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isPalette) &#123;</span><br><span class=\"line\">                col = (<span class=\"type\">uint32_t</span>) ((rr &lt;&lt; <span class=\"number\">24</span>) | (gg &lt;&lt; <span class=\"number\">16</span>) | (bb &lt;&lt; <span class=\"number\">8</span>) | aa);</span><br><span class=\"line\">                <span class=\"type\">bool</span> match = <span class=\"literal\">false</span>;</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (idx = <span class=\"number\">0</span>; idx &lt; num_colors; idx++) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (colors[idx] == col) &#123;</span><br><span class=\"line\">                        match = <span class=\"literal\">true</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!match) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (num_colors == <span class=\"number\">256</span>) &#123;</span><br><span class=\"line\">                      <span class=\"comment\">// ==&gt;&gt; Code 3</span></span><br><span class=\"line\">                        isPalette = <span class=\"literal\">false</span>;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        colors[num_colors++] = col;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    *paletteEntries = <span class=\"number\">0</span>;</span><br><span class=\"line\">    *hasTransparency = !isOpaque;</span><br><span class=\"line\">    <span class=\"type\">int</span> bpp = isOpaque ? <span class=\"number\">3</span> : <span class=\"number\">4</span>;</span><br><span class=\"line\">    <span class=\"type\">int</span> paletteSize = w * h + bpp * num_colors;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// Choose the best color type for the image.</span></span><br><span class=\"line\">    <span class=\"comment\">// 1. Opaque gray - use COLOR_TYPE_GRAY at 1 byte/pixel</span></span><br><span class=\"line\">    <span class=\"comment\">// 2. Gray + alpha - use COLOR_TYPE_PALETTE if the number of distinct combinations</span></span><br><span class=\"line\">    <span class=\"comment\">//     is sufficiently small, otherwise use COLOR_TYPE_GRAY_ALPHA</span></span><br><span class=\"line\">    <span class=\"comment\">// 3. RGB(A) - use COLOR_TYPE_PALETTE if the number of distinct colors is sufficiently</span></span><br><span class=\"line\">    <span class=\"comment\">//     small, otherwise use COLOR_TYPE_RGB&#123;_ALPHA&#125;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isOpaque) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// ==&gt;&gt; Code 4</span></span><br><span class=\"line\">            *colorType = PNG_COLOR_TYPE_GRAY; <span class=\"comment\">// 1 byte/pixel</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Use a simple heuristic to determine whether using a palette will</span></span><br><span class=\"line\">            <span class=\"comment\">// save space versus using gray + alpha for each pixel.</span></span><br><span class=\"line\">            <span class=\"comment\">// This doesn&#x27;t take into account chunk overhead, filtering, LZ</span></span><br><span class=\"line\">            <span class=\"comment\">// compression, etc.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; <span class=\"number\">2</span> * w * h)) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// ==&gt;&gt; Code 5</span></span><br><span class=\"line\">                *colorType = PNG_COLOR_TYPE_PALETTE; <span class=\"comment\">// 1 byte/pixel + 4 bytes/color</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// ==&gt;&gt; Code 6</span></span><br><span class=\"line\">                *colorType = PNG_COLOR_TYPE_GRAY_ALPHA; <span class=\"comment\">// 2 bytes per pixel</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; bpp * w * h)) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ==&gt;&gt; Code 7</span></span><br><span class=\"line\">        *colorType = PNG_COLOR_TYPE_PALETTE;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (maxGrayDeviation &lt;= grayscaleTolerance) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// ==&gt;&gt; Code 8</span></span><br><span class=\"line\">            *colorType = isOpaque ? PNG_COLOR_TYPE_GRAY : PNG_COLOR_TYPE_GRAY_ALPHA;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// ==&gt;&gt; Code 9</span></span><br><span class=\"line\">            *colorType = isOpaque ? PNG_COLOR_TYPE_RGB : PNG_COLOR_TYPE_RGB_ALPHA;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先定义了 3 个变量分别表示：isOpaque（是否不透明），isPalette（是否支持调色板），isGrayscale（是否可转化为灰度）。</p>\n<p>首先看 Code 1 处的代码：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (rr != gg || rr != bb) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ==&gt;&gt; Code 1</span></span><br><span class=\"line\">    isGrayscale = <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>只有 RGB 三种通道的颜色都一样，才能转化成灰度。</p>\n<p>Code 2 处的代码是判断透明通道是否为 0，也就是是不是不透明：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (aa != <span class=\"number\">0xff</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ==&gt;&gt; Code 2</span></span><br><span class=\"line\">    isOpaque = <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>而 Code 3 处则是判断是否可以用 256 色的调色板：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!match) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (num_colors == <span class=\"number\">256</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ==&gt;&gt; Code 3</span></span><br><span class=\"line\">        isPalette = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        colors[num_colors++] = col;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>colors</code> 是一个数组，里面存放的是图片中已经出现的（不重复）颜色，当颜色的数量大于 256 即表示不支持调色板模式。</p>\n<p>然后根据这些条件，来判断使用哪种存储模式，AAPT 中支持的存储模式有以下几种：</p>\n<ul>\n<li><p>PNG_COLOR_TYPE_PALETTE</p>\n<p>使用调色板模式，最终图片的大小就是 一个像素 1 字节 + 调色板中一个颜色 4 字节</p>\n</li>\n<li><p>PNG_COLOR_TYPE_GRAY</p>\n<p>灰度模式，这种是最节省的模式，一个像素 1 字节</p>\n</li>\n<li><p>PNG_COLOR_TYPE_GRAY_ALPHA</p>\n<p>灰度模式，同时存在透明通道，一个像素 2 字节</p>\n</li>\n<li><p>PNG_COLOR_TYPE_RGB</p>\n<p>RGB 模式，删除了透明通道，一个像素 3 字节</p>\n</li>\n<li><p>PNG_COLOR_TYPE_RGB_ALPHA</p>\n<p>ARGB 模式，一个像素 4 字节</p>\n</li>\n</ul>\n<h3 id=\"PNG-COLOR-TYPE-PALETTE\"><a href=\"#PNG-COLOR-TYPE-PALETTE\" class=\"headerlink\" title=\"PNG_COLOR_TYPE_PALETTE\"></a>PNG_COLOR_TYPE_PALETTE</h3><p>要使用这种模式，需要满足以下两个条件，分别是 Code 5 和 Code 7：</p>\n<p>Code 5</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (isOpaque) &#123;</span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; <span class=\"number\">2</span> * w * h)) &#123;</span><br><span class=\"line\">           <span class=\"comment\">// ==&gt;&gt; Code 5</span></span><br><span class=\"line\">               *colorType = PNG_COLOR_TYPE_PALETTE; <span class=\"comment\">// 1 byte/pixel + 4 bytes/color</span></span><br><span class=\"line\">           &#125; </span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在支持灰度模式的前提下，有透明通道，支持调色板模式，同时调色板的长度小于 <code>2 * w * h</code>。</p>\n<p>Code 7</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; bpp * w * h)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Code ==&gt;&gt; 7</span></span><br><span class=\"line\">        *colorType = PNG_COLOR_TYPE_PALETTE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果不支持灰度模式，但支持调色板，同时调色板长度小于 <code>bpp * w * h</code>，其中 <code>bpp</code> 的大小根据是否为不透明为决定：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> bpp = isOpaque ? <span class=\"number\">3</span> : <span class=\"number\">4</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"PNG-COLOR-TYPE-GRAY\"><a href=\"#PNG-COLOR-TYPE-GRAY\" class=\"headerlink\" title=\"PNG_COLOR_TYPE_GRAY\"></a>PNG_COLOR_TYPE_GRAY</h3><p>要使用这种模式，需要满足支持灰度模式，同时不透明。代码位于 Code 4：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (isOpaque) &#123;</span><br><span class=\"line\">         <span class=\"comment\">// ==&gt;&gt; Code 4</span></span><br><span class=\"line\">           *colorType = PNG_COLOR_TYPE_GRAY; <span class=\"comment\">// 1 byte/pixel</span></span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>###PNG_COLOR_TYPE_GRAY_ALPHA</p>\n<p>灰度，同时存在透明通道的模式。代码位于 Code 6 和 Code 8：</p>\n<p>Code 6</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (isOpaque) &#123;</span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; <span class=\"number\">2</span> * w * h)) &#123;</span><br><span class=\"line\">           &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">           <span class=\"comment\">// ==&gt;&gt; Code 6</span></span><br><span class=\"line\">           *colorType = PNG_COLOR_TYPE_GRAY_ALPHA; <span class=\"comment\">// 2 bytes per pixel</span></span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Code 8</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; bpp * w * h)) &#123;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (maxGrayDeviation &lt;= grayscaleTolerance) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// ==&gt;&gt; Code 8</span></span><br><span class=\"line\">            *colorType = isOpaque ? PNG_COLOR_TYPE_GRAY : PNG_COLOR_TYPE_GRAY_ALPHA;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><code>maxGrayDeviation</code> 是计算 RGB 通道直接的差值，如果小于 <code>grayscaleTolerance</code> 这个阙值，那么也可以转成灰度。</p>\n<h3 id=\"PNG-COLOR-TYPE-RGB\"><a href=\"#PNG-COLOR-TYPE-RGB\" class=\"headerlink\" title=\"PNG_COLOR_TYPE_RGB\"></a>PNG_COLOR_TYPE_RGB</h3><p>不透明图片可以删除透明通道，代码位于 Code 9：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isGrayscale) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (isPalette &amp;&amp; (paletteSize &lt; bpp * w * h)) &#123;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (maxGrayDeviation &lt;= grayscaleTolerance) &#123;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// ==&gt;&gt; Code 9</span></span><br><span class=\"line\">                      *colorType = isOpaque ? PNG_COLOR_TYPE_RGB : PNG_COLOR_TYPE_RGB_ALPHA;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"PNG-COLOR-TYPE-RGB-ALPHA\"><a href=\"#PNG-COLOR-TYPE-RGB-ALPHA\" class=\"headerlink\" title=\"PNG_COLOR_TYPE_RGB_ALPHA\"></a>PNG_COLOR_TYPE_RGB_ALPHA</h3><p>这个没什么好说的，最后的兜底模式。</p>\n<h3 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h3><p>AAPT 对 PNG 的优化，主要是 Indexed_color 算法，这也是一种保守的选择，因为这种是无损的，如果我们想要更高的压缩率，可以使用一些其他的压缩工具，来集成到我们的编译打包流程中。</p>\n<h2 id=\"PNG-压缩工具对比\"><a href=\"#PNG-压缩工具对比\" class=\"headerlink\" title=\"PNG 压缩工具对比\"></a>PNG 压缩工具对比</h2><p>首先，在我们选择其他 PNG 压缩工具其他，我们需要先禁用 AAPT 的默认压缩模式，因为对于 PNG 的压缩，并不是 1 + 1 &gt; 2，可以通过以下代码关闭：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">android &#123;</span><br><span class=\"line\">     aaptOptions &#123;</span><br><span class=\"line\">        cruncherEnabled = <span class=\"literal\">false</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>现在常用的 PNG 压缩工具有 <a href=\"http://pmt.sourceforge.net/pngcrush/\">pngcrush</a>、<a href=\"https://pngquant.org/\">pngquant</a>、<a href=\"https://github.com/google/zopfli\">zopfli</a> 、<a href=\"https://tinypng.com/\">tinypng</a> 等，这里我们就先不考虑 tinypng，因为这个只提供了 HTTP 接口的形式，并且有次数限制。</p>\n<h3 id=\"使用-Gradle-集成\"><a href=\"#使用-Gradle-集成\" class=\"headerlink\" title=\"使用 Gradle 集成\"></a>使用 Gradle 集成</h3><p>为了将 PNG 压缩工具集成到 APK 的构建编译流程，我们使用 Gradle 来实现。作者当前使用 Android Gradle 插件版本为 3.5.0，在这个版本我们可以通过 <code>ApplicationVariant.allRawAndroidResources</code> 获取所有的资源目录。</p>\n<p>需要注意的是，我们这个 Task 需要在 MergeResources 这个 Task 之前执行，这样我们可以将压缩后的同名覆盖，再合并到 APK 文件中。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">afterEvaluate &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        applicationVariants.all &#123; ApplicationVariant variant -&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (variant.buildType.name != <span class=\"string\">&quot;release&quot;</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">def</span> compressPngTask = task(<span class=\"string\">&#x27;compressPng&#x27;</span>)</span><br><span class=\"line\">            compressPngTask.doLast &#123;</span><br><span class=\"line\">                List&lt;File&gt; allResource = []</span><br><span class=\"line\"></span><br><span class=\"line\">                variant.allRawAndroidResources.files.forEach &#123; dir -&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!dir.exists()) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (dir.isFile()) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (dir.name.endsWith(<span class=\"string\">&quot;.png&quot;</span>)) &#123;</span><br><span class=\"line\">                            allResource.add(file)</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        dir.traverse &#123; file -&gt;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (file.name.endsWith(<span class=\"string\">&quot;.png&quot;</span>)) &#123;</span><br><span class=\"line\">                                allResource.add(file)</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">                allResource.forEach &#123; file -&gt;</span><br><span class=\"line\">                    <span class=\"comment\">// kb</span></span><br><span class=\"line\">                    <span class=\"keyword\">def</span> oldSize = file.size() / <span class=\"number\">1024</span>f</span><br><span class=\"line\"></span><br><span class=\"line\">                    println <span class=\"string\">&quot;path = $&#123;file.path&#125;&quot;</span></span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                       <span class=\"comment\">// TODO 这里就是我们执行压缩的逻辑</span></span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (Throwable ignore) &#123;</span><br><span class=\"line\">                        println <span class=\"string\">&quot;file: $&#123;file.name&#125; error: $&#123;ignore.message&#125;&quot;</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">                    println <span class=\"string\">&quot;$&#123;file.name&#125;: $oldSize KB ==&gt; $&#123;file.size() / 1024f&#125; KB&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            Task mergeResourcesTask = variant.mergeResourcesProvider.get()</span><br><span class=\"line\">            mergeResourcesTask.dependsOn(compressPngTask)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先我们创建一个名为 compressPng 的 Task，这个 Task 的任务就是收集所有 PNG 文件路径，这里我们过滤掉 BuildType 不是 release 的 Variant，最后让 MergeResources Task 依赖于 compressPng Task。</p>\n<p><strong>记得先关掉 AAPT 默认的 PNG 压缩。</strong></p>\n<p>这里我们先记录下关闭 AAPT 默认 PNG 压缩后的 APK 文件大小，和使用默认 PNG 压缩后的 APK 文件大小：</p>\n<blockquote>\n<p>这里我找的是一个直播的项目，里面有比较多的图片资源文件，过滤了 JPEG 和 .9 图，大概有 1000多张 PNG 图片，只使用一个压缩线程。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>压缩工具</th>\n<th>APK 大小（MB）</th>\n<th>耗时</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>无</td>\n<td>81.9</td>\n<td>29s</td>\n</tr>\n<tr>\n<td>AAPT</td>\n<td>78.9</td>\n<td>1m 18s</td>\n</tr>\n</tbody></table>\n<h3 id=\"pngquant\"><a href=\"#pngquant\" class=\"headerlink\" title=\"pngquant\"></a>pngquant</h3><p>首先测试 pngquant，我们将pngquant 集成进去：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exec &#123; ExecSpec spec -&gt;</span><br><span class=\"line\">    spec.workingDir(project.file(<span class=\"string\">&#x27;.&#x27;</span>))</span><br><span class=\"line\">    spec.commandLine(<span class=\"string\">&quot;./pngquant&quot;</span>, <span class=\"string\">&quot;--skip-if-larger&quot;</span>, <span class=\"string\">&quot;--speed&quot;</span>, <span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;--strip&quot;</span>, <span class=\"string\">&quot;--nofs&quot;</span>, <span class=\"string\">&quot;--force&quot;</span>, <span class=\"string\">&quot;--output&quot;</span>, file.path, <span class=\"string\">&quot;--&quot;</span>, file.path)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里我们用的基本都是默认配置：</p>\n<ul>\n<li>–skip-if-larger 表示如果压缩后的图片更大了，就跳过</li>\n<li>–speed 1 表示使用最慢的压缩速度，来换取更好的压缩质量</li>\n<li>–strip 删除图片的一些元数据</li>\n<li>–nofs 禁用 <a href=\"%5Bhttps://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering%5D(https://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering)\">Floyd–Steinberg dithering</a> 图像抖动处理</li>\n<li>–force 覆盖源文件</li>\n<li>–output 输出文件的路径</li>\n</ul>\n<p>先执行 Clean Task，再重新执行打包，最终结果如下：</p>\n<table>\n<thead>\n<tr>\n<th>压缩工具</th>\n<th>APK 大小（MB）</th>\n<th>耗时</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>无</td>\n<td>81.9</td>\n<td>29s</td>\n</tr>\n<tr>\n<td>AAPT</td>\n<td>78.9</td>\n<td>32s</td>\n</tr>\n<tr>\n<td>pngquant</td>\n<td>73.7</td>\n<td>1m 18s</td>\n</tr>\n</tbody></table>\n<h3 id=\"zopflipng\"><a href=\"#zopflipng\" class=\"headerlink\" title=\"zopflipng\"></a>zopflipng</h3><p>集成进去：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exec &#123; ExecSpec spec -&gt;</span><br><span class=\"line\">    spec.workingDir(<span class=\"keyword\">new</span> File(<span class=\"string\">&#x27;/Users/leo/Documents/projects/zopfli&#x27;</span>))</span><br><span class=\"line\">    spec.commandLine(<span class=\"string\">&quot;./zopflipng&quot;</span>, <span class=\"string\">&quot;-y&quot;</span>, <span class=\"string\">&quot;-m&quot;</span>, file.path, file.path)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>使用的也是基本配置：</p>\n<ul>\n<li>-y 覆盖原文件，不需要询问</li>\n<li>-m 尽可能多压缩，依赖于文件的大小</li>\n</ul>\n<p>先执行 Clean Task，再重新执行打包，最终结果如下：</p>\n<table>\n<thead>\n<tr>\n<th>压缩工具</th>\n<th>APK 大小（MB）</th>\n<th>耗时</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>无</td>\n<td>81.9</td>\n<td>29s</td>\n</tr>\n<tr>\n<td>AAPT</td>\n<td>78.9</td>\n<td>32s</td>\n</tr>\n<tr>\n<td>pngquant</td>\n<td>73.7</td>\n<td>1m 18s</td>\n</tr>\n<tr>\n<td>zopflipng</td>\n<td>78</td>\n<td>36m 17s</td>\n</tr>\n</tbody></table>\n<h3 id=\"pngcursh\"><a href=\"#pngcursh\" class=\"headerlink\" title=\"pngcursh\"></a>pngcursh</h3><p>集成进去：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exec &#123; ExecSpec spec -&gt;</span><br><span class=\"line\">    spec.workingDir(<span class=\"keyword\">new</span> File(<span class=\"string\">&#x27;/Users/leo/Documents/projects/pngcrush-1.8.13&#x27;</span>))</span><br><span class=\"line\">    spec.commandLine(<span class=\"string\">&quot;./pngcrush&quot;</span>, <span class=\"string\">&quot;-ow&quot;</span>,<span class=\"string\">&quot;-reduce&quot;</span>, file.path)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>使用基本配置：</p>\n<ul>\n<li>-ow 表示覆盖原文件</li>\n<li>-reduce 减少无损颜色值的类型和位深度</li>\n<li>-brute 尝试 176 种压缩方法</li>\n</ul>\n<p>先执行 Clean Task，再重新执行打包，最终结果如下：</p>\n<table>\n<thead>\n<tr>\n<th>压缩工具</th>\n<th>APK 大小（MB）</th>\n<th>耗时</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>无</td>\n<td>81.9</td>\n<td>29s</td>\n</tr>\n<tr>\n<td>AAPT</td>\n<td>78.9</td>\n<td>32s</td>\n</tr>\n<tr>\n<td>pngquant</td>\n<td>73.7</td>\n<td>1m 18s</td>\n</tr>\n<tr>\n<td>zopflipng</td>\n<td>78</td>\n<td>36m 17s</td>\n</tr>\n<tr>\n<td>pngcursh</td>\n<td>78.7</td>\n<td>13m 56s</td>\n</tr>\n</tbody></table>\n<h3 id=\"小结-1\"><a href=\"#小结-1\" class=\"headerlink\" title=\"小结\"></a>小结</h3><p>虽然从结果上来看，pngquant 是最好的选择，但因为 pngcursh 这块使用的只是默认的压缩配置，而且 pngcursh 提供的参数是最多的，所以具体哪个更优，只能靠调参数了，众所周知，调参数也是技术活。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>推荐使用 WebP 和 SVG 来代替 PNG 和 JPEG 图片的使用，但有些三方库的图片是我们没办法控制的，这块就可以用 PNG 压缩工具来进行优化。至于如果平衡压缩率、压缩耗时，这就是要靠大家去调参数了。</p>\n"},{"title":"可拖拽的网格布局","date":"2018-07-19T03:42:26.000Z","_content":"### 效果\n\n![效果图](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/DragGridLayout.gif?x-oss-process=style/doc-img)\n\n### 背景\n\n在之前的项目中为了实现类似微信朋友圈的图片九宫格效果，手写了一个简单的网格控件，继承于 ViewGroup，后面因为准备做小组的技术分享，关于自定义控件的，所以就想把这个控件优化下，来作为这次分享的例子。自定义控件一般涉及测量、布局、绘制三大流程，再加上触摸事件的处理。之前的已完成的部分，已经包括了测量和布局，绘制暂时没有好想法，所以这次就想再加上触摸事件的处理。在使用微信发布朋友圈的时候，看到可以通过拖拽来重新排序图片，所以这次就加上可拖拽的功能。\n\n### 思路\n\n因为网格控件是位置是比较固定的，所以可以通过实时计算每个 Item 的位置，这里我们为了方便，所以缓存了每个 Item 的位置。当我们拖拽某个 Item 靠近新的位置时，如果新位置大于原来的位置，我们将原来位置到新位置的 Item 向后移动一位，反之，则向前移动一位。不知道这样解释是否清晰。\n\n### 实现\n\n**[源码](https://github.com/LinXiaoTao/DragGridLayout)**\n\n首先我们要保存初始布局时的位置信息，这里我们使用 `SparseArray<Point>` 去缓存，相关代码如下：\n\n``` java\nint childTop = getPaddingTop();                                                                \nint childLeft = getPaddingLeft();                                                              \n                                                                                               \nfor (int i = 0; i < getChildCount(); i++) {                                                    \n    final View childView = getChildAt(i);                                                      \n    Point point = mLayoutPositionArray.get(i);                                                 \n                                                                                               \n    if(point == null){                                                                         \n        point = acquireTempPoint();                                                            \n    }                                                                                          \n                                                                                               \n    point.x = childLeft;                                                                       \n    point.y = childTop;                                                                        \n    mLayoutPositionArray.put(i, point);                                                        \n                                                                                               \n    childView.layout(childLeft, childTop, childLeft + itemWidth, childTop + itemHeight);       \n                                                                                               \n    if (mGridAdapter != null) {                                                                \n        mGridAdapter.handleItemView(childView, i);                                             \n    }                                                                                          \n    childLeft += itemWidth + mHGap;                                                            \n    if ((i + 1) % mColumnCount == 0) {                                                         \n        childTop += itemHeight + mVGap;                                                        \n        childLeft = getPaddingLeft();                                                          \n    }                                                                                          \n}                                                                                                                               \n```\n\n接下来是 Item 的拖拽移动处理，同样的我们可以通过手动处理 `onTouchEvent()` 和 `onInterceptTouchEvent()` 去实现，为了节约时间，我们使用 `ViewDragHelper` 去实现，关于 `ViewDragHelper` 的使用，这里我们就不去细讲，可以参考这篇[博客](https://blog.csdn.net/lmj623565791/article/details/46858663)，关于触发拖动操作，这里我们使用长按开始拖动，同样的，长按等手势判定，我们交给  `GestureDetector` 去处理，下面是两个类的集成代码：\n\n``` java\n@Override                                                                   \npublic boolean onInterceptTouchEvent(MotionEvent ev) {                      \n    boolean intercept = mDragHelper.shouldInterceptTouchEvent(ev);          \n    if (mDragHelper.getViewDragState() == ViewDragHelper.STATE_DRAGGING) {  \n        if (getParent() != null) {\n            // 这里需要禁止父视图拦截事件，防止父视图为滚动控件，发生滑动冲突\n            getParent().requestDisallowInterceptTouchEvent(true);           \n        }                                                                   \n    }                                                                       \n    return intercept;                                                       \n}                                                                           \n                                                                            \n@SuppressLint(\"ClickableViewAccessibility\")                                 \n@Override                                                                   \npublic boolean onTouchEvent(MotionEvent event) {                            \n    mDragHelper.processTouchEvent(event);                                   \n    if (mDragHelper.getViewDragState() == ViewDragHelper.STATE_DRAGGING) {  \n        if (getParent() != null) {\n            // 这里需要禁止父视图拦截事件，防止父视图为滚动控件，发生滑动冲突\n            getParent().requestDisallowInterceptTouchEvent(true);           \n        }                                                                   \n    }                                                                       \n    // 手势判断                                                                 \n    mGestureDetector.onTouchEvent(event);                                   \n    return true;                                                            \n}                                                                           \n```\n\n这时候，我们的长按开始拖拽已经实现了，接下来，当我们拖拽时，如何让目标位置的子视图移动出位置呢？在上面，我们已经提到了思路，即将部分视图进行整体移动去实现。我们通过代码来看下实现思路：\n\n``` java\n@Override                                                                                                                                          \npublic void onViewPositionChanged(@NonNull View changedView, int left, int top, int dx, int dy) {\n    // 当子视图拖拽移动时，ViewDragHelper 会回调这个方法返回新的位置\n    super.onViewPositionChanged(changedView, left, top, dx, dy);                                                                                   \n    Log.d(TAG,\"dx: \" + dx + \"，dy: \" + dy);\n    // findFirstContactView 拖拽到新的目标位置\n    int targetPosition = findFirstContactView(left, top, left + changedView.getWidth(), top + changedView.getHeight(), changedView);               \n    int sourcePosition = indexOfChild(changedView);                                                                                                \n    if (targetPosition == -1 || sourcePosition == targetPosition) {                                                                                \n        if (targetPosition == -1) {                                                                                                                \n            Log.d(TAG, \"targetPosition == -1\");                                                                                                    \n        }                                                                                                                                          \n        if (sourcePosition == targetPosition) {                                                                                                    \n            Log.w(TAG, \"sourcePosition == targetPosition\");                                                                                        \n        }                                                                                                                                          \n        return;                                                                                                                                    \n    }                                                                                                                                              \n    if (mAnimatorCountDown.get() > 0) {\n        // 上一次整体移动的动画还没结束\n        return;                                                                                                                                    \n    }                                                                                                                                              \n    Log.d(TAG, \"sourcePositon: \" + sourcePosition + \" ,targetPosition: \" + targetPosition);                                                        \n    // 移动位置                                                                                                                                        \n    if (targetPosition < sourcePosition && (dx < 0 || dy < 0)) {\n        // 当前目标位置小于拖拽视图的原位置，同时手势为向左或者向上\n        mTargetPosition = targetPosition;                                                                                                          \n        for (int i = targetPosition; i < sourcePosition; i++) {                                                                                    \n            moveAnimation(getChildAt(i), mLayoutPositionArray.get(i + 1), i + 1, null);                                                            \n        }                                                                                                                                          \n    } else if (targetPosition > sourcePosition && (dx > 0 || dy > 0)) {\n        // 当前目标位置大于拖拽视图的原位置，同时手势为向右或者向下\n        mTargetPosition = targetPosition;                                                                                                          \n        for (int i = sourcePosition + 1; i < (targetPosition + 1); i++) {                                                                          \n            moveAnimation(getChildAt(i), mLayoutPositionArray.get(i - 1), i - 1, null);                                                            \n        }                                                                                                                                          \n    }                                                                                                                                              \n}                                                                                                                                                  \n```\n\n通过上面的代码和注释，实现的思路应该很清晰了。接下来，我们再看下 `findFirstContactView` 这个方法，这是获取拖拽视图移动目标位置，代码如下：\n\n``` java\nprivate int findFirstContactView(int left, int top, int right, int bottom, View excludeView) {                          \n    final int childCount = getChildCount();                                                                             \n    for (int i = childCount - 1; i >= 0; i--) {\n        // 这里我们遍历子视图\n        final View child = getChildAt(i);                                                                               \n        if (child == excludeView) {                                                                                     \n            continue;                                                                                                   \n        }                                                                                                               \n        if (left < child.getRight() && child.getLeft() < right && top < child.getBottom() && child.getTop() < bottom) { \n            // 是否存在相交的子视图                                                                                                       \n            int calculateLeft = left;                                                                                   \n            int calculateRight = right;                                                                                 \n            int caluculateTop = top;                                                                                    \n            int caluculateBottom = bottom;                                                                              \n            if (child.getLeft() > calculateLeft){                                                                       \n                calculateLeft = child.getLeft();                                                                        \n            }                                                                                                           \n            if (child.getRight() < calculateRight){                                                                     \n                calculateRight = child.getRight();                                                                      \n            }                                                                                                           \n            if (child.getTop() > caluculateTop){                                                                        \n                caluculateTop = child.getTop();                                                                         \n            }                                                                                                           \n            if (child.getBottom() < caluculateBottom){                                                                  \n                caluculateBottom = child.getBottom();                                                                   \n            }                                                                                                           \n            int unionArea = (calculateRight - calculateLeft) * (caluculateBottom - caluculateTop);                      \n            if (unionArea > (child.getWidth() * child.getHeight() * 0.5f)){\n                // 这里我们再通过 相交面积是否大于视图面积的一半 去判定\n                // 这是为了不那么敏感\n                return i;                                                                                               \n            }                                                                                                           \n        }                                                                                                               \n    }                                                                                                                   \n    return -1;                                                                                                          \n}                                                                                                                       \n```\n\n经过上面的步骤，我们已经实现了百分之八十的代码，这时，我们还需要考虑几个问题。\n\n* 位置交换后，我们通过 `indexOfChild` 或 `getChildAt` 得到的数据还是原来的，即我们通过调用 `addView` 添加的顺序。这里我们自己去缓存一个子视图列表，重写上面两个方法：\n\n  ``` java\n  @Override                             \n  public int indexOfChild(View child) { \n      return mChildViews.indexOf(child);\n  }                                     \n                                        \n  @Override                             \n  public View getChildAt(int index) {   \n      return mChildViews.get(index);    \n  }                                     \n  ```\n\n  同时在视图移动时，去修改这个列表：\n\n  ``` java\n  mChildViews.set(targetPosition, targetView); \n  ```\n\n* 绘制顺序问题，ViewGroup 的默认绘制顺序是根据 `addView`  的调用顺序，这样会带来一个问题，当你拖拽到比当前拖拽视图更晚添加的子视图时，会显示在这个视图下面，同样我们可以通过 `setChildrenDrawingOrderEnabled` 和 \n\n  `getChildDrawingOrder` 去自定义绘制顺序，这里为了方便，我们通过设置拖拽视图的 Z 值来实现同样的效果：\n\n  ``` java\n  ViewCompat.setZ(capturedChild, 100f);     \n  postInvalidate();                         \n  ```\n\n最后我们顺便把 Item 的点击事件实现下。。。\n\n``` java\n @Override                                                                                 \n public boolean onSingleTapConfirmed(MotionEvent e) {                                      \n     final View targetView = mDragHelper.findTopChildUnder((int) e.getX(), (int) e.getY());\n     if (targetView == null) {                                                             \n         return performClick();                                                            \n     } else if (mGridItemClickListener != null) {                                          \n         mGridItemClickListener.onClickItem(indexOfChild(targetView), targetView);         \n         return true;                                                                      \n     }                                                                                     \n     return false;                                                                         \n }                                                                                         \n```\n","source":"_posts/可拖拽的网格布局.md","raw":"---\ntitle: 可拖拽的网格布局\ndate: 2018-07-19 11:42:26\ncategories: Android\n---\n### 效果\n\n![效果图](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/DragGridLayout.gif?x-oss-process=style/doc-img)\n\n### 背景\n\n在之前的项目中为了实现类似微信朋友圈的图片九宫格效果，手写了一个简单的网格控件，继承于 ViewGroup，后面因为准备做小组的技术分享，关于自定义控件的，所以就想把这个控件优化下，来作为这次分享的例子。自定义控件一般涉及测量、布局、绘制三大流程，再加上触摸事件的处理。之前的已完成的部分，已经包括了测量和布局，绘制暂时没有好想法，所以这次就想再加上触摸事件的处理。在使用微信发布朋友圈的时候，看到可以通过拖拽来重新排序图片，所以这次就加上可拖拽的功能。\n\n### 思路\n\n因为网格控件是位置是比较固定的，所以可以通过实时计算每个 Item 的位置，这里我们为了方便，所以缓存了每个 Item 的位置。当我们拖拽某个 Item 靠近新的位置时，如果新位置大于原来的位置，我们将原来位置到新位置的 Item 向后移动一位，反之，则向前移动一位。不知道这样解释是否清晰。\n\n### 实现\n\n**[源码](https://github.com/LinXiaoTao/DragGridLayout)**\n\n首先我们要保存初始布局时的位置信息，这里我们使用 `SparseArray<Point>` 去缓存，相关代码如下：\n\n``` java\nint childTop = getPaddingTop();                                                                \nint childLeft = getPaddingLeft();                                                              \n                                                                                               \nfor (int i = 0; i < getChildCount(); i++) {                                                    \n    final View childView = getChildAt(i);                                                      \n    Point point = mLayoutPositionArray.get(i);                                                 \n                                                                                               \n    if(point == null){                                                                         \n        point = acquireTempPoint();                                                            \n    }                                                                                          \n                                                                                               \n    point.x = childLeft;                                                                       \n    point.y = childTop;                                                                        \n    mLayoutPositionArray.put(i, point);                                                        \n                                                                                               \n    childView.layout(childLeft, childTop, childLeft + itemWidth, childTop + itemHeight);       \n                                                                                               \n    if (mGridAdapter != null) {                                                                \n        mGridAdapter.handleItemView(childView, i);                                             \n    }                                                                                          \n    childLeft += itemWidth + mHGap;                                                            \n    if ((i + 1) % mColumnCount == 0) {                                                         \n        childTop += itemHeight + mVGap;                                                        \n        childLeft = getPaddingLeft();                                                          \n    }                                                                                          \n}                                                                                                                               \n```\n\n接下来是 Item 的拖拽移动处理，同样的我们可以通过手动处理 `onTouchEvent()` 和 `onInterceptTouchEvent()` 去实现，为了节约时间，我们使用 `ViewDragHelper` 去实现，关于 `ViewDragHelper` 的使用，这里我们就不去细讲，可以参考这篇[博客](https://blog.csdn.net/lmj623565791/article/details/46858663)，关于触发拖动操作，这里我们使用长按开始拖动，同样的，长按等手势判定，我们交给  `GestureDetector` 去处理，下面是两个类的集成代码：\n\n``` java\n@Override                                                                   \npublic boolean onInterceptTouchEvent(MotionEvent ev) {                      \n    boolean intercept = mDragHelper.shouldInterceptTouchEvent(ev);          \n    if (mDragHelper.getViewDragState() == ViewDragHelper.STATE_DRAGGING) {  \n        if (getParent() != null) {\n            // 这里需要禁止父视图拦截事件，防止父视图为滚动控件，发生滑动冲突\n            getParent().requestDisallowInterceptTouchEvent(true);           \n        }                                                                   \n    }                                                                       \n    return intercept;                                                       \n}                                                                           \n                                                                            \n@SuppressLint(\"ClickableViewAccessibility\")                                 \n@Override                                                                   \npublic boolean onTouchEvent(MotionEvent event) {                            \n    mDragHelper.processTouchEvent(event);                                   \n    if (mDragHelper.getViewDragState() == ViewDragHelper.STATE_DRAGGING) {  \n        if (getParent() != null) {\n            // 这里需要禁止父视图拦截事件，防止父视图为滚动控件，发生滑动冲突\n            getParent().requestDisallowInterceptTouchEvent(true);           \n        }                                                                   \n    }                                                                       \n    // 手势判断                                                                 \n    mGestureDetector.onTouchEvent(event);                                   \n    return true;                                                            \n}                                                                           \n```\n\n这时候，我们的长按开始拖拽已经实现了，接下来，当我们拖拽时，如何让目标位置的子视图移动出位置呢？在上面，我们已经提到了思路，即将部分视图进行整体移动去实现。我们通过代码来看下实现思路：\n\n``` java\n@Override                                                                                                                                          \npublic void onViewPositionChanged(@NonNull View changedView, int left, int top, int dx, int dy) {\n    // 当子视图拖拽移动时，ViewDragHelper 会回调这个方法返回新的位置\n    super.onViewPositionChanged(changedView, left, top, dx, dy);                                                                                   \n    Log.d(TAG,\"dx: \" + dx + \"，dy: \" + dy);\n    // findFirstContactView 拖拽到新的目标位置\n    int targetPosition = findFirstContactView(left, top, left + changedView.getWidth(), top + changedView.getHeight(), changedView);               \n    int sourcePosition = indexOfChild(changedView);                                                                                                \n    if (targetPosition == -1 || sourcePosition == targetPosition) {                                                                                \n        if (targetPosition == -1) {                                                                                                                \n            Log.d(TAG, \"targetPosition == -1\");                                                                                                    \n        }                                                                                                                                          \n        if (sourcePosition == targetPosition) {                                                                                                    \n            Log.w(TAG, \"sourcePosition == targetPosition\");                                                                                        \n        }                                                                                                                                          \n        return;                                                                                                                                    \n    }                                                                                                                                              \n    if (mAnimatorCountDown.get() > 0) {\n        // 上一次整体移动的动画还没结束\n        return;                                                                                                                                    \n    }                                                                                                                                              \n    Log.d(TAG, \"sourcePositon: \" + sourcePosition + \" ,targetPosition: \" + targetPosition);                                                        \n    // 移动位置                                                                                                                                        \n    if (targetPosition < sourcePosition && (dx < 0 || dy < 0)) {\n        // 当前目标位置小于拖拽视图的原位置，同时手势为向左或者向上\n        mTargetPosition = targetPosition;                                                                                                          \n        for (int i = targetPosition; i < sourcePosition; i++) {                                                                                    \n            moveAnimation(getChildAt(i), mLayoutPositionArray.get(i + 1), i + 1, null);                                                            \n        }                                                                                                                                          \n    } else if (targetPosition > sourcePosition && (dx > 0 || dy > 0)) {\n        // 当前目标位置大于拖拽视图的原位置，同时手势为向右或者向下\n        mTargetPosition = targetPosition;                                                                                                          \n        for (int i = sourcePosition + 1; i < (targetPosition + 1); i++) {                                                                          \n            moveAnimation(getChildAt(i), mLayoutPositionArray.get(i - 1), i - 1, null);                                                            \n        }                                                                                                                                          \n    }                                                                                                                                              \n}                                                                                                                                                  \n```\n\n通过上面的代码和注释，实现的思路应该很清晰了。接下来，我们再看下 `findFirstContactView` 这个方法，这是获取拖拽视图移动目标位置，代码如下：\n\n``` java\nprivate int findFirstContactView(int left, int top, int right, int bottom, View excludeView) {                          \n    final int childCount = getChildCount();                                                                             \n    for (int i = childCount - 1; i >= 0; i--) {\n        // 这里我们遍历子视图\n        final View child = getChildAt(i);                                                                               \n        if (child == excludeView) {                                                                                     \n            continue;                                                                                                   \n        }                                                                                                               \n        if (left < child.getRight() && child.getLeft() < right && top < child.getBottom() && child.getTop() < bottom) { \n            // 是否存在相交的子视图                                                                                                       \n            int calculateLeft = left;                                                                                   \n            int calculateRight = right;                                                                                 \n            int caluculateTop = top;                                                                                    \n            int caluculateBottom = bottom;                                                                              \n            if (child.getLeft() > calculateLeft){                                                                       \n                calculateLeft = child.getLeft();                                                                        \n            }                                                                                                           \n            if (child.getRight() < calculateRight){                                                                     \n                calculateRight = child.getRight();                                                                      \n            }                                                                                                           \n            if (child.getTop() > caluculateTop){                                                                        \n                caluculateTop = child.getTop();                                                                         \n            }                                                                                                           \n            if (child.getBottom() < caluculateBottom){                                                                  \n                caluculateBottom = child.getBottom();                                                                   \n            }                                                                                                           \n            int unionArea = (calculateRight - calculateLeft) * (caluculateBottom - caluculateTop);                      \n            if (unionArea > (child.getWidth() * child.getHeight() * 0.5f)){\n                // 这里我们再通过 相交面积是否大于视图面积的一半 去判定\n                // 这是为了不那么敏感\n                return i;                                                                                               \n            }                                                                                                           \n        }                                                                                                               \n    }                                                                                                                   \n    return -1;                                                                                                          \n}                                                                                                                       \n```\n\n经过上面的步骤，我们已经实现了百分之八十的代码，这时，我们还需要考虑几个问题。\n\n* 位置交换后，我们通过 `indexOfChild` 或 `getChildAt` 得到的数据还是原来的，即我们通过调用 `addView` 添加的顺序。这里我们自己去缓存一个子视图列表，重写上面两个方法：\n\n  ``` java\n  @Override                             \n  public int indexOfChild(View child) { \n      return mChildViews.indexOf(child);\n  }                                     \n                                        \n  @Override                             \n  public View getChildAt(int index) {   \n      return mChildViews.get(index);    \n  }                                     \n  ```\n\n  同时在视图移动时，去修改这个列表：\n\n  ``` java\n  mChildViews.set(targetPosition, targetView); \n  ```\n\n* 绘制顺序问题，ViewGroup 的默认绘制顺序是根据 `addView`  的调用顺序，这样会带来一个问题，当你拖拽到比当前拖拽视图更晚添加的子视图时，会显示在这个视图下面，同样我们可以通过 `setChildrenDrawingOrderEnabled` 和 \n\n  `getChildDrawingOrder` 去自定义绘制顺序，这里为了方便，我们通过设置拖拽视图的 Z 值来实现同样的效果：\n\n  ``` java\n  ViewCompat.setZ(capturedChild, 100f);     \n  postInvalidate();                         \n  ```\n\n最后我们顺便把 Item 的点击事件实现下。。。\n\n``` java\n @Override                                                                                 \n public boolean onSingleTapConfirmed(MotionEvent e) {                                      \n     final View targetView = mDragHelper.findTopChildUnder((int) e.getX(), (int) e.getY());\n     if (targetView == null) {                                                             \n         return performClick();                                                            \n     } else if (mGridItemClickListener != null) {                                          \n         mGridItemClickListener.onClickItem(indexOfChild(targetView), targetView);         \n         return true;                                                                      \n     }                                                                                     \n     return false;                                                                         \n }                                                                                         \n```\n","slug":"可拖拽的网格布局","published":1,"updated":"2022-06-15T11:19:32.324Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlw000ufho695gob49y","content":"<h3 id=\"效果\"><a href=\"#效果\" class=\"headerlink\" title=\"效果\"></a>效果</h3><p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/DragGridLayout.gif?x-oss-process=style/doc-img\" alt=\"效果图\"></p>\n<h3 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h3><p>在之前的项目中为了实现类似微信朋友圈的图片九宫格效果，手写了一个简单的网格控件，继承于 ViewGroup，后面因为准备做小组的技术分享，关于自定义控件的，所以就想把这个控件优化下，来作为这次分享的例子。自定义控件一般涉及测量、布局、绘制三大流程，再加上触摸事件的处理。之前的已完成的部分，已经包括了测量和布局，绘制暂时没有好想法，所以这次就想再加上触摸事件的处理。在使用微信发布朋友圈的时候，看到可以通过拖拽来重新排序图片，所以这次就加上可拖拽的功能。</p>\n<h3 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h3><p>因为网格控件是位置是比较固定的，所以可以通过实时计算每个 Item 的位置，这里我们为了方便，所以缓存了每个 Item 的位置。当我们拖拽某个 Item 靠近新的位置时，如果新位置大于原来的位置，我们将原来位置到新位置的 Item 向后移动一位，反之，则向前移动一位。不知道这样解释是否清晰。</p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p><strong><a href=\"https://github.com/LinXiaoTao/DragGridLayout\">源码</a></strong></p>\n<p>首先我们要保存初始布局时的位置信息，这里我们使用 <code>SparseArray&lt;Point&gt;</code> 去缓存，相关代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">childTop</span> <span class=\"operator\">=</span> getPaddingTop();                                                                </span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">childLeft</span> <span class=\"operator\">=</span> getPaddingLeft();                                                              </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; getChildCount(); i++) &#123;                                                    </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">View</span> <span class=\"variable\">childView</span> <span class=\"operator\">=</span> getChildAt(i);                                                      </span><br><span class=\"line\">    <span class=\"type\">Point</span> <span class=\"variable\">point</span> <span class=\"operator\">=</span> mLayoutPositionArray.get(i);                                                 </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(point == <span class=\"literal\">null</span>)&#123;                                                                         </span><br><span class=\"line\">        point = acquireTempPoint();                                                            </span><br><span class=\"line\">    &#125;                                                                                          </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    point.x = childLeft;                                                                       </span><br><span class=\"line\">    point.y = childTop;                                                                        </span><br><span class=\"line\">    mLayoutPositionArray.put(i, point);                                                        </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    childView.layout(childLeft, childTop, childLeft + itemWidth, childTop + itemHeight);       </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mGridAdapter != <span class=\"literal\">null</span>) &#123;                                                                </span><br><span class=\"line\">        mGridAdapter.handleItemView(childView, i);                                             </span><br><span class=\"line\">    &#125;                                                                                          </span><br><span class=\"line\">    childLeft += itemWidth + mHGap;                                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((i + <span class=\"number\">1</span>) % mColumnCount == <span class=\"number\">0</span>) &#123;                                                         </span><br><span class=\"line\">        childTop += itemHeight + mVGap;                                                        </span><br><span class=\"line\">        childLeft = getPaddingLeft();                                                          </span><br><span class=\"line\">    &#125;                                                                                          </span><br><span class=\"line\">&#125;                                                                                                                               </span><br></pre></td></tr></table></figure>\n\n<p>接下来是 Item 的拖拽移动处理，同样的我们可以通过手动处理 <code>onTouchEvent()</code> 和 <code>onInterceptTouchEvent()</code> 去实现，为了节约时间，我们使用 <code>ViewDragHelper</code> 去实现，关于 <code>ViewDragHelper</code> 的使用，这里我们就不去细讲，可以参考这篇<a href=\"https://blog.csdn.net/lmj623565791/article/details/46858663\">博客</a>，关于触发拖动操作，这里我们使用长按开始拖动，同样的，长按等手势判定，我们交给  <code>GestureDetector</code> 去处理，下面是两个类的集成代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                   </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">onInterceptTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> &#123;                      </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">intercept</span> <span class=\"operator\">=</span> mDragHelper.shouldInterceptTouchEvent(ev);          </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDragHelper.getViewDragState() == ViewDragHelper.STATE_DRAGGING) &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (getParent() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 这里需要禁止父视图拦截事件，防止父视图为滚动控件，发生滑动冲突</span></span><br><span class=\"line\">            getParent().requestDisallowInterceptTouchEvent(<span class=\"literal\">true</span>);           </span><br><span class=\"line\">        &#125;                                                                   </span><br><span class=\"line\">    &#125;                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">return</span> intercept;                                                       </span><br><span class=\"line\">&#125;                                                                           </span><br><span class=\"line\">                                                                            </span><br><span class=\"line\"><span class=\"meta\">@SuppressLint(&quot;ClickableViewAccessibility&quot;)</span>                                 </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                                   </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">onTouchEvent</span><span class=\"params\">(MotionEvent event)</span> &#123;                            </span><br><span class=\"line\">    mDragHelper.processTouchEvent(event);                                   </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDragHelper.getViewDragState() == ViewDragHelper.STATE_DRAGGING) &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (getParent() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 这里需要禁止父视图拦截事件，防止父视图为滚动控件，发生滑动冲突</span></span><br><span class=\"line\">            getParent().requestDisallowInterceptTouchEvent(<span class=\"literal\">true</span>);           </span><br><span class=\"line\">        &#125;                                                                   </span><br><span class=\"line\">    &#125;                                                                       </span><br><span class=\"line\">    <span class=\"comment\">// 手势判断                                                                 </span></span><br><span class=\"line\">    mGestureDetector.onTouchEvent(event);                                   </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                                                            </span><br><span class=\"line\">&#125;                                                                           </span><br></pre></td></tr></table></figure>\n\n<p>这时候，我们的长按开始拖拽已经实现了，接下来，当我们拖拽时，如何让目标位置的子视图移动出位置呢？在上面，我们已经提到了思路，即将部分视图进行整体移动去实现。我们通过代码来看下实现思路：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                                                                          </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onViewPositionChanged</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> View changedView, <span class=\"type\">int</span> left, <span class=\"type\">int</span> top, <span class=\"type\">int</span> dx, <span class=\"type\">int</span> dy)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 当子视图拖拽移动时，ViewDragHelper 会回调这个方法返回新的位置</span></span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onViewPositionChanged(changedView, left, top, dx, dy);                                                                                   </span><br><span class=\"line\">    Log.d(TAG,<span class=\"string\">&quot;dx: &quot;</span> + dx + <span class=\"string\">&quot;，dy: &quot;</span> + dy);</span><br><span class=\"line\">    <span class=\"comment\">// findFirstContactView 拖拽到新的目标位置</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">targetPosition</span> <span class=\"operator\">=</span> findFirstContactView(left, top, left + changedView.getWidth(), top + changedView.getHeight(), changedView);               </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">sourcePosition</span> <span class=\"operator\">=</span> indexOfChild(changedView);                                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetPosition == -<span class=\"number\">1</span> || sourcePosition == targetPosition) &#123;                                                                                </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (targetPosition == -<span class=\"number\">1</span>) &#123;                                                                                                                </span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">&quot;targetPosition == -1&quot;</span>);                                                                                                    </span><br><span class=\"line\">        &#125;                                                                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sourcePosition == targetPosition) &#123;                                                                                                    </span><br><span class=\"line\">            Log.w(TAG, <span class=\"string\">&quot;sourcePosition == targetPosition&quot;</span>);                                                                                        </span><br><span class=\"line\">        &#125;                                                                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                                                                    </span><br><span class=\"line\">    &#125;                                                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mAnimatorCountDown.get() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 上一次整体移动的动画还没结束</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                                                                    </span><br><span class=\"line\">    &#125;                                                                                                                                              </span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;sourcePositon: &quot;</span> + sourcePosition + <span class=\"string\">&quot; ,targetPosition: &quot;</span> + targetPosition);                                                        </span><br><span class=\"line\">    <span class=\"comment\">// 移动位置                                                                                                                                        </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetPosition &lt; sourcePosition &amp;&amp; (dx &lt; <span class=\"number\">0</span> || dy &lt; <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前目标位置小于拖拽视图的原位置，同时手势为向左或者向上</span></span><br><span class=\"line\">        mTargetPosition = targetPosition;                                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> targetPosition; i &lt; sourcePosition; i++) &#123;                                                                                    </span><br><span class=\"line\">            moveAnimation(getChildAt(i), mLayoutPositionArray.get(i + <span class=\"number\">1</span>), i + <span class=\"number\">1</span>, <span class=\"literal\">null</span>);                                                            </span><br><span class=\"line\">        &#125;                                                                                                                                          </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (targetPosition &gt; sourcePosition &amp;&amp; (dx &gt; <span class=\"number\">0</span> || dy &gt; <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前目标位置大于拖拽视图的原位置，同时手势为向右或者向下</span></span><br><span class=\"line\">        mTargetPosition = targetPosition;                                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> sourcePosition + <span class=\"number\">1</span>; i &lt; (targetPosition + <span class=\"number\">1</span>); i++) &#123;                                                                          </span><br><span class=\"line\">            moveAnimation(getChildAt(i), mLayoutPositionArray.get(i - <span class=\"number\">1</span>), i - <span class=\"number\">1</span>, <span class=\"literal\">null</span>);                                                            </span><br><span class=\"line\">        &#125;                                                                                                                                          </span><br><span class=\"line\">    &#125;                                                                                                                                              </span><br><span class=\"line\">&#125;                                                                                                                                                  </span><br></pre></td></tr></table></figure>\n\n<p>通过上面的代码和注释，实现的思路应该很清晰了。接下来，我们再看下 <code>findFirstContactView</code> 这个方法，这是获取拖拽视图移动目标位置，代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"title function_\">findFirstContactView</span><span class=\"params\">(<span class=\"type\">int</span> left, <span class=\"type\">int</span> top, <span class=\"type\">int</span> right, <span class=\"type\">int</span> bottom, View excludeView)</span> &#123;                          </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">childCount</span> <span class=\"operator\">=</span> getChildCount();                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> childCount - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 这里我们遍历子视图</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">View</span> <span class=\"variable\">child</span> <span class=\"operator\">=</span> getChildAt(i);                                                                               </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (child == excludeView) &#123;                                                                                     </span><br><span class=\"line\">            <span class=\"keyword\">continue</span>;                                                                                                   </span><br><span class=\"line\">        &#125;                                                                                                               </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (left &lt; child.getRight() &amp;&amp; child.getLeft() &lt; right &amp;&amp; top &lt; child.getBottom() &amp;&amp; child.getTop() &lt; bottom) &#123; </span><br><span class=\"line\">            <span class=\"comment\">// 是否存在相交的子视图                                                                                                       </span></span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">calculateLeft</span> <span class=\"operator\">=</span> left;                                                                                   </span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">calculateRight</span> <span class=\"operator\">=</span> right;                                                                                 </span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">caluculateTop</span> <span class=\"operator\">=</span> top;                                                                                    </span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">caluculateBottom</span> <span class=\"operator\">=</span> bottom;                                                                              </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (child.getLeft() &gt; calculateLeft)&#123;                                                                       </span><br><span class=\"line\">                calculateLeft = child.getLeft();                                                                        </span><br><span class=\"line\">            &#125;                                                                                                           </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (child.getRight() &lt; calculateRight)&#123;                                                                     </span><br><span class=\"line\">                calculateRight = child.getRight();                                                                      </span><br><span class=\"line\">            &#125;                                                                                                           </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (child.getTop() &gt; caluculateTop)&#123;                                                                        </span><br><span class=\"line\">                caluculateTop = child.getTop();                                                                         </span><br><span class=\"line\">            &#125;                                                                                                           </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (child.getBottom() &lt; caluculateBottom)&#123;                                                                  </span><br><span class=\"line\">                caluculateBottom = child.getBottom();                                                                   </span><br><span class=\"line\">            &#125;                                                                                                           </span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">unionArea</span> <span class=\"operator\">=</span> (calculateRight - calculateLeft) * (caluculateBottom - caluculateTop);                      </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (unionArea &gt; (child.getWidth() * child.getHeight() * <span class=\"number\">0.5f</span>))&#123;</span><br><span class=\"line\">                <span class=\"comment\">// 这里我们再通过 相交面积是否大于视图面积的一半 去判定</span></span><br><span class=\"line\">                <span class=\"comment\">// 这是为了不那么敏感</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> i;                                                                                               </span><br><span class=\"line\">            &#125;                                                                                                           </span><br><span class=\"line\">        &#125;                                                                                                               </span><br><span class=\"line\">    &#125;                                                                                                                   </span><br><span class=\"line\">    <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;                                                                                                          </span><br><span class=\"line\">&#125;                                                                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>经过上面的步骤，我们已经实现了百分之八十的代码，这时，我们还需要考虑几个问题。</p>\n<ul>\n<li><p>位置交换后，我们通过 <code>indexOfChild</code> 或 <code>getChildAt</code> 得到的数据还是原来的，即我们通过调用 <code>addView</code> 添加的顺序。这里我们自己去缓存一个子视图列表，重写上面两个方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                             </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">indexOfChild</span><span class=\"params\">(View child)</span> &#123; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mChildViews.indexOf(child);</span><br><span class=\"line\">&#125;                                     </span><br><span class=\"line\">                                      </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                             </span><br><span class=\"line\"><span class=\"keyword\">public</span> View <span class=\"title function_\">getChildAt</span><span class=\"params\">(<span class=\"type\">int</span> index)</span> &#123;   </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mChildViews.get(index);    </span><br><span class=\"line\">&#125;                                     </span><br></pre></td></tr></table></figure>\n\n<p>同时在视图移动时，去修改这个列表：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mChildViews.set(targetPosition, targetView); </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>绘制顺序问题，ViewGroup 的默认绘制顺序是根据 <code>addView</code>  的调用顺序，这样会带来一个问题，当你拖拽到比当前拖拽视图更晚添加的子视图时，会显示在这个视图下面，同样我们可以通过 <code>setChildrenDrawingOrderEnabled</code> 和 </p>\n<p><code>getChildDrawingOrder</code> 去自定义绘制顺序，这里为了方便，我们通过设置拖拽视图的 Z 值来实现同样的效果：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ViewCompat.setZ(capturedChild, <span class=\"number\">100f</span>);     </span><br><span class=\"line\">postInvalidate();                         </span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>最后我们顺便把 Item 的点击事件实现下。。。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                 </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">onSingleTapConfirmed</span><span class=\"params\">(MotionEvent e)</span> &#123;                                      </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">View</span> <span class=\"variable\">targetView</span> <span class=\"operator\">=</span> mDragHelper.findTopChildUnder((<span class=\"type\">int</span>) e.getX(), (<span class=\"type\">int</span>) e.getY());</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetView == <span class=\"literal\">null</span>) &#123;                                                             </span><br><span class=\"line\">        <span class=\"keyword\">return</span> performClick();                                                            </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mGridItemClickListener != <span class=\"literal\">null</span>) &#123;                                          </span><br><span class=\"line\">        mGridItemClickListener.onClickItem(indexOfChild(targetView), targetView);         </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                                                                      </span><br><span class=\"line\">    &#125;                                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;                                                                         </span><br><span class=\"line\">&#125;                                                                                         </span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"效果\"><a href=\"#效果\" class=\"headerlink\" title=\"效果\"></a>效果</h3><p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/DragGridLayout.gif?x-oss-process=style/doc-img\" alt=\"效果图\"></p>\n<h3 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h3><p>在之前的项目中为了实现类似微信朋友圈的图片九宫格效果，手写了一个简单的网格控件，继承于 ViewGroup，后面因为准备做小组的技术分享，关于自定义控件的，所以就想把这个控件优化下，来作为这次分享的例子。自定义控件一般涉及测量、布局、绘制三大流程，再加上触摸事件的处理。之前的已完成的部分，已经包括了测量和布局，绘制暂时没有好想法，所以这次就想再加上触摸事件的处理。在使用微信发布朋友圈的时候，看到可以通过拖拽来重新排序图片，所以这次就加上可拖拽的功能。</p>\n<h3 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h3><p>因为网格控件是位置是比较固定的，所以可以通过实时计算每个 Item 的位置，这里我们为了方便，所以缓存了每个 Item 的位置。当我们拖拽某个 Item 靠近新的位置时，如果新位置大于原来的位置，我们将原来位置到新位置的 Item 向后移动一位，反之，则向前移动一位。不知道这样解释是否清晰。</p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p><strong><a href=\"https://github.com/LinXiaoTao/DragGridLayout\">源码</a></strong></p>\n<p>首先我们要保存初始布局时的位置信息，这里我们使用 <code>SparseArray&lt;Point&gt;</code> 去缓存，相关代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">childTop</span> <span class=\"operator\">=</span> getPaddingTop();                                                                </span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">childLeft</span> <span class=\"operator\">=</span> getPaddingLeft();                                                              </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; getChildCount(); i++) &#123;                                                    </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">View</span> <span class=\"variable\">childView</span> <span class=\"operator\">=</span> getChildAt(i);                                                      </span><br><span class=\"line\">    <span class=\"type\">Point</span> <span class=\"variable\">point</span> <span class=\"operator\">=</span> mLayoutPositionArray.get(i);                                                 </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(point == <span class=\"literal\">null</span>)&#123;                                                                         </span><br><span class=\"line\">        point = acquireTempPoint();                                                            </span><br><span class=\"line\">    &#125;                                                                                          </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    point.x = childLeft;                                                                       </span><br><span class=\"line\">    point.y = childTop;                                                                        </span><br><span class=\"line\">    mLayoutPositionArray.put(i, point);                                                        </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    childView.layout(childLeft, childTop, childLeft + itemWidth, childTop + itemHeight);       </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mGridAdapter != <span class=\"literal\">null</span>) &#123;                                                                </span><br><span class=\"line\">        mGridAdapter.handleItemView(childView, i);                                             </span><br><span class=\"line\">    &#125;                                                                                          </span><br><span class=\"line\">    childLeft += itemWidth + mHGap;                                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((i + <span class=\"number\">1</span>) % mColumnCount == <span class=\"number\">0</span>) &#123;                                                         </span><br><span class=\"line\">        childTop += itemHeight + mVGap;                                                        </span><br><span class=\"line\">        childLeft = getPaddingLeft();                                                          </span><br><span class=\"line\">    &#125;                                                                                          </span><br><span class=\"line\">&#125;                                                                                                                               </span><br></pre></td></tr></table></figure>\n\n<p>接下来是 Item 的拖拽移动处理，同样的我们可以通过手动处理 <code>onTouchEvent()</code> 和 <code>onInterceptTouchEvent()</code> 去实现，为了节约时间，我们使用 <code>ViewDragHelper</code> 去实现，关于 <code>ViewDragHelper</code> 的使用，这里我们就不去细讲，可以参考这篇<a href=\"https://blog.csdn.net/lmj623565791/article/details/46858663\">博客</a>，关于触发拖动操作，这里我们使用长按开始拖动，同样的，长按等手势判定，我们交给  <code>GestureDetector</code> 去处理，下面是两个类的集成代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                   </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">onInterceptTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> &#123;                      </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">intercept</span> <span class=\"operator\">=</span> mDragHelper.shouldInterceptTouchEvent(ev);          </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDragHelper.getViewDragState() == ViewDragHelper.STATE_DRAGGING) &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (getParent() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 这里需要禁止父视图拦截事件，防止父视图为滚动控件，发生滑动冲突</span></span><br><span class=\"line\">            getParent().requestDisallowInterceptTouchEvent(<span class=\"literal\">true</span>);           </span><br><span class=\"line\">        &#125;                                                                   </span><br><span class=\"line\">    &#125;                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">return</span> intercept;                                                       </span><br><span class=\"line\">&#125;                                                                           </span><br><span class=\"line\">                                                                            </span><br><span class=\"line\"><span class=\"meta\">@SuppressLint(&quot;ClickableViewAccessibility&quot;)</span>                                 </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                                   </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">onTouchEvent</span><span class=\"params\">(MotionEvent event)</span> &#123;                            </span><br><span class=\"line\">    mDragHelper.processTouchEvent(event);                                   </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDragHelper.getViewDragState() == ViewDragHelper.STATE_DRAGGING) &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (getParent() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 这里需要禁止父视图拦截事件，防止父视图为滚动控件，发生滑动冲突</span></span><br><span class=\"line\">            getParent().requestDisallowInterceptTouchEvent(<span class=\"literal\">true</span>);           </span><br><span class=\"line\">        &#125;                                                                   </span><br><span class=\"line\">    &#125;                                                                       </span><br><span class=\"line\">    <span class=\"comment\">// 手势判断                                                                 </span></span><br><span class=\"line\">    mGestureDetector.onTouchEvent(event);                                   </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                                                            </span><br><span class=\"line\">&#125;                                                                           </span><br></pre></td></tr></table></figure>\n\n<p>这时候，我们的长按开始拖拽已经实现了，接下来，当我们拖拽时，如何让目标位置的子视图移动出位置呢？在上面，我们已经提到了思路，即将部分视图进行整体移动去实现。我们通过代码来看下实现思路：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                                                                          </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onViewPositionChanged</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> View changedView, <span class=\"type\">int</span> left, <span class=\"type\">int</span> top, <span class=\"type\">int</span> dx, <span class=\"type\">int</span> dy)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 当子视图拖拽移动时，ViewDragHelper 会回调这个方法返回新的位置</span></span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onViewPositionChanged(changedView, left, top, dx, dy);                                                                                   </span><br><span class=\"line\">    Log.d(TAG,<span class=\"string\">&quot;dx: &quot;</span> + dx + <span class=\"string\">&quot;，dy: &quot;</span> + dy);</span><br><span class=\"line\">    <span class=\"comment\">// findFirstContactView 拖拽到新的目标位置</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">targetPosition</span> <span class=\"operator\">=</span> findFirstContactView(left, top, left + changedView.getWidth(), top + changedView.getHeight(), changedView);               </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">sourcePosition</span> <span class=\"operator\">=</span> indexOfChild(changedView);                                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetPosition == -<span class=\"number\">1</span> || sourcePosition == targetPosition) &#123;                                                                                </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (targetPosition == -<span class=\"number\">1</span>) &#123;                                                                                                                </span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">&quot;targetPosition == -1&quot;</span>);                                                                                                    </span><br><span class=\"line\">        &#125;                                                                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sourcePosition == targetPosition) &#123;                                                                                                    </span><br><span class=\"line\">            Log.w(TAG, <span class=\"string\">&quot;sourcePosition == targetPosition&quot;</span>);                                                                                        </span><br><span class=\"line\">        &#125;                                                                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                                                                    </span><br><span class=\"line\">    &#125;                                                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mAnimatorCountDown.get() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 上一次整体移动的动画还没结束</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                                                                                    </span><br><span class=\"line\">    &#125;                                                                                                                                              </span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;sourcePositon: &quot;</span> + sourcePosition + <span class=\"string\">&quot; ,targetPosition: &quot;</span> + targetPosition);                                                        </span><br><span class=\"line\">    <span class=\"comment\">// 移动位置                                                                                                                                        </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetPosition &lt; sourcePosition &amp;&amp; (dx &lt; <span class=\"number\">0</span> || dy &lt; <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前目标位置小于拖拽视图的原位置，同时手势为向左或者向上</span></span><br><span class=\"line\">        mTargetPosition = targetPosition;                                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> targetPosition; i &lt; sourcePosition; i++) &#123;                                                                                    </span><br><span class=\"line\">            moveAnimation(getChildAt(i), mLayoutPositionArray.get(i + <span class=\"number\">1</span>), i + <span class=\"number\">1</span>, <span class=\"literal\">null</span>);                                                            </span><br><span class=\"line\">        &#125;                                                                                                                                          </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (targetPosition &gt; sourcePosition &amp;&amp; (dx &gt; <span class=\"number\">0</span> || dy &gt; <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前目标位置大于拖拽视图的原位置，同时手势为向右或者向下</span></span><br><span class=\"line\">        mTargetPosition = targetPosition;                                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> sourcePosition + <span class=\"number\">1</span>; i &lt; (targetPosition + <span class=\"number\">1</span>); i++) &#123;                                                                          </span><br><span class=\"line\">            moveAnimation(getChildAt(i), mLayoutPositionArray.get(i - <span class=\"number\">1</span>), i - <span class=\"number\">1</span>, <span class=\"literal\">null</span>);                                                            </span><br><span class=\"line\">        &#125;                                                                                                                                          </span><br><span class=\"line\">    &#125;                                                                                                                                              </span><br><span class=\"line\">&#125;                                                                                                                                                  </span><br></pre></td></tr></table></figure>\n\n<p>通过上面的代码和注释，实现的思路应该很清晰了。接下来，我们再看下 <code>findFirstContactView</code> 这个方法，这是获取拖拽视图移动目标位置，代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"title function_\">findFirstContactView</span><span class=\"params\">(<span class=\"type\">int</span> left, <span class=\"type\">int</span> top, <span class=\"type\">int</span> right, <span class=\"type\">int</span> bottom, View excludeView)</span> &#123;                          </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">childCount</span> <span class=\"operator\">=</span> getChildCount();                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> childCount - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 这里我们遍历子视图</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">View</span> <span class=\"variable\">child</span> <span class=\"operator\">=</span> getChildAt(i);                                                                               </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (child == excludeView) &#123;                                                                                     </span><br><span class=\"line\">            <span class=\"keyword\">continue</span>;                                                                                                   </span><br><span class=\"line\">        &#125;                                                                                                               </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (left &lt; child.getRight() &amp;&amp; child.getLeft() &lt; right &amp;&amp; top &lt; child.getBottom() &amp;&amp; child.getTop() &lt; bottom) &#123; </span><br><span class=\"line\">            <span class=\"comment\">// 是否存在相交的子视图                                                                                                       </span></span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">calculateLeft</span> <span class=\"operator\">=</span> left;                                                                                   </span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">calculateRight</span> <span class=\"operator\">=</span> right;                                                                                 </span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">caluculateTop</span> <span class=\"operator\">=</span> top;                                                                                    </span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">caluculateBottom</span> <span class=\"operator\">=</span> bottom;                                                                              </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (child.getLeft() &gt; calculateLeft)&#123;                                                                       </span><br><span class=\"line\">                calculateLeft = child.getLeft();                                                                        </span><br><span class=\"line\">            &#125;                                                                                                           </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (child.getRight() &lt; calculateRight)&#123;                                                                     </span><br><span class=\"line\">                calculateRight = child.getRight();                                                                      </span><br><span class=\"line\">            &#125;                                                                                                           </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (child.getTop() &gt; caluculateTop)&#123;                                                                        </span><br><span class=\"line\">                caluculateTop = child.getTop();                                                                         </span><br><span class=\"line\">            &#125;                                                                                                           </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (child.getBottom() &lt; caluculateBottom)&#123;                                                                  </span><br><span class=\"line\">                caluculateBottom = child.getBottom();                                                                   </span><br><span class=\"line\">            &#125;                                                                                                           </span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">unionArea</span> <span class=\"operator\">=</span> (calculateRight - calculateLeft) * (caluculateBottom - caluculateTop);                      </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (unionArea &gt; (child.getWidth() * child.getHeight() * <span class=\"number\">0.5f</span>))&#123;</span><br><span class=\"line\">                <span class=\"comment\">// 这里我们再通过 相交面积是否大于视图面积的一半 去判定</span></span><br><span class=\"line\">                <span class=\"comment\">// 这是为了不那么敏感</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> i;                                                                                               </span><br><span class=\"line\">            &#125;                                                                                                           </span><br><span class=\"line\">        &#125;                                                                                                               </span><br><span class=\"line\">    &#125;                                                                                                                   </span><br><span class=\"line\">    <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;                                                                                                          </span><br><span class=\"line\">&#125;                                                                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>经过上面的步骤，我们已经实现了百分之八十的代码，这时，我们还需要考虑几个问题。</p>\n<ul>\n<li><p>位置交换后，我们通过 <code>indexOfChild</code> 或 <code>getChildAt</code> 得到的数据还是原来的，即我们通过调用 <code>addView</code> 添加的顺序。这里我们自己去缓存一个子视图列表，重写上面两个方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                             </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">indexOfChild</span><span class=\"params\">(View child)</span> &#123; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mChildViews.indexOf(child);</span><br><span class=\"line\">&#125;                                     </span><br><span class=\"line\">                                      </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                             </span><br><span class=\"line\"><span class=\"keyword\">public</span> View <span class=\"title function_\">getChildAt</span><span class=\"params\">(<span class=\"type\">int</span> index)</span> &#123;   </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mChildViews.get(index);    </span><br><span class=\"line\">&#125;                                     </span><br></pre></td></tr></table></figure>\n\n<p>同时在视图移动时，去修改这个列表：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mChildViews.set(targetPosition, targetView); </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>绘制顺序问题，ViewGroup 的默认绘制顺序是根据 <code>addView</code>  的调用顺序，这样会带来一个问题，当你拖拽到比当前拖拽视图更晚添加的子视图时，会显示在这个视图下面，同样我们可以通过 <code>setChildrenDrawingOrderEnabled</code> 和 </p>\n<p><code>getChildDrawingOrder</code> 去自定义绘制顺序，这里为了方便，我们通过设置拖拽视图的 Z 值来实现同样的效果：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ViewCompat.setZ(capturedChild, <span class=\"number\">100f</span>);     </span><br><span class=\"line\">postInvalidate();                         </span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>最后我们顺便把 Item 的点击事件实现下。。。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                 </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">onSingleTapConfirmed</span><span class=\"params\">(MotionEvent e)</span> &#123;                                      </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">View</span> <span class=\"variable\">targetView</span> <span class=\"operator\">=</span> mDragHelper.findTopChildUnder((<span class=\"type\">int</span>) e.getX(), (<span class=\"type\">int</span>) e.getY());</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetView == <span class=\"literal\">null</span>) &#123;                                                             </span><br><span class=\"line\">        <span class=\"keyword\">return</span> performClick();                                                            </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mGridItemClickListener != <span class=\"literal\">null</span>) &#123;                                          </span><br><span class=\"line\">        mGridItemClickListener.onClickItem(indexOfChild(targetView), targetView);         </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                                                                      </span><br><span class=\"line\">    &#125;                                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;                                                                         </span><br><span class=\"line\">&#125;                                                                                         </span><br></pre></td></tr></table></figure>\n"},{"title":"浅谈Flutter热重载(上)","date":"2019-09-09T11:51:49.000Z","_content":"\n## 更新记录\n\n* 本文完成于 本文写于 2019.09.10，Flutter SDK 版本为 v1.5.4-hotfix.2\n* 2019.09.12 更新，将**差异包**字眼变更为**增量包**\n* 2019.09.12 更新，**--not-hot** 写错，应该为 **--no-hot**\n\n## 前言\n\n这是浅谈 Flutter 系列的第二篇，上一篇是 [浅谈Flutter构建](https://juejin.im/post/5d68fb1af265da03d063b69e)，在上一篇中，主要是理清 Flutter 在 debug 和 release 模式下生成的不同产物分别是什么，怎么调试 build_tools 源码等等，这些不会在后面重复讨论，所以有需要的同学可以先看下第一篇。\n\n热重载是 Flutter 的一个大杀器，非常受欢迎，特别是对于客户端开发的同学来说，项目大了以后，可能就会出现，代码改一行，构建半小时的场面。之前非常火热的组件化方案其实一点就是为了解决构建时间过长的痛点。而对于 Flutter 来说，有两种模式可以快速应用修改：hot reload（热重载）和 hot restart（热重启），其中 hot reload 只需要几百毫秒就可以完成更新，速度非常快，hot restart 稍微慢一点，需要秒单位。在修改了资源文件或需要重新构建状态，只能使用 hot restart。\n\n## 源码解析\n\n在第一篇文章中，我们说到，对于每个 Flutter 命令，都有一个 Command 类与之对应，我们使用的 `flutter run` 是由 RunCommand 类处理的。\n\n默认在 debug 模式下会开启 hot mode，release 模式下默认关闭，可以在执行 run 命令的时候，添加 `--no-hot` 来禁用 hot mode。\n\n当启用 hot mode 时，会使用 HotRunner 来启动 Flutter 应用。\n\n``` dart\nif (hotMode) {                                          \n  runner = HotRunner(                                   \n    flutterDevices,                                     \n    target: targetFile,                                 \n    debuggingOptions: _createDebuggingOptions(),        \n    benchmarkMode: argResults['benchmark'],             \n    applicationBinary: applicationBinaryPath == null    \n        ? null                                          \n        : fs.file(applicationBinaryPath),               \n    projectRootPath: argResults['project-root'],        \n    packagesFilePath: globalResults['packages'],        \n    dillOutputPath: argResults['output-dill'],          \n    saveCompilationTrace: argResults['train'],          \n    stayResident: stayResident,                         \n    ipv6: ipv6,                                         \n  );                                                    \n} \n```\n\nhot mode 开启后，首先会进行初始化，这部分相关的代码在 `HotRunner run()`。\n\n### 初始化\n\n* 构建应用，以 Anroid 为例，这里会调用 gradle 去执行 assemble task 来生成 APK 文件\n\n  ``` dart\n  if (!prebuiltApplication || androidSdk.licensesAvailable && androidSdk.latestVersion == null) {   \n    printTrace('Building APK');                                                                     \n    final FlutterProject project = FlutterProject.current();                                        \n    await buildApk(                                                                                 \n        project: project,                                                                           \n        target: mainPath,                                                                           \n        androidBuildInfo: AndroidBuildInfo(debuggingOptions.buildInfo,                              \n          targetArchs: <AndroidArch>[androidArch]                                                   \n        ),                                                                                           \n    );                                                                                              \n    // Package has been built, so we can get the updated application ID and                         \n    // activity name from the .apk.                                                                 \n    package = await AndroidApk.fromAndroidProject(project.android);                                 \n  }                                                                                                 \n  ```\n\n* 构建 APK 成功，则会使用 adb 启动它，并建立 sockets 连接，转发主机的端口到设备上。\n\n  > 这里的主机指的是，运行 Flutter 命令的环境，一般是 PC。设备指的是，运行 Flutter 应用的环境，这里指手机。\n\n  转发端口的意义是为了与设备上 Dart VM（虚拟机）进行通信，这个后面会说到。\n\n  在使用 adb 启动应用后，会监听 log 输出，使用正则表达式去获取 sockets 连接地址后，设置端口转发。\n\n  ``` dart\n  void _handleLine(String line) {                                                                                  \n    Uri uri;                                                                                                       \n    final RegExp r = RegExp('${RegExp.escape(serviceName)} listening on ((http|\\/\\/)[a-zA-Z0-9:/=_\\\\-\\.\\\\[\\\\]]+)');\n    final Match match = r.firstMatch(line);                                                                        \n                                                                                                                   \n    if (match != null) {                                                                                           \n      try {                                                                                                        \n        uri = Uri.parse(match[1]);                                                                                 \n      } catch (error) {                                                                                            \n        _stopScrapingLogs();                                                                                       \n        _completer.completeError(error);                                                                           \n      }                                                                                                            \n    }                                                                                                              \n                                                                                                                   \n    if (uri != null) {                                                                                             \n      assert(!_completer.isCompleted);                                                                             \n      _stopScrapingLogs();                                                                                         \n      _completer.complete(_forwardPort(uri));                                                                      \n    }                                                                                                              \n                                                                                                                   \n  }\n  \n  // 转发端口\n  Future<Uri> _forwardPort(Uri deviceUri) async {                                                         \n    printTrace('$serviceName URL on device: $deviceUri');                                                 \n    Uri hostUri = deviceUri;                                                                              \n                                                                                                          \n    if (portForwarder != null) {                                                                          \n      final int actualDevicePort = deviceUri.port;                                                        \n      final int actualHostPort = await portForwarder.forward(actualDevicePort, hostPort: hostPort);       \n      printTrace('Forwarded host port $actualHostPort to device port $actualDevicePort for $serviceName');\n      hostUri = deviceUri.replace(port: actualHostPort);                                                  \n    }                                                                                                     \n                                                                                                          \n    assert(InternetAddress(hostUri.host).isLoopback);                                                     \n    if (ipv6) {                                                                                           \n      hostUri = hostUri.replace(host: InternetAddress.loopbackIPv6.host);                                 \n    }                                                                                                     \n                                                                                                          \n    return hostUri;                                                                                       \n  }                                                                                                       \n  ```\n\n  在我的设备上，匹配地址如下：\n\n  ``` \n  09-08 14:14:12.708  6122  6149 I flutter : Observatory listening on http://127.0.0.1:45093/6p_NsmXILHw=/\n  ```\n\n* 根据第二步建立的 sockets 连接地址和转发的端口，建立 RPC 通信，这里使用的 [json_rpc_2](https://github.com/dart-lang/json_rpc_2) 。\n\n  > 关于 Dart VM 支持的 RPC 方法可以看这里：[Dart VM Service Protocol 3.26](https://github.com/dart-lang/sdk/blob/master/runtime/vm/service/service.md)\n  >\n  > 关于 JSON-RPC，可以看这里：[JSON-RPC 2.0 Specification](https://www.jsonrpc.org/specification)\n  >\n  > 注意：Dart VM 只支持 WebSocket，不支持 HTTP。\n  >\n  > \"The VM will start a webserver which services protocol requests via WebSocket. It is possible to make HTTP (non-WebSocket) requests, but this does not allow access to VM *events* and is not documented here.\"\n\n  ``` dart\n  static Future<VMService> connect(                                                                            \n    Uri httpUri, {                                                                                             \n    ReloadSources reloadSources,                                                                               \n    Restart restart,                                                                                           \n    CompileExpression compileExpression,                                                                       \n    io.CompressionOptions compression = io.CompressionOptions.compressionDefault,                              \n  }) async {                                                                                                   \n    final Uri wsUri = httpUri.replace(scheme: 'ws', path: fs.path.join(httpUri.path, 'ws'));                   \n    final StreamChannel<String> channel = await _openChannel(wsUri, compression: compression);                 \n    final rpc.Peer peer = rpc.Peer.withoutJson(jsonDocument.bind(channel), onUnhandledError: _unhandledError); \n    final VMService service = VMService(peer, httpUri, wsUri, reloadSources, restart, compileExpression);      \n    // This call is to ensure we are able to establish a connection instead of                                 \n    // keeping on trucking and failing farther down the process.                                               \n    await service._sendRequest('getVersion', const <String, dynamic>{});                                       \n    return service;                                                                                            \n  }                                                                                                            \n  ```\n\n  关于 Dart VM 具体的使用，可以看 `FlutterDevice.getVMs()` 和 `FlutterDevice.refreshViews()` 两个函数。\n  \n  `getVMs()` 用于获取 Dart VM 实例，最终调用的是 **getVM** 这个 RPC 方法：\n  \n  ``` dart\n  @override                                                             \n  Future<Map<String, dynamic>> _fetchDirect() => invokeRpcRaw('getVM'); \n  ```\n  \n  ![getVM](https://user-gold-cdn.xitu.io/2019/9/9/16d14e728a12328b?w=904&h=184&f=png&s=19281)\n  \n  `refreshVIews()` 用于获取最新的 FlutterView 实例，最终调用的是 **_flutter.listViews** 这个 RPC 方法：\n  \n  ``` dart\n  // When the future returned by invokeRpc() below returns,              \n  // the _viewCache will have been updated.                              \n  // This message updates all the views of every isolate.                \n  await vmService.vm.invokeRpc<ServiceObject>('_flutter.listViews');     \n  ```\n  \n  这个方法不属于 Dart VM 定义的，是 Flutter 额外扩展的方法，定义位于 [Engine-specific-Service-Protocol-extensions](https://github.com/flutter/flutter/wiki/Engine-specific-Service-Protocol-extensions)：\n  \n  ![listViews](https://user-gold-cdn.xitu.io/2019/9/9/16d14ec3de2b95e0?w=747&h=535&f=png&s=61996)\n  \n* 这是初始化的最后一步，使用 devfs 管理设备文件，当执行热重载时，会重新生成增量包再同步到设备上。\n\n  首先，会在设备上生成一个目录，用于存放重载的资源文件和增量包。\n\n  ``` dart\n  @override                                                                             \n  Future<Uri> create(String fsName) async {                                             \n    final Map<String, dynamic> response = await vmService.vm.createDevFS(fsName);       \n    return Uri.parse(response['uri']);                                                  \n  }                                                                               \n  \n  /// Create a new development file system on the device.                             \n  Future<Map<String, dynamic>> createDevFS(String fsName) {                           \n    return invokeRpcRaw('_createDevFS', params: <String, dynamic>{'fsName': fsName}); \n  }                                                                                   \n  ```\n\n  生成的 Uri 类似这种：file:///data/user/0/com.example.my_app/code_cache/my_appLGHJYJ/my_app/，每个 FlutterDevice 都会有个 `DevFS devFS` 用于封装对设备文件的同步。设备上创建的目录如下：\n\n  ![code_cache](https://user-gold-cdn.xitu.io/2019/9/9/16d154533a74184f?w=429&h=170&f=png&s=17910)\n\n  每执行一次 `flutter run` 都会生成一个新的 `my_appXXXX` 目录，修改的资源都会同步到这个目录中。\n  \n  > 注意这里我是用的测试项目 my_app\n  \n  在生成目录后，会同步一次资源文件，将 fonts、packages、AssetManifest.json 等同步到设备中。\n  \n  ``` dart\n  final UpdateFSReport devfsResult = await _updateDevFS(fullRestart: true);\n  ```\n  \n  ![code_cache_my_app](https://user-gold-cdn.xitu.io/2019/9/9/16d15520be20309e?w=463&h=213&f=png&s=24775)\n\n### 监听输入\n\n当修改了 dart 代码后，我们需要输入 r 或者 R 来使得我们的修改生效，其中 r 表示 hot reload，R 表示 hot restart。\n\n首先，需要先注册输入处理函数：\n\n``` dart\nvoid setupTerminal() {                               \n  assert(stayResident);                              \n  if (usesTerminalUI) {                              \n    if (!logger.quiet) {                             \n      printStatus('');                               \n      printHelp(details: false);                     \n    }                                                \n    terminal.singleCharMode = true;                  \n    terminal.keystrokes.listen(processTerminalInput);\n  }                                                  \n}                                                    \n```\n\n当输入 r 时，最终会调用到 `restart(false)` 这个方法：\n\n``` dart\nif (lower == 'r') {                                                             \n  OperationResult result;                                                       \n  if (code == 'R') {                                                            \n    // If hot restart is not supported for all devices, ignore the command.     \n    if (!canHotRestart) {                                                       \n      return;                                                                   \n    }                                                                           \n    result = await restart(fullRestart: true);                                  \n  } else {                                                                      \n    result = await restart(fullRestart: false);                                 \n  }                                                                             \n  if (!result.isOk) {                                                           \n    printStatus('Try again after fixing the above error(s).', emphasis: true);  \n  }                                                                             \n}                                                     \n```\n\n`restart()` 函数的核心代码在 `_reloadSources()` 函数中，这个函数的主要作用如下：\n\n* 调用 `_updateDevFS()` 方法，生成增量包，并同步到设备上，DevFS 用于管理设备文件系统。\n\n  首先比较资源文件的修改时间，判断是否需要更新：\n\n  ``` dart\n  // Only update assets if they have been modified, or if this is the      \n  // first upload of the asset bundle.                                     \n  if (content.isModified || (bundleFirstUpload && archivePath != null)) {  \n    dirtyEntries[deviceUri] = content;                                     \n    syncedBytes += content.size;                                           \n    if (archivePath != null && !bundleFirstUpload) {                       \n      assetPathsToEvict.add(archivePath);                                  \n    }                                                                      \n  }                                                                        \n  ```\n\n  dirtyEntries 用于存放需要更新的内容，syncedBytes 计算需要同步的字节数。\n\n  接着，生成代码增量包，以 .incremental.dill 结尾：\n\n  ``` dart\n  final CompilerOutput compilerOutput = await generator.recompile(                                              \n    mainPath,                                                                                                   \n    invalidatedFiles,                                                                                           \n    outputPath:  dillOutputPath ?? getDefaultApplicationKernelPath(trackWidgetCreation: trackWidgetCreation),   \n    packagesFilePath : _packagesFilePath,                                                                       \n  );                                                                                                            \n  ```\n\n  最后通过 http 写入到设备中：\n\n  ``` dart\n  if (dirtyEntries.isNotEmpty) {                                                        \n    try {                                                                               \n      await _httpWriter.write(dirtyEntries);                                            \n    } on SocketException catch (socketException, stackTrace) {                          \n      printTrace('DevFS sync failed. Lost connection to device: $socketException');     \n      throw DevFSException('Lost connection to device.', socketException, stackTrace);  \n    } catch (exception, stackTrace) {                                                   \n      printError('Could not update files on device: $exception');                       \n      throw DevFSException('Sync failed', exception, stackTrace);                       \n    }                                                                                   \n  }                                                                                     \n  ```\n\n* 调用 `reloadSources()` 方法通知 Dart VM 重新加载 Dart 增量包，同样的这里也是调用的 RPC 方法：\n\n  ``` dart\n  final Map<String, dynamic> arguments = <String, dynamic>{                                      \n    'pause': pause,                                                                              \n  };                                                                                             \n  if (rootLibUri != null) {                                                                      \n    arguments['rootLibUri'] = rootLibUri.toString();                                             \n  }                                                                                              \n  if (packagesUri != null) {                                                                     \n    arguments['packagesUri'] = packagesUri.toString();                                           \n  }                                                                                              \n  final Map<String, dynamic> response = await invokeRpcRaw('_reloadSources', params: arguments); \n  return response;                                                                               \n  ```\n\n* 最后调用 `flutterReassemble()` 方法重新刷新页面，这里调用的是 RPC 方法 **ext.flutter.reassemble**：\n\n  ``` dart\n  Future<Map<String, dynamic>> flutterReassemble() {                \n    return invokeFlutterExtensionRpcRaw('ext.flutter.reassemble');  \n  }                                                                 \n  ```\n\n## 关于增量包\n\n我们用一个非常简单的 DEMO 来看下生成的增量包的内容。DEMO 有两个 dart 文件，首先是 main.dart，这个是入口文件：\n\n``` dart\nvoid main() => runApp(MyApp());          \n                                         \nclass MyApp extends StatelessWidget {    \n  @override                              \n  Widget build(BuildContext context) {   \n    return MaterialApp(                  \n      title: 'Flutter Demo',             \n      theme: ThemeData(                  \n        primarySwatch: Colors.blue,      \n      ),                                 \n      home: HomePage(),                  \n    );                                   \n  }                                      \n}                                        \n```\n\nhome.dart 也非常简单，就显示一个文本：\n\n``` dart\nclass HomePage extends StatelessWidget {   \n  @override                                \n  Widget build(BuildContext context) {     \n    return Scaffold(                       \n      body: Center(                        \n        child: Text('Hello World'),        \n      ),                                   \n      appBar: AppBar(                      \n        title: Text('My APP'),             \n      ),                                   \n    );                                     \n  }                                        \n}                                          \n```\n\n这里我们做两个地方的修改，首先是将主题颜色从 `Colors.blue` 改成 `Colors.red`，将 HomePage 中的 \"Hello World\" 改成 \"Hello Flutter\"。\n\n修改完成后，在终端键入 r 后执行，会在 build 目录下生成 app.dill.incremental.dill，什么是 dill 文件？其实这里面就是我们的代码产物，用于提供给 Dart VM 执行的。我们用 `strings` 命令查看下内容：\n\n![incremental.dill](https://user-gold-cdn.xitu.io/2019/9/9/16d162fd0eda5b3e?w=804&h=928&f=png&s=941410)\n\n修改的内容已经包含在增量包中了，当我们执行 `_updateDevFS()` 方法后，incremental.dill 也被同步到设备中了。\n\n![app_incremental_dill](https://user-gold-cdn.xitu.io/2019/9/9/16d1633c7395161b?w=758&h=354&f=png&s=46822)\n\n名字虽然不一样，但内容一致的。现在设备是已经包含了增量包，接着下来就是通知 Dart VM 刷新了，先调用 `reloadSources()`，最后调用 `flutterReassemble()`，执行完之后，我们就可以看到新的界面了。\n\n![new_ui](https://user-gold-cdn.xitu.io/2019/9/9/16d1643f1380ac04?w=608&h=1086&f=png&s=97611)\n\n## 总结\n\n热重载功能的实现，首先是增量包的实现，这里我们没有细讲，留到后面的文章中，生成的增量包，文件后缀以 incremental.dill 结尾，文件的同步则通过 adb 建立的 sockets 连接进行传输，而且这个 sockets 另外一个非常重要的功能就是，建立和 Dart VM 的 RPC 通信，Dart VM 本身就已经定义了一些 RPC 方法，Flutter 又扩展了一些，获取 Dart VM 信息，刷新 Flutter 视图等等都是通过 RPC 实现的。\n\n因为篇幅的原因，这里我们并没有讲解增量包的生成实现，还有 Dart VM 和 Flutter engine 对 RPC 方法的实现，这个留到后面的文章。\n\n写到这里，其实距离实现动态更新的目标也越来越清晰，第一，生成增量包；第二，在合适的时候，重新加载刷新增量包。","source":"_posts/浅谈Flutter热重载-上.md","raw":"---\ntitle: 浅谈Flutter热重载(上)\ndate: 2019-09-09 19:51:49\ncategories: Flutter\ntags:\n---\n\n## 更新记录\n\n* 本文完成于 本文写于 2019.09.10，Flutter SDK 版本为 v1.5.4-hotfix.2\n* 2019.09.12 更新，将**差异包**字眼变更为**增量包**\n* 2019.09.12 更新，**--not-hot** 写错，应该为 **--no-hot**\n\n## 前言\n\n这是浅谈 Flutter 系列的第二篇，上一篇是 [浅谈Flutter构建](https://juejin.im/post/5d68fb1af265da03d063b69e)，在上一篇中，主要是理清 Flutter 在 debug 和 release 模式下生成的不同产物分别是什么，怎么调试 build_tools 源码等等，这些不会在后面重复讨论，所以有需要的同学可以先看下第一篇。\n\n热重载是 Flutter 的一个大杀器，非常受欢迎，特别是对于客户端开发的同学来说，项目大了以后，可能就会出现，代码改一行，构建半小时的场面。之前非常火热的组件化方案其实一点就是为了解决构建时间过长的痛点。而对于 Flutter 来说，有两种模式可以快速应用修改：hot reload（热重载）和 hot restart（热重启），其中 hot reload 只需要几百毫秒就可以完成更新，速度非常快，hot restart 稍微慢一点，需要秒单位。在修改了资源文件或需要重新构建状态，只能使用 hot restart。\n\n## 源码解析\n\n在第一篇文章中，我们说到，对于每个 Flutter 命令，都有一个 Command 类与之对应，我们使用的 `flutter run` 是由 RunCommand 类处理的。\n\n默认在 debug 模式下会开启 hot mode，release 模式下默认关闭，可以在执行 run 命令的时候，添加 `--no-hot` 来禁用 hot mode。\n\n当启用 hot mode 时，会使用 HotRunner 来启动 Flutter 应用。\n\n``` dart\nif (hotMode) {                                          \n  runner = HotRunner(                                   \n    flutterDevices,                                     \n    target: targetFile,                                 \n    debuggingOptions: _createDebuggingOptions(),        \n    benchmarkMode: argResults['benchmark'],             \n    applicationBinary: applicationBinaryPath == null    \n        ? null                                          \n        : fs.file(applicationBinaryPath),               \n    projectRootPath: argResults['project-root'],        \n    packagesFilePath: globalResults['packages'],        \n    dillOutputPath: argResults['output-dill'],          \n    saveCompilationTrace: argResults['train'],          \n    stayResident: stayResident,                         \n    ipv6: ipv6,                                         \n  );                                                    \n} \n```\n\nhot mode 开启后，首先会进行初始化，这部分相关的代码在 `HotRunner run()`。\n\n### 初始化\n\n* 构建应用，以 Anroid 为例，这里会调用 gradle 去执行 assemble task 来生成 APK 文件\n\n  ``` dart\n  if (!prebuiltApplication || androidSdk.licensesAvailable && androidSdk.latestVersion == null) {   \n    printTrace('Building APK');                                                                     \n    final FlutterProject project = FlutterProject.current();                                        \n    await buildApk(                                                                                 \n        project: project,                                                                           \n        target: mainPath,                                                                           \n        androidBuildInfo: AndroidBuildInfo(debuggingOptions.buildInfo,                              \n          targetArchs: <AndroidArch>[androidArch]                                                   \n        ),                                                                                           \n    );                                                                                              \n    // Package has been built, so we can get the updated application ID and                         \n    // activity name from the .apk.                                                                 \n    package = await AndroidApk.fromAndroidProject(project.android);                                 \n  }                                                                                                 \n  ```\n\n* 构建 APK 成功，则会使用 adb 启动它，并建立 sockets 连接，转发主机的端口到设备上。\n\n  > 这里的主机指的是，运行 Flutter 命令的环境，一般是 PC。设备指的是，运行 Flutter 应用的环境，这里指手机。\n\n  转发端口的意义是为了与设备上 Dart VM（虚拟机）进行通信，这个后面会说到。\n\n  在使用 adb 启动应用后，会监听 log 输出，使用正则表达式去获取 sockets 连接地址后，设置端口转发。\n\n  ``` dart\n  void _handleLine(String line) {                                                                                  \n    Uri uri;                                                                                                       \n    final RegExp r = RegExp('${RegExp.escape(serviceName)} listening on ((http|\\/\\/)[a-zA-Z0-9:/=_\\\\-\\.\\\\[\\\\]]+)');\n    final Match match = r.firstMatch(line);                                                                        \n                                                                                                                   \n    if (match != null) {                                                                                           \n      try {                                                                                                        \n        uri = Uri.parse(match[1]);                                                                                 \n      } catch (error) {                                                                                            \n        _stopScrapingLogs();                                                                                       \n        _completer.completeError(error);                                                                           \n      }                                                                                                            \n    }                                                                                                              \n                                                                                                                   \n    if (uri != null) {                                                                                             \n      assert(!_completer.isCompleted);                                                                             \n      _stopScrapingLogs();                                                                                         \n      _completer.complete(_forwardPort(uri));                                                                      \n    }                                                                                                              \n                                                                                                                   \n  }\n  \n  // 转发端口\n  Future<Uri> _forwardPort(Uri deviceUri) async {                                                         \n    printTrace('$serviceName URL on device: $deviceUri');                                                 \n    Uri hostUri = deviceUri;                                                                              \n                                                                                                          \n    if (portForwarder != null) {                                                                          \n      final int actualDevicePort = deviceUri.port;                                                        \n      final int actualHostPort = await portForwarder.forward(actualDevicePort, hostPort: hostPort);       \n      printTrace('Forwarded host port $actualHostPort to device port $actualDevicePort for $serviceName');\n      hostUri = deviceUri.replace(port: actualHostPort);                                                  \n    }                                                                                                     \n                                                                                                          \n    assert(InternetAddress(hostUri.host).isLoopback);                                                     \n    if (ipv6) {                                                                                           \n      hostUri = hostUri.replace(host: InternetAddress.loopbackIPv6.host);                                 \n    }                                                                                                     \n                                                                                                          \n    return hostUri;                                                                                       \n  }                                                                                                       \n  ```\n\n  在我的设备上，匹配地址如下：\n\n  ``` \n  09-08 14:14:12.708  6122  6149 I flutter : Observatory listening on http://127.0.0.1:45093/6p_NsmXILHw=/\n  ```\n\n* 根据第二步建立的 sockets 连接地址和转发的端口，建立 RPC 通信，这里使用的 [json_rpc_2](https://github.com/dart-lang/json_rpc_2) 。\n\n  > 关于 Dart VM 支持的 RPC 方法可以看这里：[Dart VM Service Protocol 3.26](https://github.com/dart-lang/sdk/blob/master/runtime/vm/service/service.md)\n  >\n  > 关于 JSON-RPC，可以看这里：[JSON-RPC 2.0 Specification](https://www.jsonrpc.org/specification)\n  >\n  > 注意：Dart VM 只支持 WebSocket，不支持 HTTP。\n  >\n  > \"The VM will start a webserver which services protocol requests via WebSocket. It is possible to make HTTP (non-WebSocket) requests, but this does not allow access to VM *events* and is not documented here.\"\n\n  ``` dart\n  static Future<VMService> connect(                                                                            \n    Uri httpUri, {                                                                                             \n    ReloadSources reloadSources,                                                                               \n    Restart restart,                                                                                           \n    CompileExpression compileExpression,                                                                       \n    io.CompressionOptions compression = io.CompressionOptions.compressionDefault,                              \n  }) async {                                                                                                   \n    final Uri wsUri = httpUri.replace(scheme: 'ws', path: fs.path.join(httpUri.path, 'ws'));                   \n    final StreamChannel<String> channel = await _openChannel(wsUri, compression: compression);                 \n    final rpc.Peer peer = rpc.Peer.withoutJson(jsonDocument.bind(channel), onUnhandledError: _unhandledError); \n    final VMService service = VMService(peer, httpUri, wsUri, reloadSources, restart, compileExpression);      \n    // This call is to ensure we are able to establish a connection instead of                                 \n    // keeping on trucking and failing farther down the process.                                               \n    await service._sendRequest('getVersion', const <String, dynamic>{});                                       \n    return service;                                                                                            \n  }                                                                                                            \n  ```\n\n  关于 Dart VM 具体的使用，可以看 `FlutterDevice.getVMs()` 和 `FlutterDevice.refreshViews()` 两个函数。\n  \n  `getVMs()` 用于获取 Dart VM 实例，最终调用的是 **getVM** 这个 RPC 方法：\n  \n  ``` dart\n  @override                                                             \n  Future<Map<String, dynamic>> _fetchDirect() => invokeRpcRaw('getVM'); \n  ```\n  \n  ![getVM](https://user-gold-cdn.xitu.io/2019/9/9/16d14e728a12328b?w=904&h=184&f=png&s=19281)\n  \n  `refreshVIews()` 用于获取最新的 FlutterView 实例，最终调用的是 **_flutter.listViews** 这个 RPC 方法：\n  \n  ``` dart\n  // When the future returned by invokeRpc() below returns,              \n  // the _viewCache will have been updated.                              \n  // This message updates all the views of every isolate.                \n  await vmService.vm.invokeRpc<ServiceObject>('_flutter.listViews');     \n  ```\n  \n  这个方法不属于 Dart VM 定义的，是 Flutter 额外扩展的方法，定义位于 [Engine-specific-Service-Protocol-extensions](https://github.com/flutter/flutter/wiki/Engine-specific-Service-Protocol-extensions)：\n  \n  ![listViews](https://user-gold-cdn.xitu.io/2019/9/9/16d14ec3de2b95e0?w=747&h=535&f=png&s=61996)\n  \n* 这是初始化的最后一步，使用 devfs 管理设备文件，当执行热重载时，会重新生成增量包再同步到设备上。\n\n  首先，会在设备上生成一个目录，用于存放重载的资源文件和增量包。\n\n  ``` dart\n  @override                                                                             \n  Future<Uri> create(String fsName) async {                                             \n    final Map<String, dynamic> response = await vmService.vm.createDevFS(fsName);       \n    return Uri.parse(response['uri']);                                                  \n  }                                                                               \n  \n  /// Create a new development file system on the device.                             \n  Future<Map<String, dynamic>> createDevFS(String fsName) {                           \n    return invokeRpcRaw('_createDevFS', params: <String, dynamic>{'fsName': fsName}); \n  }                                                                                   \n  ```\n\n  生成的 Uri 类似这种：file:///data/user/0/com.example.my_app/code_cache/my_appLGHJYJ/my_app/，每个 FlutterDevice 都会有个 `DevFS devFS` 用于封装对设备文件的同步。设备上创建的目录如下：\n\n  ![code_cache](https://user-gold-cdn.xitu.io/2019/9/9/16d154533a74184f?w=429&h=170&f=png&s=17910)\n\n  每执行一次 `flutter run` 都会生成一个新的 `my_appXXXX` 目录，修改的资源都会同步到这个目录中。\n  \n  > 注意这里我是用的测试项目 my_app\n  \n  在生成目录后，会同步一次资源文件，将 fonts、packages、AssetManifest.json 等同步到设备中。\n  \n  ``` dart\n  final UpdateFSReport devfsResult = await _updateDevFS(fullRestart: true);\n  ```\n  \n  ![code_cache_my_app](https://user-gold-cdn.xitu.io/2019/9/9/16d15520be20309e?w=463&h=213&f=png&s=24775)\n\n### 监听输入\n\n当修改了 dart 代码后，我们需要输入 r 或者 R 来使得我们的修改生效，其中 r 表示 hot reload，R 表示 hot restart。\n\n首先，需要先注册输入处理函数：\n\n``` dart\nvoid setupTerminal() {                               \n  assert(stayResident);                              \n  if (usesTerminalUI) {                              \n    if (!logger.quiet) {                             \n      printStatus('');                               \n      printHelp(details: false);                     \n    }                                                \n    terminal.singleCharMode = true;                  \n    terminal.keystrokes.listen(processTerminalInput);\n  }                                                  \n}                                                    \n```\n\n当输入 r 时，最终会调用到 `restart(false)` 这个方法：\n\n``` dart\nif (lower == 'r') {                                                             \n  OperationResult result;                                                       \n  if (code == 'R') {                                                            \n    // If hot restart is not supported for all devices, ignore the command.     \n    if (!canHotRestart) {                                                       \n      return;                                                                   \n    }                                                                           \n    result = await restart(fullRestart: true);                                  \n  } else {                                                                      \n    result = await restart(fullRestart: false);                                 \n  }                                                                             \n  if (!result.isOk) {                                                           \n    printStatus('Try again after fixing the above error(s).', emphasis: true);  \n  }                                                                             \n}                                                     \n```\n\n`restart()` 函数的核心代码在 `_reloadSources()` 函数中，这个函数的主要作用如下：\n\n* 调用 `_updateDevFS()` 方法，生成增量包，并同步到设备上，DevFS 用于管理设备文件系统。\n\n  首先比较资源文件的修改时间，判断是否需要更新：\n\n  ``` dart\n  // Only update assets if they have been modified, or if this is the      \n  // first upload of the asset bundle.                                     \n  if (content.isModified || (bundleFirstUpload && archivePath != null)) {  \n    dirtyEntries[deviceUri] = content;                                     \n    syncedBytes += content.size;                                           \n    if (archivePath != null && !bundleFirstUpload) {                       \n      assetPathsToEvict.add(archivePath);                                  \n    }                                                                      \n  }                                                                        \n  ```\n\n  dirtyEntries 用于存放需要更新的内容，syncedBytes 计算需要同步的字节数。\n\n  接着，生成代码增量包，以 .incremental.dill 结尾：\n\n  ``` dart\n  final CompilerOutput compilerOutput = await generator.recompile(                                              \n    mainPath,                                                                                                   \n    invalidatedFiles,                                                                                           \n    outputPath:  dillOutputPath ?? getDefaultApplicationKernelPath(trackWidgetCreation: trackWidgetCreation),   \n    packagesFilePath : _packagesFilePath,                                                                       \n  );                                                                                                            \n  ```\n\n  最后通过 http 写入到设备中：\n\n  ``` dart\n  if (dirtyEntries.isNotEmpty) {                                                        \n    try {                                                                               \n      await _httpWriter.write(dirtyEntries);                                            \n    } on SocketException catch (socketException, stackTrace) {                          \n      printTrace('DevFS sync failed. Lost connection to device: $socketException');     \n      throw DevFSException('Lost connection to device.', socketException, stackTrace);  \n    } catch (exception, stackTrace) {                                                   \n      printError('Could not update files on device: $exception');                       \n      throw DevFSException('Sync failed', exception, stackTrace);                       \n    }                                                                                   \n  }                                                                                     \n  ```\n\n* 调用 `reloadSources()` 方法通知 Dart VM 重新加载 Dart 增量包，同样的这里也是调用的 RPC 方法：\n\n  ``` dart\n  final Map<String, dynamic> arguments = <String, dynamic>{                                      \n    'pause': pause,                                                                              \n  };                                                                                             \n  if (rootLibUri != null) {                                                                      \n    arguments['rootLibUri'] = rootLibUri.toString();                                             \n  }                                                                                              \n  if (packagesUri != null) {                                                                     \n    arguments['packagesUri'] = packagesUri.toString();                                           \n  }                                                                                              \n  final Map<String, dynamic> response = await invokeRpcRaw('_reloadSources', params: arguments); \n  return response;                                                                               \n  ```\n\n* 最后调用 `flutterReassemble()` 方法重新刷新页面，这里调用的是 RPC 方法 **ext.flutter.reassemble**：\n\n  ``` dart\n  Future<Map<String, dynamic>> flutterReassemble() {                \n    return invokeFlutterExtensionRpcRaw('ext.flutter.reassemble');  \n  }                                                                 \n  ```\n\n## 关于增量包\n\n我们用一个非常简单的 DEMO 来看下生成的增量包的内容。DEMO 有两个 dart 文件，首先是 main.dart，这个是入口文件：\n\n``` dart\nvoid main() => runApp(MyApp());          \n                                         \nclass MyApp extends StatelessWidget {    \n  @override                              \n  Widget build(BuildContext context) {   \n    return MaterialApp(                  \n      title: 'Flutter Demo',             \n      theme: ThemeData(                  \n        primarySwatch: Colors.blue,      \n      ),                                 \n      home: HomePage(),                  \n    );                                   \n  }                                      \n}                                        \n```\n\nhome.dart 也非常简单，就显示一个文本：\n\n``` dart\nclass HomePage extends StatelessWidget {   \n  @override                                \n  Widget build(BuildContext context) {     \n    return Scaffold(                       \n      body: Center(                        \n        child: Text('Hello World'),        \n      ),                                   \n      appBar: AppBar(                      \n        title: Text('My APP'),             \n      ),                                   \n    );                                     \n  }                                        \n}                                          \n```\n\n这里我们做两个地方的修改，首先是将主题颜色从 `Colors.blue` 改成 `Colors.red`，将 HomePage 中的 \"Hello World\" 改成 \"Hello Flutter\"。\n\n修改完成后，在终端键入 r 后执行，会在 build 目录下生成 app.dill.incremental.dill，什么是 dill 文件？其实这里面就是我们的代码产物，用于提供给 Dart VM 执行的。我们用 `strings` 命令查看下内容：\n\n![incremental.dill](https://user-gold-cdn.xitu.io/2019/9/9/16d162fd0eda5b3e?w=804&h=928&f=png&s=941410)\n\n修改的内容已经包含在增量包中了，当我们执行 `_updateDevFS()` 方法后，incremental.dill 也被同步到设备中了。\n\n![app_incremental_dill](https://user-gold-cdn.xitu.io/2019/9/9/16d1633c7395161b?w=758&h=354&f=png&s=46822)\n\n名字虽然不一样，但内容一致的。现在设备是已经包含了增量包，接着下来就是通知 Dart VM 刷新了，先调用 `reloadSources()`，最后调用 `flutterReassemble()`，执行完之后，我们就可以看到新的界面了。\n\n![new_ui](https://user-gold-cdn.xitu.io/2019/9/9/16d1643f1380ac04?w=608&h=1086&f=png&s=97611)\n\n## 总结\n\n热重载功能的实现，首先是增量包的实现，这里我们没有细讲，留到后面的文章中，生成的增量包，文件后缀以 incremental.dill 结尾，文件的同步则通过 adb 建立的 sockets 连接进行传输，而且这个 sockets 另外一个非常重要的功能就是，建立和 Dart VM 的 RPC 通信，Dart VM 本身就已经定义了一些 RPC 方法，Flutter 又扩展了一些，获取 Dart VM 信息，刷新 Flutter 视图等等都是通过 RPC 实现的。\n\n因为篇幅的原因，这里我们并没有讲解增量包的生成实现，还有 Dart VM 和 Flutter engine 对 RPC 方法的实现，这个留到后面的文章。\n\n写到这里，其实距离实现动态更新的目标也越来越清晰，第一，生成增量包；第二，在合适的时候，重新加载刷新增量包。","slug":"浅谈Flutter热重载-上","published":1,"updated":"2022-06-15T11:19:32.326Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrlw000wfho621ijcs5z","content":"<h2 id=\"更新记录\"><a href=\"#更新记录\" class=\"headerlink\" title=\"更新记录\"></a>更新记录</h2><ul>\n<li>本文完成于 本文写于 2019.09.10，Flutter SDK 版本为 v1.5.4-hotfix.2</li>\n<li>2019.09.12 更新，将<strong>差异包</strong>字眼变更为<strong>增量包</strong></li>\n<li>2019.09.12 更新，**–not-hot** 写错，应该为 <strong>–no-hot</strong></li>\n</ul>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>这是浅谈 Flutter 系列的第二篇，上一篇是 <a href=\"https://juejin.im/post/5d68fb1af265da03d063b69e\">浅谈Flutter构建</a>，在上一篇中，主要是理清 Flutter 在 debug 和 release 模式下生成的不同产物分别是什么，怎么调试 build_tools 源码等等，这些不会在后面重复讨论，所以有需要的同学可以先看下第一篇。</p>\n<p>热重载是 Flutter 的一个大杀器，非常受欢迎，特别是对于客户端开发的同学来说，项目大了以后，可能就会出现，代码改一行，构建半小时的场面。之前非常火热的组件化方案其实一点就是为了解决构建时间过长的痛点。而对于 Flutter 来说，有两种模式可以快速应用修改：hot reload（热重载）和 hot restart（热重启），其中 hot reload 只需要几百毫秒就可以完成更新，速度非常快，hot restart 稍微慢一点，需要秒单位。在修改了资源文件或需要重新构建状态，只能使用 hot restart。</p>\n<h2 id=\"源码解析\"><a href=\"#源码解析\" class=\"headerlink\" title=\"源码解析\"></a>源码解析</h2><p>在第一篇文章中，我们说到，对于每个 Flutter 命令，都有一个 Command 类与之对应，我们使用的 <code>flutter run</code> 是由 RunCommand 类处理的。</p>\n<p>默认在 debug 模式下会开启 hot mode，release 模式下默认关闭，可以在执行 run 命令的时候，添加 <code>--no-hot</code> 来禁用 hot mode。</p>\n<p>当启用 hot mode 时，会使用 HotRunner 来启动 Flutter 应用。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (hotMode) &#123;                                          </span><br><span class=\"line\">  runner = HotRunner(                                   </span><br><span class=\"line\">    flutterDevices,                                     </span><br><span class=\"line\">    target: targetFile,                                 </span><br><span class=\"line\">    debuggingOptions: _createDebuggingOptions(),        </span><br><span class=\"line\">    benchmarkMode: argResults[<span class=\"string\">&#x27;benchmark&#x27;</span>],             </span><br><span class=\"line\">    applicationBinary: applicationBinaryPath == <span class=\"keyword\">null</span>    </span><br><span class=\"line\">        ? <span class=\"keyword\">null</span>                                          </span><br><span class=\"line\">        : fs.file(applicationBinaryPath),               </span><br><span class=\"line\">    projectRootPath: argResults[<span class=\"string\">&#x27;project-root&#x27;</span>],        </span><br><span class=\"line\">    packagesFilePath: globalResults[<span class=\"string\">&#x27;packages&#x27;</span>],        </span><br><span class=\"line\">    dillOutputPath: argResults[<span class=\"string\">&#x27;output-dill&#x27;</span>],          </span><br><span class=\"line\">    saveCompilationTrace: argResults[<span class=\"string\">&#x27;train&#x27;</span>],          </span><br><span class=\"line\">    stayResident: stayResident,                         </span><br><span class=\"line\">    ipv6: ipv6,                                         </span><br><span class=\"line\">  );                                                    </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n\n<p>hot mode 开启后，首先会进行初始化，这部分相关的代码在 <code>HotRunner run()</code>。</p>\n<h3 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h3><ul>\n<li><p>构建应用，以 Anroid 为例，这里会调用 gradle 去执行 assemble task 来生成 APK 文件</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!prebuiltApplication || androidSdk.licensesAvailable &amp;&amp; androidSdk.latestVersion == <span class=\"keyword\">null</span>) &#123;   </span><br><span class=\"line\">  printTrace(<span class=\"string\">&#x27;Building APK&#x27;</span>);                                                                     </span><br><span class=\"line\">  <span class=\"keyword\">final</span> FlutterProject project = FlutterProject.current();                                        </span><br><span class=\"line\">  <span class=\"keyword\">await</span> buildApk(                                                                                 </span><br><span class=\"line\">      project: project,                                                                           </span><br><span class=\"line\">      target: mainPath,                                                                           </span><br><span class=\"line\">      androidBuildInfo: AndroidBuildInfo(debuggingOptions.buildInfo,                              </span><br><span class=\"line\">        targetArchs: &lt;AndroidArch&gt;[androidArch]                                                   </span><br><span class=\"line\">      ),                                                                                           </span><br><span class=\"line\">  );                                                                                              </span><br><span class=\"line\">  <span class=\"comment\">// Package has been built, so we can get the updated application ID and                         </span></span><br><span class=\"line\">  <span class=\"comment\">// activity name from the .apk.                                                                 </span></span><br><span class=\"line\">  package = <span class=\"keyword\">await</span> AndroidApk.fromAndroidProject(project.android);                                 </span><br><span class=\"line\">&#125;                                                                                                 </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>构建 APK 成功，则会使用 adb 启动它，并建立 sockets 连接，转发主机的端口到设备上。</p>\n<blockquote>\n<p>这里的主机指的是，运行 Flutter 命令的环境，一般是 PC。设备指的是，运行 Flutter 应用的环境，这里指手机。</p>\n</blockquote>\n<p>转发端口的意义是为了与设备上 Dart VM（虚拟机）进行通信，这个后面会说到。</p>\n<p>在使用 adb 启动应用后，会监听 log 输出，使用正则表达式去获取 sockets 连接地址后，设置端口转发。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> _handleLine(<span class=\"built_in\">String</span> line) &#123;                                                                                  </span><br><span class=\"line\">  <span class=\"built_in\">Uri</span> uri;                                                                                                       </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">RegExp</span> r = <span class=\"built_in\">RegExp</span>(<span class=\"string\">&#x27;<span class=\"subst\">$&#123;RegExp.escape(serviceName)&#125;</span> listening on ((http|\\/\\/)[a-zA-Z0-9:/=_\\\\-\\.\\\\[\\\\]]+)&#x27;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">Match</span> match = r.firstMatch(line);                                                                        </span><br><span class=\"line\">                                                                                                                 </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (match != <span class=\"keyword\">null</span>) &#123;                                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;                                                                                                        </span><br><span class=\"line\">      uri = <span class=\"built_in\">Uri</span>.parse(match[<span class=\"number\">1</span>]);                                                                                 </span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (error) &#123;                                                                                            </span><br><span class=\"line\">      _stopScrapingLogs();                                                                                       </span><br><span class=\"line\">      _completer.completeError(error);                                                                           </span><br><span class=\"line\">    &#125;                                                                                                            </span><br><span class=\"line\">  &#125;                                                                                                              </span><br><span class=\"line\">                                                                                                                 </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (uri != <span class=\"keyword\">null</span>) &#123;                                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">assert</span>(!_completer.isCompleted);                                                                             </span><br><span class=\"line\">    _stopScrapingLogs();                                                                                         </span><br><span class=\"line\">    _completer.complete(_forwardPort(uri));                                                                      </span><br><span class=\"line\">  &#125;                                                                                                              </span><br><span class=\"line\">                                                                                                                 </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 转发端口</span></span><br><span class=\"line\">Future&lt;<span class=\"built_in\">Uri</span>&gt; _forwardPort(<span class=\"built_in\">Uri</span> deviceUri) <span class=\"keyword\">async</span> &#123;                                                         </span><br><span class=\"line\">  printTrace(<span class=\"string\">&#x27;<span class=\"subst\">$serviceName</span> URL on device: <span class=\"subst\">$deviceUri</span>&#x27;</span>);                                                 </span><br><span class=\"line\">  <span class=\"built_in\">Uri</span> hostUri = deviceUri;                                                                              </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (portForwarder != <span class=\"keyword\">null</span>) &#123;                                                                          </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> actualDevicePort = deviceUri.port;                                                        </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> actualHostPort = <span class=\"keyword\">await</span> portForwarder.forward(actualDevicePort, hostPort: hostPort);       </span><br><span class=\"line\">    printTrace(<span class=\"string\">&#x27;Forwarded host port <span class=\"subst\">$actualHostPort</span> to device port <span class=\"subst\">$actualDevicePort</span> for <span class=\"subst\">$serviceName</span>&#x27;</span>);</span><br><span class=\"line\">    hostUri = deviceUri.replace(port: actualHostPort);                                                  </span><br><span class=\"line\">  &#125;                                                                                                     </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(InternetAddress(hostUri.host).isLoopback);                                                     </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ipv6) &#123;                                                                                           </span><br><span class=\"line\">    hostUri = hostUri.replace(host: InternetAddress.loopbackIPv6.host);                                 </span><br><span class=\"line\">  &#125;                                                                                                     </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">  <span class=\"keyword\">return</span> hostUri;                                                                                       </span><br><span class=\"line\">&#125;                                                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>在我的设备上，匹配地址如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">09-08 14:14:12.708  6122  6149 I flutter : Observatory listening on http://127.0.0.1:45093/6p_NsmXILHw=/</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>根据第二步建立的 sockets 连接地址和转发的端口，建立 RPC 通信，这里使用的 <a href=\"https://github.com/dart-lang/json_rpc_2\">json_rpc_2</a> 。</p>\n<blockquote>\n<p>关于 Dart VM 支持的 RPC 方法可以看这里：<a href=\"https://github.com/dart-lang/sdk/blob/master/runtime/vm/service/service.md\">Dart VM Service Protocol 3.26</a></p>\n<p>关于 JSON-RPC，可以看这里：<a href=\"https://www.jsonrpc.org/specification\">JSON-RPC 2.0 Specification</a></p>\n<p>注意：Dart VM 只支持 WebSocket，不支持 HTTP。</p>\n<p>“The VM will start a webserver which services protocol requests via WebSocket. It is possible to make HTTP (non-WebSocket) requests, but this does not allow access to VM <em>events</em> and is not documented here.”</p>\n</blockquote>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> Future&lt;VMService&gt; connect(                                                                            </span><br><span class=\"line\">  <span class=\"built_in\">Uri</span> httpUri, &#123;                                                                                             </span><br><span class=\"line\">  ReloadSources reloadSources,                                                                               </span><br><span class=\"line\">  Restart restart,                                                                                           </span><br><span class=\"line\">  CompileExpression compileExpression,                                                                       </span><br><span class=\"line\">  io.CompressionOptions compression = io.CompressionOptions.compressionDefault,                              </span><br><span class=\"line\">&#125;) <span class=\"keyword\">async</span> &#123;                                                                                                   </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">Uri</span> wsUri = httpUri.replace(scheme: <span class=\"string\">&#x27;ws&#x27;</span>, path: fs.path.join(httpUri.path, <span class=\"string\">&#x27;ws&#x27;</span>));                   </span><br><span class=\"line\">  <span class=\"keyword\">final</span> StreamChannel&lt;<span class=\"built_in\">String</span>&gt; channel = <span class=\"keyword\">await</span> _openChannel(wsUri, compression: compression);                 </span><br><span class=\"line\">  <span class=\"keyword\">final</span> rpc.Peer peer = rpc.Peer.withoutJson(jsonDocument.bind(channel), onUnhandledError: _unhandledError); </span><br><span class=\"line\">  <span class=\"keyword\">final</span> VMService service = VMService(peer, httpUri, wsUri, reloadSources, restart, compileExpression);      </span><br><span class=\"line\">  <span class=\"comment\">// This call is to ensure we are able to establish a connection instead of                                 </span></span><br><span class=\"line\">  <span class=\"comment\">// keeping on trucking and failing farther down the process.                                               </span></span><br><span class=\"line\">  <span class=\"keyword\">await</span> service._sendRequest(<span class=\"string\">&#x27;getVersion&#x27;</span>, <span class=\"keyword\">const</span> &lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&#123;&#125;);                                       </span><br><span class=\"line\">  <span class=\"keyword\">return</span> service;                                                                                            </span><br><span class=\"line\">&#125;                                                                                                            </span><br></pre></td></tr></table></figure>\n\n<p>关于 Dart VM 具体的使用，可以看 <code>FlutterDevice.getVMs()</code> 和 <code>FlutterDevice.refreshViews()</code> 两个函数。</p>\n<p><code>getVMs()</code> 用于获取 Dart VM 实例，最终调用的是 <strong>getVM</strong> 这个 RPC 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                             </span><br><span class=\"line\">Future&lt;<span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&gt; _fetchDirect() =&gt; invokeRpcRaw(<span class=\"string\">&#x27;getVM&#x27;</span>); </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d14e728a12328b?w=904&h=184&f=png&s=19281\" alt=\"getVM\"></p>\n<p><code>refreshVIews()</code> 用于获取最新的 FlutterView 实例，最终调用的是 <strong>_flutter.listViews</strong> 这个 RPC 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// When the future returned by invokeRpc() below returns,              </span></span><br><span class=\"line\"><span class=\"comment\">// the _viewCache will have been updated.                              </span></span><br><span class=\"line\"><span class=\"comment\">// This message updates all the views of every isolate.                </span></span><br><span class=\"line\"><span class=\"keyword\">await</span> vmService.vm.invokeRpc&lt;ServiceObject&gt;(<span class=\"string\">&#x27;_flutter.listViews&#x27;</span>);     </span><br></pre></td></tr></table></figure>\n\n<p>这个方法不属于 Dart VM 定义的，是 Flutter 额外扩展的方法，定义位于 <a href=\"https://github.com/flutter/flutter/wiki/Engine-specific-Service-Protocol-extensions\">Engine-specific-Service-Protocol-extensions</a>：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d14ec3de2b95e0?w=747&h=535&f=png&s=61996\" alt=\"listViews\"></p>\n</li>\n<li><p>这是初始化的最后一步，使用 devfs 管理设备文件，当执行热重载时，会重新生成增量包再同步到设备上。</p>\n<p>首先，会在设备上生成一个目录，用于存放重载的资源文件和增量包。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                                             </span><br><span class=\"line\">Future&lt;<span class=\"built_in\">Uri</span>&gt; create(<span class=\"built_in\">String</span> fsName) <span class=\"keyword\">async</span> &#123;                                             </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt; response = <span class=\"keyword\">await</span> vmService.vm.createDevFS(fsName);       </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">Uri</span>.parse(response[<span class=\"string\">&#x27;uri&#x27;</span>]);                                                  </span><br><span class=\"line\">&#125;                                                                               </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/// <span class=\"language-markdown\">Create a new development file system on the device.                             </span></span></span><br><span class=\"line\">Future&lt;<span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&gt; createDevFS(<span class=\"built_in\">String</span> fsName) &#123;                           </span><br><span class=\"line\">  <span class=\"keyword\">return</span> invokeRpcRaw(<span class=\"string\">&#x27;_createDevFS&#x27;</span>, params: &lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&#123;<span class=\"string\">&#x27;fsName&#x27;</span>: fsName&#125;); </span><br><span class=\"line\">&#125;                                                                                   </span><br></pre></td></tr></table></figure>\n\n<p>生成的 Uri 类似这种：file:&#x2F;&#x2F;&#x2F;data&#x2F;user&#x2F;0&#x2F;com.example.my_app&#x2F;code_cache&#x2F;my_appLGHJYJ&#x2F;my_app&#x2F;，每个 FlutterDevice 都会有个 <code>DevFS devFS</code> 用于封装对设备文件的同步。设备上创建的目录如下：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d154533a74184f?w=429&h=170&f=png&s=17910\" alt=\"code_cache\"></p>\n<p>每执行一次 <code>flutter run</code> 都会生成一个新的 <code>my_appXXXX</code> 目录，修改的资源都会同步到这个目录中。</p>\n<blockquote>\n<p>注意这里我是用的测试项目 my_app</p>\n</blockquote>\n<p>在生成目录后，会同步一次资源文件，将 fonts、packages、AssetManifest.json 等同步到设备中。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> UpdateFSReport devfsResult = <span class=\"keyword\">await</span> _updateDevFS(fullRestart: <span class=\"keyword\">true</span>);</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d15520be20309e?w=463&h=213&f=png&s=24775\" alt=\"code_cache_my_app\"></p>\n</li>\n</ul>\n<h3 id=\"监听输入\"><a href=\"#监听输入\" class=\"headerlink\" title=\"监听输入\"></a>监听输入</h3><p>当修改了 dart 代码后，我们需要输入 r 或者 R 来使得我们的修改生效，其中 r 表示 hot reload，R 表示 hot restart。</p>\n<p>首先，需要先注册输入处理函数：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> setupTerminal() &#123;                               </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(stayResident);                              </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (usesTerminalUI) &#123;                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!logger.quiet) &#123;                             </span><br><span class=\"line\">      printStatus(<span class=\"string\">&#x27;&#x27;</span>);                               </span><br><span class=\"line\">      printHelp(details: <span class=\"keyword\">false</span>);                     </span><br><span class=\"line\">    &#125;                                                </span><br><span class=\"line\">    terminal.singleCharMode = <span class=\"keyword\">true</span>;                  </span><br><span class=\"line\">    terminal.keystrokes.listen(processTerminalInput);</span><br><span class=\"line\">  &#125;                                                  </span><br><span class=\"line\">&#125;                                                    </span><br></pre></td></tr></table></figure>\n\n<p>当输入 r 时，最终会调用到 <code>restart(false)</code> 这个方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (lower == <span class=\"string\">&#x27;r&#x27;</span>) &#123;                                                             </span><br><span class=\"line\">  OperationResult result;                                                       </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (code == <span class=\"string\">&#x27;R&#x27;</span>) &#123;                                                            </span><br><span class=\"line\">    <span class=\"comment\">// If hot restart is not supported for all devices, ignore the command.     </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!canHotRestart) &#123;                                                       </span><br><span class=\"line\">      <span class=\"keyword\">return</span>;                                                                   </span><br><span class=\"line\">    &#125;                                                                           </span><br><span class=\"line\">    result = <span class=\"keyword\">await</span> restart(fullRestart: <span class=\"keyword\">true</span>);                                  </span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;                                                                      </span><br><span class=\"line\">    result = <span class=\"keyword\">await</span> restart(fullRestart: <span class=\"keyword\">false</span>);                                 </span><br><span class=\"line\">  &#125;                                                                             </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!result.isOk) &#123;                                                           </span><br><span class=\"line\">    printStatus(<span class=\"string\">&#x27;Try again after fixing the above error(s).&#x27;</span>, emphasis: <span class=\"keyword\">true</span>);  </span><br><span class=\"line\">  &#125;                                                                             </span><br><span class=\"line\">&#125;                                                     </span><br></pre></td></tr></table></figure>\n\n<p><code>restart()</code> 函数的核心代码在 <code>_reloadSources()</code> 函数中，这个函数的主要作用如下：</p>\n<ul>\n<li><p>调用 <code>_updateDevFS()</code> 方法，生成增量包，并同步到设备上，DevFS 用于管理设备文件系统。</p>\n<p>首先比较资源文件的修改时间，判断是否需要更新：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Only update assets if they have been modified, or if this is the      </span></span><br><span class=\"line\"><span class=\"comment\">// first upload of the asset bundle.                                     </span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (content.isModified || (bundleFirstUpload &amp;&amp; archivePath != <span class=\"keyword\">null</span>)) &#123;  </span><br><span class=\"line\">  dirtyEntries[deviceUri] = content;                                     </span><br><span class=\"line\">  syncedBytes += content.size;                                           </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (archivePath != <span class=\"keyword\">null</span> &amp;&amp; !bundleFirstUpload) &#123;                       </span><br><span class=\"line\">    assetPathsToEvict.add(archivePath);                                  </span><br><span class=\"line\">  &#125;                                                                      </span><br><span class=\"line\">&#125;                                                                        </span><br></pre></td></tr></table></figure>\n\n<p>dirtyEntries 用于存放需要更新的内容，syncedBytes 计算需要同步的字节数。</p>\n<p>接着，生成代码增量包，以 .incremental.dill 结尾：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> CompilerOutput compilerOutput = <span class=\"keyword\">await</span> generator.recompile(                                              </span><br><span class=\"line\">  mainPath,                                                                                                   </span><br><span class=\"line\">  invalidatedFiles,                                                                                           </span><br><span class=\"line\">  outputPath:  dillOutputPath ?? getDefaultApplicationKernelPath(trackWidgetCreation: trackWidgetCreation),   </span><br><span class=\"line\">  packagesFilePath : _packagesFilePath,                                                                       </span><br><span class=\"line\">);                                                                                                            </span><br></pre></td></tr></table></figure>\n\n<p>最后通过 http 写入到设备中：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (dirtyEntries.isNotEmpty) &#123;                                                        </span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;                                                                               </span><br><span class=\"line\">    <span class=\"keyword\">await</span> _httpWriter.write(dirtyEntries);                                            </span><br><span class=\"line\">  &#125; <span class=\"keyword\">on</span> SocketException <span class=\"keyword\">catch</span> (socketException, stackTrace) &#123;                          </span><br><span class=\"line\">    printTrace(<span class=\"string\">&#x27;DevFS sync failed. Lost connection to device: <span class=\"subst\">$socketException</span>&#x27;</span>);     </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> DevFSException(<span class=\"string\">&#x27;Lost connection to device.&#x27;</span>, socketException, stackTrace);  </span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (exception, stackTrace) &#123;                                                   </span><br><span class=\"line\">    printError(<span class=\"string\">&#x27;Could not update files on device: <span class=\"subst\">$exception</span>&#x27;</span>);                       </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> DevFSException(<span class=\"string\">&#x27;Sync failed&#x27;</span>, exception, stackTrace);                       </span><br><span class=\"line\">  &#125;                                                                                   </span><br><span class=\"line\">&#125;                                                                                     </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调用 <code>reloadSources()</code> 方法通知 Dart VM 重新加载 Dart 增量包，同样的这里也是调用的 RPC 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt; arguments = &lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&#123;                                      </span><br><span class=\"line\">  <span class=\"string\">&#x27;pause&#x27;</span>: pause,                                                                              </span><br><span class=\"line\">&#125;;                                                                                             </span><br><span class=\"line\"><span class=\"keyword\">if</span> (rootLibUri != <span class=\"keyword\">null</span>) &#123;                                                                      </span><br><span class=\"line\">  arguments[<span class=\"string\">&#x27;rootLibUri&#x27;</span>] = rootLibUri.toString();                                             </span><br><span class=\"line\">&#125;                                                                                              </span><br><span class=\"line\"><span class=\"keyword\">if</span> (packagesUri != <span class=\"keyword\">null</span>) &#123;                                                                     </span><br><span class=\"line\">  arguments[<span class=\"string\">&#x27;packagesUri&#x27;</span>] = packagesUri.toString();                                           </span><br><span class=\"line\">&#125;                                                                                              </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt; response = <span class=\"keyword\">await</span> invokeRpcRaw(<span class=\"string\">&#x27;_reloadSources&#x27;</span>, params: arguments); </span><br><span class=\"line\"><span class=\"keyword\">return</span> response;                                                                               </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>最后调用 <code>flutterReassemble()</code> 方法重新刷新页面，这里调用的是 RPC 方法 <strong>ext.flutter.reassemble</strong>：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Future&lt;<span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&gt; flutterReassemble() &#123;                </span><br><span class=\"line\">  <span class=\"keyword\">return</span> invokeFlutterExtensionRpcRaw(<span class=\"string\">&#x27;ext.flutter.reassemble&#x27;</span>);  </span><br><span class=\"line\">&#125;                                                                 </span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"关于增量包\"><a href=\"#关于增量包\" class=\"headerlink\" title=\"关于增量包\"></a>关于增量包</h2><p>我们用一个非常简单的 DEMO 来看下生成的增量包的内容。DEMO 有两个 dart 文件，首先是 main.dart，这个是入口文件：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> main() =&gt; runApp(MyApp());          </span><br><span class=\"line\">                                         </span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyApp</span> <span class=\"keyword\">extends</span> <span class=\"title\">StatelessWidget</span> </span>&#123;    </span><br><span class=\"line\">  <span class=\"meta\">@override</span>                              </span><br><span class=\"line\">  Widget build(BuildContext context) &#123;   </span><br><span class=\"line\">    <span class=\"keyword\">return</span> MaterialApp(                  </span><br><span class=\"line\">      title: <span class=\"string\">&#x27;Flutter Demo&#x27;</span>,             </span><br><span class=\"line\">      theme: ThemeData(                  </span><br><span class=\"line\">        primarySwatch: Colors.blue,      </span><br><span class=\"line\">      ),                                 </span><br><span class=\"line\">      home: HomePage(),                  </span><br><span class=\"line\">    );                                   </span><br><span class=\"line\">  &#125;                                      </span><br><span class=\"line\">&#125;                                        </span><br></pre></td></tr></table></figure>\n\n<p>home.dart 也非常简单，就显示一个文本：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HomePage</span> <span class=\"keyword\">extends</span> <span class=\"title\">StatelessWidget</span> </span>&#123;   </span><br><span class=\"line\">  <span class=\"meta\">@override</span>                                </span><br><span class=\"line\">  Widget build(BuildContext context) &#123;     </span><br><span class=\"line\">    <span class=\"keyword\">return</span> Scaffold(                       </span><br><span class=\"line\">      body: Center(                        </span><br><span class=\"line\">        child: Text(<span class=\"string\">&#x27;Hello World&#x27;</span>),        </span><br><span class=\"line\">      ),                                   </span><br><span class=\"line\">      appBar: AppBar(                      </span><br><span class=\"line\">        title: Text(<span class=\"string\">&#x27;My APP&#x27;</span>),             </span><br><span class=\"line\">      ),                                   </span><br><span class=\"line\">    );                                     </span><br><span class=\"line\">  &#125;                                        </span><br><span class=\"line\">&#125;                                          </span><br></pre></td></tr></table></figure>\n\n<p>这里我们做两个地方的修改，首先是将主题颜色从 <code>Colors.blue</code> 改成 <code>Colors.red</code>，将 HomePage 中的 “Hello World” 改成 “Hello Flutter”。</p>\n<p>修改完成后，在终端键入 r 后执行，会在 build 目录下生成 app.dill.incremental.dill，什么是 dill 文件？其实这里面就是我们的代码产物，用于提供给 Dart VM 执行的。我们用 <code>strings</code> 命令查看下内容：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d162fd0eda5b3e?w=804&h=928&f=png&s=941410\" alt=\"incremental.dill\"></p>\n<p>修改的内容已经包含在增量包中了，当我们执行 <code>_updateDevFS()</code> 方法后，incremental.dill 也被同步到设备中了。</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d1633c7395161b?w=758&h=354&f=png&s=46822\" alt=\"app_incremental_dill\"></p>\n<p>名字虽然不一样，但内容一致的。现在设备是已经包含了增量包，接着下来就是通知 Dart VM 刷新了，先调用 <code>reloadSources()</code>，最后调用 <code>flutterReassemble()</code>，执行完之后，我们就可以看到新的界面了。</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d1643f1380ac04?w=608&h=1086&f=png&s=97611\" alt=\"new_ui\"></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>热重载功能的实现，首先是增量包的实现，这里我们没有细讲，留到后面的文章中，生成的增量包，文件后缀以 incremental.dill 结尾，文件的同步则通过 adb 建立的 sockets 连接进行传输，而且这个 sockets 另外一个非常重要的功能就是，建立和 Dart VM 的 RPC 通信，Dart VM 本身就已经定义了一些 RPC 方法，Flutter 又扩展了一些，获取 Dart VM 信息，刷新 Flutter 视图等等都是通过 RPC 实现的。</p>\n<p>因为篇幅的原因，这里我们并没有讲解增量包的生成实现，还有 Dart VM 和 Flutter engine 对 RPC 方法的实现，这个留到后面的文章。</p>\n<p>写到这里，其实距离实现动态更新的目标也越来越清晰，第一，生成增量包；第二，在合适的时候，重新加载刷新增量包。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"更新记录\"><a href=\"#更新记录\" class=\"headerlink\" title=\"更新记录\"></a>更新记录</h2><ul>\n<li>本文完成于 本文写于 2019.09.10，Flutter SDK 版本为 v1.5.4-hotfix.2</li>\n<li>2019.09.12 更新，将<strong>差异包</strong>字眼变更为<strong>增量包</strong></li>\n<li>2019.09.12 更新，**–not-hot** 写错，应该为 <strong>–no-hot</strong></li>\n</ul>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>这是浅谈 Flutter 系列的第二篇，上一篇是 <a href=\"https://juejin.im/post/5d68fb1af265da03d063b69e\">浅谈Flutter构建</a>，在上一篇中，主要是理清 Flutter 在 debug 和 release 模式下生成的不同产物分别是什么，怎么调试 build_tools 源码等等，这些不会在后面重复讨论，所以有需要的同学可以先看下第一篇。</p>\n<p>热重载是 Flutter 的一个大杀器，非常受欢迎，特别是对于客户端开发的同学来说，项目大了以后，可能就会出现，代码改一行，构建半小时的场面。之前非常火热的组件化方案其实一点就是为了解决构建时间过长的痛点。而对于 Flutter 来说，有两种模式可以快速应用修改：hot reload（热重载）和 hot restart（热重启），其中 hot reload 只需要几百毫秒就可以完成更新，速度非常快，hot restart 稍微慢一点，需要秒单位。在修改了资源文件或需要重新构建状态，只能使用 hot restart。</p>\n<h2 id=\"源码解析\"><a href=\"#源码解析\" class=\"headerlink\" title=\"源码解析\"></a>源码解析</h2><p>在第一篇文章中，我们说到，对于每个 Flutter 命令，都有一个 Command 类与之对应，我们使用的 <code>flutter run</code> 是由 RunCommand 类处理的。</p>\n<p>默认在 debug 模式下会开启 hot mode，release 模式下默认关闭，可以在执行 run 命令的时候，添加 <code>--no-hot</code> 来禁用 hot mode。</p>\n<p>当启用 hot mode 时，会使用 HotRunner 来启动 Flutter 应用。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (hotMode) &#123;                                          </span><br><span class=\"line\">  runner = HotRunner(                                   </span><br><span class=\"line\">    flutterDevices,                                     </span><br><span class=\"line\">    target: targetFile,                                 </span><br><span class=\"line\">    debuggingOptions: _createDebuggingOptions(),        </span><br><span class=\"line\">    benchmarkMode: argResults[<span class=\"string\">&#x27;benchmark&#x27;</span>],             </span><br><span class=\"line\">    applicationBinary: applicationBinaryPath == <span class=\"keyword\">null</span>    </span><br><span class=\"line\">        ? <span class=\"keyword\">null</span>                                          </span><br><span class=\"line\">        : fs.file(applicationBinaryPath),               </span><br><span class=\"line\">    projectRootPath: argResults[<span class=\"string\">&#x27;project-root&#x27;</span>],        </span><br><span class=\"line\">    packagesFilePath: globalResults[<span class=\"string\">&#x27;packages&#x27;</span>],        </span><br><span class=\"line\">    dillOutputPath: argResults[<span class=\"string\">&#x27;output-dill&#x27;</span>],          </span><br><span class=\"line\">    saveCompilationTrace: argResults[<span class=\"string\">&#x27;train&#x27;</span>],          </span><br><span class=\"line\">    stayResident: stayResident,                         </span><br><span class=\"line\">    ipv6: ipv6,                                         </span><br><span class=\"line\">  );                                                    </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n\n<p>hot mode 开启后，首先会进行初始化，这部分相关的代码在 <code>HotRunner run()</code>。</p>\n<h3 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h3><ul>\n<li><p>构建应用，以 Anroid 为例，这里会调用 gradle 去执行 assemble task 来生成 APK 文件</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!prebuiltApplication || androidSdk.licensesAvailable &amp;&amp; androidSdk.latestVersion == <span class=\"keyword\">null</span>) &#123;   </span><br><span class=\"line\">  printTrace(<span class=\"string\">&#x27;Building APK&#x27;</span>);                                                                     </span><br><span class=\"line\">  <span class=\"keyword\">final</span> FlutterProject project = FlutterProject.current();                                        </span><br><span class=\"line\">  <span class=\"keyword\">await</span> buildApk(                                                                                 </span><br><span class=\"line\">      project: project,                                                                           </span><br><span class=\"line\">      target: mainPath,                                                                           </span><br><span class=\"line\">      androidBuildInfo: AndroidBuildInfo(debuggingOptions.buildInfo,                              </span><br><span class=\"line\">        targetArchs: &lt;AndroidArch&gt;[androidArch]                                                   </span><br><span class=\"line\">      ),                                                                                           </span><br><span class=\"line\">  );                                                                                              </span><br><span class=\"line\">  <span class=\"comment\">// Package has been built, so we can get the updated application ID and                         </span></span><br><span class=\"line\">  <span class=\"comment\">// activity name from the .apk.                                                                 </span></span><br><span class=\"line\">  package = <span class=\"keyword\">await</span> AndroidApk.fromAndroidProject(project.android);                                 </span><br><span class=\"line\">&#125;                                                                                                 </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>构建 APK 成功，则会使用 adb 启动它，并建立 sockets 连接，转发主机的端口到设备上。</p>\n<blockquote>\n<p>这里的主机指的是，运行 Flutter 命令的环境，一般是 PC。设备指的是，运行 Flutter 应用的环境，这里指手机。</p>\n</blockquote>\n<p>转发端口的意义是为了与设备上 Dart VM（虚拟机）进行通信，这个后面会说到。</p>\n<p>在使用 adb 启动应用后，会监听 log 输出，使用正则表达式去获取 sockets 连接地址后，设置端口转发。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> _handleLine(<span class=\"built_in\">String</span> line) &#123;                                                                                  </span><br><span class=\"line\">  <span class=\"built_in\">Uri</span> uri;                                                                                                       </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">RegExp</span> r = <span class=\"built_in\">RegExp</span>(<span class=\"string\">&#x27;<span class=\"subst\">$&#123;RegExp.escape(serviceName)&#125;</span> listening on ((http|\\/\\/)[a-zA-Z0-9:/=_\\\\-\\.\\\\[\\\\]]+)&#x27;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">Match</span> match = r.firstMatch(line);                                                                        </span><br><span class=\"line\">                                                                                                                 </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (match != <span class=\"keyword\">null</span>) &#123;                                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;                                                                                                        </span><br><span class=\"line\">      uri = <span class=\"built_in\">Uri</span>.parse(match[<span class=\"number\">1</span>]);                                                                                 </span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (error) &#123;                                                                                            </span><br><span class=\"line\">      _stopScrapingLogs();                                                                                       </span><br><span class=\"line\">      _completer.completeError(error);                                                                           </span><br><span class=\"line\">    &#125;                                                                                                            </span><br><span class=\"line\">  &#125;                                                                                                              </span><br><span class=\"line\">                                                                                                                 </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (uri != <span class=\"keyword\">null</span>) &#123;                                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">assert</span>(!_completer.isCompleted);                                                                             </span><br><span class=\"line\">    _stopScrapingLogs();                                                                                         </span><br><span class=\"line\">    _completer.complete(_forwardPort(uri));                                                                      </span><br><span class=\"line\">  &#125;                                                                                                              </span><br><span class=\"line\">                                                                                                                 </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 转发端口</span></span><br><span class=\"line\">Future&lt;<span class=\"built_in\">Uri</span>&gt; _forwardPort(<span class=\"built_in\">Uri</span> deviceUri) <span class=\"keyword\">async</span> &#123;                                                         </span><br><span class=\"line\">  printTrace(<span class=\"string\">&#x27;<span class=\"subst\">$serviceName</span> URL on device: <span class=\"subst\">$deviceUri</span>&#x27;</span>);                                                 </span><br><span class=\"line\">  <span class=\"built_in\">Uri</span> hostUri = deviceUri;                                                                              </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (portForwarder != <span class=\"keyword\">null</span>) &#123;                                                                          </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> actualDevicePort = deviceUri.port;                                                        </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> actualHostPort = <span class=\"keyword\">await</span> portForwarder.forward(actualDevicePort, hostPort: hostPort);       </span><br><span class=\"line\">    printTrace(<span class=\"string\">&#x27;Forwarded host port <span class=\"subst\">$actualHostPort</span> to device port <span class=\"subst\">$actualDevicePort</span> for <span class=\"subst\">$serviceName</span>&#x27;</span>);</span><br><span class=\"line\">    hostUri = deviceUri.replace(port: actualHostPort);                                                  </span><br><span class=\"line\">  &#125;                                                                                                     </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(InternetAddress(hostUri.host).isLoopback);                                                     </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ipv6) &#123;                                                                                           </span><br><span class=\"line\">    hostUri = hostUri.replace(host: InternetAddress.loopbackIPv6.host);                                 </span><br><span class=\"line\">  &#125;                                                                                                     </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">  <span class=\"keyword\">return</span> hostUri;                                                                                       </span><br><span class=\"line\">&#125;                                                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>在我的设备上，匹配地址如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">09-08 14:14:12.708  6122  6149 I flutter : Observatory listening on http://127.0.0.1:45093/6p_NsmXILHw=/</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>根据第二步建立的 sockets 连接地址和转发的端口，建立 RPC 通信，这里使用的 <a href=\"https://github.com/dart-lang/json_rpc_2\">json_rpc_2</a> 。</p>\n<blockquote>\n<p>关于 Dart VM 支持的 RPC 方法可以看这里：<a href=\"https://github.com/dart-lang/sdk/blob/master/runtime/vm/service/service.md\">Dart VM Service Protocol 3.26</a></p>\n<p>关于 JSON-RPC，可以看这里：<a href=\"https://www.jsonrpc.org/specification\">JSON-RPC 2.0 Specification</a></p>\n<p>注意：Dart VM 只支持 WebSocket，不支持 HTTP。</p>\n<p>“The VM will start a webserver which services protocol requests via WebSocket. It is possible to make HTTP (non-WebSocket) requests, but this does not allow access to VM <em>events</em> and is not documented here.”</p>\n</blockquote>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> Future&lt;VMService&gt; connect(                                                                            </span><br><span class=\"line\">  <span class=\"built_in\">Uri</span> httpUri, &#123;                                                                                             </span><br><span class=\"line\">  ReloadSources reloadSources,                                                                               </span><br><span class=\"line\">  Restart restart,                                                                                           </span><br><span class=\"line\">  CompileExpression compileExpression,                                                                       </span><br><span class=\"line\">  io.CompressionOptions compression = io.CompressionOptions.compressionDefault,                              </span><br><span class=\"line\">&#125;) <span class=\"keyword\">async</span> &#123;                                                                                                   </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">Uri</span> wsUri = httpUri.replace(scheme: <span class=\"string\">&#x27;ws&#x27;</span>, path: fs.path.join(httpUri.path, <span class=\"string\">&#x27;ws&#x27;</span>));                   </span><br><span class=\"line\">  <span class=\"keyword\">final</span> StreamChannel&lt;<span class=\"built_in\">String</span>&gt; channel = <span class=\"keyword\">await</span> _openChannel(wsUri, compression: compression);                 </span><br><span class=\"line\">  <span class=\"keyword\">final</span> rpc.Peer peer = rpc.Peer.withoutJson(jsonDocument.bind(channel), onUnhandledError: _unhandledError); </span><br><span class=\"line\">  <span class=\"keyword\">final</span> VMService service = VMService(peer, httpUri, wsUri, reloadSources, restart, compileExpression);      </span><br><span class=\"line\">  <span class=\"comment\">// This call is to ensure we are able to establish a connection instead of                                 </span></span><br><span class=\"line\">  <span class=\"comment\">// keeping on trucking and failing farther down the process.                                               </span></span><br><span class=\"line\">  <span class=\"keyword\">await</span> service._sendRequest(<span class=\"string\">&#x27;getVersion&#x27;</span>, <span class=\"keyword\">const</span> &lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&#123;&#125;);                                       </span><br><span class=\"line\">  <span class=\"keyword\">return</span> service;                                                                                            </span><br><span class=\"line\">&#125;                                                                                                            </span><br></pre></td></tr></table></figure>\n\n<p>关于 Dart VM 具体的使用，可以看 <code>FlutterDevice.getVMs()</code> 和 <code>FlutterDevice.refreshViews()</code> 两个函数。</p>\n<p><code>getVMs()</code> 用于获取 Dart VM 实例，最终调用的是 <strong>getVM</strong> 这个 RPC 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                             </span><br><span class=\"line\">Future&lt;<span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&gt; _fetchDirect() =&gt; invokeRpcRaw(<span class=\"string\">&#x27;getVM&#x27;</span>); </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d14e728a12328b?w=904&h=184&f=png&s=19281\" alt=\"getVM\"></p>\n<p><code>refreshVIews()</code> 用于获取最新的 FlutterView 实例，最终调用的是 <strong>_flutter.listViews</strong> 这个 RPC 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// When the future returned by invokeRpc() below returns,              </span></span><br><span class=\"line\"><span class=\"comment\">// the _viewCache will have been updated.                              </span></span><br><span class=\"line\"><span class=\"comment\">// This message updates all the views of every isolate.                </span></span><br><span class=\"line\"><span class=\"keyword\">await</span> vmService.vm.invokeRpc&lt;ServiceObject&gt;(<span class=\"string\">&#x27;_flutter.listViews&#x27;</span>);     </span><br></pre></td></tr></table></figure>\n\n<p>这个方法不属于 Dart VM 定义的，是 Flutter 额外扩展的方法，定义位于 <a href=\"https://github.com/flutter/flutter/wiki/Engine-specific-Service-Protocol-extensions\">Engine-specific-Service-Protocol-extensions</a>：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d14ec3de2b95e0?w=747&h=535&f=png&s=61996\" alt=\"listViews\"></p>\n</li>\n<li><p>这是初始化的最后一步，使用 devfs 管理设备文件，当执行热重载时，会重新生成增量包再同步到设备上。</p>\n<p>首先，会在设备上生成一个目录，用于存放重载的资源文件和增量包。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@override</span>                                                                             </span><br><span class=\"line\">Future&lt;<span class=\"built_in\">Uri</span>&gt; create(<span class=\"built_in\">String</span> fsName) <span class=\"keyword\">async</span> &#123;                                             </span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt; response = <span class=\"keyword\">await</span> vmService.vm.createDevFS(fsName);       </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">Uri</span>.parse(response[<span class=\"string\">&#x27;uri&#x27;</span>]);                                                  </span><br><span class=\"line\">&#125;                                                                               </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/// <span class=\"language-markdown\">Create a new development file system on the device.                             </span></span></span><br><span class=\"line\">Future&lt;<span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&gt; createDevFS(<span class=\"built_in\">String</span> fsName) &#123;                           </span><br><span class=\"line\">  <span class=\"keyword\">return</span> invokeRpcRaw(<span class=\"string\">&#x27;_createDevFS&#x27;</span>, params: &lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&#123;<span class=\"string\">&#x27;fsName&#x27;</span>: fsName&#125;); </span><br><span class=\"line\">&#125;                                                                                   </span><br></pre></td></tr></table></figure>\n\n<p>生成的 Uri 类似这种：file:&#x2F;&#x2F;&#x2F;data&#x2F;user&#x2F;0&#x2F;com.example.my_app&#x2F;code_cache&#x2F;my_appLGHJYJ&#x2F;my_app&#x2F;，每个 FlutterDevice 都会有个 <code>DevFS devFS</code> 用于封装对设备文件的同步。设备上创建的目录如下：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d154533a74184f?w=429&h=170&f=png&s=17910\" alt=\"code_cache\"></p>\n<p>每执行一次 <code>flutter run</code> 都会生成一个新的 <code>my_appXXXX</code> 目录，修改的资源都会同步到这个目录中。</p>\n<blockquote>\n<p>注意这里我是用的测试项目 my_app</p>\n</blockquote>\n<p>在生成目录后，会同步一次资源文件，将 fonts、packages、AssetManifest.json 等同步到设备中。</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> UpdateFSReport devfsResult = <span class=\"keyword\">await</span> _updateDevFS(fullRestart: <span class=\"keyword\">true</span>);</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d15520be20309e?w=463&h=213&f=png&s=24775\" alt=\"code_cache_my_app\"></p>\n</li>\n</ul>\n<h3 id=\"监听输入\"><a href=\"#监听输入\" class=\"headerlink\" title=\"监听输入\"></a>监听输入</h3><p>当修改了 dart 代码后，我们需要输入 r 或者 R 来使得我们的修改生效，其中 r 表示 hot reload，R 表示 hot restart。</p>\n<p>首先，需要先注册输入处理函数：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> setupTerminal() &#123;                               </span><br><span class=\"line\">  <span class=\"keyword\">assert</span>(stayResident);                              </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (usesTerminalUI) &#123;                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!logger.quiet) &#123;                             </span><br><span class=\"line\">      printStatus(<span class=\"string\">&#x27;&#x27;</span>);                               </span><br><span class=\"line\">      printHelp(details: <span class=\"keyword\">false</span>);                     </span><br><span class=\"line\">    &#125;                                                </span><br><span class=\"line\">    terminal.singleCharMode = <span class=\"keyword\">true</span>;                  </span><br><span class=\"line\">    terminal.keystrokes.listen(processTerminalInput);</span><br><span class=\"line\">  &#125;                                                  </span><br><span class=\"line\">&#125;                                                    </span><br></pre></td></tr></table></figure>\n\n<p>当输入 r 时，最终会调用到 <code>restart(false)</code> 这个方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (lower == <span class=\"string\">&#x27;r&#x27;</span>) &#123;                                                             </span><br><span class=\"line\">  OperationResult result;                                                       </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (code == <span class=\"string\">&#x27;R&#x27;</span>) &#123;                                                            </span><br><span class=\"line\">    <span class=\"comment\">// If hot restart is not supported for all devices, ignore the command.     </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!canHotRestart) &#123;                                                       </span><br><span class=\"line\">      <span class=\"keyword\">return</span>;                                                                   </span><br><span class=\"line\">    &#125;                                                                           </span><br><span class=\"line\">    result = <span class=\"keyword\">await</span> restart(fullRestart: <span class=\"keyword\">true</span>);                                  </span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;                                                                      </span><br><span class=\"line\">    result = <span class=\"keyword\">await</span> restart(fullRestart: <span class=\"keyword\">false</span>);                                 </span><br><span class=\"line\">  &#125;                                                                             </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!result.isOk) &#123;                                                           </span><br><span class=\"line\">    printStatus(<span class=\"string\">&#x27;Try again after fixing the above error(s).&#x27;</span>, emphasis: <span class=\"keyword\">true</span>);  </span><br><span class=\"line\">  &#125;                                                                             </span><br><span class=\"line\">&#125;                                                     </span><br></pre></td></tr></table></figure>\n\n<p><code>restart()</code> 函数的核心代码在 <code>_reloadSources()</code> 函数中，这个函数的主要作用如下：</p>\n<ul>\n<li><p>调用 <code>_updateDevFS()</code> 方法，生成增量包，并同步到设备上，DevFS 用于管理设备文件系统。</p>\n<p>首先比较资源文件的修改时间，判断是否需要更新：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Only update assets if they have been modified, or if this is the      </span></span><br><span class=\"line\"><span class=\"comment\">// first upload of the asset bundle.                                     </span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (content.isModified || (bundleFirstUpload &amp;&amp; archivePath != <span class=\"keyword\">null</span>)) &#123;  </span><br><span class=\"line\">  dirtyEntries[deviceUri] = content;                                     </span><br><span class=\"line\">  syncedBytes += content.size;                                           </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (archivePath != <span class=\"keyword\">null</span> &amp;&amp; !bundleFirstUpload) &#123;                       </span><br><span class=\"line\">    assetPathsToEvict.add(archivePath);                                  </span><br><span class=\"line\">  &#125;                                                                      </span><br><span class=\"line\">&#125;                                                                        </span><br></pre></td></tr></table></figure>\n\n<p>dirtyEntries 用于存放需要更新的内容，syncedBytes 计算需要同步的字节数。</p>\n<p>接着，生成代码增量包，以 .incremental.dill 结尾：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> CompilerOutput compilerOutput = <span class=\"keyword\">await</span> generator.recompile(                                              </span><br><span class=\"line\">  mainPath,                                                                                                   </span><br><span class=\"line\">  invalidatedFiles,                                                                                           </span><br><span class=\"line\">  outputPath:  dillOutputPath ?? getDefaultApplicationKernelPath(trackWidgetCreation: trackWidgetCreation),   </span><br><span class=\"line\">  packagesFilePath : _packagesFilePath,                                                                       </span><br><span class=\"line\">);                                                                                                            </span><br></pre></td></tr></table></figure>\n\n<p>最后通过 http 写入到设备中：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (dirtyEntries.isNotEmpty) &#123;                                                        </span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;                                                                               </span><br><span class=\"line\">    <span class=\"keyword\">await</span> _httpWriter.write(dirtyEntries);                                            </span><br><span class=\"line\">  &#125; <span class=\"keyword\">on</span> SocketException <span class=\"keyword\">catch</span> (socketException, stackTrace) &#123;                          </span><br><span class=\"line\">    printTrace(<span class=\"string\">&#x27;DevFS sync failed. Lost connection to device: <span class=\"subst\">$socketException</span>&#x27;</span>);     </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> DevFSException(<span class=\"string\">&#x27;Lost connection to device.&#x27;</span>, socketException, stackTrace);  </span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (exception, stackTrace) &#123;                                                   </span><br><span class=\"line\">    printError(<span class=\"string\">&#x27;Could not update files on device: <span class=\"subst\">$exception</span>&#x27;</span>);                       </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> DevFSException(<span class=\"string\">&#x27;Sync failed&#x27;</span>, exception, stackTrace);                       </span><br><span class=\"line\">  &#125;                                                                                   </span><br><span class=\"line\">&#125;                                                                                     </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调用 <code>reloadSources()</code> 方法通知 Dart VM 重新加载 Dart 增量包，同样的这里也是调用的 RPC 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt; arguments = &lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&#123;                                      </span><br><span class=\"line\">  <span class=\"string\">&#x27;pause&#x27;</span>: pause,                                                                              </span><br><span class=\"line\">&#125;;                                                                                             </span><br><span class=\"line\"><span class=\"keyword\">if</span> (rootLibUri != <span class=\"keyword\">null</span>) &#123;                                                                      </span><br><span class=\"line\">  arguments[<span class=\"string\">&#x27;rootLibUri&#x27;</span>] = rootLibUri.toString();                                             </span><br><span class=\"line\">&#125;                                                                                              </span><br><span class=\"line\"><span class=\"keyword\">if</span> (packagesUri != <span class=\"keyword\">null</span>) &#123;                                                                     </span><br><span class=\"line\">  arguments[<span class=\"string\">&#x27;packagesUri&#x27;</span>] = packagesUri.toString();                                           </span><br><span class=\"line\">&#125;                                                                                              </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt; response = <span class=\"keyword\">await</span> invokeRpcRaw(<span class=\"string\">&#x27;_reloadSources&#x27;</span>, params: arguments); </span><br><span class=\"line\"><span class=\"keyword\">return</span> response;                                                                               </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>最后调用 <code>flutterReassemble()</code> 方法重新刷新页面，这里调用的是 RPC 方法 <strong>ext.flutter.reassemble</strong>：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Future&lt;<span class=\"built_in\">Map</span>&lt;<span class=\"built_in\">String</span>, <span class=\"built_in\">dynamic</span>&gt;&gt; flutterReassemble() &#123;                </span><br><span class=\"line\">  <span class=\"keyword\">return</span> invokeFlutterExtensionRpcRaw(<span class=\"string\">&#x27;ext.flutter.reassemble&#x27;</span>);  </span><br><span class=\"line\">&#125;                                                                 </span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"关于增量包\"><a href=\"#关于增量包\" class=\"headerlink\" title=\"关于增量包\"></a>关于增量包</h2><p>我们用一个非常简单的 DEMO 来看下生成的增量包的内容。DEMO 有两个 dart 文件，首先是 main.dart，这个是入口文件：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> main() =&gt; runApp(MyApp());          </span><br><span class=\"line\">                                         </span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyApp</span> <span class=\"keyword\">extends</span> <span class=\"title\">StatelessWidget</span> </span>&#123;    </span><br><span class=\"line\">  <span class=\"meta\">@override</span>                              </span><br><span class=\"line\">  Widget build(BuildContext context) &#123;   </span><br><span class=\"line\">    <span class=\"keyword\">return</span> MaterialApp(                  </span><br><span class=\"line\">      title: <span class=\"string\">&#x27;Flutter Demo&#x27;</span>,             </span><br><span class=\"line\">      theme: ThemeData(                  </span><br><span class=\"line\">        primarySwatch: Colors.blue,      </span><br><span class=\"line\">      ),                                 </span><br><span class=\"line\">      home: HomePage(),                  </span><br><span class=\"line\">    );                                   </span><br><span class=\"line\">  &#125;                                      </span><br><span class=\"line\">&#125;                                        </span><br></pre></td></tr></table></figure>\n\n<p>home.dart 也非常简单，就显示一个文本：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HomePage</span> <span class=\"keyword\">extends</span> <span class=\"title\">StatelessWidget</span> </span>&#123;   </span><br><span class=\"line\">  <span class=\"meta\">@override</span>                                </span><br><span class=\"line\">  Widget build(BuildContext context) &#123;     </span><br><span class=\"line\">    <span class=\"keyword\">return</span> Scaffold(                       </span><br><span class=\"line\">      body: Center(                        </span><br><span class=\"line\">        child: Text(<span class=\"string\">&#x27;Hello World&#x27;</span>),        </span><br><span class=\"line\">      ),                                   </span><br><span class=\"line\">      appBar: AppBar(                      </span><br><span class=\"line\">        title: Text(<span class=\"string\">&#x27;My APP&#x27;</span>),             </span><br><span class=\"line\">      ),                                   </span><br><span class=\"line\">    );                                     </span><br><span class=\"line\">  &#125;                                        </span><br><span class=\"line\">&#125;                                          </span><br></pre></td></tr></table></figure>\n\n<p>这里我们做两个地方的修改，首先是将主题颜色从 <code>Colors.blue</code> 改成 <code>Colors.red</code>，将 HomePage 中的 “Hello World” 改成 “Hello Flutter”。</p>\n<p>修改完成后，在终端键入 r 后执行，会在 build 目录下生成 app.dill.incremental.dill，什么是 dill 文件？其实这里面就是我们的代码产物，用于提供给 Dart VM 执行的。我们用 <code>strings</code> 命令查看下内容：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d162fd0eda5b3e?w=804&h=928&f=png&s=941410\" alt=\"incremental.dill\"></p>\n<p>修改的内容已经包含在增量包中了，当我们执行 <code>_updateDevFS()</code> 方法后，incremental.dill 也被同步到设备中了。</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d1633c7395161b?w=758&h=354&f=png&s=46822\" alt=\"app_incremental_dill\"></p>\n<p>名字虽然不一样，但内容一致的。现在设备是已经包含了增量包，接着下来就是通知 Dart VM 刷新了，先调用 <code>reloadSources()</code>，最后调用 <code>flutterReassemble()</code>，执行完之后，我们就可以看到新的界面了。</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/9/9/16d1643f1380ac04?w=608&h=1086&f=png&s=97611\" alt=\"new_ui\"></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>热重载功能的实现，首先是增量包的实现，这里我们没有细讲，留到后面的文章中，生成的增量包，文件后缀以 incremental.dill 结尾，文件的同步则通过 adb 建立的 sockets 连接进行传输，而且这个 sockets 另外一个非常重要的功能就是，建立和 Dart VM 的 RPC 通信，Dart VM 本身就已经定义了一些 RPC 方法，Flutter 又扩展了一些，获取 Dart VM 信息，刷新 Flutter 视图等等都是通过 RPC 实现的。</p>\n<p>因为篇幅的原因，这里我们并没有讲解增量包的生成实现，还有 Dart VM 和 Flutter engine 对 RPC 方法的实现，这个留到后面的文章。</p>\n<p>写到这里，其实距离实现动态更新的目标也越来越清晰，第一，生成增量包；第二，在合适的时候，重新加载刷新增量包。</p>\n"},{"title":"熟悉又陌生的Context","date":"2018-04-12T02:45:36.000Z","_content":"\n## 感谢\n\n[android-context](http://gityuan.com/2017/04/09/android_context/)\n\n## 概述\n\n> 本文中涉及的源码分析都是基于 Android 27\n\nContext 又叫上下文，用于提供应用环境的信息。常用的操作包括启动 Activity、Service，或者通过 `getResources()` 返回 Resources 用于获取应用的资源文件，比如字符串、Drawable 等等。对于这些用法，我们就不去一一列举了，这篇文章的最终目的是，通过对 Context 体系的整体了解，能在平时的应用开发中，正确使用不同类型的 Context。首先我们看下 Context 的类图：\n\n![Context](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/Context.png?x-oss-process=style/doc-img)\n\n其中 ContextImpl 负责 Context 核心功能的实现，而我们常见的 Activity Context，Application Context 等则是继承于 ContextWrapper，从类名可以猜测，这个是 Context 的包装类。实际上也是如此：\n\n``` java\npublic ContextWrapper(Context base) {\n\tmBase = base;\n}\n\n@Override\npublic void startActivity(Intent intent) {\n    mBase.startActivity(intent);\n}\n```\n\n通过在构造函数中将 ContextImpl 实例赋值给 `mBase`，然后在比如 `startActivity` 等方法实现中，将调用转发给 `mBase`，至于 `mBase` 是不是 ContextImpl 实例，这个在后面的源码分析中可以知道。\n\n通过上面的类图，我们可以知道 Application、Service、Activity 都是继承于 ContextWrapper，那么接下来通过简单的源码分析下上述的三个类实例的 Context 初始化过程。\n\n## Context初始化\n\n### Activity\n\n在前面的 [Activity 启动分析](https://linxiaotao.github.io/2018/03/27/Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B-%E5%9F%BA%E4%BA%8EAndroid26/)中，我们知道 Activity 启动方法是 `ActivityThread.performLaunchActivity()`\n\n``` java\nprivate void performLaunchActivity() {\n    // 初始化 LoadedApk\n    if (r.packageInfo == null) {\n    \tr.packageInfo = getPackageInfo();\n    }\n    \n    // 创建 ContextImpl 实例\n    ContextImpl appContext = createBaseContextForActivity(r);\n    Activity activity = null;\n    try {\n        java.lang.ClassLoader cl = appContext.getClassLoader();\n        activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);\n    } catch (Exception e) {\n        \n    }\n    \n    try {\n        Application app = r.packageInfo.makeApplication(false, mInstrumentation);\n        appContext.setOuterContext(activity);\n        activity.attach();\n    } catch (Exception e) {\n        \n    }\n}\n```\n\n首先获取 LoadedApk 实例，接着调用 `createBaseContextForActivity()` 创建 ContextImpl 实例，之前我们提到 ContextWrapper 是将 Context 核心功能转发给 ContextImpl 实现的，而 `ContextWrapper.mBase` 的赋值，在 Activity 启动流程中，是通过调用 `Activity.attach()` 实现，这个我们在后面的分析中可以知道。\n\n#### create \n\n``` java\nprivate ComtextImpl createBaseContextForActivity() {\n    final int displayId;\n    try {\n        displayId = ActivityManager.getService().getActivityDisplayId(r.token);\n    } catch (RemoteException e) {\n        \n    }\n    \n    ContextImpl appContext = ContextImpl.createActivityContext();\n}\n```\n\n``` java\nstatic ContextImpl createActivityContext() {\n    ContextImpl context = new ContextImpl();\n    \n    // Activity Resource\n    final ResourcesManager resourcesManager = ResourcesManager.getInstance();\n    context.setResources(resourcesManager.createBaseActivityResources(activityToken,\n                packageInfo.getResDir(),\n                splitDirs,\n                packageInfo.getOverlayDirs(),\n                packageInfo.getApplicationInfo().sharedLibraryFiles,\n                displayId,\n                overrideConfiguration,\n                compatInfo,\n                classLoader));\n    context.mDisplay = resourcesManager.getAdjustedDisplay(displayId,\n                context.getResources());\n}\n```\n\n#### attach\n\n``` java\nfinal void attach() {\n    attachBaseContext(context);\n}\n```\n\n``` java\nprotected void attachBaseContext() {\n    super.attachBaseContext(newBase);\n}\n```\n\n这个步骤比较简单，最终也是调用 `ContextWrapper.attachBaseContext()`\n\n### Service\n\nService 的创建是在 `ActivityThread.handleCreateService()`\n\n``` java\n// 初始化 LoadedApk\nLoadedApk packageInfo = getPackageInfoNoCheck();\n\nService service = null;\ntry {\n    java.lang.ClassLoader cl = packageInfo.getClassLoader();\n    // 通过反射实例化 Service\n    service = (Service) cl.loadClass(data.info.name).newInstance();\n} catch (Exception e) {\n    \n}\n\ntry {\n    ContextImpl context = ContextImpl.createAppContext(this, packageInfo);\n    context.setOuterContext(service);\n    \n    Application app = packageInfo.makeApplication(false, mInstrumentation);\n    service.attach();\n} catch (Exception e) {\n    \n}\n```\n\nService 的 Context 初始化流程和 Activity 是差不多，相同的 LoadedApk -> ContextImpl -> attach\n\n#### create\n\n``` java\nstatic ContextImpl createAppContext() {\n    ContextImpl context = new ContextImpl();\n    // Service 的 Resources 相对于 Activity 是比较简单的\n    context.setResources(packageInfo.getResources());\n    return context;\n}\n```\n\n#### attach\n\n``` java\npublic final void attach() {\n    attachBaseContext(context);\n}\n```\n\nService 的 attach 和 Activity 相同，都是调用 `ContextWrapper.attachBaseContext()`\n\n### Application\n\nApplication 的创建是在 `LoadedApk.makeApplication()` \n\n``` java\npublic Application makeApplication() {\n    // 保持单例\n    if (mApplication != null) {\n    \treturn mApplication;\n    }\n    Application app = null;\n    String appClass = mApplicationInfo.className;\n    if (forceDefaultAppClass || (appClass == null)) {\n        // 如果强制使用默认 Application，或者没有实现自定义 Application\n    \tappClass = \"android.app.Application\";\n    }\n    try {\n        java.lang.ClassLoader cl = getClassLoader();\n        if (!mPackageName.equals(\"android\")) {\n            // 包名不是 \"android\"，即非系统进程\n        \tinitializeJavaContextClassLoader();\n        }\n        // 创建 ContextImpl 实例\n        ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, this);\n        // 创建 Application 实例\n    \tapp = mActivityThread.mInstrumentation.newApplication(\n                    cl, appClass, appContext);\n    \tappContext.setOuterContext(app);\n    } catch (Exception e) {\n        \n    }\n}\n```\n\n咋一看好像 Application 的流程和其他两个不太相同，其实 Application 的 attach 是在 `Instrumentation.newApplication()`\n\n#### create\n\n``` java\nstatic ContextImpl createAppContext() {\n    ContextImpl context = new ContextImpl();\n    context.setResources(packageInfo.getResources());\n}\n```\n\n#### attach\n\n``` java\npublic static Application newApplication() {\n    // 反射获取实例\n    Application app = (Application)clazz.newInstance();\n    app.attach(context);\n    return app;\n}\n```\n\n``` java\nfinal void attach() {\n    attachBaseContext(context);\n    mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;\n}\n```\n\n### 小结\n\n Activity、Service、Application 的 Context 初始化流程大致是这样，首先创建 ContextImpl 实例，接着调用 `ContextWrapper.attachBaseContext()` 赋值给 `mBase`，ContextImpl 用于实现 Context 的核心功能，而 Context 的继承类则增加差异性功能。\n\n## 实践\n\n通过上面对不同类型的 Context 的初始化分析，我们对 Context 机制有个大概的认识，接下来我们通过对实际场景下的不同 Context 用例进行分析，从而加深对 Context 的理解。\n\n### View Context\n\n#### 问题\n\n我们知道可以通过调用 `View.getContext()` 返回当前 View 使用的 Context 实例，这个实例主要用于获取 View 所要使用的资源信息，那么这个 Context 实例是在什么时候赋值的，使用的是哪种类型的 Context，区别又是什么呢。\n\n#### 分析\n\n首先我们对 View 的 `mContext` 变量赋值进行搜索，可以知道，赋值操作是在其中一个构造函数中，同时其他构造函数都会调用这个构造函数，所以我们可以先从构造函数的调用入手。\n\n如果我们想要动态从 xml 布局中解析得到 View，我们会通过 LayoutInflater 去实现：\n\n``` java\nLayoutInflater layoutInflater = LayoutInflater.from(context);\nView view = layoutInflater.inflate(R.layout.xxx,null);\n```\n\n首先我们看下 `LayoutInflater.from()`：\n\n``` java\npublic static LayoutInflater from(Context context) {\nLayoutInflater LayoutInflater =\t\t  (LayoutInflater)context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);\n    if (LayoutInflater == null) {\n        throw new AssertionError(\"LayoutInflater not found.\");\n    }\n    return LayoutInflater;\n}\n```\n\n在前面，我们提到 Context 的核心方法都转发给 `mBase` 即 ContextImpl 实例，所以看下 ContextImpl 类的实现：\n\n``` java\npublic Object getSystemService(String name) {\n    return SystemServiceRegistry.getSystemService(this, name);\n}\n\npublic static Object getSystemService(ContextImpl ctx, String name) {\n    ServiceFetcher<?> fetcher = SYSTEM_SERVICE_FETCHERS.get(name);\n    return fetcher != null ? fetcher.getService(ctx) : null;\n}\n```\n\n可以看到最终的调用都转发给了 ServiceFetcher，而 `SYSTEM_SERVICE_FETCHERS` 则是存储着各个类型的 Fetcher 的实例\n\n``` java\n// SYSTEM_SERVICE_FETCHERS 是个 Map，存储 Name->Fetcher\nprivate static final HashMap<String, ServiceFetcher<?>> SYSTEM_SERVICE_FETCHERS =\n            new HashMap<String, ServiceFetcher<?>>();\n// 存储 Class->Name\nprivate static final HashMap<Class<?>, String> SYSTEM_SERVICE_NAMES =\n            new HashMap<Class<?>, String>();\n\nprivate static <T> void registerService(String serviceName, Class<T> serviceClass,\n            ServiceFetcher<T> serviceFetcher) {\n    SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);\n    SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);\n}\n```\n\n`SYSTEM_SERVICE_FETCHERS` 存储着 Service 名称和 Fetcher 的映射关系，而这种关系的注册是通过 `registerService()`，这里我们只关心 LayoutInflater 的注册：\n\n``` java\nregisterService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,\n        new CachedServiceFetcher<LayoutInflater>() {                  \n    @Override                                                         \n    public LayoutInflater createService(ContextImpl ctx) {            \n        return new PhoneLayoutInflater(ctx.getOuterContext());        \n    }});                                                              \n```\n\nLayoutInflater 的实现类是 PhoneLayoutInflater，同时 Fetcher 的实现类是 CachedServiceFetcher，PhoneLayoutInflater 只是简单的继承 LayoutInflater，核心代码都在 LayoutInflater，有兴趣的同学可以去看下，所以我们就看下 `CachedServiceFetcher.getService()`\n\n``` java\npublic final T getService(ContextImpl ctx) {\n    final Object[] cache = ctx.mServiceCache;\n    synchronized (cache) {\n        Object service = cache[mCacheIndex];\n        if (service == null) {\n            try {\n                service = createService(ctx);\n                cache[mCacheIndex] = service;\n            } catch (ServiceNotFoundException e) {\n                \n            }\n        }\n        return (T)service;\n    }\n}\n```\n\n注意到，Service 的缓存是存储在 `ContextImpl.mServiceCache` 并且该字段不是静态的，即**Service 的缓存是针对于相同的 Context 实例的**，如果不存在缓存，那么调用 `createService()`，上文我们分析 LayoutInflater Fetcher 时知道会创建 PhoneLayoutInflater 实例：\n\n```java\n// 在 Context 初始化那节我们知道 outerContext 就是具体的 ContextWrapper 实现类的实例，比如 Activity、Service 或者 Application\nreturn new PhoneLayoutInflater(ctx.getOuterContext()); \n```\n\n而 PhoneLayoutInflater 的构造函数也是调用超类的构造函数：\n\n``` java\nprotected LayoutInflater(Context context) {\n    // 这个 mContext 要记住他是具体 ContextWrapper 实现类的实例，比如 Activity 等，这个后面会用到\n    mContext = context;\n}\n```\n\n接下来我们看下 `inflate()` 源码：\n\n``` java\npublic View inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot) {\n    final Resources res = getContext().getResources();\n    final XmlResourceParser parser = res.getLayout(resource);\n    try {\n        return inflate(parser, root, attachToRoot);\n    } finally {\n        parser.close();\n    }\n}\n```\n\n``` java\npublic View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) {\n    synchronized (mConstructorArgs) {\n        // mContext 是具体 ContextWrapper 实现类的实例，上文我们已经提到了\n        final Context inflaterContext = mContext;\n        final AttributeSet attrs = Xml.asAttributeSet(parser);\n    \tContext lastContext = (Context) mConstructorArgs[0];\n        mConstructorArgs[0] = inflaterContext;\n        View result = root;\n        \n        try {\n            // 解析 xml 中的节点\n            \n            final View temp = createViewFromTag(root, name, inflaterContext, attrs);\n        } catch () {\n            \n        } finally {\n            mConstructorArgs[0] = lastContext;\n            mConstructorArgs[1] = null;\n        }\n        \n        return result;\n    }\n}\n    \n```\n\n`inflater()` 就是对 xml 布局进行解析，接着实例化 View，这里我们不去关心它的解析流程，这一块内容可以单独写成一篇文章，我们主要看的是 `createViewFromTag()` 它是根据标签名称去实例化具体的 View 实例\n\n``` java\nView createViewFromTag(View parent, String name, Context context, AttributeSet attrs,\n            boolean ignoreThemeAttr) {\n    if (name.equals(\"view\")) {\n        // 如果我们使用 view 标签则从 class 属性中获取具体类名称\n        name = attrs.getAttributeValue(null, \"class\");\n    }\n    \n    if (!ignoreThemeAttr) {\n        // 默认 ignoreThemeAttr 为 false，即不忽略 theme 属性\n        // 获取设置的 theme 属性值\n        final TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME);\n    \tfinal int themeResId = ta.getResourceId(0, 0);\n        if (themeResId != 0) {\n            // 如果设置了，则将 context 包装成 ContextThemeWrapper\n            // 这意味着 xml 布局中 view 设置的 theme 属性优先级要高于 context 中的 theme 属性\n            context = new ContextThemeWrapper(context, themeResId);\n        }\n        ta.recycle();\n    }\n    \n    try {\n        View view;\n        \n        // Factory 是用于实现兼容功能，比如 TextView 会使用兼容包的 AppCompatTextView\n        if (mFactory2 != null) {\n        \tview = mFactory2.onCreateView(parent, name, context, attrs);\n        } else if (mFactory != null) {\n            view = mFactory.onCreateView(name, context, attrs);\n        } else {\n            view = null;\n        }\n        \n        if (view == null && mPrivateFactory != null) {\n        \tview = mPrivateFactory.onCreateView(parent, name, context, attrs);\n        }\n        \n        if (view == null) {\n            final Object lastContext = mConstructorArgs[0];\n            mConstructorArgs[0] = context;\n            try {\n                if (-1 == name.indexOf('.')) {\n                    // 系统控件\n                    view = onCreateView(parent, name, attrs);\n                } else {\n                    // 自定义控件\n                    view = createView(name, null, attrs);\n                }\n            } finally {\n                mConstructorArgs[0] = lastContext;\n            }\n        }\n        \n        return view;\n    } catch () {\n        \n    }\n}\n```\n\n不管是系统控件或者自定义控件，最终创建 View 实例都会调用到 `createView()`\n\n``` java\npublic final View createView(String name, String prefix, AttributeSet attrs){\n\t// 缓存构造函数\n    Constructor<? extends View> constructor = sConstructorMap.get(name);\n    // 检查构造函数类加载器\n    if (constructor != null && !verifyClassLoader(constructor)){\n        constructor = null;\n        sConstructorMap.remove(name);\n    }\n    Class<? extends View> clazz = null;\n    try {\n        \n        // 获取 View 构造函数实例，并处理过滤情况\n        if (constructor == null) {\n        \tclazz = mContext.getClassLoader().loadClass(\n                        prefix != null ? (prefix + name) : name).asSubclass(View.class);\n        \n            if (mFilter != null && clazz != null) {\n            // 检查是否过滤\n        \tboolean allowed = mFilter.onLoadClass(clazz);\n            if (!allowed) {\n                failNotAllowed(name, prefix, attrs);\n            }\n            }\n            constructor = clazz.getConstructor(mConstructorSignature);\n            constructor.setAccessible(true);\n            sConstructorMap.put(name, constructor);\n        } else {\n            if (mFilter != null) {\n                // 存在过滤器\n                Boolean allowedState = mFilterMap.get(name);\n                if (allowedState == null) {\n                    // 没有缓存过滤结果，新的类\n                    clazz = mContext.getClassLoader().loadClass(                            \n                    prefix != null ? (prefix + name) : name).asSubclass(View.class);\n                \tboolean allowed = clazz != null && mFilter.onLoadClass(clazz);\n                \tmFilterMap.put(name, allowed);\n                    if (!allowed) {\n                    \tfailNotAllowed(name, prefix, attrs);\n                    }\n                } else if (allowedState.equals(Boolean.FALSE)) {\n                    failNotAllowed(name, prefix, attrs);\n                } \n            }\n        }\n        \n        Object lastContext = mConstructorArgs[0];\n        if (mConstructorArgs[0] == null) {\n            // 如果还没设置 context 参数\n            mConstructorArgs[0] = mContext;\n        }\n        Object[] args = mConstructorArgs;\n        args[1] = attrs;\n        // 反射创建 View 实例，这里调用的构造函数类型为 (Context,AttributeSet)，从 args 可知\n        final View view = constructor.newInstance(args); \n        if (view instanceof ViewStub) {\n            // 使用相同的 Context 处理 ViewStub\n            final ViewStub viewStub = (ViewStub) view;\n            viewStub.setLayoutInflater(cloneInContext((Context) args[0]));\n        }\n        mConstructorArgs[0] = lastContext;\n        return view;\n    } catech () {\n        \n    }\n}\n```\n\n最后一个问题，Application Context 和 Activity Context 用在 View Context 中有什么不同的地方，我们先通过一个例子来看下效果：\n\n``` java\nprotected void onCreate(Bundle savedInstanceState) {\n    // 使用两种 Context 创建两个 EditText\n    addEditText(this);                   \n\taddEditText(getApplicationContext());\n}\nprivate void addEditText(@Nullable Context context) { \n                                                      \n    if (mRootLayout == null) {                        \n        return;                                       \n    }                                                 \n                                                      \n    if (context == null) {                            \n        return;                                       \n    }                                                 \n                                                                                                       \n    EditText editText = new EditText(context);        \n    mRootLayout.addView(editText);                    \n    editText.setText(context.toString());                                                               \n}                                                     \n```\n\n代码很简单，使用不同 Context 去创建 EditText 实例，同时我们在 AndroidManifest 中应用了主题\n\n``` xml\n<Applicatin \n  android:theme=\"@style/AppTheme\">\n</Applicatin>\n\n<item name=\"colorAccent\">@color/colorAccent</item>\n<color name=\"colorAccent\">#FF4081</color>\n```\n\n![ActivityContextEditText](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/ActivityContextEditText.png?x-oss-process=style/doc-img)\n\n![ApplicationContextEditText](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/ApplicationContextEditText.png?x-oss-process=style/doc-img)\n\n我们发现使用 Activity Context 的 EditText 使用了 theme 中的配置，回顾我们最开始的 Context 类图，Activity 是继承于 ContextThemeWrapper，而 Application 则是继承于 ContextWrapper，那我们是不是可以猜测只有 ContextThemeWrapper 的继承类才会读取 theme 中配置信息呢？我们可以看下 ContextThemeWrapper 中跟 theme 相关的方法：\n\n``` java\npublic Resources.Theme getTheme() {\n    if (mTheme != null) {\n        return mTheme;\n    }\n    if (mThemeResource == 0) {\n        mThemeResource = R.style.Theme_AppCompat_Light;\n    }\n    initializeTheme();\n    return mTheme;\n}\n\nprivate void initializeTheme() {\n    final boolean first = mTheme == null;\n    if (first) {\n        mTheme = getResources().newTheme();\n        Resources.Theme theme = getBaseContext().getTheme();\n        if (theme != null) {\n            mTheme.setTo(theme);\n        }\n    }\n    onApplyThemeResource(mTheme, mThemeResource, first);\n}\n\nprotected void onApplyThemeResource(Resources.Theme theme, int resid, boolean first) {\n    theme.applyStyle(resid, true);\n}\n```\n\n`mTheme` 和 `mThemeResource` 都可以通过构造方法和 set 方法进行赋值，假设没有给 `mTheme` 赋值，只给 `mThemeResource` 赋值，那么上面的代码将 `mThemeSource` 应用到 `ContextWrapper.getTheme()` 返回的 Theme 实例，从而获取新的 Theme 实例。Activity 的启动流程是在 `ActivityThread.performLaunchActivity()` 中，其中涉及 Theme 的赋值是：\n\n``` java\nint theme = r.activityInfo.getThemeResource();\nif (theme != 0) {\n    activity.setTheme(theme);\n}\n```\n\n现在我们应该知道了为什么有时候控件的样式不跟随主题设置了。\n\n#### 小结\n\n通过上面的源码分析，我们可以知道：\n\n1. 当使用 LayoutInflater 从 xml 文件中 inflate 布局时，调用的是 `View(Context,AttributeSet)` 构造函数，使用的 Context 实例跟 LayoutInflater 创建时使用的 Context 一样，并且 LayoutInflater 会缓存在 Context 实例中，即相同的 Context 实例多次调用会获取一样的 LayoutInflater 实例。\n2. Activity Context 会读取 Theme 的样式信息，而 Application Context 则不会。\n\n### getApplication()和getApplicatinContext()\n\n**接下来的分析参考于 [android-context](http://gityuan.com/2017/04/09/android_context/)**\n\n绝大数情况下，这两个方法的返回值是一样。\n\n`getApplicationContext()` 的存在是 Android 历史原因，`getApplication()` 这个只存在 Activity 和 Service 类中，那么对于 BroadcastReceiver 和 ContentProvider 来说，要获取 Application，就只能通过 `getApplicationContext()`。\n\n两者对比：\n\n1. 对于 Activity/Service 来说，这两个方法没有区别，除非厂商修改过\n2. BroadcastReceiver 只能通过 `getApplicationContext()` 获取 Application 实例\n3. ContentProvider 也只能通过 `getApplicationContext()` 获取 Application 实例，但有可能出现空值的情况。当同个进程有多个 apk 的情况下，对于第二个 apk 是由 provider 方式拉起，而 provider 创建过程中并不会初始化 Application，此时调用 `getApplicationContext()` 则会返回空。\n\n#### 小结\n\n绝大数情况下，`getApplication()` 和 `getApplicationContext()` 返回是一样的，但如果不是特别熟悉，最好对 `getApplicationContext()` 进行空值判断。\n\n### Dialog Context\n\n我们都知道创建 Dialog 实例需要传递 Context 实例，但这里的 Context 必须是 Activity Context，如果传入其他类型的 Context，则会抛出以下异常：\n\n```\nCaused by: android.view.WindowManager$BadTokenException: Unable to add window -- token null is not valid; is your activity running?\n```\n\n### start Activity\n\n通过调用 `startActivity()` 去启动 Activity 是非常常见的操作，并且这个方法存在 Context 类中，即不仅仅是 Activity 可以调用，Application 也可以调用，而 Application 没有重写 `startActivity()` 即实现是委托给 ContextImpl 的。这里有个需要注意的地方：\n\n在 Android 26 上，如果使用 Application 启动 Activity，而没有添加 `Intent.FLAG_ACTIVITY_NEW_TASK` 标记的话，则会抛出以下异常：\n\n```\nCaused by: android.util.AndroidRuntimeException: Calling startActivity() from outside of an Activity  context requires the FLAG_ACTIVITY_NEW_TASK flag. Is this really what you want?\n```\n\nAndroid 26 上 ContextImpl 的相关代码如下：\n\n``` java\npublic void startActivity(Intent intent, Bundle options) {\n    if ((intent.getFlags()&Intent.FLAG_ACTIVITY_NEW_TASK) == 0) {\n        throw new AndroidRuntimeException(\n                    \"Calling startActivity() from outside of an Activity \"\n                    + \" context requires the FLAG_ACTIVITY_NEW_TASK flag.\"\n                    + \" Is this really what you want?\");\n\n    }\n}\n```\n\n只要没有添加 `Intent.FLAG_ACTIVITY_NEW_TASK` 标记就会抛异常。\n\n而在 Android 27 上，则有些区别，同样是 ContextImpl 的源码：\n\n``` java\npublic void startActivity(Intent intent, Bundle options) {\n    if ((intent.getFlags()&Intent.FLAG_ACTIVITY_NEW_TASK) == 0\n        && options != null && ActivityOptions.fromBundle(options).getLaunchTaskId() == -1) {\n        throw new AndroidRuntimeException(\n                    \"Calling startActivity() from outside of an Activity \"\n                    + \" context requires the FLAG_ACTIVITY_NEW_TASK flag.\"\n                    + \" Is this really what you want?\");\n    }\n}\n```\n\n只有在指定了 `options` 同时其中没有指定 LaunchTaskId 才会抛异常。\n\n## 总结\n\n上面我们列举了不同 Context 的初始化过程，比如最常见的 Activity Context 和 Application Context，同时对不同 Context 的使用场景进行比较，相信看完文章的同学，对 Context 有了更多的理解。\n\n不管如何谨慎小心，怀着诚惶诚恐的心态写作，但是毕竟作者的水平有限，如果有写的不对的地方，敬请指教，先行感谢。","source":"_posts/熟悉又陌生的Context.md","raw":"---\ntitle: 熟悉又陌生的Context\ndate: 2018-04-12 10:45:36\ncategories: Android\n---\n\n## 感谢\n\n[android-context](http://gityuan.com/2017/04/09/android_context/)\n\n## 概述\n\n> 本文中涉及的源码分析都是基于 Android 27\n\nContext 又叫上下文，用于提供应用环境的信息。常用的操作包括启动 Activity、Service，或者通过 `getResources()` 返回 Resources 用于获取应用的资源文件，比如字符串、Drawable 等等。对于这些用法，我们就不去一一列举了，这篇文章的最终目的是，通过对 Context 体系的整体了解，能在平时的应用开发中，正确使用不同类型的 Context。首先我们看下 Context 的类图：\n\n![Context](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/Context.png?x-oss-process=style/doc-img)\n\n其中 ContextImpl 负责 Context 核心功能的实现，而我们常见的 Activity Context，Application Context 等则是继承于 ContextWrapper，从类名可以猜测，这个是 Context 的包装类。实际上也是如此：\n\n``` java\npublic ContextWrapper(Context base) {\n\tmBase = base;\n}\n\n@Override\npublic void startActivity(Intent intent) {\n    mBase.startActivity(intent);\n}\n```\n\n通过在构造函数中将 ContextImpl 实例赋值给 `mBase`，然后在比如 `startActivity` 等方法实现中，将调用转发给 `mBase`，至于 `mBase` 是不是 ContextImpl 实例，这个在后面的源码分析中可以知道。\n\n通过上面的类图，我们可以知道 Application、Service、Activity 都是继承于 ContextWrapper，那么接下来通过简单的源码分析下上述的三个类实例的 Context 初始化过程。\n\n## Context初始化\n\n### Activity\n\n在前面的 [Activity 启动分析](https://linxiaotao.github.io/2018/03/27/Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B-%E5%9F%BA%E4%BA%8EAndroid26/)中，我们知道 Activity 启动方法是 `ActivityThread.performLaunchActivity()`\n\n``` java\nprivate void performLaunchActivity() {\n    // 初始化 LoadedApk\n    if (r.packageInfo == null) {\n    \tr.packageInfo = getPackageInfo();\n    }\n    \n    // 创建 ContextImpl 实例\n    ContextImpl appContext = createBaseContextForActivity(r);\n    Activity activity = null;\n    try {\n        java.lang.ClassLoader cl = appContext.getClassLoader();\n        activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);\n    } catch (Exception e) {\n        \n    }\n    \n    try {\n        Application app = r.packageInfo.makeApplication(false, mInstrumentation);\n        appContext.setOuterContext(activity);\n        activity.attach();\n    } catch (Exception e) {\n        \n    }\n}\n```\n\n首先获取 LoadedApk 实例，接着调用 `createBaseContextForActivity()` 创建 ContextImpl 实例，之前我们提到 ContextWrapper 是将 Context 核心功能转发给 ContextImpl 实现的，而 `ContextWrapper.mBase` 的赋值，在 Activity 启动流程中，是通过调用 `Activity.attach()` 实现，这个我们在后面的分析中可以知道。\n\n#### create \n\n``` java\nprivate ComtextImpl createBaseContextForActivity() {\n    final int displayId;\n    try {\n        displayId = ActivityManager.getService().getActivityDisplayId(r.token);\n    } catch (RemoteException e) {\n        \n    }\n    \n    ContextImpl appContext = ContextImpl.createActivityContext();\n}\n```\n\n``` java\nstatic ContextImpl createActivityContext() {\n    ContextImpl context = new ContextImpl();\n    \n    // Activity Resource\n    final ResourcesManager resourcesManager = ResourcesManager.getInstance();\n    context.setResources(resourcesManager.createBaseActivityResources(activityToken,\n                packageInfo.getResDir(),\n                splitDirs,\n                packageInfo.getOverlayDirs(),\n                packageInfo.getApplicationInfo().sharedLibraryFiles,\n                displayId,\n                overrideConfiguration,\n                compatInfo,\n                classLoader));\n    context.mDisplay = resourcesManager.getAdjustedDisplay(displayId,\n                context.getResources());\n}\n```\n\n#### attach\n\n``` java\nfinal void attach() {\n    attachBaseContext(context);\n}\n```\n\n``` java\nprotected void attachBaseContext() {\n    super.attachBaseContext(newBase);\n}\n```\n\n这个步骤比较简单，最终也是调用 `ContextWrapper.attachBaseContext()`\n\n### Service\n\nService 的创建是在 `ActivityThread.handleCreateService()`\n\n``` java\n// 初始化 LoadedApk\nLoadedApk packageInfo = getPackageInfoNoCheck();\n\nService service = null;\ntry {\n    java.lang.ClassLoader cl = packageInfo.getClassLoader();\n    // 通过反射实例化 Service\n    service = (Service) cl.loadClass(data.info.name).newInstance();\n} catch (Exception e) {\n    \n}\n\ntry {\n    ContextImpl context = ContextImpl.createAppContext(this, packageInfo);\n    context.setOuterContext(service);\n    \n    Application app = packageInfo.makeApplication(false, mInstrumentation);\n    service.attach();\n} catch (Exception e) {\n    \n}\n```\n\nService 的 Context 初始化流程和 Activity 是差不多，相同的 LoadedApk -> ContextImpl -> attach\n\n#### create\n\n``` java\nstatic ContextImpl createAppContext() {\n    ContextImpl context = new ContextImpl();\n    // Service 的 Resources 相对于 Activity 是比较简单的\n    context.setResources(packageInfo.getResources());\n    return context;\n}\n```\n\n#### attach\n\n``` java\npublic final void attach() {\n    attachBaseContext(context);\n}\n```\n\nService 的 attach 和 Activity 相同，都是调用 `ContextWrapper.attachBaseContext()`\n\n### Application\n\nApplication 的创建是在 `LoadedApk.makeApplication()` \n\n``` java\npublic Application makeApplication() {\n    // 保持单例\n    if (mApplication != null) {\n    \treturn mApplication;\n    }\n    Application app = null;\n    String appClass = mApplicationInfo.className;\n    if (forceDefaultAppClass || (appClass == null)) {\n        // 如果强制使用默认 Application，或者没有实现自定义 Application\n    \tappClass = \"android.app.Application\";\n    }\n    try {\n        java.lang.ClassLoader cl = getClassLoader();\n        if (!mPackageName.equals(\"android\")) {\n            // 包名不是 \"android\"，即非系统进程\n        \tinitializeJavaContextClassLoader();\n        }\n        // 创建 ContextImpl 实例\n        ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, this);\n        // 创建 Application 实例\n    \tapp = mActivityThread.mInstrumentation.newApplication(\n                    cl, appClass, appContext);\n    \tappContext.setOuterContext(app);\n    } catch (Exception e) {\n        \n    }\n}\n```\n\n咋一看好像 Application 的流程和其他两个不太相同，其实 Application 的 attach 是在 `Instrumentation.newApplication()`\n\n#### create\n\n``` java\nstatic ContextImpl createAppContext() {\n    ContextImpl context = new ContextImpl();\n    context.setResources(packageInfo.getResources());\n}\n```\n\n#### attach\n\n``` java\npublic static Application newApplication() {\n    // 反射获取实例\n    Application app = (Application)clazz.newInstance();\n    app.attach(context);\n    return app;\n}\n```\n\n``` java\nfinal void attach() {\n    attachBaseContext(context);\n    mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;\n}\n```\n\n### 小结\n\n Activity、Service、Application 的 Context 初始化流程大致是这样，首先创建 ContextImpl 实例，接着调用 `ContextWrapper.attachBaseContext()` 赋值给 `mBase`，ContextImpl 用于实现 Context 的核心功能，而 Context 的继承类则增加差异性功能。\n\n## 实践\n\n通过上面对不同类型的 Context 的初始化分析，我们对 Context 机制有个大概的认识，接下来我们通过对实际场景下的不同 Context 用例进行分析，从而加深对 Context 的理解。\n\n### View Context\n\n#### 问题\n\n我们知道可以通过调用 `View.getContext()` 返回当前 View 使用的 Context 实例，这个实例主要用于获取 View 所要使用的资源信息，那么这个 Context 实例是在什么时候赋值的，使用的是哪种类型的 Context，区别又是什么呢。\n\n#### 分析\n\n首先我们对 View 的 `mContext` 变量赋值进行搜索，可以知道，赋值操作是在其中一个构造函数中，同时其他构造函数都会调用这个构造函数，所以我们可以先从构造函数的调用入手。\n\n如果我们想要动态从 xml 布局中解析得到 View，我们会通过 LayoutInflater 去实现：\n\n``` java\nLayoutInflater layoutInflater = LayoutInflater.from(context);\nView view = layoutInflater.inflate(R.layout.xxx,null);\n```\n\n首先我们看下 `LayoutInflater.from()`：\n\n``` java\npublic static LayoutInflater from(Context context) {\nLayoutInflater LayoutInflater =\t\t  (LayoutInflater)context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);\n    if (LayoutInflater == null) {\n        throw new AssertionError(\"LayoutInflater not found.\");\n    }\n    return LayoutInflater;\n}\n```\n\n在前面，我们提到 Context 的核心方法都转发给 `mBase` 即 ContextImpl 实例，所以看下 ContextImpl 类的实现：\n\n``` java\npublic Object getSystemService(String name) {\n    return SystemServiceRegistry.getSystemService(this, name);\n}\n\npublic static Object getSystemService(ContextImpl ctx, String name) {\n    ServiceFetcher<?> fetcher = SYSTEM_SERVICE_FETCHERS.get(name);\n    return fetcher != null ? fetcher.getService(ctx) : null;\n}\n```\n\n可以看到最终的调用都转发给了 ServiceFetcher，而 `SYSTEM_SERVICE_FETCHERS` 则是存储着各个类型的 Fetcher 的实例\n\n``` java\n// SYSTEM_SERVICE_FETCHERS 是个 Map，存储 Name->Fetcher\nprivate static final HashMap<String, ServiceFetcher<?>> SYSTEM_SERVICE_FETCHERS =\n            new HashMap<String, ServiceFetcher<?>>();\n// 存储 Class->Name\nprivate static final HashMap<Class<?>, String> SYSTEM_SERVICE_NAMES =\n            new HashMap<Class<?>, String>();\n\nprivate static <T> void registerService(String serviceName, Class<T> serviceClass,\n            ServiceFetcher<T> serviceFetcher) {\n    SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);\n    SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);\n}\n```\n\n`SYSTEM_SERVICE_FETCHERS` 存储着 Service 名称和 Fetcher 的映射关系，而这种关系的注册是通过 `registerService()`，这里我们只关心 LayoutInflater 的注册：\n\n``` java\nregisterService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,\n        new CachedServiceFetcher<LayoutInflater>() {                  \n    @Override                                                         \n    public LayoutInflater createService(ContextImpl ctx) {            \n        return new PhoneLayoutInflater(ctx.getOuterContext());        \n    }});                                                              \n```\n\nLayoutInflater 的实现类是 PhoneLayoutInflater，同时 Fetcher 的实现类是 CachedServiceFetcher，PhoneLayoutInflater 只是简单的继承 LayoutInflater，核心代码都在 LayoutInflater，有兴趣的同学可以去看下，所以我们就看下 `CachedServiceFetcher.getService()`\n\n``` java\npublic final T getService(ContextImpl ctx) {\n    final Object[] cache = ctx.mServiceCache;\n    synchronized (cache) {\n        Object service = cache[mCacheIndex];\n        if (service == null) {\n            try {\n                service = createService(ctx);\n                cache[mCacheIndex] = service;\n            } catch (ServiceNotFoundException e) {\n                \n            }\n        }\n        return (T)service;\n    }\n}\n```\n\n注意到，Service 的缓存是存储在 `ContextImpl.mServiceCache` 并且该字段不是静态的，即**Service 的缓存是针对于相同的 Context 实例的**，如果不存在缓存，那么调用 `createService()`，上文我们分析 LayoutInflater Fetcher 时知道会创建 PhoneLayoutInflater 实例：\n\n```java\n// 在 Context 初始化那节我们知道 outerContext 就是具体的 ContextWrapper 实现类的实例，比如 Activity、Service 或者 Application\nreturn new PhoneLayoutInflater(ctx.getOuterContext()); \n```\n\n而 PhoneLayoutInflater 的构造函数也是调用超类的构造函数：\n\n``` java\nprotected LayoutInflater(Context context) {\n    // 这个 mContext 要记住他是具体 ContextWrapper 实现类的实例，比如 Activity 等，这个后面会用到\n    mContext = context;\n}\n```\n\n接下来我们看下 `inflate()` 源码：\n\n``` java\npublic View inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot) {\n    final Resources res = getContext().getResources();\n    final XmlResourceParser parser = res.getLayout(resource);\n    try {\n        return inflate(parser, root, attachToRoot);\n    } finally {\n        parser.close();\n    }\n}\n```\n\n``` java\npublic View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) {\n    synchronized (mConstructorArgs) {\n        // mContext 是具体 ContextWrapper 实现类的实例，上文我们已经提到了\n        final Context inflaterContext = mContext;\n        final AttributeSet attrs = Xml.asAttributeSet(parser);\n    \tContext lastContext = (Context) mConstructorArgs[0];\n        mConstructorArgs[0] = inflaterContext;\n        View result = root;\n        \n        try {\n            // 解析 xml 中的节点\n            \n            final View temp = createViewFromTag(root, name, inflaterContext, attrs);\n        } catch () {\n            \n        } finally {\n            mConstructorArgs[0] = lastContext;\n            mConstructorArgs[1] = null;\n        }\n        \n        return result;\n    }\n}\n    \n```\n\n`inflater()` 就是对 xml 布局进行解析，接着实例化 View，这里我们不去关心它的解析流程，这一块内容可以单独写成一篇文章，我们主要看的是 `createViewFromTag()` 它是根据标签名称去实例化具体的 View 实例\n\n``` java\nView createViewFromTag(View parent, String name, Context context, AttributeSet attrs,\n            boolean ignoreThemeAttr) {\n    if (name.equals(\"view\")) {\n        // 如果我们使用 view 标签则从 class 属性中获取具体类名称\n        name = attrs.getAttributeValue(null, \"class\");\n    }\n    \n    if (!ignoreThemeAttr) {\n        // 默认 ignoreThemeAttr 为 false，即不忽略 theme 属性\n        // 获取设置的 theme 属性值\n        final TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME);\n    \tfinal int themeResId = ta.getResourceId(0, 0);\n        if (themeResId != 0) {\n            // 如果设置了，则将 context 包装成 ContextThemeWrapper\n            // 这意味着 xml 布局中 view 设置的 theme 属性优先级要高于 context 中的 theme 属性\n            context = new ContextThemeWrapper(context, themeResId);\n        }\n        ta.recycle();\n    }\n    \n    try {\n        View view;\n        \n        // Factory 是用于实现兼容功能，比如 TextView 会使用兼容包的 AppCompatTextView\n        if (mFactory2 != null) {\n        \tview = mFactory2.onCreateView(parent, name, context, attrs);\n        } else if (mFactory != null) {\n            view = mFactory.onCreateView(name, context, attrs);\n        } else {\n            view = null;\n        }\n        \n        if (view == null && mPrivateFactory != null) {\n        \tview = mPrivateFactory.onCreateView(parent, name, context, attrs);\n        }\n        \n        if (view == null) {\n            final Object lastContext = mConstructorArgs[0];\n            mConstructorArgs[0] = context;\n            try {\n                if (-1 == name.indexOf('.')) {\n                    // 系统控件\n                    view = onCreateView(parent, name, attrs);\n                } else {\n                    // 自定义控件\n                    view = createView(name, null, attrs);\n                }\n            } finally {\n                mConstructorArgs[0] = lastContext;\n            }\n        }\n        \n        return view;\n    } catch () {\n        \n    }\n}\n```\n\n不管是系统控件或者自定义控件，最终创建 View 实例都会调用到 `createView()`\n\n``` java\npublic final View createView(String name, String prefix, AttributeSet attrs){\n\t// 缓存构造函数\n    Constructor<? extends View> constructor = sConstructorMap.get(name);\n    // 检查构造函数类加载器\n    if (constructor != null && !verifyClassLoader(constructor)){\n        constructor = null;\n        sConstructorMap.remove(name);\n    }\n    Class<? extends View> clazz = null;\n    try {\n        \n        // 获取 View 构造函数实例，并处理过滤情况\n        if (constructor == null) {\n        \tclazz = mContext.getClassLoader().loadClass(\n                        prefix != null ? (prefix + name) : name).asSubclass(View.class);\n        \n            if (mFilter != null && clazz != null) {\n            // 检查是否过滤\n        \tboolean allowed = mFilter.onLoadClass(clazz);\n            if (!allowed) {\n                failNotAllowed(name, prefix, attrs);\n            }\n            }\n            constructor = clazz.getConstructor(mConstructorSignature);\n            constructor.setAccessible(true);\n            sConstructorMap.put(name, constructor);\n        } else {\n            if (mFilter != null) {\n                // 存在过滤器\n                Boolean allowedState = mFilterMap.get(name);\n                if (allowedState == null) {\n                    // 没有缓存过滤结果，新的类\n                    clazz = mContext.getClassLoader().loadClass(                            \n                    prefix != null ? (prefix + name) : name).asSubclass(View.class);\n                \tboolean allowed = clazz != null && mFilter.onLoadClass(clazz);\n                \tmFilterMap.put(name, allowed);\n                    if (!allowed) {\n                    \tfailNotAllowed(name, prefix, attrs);\n                    }\n                } else if (allowedState.equals(Boolean.FALSE)) {\n                    failNotAllowed(name, prefix, attrs);\n                } \n            }\n        }\n        \n        Object lastContext = mConstructorArgs[0];\n        if (mConstructorArgs[0] == null) {\n            // 如果还没设置 context 参数\n            mConstructorArgs[0] = mContext;\n        }\n        Object[] args = mConstructorArgs;\n        args[1] = attrs;\n        // 反射创建 View 实例，这里调用的构造函数类型为 (Context,AttributeSet)，从 args 可知\n        final View view = constructor.newInstance(args); \n        if (view instanceof ViewStub) {\n            // 使用相同的 Context 处理 ViewStub\n            final ViewStub viewStub = (ViewStub) view;\n            viewStub.setLayoutInflater(cloneInContext((Context) args[0]));\n        }\n        mConstructorArgs[0] = lastContext;\n        return view;\n    } catech () {\n        \n    }\n}\n```\n\n最后一个问题，Application Context 和 Activity Context 用在 View Context 中有什么不同的地方，我们先通过一个例子来看下效果：\n\n``` java\nprotected void onCreate(Bundle savedInstanceState) {\n    // 使用两种 Context 创建两个 EditText\n    addEditText(this);                   \n\taddEditText(getApplicationContext());\n}\nprivate void addEditText(@Nullable Context context) { \n                                                      \n    if (mRootLayout == null) {                        \n        return;                                       \n    }                                                 \n                                                      \n    if (context == null) {                            \n        return;                                       \n    }                                                 \n                                                                                                       \n    EditText editText = new EditText(context);        \n    mRootLayout.addView(editText);                    \n    editText.setText(context.toString());                                                               \n}                                                     \n```\n\n代码很简单，使用不同 Context 去创建 EditText 实例，同时我们在 AndroidManifest 中应用了主题\n\n``` xml\n<Applicatin \n  android:theme=\"@style/AppTheme\">\n</Applicatin>\n\n<item name=\"colorAccent\">@color/colorAccent</item>\n<color name=\"colorAccent\">#FF4081</color>\n```\n\n![ActivityContextEditText](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/ActivityContextEditText.png?x-oss-process=style/doc-img)\n\n![ApplicationContextEditText](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/ApplicationContextEditText.png?x-oss-process=style/doc-img)\n\n我们发现使用 Activity Context 的 EditText 使用了 theme 中的配置，回顾我们最开始的 Context 类图，Activity 是继承于 ContextThemeWrapper，而 Application 则是继承于 ContextWrapper，那我们是不是可以猜测只有 ContextThemeWrapper 的继承类才会读取 theme 中配置信息呢？我们可以看下 ContextThemeWrapper 中跟 theme 相关的方法：\n\n``` java\npublic Resources.Theme getTheme() {\n    if (mTheme != null) {\n        return mTheme;\n    }\n    if (mThemeResource == 0) {\n        mThemeResource = R.style.Theme_AppCompat_Light;\n    }\n    initializeTheme();\n    return mTheme;\n}\n\nprivate void initializeTheme() {\n    final boolean first = mTheme == null;\n    if (first) {\n        mTheme = getResources().newTheme();\n        Resources.Theme theme = getBaseContext().getTheme();\n        if (theme != null) {\n            mTheme.setTo(theme);\n        }\n    }\n    onApplyThemeResource(mTheme, mThemeResource, first);\n}\n\nprotected void onApplyThemeResource(Resources.Theme theme, int resid, boolean first) {\n    theme.applyStyle(resid, true);\n}\n```\n\n`mTheme` 和 `mThemeResource` 都可以通过构造方法和 set 方法进行赋值，假设没有给 `mTheme` 赋值，只给 `mThemeResource` 赋值，那么上面的代码将 `mThemeSource` 应用到 `ContextWrapper.getTheme()` 返回的 Theme 实例，从而获取新的 Theme 实例。Activity 的启动流程是在 `ActivityThread.performLaunchActivity()` 中，其中涉及 Theme 的赋值是：\n\n``` java\nint theme = r.activityInfo.getThemeResource();\nif (theme != 0) {\n    activity.setTheme(theme);\n}\n```\n\n现在我们应该知道了为什么有时候控件的样式不跟随主题设置了。\n\n#### 小结\n\n通过上面的源码分析，我们可以知道：\n\n1. 当使用 LayoutInflater 从 xml 文件中 inflate 布局时，调用的是 `View(Context,AttributeSet)` 构造函数，使用的 Context 实例跟 LayoutInflater 创建时使用的 Context 一样，并且 LayoutInflater 会缓存在 Context 实例中，即相同的 Context 实例多次调用会获取一样的 LayoutInflater 实例。\n2. Activity Context 会读取 Theme 的样式信息，而 Application Context 则不会。\n\n### getApplication()和getApplicatinContext()\n\n**接下来的分析参考于 [android-context](http://gityuan.com/2017/04/09/android_context/)**\n\n绝大数情况下，这两个方法的返回值是一样。\n\n`getApplicationContext()` 的存在是 Android 历史原因，`getApplication()` 这个只存在 Activity 和 Service 类中，那么对于 BroadcastReceiver 和 ContentProvider 来说，要获取 Application，就只能通过 `getApplicationContext()`。\n\n两者对比：\n\n1. 对于 Activity/Service 来说，这两个方法没有区别，除非厂商修改过\n2. BroadcastReceiver 只能通过 `getApplicationContext()` 获取 Application 实例\n3. ContentProvider 也只能通过 `getApplicationContext()` 获取 Application 实例，但有可能出现空值的情况。当同个进程有多个 apk 的情况下，对于第二个 apk 是由 provider 方式拉起，而 provider 创建过程中并不会初始化 Application，此时调用 `getApplicationContext()` 则会返回空。\n\n#### 小结\n\n绝大数情况下，`getApplication()` 和 `getApplicationContext()` 返回是一样的，但如果不是特别熟悉，最好对 `getApplicationContext()` 进行空值判断。\n\n### Dialog Context\n\n我们都知道创建 Dialog 实例需要传递 Context 实例，但这里的 Context 必须是 Activity Context，如果传入其他类型的 Context，则会抛出以下异常：\n\n```\nCaused by: android.view.WindowManager$BadTokenException: Unable to add window -- token null is not valid; is your activity running?\n```\n\n### start Activity\n\n通过调用 `startActivity()` 去启动 Activity 是非常常见的操作，并且这个方法存在 Context 类中，即不仅仅是 Activity 可以调用，Application 也可以调用，而 Application 没有重写 `startActivity()` 即实现是委托给 ContextImpl 的。这里有个需要注意的地方：\n\n在 Android 26 上，如果使用 Application 启动 Activity，而没有添加 `Intent.FLAG_ACTIVITY_NEW_TASK` 标记的话，则会抛出以下异常：\n\n```\nCaused by: android.util.AndroidRuntimeException: Calling startActivity() from outside of an Activity  context requires the FLAG_ACTIVITY_NEW_TASK flag. Is this really what you want?\n```\n\nAndroid 26 上 ContextImpl 的相关代码如下：\n\n``` java\npublic void startActivity(Intent intent, Bundle options) {\n    if ((intent.getFlags()&Intent.FLAG_ACTIVITY_NEW_TASK) == 0) {\n        throw new AndroidRuntimeException(\n                    \"Calling startActivity() from outside of an Activity \"\n                    + \" context requires the FLAG_ACTIVITY_NEW_TASK flag.\"\n                    + \" Is this really what you want?\");\n\n    }\n}\n```\n\n只要没有添加 `Intent.FLAG_ACTIVITY_NEW_TASK` 标记就会抛异常。\n\n而在 Android 27 上，则有些区别，同样是 ContextImpl 的源码：\n\n``` java\npublic void startActivity(Intent intent, Bundle options) {\n    if ((intent.getFlags()&Intent.FLAG_ACTIVITY_NEW_TASK) == 0\n        && options != null && ActivityOptions.fromBundle(options).getLaunchTaskId() == -1) {\n        throw new AndroidRuntimeException(\n                    \"Calling startActivity() from outside of an Activity \"\n                    + \" context requires the FLAG_ACTIVITY_NEW_TASK flag.\"\n                    + \" Is this really what you want?\");\n    }\n}\n```\n\n只有在指定了 `options` 同时其中没有指定 LaunchTaskId 才会抛异常。\n\n## 总结\n\n上面我们列举了不同 Context 的初始化过程，比如最常见的 Activity Context 和 Application Context，同时对不同 Context 的使用场景进行比较，相信看完文章的同学，对 Context 有了更多的理解。\n\n不管如何谨慎小心，怀着诚惶诚恐的心态写作，但是毕竟作者的水平有限，如果有写的不对的地方，敬请指教，先行感谢。","slug":"熟悉又陌生的Context","published":1,"updated":"2022-06-15T11:19:32.327Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrly000xfho63e4od1zl","content":"<h2 id=\"感谢\"><a href=\"#感谢\" class=\"headerlink\" title=\"感谢\"></a>感谢</h2><p><a href=\"http://gityuan.com/2017/04/09/android_context/\">android-context</a></p>\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><blockquote>\n<p>本文中涉及的源码分析都是基于 Android 27</p>\n</blockquote>\n<p>Context 又叫上下文，用于提供应用环境的信息。常用的操作包括启动 Activity、Service，或者通过 <code>getResources()</code> 返回 Resources 用于获取应用的资源文件，比如字符串、Drawable 等等。对于这些用法，我们就不去一一列举了，这篇文章的最终目的是，通过对 Context 体系的整体了解，能在平时的应用开发中，正确使用不同类型的 Context。首先我们看下 Context 的类图：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/Context.png?x-oss-process=style/doc-img\" alt=\"Context\"></p>\n<p>其中 ContextImpl 负责 Context 核心功能的实现，而我们常见的 Activity Context，Application Context 等则是继承于 ContextWrapper，从类名可以猜测，这个是 Context 的包装类。实际上也是如此：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ContextWrapper</span><span class=\"params\">(Context base)</span> &#123;</span><br><span class=\"line\">\tmBase = base;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivity</span><span class=\"params\">(Intent intent)</span> &#123;</span><br><span class=\"line\">    mBase.startActivity(intent);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>通过在构造函数中将 ContextImpl 实例赋值给 <code>mBase</code>，然后在比如 <code>startActivity</code> 等方法实现中，将调用转发给 <code>mBase</code>，至于 <code>mBase</code> 是不是 ContextImpl 实例，这个在后面的源码分析中可以知道。</p>\n<p>通过上面的类图，我们可以知道 Application、Service、Activity 都是继承于 ContextWrapper，那么接下来通过简单的源码分析下上述的三个类实例的 Context 初始化过程。</p>\n<h2 id=\"Context初始化\"><a href=\"#Context初始化\" class=\"headerlink\" title=\"Context初始化\"></a>Context初始化</h2><h3 id=\"Activity\"><a href=\"#Activity\" class=\"headerlink\" title=\"Activity\"></a>Activity</h3><p>在前面的 <a href=\"https://linxiaotao.github.io/2018/03/27/Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B-%E5%9F%BA%E4%BA%8EAndroid26/\">Activity 启动分析</a>中，我们知道 Activity 启动方法是 <code>ActivityThread.performLaunchActivity()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performLaunchActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 初始化 LoadedApk</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (r.packageInfo == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \tr.packageInfo = getPackageInfo();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 创建 ContextImpl 实例</span></span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">appContext</span> <span class=\"operator\">=</span> createBaseContextForActivity(r);</span><br><span class=\"line\">    <span class=\"type\">Activity</span> <span class=\"variable\">activity</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        java.lang.<span class=\"type\">ClassLoader</span> <span class=\"variable\">cl</span> <span class=\"operator\">=</span> appContext.getClassLoader();</span><br><span class=\"line\">        activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> r.packageInfo.makeApplication(<span class=\"literal\">false</span>, mInstrumentation);</span><br><span class=\"line\">        appContext.setOuterContext(activity);</span><br><span class=\"line\">        activity.attach();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先获取 LoadedApk 实例，接着调用 <code>createBaseContextForActivity()</code> 创建 ContextImpl 实例，之前我们提到 ContextWrapper 是将 Context 核心功能转发给 ContextImpl 实现的，而 <code>ContextWrapper.mBase</code> 的赋值，在 Activity 启动流程中，是通过调用 <code>Activity.attach()</code> 实现，这个我们在后面的分析中可以知道。</p>\n<h4 id=\"create\"><a href=\"#create\" class=\"headerlink\" title=\"create\"></a>create</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> ComtextImpl <span class=\"title function_\">createBaseContextForActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">int</span> displayId;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        displayId = ActivityManager.getService().getActivityDisplayId(r.token);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (RemoteException e) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">appContext</span> <span class=\"operator\">=</span> ContextImpl.createActivityContext();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> ContextImpl <span class=\"title function_\">createActivityContext</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ContextImpl</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// Activity Resource</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ResourcesManager</span> <span class=\"variable\">resourcesManager</span> <span class=\"operator\">=</span> ResourcesManager.getInstance();</span><br><span class=\"line\">    context.setResources(resourcesManager.createBaseActivityResources(activityToken,</span><br><span class=\"line\">                packageInfo.getResDir(),</span><br><span class=\"line\">                splitDirs,</span><br><span class=\"line\">                packageInfo.getOverlayDirs(),</span><br><span class=\"line\">                packageInfo.getApplicationInfo().sharedLibraryFiles,</span><br><span class=\"line\">                displayId,</span><br><span class=\"line\">                overrideConfiguration,</span><br><span class=\"line\">                compatInfo,</span><br><span class=\"line\">                classLoader));</span><br><span class=\"line\">    context.mDisplay = resourcesManager.getAdjustedDisplay(displayId,</span><br><span class=\"line\">                context.getResources());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"attach\"><a href=\"#attach\" class=\"headerlink\" title=\"attach\"></a>attach</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">attach</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    attachBaseContext(context);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">attachBaseContext</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">super</span>.attachBaseContext(newBase);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这个步骤比较简单，最终也是调用 <code>ContextWrapper.attachBaseContext()</code></p>\n<h3 id=\"Service\"><a href=\"#Service\" class=\"headerlink\" title=\"Service\"></a>Service</h3><p>Service 的创建是在 <code>ActivityThread.handleCreateService()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 初始化 LoadedApk</span></span><br><span class=\"line\"><span class=\"type\">LoadedApk</span> <span class=\"variable\">packageInfo</span> <span class=\"operator\">=</span> getPackageInfoNoCheck();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">Service</span> <span class=\"variable\">service</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    java.lang.<span class=\"type\">ClassLoader</span> <span class=\"variable\">cl</span> <span class=\"operator\">=</span> packageInfo.getClassLoader();</span><br><span class=\"line\">    <span class=\"comment\">// 通过反射实例化 Service</span></span><br><span class=\"line\">    service = (Service) cl.loadClass(data.info.name).newInstance();</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> ContextImpl.createAppContext(<span class=\"built_in\">this</span>, packageInfo);</span><br><span class=\"line\">    context.setOuterContext(service);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> packageInfo.makeApplication(<span class=\"literal\">false</span>, mInstrumentation);</span><br><span class=\"line\">    service.attach();</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Service 的 Context 初始化流程和 Activity 是差不多，相同的 LoadedApk -&gt; ContextImpl -&gt; attach</p>\n<h4 id=\"create-1\"><a href=\"#create-1\" class=\"headerlink\" title=\"create\"></a>create</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> ContextImpl <span class=\"title function_\">createAppContext</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ContextImpl</span>();</span><br><span class=\"line\">    <span class=\"comment\">// Service 的 Resources 相对于 Activity 是比较简单的</span></span><br><span class=\"line\">    context.setResources(packageInfo.getResources());</span><br><span class=\"line\">    <span class=\"keyword\">return</span> context;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"attach-1\"><a href=\"#attach-1\" class=\"headerlink\" title=\"attach\"></a>attach</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">attach</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    attachBaseContext(context);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Service 的 attach 和 Activity 相同，都是调用 <code>ContextWrapper.attachBaseContext()</code></p>\n<h3 id=\"Application\"><a href=\"#Application\" class=\"headerlink\" title=\"Application\"></a>Application</h3><p>Application 的创建是在 <code>LoadedApk.makeApplication()</code> </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> Application <span class=\"title function_\">makeApplication</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 保持单例</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mApplication != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> mApplication;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">appClass</span> <span class=\"operator\">=</span> mApplicationInfo.className;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (forceDefaultAppClass || (appClass == <span class=\"literal\">null</span>)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果强制使用默认 Application，或者没有实现自定义 Application</span></span><br><span class=\"line\">    \tappClass = <span class=\"string\">&quot;android.app.Application&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        java.lang.<span class=\"type\">ClassLoader</span> <span class=\"variable\">cl</span> <span class=\"operator\">=</span> getClassLoader();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mPackageName.equals(<span class=\"string\">&quot;android&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 包名不是 &quot;android&quot;，即非系统进程</span></span><br><span class=\"line\">        \tinitializeJavaContextClassLoader();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 ContextImpl 实例</span></span><br><span class=\"line\">        <span class=\"type\">ContextImpl</span> <span class=\"variable\">appContext</span> <span class=\"operator\">=</span> ContextImpl.createAppContext(mActivityThread, <span class=\"built_in\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 创建 Application 实例</span></span><br><span class=\"line\">    \tapp = mActivityThread.mInstrumentation.newApplication(</span><br><span class=\"line\">                    cl, appClass, appContext);</span><br><span class=\"line\">    \tappContext.setOuterContext(app);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>咋一看好像 Application 的流程和其他两个不太相同，其实 Application 的 attach 是在 <code>Instrumentation.newApplication()</code></p>\n<h4 id=\"create-2\"><a href=\"#create-2\" class=\"headerlink\" title=\"create\"></a>create</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> ContextImpl <span class=\"title function_\">createAppContext</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ContextImpl</span>();</span><br><span class=\"line\">    context.setResources(packageInfo.getResources());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"attach-2\"><a href=\"#attach-2\" class=\"headerlink\" title=\"attach\"></a>attach</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Application <span class=\"title function_\">newApplication</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 反射获取实例</span></span><br><span class=\"line\">    <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> (Application)clazz.newInstance();</span><br><span class=\"line\">    app.attach(context);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> app;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">attach</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    attachBaseContext(context);</span><br><span class=\"line\">    mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h3><p> Activity、Service、Application 的 Context 初始化流程大致是这样，首先创建 ContextImpl 实例，接着调用 <code>ContextWrapper.attachBaseContext()</code> 赋值给 <code>mBase</code>，ContextImpl 用于实现 Context 的核心功能，而 Context 的继承类则增加差异性功能。</p>\n<h2 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h2><p>通过上面对不同类型的 Context 的初始化分析，我们对 Context 机制有个大概的认识，接下来我们通过对实际场景下的不同 Context 用例进行分析，从而加深对 Context 的理解。</p>\n<h3 id=\"View-Context\"><a href=\"#View-Context\" class=\"headerlink\" title=\"View Context\"></a>View Context</h3><h4 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h4><p>我们知道可以通过调用 <code>View.getContext()</code> 返回当前 View 使用的 Context 实例，这个实例主要用于获取 View 所要使用的资源信息，那么这个 Context 实例是在什么时候赋值的，使用的是哪种类型的 Context，区别又是什么呢。</p>\n<h4 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h4><p>首先我们对 View 的 <code>mContext</code> 变量赋值进行搜索，可以知道，赋值操作是在其中一个构造函数中，同时其他构造函数都会调用这个构造函数，所以我们可以先从构造函数的调用入手。</p>\n<p>如果我们想要动态从 xml 布局中解析得到 View，我们会通过 LayoutInflater 去实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">LayoutInflater</span> <span class=\"variable\">layoutInflater</span> <span class=\"operator\">=</span> LayoutInflater.from(context);</span><br><span class=\"line\"><span class=\"type\">View</span> <span class=\"variable\">view</span> <span class=\"operator\">=</span> layoutInflater.inflate(R.layout.xxx,<span class=\"literal\">null</span>);</span><br></pre></td></tr></table></figure>\n\n<p>首先我们看下 <code>LayoutInflater.from()</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> LayoutInflater <span class=\"title function_\">from</span><span class=\"params\">(Context context)</span> &#123;</span><br><span class=\"line\"><span class=\"type\">LayoutInflater</span> <span class=\"variable\">LayoutInflater</span> <span class=\"operator\">=</span>\t\t  (LayoutInflater)context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (LayoutInflater == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">AssertionError</span>(<span class=\"string\">&quot;LayoutInflater not found.&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> LayoutInflater;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在前面，我们提到 Context 的核心方法都转发给 <code>mBase</code> 即 ContextImpl 实例，所以看下 ContextImpl 类的实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> Object <span class=\"title function_\">getSystemService</span><span class=\"params\">(String name)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> SystemServiceRegistry.getSystemService(<span class=\"built_in\">this</span>, name);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Object <span class=\"title function_\">getSystemService</span><span class=\"params\">(ContextImpl ctx, String name)</span> &#123;</span><br><span class=\"line\">    ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> fetcher != <span class=\"literal\">null</span> ? fetcher.getService(ctx) : <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以看到最终的调用都转发给了 ServiceFetcher，而 <code>SYSTEM_SERVICE_FETCHERS</code> 则是存储着各个类型的 Fetcher 的实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// SYSTEM_SERVICE_FETCHERS 是个 Map，存储 Name-&gt;Fetcher</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt; SYSTEM_SERVICE_FETCHERS =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;String, ServiceFetcher&lt;?&gt;&gt;();</span><br><span class=\"line\"><span class=\"comment\">// 存储 Class-&gt;Name</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> HashMap&lt;Class&lt;?&gt;, String&gt; SYSTEM_SERVICE_NAMES =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;Class&lt;?&gt;, String&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> &lt;T&gt; <span class=\"keyword\">void</span> <span class=\"title function_\">registerService</span><span class=\"params\">(String serviceName, Class&lt;T&gt; serviceClass,</span></span><br><span class=\"line\"><span class=\"params\">            ServiceFetcher&lt;T&gt; serviceFetcher)</span> &#123;</span><br><span class=\"line\">    SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);</span><br><span class=\"line\">    SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>SYSTEM_SERVICE_FETCHERS</code> 存储着 Service 名称和 Fetcher 的映射关系，而这种关系的注册是通过 <code>registerService()</code>，这里我们只关心 LayoutInflater 的注册：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">registerService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,</span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">CachedServiceFetcher</span>&lt;LayoutInflater&gt;() &#123;                  </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                         </span><br><span class=\"line\">    <span class=\"keyword\">public</span> LayoutInflater <span class=\"title function_\">createService</span><span class=\"params\">(ContextImpl ctx)</span> &#123;            </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PhoneLayoutInflater</span>(ctx.getOuterContext());        </span><br><span class=\"line\">    &#125;&#125;);                                                              </span><br></pre></td></tr></table></figure>\n\n<p>LayoutInflater 的实现类是 PhoneLayoutInflater，同时 Fetcher 的实现类是 CachedServiceFetcher，PhoneLayoutInflater 只是简单的继承 LayoutInflater，核心代码都在 LayoutInflater，有兴趣的同学可以去看下，所以我们就看下 <code>CachedServiceFetcher.getService()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> T <span class=\"title function_\">getService</span><span class=\"params\">(ContextImpl ctx)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Object[] cache = ctx.mServiceCache;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (cache) &#123;</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">service</span> <span class=\"operator\">=</span> cache[mCacheIndex];</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (service == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                service = createService(ctx);</span><br><span class=\"line\">                cache[mCacheIndex] = service;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (ServiceNotFoundException e) &#123;</span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (T)service;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>注意到，Service 的缓存是存储在 <code>ContextImpl.mServiceCache</code> 并且该字段不是静态的，即<strong>Service 的缓存是针对于相同的 Context 实例的</strong>，如果不存在缓存，那么调用 <code>createService()</code>，上文我们分析 LayoutInflater Fetcher 时知道会创建 PhoneLayoutInflater 实例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 在 Context 初始化那节我们知道 outerContext 就是具体的 ContextWrapper 实现类的实例，比如 Activity、Service 或者 Application</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PhoneLayoutInflater</span>(ctx.getOuterContext()); </span><br></pre></td></tr></table></figure>\n\n<p>而 PhoneLayoutInflater 的构造函数也是调用超类的构造函数：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"title function_\">LayoutInflater</span><span class=\"params\">(Context context)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 这个 mContext 要记住他是具体 ContextWrapper 实现类的实例，比如 Activity 等，这个后面会用到</span></span><br><span class=\"line\">    mContext = context;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>接下来我们看下 <code>inflate()</code> 源码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> View <span class=\"title function_\">inflate</span><span class=\"params\">(<span class=\"meta\">@LayoutRes</span> <span class=\"type\">int</span> resource, <span class=\"meta\">@Nullable</span> ViewGroup root, <span class=\"type\">boolean</span> attachToRoot)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">Resources</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> getContext().getResources();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">XmlResourceParser</span> <span class=\"variable\">parser</span> <span class=\"operator\">=</span> res.getLayout(resource);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> inflate(parser, root, attachToRoot);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        parser.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> View <span class=\"title function_\">inflate</span><span class=\"params\">(XmlPullParser parser, <span class=\"meta\">@Nullable</span> ViewGroup root, <span class=\"type\">boolean</span> attachToRoot)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (mConstructorArgs) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// mContext 是具体 ContextWrapper 实现类的实例，上文我们已经提到了</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">Context</span> <span class=\"variable\">inflaterContext</span> <span class=\"operator\">=</span> mContext;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">AttributeSet</span> <span class=\"variable\">attrs</span> <span class=\"operator\">=</span> Xml.asAttributeSet(parser);</span><br><span class=\"line\">    \t<span class=\"type\">Context</span> <span class=\"variable\">lastContext</span> <span class=\"operator\">=</span> (Context) mConstructorArgs[<span class=\"number\">0</span>];</span><br><span class=\"line\">        mConstructorArgs[<span class=\"number\">0</span>] = inflaterContext;</span><br><span class=\"line\">        <span class=\"type\">View</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> root;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 解析 xml 中的节点</span></span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">View</span> <span class=\"variable\">temp</span> <span class=\"operator\">=</span> createViewFromTag(root, name, inflaterContext, attrs);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> () &#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            mConstructorArgs[<span class=\"number\">0</span>] = lastContext;</span><br><span class=\"line\">            mConstructorArgs[<span class=\"number\">1</span>] = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n\n<p><code>inflater()</code> 就是对 xml 布局进行解析，接着实例化 View，这里我们不去关心它的解析流程，这一块内容可以单独写成一篇文章，我们主要看的是 <code>createViewFromTag()</code> 它是根据标签名称去实例化具体的 View 实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">View <span class=\"title function_\">createViewFromTag</span><span class=\"params\">(View parent, String name, Context context, AttributeSet attrs,</span></span><br><span class=\"line\"><span class=\"params\">            <span class=\"type\">boolean</span> ignoreThemeAttr)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (name.equals(<span class=\"string\">&quot;view&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果我们使用 view 标签则从 class 属性中获取具体类名称</span></span><br><span class=\"line\">        name = attrs.getAttributeValue(<span class=\"literal\">null</span>, <span class=\"string\">&quot;class&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ignoreThemeAttr) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 默认 ignoreThemeAttr 为 false，即不忽略 theme 属性</span></span><br><span class=\"line\">        <span class=\"comment\">// 获取设置的 theme 属性值</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">TypedArray</span> <span class=\"variable\">ta</span> <span class=\"operator\">=</span> context.obtainStyledAttributes(attrs, ATTRS_THEME);</span><br><span class=\"line\">    \t<span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">themeResId</span> <span class=\"operator\">=</span> ta.getResourceId(<span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (themeResId != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果设置了，则将 context 包装成 ContextThemeWrapper</span></span><br><span class=\"line\">            <span class=\"comment\">// 这意味着 xml 布局中 view 设置的 theme 属性优先级要高于 context 中的 theme 属性</span></span><br><span class=\"line\">            context = <span class=\"keyword\">new</span> <span class=\"title class_\">ContextThemeWrapper</span>(context, themeResId);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ta.recycle();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        View view;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// Factory 是用于实现兼容功能，比如 TextView 会使用兼容包的 AppCompatTextView</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mFactory2 != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        \tview = mFactory2.onCreateView(parent, name, context, attrs);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mFactory != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            view = mFactory.onCreateView(name, context, attrs);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            view = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (view == <span class=\"literal\">null</span> &amp;&amp; mPrivateFactory != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        \tview = mPrivateFactory.onCreateView(parent, name, context, attrs);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (view == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">Object</span> <span class=\"variable\">lastContext</span> <span class=\"operator\">=</span> mConstructorArgs[<span class=\"number\">0</span>];</span><br><span class=\"line\">            mConstructorArgs[<span class=\"number\">0</span>] = context;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == name.indexOf(<span class=\"string\">&#x27;.&#x27;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 系统控件</span></span><br><span class=\"line\">                    view = onCreateView(parent, name, attrs);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 自定义控件</span></span><br><span class=\"line\">                    view = createView(name, <span class=\"literal\">null</span>, attrs);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                mConstructorArgs[<span class=\"number\">0</span>] = lastContext;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">return</span> view;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> () &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>不管是系统控件或者自定义控件，最终创建 View 实例都会调用到 <code>createView()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> View <span class=\"title function_\">createView</span><span class=\"params\">(String name, String prefix, AttributeSet attrs)</span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 缓存构造函数</span></span><br><span class=\"line\">    Constructor&lt;? <span class=\"keyword\">extends</span> <span class=\"title class_\">View</span>&gt; constructor = sConstructorMap.get(name);</span><br><span class=\"line\">    <span class=\"comment\">// 检查构造函数类加载器</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (constructor != <span class=\"literal\">null</span> &amp;&amp; !verifyClassLoader(constructor))&#123;</span><br><span class=\"line\">        constructor = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        sConstructorMap.remove(name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Class&lt;? <span class=\"keyword\">extends</span> <span class=\"title class_\">View</span>&gt; clazz = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 获取 View 构造函数实例，并处理过滤情况</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (constructor == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        \tclazz = mContext.getClassLoader().loadClass(</span><br><span class=\"line\">                        prefix != <span class=\"literal\">null</span> ? (prefix + name) : name).asSubclass(View.class);</span><br><span class=\"line\">        </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mFilter != <span class=\"literal\">null</span> &amp;&amp; clazz != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 检查是否过滤</span></span><br><span class=\"line\">        \t<span class=\"type\">boolean</span> <span class=\"variable\">allowed</span> <span class=\"operator\">=</span> mFilter.onLoadClass(clazz);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!allowed) &#123;</span><br><span class=\"line\">                failNotAllowed(name, prefix, attrs);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            constructor = clazz.getConstructor(mConstructorSignature);</span><br><span class=\"line\">            constructor.setAccessible(<span class=\"literal\">true</span>);</span><br><span class=\"line\">            sConstructorMap.put(name, constructor);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mFilter != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 存在过滤器</span></span><br><span class=\"line\">                <span class=\"type\">Boolean</span> <span class=\"variable\">allowedState</span> <span class=\"operator\">=</span> mFilterMap.get(name);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (allowedState == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 没有缓存过滤结果，新的类</span></span><br><span class=\"line\">                    clazz = mContext.getClassLoader().loadClass(                            </span><br><span class=\"line\">                    prefix != <span class=\"literal\">null</span> ? (prefix + name) : name).asSubclass(View.class);</span><br><span class=\"line\">                \t<span class=\"type\">boolean</span> <span class=\"variable\">allowed</span> <span class=\"operator\">=</span> clazz != <span class=\"literal\">null</span> &amp;&amp; mFilter.onLoadClass(clazz);</span><br><span class=\"line\">                \tmFilterMap.put(name, allowed);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!allowed) &#123;</span><br><span class=\"line\">                    \tfailNotAllowed(name, prefix, attrs);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (allowedState.equals(Boolean.FALSE)) &#123;</span><br><span class=\"line\">                    failNotAllowed(name, prefix, attrs);</span><br><span class=\"line\">                &#125; </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">lastContext</span> <span class=\"operator\">=</span> mConstructorArgs[<span class=\"number\">0</span>];</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mConstructorArgs[<span class=\"number\">0</span>] == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果还没设置 context 参数</span></span><br><span class=\"line\">            mConstructorArgs[<span class=\"number\">0</span>] = mContext;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        Object[] args = mConstructorArgs;</span><br><span class=\"line\">        args[<span class=\"number\">1</span>] = attrs;</span><br><span class=\"line\">        <span class=\"comment\">// 反射创建 View 实例，这里调用的构造函数类型为 (Context,AttributeSet)，从 args 可知</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">View</span> <span class=\"variable\">view</span> <span class=\"operator\">=</span> constructor.newInstance(args); </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (view <span class=\"keyword\">instanceof</span> ViewStub) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 使用相同的 Context 处理 ViewStub</span></span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">ViewStub</span> <span class=\"variable\">viewStub</span> <span class=\"operator\">=</span> (ViewStub) view;</span><br><span class=\"line\">            viewStub.setLayoutInflater(cloneInContext((Context) args[<span class=\"number\">0</span>]));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        mConstructorArgs[<span class=\"number\">0</span>] = lastContext;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> view;</span><br><span class=\"line\">    &#125; catech () &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>最后一个问题，Application Context 和 Activity Context 用在 View Context 中有什么不同的地方，我们先通过一个例子来看下效果：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 使用两种 Context 创建两个 EditText</span></span><br><span class=\"line\">    addEditText(<span class=\"built_in\">this</span>);                   </span><br><span class=\"line\">\taddEditText(getApplicationContext());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addEditText</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> Context context)</span> &#123; </span><br><span class=\"line\">                                                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mRootLayout == <span class=\"literal\">null</span>) &#123;                        </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                       </span><br><span class=\"line\">    &#125;                                                 </span><br><span class=\"line\">                                                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (context == <span class=\"literal\">null</span>) &#123;                            </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                       </span><br><span class=\"line\">    &#125;                                                 </span><br><span class=\"line\">                                                                                                       </span><br><span class=\"line\">    <span class=\"type\">EditText</span> <span class=\"variable\">editText</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">EditText</span>(context);        </span><br><span class=\"line\">    mRootLayout.addView(editText);                    </span><br><span class=\"line\">    editText.setText(context.toString());                                                               </span><br><span class=\"line\">&#125;                                                     </span><br></pre></td></tr></table></figure>\n\n<p>代码很简单，使用不同 Context 去创建 EditText 实例，同时我们在 AndroidManifest 中应用了主题</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Applicatin</span> </span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">android:theme</span>=<span class=\"string\">&quot;@style/AppTheme&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Applicatin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;colorAccent&quot;</span>&gt;</span>@color/colorAccent<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">color</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;colorAccent&quot;</span>&gt;</span>#FF4081<span class=\"tag\">&lt;/<span class=\"name\">color</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/ActivityContextEditText.png?x-oss-process=style/doc-img\" alt=\"ActivityContextEditText\"></p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/ApplicationContextEditText.png?x-oss-process=style/doc-img\" alt=\"ApplicationContextEditText\"></p>\n<p>我们发现使用 Activity Context 的 EditText 使用了 theme 中的配置，回顾我们最开始的 Context 类图，Activity 是继承于 ContextThemeWrapper，而 Application 则是继承于 ContextWrapper，那我们是不是可以猜测只有 ContextThemeWrapper 的继承类才会读取 theme 中配置信息呢？我们可以看下 ContextThemeWrapper 中跟 theme 相关的方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> Resources.Theme <span class=\"title function_\">getTheme</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mTheme != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> mTheme;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mThemeResource == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        mThemeResource = R.style.Theme_AppCompat_Light;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    initializeTheme();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> mTheme;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initializeTheme</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">first</span> <span class=\"operator\">=</span> mTheme == <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (first) &#123;</span><br><span class=\"line\">        mTheme = getResources().newTheme();</span><br><span class=\"line\">        Resources.<span class=\"type\">Theme</span> <span class=\"variable\">theme</span> <span class=\"operator\">=</span> getBaseContext().getTheme();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (theme != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            mTheme.setTo(theme);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    onApplyThemeResource(mTheme, mThemeResource, first);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onApplyThemeResource</span><span class=\"params\">(Resources.Theme theme, <span class=\"type\">int</span> resid, <span class=\"type\">boolean</span> first)</span> &#123;</span><br><span class=\"line\">    theme.applyStyle(resid, <span class=\"literal\">true</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>mTheme</code> 和 <code>mThemeResource</code> 都可以通过构造方法和 set 方法进行赋值，假设没有给 <code>mTheme</code> 赋值，只给 <code>mThemeResource</code> 赋值，那么上面的代码将 <code>mThemeSource</code> 应用到 <code>ContextWrapper.getTheme()</code> 返回的 Theme 实例，从而获取新的 Theme 实例。Activity 的启动流程是在 <code>ActivityThread.performLaunchActivity()</code> 中，其中涉及 Theme 的赋值是：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">theme</span> <span class=\"operator\">=</span> r.activityInfo.getThemeResource();</span><br><span class=\"line\"><span class=\"keyword\">if</span> (theme != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    activity.setTheme(theme);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>现在我们应该知道了为什么有时候控件的样式不跟随主题设置了。</p>\n<h4 id=\"小结-1\"><a href=\"#小结-1\" class=\"headerlink\" title=\"小结\"></a>小结</h4><p>通过上面的源码分析，我们可以知道：</p>\n<ol>\n<li>当使用 LayoutInflater 从 xml 文件中 inflate 布局时，调用的是 <code>View(Context,AttributeSet)</code> 构造函数，使用的 Context 实例跟 LayoutInflater 创建时使用的 Context 一样，并且 LayoutInflater 会缓存在 Context 实例中，即相同的 Context 实例多次调用会获取一样的 LayoutInflater 实例。</li>\n<li>Activity Context 会读取 Theme 的样式信息，而 Application Context 则不会。</li>\n</ol>\n<h3 id=\"getApplication-和getApplicatinContext\"><a href=\"#getApplication-和getApplicatinContext\" class=\"headerlink\" title=\"getApplication()和getApplicatinContext()\"></a>getApplication()和getApplicatinContext()</h3><p><strong>接下来的分析参考于 <a href=\"http://gityuan.com/2017/04/09/android_context/\">android-context</a></strong></p>\n<p>绝大数情况下，这两个方法的返回值是一样。</p>\n<p><code>getApplicationContext()</code> 的存在是 Android 历史原因，<code>getApplication()</code> 这个只存在 Activity 和 Service 类中，那么对于 BroadcastReceiver 和 ContentProvider 来说，要获取 Application，就只能通过 <code>getApplicationContext()</code>。</p>\n<p>两者对比：</p>\n<ol>\n<li>对于 Activity&#x2F;Service 来说，这两个方法没有区别，除非厂商修改过</li>\n<li>BroadcastReceiver 只能通过 <code>getApplicationContext()</code> 获取 Application 实例</li>\n<li>ContentProvider 也只能通过 <code>getApplicationContext()</code> 获取 Application 实例，但有可能出现空值的情况。当同个进程有多个 apk 的情况下，对于第二个 apk 是由 provider 方式拉起，而 provider 创建过程中并不会初始化 Application，此时调用 <code>getApplicationContext()</code> 则会返回空。</li>\n</ol>\n<h4 id=\"小结-2\"><a href=\"#小结-2\" class=\"headerlink\" title=\"小结\"></a>小结</h4><p>绝大数情况下，<code>getApplication()</code> 和 <code>getApplicationContext()</code> 返回是一样的，但如果不是特别熟悉，最好对 <code>getApplicationContext()</code> 进行空值判断。</p>\n<h3 id=\"Dialog-Context\"><a href=\"#Dialog-Context\" class=\"headerlink\" title=\"Dialog Context\"></a>Dialog Context</h3><p>我们都知道创建 Dialog 实例需要传递 Context 实例，但这里的 Context 必须是 Activity Context，如果传入其他类型的 Context，则会抛出以下异常：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Caused by: android.view.WindowManager$BadTokenException: Unable to add window -- token null is not valid; is your activity running?</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"start-Activity\"><a href=\"#start-Activity\" class=\"headerlink\" title=\"start Activity\"></a>start Activity</h3><p>通过调用 <code>startActivity()</code> 去启动 Activity 是非常常见的操作，并且这个方法存在 Context 类中，即不仅仅是 Activity 可以调用，Application 也可以调用，而 Application 没有重写 <code>startActivity()</code> 即实现是委托给 ContextImpl 的。这里有个需要注意的地方：</p>\n<p>在 Android 26 上，如果使用 Application 启动 Activity，而没有添加 <code>Intent.FLAG_ACTIVITY_NEW_TASK</code> 标记的话，则会抛出以下异常：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Caused by: android.util.AndroidRuntimeException: Calling startActivity() from outside of an Activity  context requires the FLAG_ACTIVITY_NEW_TASK flag. Is this really what you want?</span><br></pre></td></tr></table></figure>\n\n<p>Android 26 上 ContextImpl 的相关代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivity</span><span class=\"params\">(Intent intent, Bundle options)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((intent.getFlags()&amp;Intent.FLAG_ACTIVITY_NEW_TASK) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">AndroidRuntimeException</span>(</span><br><span class=\"line\">                    <span class=\"string\">&quot;Calling startActivity() from outside of an Activity &quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot; context requires the FLAG_ACTIVITY_NEW_TASK flag.&quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot; Is this really what you want?&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>只要没有添加 <code>Intent.FLAG_ACTIVITY_NEW_TASK</code> 标记就会抛异常。</p>\n<p>而在 Android 27 上，则有些区别，同样是 ContextImpl 的源码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivity</span><span class=\"params\">(Intent intent, Bundle options)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((intent.getFlags()&amp;Intent.FLAG_ACTIVITY_NEW_TASK) == <span class=\"number\">0</span></span><br><span class=\"line\">        &amp;&amp; options != <span class=\"literal\">null</span> &amp;&amp; ActivityOptions.fromBundle(options).getLaunchTaskId() == -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">AndroidRuntimeException</span>(</span><br><span class=\"line\">                    <span class=\"string\">&quot;Calling startActivity() from outside of an Activity &quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot; context requires the FLAG_ACTIVITY_NEW_TASK flag.&quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot; Is this really what you want?&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>只有在指定了 <code>options</code> 同时其中没有指定 LaunchTaskId 才会抛异常。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>上面我们列举了不同 Context 的初始化过程，比如最常见的 Activity Context 和 Application Context，同时对不同 Context 的使用场景进行比较，相信看完文章的同学，对 Context 有了更多的理解。</p>\n<p>不管如何谨慎小心，怀着诚惶诚恐的心态写作，但是毕竟作者的水平有限，如果有写的不对的地方，敬请指教，先行感谢。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"感谢\"><a href=\"#感谢\" class=\"headerlink\" title=\"感谢\"></a>感谢</h2><p><a href=\"http://gityuan.com/2017/04/09/android_context/\">android-context</a></p>\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><blockquote>\n<p>本文中涉及的源码分析都是基于 Android 27</p>\n</blockquote>\n<p>Context 又叫上下文，用于提供应用环境的信息。常用的操作包括启动 Activity、Service，或者通过 <code>getResources()</code> 返回 Resources 用于获取应用的资源文件，比如字符串、Drawable 等等。对于这些用法，我们就不去一一列举了，这篇文章的最终目的是，通过对 Context 体系的整体了解，能在平时的应用开发中，正确使用不同类型的 Context。首先我们看下 Context 的类图：</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/Context.png?x-oss-process=style/doc-img\" alt=\"Context\"></p>\n<p>其中 ContextImpl 负责 Context 核心功能的实现，而我们常见的 Activity Context，Application Context 等则是继承于 ContextWrapper，从类名可以猜测，这个是 Context 的包装类。实际上也是如此：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">ContextWrapper</span><span class=\"params\">(Context base)</span> &#123;</span><br><span class=\"line\">\tmBase = base;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivity</span><span class=\"params\">(Intent intent)</span> &#123;</span><br><span class=\"line\">    mBase.startActivity(intent);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>通过在构造函数中将 ContextImpl 实例赋值给 <code>mBase</code>，然后在比如 <code>startActivity</code> 等方法实现中，将调用转发给 <code>mBase</code>，至于 <code>mBase</code> 是不是 ContextImpl 实例，这个在后面的源码分析中可以知道。</p>\n<p>通过上面的类图，我们可以知道 Application、Service、Activity 都是继承于 ContextWrapper，那么接下来通过简单的源码分析下上述的三个类实例的 Context 初始化过程。</p>\n<h2 id=\"Context初始化\"><a href=\"#Context初始化\" class=\"headerlink\" title=\"Context初始化\"></a>Context初始化</h2><h3 id=\"Activity\"><a href=\"#Activity\" class=\"headerlink\" title=\"Activity\"></a>Activity</h3><p>在前面的 <a href=\"https://linxiaotao.github.io/2018/03/27/Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B-%E5%9F%BA%E4%BA%8EAndroid26/\">Activity 启动分析</a>中，我们知道 Activity 启动方法是 <code>ActivityThread.performLaunchActivity()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performLaunchActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 初始化 LoadedApk</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (r.packageInfo == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \tr.packageInfo = getPackageInfo();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 创建 ContextImpl 实例</span></span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">appContext</span> <span class=\"operator\">=</span> createBaseContextForActivity(r);</span><br><span class=\"line\">    <span class=\"type\">Activity</span> <span class=\"variable\">activity</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        java.lang.<span class=\"type\">ClassLoader</span> <span class=\"variable\">cl</span> <span class=\"operator\">=</span> appContext.getClassLoader();</span><br><span class=\"line\">        activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> r.packageInfo.makeApplication(<span class=\"literal\">false</span>, mInstrumentation);</span><br><span class=\"line\">        appContext.setOuterContext(activity);</span><br><span class=\"line\">        activity.attach();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先获取 LoadedApk 实例，接着调用 <code>createBaseContextForActivity()</code> 创建 ContextImpl 实例，之前我们提到 ContextWrapper 是将 Context 核心功能转发给 ContextImpl 实现的，而 <code>ContextWrapper.mBase</code> 的赋值，在 Activity 启动流程中，是通过调用 <code>Activity.attach()</code> 实现，这个我们在后面的分析中可以知道。</p>\n<h4 id=\"create\"><a href=\"#create\" class=\"headerlink\" title=\"create\"></a>create</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> ComtextImpl <span class=\"title function_\">createBaseContextForActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">int</span> displayId;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        displayId = ActivityManager.getService().getActivityDisplayId(r.token);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (RemoteException e) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">appContext</span> <span class=\"operator\">=</span> ContextImpl.createActivityContext();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> ContextImpl <span class=\"title function_\">createActivityContext</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ContextImpl</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// Activity Resource</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ResourcesManager</span> <span class=\"variable\">resourcesManager</span> <span class=\"operator\">=</span> ResourcesManager.getInstance();</span><br><span class=\"line\">    context.setResources(resourcesManager.createBaseActivityResources(activityToken,</span><br><span class=\"line\">                packageInfo.getResDir(),</span><br><span class=\"line\">                splitDirs,</span><br><span class=\"line\">                packageInfo.getOverlayDirs(),</span><br><span class=\"line\">                packageInfo.getApplicationInfo().sharedLibraryFiles,</span><br><span class=\"line\">                displayId,</span><br><span class=\"line\">                overrideConfiguration,</span><br><span class=\"line\">                compatInfo,</span><br><span class=\"line\">                classLoader));</span><br><span class=\"line\">    context.mDisplay = resourcesManager.getAdjustedDisplay(displayId,</span><br><span class=\"line\">                context.getResources());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"attach\"><a href=\"#attach\" class=\"headerlink\" title=\"attach\"></a>attach</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">attach</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    attachBaseContext(context);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">attachBaseContext</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">super</span>.attachBaseContext(newBase);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这个步骤比较简单，最终也是调用 <code>ContextWrapper.attachBaseContext()</code></p>\n<h3 id=\"Service\"><a href=\"#Service\" class=\"headerlink\" title=\"Service\"></a>Service</h3><p>Service 的创建是在 <code>ActivityThread.handleCreateService()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 初始化 LoadedApk</span></span><br><span class=\"line\"><span class=\"type\">LoadedApk</span> <span class=\"variable\">packageInfo</span> <span class=\"operator\">=</span> getPackageInfoNoCheck();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">Service</span> <span class=\"variable\">service</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    java.lang.<span class=\"type\">ClassLoader</span> <span class=\"variable\">cl</span> <span class=\"operator\">=</span> packageInfo.getClassLoader();</span><br><span class=\"line\">    <span class=\"comment\">// 通过反射实例化 Service</span></span><br><span class=\"line\">    service = (Service) cl.loadClass(data.info.name).newInstance();</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> ContextImpl.createAppContext(<span class=\"built_in\">this</span>, packageInfo);</span><br><span class=\"line\">    context.setOuterContext(service);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> packageInfo.makeApplication(<span class=\"literal\">false</span>, mInstrumentation);</span><br><span class=\"line\">    service.attach();</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Service 的 Context 初始化流程和 Activity 是差不多，相同的 LoadedApk -&gt; ContextImpl -&gt; attach</p>\n<h4 id=\"create-1\"><a href=\"#create-1\" class=\"headerlink\" title=\"create\"></a>create</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> ContextImpl <span class=\"title function_\">createAppContext</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ContextImpl</span>();</span><br><span class=\"line\">    <span class=\"comment\">// Service 的 Resources 相对于 Activity 是比较简单的</span></span><br><span class=\"line\">    context.setResources(packageInfo.getResources());</span><br><span class=\"line\">    <span class=\"keyword\">return</span> context;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"attach-1\"><a href=\"#attach-1\" class=\"headerlink\" title=\"attach\"></a>attach</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">attach</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    attachBaseContext(context);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Service 的 attach 和 Activity 相同，都是调用 <code>ContextWrapper.attachBaseContext()</code></p>\n<h3 id=\"Application\"><a href=\"#Application\" class=\"headerlink\" title=\"Application\"></a>Application</h3><p>Application 的创建是在 <code>LoadedApk.makeApplication()</code> </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> Application <span class=\"title function_\">makeApplication</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 保持单例</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mApplication != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> mApplication;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">appClass</span> <span class=\"operator\">=</span> mApplicationInfo.className;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (forceDefaultAppClass || (appClass == <span class=\"literal\">null</span>)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果强制使用默认 Application，或者没有实现自定义 Application</span></span><br><span class=\"line\">    \tappClass = <span class=\"string\">&quot;android.app.Application&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        java.lang.<span class=\"type\">ClassLoader</span> <span class=\"variable\">cl</span> <span class=\"operator\">=</span> getClassLoader();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mPackageName.equals(<span class=\"string\">&quot;android&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 包名不是 &quot;android&quot;，即非系统进程</span></span><br><span class=\"line\">        \tinitializeJavaContextClassLoader();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 ContextImpl 实例</span></span><br><span class=\"line\">        <span class=\"type\">ContextImpl</span> <span class=\"variable\">appContext</span> <span class=\"operator\">=</span> ContextImpl.createAppContext(mActivityThread, <span class=\"built_in\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 创建 Application 实例</span></span><br><span class=\"line\">    \tapp = mActivityThread.mInstrumentation.newApplication(</span><br><span class=\"line\">                    cl, appClass, appContext);</span><br><span class=\"line\">    \tappContext.setOuterContext(app);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>咋一看好像 Application 的流程和其他两个不太相同，其实 Application 的 attach 是在 <code>Instrumentation.newApplication()</code></p>\n<h4 id=\"create-2\"><a href=\"#create-2\" class=\"headerlink\" title=\"create\"></a>create</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> ContextImpl <span class=\"title function_\">createAppContext</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ContextImpl</span>();</span><br><span class=\"line\">    context.setResources(packageInfo.getResources());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"attach-2\"><a href=\"#attach-2\" class=\"headerlink\" title=\"attach\"></a>attach</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Application <span class=\"title function_\">newApplication</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 反射获取实例</span></span><br><span class=\"line\">    <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> (Application)clazz.newInstance();</span><br><span class=\"line\">    app.attach(context);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> app;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">attach</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    attachBaseContext(context);</span><br><span class=\"line\">    mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h3><p> Activity、Service、Application 的 Context 初始化流程大致是这样，首先创建 ContextImpl 实例，接着调用 <code>ContextWrapper.attachBaseContext()</code> 赋值给 <code>mBase</code>，ContextImpl 用于实现 Context 的核心功能，而 Context 的继承类则增加差异性功能。</p>\n<h2 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h2><p>通过上面对不同类型的 Context 的初始化分析，我们对 Context 机制有个大概的认识，接下来我们通过对实际场景下的不同 Context 用例进行分析，从而加深对 Context 的理解。</p>\n<h3 id=\"View-Context\"><a href=\"#View-Context\" class=\"headerlink\" title=\"View Context\"></a>View Context</h3><h4 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h4><p>我们知道可以通过调用 <code>View.getContext()</code> 返回当前 View 使用的 Context 实例，这个实例主要用于获取 View 所要使用的资源信息，那么这个 Context 实例是在什么时候赋值的，使用的是哪种类型的 Context，区别又是什么呢。</p>\n<h4 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h4><p>首先我们对 View 的 <code>mContext</code> 变量赋值进行搜索，可以知道，赋值操作是在其中一个构造函数中，同时其他构造函数都会调用这个构造函数，所以我们可以先从构造函数的调用入手。</p>\n<p>如果我们想要动态从 xml 布局中解析得到 View，我们会通过 LayoutInflater 去实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">LayoutInflater</span> <span class=\"variable\">layoutInflater</span> <span class=\"operator\">=</span> LayoutInflater.from(context);</span><br><span class=\"line\"><span class=\"type\">View</span> <span class=\"variable\">view</span> <span class=\"operator\">=</span> layoutInflater.inflate(R.layout.xxx,<span class=\"literal\">null</span>);</span><br></pre></td></tr></table></figure>\n\n<p>首先我们看下 <code>LayoutInflater.from()</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> LayoutInflater <span class=\"title function_\">from</span><span class=\"params\">(Context context)</span> &#123;</span><br><span class=\"line\"><span class=\"type\">LayoutInflater</span> <span class=\"variable\">LayoutInflater</span> <span class=\"operator\">=</span>\t\t  (LayoutInflater)context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (LayoutInflater == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">AssertionError</span>(<span class=\"string\">&quot;LayoutInflater not found.&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> LayoutInflater;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在前面，我们提到 Context 的核心方法都转发给 <code>mBase</code> 即 ContextImpl 实例，所以看下 ContextImpl 类的实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> Object <span class=\"title function_\">getSystemService</span><span class=\"params\">(String name)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> SystemServiceRegistry.getSystemService(<span class=\"built_in\">this</span>, name);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Object <span class=\"title function_\">getSystemService</span><span class=\"params\">(ContextImpl ctx, String name)</span> &#123;</span><br><span class=\"line\">    ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> fetcher != <span class=\"literal\">null</span> ? fetcher.getService(ctx) : <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以看到最终的调用都转发给了 ServiceFetcher，而 <code>SYSTEM_SERVICE_FETCHERS</code> 则是存储着各个类型的 Fetcher 的实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// SYSTEM_SERVICE_FETCHERS 是个 Map，存储 Name-&gt;Fetcher</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt; SYSTEM_SERVICE_FETCHERS =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;String, ServiceFetcher&lt;?&gt;&gt;();</span><br><span class=\"line\"><span class=\"comment\">// 存储 Class-&gt;Name</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> HashMap&lt;Class&lt;?&gt;, String&gt; SYSTEM_SERVICE_NAMES =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;Class&lt;?&gt;, String&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> &lt;T&gt; <span class=\"keyword\">void</span> <span class=\"title function_\">registerService</span><span class=\"params\">(String serviceName, Class&lt;T&gt; serviceClass,</span></span><br><span class=\"line\"><span class=\"params\">            ServiceFetcher&lt;T&gt; serviceFetcher)</span> &#123;</span><br><span class=\"line\">    SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);</span><br><span class=\"line\">    SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>SYSTEM_SERVICE_FETCHERS</code> 存储着 Service 名称和 Fetcher 的映射关系，而这种关系的注册是通过 <code>registerService()</code>，这里我们只关心 LayoutInflater 的注册：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">registerService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,</span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">CachedServiceFetcher</span>&lt;LayoutInflater&gt;() &#123;                  </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                         </span><br><span class=\"line\">    <span class=\"keyword\">public</span> LayoutInflater <span class=\"title function_\">createService</span><span class=\"params\">(ContextImpl ctx)</span> &#123;            </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PhoneLayoutInflater</span>(ctx.getOuterContext());        </span><br><span class=\"line\">    &#125;&#125;);                                                              </span><br></pre></td></tr></table></figure>\n\n<p>LayoutInflater 的实现类是 PhoneLayoutInflater，同时 Fetcher 的实现类是 CachedServiceFetcher，PhoneLayoutInflater 只是简单的继承 LayoutInflater，核心代码都在 LayoutInflater，有兴趣的同学可以去看下，所以我们就看下 <code>CachedServiceFetcher.getService()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> T <span class=\"title function_\">getService</span><span class=\"params\">(ContextImpl ctx)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Object[] cache = ctx.mServiceCache;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (cache) &#123;</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">service</span> <span class=\"operator\">=</span> cache[mCacheIndex];</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (service == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                service = createService(ctx);</span><br><span class=\"line\">                cache[mCacheIndex] = service;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (ServiceNotFoundException e) &#123;</span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (T)service;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>注意到，Service 的缓存是存储在 <code>ContextImpl.mServiceCache</code> 并且该字段不是静态的，即<strong>Service 的缓存是针对于相同的 Context 实例的</strong>，如果不存在缓存，那么调用 <code>createService()</code>，上文我们分析 LayoutInflater Fetcher 时知道会创建 PhoneLayoutInflater 实例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 在 Context 初始化那节我们知道 outerContext 就是具体的 ContextWrapper 实现类的实例，比如 Activity、Service 或者 Application</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PhoneLayoutInflater</span>(ctx.getOuterContext()); </span><br></pre></td></tr></table></figure>\n\n<p>而 PhoneLayoutInflater 的构造函数也是调用超类的构造函数：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"title function_\">LayoutInflater</span><span class=\"params\">(Context context)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 这个 mContext 要记住他是具体 ContextWrapper 实现类的实例，比如 Activity 等，这个后面会用到</span></span><br><span class=\"line\">    mContext = context;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>接下来我们看下 <code>inflate()</code> 源码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> View <span class=\"title function_\">inflate</span><span class=\"params\">(<span class=\"meta\">@LayoutRes</span> <span class=\"type\">int</span> resource, <span class=\"meta\">@Nullable</span> ViewGroup root, <span class=\"type\">boolean</span> attachToRoot)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">Resources</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> getContext().getResources();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">XmlResourceParser</span> <span class=\"variable\">parser</span> <span class=\"operator\">=</span> res.getLayout(resource);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> inflate(parser, root, attachToRoot);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        parser.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> View <span class=\"title function_\">inflate</span><span class=\"params\">(XmlPullParser parser, <span class=\"meta\">@Nullable</span> ViewGroup root, <span class=\"type\">boolean</span> attachToRoot)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (mConstructorArgs) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// mContext 是具体 ContextWrapper 实现类的实例，上文我们已经提到了</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">Context</span> <span class=\"variable\">inflaterContext</span> <span class=\"operator\">=</span> mContext;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">AttributeSet</span> <span class=\"variable\">attrs</span> <span class=\"operator\">=</span> Xml.asAttributeSet(parser);</span><br><span class=\"line\">    \t<span class=\"type\">Context</span> <span class=\"variable\">lastContext</span> <span class=\"operator\">=</span> (Context) mConstructorArgs[<span class=\"number\">0</span>];</span><br><span class=\"line\">        mConstructorArgs[<span class=\"number\">0</span>] = inflaterContext;</span><br><span class=\"line\">        <span class=\"type\">View</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> root;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 解析 xml 中的节点</span></span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">View</span> <span class=\"variable\">temp</span> <span class=\"operator\">=</span> createViewFromTag(root, name, inflaterContext, attrs);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> () &#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            mConstructorArgs[<span class=\"number\">0</span>] = lastContext;</span><br><span class=\"line\">            mConstructorArgs[<span class=\"number\">1</span>] = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n\n<p><code>inflater()</code> 就是对 xml 布局进行解析，接着实例化 View，这里我们不去关心它的解析流程，这一块内容可以单独写成一篇文章，我们主要看的是 <code>createViewFromTag()</code> 它是根据标签名称去实例化具体的 View 实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">View <span class=\"title function_\">createViewFromTag</span><span class=\"params\">(View parent, String name, Context context, AttributeSet attrs,</span></span><br><span class=\"line\"><span class=\"params\">            <span class=\"type\">boolean</span> ignoreThemeAttr)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (name.equals(<span class=\"string\">&quot;view&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果我们使用 view 标签则从 class 属性中获取具体类名称</span></span><br><span class=\"line\">        name = attrs.getAttributeValue(<span class=\"literal\">null</span>, <span class=\"string\">&quot;class&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ignoreThemeAttr) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 默认 ignoreThemeAttr 为 false，即不忽略 theme 属性</span></span><br><span class=\"line\">        <span class=\"comment\">// 获取设置的 theme 属性值</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">TypedArray</span> <span class=\"variable\">ta</span> <span class=\"operator\">=</span> context.obtainStyledAttributes(attrs, ATTRS_THEME);</span><br><span class=\"line\">    \t<span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">themeResId</span> <span class=\"operator\">=</span> ta.getResourceId(<span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (themeResId != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果设置了，则将 context 包装成 ContextThemeWrapper</span></span><br><span class=\"line\">            <span class=\"comment\">// 这意味着 xml 布局中 view 设置的 theme 属性优先级要高于 context 中的 theme 属性</span></span><br><span class=\"line\">            context = <span class=\"keyword\">new</span> <span class=\"title class_\">ContextThemeWrapper</span>(context, themeResId);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ta.recycle();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        View view;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// Factory 是用于实现兼容功能，比如 TextView 会使用兼容包的 AppCompatTextView</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mFactory2 != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        \tview = mFactory2.onCreateView(parent, name, context, attrs);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mFactory != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            view = mFactory.onCreateView(name, context, attrs);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            view = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (view == <span class=\"literal\">null</span> &amp;&amp; mPrivateFactory != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        \tview = mPrivateFactory.onCreateView(parent, name, context, attrs);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (view == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">Object</span> <span class=\"variable\">lastContext</span> <span class=\"operator\">=</span> mConstructorArgs[<span class=\"number\">0</span>];</span><br><span class=\"line\">            mConstructorArgs[<span class=\"number\">0</span>] = context;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == name.indexOf(<span class=\"string\">&#x27;.&#x27;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 系统控件</span></span><br><span class=\"line\">                    view = onCreateView(parent, name, attrs);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 自定义控件</span></span><br><span class=\"line\">                    view = createView(name, <span class=\"literal\">null</span>, attrs);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                mConstructorArgs[<span class=\"number\">0</span>] = lastContext;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">return</span> view;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> () &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>不管是系统控件或者自定义控件，最终创建 View 实例都会调用到 <code>createView()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> View <span class=\"title function_\">createView</span><span class=\"params\">(String name, String prefix, AttributeSet attrs)</span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 缓存构造函数</span></span><br><span class=\"line\">    Constructor&lt;? <span class=\"keyword\">extends</span> <span class=\"title class_\">View</span>&gt; constructor = sConstructorMap.get(name);</span><br><span class=\"line\">    <span class=\"comment\">// 检查构造函数类加载器</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (constructor != <span class=\"literal\">null</span> &amp;&amp; !verifyClassLoader(constructor))&#123;</span><br><span class=\"line\">        constructor = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        sConstructorMap.remove(name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Class&lt;? <span class=\"keyword\">extends</span> <span class=\"title class_\">View</span>&gt; clazz = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 获取 View 构造函数实例，并处理过滤情况</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (constructor == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        \tclazz = mContext.getClassLoader().loadClass(</span><br><span class=\"line\">                        prefix != <span class=\"literal\">null</span> ? (prefix + name) : name).asSubclass(View.class);</span><br><span class=\"line\">        </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mFilter != <span class=\"literal\">null</span> &amp;&amp; clazz != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 检查是否过滤</span></span><br><span class=\"line\">        \t<span class=\"type\">boolean</span> <span class=\"variable\">allowed</span> <span class=\"operator\">=</span> mFilter.onLoadClass(clazz);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!allowed) &#123;</span><br><span class=\"line\">                failNotAllowed(name, prefix, attrs);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            constructor = clazz.getConstructor(mConstructorSignature);</span><br><span class=\"line\">            constructor.setAccessible(<span class=\"literal\">true</span>);</span><br><span class=\"line\">            sConstructorMap.put(name, constructor);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mFilter != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 存在过滤器</span></span><br><span class=\"line\">                <span class=\"type\">Boolean</span> <span class=\"variable\">allowedState</span> <span class=\"operator\">=</span> mFilterMap.get(name);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (allowedState == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 没有缓存过滤结果，新的类</span></span><br><span class=\"line\">                    clazz = mContext.getClassLoader().loadClass(                            </span><br><span class=\"line\">                    prefix != <span class=\"literal\">null</span> ? (prefix + name) : name).asSubclass(View.class);</span><br><span class=\"line\">                \t<span class=\"type\">boolean</span> <span class=\"variable\">allowed</span> <span class=\"operator\">=</span> clazz != <span class=\"literal\">null</span> &amp;&amp; mFilter.onLoadClass(clazz);</span><br><span class=\"line\">                \tmFilterMap.put(name, allowed);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!allowed) &#123;</span><br><span class=\"line\">                    \tfailNotAllowed(name, prefix, attrs);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (allowedState.equals(Boolean.FALSE)) &#123;</span><br><span class=\"line\">                    failNotAllowed(name, prefix, attrs);</span><br><span class=\"line\">                &#125; </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">lastContext</span> <span class=\"operator\">=</span> mConstructorArgs[<span class=\"number\">0</span>];</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mConstructorArgs[<span class=\"number\">0</span>] == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果还没设置 context 参数</span></span><br><span class=\"line\">            mConstructorArgs[<span class=\"number\">0</span>] = mContext;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        Object[] args = mConstructorArgs;</span><br><span class=\"line\">        args[<span class=\"number\">1</span>] = attrs;</span><br><span class=\"line\">        <span class=\"comment\">// 反射创建 View 实例，这里调用的构造函数类型为 (Context,AttributeSet)，从 args 可知</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">View</span> <span class=\"variable\">view</span> <span class=\"operator\">=</span> constructor.newInstance(args); </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (view <span class=\"keyword\">instanceof</span> ViewStub) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 使用相同的 Context 处理 ViewStub</span></span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">ViewStub</span> <span class=\"variable\">viewStub</span> <span class=\"operator\">=</span> (ViewStub) view;</span><br><span class=\"line\">            viewStub.setLayoutInflater(cloneInContext((Context) args[<span class=\"number\">0</span>]));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        mConstructorArgs[<span class=\"number\">0</span>] = lastContext;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> view;</span><br><span class=\"line\">    &#125; catech () &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>最后一个问题，Application Context 和 Activity Context 用在 View Context 中有什么不同的地方，我们先通过一个例子来看下效果：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 使用两种 Context 创建两个 EditText</span></span><br><span class=\"line\">    addEditText(<span class=\"built_in\">this</span>);                   </span><br><span class=\"line\">\taddEditText(getApplicationContext());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addEditText</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> Context context)</span> &#123; </span><br><span class=\"line\">                                                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mRootLayout == <span class=\"literal\">null</span>) &#123;                        </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                       </span><br><span class=\"line\">    &#125;                                                 </span><br><span class=\"line\">                                                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (context == <span class=\"literal\">null</span>) &#123;                            </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                       </span><br><span class=\"line\">    &#125;                                                 </span><br><span class=\"line\">                                                                                                       </span><br><span class=\"line\">    <span class=\"type\">EditText</span> <span class=\"variable\">editText</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">EditText</span>(context);        </span><br><span class=\"line\">    mRootLayout.addView(editText);                    </span><br><span class=\"line\">    editText.setText(context.toString());                                                               </span><br><span class=\"line\">&#125;                                                     </span><br></pre></td></tr></table></figure>\n\n<p>代码很简单，使用不同 Context 去创建 EditText 实例，同时我们在 AndroidManifest 中应用了主题</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Applicatin</span> </span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">android:theme</span>=<span class=\"string\">&quot;@style/AppTheme&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Applicatin</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;colorAccent&quot;</span>&gt;</span>@color/colorAccent<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">color</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;colorAccent&quot;</span>&gt;</span>#FF4081<span class=\"tag\">&lt;/<span class=\"name\">color</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/ActivityContextEditText.png?x-oss-process=style/doc-img\" alt=\"ActivityContextEditText\"></p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/ApplicationContextEditText.png?x-oss-process=style/doc-img\" alt=\"ApplicationContextEditText\"></p>\n<p>我们发现使用 Activity Context 的 EditText 使用了 theme 中的配置，回顾我们最开始的 Context 类图，Activity 是继承于 ContextThemeWrapper，而 Application 则是继承于 ContextWrapper，那我们是不是可以猜测只有 ContextThemeWrapper 的继承类才会读取 theme 中配置信息呢？我们可以看下 ContextThemeWrapper 中跟 theme 相关的方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> Resources.Theme <span class=\"title function_\">getTheme</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mTheme != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> mTheme;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mThemeResource == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        mThemeResource = R.style.Theme_AppCompat_Light;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    initializeTheme();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> mTheme;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initializeTheme</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">first</span> <span class=\"operator\">=</span> mTheme == <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (first) &#123;</span><br><span class=\"line\">        mTheme = getResources().newTheme();</span><br><span class=\"line\">        Resources.<span class=\"type\">Theme</span> <span class=\"variable\">theme</span> <span class=\"operator\">=</span> getBaseContext().getTheme();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (theme != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            mTheme.setTo(theme);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    onApplyThemeResource(mTheme, mThemeResource, first);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onApplyThemeResource</span><span class=\"params\">(Resources.Theme theme, <span class=\"type\">int</span> resid, <span class=\"type\">boolean</span> first)</span> &#123;</span><br><span class=\"line\">    theme.applyStyle(resid, <span class=\"literal\">true</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>mTheme</code> 和 <code>mThemeResource</code> 都可以通过构造方法和 set 方法进行赋值，假设没有给 <code>mTheme</code> 赋值，只给 <code>mThemeResource</code> 赋值，那么上面的代码将 <code>mThemeSource</code> 应用到 <code>ContextWrapper.getTheme()</code> 返回的 Theme 实例，从而获取新的 Theme 实例。Activity 的启动流程是在 <code>ActivityThread.performLaunchActivity()</code> 中，其中涉及 Theme 的赋值是：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">theme</span> <span class=\"operator\">=</span> r.activityInfo.getThemeResource();</span><br><span class=\"line\"><span class=\"keyword\">if</span> (theme != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    activity.setTheme(theme);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>现在我们应该知道了为什么有时候控件的样式不跟随主题设置了。</p>\n<h4 id=\"小结-1\"><a href=\"#小结-1\" class=\"headerlink\" title=\"小结\"></a>小结</h4><p>通过上面的源码分析，我们可以知道：</p>\n<ol>\n<li>当使用 LayoutInflater 从 xml 文件中 inflate 布局时，调用的是 <code>View(Context,AttributeSet)</code> 构造函数，使用的 Context 实例跟 LayoutInflater 创建时使用的 Context 一样，并且 LayoutInflater 会缓存在 Context 实例中，即相同的 Context 实例多次调用会获取一样的 LayoutInflater 实例。</li>\n<li>Activity Context 会读取 Theme 的样式信息，而 Application Context 则不会。</li>\n</ol>\n<h3 id=\"getApplication-和getApplicatinContext\"><a href=\"#getApplication-和getApplicatinContext\" class=\"headerlink\" title=\"getApplication()和getApplicatinContext()\"></a>getApplication()和getApplicatinContext()</h3><p><strong>接下来的分析参考于 <a href=\"http://gityuan.com/2017/04/09/android_context/\">android-context</a></strong></p>\n<p>绝大数情况下，这两个方法的返回值是一样。</p>\n<p><code>getApplicationContext()</code> 的存在是 Android 历史原因，<code>getApplication()</code> 这个只存在 Activity 和 Service 类中，那么对于 BroadcastReceiver 和 ContentProvider 来说，要获取 Application，就只能通过 <code>getApplicationContext()</code>。</p>\n<p>两者对比：</p>\n<ol>\n<li>对于 Activity&#x2F;Service 来说，这两个方法没有区别，除非厂商修改过</li>\n<li>BroadcastReceiver 只能通过 <code>getApplicationContext()</code> 获取 Application 实例</li>\n<li>ContentProvider 也只能通过 <code>getApplicationContext()</code> 获取 Application 实例，但有可能出现空值的情况。当同个进程有多个 apk 的情况下，对于第二个 apk 是由 provider 方式拉起，而 provider 创建过程中并不会初始化 Application，此时调用 <code>getApplicationContext()</code> 则会返回空。</li>\n</ol>\n<h4 id=\"小结-2\"><a href=\"#小结-2\" class=\"headerlink\" title=\"小结\"></a>小结</h4><p>绝大数情况下，<code>getApplication()</code> 和 <code>getApplicationContext()</code> 返回是一样的，但如果不是特别熟悉，最好对 <code>getApplicationContext()</code> 进行空值判断。</p>\n<h3 id=\"Dialog-Context\"><a href=\"#Dialog-Context\" class=\"headerlink\" title=\"Dialog Context\"></a>Dialog Context</h3><p>我们都知道创建 Dialog 实例需要传递 Context 实例，但这里的 Context 必须是 Activity Context，如果传入其他类型的 Context，则会抛出以下异常：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Caused by: android.view.WindowManager$BadTokenException: Unable to add window -- token null is not valid; is your activity running?</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"start-Activity\"><a href=\"#start-Activity\" class=\"headerlink\" title=\"start Activity\"></a>start Activity</h3><p>通过调用 <code>startActivity()</code> 去启动 Activity 是非常常见的操作，并且这个方法存在 Context 类中，即不仅仅是 Activity 可以调用，Application 也可以调用，而 Application 没有重写 <code>startActivity()</code> 即实现是委托给 ContextImpl 的。这里有个需要注意的地方：</p>\n<p>在 Android 26 上，如果使用 Application 启动 Activity，而没有添加 <code>Intent.FLAG_ACTIVITY_NEW_TASK</code> 标记的话，则会抛出以下异常：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Caused by: android.util.AndroidRuntimeException: Calling startActivity() from outside of an Activity  context requires the FLAG_ACTIVITY_NEW_TASK flag. Is this really what you want?</span><br></pre></td></tr></table></figure>\n\n<p>Android 26 上 ContextImpl 的相关代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivity</span><span class=\"params\">(Intent intent, Bundle options)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((intent.getFlags()&amp;Intent.FLAG_ACTIVITY_NEW_TASK) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">AndroidRuntimeException</span>(</span><br><span class=\"line\">                    <span class=\"string\">&quot;Calling startActivity() from outside of an Activity &quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot; context requires the FLAG_ACTIVITY_NEW_TASK flag.&quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot; Is this really what you want?&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>只要没有添加 <code>Intent.FLAG_ACTIVITY_NEW_TASK</code> 标记就会抛异常。</p>\n<p>而在 Android 27 上，则有些区别，同样是 ContextImpl 的源码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivity</span><span class=\"params\">(Intent intent, Bundle options)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((intent.getFlags()&amp;Intent.FLAG_ACTIVITY_NEW_TASK) == <span class=\"number\">0</span></span><br><span class=\"line\">        &amp;&amp; options != <span class=\"literal\">null</span> &amp;&amp; ActivityOptions.fromBundle(options).getLaunchTaskId() == -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">AndroidRuntimeException</span>(</span><br><span class=\"line\">                    <span class=\"string\">&quot;Calling startActivity() from outside of an Activity &quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot; context requires the FLAG_ACTIVITY_NEW_TASK flag.&quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot; Is this really what you want?&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>只有在指定了 <code>options</code> 同时其中没有指定 LaunchTaskId 才会抛异常。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>上面我们列举了不同 Context 的初始化过程，比如最常见的 Activity Context 和 Application Context，同时对不同 Context 的使用场景进行比较，相信看完文章的同学，对 Context 有了更多的理解。</p>\n<p>不管如何谨慎小心，怀着诚惶诚恐的心态写作，但是毕竟作者的水平有限，如果有写的不对的地方，敬请指教，先行感谢。</p>\n"},{"title":"触摸事件实践之路","date":"2018-04-03T01:17:20.000Z","_content":"\n## 前言\n\n最近帮公司面试 Android 岗位，面试的同学大部分具有两年以上的工作经验，但发现很多同学对触摸事件的分发都不是很熟悉，有的可能还能照本宣科地说个七七八八，有的却完全不熟悉，这让我感觉到诧异，因为我认为这 Android 中非常基础的知识，不仅要熟悉其中的分发流程，还要能实现简单的涉及手势处理的自定义控件。所以，这也是这篇文章的目的，希望能通过一些触摸事件处理的实际例子，来加深对触摸事件分发的理解，同时能实现相关需求。\n\n## 触摸事件简单回顾\n\n我们都知道触摸事件的分发严格意义上讲，是从 Activity 开始进行分发，但一般我们谈论的，只从 ViewGroup 开始分发。\n\n![TouchEvent](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/TouchEvent.png?x-oss-process=style/doc-img)\n\n上面的图只是粗略地画出触摸事件的分发流程，从 ViewGroup 的 `dispatchTouchEvent` 开始分发，先判断 ViewGroup 的 `onInterceptTouchEvent` 是否拦截，同时这里也可以调用 ViewGroup 的 `requestDisallowInterceptTouchEvent` 让 ViewGroup 不调用 `onInterceptTouchEvent`，如果事件被拦截，则调用 ViewGroup 的超类即 View 的 `dispatchTouchEvent`，反之，则调用子视图的 `dispatchTouchEvent`，注意：这里我们做了简单处理，假设当前 ViewGroup 的子视图为 View，如果子视图为 ViewGroup，那么还是先执行 ViewGroup 的 `dispatchTouchEvent`。\n\n最终都会调用到 View 的 `onTouchEvent` 中，这个方法是真正处理触摸事件的，一般如果我们需要自己处理触摸事件，也是在这个方法中处理。\n\n## 手势判定\n\n上面我们简单回顾了触摸事件分发，具体细节可以看下源码。其实上面所讲的分发流程，很多同学都能说出个大概，但就是在动手写的时候，不知道如何入手。\n\n当我们在日常开发中，如果遇到不知道怎么实现的需求时，最直接的方法就是阅读他人的源码，不管是个人的库也好，Google 提供的库也好，设计良好的源码抵过看一大堆的博客。在实现需要处理触摸事件的需求也是一个道理，Android SDK 已经提供了 ListView，RecyclerView，ScrollView 等等涉及拖动处理的系统控件，所以我们可以从阅读这类控件的源码入手，看看系统控件是如何处理触摸事件的。这里我们选择 ScrollView 来简单分析下：\n\nScrollView 继承于 FrameLayout，属于 ViewGroup 控件，所以有 `onInterceptTouchEvent`\n\n> 因为篇幅有限，所以我们会省略去无关紧要的代码，各位同学可以对照着源码进行分析。\n>\n> 源码部分基于 Android 26\n\n### onInterceptTouchEvent\n\n``` java\nif ((action == MotionEvent.ACTION_MOVE) && (mIsBeingDragged)) {\n    return true;\n}\n```\n\n用 `mIsBeingDragged` 变量来保存当前是否已经开始进行拖动手势，这个后面会讲到，同时当前分发事件类型为 `ACTION_MOVE`，那么直接返回 true，即拦截事件向子视图进行分发。这个是一个快捷的判断，省去了后面再进行一系列的判断，这个是个小技巧，我们在实现自定义控件的时候也可以用上。接下来的分析，为了更清晰，我们分为不同类型的 Touch Action 进行阅读。\n\n#### TOUCH_DOWN\n\n``` java\nif (!inChild((int) ev.getX(), (int) y)) {\n    mIsBeingDragged = false;\n    recycleVelocityTracker();\n    break;\n}\n```\n\n这段代码很简单，如果触摸事件没有作用于子视图范围内，那么就不处理，同时释放速度跟踪器，这个后面会讲到，一般用于 fling 手势的判定。\n\n``` java\nmLastMotionY = y;\nmActivePointerId = ev.getPointerId(0);\ninitOrResetVelocityTracker();\nmVelocityTracker.addMovement(ev);\n\nmScroller.computeScrollOffset();\nmIsBeingDragged = !mScroller.isFinished();\n\nstartNestedScroll(SCROLL_AXIS_VERTICAL);\n```\n\n这段代码主要是用于初始化判定之前的资源，比如 `mLastMotionY` 记录按下时的坐标信息，`mActivePointerId` 记录当前分发触摸事件的手指 id，这个一般用于多指的处理，`initOrResetVelocityTracker` 初始化速度跟踪器，同时使用 `addMovement` 记录当前触摸事件信息，`mScroller` 是一般用于 fling 手势处理，这里的作用是处理上一次的 fling，`startNestedScroll` 则是嵌套滚动机制的知识了，嵌套滚动机制也不难理解，但这里我们先不涉及，相信理解基础的触摸事件知识后，这个只要稍微阅读下源码，就能理解的，说句题外话，虽然嵌套滚动很容易理解，作用却非常大，基本解决了大部分的滑动冲突场景。\n\n#### TOUCH_MOVE\n\n```java\nfinal int activePointerId = mActivePointerId;\nif (activePointerId == INVALID_POINTER) {\n    break;\n}\nfinal int pointerIndex = ev.findPointerIndex(activePointerId);\nif (pointerIndex == -1) {\n    break;\n}\nfinal int y = (int) ev.getY(pointerIndex);\nfinal int yDiff = Math.abs(y - mLastMotionY);\nif (yDiff > mTouchSlop && (getNestedScrollAxes() & SCROLL_AXIS_VERTICAL) == 0) {\n    mIsBeingDragged = true;\n    mLastMotionY = y;\n    initVelocityTrackerIfNotExists();\n    mVelocityTracker.addMovement(ev);\n    final ViewParent parent = getParent();\n    if (parent != null) {\n        parent.requestDisallowInterceptTouchEvent(true);\n    }\n}\n```\n\n这段代码先使用我们在 `TOUCH_DOWN` 中记录的  `mActivePointerId` 进行是否为有效的判断，如果有效，则通过 `findPointerIndex` 获取作用手指 id 的下标，记录为  `pointerIndex` ，为什么要获取这个值，我们知道现在的手机屏幕都是支持多指触摸的，所以我们需要根据某个按下的手指的触摸信息来进行处理。`yDiff` 是滑动的距离，`mTouchSlop` 则是 SDK 定义的可作为判定是否开始进行拖动的距离常量，可以通过 ViewConfiguration 的 `getScaledTouchSlop` 获取，如果大于这个值，我们可以认为开始了拖动的手势。 `getNestedScrollAxes` 这个同样是用于嵌套滚动机制的，可以略过。如果开始了拖动手势，`mIsBeingDragged` 标记为 `true`，同样使用速度跟踪器记录信息，这里还会调用 ViewParent 的 `requestDisallowInterceptTouchEvent`，防止父视图拦截了事件，即 `onInterceptTouchEvent`\n\n#### TOUCH_CANCEL && TOUCH_UP\n\n``` java\nmIsBeingDragged = false;\nmActivePointerId = INVALID_POINTER;\nrecycleVelocityTracker();\nstopNestedScroll();\n```\n\n一般我们都会在 `TOUCH_CANCEL` 和 `TOUCH_UP` 这两个类型的触摸事件分发中，进行一些释放资源的操作，比如 `mIsBeingDragged` 设置为 `false`，释放速度跟踪器等等 \n\n> `TOUCH_UP` 是所有的手指(多指触摸)抬起时分发的事件，这个比较好理解，而 `TOUCH_CANCEL` 则是触摸取消事件类型，一般什么时候会分发这个事件呢？举个例子，如果某个子视图已经消费了 `TOUCH_DOWN`，即在这个事件分发时，向父视图传递了 `true` 的返回值，那么一般情况下，父视图不会再拦截接下来的事件，比如 `ACTION_MOVE` 等，但是如果父视图在这种情况下，还拦截了事件传递，即在 `onInterceptTouch` 中返回了 `true`，那么在 ViewGroup 的 `dispatchTouchEvent` 中会给已经确认消费事件的子视图分发一个 `TOUCH_CANCEL` 的事件，具体可以阅读源码。\n\n#### ACTION_POINTER_UP\n\n这个为多指触摸时，某个手指抬起时分发的事件。\n\n``` java\nfinal int pointerIndex = (ev.getAction() & MotionEvent.ACTION_POINTER_INDEX_MASK) >>\n                MotionEvent.ACTION_POINTER_INDEX_SHIFT;\nfinal int pointerId = ev.getPointerId(pointerIndex);\nif (pointerId == mActivePointerId) {\n    final int newPointerIndex = pointerIndex == 0 ? 1 : 0;\n    mLastMotionY = (int) ev.getY(newPointerIndex);\n    mActivePointerId = ev.getPointerId(newPointerIndex);\n    if (mVelocityTracker != null) {\n        mVelocityTracker.clear();\n    }\n}\n```\n\n这段代码处理的是，当某个手指抬起时，而这个手指刚好是我们当前使用的，则重新初始化资源\n\n#### 小结\n\n我们可以简单总结下，`onInterceptTouchEvent` 所进行的处理，即在 `TOUCH_DOWN` 资源初始化，`TOUCH_MOVE` 判断是否开始拖动手势，`TOUCH_CANCEL` && `TOUCH_UP` 中进行资源释放。这里涉及了多指触摸的处理。\n\n### onTouchEvent\n\n`onTouchEvent` 要比 `onInterceptTouch` 的逻辑更复杂，因为这个方法是用于真正的消费触摸事件。同样的，我们只关心核心代码，略去无关紧要的代码片段。\n\n#### TOUCH_DOWN\n\n``` java\nif (getChildCount() == 0) {\n    return false;\n}\nif ((mIsBeingDragged = !mScroller.isFinished())) {\n    final ViewParent parent = getParent();\n    if (parent != null) {\n        parent.requestDisallowInterceptTouchEvent(true);\n    }\n}\n\nif (!mScroller.isFinished()) {\n    mScroller.abortAnimation();\n}\n\nmLastMotionY = (int) ev.getY();\nmActivePointerId = ev.getPointerId(0);\n```\n\n同样的，`onTouchEvent` 在 `TOUCH_DOWN` 事件分发中，主要是进行资源初始化，同时也处理上一次的 fling 任务，比如调用 Scroller 的 `abortAnimation`，如果 Scroller 还没结束 fling 计算，则中止处理。\n\n#### TOUCH_MOVE\n\n``` java\nfinal int activePointerIndex = ev.findPointerIndex(mActivePointerId);\nif (activePointerIndex == -1) {\n    break;\n}\nfinal int y = (int) ev.getY(activePointerIndex);\nint deltaY = mLastMotionY - y;\nif (dispatchNestedPreScroll(0, deltaY, mScrollConsumed, mScrollOffset)) {\n    // 嵌套滚动处理\n    deltaY -= mScrollConsumed[1];\n    vtev.offsetLocation(0, mScrollOffset[1]);\n    mNestedYOffset += mScrollOffset[1];\n}\n    if (!mIsBeingDragged && Math.abs(deltaY) > mTouchSlop) {\n        final ViewParent parent = getParent();\n        if (parent != null) {\n            parent.requestDisallowInterceptTouchEvent(true);\n        }\n        mIsBeingDragged = true;\n        if (deltaY > 0) {\n            deltaY -= mTouchSlop;\n        } else {\n            deltaY += mTouchSlop;\n        }\n    }\n    \n    if (mIsBeingDragged) {\n        /// 业务逻辑\n    }\n```\n\n这段代码同样会进行多指处理，获取指定手指的触摸事件信息。`mIsBeingDragged` 为 `false`，同时会再进行一次拖动手势的判定，判定逻辑和 `onInterceptTouchEvent` 中类似，如果 `mIsBeingDragged` 为 `true`，则开始进行真正的逻辑处理。\n\n> EdgeEffect 是用于拖动时，边缘的阴影效果，具体使用可以参考源码\n\n#### TOUCH_UP\n\n``` java\nif (mIsBeingDragged) {\n    final VelocityTracker velocityTracker = mVelocityTracker;\n\tvelocityTracker.computeCurrentVelocity(1000, mMaximumVelocity);\n    int initialVelocity = (int) velocityTracker.getYVelocity(mActivePointerId);\n    \n    if ((Math.abs(initialVelocity) > mMinimumVelocity)) {\n    \tflingWithNestedDispatch(-initialVelocity);\n    }\n    \n    mActivePointerId = INVALID_POINTER;\n    endDrag();\n}\n```\n\n当手指全部抬起时，可以使用速度跟踪器进行 fling 手势的判定，同时释放资源。通过 `getYVelocity` 获取速度，在判断是否可以作为 fling 手势处理，`mMaximumVelocity` 是处理的最大速度，`mMinimumVelocity` 是处理的最小速度，这两个值同样可以通过 ViewConfiguration 的 `getScaledMaximumFlingVelocity` 和 `getScaledMinimumFlingVelocity` 获取。一般情况对 fling 的处理是通过 Scroller 进行处理的，因为这里涉及复杂的数学知识，而 Scroller 可以帮我们简化这里的操作，使用如下：\n\n``` java\nint height = getHeight() - mPaddingBottom - mPaddingTop;\nint bottom = getChildAt(0).getHeight();\n\nmScroller.fling(mScrollX, mScrollY, 0, velocityY, 0, 0, 0,\n                    Math.max(0, bottom - height), 0, height/2);\n\npostInvalidateOnAnimation();\n```\n\n通过传递当前拖动手势速度值来调用 `fling` 进行处理，然后在 `computeScrollOffset` 方法中，进行真正的滚动处理：\n\n``` java\npublic void computeScroll() {\n    if (mScroller.computeScrollOffset()) {\n      \t// 逻辑处理\n        int x = mScroller.getCurrX();\n        int y = mScroller.getCurrY();\n        postInvalidateOnAnimation();\n    }\n}\n```\n\n首先我们要知道 Scroller 并不会为我们进行滚动处理，它只是提供了计算的模型，通过调用 `computeScrollOffset` 进行计算，如果返回 `true`，表示计算还没结束，然后通过 `getCurrX` 或 `getCurrY` 获取计算后的值，最后进行真正的滚动处理，比如调用 `scrollTo` 等等，这里需要注意的是，需要调用 `invalidate` 来确保进行下一次的 `computeScroll` 调用，这里使用的 `postInvalidateOnAnimation` 其作用是类似的。\n\n#### TOUCH_CANCEL\n\n``` java\nif (mIsBeingDragged && getChildCount() > 0) {\n    if (mScroller.springBack(mScrollX, mScrollY, 0, 0, 0, getScrollRange())) {\n        postInvalidateOnAnimation();\n    }\n    mActivePointerId = INVALID_POINTER;\n    endDrag();\n}\n```\n\n同样的，一般我们都会在 `TOUCH_CANCEL` 中释放资源。\n\n#### ACTION_POINTER_DOWN\n\n当有新的手指按下时分发的事件\n\n``` java\nfinal int index = ev.getActionIndex();\nmLastMotionY = (int) ev.getY(index);\nmActivePointerId = ev.getPointerId(index);\n```\n\n以新按下的手指的信息重新计算\n\n#### ACTION_POINTER_UP\n\n这里的处理和 `onInterceptTouch` 一致\n\n#### 小结\n\n`onTouchEvent` 和 `onInterceptTouchEvent` 处理有些相似，主要是在 `TOUCH_MOVE` 中在判定为拖动手势后进行真正的业务逻辑处理，同时在 `TOUCH_UP` 中根据速度跟踪器的获取的速度，判定是否符合 fling 手势，如果符合，则使用 Scroller 进行计算。\n\n### 总结\n\n在分析完 ScrollView 的触摸事件处理，我们应该对事件处理有个基本理解，可以按照这个思路去分析其他的类似的系统控件，比如 `NestedScrollView`、`RecyclerView`  等等，我们可以发现处理的思路基本一致，那我们是不是可以将这些判定逻辑封装下呢？是的，并且系统已经提供 GestureDetector 来进行手势的判定，我们只需要在相应的手势回调方法中进行我们的业务逻辑即可。还有更强大的 `ViewDragHelper` ，但不管怎样，只要能理解好触摸事件分发，对工具类的熟练使用就不在话下。\n\n## 实战\n\n理论说的再多，也是纸上谈兵，只有真正去实践，才能熟练掌握。因为业务需求或者兴趣爱好，我写了以下两个自定义控件，正好一个是纵向滑动和一个是横向滑动，效果如下：\n\n![WheelView](https://user-gold-cdn.xitu.io/2018/2/22/161bd1e1f4774f80?imageslim)\n\n![TapeView](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/more.gif?x-oss-process=style/doc-img)\n\n详细的代码分析我们就不进行了，因为阅读源码是最快的方式，第一个是[滚轮控件](https://github.com/LinXiaoTao/WheelView)，第二个是之前参加活动的仿薄荷健康的[卷尺控件](https://github.com/LinXiaoTao/CustomViewProject/blob/master/app/src/main/java/com/leo/customviewproject/tape/README.md)。在这里我们只分析部分代码：\n\n### 滚轮控件\n\n在前面手势判定中的分析中，我们提到在 `onTouchEvent` 判定拖动手势成功后，进行真正的业务逻辑处理，在这个控件中也是一样的：\n\n``` java\nif (mIsBeingDragged) {\n    mDistanceY += mLastY - moveY;\n    postInvalidateOnAnimation();\n}\n```\n\n在每次 `TOUCH_MOVE` 事件分发时，计算与 `TOUCH_DOWN` 时记录的位置信息的差值，保存为 `mDistanceY`，并且在 `onDraw` 中使用这个值对 Canvas 进行位移，绘制新位置的 UI。\n\n### 卷尺控件\n\n拖动距离的计算与滚轮控件一样，只是记录为 `mOffsetLeft` 而已，同时两个控件都有在 `onTouchEvent` 的 `ACTION_UP` 事件分发中，处理 fling 手势。不过卷尺控件有使用 EdgeEffect 处理边缘效果，有兴趣的同学可以看下。\n\n## 结语\n\n文章的主要目的并不在于教会怎么去处理触摸事件的分发，只是希望通过这个例子，大家能养成阅读源码的习惯，不管是系统 SDK 也好，第三方库也好，只要把核心知识掌握，就能熟练使用各种现成的工具库，并且达到举一反三的效果。\n\n但是理论知识再多也是纸上谈兵，最重要的是实践，具体实践可以这样做：先理解好触摸事件分发流程，然后选择一个控件，可以是系统控件，也可以是其他控件，只要涉及触摸事件处理就行，进行阅读，然后手动实现一个相反方向滚动的控件，比如，你阅读的是纵向滑动的控件，那么就实现一个横向滑动的控件。这个自定义控件需要实现以下效果：\n\n* 最基本的拖动手势处理\n* fling 效果实现\n* 如果可以，再实现边缘效果\n\n感谢大家的阅读。\n\n\n\n","source":"_posts/触摸事件实践之路.md","raw":"---\ntitle: 触摸事件实践之路\ndate: 2018-04-03 09:17:20\ncategories: Android\ntags: \n---\n\n## 前言\n\n最近帮公司面试 Android 岗位，面试的同学大部分具有两年以上的工作经验，但发现很多同学对触摸事件的分发都不是很熟悉，有的可能还能照本宣科地说个七七八八，有的却完全不熟悉，这让我感觉到诧异，因为我认为这 Android 中非常基础的知识，不仅要熟悉其中的分发流程，还要能实现简单的涉及手势处理的自定义控件。所以，这也是这篇文章的目的，希望能通过一些触摸事件处理的实际例子，来加深对触摸事件分发的理解，同时能实现相关需求。\n\n## 触摸事件简单回顾\n\n我们都知道触摸事件的分发严格意义上讲，是从 Activity 开始进行分发，但一般我们谈论的，只从 ViewGroup 开始分发。\n\n![TouchEvent](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/TouchEvent.png?x-oss-process=style/doc-img)\n\n上面的图只是粗略地画出触摸事件的分发流程，从 ViewGroup 的 `dispatchTouchEvent` 开始分发，先判断 ViewGroup 的 `onInterceptTouchEvent` 是否拦截，同时这里也可以调用 ViewGroup 的 `requestDisallowInterceptTouchEvent` 让 ViewGroup 不调用 `onInterceptTouchEvent`，如果事件被拦截，则调用 ViewGroup 的超类即 View 的 `dispatchTouchEvent`，反之，则调用子视图的 `dispatchTouchEvent`，注意：这里我们做了简单处理，假设当前 ViewGroup 的子视图为 View，如果子视图为 ViewGroup，那么还是先执行 ViewGroup 的 `dispatchTouchEvent`。\n\n最终都会调用到 View 的 `onTouchEvent` 中，这个方法是真正处理触摸事件的，一般如果我们需要自己处理触摸事件，也是在这个方法中处理。\n\n## 手势判定\n\n上面我们简单回顾了触摸事件分发，具体细节可以看下源码。其实上面所讲的分发流程，很多同学都能说出个大概，但就是在动手写的时候，不知道如何入手。\n\n当我们在日常开发中，如果遇到不知道怎么实现的需求时，最直接的方法就是阅读他人的源码，不管是个人的库也好，Google 提供的库也好，设计良好的源码抵过看一大堆的博客。在实现需要处理触摸事件的需求也是一个道理，Android SDK 已经提供了 ListView，RecyclerView，ScrollView 等等涉及拖动处理的系统控件，所以我们可以从阅读这类控件的源码入手，看看系统控件是如何处理触摸事件的。这里我们选择 ScrollView 来简单分析下：\n\nScrollView 继承于 FrameLayout，属于 ViewGroup 控件，所以有 `onInterceptTouchEvent`\n\n> 因为篇幅有限，所以我们会省略去无关紧要的代码，各位同学可以对照着源码进行分析。\n>\n> 源码部分基于 Android 26\n\n### onInterceptTouchEvent\n\n``` java\nif ((action == MotionEvent.ACTION_MOVE) && (mIsBeingDragged)) {\n    return true;\n}\n```\n\n用 `mIsBeingDragged` 变量来保存当前是否已经开始进行拖动手势，这个后面会讲到，同时当前分发事件类型为 `ACTION_MOVE`，那么直接返回 true，即拦截事件向子视图进行分发。这个是一个快捷的判断，省去了后面再进行一系列的判断，这个是个小技巧，我们在实现自定义控件的时候也可以用上。接下来的分析，为了更清晰，我们分为不同类型的 Touch Action 进行阅读。\n\n#### TOUCH_DOWN\n\n``` java\nif (!inChild((int) ev.getX(), (int) y)) {\n    mIsBeingDragged = false;\n    recycleVelocityTracker();\n    break;\n}\n```\n\n这段代码很简单，如果触摸事件没有作用于子视图范围内，那么就不处理，同时释放速度跟踪器，这个后面会讲到，一般用于 fling 手势的判定。\n\n``` java\nmLastMotionY = y;\nmActivePointerId = ev.getPointerId(0);\ninitOrResetVelocityTracker();\nmVelocityTracker.addMovement(ev);\n\nmScroller.computeScrollOffset();\nmIsBeingDragged = !mScroller.isFinished();\n\nstartNestedScroll(SCROLL_AXIS_VERTICAL);\n```\n\n这段代码主要是用于初始化判定之前的资源，比如 `mLastMotionY` 记录按下时的坐标信息，`mActivePointerId` 记录当前分发触摸事件的手指 id，这个一般用于多指的处理，`initOrResetVelocityTracker` 初始化速度跟踪器，同时使用 `addMovement` 记录当前触摸事件信息，`mScroller` 是一般用于 fling 手势处理，这里的作用是处理上一次的 fling，`startNestedScroll` 则是嵌套滚动机制的知识了，嵌套滚动机制也不难理解，但这里我们先不涉及，相信理解基础的触摸事件知识后，这个只要稍微阅读下源码，就能理解的，说句题外话，虽然嵌套滚动很容易理解，作用却非常大，基本解决了大部分的滑动冲突场景。\n\n#### TOUCH_MOVE\n\n```java\nfinal int activePointerId = mActivePointerId;\nif (activePointerId == INVALID_POINTER) {\n    break;\n}\nfinal int pointerIndex = ev.findPointerIndex(activePointerId);\nif (pointerIndex == -1) {\n    break;\n}\nfinal int y = (int) ev.getY(pointerIndex);\nfinal int yDiff = Math.abs(y - mLastMotionY);\nif (yDiff > mTouchSlop && (getNestedScrollAxes() & SCROLL_AXIS_VERTICAL) == 0) {\n    mIsBeingDragged = true;\n    mLastMotionY = y;\n    initVelocityTrackerIfNotExists();\n    mVelocityTracker.addMovement(ev);\n    final ViewParent parent = getParent();\n    if (parent != null) {\n        parent.requestDisallowInterceptTouchEvent(true);\n    }\n}\n```\n\n这段代码先使用我们在 `TOUCH_DOWN` 中记录的  `mActivePointerId` 进行是否为有效的判断，如果有效，则通过 `findPointerIndex` 获取作用手指 id 的下标，记录为  `pointerIndex` ，为什么要获取这个值，我们知道现在的手机屏幕都是支持多指触摸的，所以我们需要根据某个按下的手指的触摸信息来进行处理。`yDiff` 是滑动的距离，`mTouchSlop` 则是 SDK 定义的可作为判定是否开始进行拖动的距离常量，可以通过 ViewConfiguration 的 `getScaledTouchSlop` 获取，如果大于这个值，我们可以认为开始了拖动的手势。 `getNestedScrollAxes` 这个同样是用于嵌套滚动机制的，可以略过。如果开始了拖动手势，`mIsBeingDragged` 标记为 `true`，同样使用速度跟踪器记录信息，这里还会调用 ViewParent 的 `requestDisallowInterceptTouchEvent`，防止父视图拦截了事件，即 `onInterceptTouchEvent`\n\n#### TOUCH_CANCEL && TOUCH_UP\n\n``` java\nmIsBeingDragged = false;\nmActivePointerId = INVALID_POINTER;\nrecycleVelocityTracker();\nstopNestedScroll();\n```\n\n一般我们都会在 `TOUCH_CANCEL` 和 `TOUCH_UP` 这两个类型的触摸事件分发中，进行一些释放资源的操作，比如 `mIsBeingDragged` 设置为 `false`，释放速度跟踪器等等 \n\n> `TOUCH_UP` 是所有的手指(多指触摸)抬起时分发的事件，这个比较好理解，而 `TOUCH_CANCEL` 则是触摸取消事件类型，一般什么时候会分发这个事件呢？举个例子，如果某个子视图已经消费了 `TOUCH_DOWN`，即在这个事件分发时，向父视图传递了 `true` 的返回值，那么一般情况下，父视图不会再拦截接下来的事件，比如 `ACTION_MOVE` 等，但是如果父视图在这种情况下，还拦截了事件传递，即在 `onInterceptTouch` 中返回了 `true`，那么在 ViewGroup 的 `dispatchTouchEvent` 中会给已经确认消费事件的子视图分发一个 `TOUCH_CANCEL` 的事件，具体可以阅读源码。\n\n#### ACTION_POINTER_UP\n\n这个为多指触摸时，某个手指抬起时分发的事件。\n\n``` java\nfinal int pointerIndex = (ev.getAction() & MotionEvent.ACTION_POINTER_INDEX_MASK) >>\n                MotionEvent.ACTION_POINTER_INDEX_SHIFT;\nfinal int pointerId = ev.getPointerId(pointerIndex);\nif (pointerId == mActivePointerId) {\n    final int newPointerIndex = pointerIndex == 0 ? 1 : 0;\n    mLastMotionY = (int) ev.getY(newPointerIndex);\n    mActivePointerId = ev.getPointerId(newPointerIndex);\n    if (mVelocityTracker != null) {\n        mVelocityTracker.clear();\n    }\n}\n```\n\n这段代码处理的是，当某个手指抬起时，而这个手指刚好是我们当前使用的，则重新初始化资源\n\n#### 小结\n\n我们可以简单总结下，`onInterceptTouchEvent` 所进行的处理，即在 `TOUCH_DOWN` 资源初始化，`TOUCH_MOVE` 判断是否开始拖动手势，`TOUCH_CANCEL` && `TOUCH_UP` 中进行资源释放。这里涉及了多指触摸的处理。\n\n### onTouchEvent\n\n`onTouchEvent` 要比 `onInterceptTouch` 的逻辑更复杂，因为这个方法是用于真正的消费触摸事件。同样的，我们只关心核心代码，略去无关紧要的代码片段。\n\n#### TOUCH_DOWN\n\n``` java\nif (getChildCount() == 0) {\n    return false;\n}\nif ((mIsBeingDragged = !mScroller.isFinished())) {\n    final ViewParent parent = getParent();\n    if (parent != null) {\n        parent.requestDisallowInterceptTouchEvent(true);\n    }\n}\n\nif (!mScroller.isFinished()) {\n    mScroller.abortAnimation();\n}\n\nmLastMotionY = (int) ev.getY();\nmActivePointerId = ev.getPointerId(0);\n```\n\n同样的，`onTouchEvent` 在 `TOUCH_DOWN` 事件分发中，主要是进行资源初始化，同时也处理上一次的 fling 任务，比如调用 Scroller 的 `abortAnimation`，如果 Scroller 还没结束 fling 计算，则中止处理。\n\n#### TOUCH_MOVE\n\n``` java\nfinal int activePointerIndex = ev.findPointerIndex(mActivePointerId);\nif (activePointerIndex == -1) {\n    break;\n}\nfinal int y = (int) ev.getY(activePointerIndex);\nint deltaY = mLastMotionY - y;\nif (dispatchNestedPreScroll(0, deltaY, mScrollConsumed, mScrollOffset)) {\n    // 嵌套滚动处理\n    deltaY -= mScrollConsumed[1];\n    vtev.offsetLocation(0, mScrollOffset[1]);\n    mNestedYOffset += mScrollOffset[1];\n}\n    if (!mIsBeingDragged && Math.abs(deltaY) > mTouchSlop) {\n        final ViewParent parent = getParent();\n        if (parent != null) {\n            parent.requestDisallowInterceptTouchEvent(true);\n        }\n        mIsBeingDragged = true;\n        if (deltaY > 0) {\n            deltaY -= mTouchSlop;\n        } else {\n            deltaY += mTouchSlop;\n        }\n    }\n    \n    if (mIsBeingDragged) {\n        /// 业务逻辑\n    }\n```\n\n这段代码同样会进行多指处理，获取指定手指的触摸事件信息。`mIsBeingDragged` 为 `false`，同时会再进行一次拖动手势的判定，判定逻辑和 `onInterceptTouchEvent` 中类似，如果 `mIsBeingDragged` 为 `true`，则开始进行真正的逻辑处理。\n\n> EdgeEffect 是用于拖动时，边缘的阴影效果，具体使用可以参考源码\n\n#### TOUCH_UP\n\n``` java\nif (mIsBeingDragged) {\n    final VelocityTracker velocityTracker = mVelocityTracker;\n\tvelocityTracker.computeCurrentVelocity(1000, mMaximumVelocity);\n    int initialVelocity = (int) velocityTracker.getYVelocity(mActivePointerId);\n    \n    if ((Math.abs(initialVelocity) > mMinimumVelocity)) {\n    \tflingWithNestedDispatch(-initialVelocity);\n    }\n    \n    mActivePointerId = INVALID_POINTER;\n    endDrag();\n}\n```\n\n当手指全部抬起时，可以使用速度跟踪器进行 fling 手势的判定，同时释放资源。通过 `getYVelocity` 获取速度，在判断是否可以作为 fling 手势处理，`mMaximumVelocity` 是处理的最大速度，`mMinimumVelocity` 是处理的最小速度，这两个值同样可以通过 ViewConfiguration 的 `getScaledMaximumFlingVelocity` 和 `getScaledMinimumFlingVelocity` 获取。一般情况对 fling 的处理是通过 Scroller 进行处理的，因为这里涉及复杂的数学知识，而 Scroller 可以帮我们简化这里的操作，使用如下：\n\n``` java\nint height = getHeight() - mPaddingBottom - mPaddingTop;\nint bottom = getChildAt(0).getHeight();\n\nmScroller.fling(mScrollX, mScrollY, 0, velocityY, 0, 0, 0,\n                    Math.max(0, bottom - height), 0, height/2);\n\npostInvalidateOnAnimation();\n```\n\n通过传递当前拖动手势速度值来调用 `fling` 进行处理，然后在 `computeScrollOffset` 方法中，进行真正的滚动处理：\n\n``` java\npublic void computeScroll() {\n    if (mScroller.computeScrollOffset()) {\n      \t// 逻辑处理\n        int x = mScroller.getCurrX();\n        int y = mScroller.getCurrY();\n        postInvalidateOnAnimation();\n    }\n}\n```\n\n首先我们要知道 Scroller 并不会为我们进行滚动处理，它只是提供了计算的模型，通过调用 `computeScrollOffset` 进行计算，如果返回 `true`，表示计算还没结束，然后通过 `getCurrX` 或 `getCurrY` 获取计算后的值，最后进行真正的滚动处理，比如调用 `scrollTo` 等等，这里需要注意的是，需要调用 `invalidate` 来确保进行下一次的 `computeScroll` 调用，这里使用的 `postInvalidateOnAnimation` 其作用是类似的。\n\n#### TOUCH_CANCEL\n\n``` java\nif (mIsBeingDragged && getChildCount() > 0) {\n    if (mScroller.springBack(mScrollX, mScrollY, 0, 0, 0, getScrollRange())) {\n        postInvalidateOnAnimation();\n    }\n    mActivePointerId = INVALID_POINTER;\n    endDrag();\n}\n```\n\n同样的，一般我们都会在 `TOUCH_CANCEL` 中释放资源。\n\n#### ACTION_POINTER_DOWN\n\n当有新的手指按下时分发的事件\n\n``` java\nfinal int index = ev.getActionIndex();\nmLastMotionY = (int) ev.getY(index);\nmActivePointerId = ev.getPointerId(index);\n```\n\n以新按下的手指的信息重新计算\n\n#### ACTION_POINTER_UP\n\n这里的处理和 `onInterceptTouch` 一致\n\n#### 小结\n\n`onTouchEvent` 和 `onInterceptTouchEvent` 处理有些相似，主要是在 `TOUCH_MOVE` 中在判定为拖动手势后进行真正的业务逻辑处理，同时在 `TOUCH_UP` 中根据速度跟踪器的获取的速度，判定是否符合 fling 手势，如果符合，则使用 Scroller 进行计算。\n\n### 总结\n\n在分析完 ScrollView 的触摸事件处理，我们应该对事件处理有个基本理解，可以按照这个思路去分析其他的类似的系统控件，比如 `NestedScrollView`、`RecyclerView`  等等，我们可以发现处理的思路基本一致，那我们是不是可以将这些判定逻辑封装下呢？是的，并且系统已经提供 GestureDetector 来进行手势的判定，我们只需要在相应的手势回调方法中进行我们的业务逻辑即可。还有更强大的 `ViewDragHelper` ，但不管怎样，只要能理解好触摸事件分发，对工具类的熟练使用就不在话下。\n\n## 实战\n\n理论说的再多，也是纸上谈兵，只有真正去实践，才能熟练掌握。因为业务需求或者兴趣爱好，我写了以下两个自定义控件，正好一个是纵向滑动和一个是横向滑动，效果如下：\n\n![WheelView](https://user-gold-cdn.xitu.io/2018/2/22/161bd1e1f4774f80?imageslim)\n\n![TapeView](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/more.gif?x-oss-process=style/doc-img)\n\n详细的代码分析我们就不进行了，因为阅读源码是最快的方式，第一个是[滚轮控件](https://github.com/LinXiaoTao/WheelView)，第二个是之前参加活动的仿薄荷健康的[卷尺控件](https://github.com/LinXiaoTao/CustomViewProject/blob/master/app/src/main/java/com/leo/customviewproject/tape/README.md)。在这里我们只分析部分代码：\n\n### 滚轮控件\n\n在前面手势判定中的分析中，我们提到在 `onTouchEvent` 判定拖动手势成功后，进行真正的业务逻辑处理，在这个控件中也是一样的：\n\n``` java\nif (mIsBeingDragged) {\n    mDistanceY += mLastY - moveY;\n    postInvalidateOnAnimation();\n}\n```\n\n在每次 `TOUCH_MOVE` 事件分发时，计算与 `TOUCH_DOWN` 时记录的位置信息的差值，保存为 `mDistanceY`，并且在 `onDraw` 中使用这个值对 Canvas 进行位移，绘制新位置的 UI。\n\n### 卷尺控件\n\n拖动距离的计算与滚轮控件一样，只是记录为 `mOffsetLeft` 而已，同时两个控件都有在 `onTouchEvent` 的 `ACTION_UP` 事件分发中，处理 fling 手势。不过卷尺控件有使用 EdgeEffect 处理边缘效果，有兴趣的同学可以看下。\n\n## 结语\n\n文章的主要目的并不在于教会怎么去处理触摸事件的分发，只是希望通过这个例子，大家能养成阅读源码的习惯，不管是系统 SDK 也好，第三方库也好，只要把核心知识掌握，就能熟练使用各种现成的工具库，并且达到举一反三的效果。\n\n但是理论知识再多也是纸上谈兵，最重要的是实践，具体实践可以这样做：先理解好触摸事件分发流程，然后选择一个控件，可以是系统控件，也可以是其他控件，只要涉及触摸事件处理就行，进行阅读，然后手动实现一个相反方向滚动的控件，比如，你阅读的是纵向滑动的控件，那么就实现一个横向滑动的控件。这个自定义控件需要实现以下效果：\n\n* 最基本的拖动手势处理\n* fling 效果实现\n* 如果可以，再实现边缘效果\n\n感谢大家的阅读。\n\n\n\n","slug":"触摸事件实践之路","published":1,"updated":"2022-06-15T11:19:32.328Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrly000zfho6bs7z8ibe","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>最近帮公司面试 Android 岗位，面试的同学大部分具有两年以上的工作经验，但发现很多同学对触摸事件的分发都不是很熟悉，有的可能还能照本宣科地说个七七八八，有的却完全不熟悉，这让我感觉到诧异，因为我认为这 Android 中非常基础的知识，不仅要熟悉其中的分发流程，还要能实现简单的涉及手势处理的自定义控件。所以，这也是这篇文章的目的，希望能通过一些触摸事件处理的实际例子，来加深对触摸事件分发的理解，同时能实现相关需求。</p>\n<h2 id=\"触摸事件简单回顾\"><a href=\"#触摸事件简单回顾\" class=\"headerlink\" title=\"触摸事件简单回顾\"></a>触摸事件简单回顾</h2><p>我们都知道触摸事件的分发严格意义上讲，是从 Activity 开始进行分发，但一般我们谈论的，只从 ViewGroup 开始分发。</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/TouchEvent.png?x-oss-process=style/doc-img\" alt=\"TouchEvent\"></p>\n<p>上面的图只是粗略地画出触摸事件的分发流程，从 ViewGroup 的 <code>dispatchTouchEvent</code> 开始分发，先判断 ViewGroup 的 <code>onInterceptTouchEvent</code> 是否拦截，同时这里也可以调用 ViewGroup 的 <code>requestDisallowInterceptTouchEvent</code> 让 ViewGroup 不调用 <code>onInterceptTouchEvent</code>，如果事件被拦截，则调用 ViewGroup 的超类即 View 的 <code>dispatchTouchEvent</code>，反之，则调用子视图的 <code>dispatchTouchEvent</code>，注意：这里我们做了简单处理，假设当前 ViewGroup 的子视图为 View，如果子视图为 ViewGroup，那么还是先执行 ViewGroup 的 <code>dispatchTouchEvent</code>。</p>\n<p>最终都会调用到 View 的 <code>onTouchEvent</code> 中，这个方法是真正处理触摸事件的，一般如果我们需要自己处理触摸事件，也是在这个方法中处理。</p>\n<h2 id=\"手势判定\"><a href=\"#手势判定\" class=\"headerlink\" title=\"手势判定\"></a>手势判定</h2><p>上面我们简单回顾了触摸事件分发，具体细节可以看下源码。其实上面所讲的分发流程，很多同学都能说出个大概，但就是在动手写的时候，不知道如何入手。</p>\n<p>当我们在日常开发中，如果遇到不知道怎么实现的需求时，最直接的方法就是阅读他人的源码，不管是个人的库也好，Google 提供的库也好，设计良好的源码抵过看一大堆的博客。在实现需要处理触摸事件的需求也是一个道理，Android SDK 已经提供了 ListView，RecyclerView，ScrollView 等等涉及拖动处理的系统控件，所以我们可以从阅读这类控件的源码入手，看看系统控件是如何处理触摸事件的。这里我们选择 ScrollView 来简单分析下：</p>\n<p>ScrollView 继承于 FrameLayout，属于 ViewGroup 控件，所以有 <code>onInterceptTouchEvent</code></p>\n<blockquote>\n<p>因为篇幅有限，所以我们会省略去无关紧要的代码，各位同学可以对照着源码进行分析。</p>\n<p>源码部分基于 Android 26</p>\n</blockquote>\n<h3 id=\"onInterceptTouchEvent\"><a href=\"#onInterceptTouchEvent\" class=\"headerlink\" title=\"onInterceptTouchEvent\"></a>onInterceptTouchEvent</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ((action == MotionEvent.ACTION_MOVE) &amp;&amp; (mIsBeingDragged)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>用 <code>mIsBeingDragged</code> 变量来保存当前是否已经开始进行拖动手势，这个后面会讲到，同时当前分发事件类型为 <code>ACTION_MOVE</code>，那么直接返回 true，即拦截事件向子视图进行分发。这个是一个快捷的判断，省去了后面再进行一系列的判断，这个是个小技巧，我们在实现自定义控件的时候也可以用上。接下来的分析，为了更清晰，我们分为不同类型的 Touch Action 进行阅读。</p>\n<h4 id=\"TOUCH-DOWN\"><a href=\"#TOUCH-DOWN\" class=\"headerlink\" title=\"TOUCH_DOWN\"></a>TOUCH_DOWN</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!inChild((<span class=\"type\">int</span>) ev.getX(), (<span class=\"type\">int</span>) y)) &#123;</span><br><span class=\"line\">    mIsBeingDragged = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    recycleVelocityTracker();</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这段代码很简单，如果触摸事件没有作用于子视图范围内，那么就不处理，同时释放速度跟踪器，这个后面会讲到，一般用于 fling 手势的判定。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mLastMotionY = y;</span><br><span class=\"line\">mActivePointerId = ev.getPointerId(<span class=\"number\">0</span>);</span><br><span class=\"line\">initOrResetVelocityTracker();</span><br><span class=\"line\">mVelocityTracker.addMovement(ev);</span><br><span class=\"line\"></span><br><span class=\"line\">mScroller.computeScrollOffset();</span><br><span class=\"line\">mIsBeingDragged = !mScroller.isFinished();</span><br><span class=\"line\"></span><br><span class=\"line\">startNestedScroll(SCROLL_AXIS_VERTICAL);</span><br></pre></td></tr></table></figure>\n\n<p>这段代码主要是用于初始化判定之前的资源，比如 <code>mLastMotionY</code> 记录按下时的坐标信息，<code>mActivePointerId</code> 记录当前分发触摸事件的手指 id，这个一般用于多指的处理，<code>initOrResetVelocityTracker</code> 初始化速度跟踪器，同时使用 <code>addMovement</code> 记录当前触摸事件信息，<code>mScroller</code> 是一般用于 fling 手势处理，这里的作用是处理上一次的 fling，<code>startNestedScroll</code> 则是嵌套滚动机制的知识了，嵌套滚动机制也不难理解，但这里我们先不涉及，相信理解基础的触摸事件知识后，这个只要稍微阅读下源码，就能理解的，说句题外话，虽然嵌套滚动很容易理解，作用却非常大，基本解决了大部分的滑动冲突场景。</p>\n<h4 id=\"TOUCH-MOVE\"><a href=\"#TOUCH-MOVE\" class=\"headerlink\" title=\"TOUCH_MOVE\"></a>TOUCH_MOVE</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">activePointerId</span> <span class=\"operator\">=</span> mActivePointerId;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (activePointerId == INVALID_POINTER) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">pointerIndex</span> <span class=\"operator\">=</span> ev.findPointerIndex(activePointerId);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (pointerIndex == -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">y</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) ev.getY(pointerIndex);</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">yDiff</span> <span class=\"operator\">=</span> Math.abs(y - mLastMotionY);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (yDiff &gt; mTouchSlop &amp;&amp; (getNestedScrollAxes() &amp; SCROLL_AXIS_VERTICAL) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    mIsBeingDragged = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    mLastMotionY = y;</span><br><span class=\"line\">    initVelocityTrackerIfNotExists();</span><br><span class=\"line\">    mVelocityTracker.addMovement(ev);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ViewParent</span> <span class=\"variable\">parent</span> <span class=\"operator\">=</span> getParent();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (parent != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        parent.requestDisallowInterceptTouchEvent(<span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这段代码先使用我们在 <code>TOUCH_DOWN</code> 中记录的  <code>mActivePointerId</code> 进行是否为有效的判断，如果有效，则通过 <code>findPointerIndex</code> 获取作用手指 id 的下标，记录为  <code>pointerIndex</code> ，为什么要获取这个值，我们知道现在的手机屏幕都是支持多指触摸的，所以我们需要根据某个按下的手指的触摸信息来进行处理。<code>yDiff</code> 是滑动的距离，<code>mTouchSlop</code> 则是 SDK 定义的可作为判定是否开始进行拖动的距离常量，可以通过 ViewConfiguration 的 <code>getScaledTouchSlop</code> 获取，如果大于这个值，我们可以认为开始了拖动的手势。 <code>getNestedScrollAxes</code> 这个同样是用于嵌套滚动机制的，可以略过。如果开始了拖动手势，<code>mIsBeingDragged</code> 标记为 <code>true</code>，同样使用速度跟踪器记录信息，这里还会调用 ViewParent 的 <code>requestDisallowInterceptTouchEvent</code>，防止父视图拦截了事件，即 <code>onInterceptTouchEvent</code></p>\n<h4 id=\"TOUCH-CANCEL-amp-amp-TOUCH-UP\"><a href=\"#TOUCH-CANCEL-amp-amp-TOUCH-UP\" class=\"headerlink\" title=\"TOUCH_CANCEL &amp;&amp; TOUCH_UP\"></a>TOUCH_CANCEL &amp;&amp; TOUCH_UP</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mIsBeingDragged = <span class=\"literal\">false</span>;</span><br><span class=\"line\">mActivePointerId = INVALID_POINTER;</span><br><span class=\"line\">recycleVelocityTracker();</span><br><span class=\"line\">stopNestedScroll();</span><br></pre></td></tr></table></figure>\n\n<p>一般我们都会在 <code>TOUCH_CANCEL</code> 和 <code>TOUCH_UP</code> 这两个类型的触摸事件分发中，进行一些释放资源的操作，比如 <code>mIsBeingDragged</code> 设置为 <code>false</code>，释放速度跟踪器等等 </p>\n<blockquote>\n<p><code>TOUCH_UP</code> 是所有的手指(多指触摸)抬起时分发的事件，这个比较好理解，而 <code>TOUCH_CANCEL</code> 则是触摸取消事件类型，一般什么时候会分发这个事件呢？举个例子，如果某个子视图已经消费了 <code>TOUCH_DOWN</code>，即在这个事件分发时，向父视图传递了 <code>true</code> 的返回值，那么一般情况下，父视图不会再拦截接下来的事件，比如 <code>ACTION_MOVE</code> 等，但是如果父视图在这种情况下，还拦截了事件传递，即在 <code>onInterceptTouch</code> 中返回了 <code>true</code>，那么在 ViewGroup 的 <code>dispatchTouchEvent</code> 中会给已经确认消费事件的子视图分发一个 <code>TOUCH_CANCEL</code> 的事件，具体可以阅读源码。</p>\n</blockquote>\n<h4 id=\"ACTION-POINTER-UP\"><a href=\"#ACTION-POINTER-UP\" class=\"headerlink\" title=\"ACTION_POINTER_UP\"></a>ACTION_POINTER_UP</h4><p>这个为多指触摸时，某个手指抬起时分发的事件。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">pointerIndex</span> <span class=\"operator\">=</span> (ev.getAction() &amp; MotionEvent.ACTION_POINTER_INDEX_MASK) &gt;&gt;</span><br><span class=\"line\">                MotionEvent.ACTION_POINTER_INDEX_SHIFT;</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">pointerId</span> <span class=\"operator\">=</span> ev.getPointerId(pointerIndex);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (pointerId == mActivePointerId) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">newPointerIndex</span> <span class=\"operator\">=</span> pointerIndex == <span class=\"number\">0</span> ? <span class=\"number\">1</span> : <span class=\"number\">0</span>;</span><br><span class=\"line\">    mLastMotionY = (<span class=\"type\">int</span>) ev.getY(newPointerIndex);</span><br><span class=\"line\">    mActivePointerId = ev.getPointerId(newPointerIndex);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mVelocityTracker != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        mVelocityTracker.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这段代码处理的是，当某个手指抬起时，而这个手指刚好是我们当前使用的，则重新初始化资源</p>\n<h4 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h4><p>我们可以简单总结下，<code>onInterceptTouchEvent</code> 所进行的处理，即在 <code>TOUCH_DOWN</code> 资源初始化，<code>TOUCH_MOVE</code> 判断是否开始拖动手势，<code>TOUCH_CANCEL</code> &amp;&amp; <code>TOUCH_UP</code> 中进行资源释放。这里涉及了多指触摸的处理。</p>\n<h3 id=\"onTouchEvent\"><a href=\"#onTouchEvent\" class=\"headerlink\" title=\"onTouchEvent\"></a>onTouchEvent</h3><p><code>onTouchEvent</code> 要比 <code>onInterceptTouch</code> 的逻辑更复杂，因为这个方法是用于真正的消费触摸事件。同样的，我们只关心核心代码，略去无关紧要的代码片段。</p>\n<h4 id=\"TOUCH-DOWN-1\"><a href=\"#TOUCH-DOWN-1\" class=\"headerlink\" title=\"TOUCH_DOWN\"></a>TOUCH_DOWN</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (getChildCount() == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> ((mIsBeingDragged = !mScroller.isFinished())) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ViewParent</span> <span class=\"variable\">parent</span> <span class=\"operator\">=</span> getParent();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (parent != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        parent.requestDisallowInterceptTouchEvent(<span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!mScroller.isFinished()) &#123;</span><br><span class=\"line\">    mScroller.abortAnimation();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">mLastMotionY = (<span class=\"type\">int</span>) ev.getY();</span><br><span class=\"line\">mActivePointerId = ev.getPointerId(<span class=\"number\">0</span>);</span><br></pre></td></tr></table></figure>\n\n<p>同样的，<code>onTouchEvent</code> 在 <code>TOUCH_DOWN</code> 事件分发中，主要是进行资源初始化，同时也处理上一次的 fling 任务，比如调用 Scroller 的 <code>abortAnimation</code>，如果 Scroller 还没结束 fling 计算，则中止处理。</p>\n<h4 id=\"TOUCH-MOVE-1\"><a href=\"#TOUCH-MOVE-1\" class=\"headerlink\" title=\"TOUCH_MOVE\"></a>TOUCH_MOVE</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">activePointerIndex</span> <span class=\"operator\">=</span> ev.findPointerIndex(mActivePointerId);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (activePointerIndex == -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">y</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) ev.getY(activePointerIndex);</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">deltaY</span> <span class=\"operator\">=</span> mLastMotionY - y;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (dispatchNestedPreScroll(<span class=\"number\">0</span>, deltaY, mScrollConsumed, mScrollOffset)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 嵌套滚动处理</span></span><br><span class=\"line\">    deltaY -= mScrollConsumed[<span class=\"number\">1</span>];</span><br><span class=\"line\">    vtev.offsetLocation(<span class=\"number\">0</span>, mScrollOffset[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    mNestedYOffset += mScrollOffset[<span class=\"number\">1</span>];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!mIsBeingDragged &amp;&amp; Math.abs(deltaY) &gt; mTouchSlop) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">ViewParent</span> <span class=\"variable\">parent</span> <span class=\"operator\">=</span> getParent();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (parent != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            parent.requestDisallowInterceptTouchEvent(<span class=\"literal\">true</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        mIsBeingDragged = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (deltaY &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            deltaY -= mTouchSlop;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            deltaY += mTouchSlop;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mIsBeingDragged) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/// 业务逻辑</span></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>这段代码同样会进行多指处理，获取指定手指的触摸事件信息。<code>mIsBeingDragged</code> 为 <code>false</code>，同时会再进行一次拖动手势的判定，判定逻辑和 <code>onInterceptTouchEvent</code> 中类似，如果 <code>mIsBeingDragged</code> 为 <code>true</code>，则开始进行真正的逻辑处理。</p>\n<blockquote>\n<p>EdgeEffect 是用于拖动时，边缘的阴影效果，具体使用可以参考源码</p>\n</blockquote>\n<h4 id=\"TOUCH-UP\"><a href=\"#TOUCH-UP\" class=\"headerlink\" title=\"TOUCH_UP\"></a>TOUCH_UP</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (mIsBeingDragged) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">VelocityTracker</span> <span class=\"variable\">velocityTracker</span> <span class=\"operator\">=</span> mVelocityTracker;</span><br><span class=\"line\">\tvelocityTracker.computeCurrentVelocity(<span class=\"number\">1000</span>, mMaximumVelocity);</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">initialVelocity</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) velocityTracker.getYVelocity(mActivePointerId);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((Math.abs(initialVelocity) &gt; mMinimumVelocity)) &#123;</span><br><span class=\"line\">    \tflingWithNestedDispatch(-initialVelocity);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    mActivePointerId = INVALID_POINTER;</span><br><span class=\"line\">    endDrag();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>当手指全部抬起时，可以使用速度跟踪器进行 fling 手势的判定，同时释放资源。通过 <code>getYVelocity</code> 获取速度，在判断是否可以作为 fling 手势处理，<code>mMaximumVelocity</code> 是处理的最大速度，<code>mMinimumVelocity</code> 是处理的最小速度，这两个值同样可以通过 ViewConfiguration 的 <code>getScaledMaximumFlingVelocity</code> 和 <code>getScaledMinimumFlingVelocity</code> 获取。一般情况对 fling 的处理是通过 Scroller 进行处理的，因为这里涉及复杂的数学知识，而 Scroller 可以帮我们简化这里的操作，使用如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">height</span> <span class=\"operator\">=</span> getHeight() - mPaddingBottom - mPaddingTop;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">bottom</span> <span class=\"operator\">=</span> getChildAt(<span class=\"number\">0</span>).getHeight();</span><br><span class=\"line\"></span><br><span class=\"line\">mScroller.fling(mScrollX, mScrollY, <span class=\"number\">0</span>, velocityY, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>,</span><br><span class=\"line\">                    Math.max(<span class=\"number\">0</span>, bottom - height), <span class=\"number\">0</span>, height/<span class=\"number\">2</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">postInvalidateOnAnimation();</span><br></pre></td></tr></table></figure>\n\n<p>通过传递当前拖动手势速度值来调用 <code>fling</code> 进行处理，然后在 <code>computeScrollOffset</code> 方法中，进行真正的滚动处理：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">computeScroll</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mScroller.computeScrollOffset()) &#123;</span><br><span class=\"line\">      \t<span class=\"comment\">// 逻辑处理</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">x</span> <span class=\"operator\">=</span> mScroller.getCurrX();</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">y</span> <span class=\"operator\">=</span> mScroller.getCurrY();</span><br><span class=\"line\">        postInvalidateOnAnimation();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先我们要知道 Scroller 并不会为我们进行滚动处理，它只是提供了计算的模型，通过调用 <code>computeScrollOffset</code> 进行计算，如果返回 <code>true</code>，表示计算还没结束，然后通过 <code>getCurrX</code> 或 <code>getCurrY</code> 获取计算后的值，最后进行真正的滚动处理，比如调用 <code>scrollTo</code> 等等，这里需要注意的是，需要调用 <code>invalidate</code> 来确保进行下一次的 <code>computeScroll</code> 调用，这里使用的 <code>postInvalidateOnAnimation</code> 其作用是类似的。</p>\n<h4 id=\"TOUCH-CANCEL\"><a href=\"#TOUCH-CANCEL\" class=\"headerlink\" title=\"TOUCH_CANCEL\"></a>TOUCH_CANCEL</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (mIsBeingDragged &amp;&amp; getChildCount() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mScroller.springBack(mScrollX, mScrollY, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, getScrollRange())) &#123;</span><br><span class=\"line\">        postInvalidateOnAnimation();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    mActivePointerId = INVALID_POINTER;</span><br><span class=\"line\">    endDrag();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>同样的，一般我们都会在 <code>TOUCH_CANCEL</code> 中释放资源。</p>\n<h4 id=\"ACTION-POINTER-DOWN\"><a href=\"#ACTION-POINTER-DOWN\" class=\"headerlink\" title=\"ACTION_POINTER_DOWN\"></a>ACTION_POINTER_DOWN</h4><p>当有新的手指按下时分发的事件</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">index</span> <span class=\"operator\">=</span> ev.getActionIndex();</span><br><span class=\"line\">mLastMotionY = (<span class=\"type\">int</span>) ev.getY(index);</span><br><span class=\"line\">mActivePointerId = ev.getPointerId(index);</span><br></pre></td></tr></table></figure>\n\n<p>以新按下的手指的信息重新计算</p>\n<h4 id=\"ACTION-POINTER-UP-1\"><a href=\"#ACTION-POINTER-UP-1\" class=\"headerlink\" title=\"ACTION_POINTER_UP\"></a>ACTION_POINTER_UP</h4><p>这里的处理和 <code>onInterceptTouch</code> 一致</p>\n<h4 id=\"小结-1\"><a href=\"#小结-1\" class=\"headerlink\" title=\"小结\"></a>小结</h4><p><code>onTouchEvent</code> 和 <code>onInterceptTouchEvent</code> 处理有些相似，主要是在 <code>TOUCH_MOVE</code> 中在判定为拖动手势后进行真正的业务逻辑处理，同时在 <code>TOUCH_UP</code> 中根据速度跟踪器的获取的速度，判定是否符合 fling 手势，如果符合，则使用 Scroller 进行计算。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>在分析完 ScrollView 的触摸事件处理，我们应该对事件处理有个基本理解，可以按照这个思路去分析其他的类似的系统控件，比如 <code>NestedScrollView</code>、<code>RecyclerView</code>  等等，我们可以发现处理的思路基本一致，那我们是不是可以将这些判定逻辑封装下呢？是的，并且系统已经提供 GestureDetector 来进行手势的判定，我们只需要在相应的手势回调方法中进行我们的业务逻辑即可。还有更强大的 <code>ViewDragHelper</code> ，但不管怎样，只要能理解好触摸事件分发，对工具类的熟练使用就不在话下。</p>\n<h2 id=\"实战\"><a href=\"#实战\" class=\"headerlink\" title=\"实战\"></a>实战</h2><p>理论说的再多，也是纸上谈兵，只有真正去实践，才能熟练掌握。因为业务需求或者兴趣爱好，我写了以下两个自定义控件，正好一个是纵向滑动和一个是横向滑动，效果如下：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2018/2/22/161bd1e1f4774f80?imageslim\" alt=\"WheelView\"></p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/more.gif?x-oss-process=style/doc-img\" alt=\"TapeView\"></p>\n<p>详细的代码分析我们就不进行了，因为阅读源码是最快的方式，第一个是<a href=\"https://github.com/LinXiaoTao/WheelView\">滚轮控件</a>，第二个是之前参加活动的仿薄荷健康的<a href=\"https://github.com/LinXiaoTao/CustomViewProject/blob/master/app/src/main/java/com/leo/customviewproject/tape/README.md\">卷尺控件</a>。在这里我们只分析部分代码：</p>\n<h3 id=\"滚轮控件\"><a href=\"#滚轮控件\" class=\"headerlink\" title=\"滚轮控件\"></a>滚轮控件</h3><p>在前面手势判定中的分析中，我们提到在 <code>onTouchEvent</code> 判定拖动手势成功后，进行真正的业务逻辑处理，在这个控件中也是一样的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (mIsBeingDragged) &#123;</span><br><span class=\"line\">    mDistanceY += mLastY - moveY;</span><br><span class=\"line\">    postInvalidateOnAnimation();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在每次 <code>TOUCH_MOVE</code> 事件分发时，计算与 <code>TOUCH_DOWN</code> 时记录的位置信息的差值，保存为 <code>mDistanceY</code>，并且在 <code>onDraw</code> 中使用这个值对 Canvas 进行位移，绘制新位置的 UI。</p>\n<h3 id=\"卷尺控件\"><a href=\"#卷尺控件\" class=\"headerlink\" title=\"卷尺控件\"></a>卷尺控件</h3><p>拖动距离的计算与滚轮控件一样，只是记录为 <code>mOffsetLeft</code> 而已，同时两个控件都有在 <code>onTouchEvent</code> 的 <code>ACTION_UP</code> 事件分发中，处理 fling 手势。不过卷尺控件有使用 EdgeEffect 处理边缘效果，有兴趣的同学可以看下。</p>\n<h2 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h2><p>文章的主要目的并不在于教会怎么去处理触摸事件的分发，只是希望通过这个例子，大家能养成阅读源码的习惯，不管是系统 SDK 也好，第三方库也好，只要把核心知识掌握，就能熟练使用各种现成的工具库，并且达到举一反三的效果。</p>\n<p>但是理论知识再多也是纸上谈兵，最重要的是实践，具体实践可以这样做：先理解好触摸事件分发流程，然后选择一个控件，可以是系统控件，也可以是其他控件，只要涉及触摸事件处理就行，进行阅读，然后手动实现一个相反方向滚动的控件，比如，你阅读的是纵向滑动的控件，那么就实现一个横向滑动的控件。这个自定义控件需要实现以下效果：</p>\n<ul>\n<li>最基本的拖动手势处理</li>\n<li>fling 效果实现</li>\n<li>如果可以，再实现边缘效果</li>\n</ul>\n<p>感谢大家的阅读。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>最近帮公司面试 Android 岗位，面试的同学大部分具有两年以上的工作经验，但发现很多同学对触摸事件的分发都不是很熟悉，有的可能还能照本宣科地说个七七八八，有的却完全不熟悉，这让我感觉到诧异，因为我认为这 Android 中非常基础的知识，不仅要熟悉其中的分发流程，还要能实现简单的涉及手势处理的自定义控件。所以，这也是这篇文章的目的，希望能通过一些触摸事件处理的实际例子，来加深对触摸事件分发的理解，同时能实现相关需求。</p>\n<h2 id=\"触摸事件简单回顾\"><a href=\"#触摸事件简单回顾\" class=\"headerlink\" title=\"触摸事件简单回顾\"></a>触摸事件简单回顾</h2><p>我们都知道触摸事件的分发严格意义上讲，是从 Activity 开始进行分发，但一般我们谈论的，只从 ViewGroup 开始分发。</p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/TouchEvent.png?x-oss-process=style/doc-img\" alt=\"TouchEvent\"></p>\n<p>上面的图只是粗略地画出触摸事件的分发流程，从 ViewGroup 的 <code>dispatchTouchEvent</code> 开始分发，先判断 ViewGroup 的 <code>onInterceptTouchEvent</code> 是否拦截，同时这里也可以调用 ViewGroup 的 <code>requestDisallowInterceptTouchEvent</code> 让 ViewGroup 不调用 <code>onInterceptTouchEvent</code>，如果事件被拦截，则调用 ViewGroup 的超类即 View 的 <code>dispatchTouchEvent</code>，反之，则调用子视图的 <code>dispatchTouchEvent</code>，注意：这里我们做了简单处理，假设当前 ViewGroup 的子视图为 View，如果子视图为 ViewGroup，那么还是先执行 ViewGroup 的 <code>dispatchTouchEvent</code>。</p>\n<p>最终都会调用到 View 的 <code>onTouchEvent</code> 中，这个方法是真正处理触摸事件的，一般如果我们需要自己处理触摸事件，也是在这个方法中处理。</p>\n<h2 id=\"手势判定\"><a href=\"#手势判定\" class=\"headerlink\" title=\"手势判定\"></a>手势判定</h2><p>上面我们简单回顾了触摸事件分发，具体细节可以看下源码。其实上面所讲的分发流程，很多同学都能说出个大概，但就是在动手写的时候，不知道如何入手。</p>\n<p>当我们在日常开发中，如果遇到不知道怎么实现的需求时，最直接的方法就是阅读他人的源码，不管是个人的库也好，Google 提供的库也好，设计良好的源码抵过看一大堆的博客。在实现需要处理触摸事件的需求也是一个道理，Android SDK 已经提供了 ListView，RecyclerView，ScrollView 等等涉及拖动处理的系统控件，所以我们可以从阅读这类控件的源码入手，看看系统控件是如何处理触摸事件的。这里我们选择 ScrollView 来简单分析下：</p>\n<p>ScrollView 继承于 FrameLayout，属于 ViewGroup 控件，所以有 <code>onInterceptTouchEvent</code></p>\n<blockquote>\n<p>因为篇幅有限，所以我们会省略去无关紧要的代码，各位同学可以对照着源码进行分析。</p>\n<p>源码部分基于 Android 26</p>\n</blockquote>\n<h3 id=\"onInterceptTouchEvent\"><a href=\"#onInterceptTouchEvent\" class=\"headerlink\" title=\"onInterceptTouchEvent\"></a>onInterceptTouchEvent</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ((action == MotionEvent.ACTION_MOVE) &amp;&amp; (mIsBeingDragged)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>用 <code>mIsBeingDragged</code> 变量来保存当前是否已经开始进行拖动手势，这个后面会讲到，同时当前分发事件类型为 <code>ACTION_MOVE</code>，那么直接返回 true，即拦截事件向子视图进行分发。这个是一个快捷的判断，省去了后面再进行一系列的判断，这个是个小技巧，我们在实现自定义控件的时候也可以用上。接下来的分析，为了更清晰，我们分为不同类型的 Touch Action 进行阅读。</p>\n<h4 id=\"TOUCH-DOWN\"><a href=\"#TOUCH-DOWN\" class=\"headerlink\" title=\"TOUCH_DOWN\"></a>TOUCH_DOWN</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!inChild((<span class=\"type\">int</span>) ev.getX(), (<span class=\"type\">int</span>) y)) &#123;</span><br><span class=\"line\">    mIsBeingDragged = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    recycleVelocityTracker();</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这段代码很简单，如果触摸事件没有作用于子视图范围内，那么就不处理，同时释放速度跟踪器，这个后面会讲到，一般用于 fling 手势的判定。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mLastMotionY = y;</span><br><span class=\"line\">mActivePointerId = ev.getPointerId(<span class=\"number\">0</span>);</span><br><span class=\"line\">initOrResetVelocityTracker();</span><br><span class=\"line\">mVelocityTracker.addMovement(ev);</span><br><span class=\"line\"></span><br><span class=\"line\">mScroller.computeScrollOffset();</span><br><span class=\"line\">mIsBeingDragged = !mScroller.isFinished();</span><br><span class=\"line\"></span><br><span class=\"line\">startNestedScroll(SCROLL_AXIS_VERTICAL);</span><br></pre></td></tr></table></figure>\n\n<p>这段代码主要是用于初始化判定之前的资源，比如 <code>mLastMotionY</code> 记录按下时的坐标信息，<code>mActivePointerId</code> 记录当前分发触摸事件的手指 id，这个一般用于多指的处理，<code>initOrResetVelocityTracker</code> 初始化速度跟踪器，同时使用 <code>addMovement</code> 记录当前触摸事件信息，<code>mScroller</code> 是一般用于 fling 手势处理，这里的作用是处理上一次的 fling，<code>startNestedScroll</code> 则是嵌套滚动机制的知识了，嵌套滚动机制也不难理解，但这里我们先不涉及，相信理解基础的触摸事件知识后，这个只要稍微阅读下源码，就能理解的，说句题外话，虽然嵌套滚动很容易理解，作用却非常大，基本解决了大部分的滑动冲突场景。</p>\n<h4 id=\"TOUCH-MOVE\"><a href=\"#TOUCH-MOVE\" class=\"headerlink\" title=\"TOUCH_MOVE\"></a>TOUCH_MOVE</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">activePointerId</span> <span class=\"operator\">=</span> mActivePointerId;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (activePointerId == INVALID_POINTER) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">pointerIndex</span> <span class=\"operator\">=</span> ev.findPointerIndex(activePointerId);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (pointerIndex == -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">y</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) ev.getY(pointerIndex);</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">yDiff</span> <span class=\"operator\">=</span> Math.abs(y - mLastMotionY);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (yDiff &gt; mTouchSlop &amp;&amp; (getNestedScrollAxes() &amp; SCROLL_AXIS_VERTICAL) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    mIsBeingDragged = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    mLastMotionY = y;</span><br><span class=\"line\">    initVelocityTrackerIfNotExists();</span><br><span class=\"line\">    mVelocityTracker.addMovement(ev);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ViewParent</span> <span class=\"variable\">parent</span> <span class=\"operator\">=</span> getParent();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (parent != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        parent.requestDisallowInterceptTouchEvent(<span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这段代码先使用我们在 <code>TOUCH_DOWN</code> 中记录的  <code>mActivePointerId</code> 进行是否为有效的判断，如果有效，则通过 <code>findPointerIndex</code> 获取作用手指 id 的下标，记录为  <code>pointerIndex</code> ，为什么要获取这个值，我们知道现在的手机屏幕都是支持多指触摸的，所以我们需要根据某个按下的手指的触摸信息来进行处理。<code>yDiff</code> 是滑动的距离，<code>mTouchSlop</code> 则是 SDK 定义的可作为判定是否开始进行拖动的距离常量，可以通过 ViewConfiguration 的 <code>getScaledTouchSlop</code> 获取，如果大于这个值，我们可以认为开始了拖动的手势。 <code>getNestedScrollAxes</code> 这个同样是用于嵌套滚动机制的，可以略过。如果开始了拖动手势，<code>mIsBeingDragged</code> 标记为 <code>true</code>，同样使用速度跟踪器记录信息，这里还会调用 ViewParent 的 <code>requestDisallowInterceptTouchEvent</code>，防止父视图拦截了事件，即 <code>onInterceptTouchEvent</code></p>\n<h4 id=\"TOUCH-CANCEL-amp-amp-TOUCH-UP\"><a href=\"#TOUCH-CANCEL-amp-amp-TOUCH-UP\" class=\"headerlink\" title=\"TOUCH_CANCEL &amp;&amp; TOUCH_UP\"></a>TOUCH_CANCEL &amp;&amp; TOUCH_UP</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mIsBeingDragged = <span class=\"literal\">false</span>;</span><br><span class=\"line\">mActivePointerId = INVALID_POINTER;</span><br><span class=\"line\">recycleVelocityTracker();</span><br><span class=\"line\">stopNestedScroll();</span><br></pre></td></tr></table></figure>\n\n<p>一般我们都会在 <code>TOUCH_CANCEL</code> 和 <code>TOUCH_UP</code> 这两个类型的触摸事件分发中，进行一些释放资源的操作，比如 <code>mIsBeingDragged</code> 设置为 <code>false</code>，释放速度跟踪器等等 </p>\n<blockquote>\n<p><code>TOUCH_UP</code> 是所有的手指(多指触摸)抬起时分发的事件，这个比较好理解，而 <code>TOUCH_CANCEL</code> 则是触摸取消事件类型，一般什么时候会分发这个事件呢？举个例子，如果某个子视图已经消费了 <code>TOUCH_DOWN</code>，即在这个事件分发时，向父视图传递了 <code>true</code> 的返回值，那么一般情况下，父视图不会再拦截接下来的事件，比如 <code>ACTION_MOVE</code> 等，但是如果父视图在这种情况下，还拦截了事件传递，即在 <code>onInterceptTouch</code> 中返回了 <code>true</code>，那么在 ViewGroup 的 <code>dispatchTouchEvent</code> 中会给已经确认消费事件的子视图分发一个 <code>TOUCH_CANCEL</code> 的事件，具体可以阅读源码。</p>\n</blockquote>\n<h4 id=\"ACTION-POINTER-UP\"><a href=\"#ACTION-POINTER-UP\" class=\"headerlink\" title=\"ACTION_POINTER_UP\"></a>ACTION_POINTER_UP</h4><p>这个为多指触摸时，某个手指抬起时分发的事件。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">pointerIndex</span> <span class=\"operator\">=</span> (ev.getAction() &amp; MotionEvent.ACTION_POINTER_INDEX_MASK) &gt;&gt;</span><br><span class=\"line\">                MotionEvent.ACTION_POINTER_INDEX_SHIFT;</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">pointerId</span> <span class=\"operator\">=</span> ev.getPointerId(pointerIndex);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (pointerId == mActivePointerId) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">newPointerIndex</span> <span class=\"operator\">=</span> pointerIndex == <span class=\"number\">0</span> ? <span class=\"number\">1</span> : <span class=\"number\">0</span>;</span><br><span class=\"line\">    mLastMotionY = (<span class=\"type\">int</span>) ev.getY(newPointerIndex);</span><br><span class=\"line\">    mActivePointerId = ev.getPointerId(newPointerIndex);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mVelocityTracker != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        mVelocityTracker.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这段代码处理的是，当某个手指抬起时，而这个手指刚好是我们当前使用的，则重新初始化资源</p>\n<h4 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h4><p>我们可以简单总结下，<code>onInterceptTouchEvent</code> 所进行的处理，即在 <code>TOUCH_DOWN</code> 资源初始化，<code>TOUCH_MOVE</code> 判断是否开始拖动手势，<code>TOUCH_CANCEL</code> &amp;&amp; <code>TOUCH_UP</code> 中进行资源释放。这里涉及了多指触摸的处理。</p>\n<h3 id=\"onTouchEvent\"><a href=\"#onTouchEvent\" class=\"headerlink\" title=\"onTouchEvent\"></a>onTouchEvent</h3><p><code>onTouchEvent</code> 要比 <code>onInterceptTouch</code> 的逻辑更复杂，因为这个方法是用于真正的消费触摸事件。同样的，我们只关心核心代码，略去无关紧要的代码片段。</p>\n<h4 id=\"TOUCH-DOWN-1\"><a href=\"#TOUCH-DOWN-1\" class=\"headerlink\" title=\"TOUCH_DOWN\"></a>TOUCH_DOWN</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (getChildCount() == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> ((mIsBeingDragged = !mScroller.isFinished())) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ViewParent</span> <span class=\"variable\">parent</span> <span class=\"operator\">=</span> getParent();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (parent != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        parent.requestDisallowInterceptTouchEvent(<span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!mScroller.isFinished()) &#123;</span><br><span class=\"line\">    mScroller.abortAnimation();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">mLastMotionY = (<span class=\"type\">int</span>) ev.getY();</span><br><span class=\"line\">mActivePointerId = ev.getPointerId(<span class=\"number\">0</span>);</span><br></pre></td></tr></table></figure>\n\n<p>同样的，<code>onTouchEvent</code> 在 <code>TOUCH_DOWN</code> 事件分发中，主要是进行资源初始化，同时也处理上一次的 fling 任务，比如调用 Scroller 的 <code>abortAnimation</code>，如果 Scroller 还没结束 fling 计算，则中止处理。</p>\n<h4 id=\"TOUCH-MOVE-1\"><a href=\"#TOUCH-MOVE-1\" class=\"headerlink\" title=\"TOUCH_MOVE\"></a>TOUCH_MOVE</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">activePointerIndex</span> <span class=\"operator\">=</span> ev.findPointerIndex(mActivePointerId);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (activePointerIndex == -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">y</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) ev.getY(activePointerIndex);</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">deltaY</span> <span class=\"operator\">=</span> mLastMotionY - y;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (dispatchNestedPreScroll(<span class=\"number\">0</span>, deltaY, mScrollConsumed, mScrollOffset)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 嵌套滚动处理</span></span><br><span class=\"line\">    deltaY -= mScrollConsumed[<span class=\"number\">1</span>];</span><br><span class=\"line\">    vtev.offsetLocation(<span class=\"number\">0</span>, mScrollOffset[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    mNestedYOffset += mScrollOffset[<span class=\"number\">1</span>];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!mIsBeingDragged &amp;&amp; Math.abs(deltaY) &gt; mTouchSlop) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">ViewParent</span> <span class=\"variable\">parent</span> <span class=\"operator\">=</span> getParent();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (parent != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            parent.requestDisallowInterceptTouchEvent(<span class=\"literal\">true</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        mIsBeingDragged = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (deltaY &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            deltaY -= mTouchSlop;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            deltaY += mTouchSlop;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mIsBeingDragged) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/// 业务逻辑</span></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>这段代码同样会进行多指处理，获取指定手指的触摸事件信息。<code>mIsBeingDragged</code> 为 <code>false</code>，同时会再进行一次拖动手势的判定，判定逻辑和 <code>onInterceptTouchEvent</code> 中类似，如果 <code>mIsBeingDragged</code> 为 <code>true</code>，则开始进行真正的逻辑处理。</p>\n<blockquote>\n<p>EdgeEffect 是用于拖动时，边缘的阴影效果，具体使用可以参考源码</p>\n</blockquote>\n<h4 id=\"TOUCH-UP\"><a href=\"#TOUCH-UP\" class=\"headerlink\" title=\"TOUCH_UP\"></a>TOUCH_UP</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (mIsBeingDragged) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">VelocityTracker</span> <span class=\"variable\">velocityTracker</span> <span class=\"operator\">=</span> mVelocityTracker;</span><br><span class=\"line\">\tvelocityTracker.computeCurrentVelocity(<span class=\"number\">1000</span>, mMaximumVelocity);</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">initialVelocity</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) velocityTracker.getYVelocity(mActivePointerId);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((Math.abs(initialVelocity) &gt; mMinimumVelocity)) &#123;</span><br><span class=\"line\">    \tflingWithNestedDispatch(-initialVelocity);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    mActivePointerId = INVALID_POINTER;</span><br><span class=\"line\">    endDrag();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>当手指全部抬起时，可以使用速度跟踪器进行 fling 手势的判定，同时释放资源。通过 <code>getYVelocity</code> 获取速度，在判断是否可以作为 fling 手势处理，<code>mMaximumVelocity</code> 是处理的最大速度，<code>mMinimumVelocity</code> 是处理的最小速度，这两个值同样可以通过 ViewConfiguration 的 <code>getScaledMaximumFlingVelocity</code> 和 <code>getScaledMinimumFlingVelocity</code> 获取。一般情况对 fling 的处理是通过 Scroller 进行处理的，因为这里涉及复杂的数学知识，而 Scroller 可以帮我们简化这里的操作，使用如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">height</span> <span class=\"operator\">=</span> getHeight() - mPaddingBottom - mPaddingTop;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">bottom</span> <span class=\"operator\">=</span> getChildAt(<span class=\"number\">0</span>).getHeight();</span><br><span class=\"line\"></span><br><span class=\"line\">mScroller.fling(mScrollX, mScrollY, <span class=\"number\">0</span>, velocityY, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>,</span><br><span class=\"line\">                    Math.max(<span class=\"number\">0</span>, bottom - height), <span class=\"number\">0</span>, height/<span class=\"number\">2</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">postInvalidateOnAnimation();</span><br></pre></td></tr></table></figure>\n\n<p>通过传递当前拖动手势速度值来调用 <code>fling</code> 进行处理，然后在 <code>computeScrollOffset</code> 方法中，进行真正的滚动处理：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">computeScroll</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mScroller.computeScrollOffset()) &#123;</span><br><span class=\"line\">      \t<span class=\"comment\">// 逻辑处理</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">x</span> <span class=\"operator\">=</span> mScroller.getCurrX();</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">y</span> <span class=\"operator\">=</span> mScroller.getCurrY();</span><br><span class=\"line\">        postInvalidateOnAnimation();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>首先我们要知道 Scroller 并不会为我们进行滚动处理，它只是提供了计算的模型，通过调用 <code>computeScrollOffset</code> 进行计算，如果返回 <code>true</code>，表示计算还没结束，然后通过 <code>getCurrX</code> 或 <code>getCurrY</code> 获取计算后的值，最后进行真正的滚动处理，比如调用 <code>scrollTo</code> 等等，这里需要注意的是，需要调用 <code>invalidate</code> 来确保进行下一次的 <code>computeScroll</code> 调用，这里使用的 <code>postInvalidateOnAnimation</code> 其作用是类似的。</p>\n<h4 id=\"TOUCH-CANCEL\"><a href=\"#TOUCH-CANCEL\" class=\"headerlink\" title=\"TOUCH_CANCEL\"></a>TOUCH_CANCEL</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (mIsBeingDragged &amp;&amp; getChildCount() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mScroller.springBack(mScrollX, mScrollY, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, getScrollRange())) &#123;</span><br><span class=\"line\">        postInvalidateOnAnimation();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    mActivePointerId = INVALID_POINTER;</span><br><span class=\"line\">    endDrag();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>同样的，一般我们都会在 <code>TOUCH_CANCEL</code> 中释放资源。</p>\n<h4 id=\"ACTION-POINTER-DOWN\"><a href=\"#ACTION-POINTER-DOWN\" class=\"headerlink\" title=\"ACTION_POINTER_DOWN\"></a>ACTION_POINTER_DOWN</h4><p>当有新的手指按下时分发的事件</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">index</span> <span class=\"operator\">=</span> ev.getActionIndex();</span><br><span class=\"line\">mLastMotionY = (<span class=\"type\">int</span>) ev.getY(index);</span><br><span class=\"line\">mActivePointerId = ev.getPointerId(index);</span><br></pre></td></tr></table></figure>\n\n<p>以新按下的手指的信息重新计算</p>\n<h4 id=\"ACTION-POINTER-UP-1\"><a href=\"#ACTION-POINTER-UP-1\" class=\"headerlink\" title=\"ACTION_POINTER_UP\"></a>ACTION_POINTER_UP</h4><p>这里的处理和 <code>onInterceptTouch</code> 一致</p>\n<h4 id=\"小结-1\"><a href=\"#小结-1\" class=\"headerlink\" title=\"小结\"></a>小结</h4><p><code>onTouchEvent</code> 和 <code>onInterceptTouchEvent</code> 处理有些相似，主要是在 <code>TOUCH_MOVE</code> 中在判定为拖动手势后进行真正的业务逻辑处理，同时在 <code>TOUCH_UP</code> 中根据速度跟踪器的获取的速度，判定是否符合 fling 手势，如果符合，则使用 Scroller 进行计算。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>在分析完 ScrollView 的触摸事件处理，我们应该对事件处理有个基本理解，可以按照这个思路去分析其他的类似的系统控件，比如 <code>NestedScrollView</code>、<code>RecyclerView</code>  等等，我们可以发现处理的思路基本一致，那我们是不是可以将这些判定逻辑封装下呢？是的，并且系统已经提供 GestureDetector 来进行手势的判定，我们只需要在相应的手势回调方法中进行我们的业务逻辑即可。还有更强大的 <code>ViewDragHelper</code> ，但不管怎样，只要能理解好触摸事件分发，对工具类的熟练使用就不在话下。</p>\n<h2 id=\"实战\"><a href=\"#实战\" class=\"headerlink\" title=\"实战\"></a>实战</h2><p>理论说的再多，也是纸上谈兵，只有真正去实践，才能熟练掌握。因为业务需求或者兴趣爱好，我写了以下两个自定义控件，正好一个是纵向滑动和一个是横向滑动，效果如下：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2018/2/22/161bd1e1f4774f80?imageslim\" alt=\"WheelView\"></p>\n<p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/more.gif?x-oss-process=style/doc-img\" alt=\"TapeView\"></p>\n<p>详细的代码分析我们就不进行了，因为阅读源码是最快的方式，第一个是<a href=\"https://github.com/LinXiaoTao/WheelView\">滚轮控件</a>，第二个是之前参加活动的仿薄荷健康的<a href=\"https://github.com/LinXiaoTao/CustomViewProject/blob/master/app/src/main/java/com/leo/customviewproject/tape/README.md\">卷尺控件</a>。在这里我们只分析部分代码：</p>\n<h3 id=\"滚轮控件\"><a href=\"#滚轮控件\" class=\"headerlink\" title=\"滚轮控件\"></a>滚轮控件</h3><p>在前面手势判定中的分析中，我们提到在 <code>onTouchEvent</code> 判定拖动手势成功后，进行真正的业务逻辑处理，在这个控件中也是一样的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (mIsBeingDragged) &#123;</span><br><span class=\"line\">    mDistanceY += mLastY - moveY;</span><br><span class=\"line\">    postInvalidateOnAnimation();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在每次 <code>TOUCH_MOVE</code> 事件分发时，计算与 <code>TOUCH_DOWN</code> 时记录的位置信息的差值，保存为 <code>mDistanceY</code>，并且在 <code>onDraw</code> 中使用这个值对 Canvas 进行位移，绘制新位置的 UI。</p>\n<h3 id=\"卷尺控件\"><a href=\"#卷尺控件\" class=\"headerlink\" title=\"卷尺控件\"></a>卷尺控件</h3><p>拖动距离的计算与滚轮控件一样，只是记录为 <code>mOffsetLeft</code> 而已，同时两个控件都有在 <code>onTouchEvent</code> 的 <code>ACTION_UP</code> 事件分发中，处理 fling 手势。不过卷尺控件有使用 EdgeEffect 处理边缘效果，有兴趣的同学可以看下。</p>\n<h2 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h2><p>文章的主要目的并不在于教会怎么去处理触摸事件的分发，只是希望通过这个例子，大家能养成阅读源码的习惯，不管是系统 SDK 也好，第三方库也好，只要把核心知识掌握，就能熟练使用各种现成的工具库，并且达到举一反三的效果。</p>\n<p>但是理论知识再多也是纸上谈兵，最重要的是实践，具体实践可以这样做：先理解好触摸事件分发流程，然后选择一个控件，可以是系统控件，也可以是其他控件，只要涉及触摸事件处理就行，进行阅读，然后手动实现一个相反方向滚动的控件，比如，你阅读的是纵向滑动的控件，那么就实现一个横向滑动的控件。这个自定义控件需要实现以下效果：</p>\n<ul>\n<li>最基本的拖动手势处理</li>\n<li>fling 效果实现</li>\n<li>如果可以，再实现边缘效果</li>\n</ul>\n<p>感谢大家的阅读。</p>\n"},{"title":"Activity启动流程(基于Android26)","date":"2018-03-27T01:54:17.000Z","_content":"\n> 基于 Android 26，分析 Android Activity 启动流程\n\n## 参考\n\n[startActivity启动过程分析](http://gityuan.com/2016/03/12/start-activity/)\n\n## 源码\n\n**源码篇幅可能过长，所以会省略一下不必要的代码和注释**\n\n### Activity\n\n``` java\n@Override                                    \npublic void startActivity() {   \n    this.startActivity(intent, null);        \n}\n\n@Override                                                           \npublic void startActivity() {\n    if (options != null) {                                          \n        startActivityForResult(intent, -1, options);                \n    } else {                                                        \n        startActivityForResult(intent, -1);                         \n    }                                                               \n}                                                                   \n```\n\n最终都会调用到 `startActivityForResult`：\n\n``` java\npublic void startActivityForResult() {                                                             \n    if (mParent == null) {\n        // 转场动画的处理\n        Instrumentation.ActivityResult ar = mInstrumentation.execStartActivity();                                                                                                                                                      \n        if (ar != null) {                                                                       \n            mMainThread.sendActivityResult();                                                                                                             \n        }                                                                                       \n        if (requestCode >= 0) {                                                                                        \n            mStartedActivity = true;                                                            \n        }                                                                                                                                                                             \n    } else {                                                                                    \n        // 如果存在 Parent Activity 则交由它处理                                                                                    \n    }                                                                                           \n}                                                                                               \n```\n\n可以知道 Activity 启动委托给了 Instrumentation 进行实现\n\n### Instrumentation\n\n``` java\npublic ActivityResult execStartActivity() {\n    // 由 ActivityThread.getApplicationThread 提供的 ApplicationThread\n    IApplicationThread whoThread = (IApplicationThread) contextThread;                                                                \n    if (mActivityMonitors != null) {                                       \n        synchronized (mSync) {                                             \n            final int N = mActivityMonitors.size();                        \n            for (int i=0; i<N; i++) {                                      \n                final ActivityMonitor am = mActivityMonitors.get(i);       \n                ActivityResult result = null;                              \n                if (am.ignoreMatchingSpecificIntents()) {\n                    // true 表示这个监视器被用于使用 onStartActivity 拦截所有 Activity 启动 \n                    result = am.onStartActivity(intent);                   \n                }                                                          \n                if (result != null) {                                      \n                    am.mHits++;                                            \n                    return result;                                         \n                } else if (am.match(who, null, intent)) {\n                    // match 使用 IntentFilter 和 类名 进行匹配\n                    am.mHits++;                                            \n                    if (am.isBlocking()) {\n                        // 当前监视器阻止 Activity 启动\n                        return requestCode >= 0 ? am.getResult() : null;   \n                    }                                                      \n                    break;                                                 \n                }                                                          \n            }                                                              \n        }                                                                  \n    }                                                                      \n    try {\n        // 委托为 ActivityManagerService(AMS) 去处理\n        int result = ActivityManager.getService().startActivity();                          \n        // 检查 AMS 的处理结果\n        checkStartActivityResult(result, intent);                          \n    } catch (RemoteException e) {                                          \n        throw new RuntimeException(\"Failure from system\", e);              \n    }                                                                      \n    return null;                                                           \n}                                                                          \n```\n\n可以通过最后的调用委托给了`ActivityManager.getService`，实际上就是 ActivityManagerService(AMS) 的 Binder 代理类实现\n\n> 相对于之前的版本，比如 Android 23，现在已经没有了 ActivityManagerProxy 和 ActivityManagerNative，将直接与 system_server 进程上的 AMS 进行 IPC\n\n``` java\npublic static IActivityManager getService() {\n    return IActivityManagerSingleton.get();  \n}\n\nprivate static final Singleton<IActivityManager> IActivityManagerSingleton =          \n        new Singleton<IActivityManager>() {                                           \n            @Override                                                                 \n            protected IActivityManager create() {                                     \n                final IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);\n                final IActivityManager am = IActivityManager.Stub.asInterface(b);     \n                return am;                                                            \n            }                                                                         \n        };                                                                            \n```\n\n### ActivityManagerService\n\n``` java\n@Override                                                                                       \npublic final int startActivity() {                           \n    return startActivityAsUser();                                                     \n}\n\n@Override                                                                                                                          \npublic final int startActivityAsUser() {                                                                                                                                   \n    return mActivityStarter.startActivityMayWait();                                                                                                \n}                                                                                                                                  \n```\n\n这里将启动请求又委托给了 ActivityStarter\n\n### ActivityStarter\n\n``` java\nfinal int startActivityMayWait() {                                                \n    // Intent 的响应\n    ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);                                                                                                                                           \n    // Intent 的 Activity 信息                                                               \n    ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);                                                                                                                                                                                                                                                                                                                                        \n        final ActivityRecord[] outRecord = new ActivityRecord[1];\n    \t// 调用 startActivityLocked\n        int res = startActivityLocked(outRecord);                                                                                                                          \n        return res;                                                                                                       \n    }                                                                                                                     \n}                                                                                                                         \n```\n\n``` java\nprivate int startActivity() {\n    // 源 Activity 记录，即在哪个 Activity 进行 startActivity\n    ActivityRecord sourceRecord = null;\n    // 如果使用 startActivityForResult，result 返回的 Activity 称为结果 Activity\n    ActivityRecord resultRecord = null;                                                                       \n    if (resultTo != null) {\n        // 获取 Activity Stack 中已经存在的源 Activity 记录\n        sourceRecord = mSupervisor.isInAnyStackLocked(resultTo);                                                                                 \n        if (sourceRecord != null) {                                                                           \n            if (requestCode >= 0 && !sourceRecord.finishing) {\n                // requestCode >= 0，源 Activity 同时为 结果 Activity\n                resultRecord = sourceRecord;                                                                  \n            }                                                                                                 \n        }                                                                                                     \n    }                                                                                                         \n                                                                                                              \n    final int launchFlags = intent.getFlags();                                                                \n                                                                                                              \n    if ((launchFlags & Intent.FLAG_ACTIVITY_FORWARD_RESULT) != 0 && sourceRecord != null) {                   \n        // 使用 FLAG_ACTIVITY_FORWARD_RESULT，可以将返回结果的源 Activity 转移为当前正在新启动的 Activity\n        // 比如：A -> B,B - C 使用了 FLAG_ACTIVITY_FORWARD_RESULT,那么 C 的 setResult 会返回给 A\n        if (requestCode >= 0) {\n            // 不允许有 requestCode\n            ActivityOptions.abort(options);                                                                   \n            return ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;                                        \n        }\n        // 将源 Activity 的结果 Activity 设置为新 Activity 的结果 Activity\n        resultRecord = sourceRecord.resultTo;                                                                 \n        if (resultRecord != null && !resultRecord.isInStackLocked()) {                                        \n            resultRecord = null;                                                                              \n        }\n        // requestCode 处理\n        resultWho = sourceRecord.resultWho;                                                                   \n        requestCode = sourceRecord.requestCode;                                                               \n        sourceRecord.resultTo = null;                                                                         \n        if (resultRecord != null) {\n            // 删除源 Activity 记录\n            resultRecord.removeResultsLocked(sourceRecord, resultWho, requestCode);                           \n        }                                                                                                                                                                                         \n    }                                                                                                         \n                                                                                                              \n    if (err == ActivityManager.START_SUCCESS && intent.getComponent() == null) {                              \n        // component 找不到                                                                         \n        err = ActivityManager.START_INTENT_NOT_RESOLVED;                                                      \n    }                                                                                                         \n                                                                                                              \n    if (err == ActivityManager.START_SUCCESS && aInfo == null) {                                              \n        // ActivityInfo 找不到                                                                         \n        err = ActivityManager.START_CLASS_NOT_FOUND;                                                          \n    }                                                                                                         \n                                                                                                              \n    if (err == ActivityManager.START_SUCCESS && sourceRecord != null                                          \n            && sourceRecord.getTask().voiceSession != null) {                                                 \n        // 语音启动 Activity，检查是否符合                                                                      \n    }                                                                                                         \n                                                                                                              \n    if (err == ActivityManager.START_SUCCESS && voiceSession != null) {                                       \n        // 启动语音会话                                                       \n    }                                                                                                         \n                                                                                                              \n    final ActivityStack resultStack = resultRecord == null ? null : resultRecord.getStack();                  \n                                                                                                              \n    if (err != START_SUCCESS) {\n        // 启动 Activity 失败\n        if (resultRecord != null) {\n            // 发送取消通知\n            resultStack.sendActivityResultLocked(                                                             \n                    -1, resultRecord, resultWho, requestCode, RESULT_CANCELED, null);                         \n        }                                                                                                     \n        ActivityOptions.abort(options);                                                                       \n        return err;                                                                                           \n    }                                                                                                         \n                                                                                                              \n    // 进行一些权限检查，判断是否终止                                                              \n    if (abort) {\n        // 如果需要终止 Activity\n        if (resultRecord != null) {                                                                           \n            resultStack.sendActivityResultLocked();                                                                   \n        }                                                                                                     \n        // 返回启动成功，实际终止                                                                \n        ActivityOptions.abort(options);                                                                       \n        return START_SUCCESS;                                                                                 \n    }                                                                                                         \n                                                                                                              \n    // 如果权限检查是否在启动 Activity 之前，那么先启动权限检查的 Intent                                                             \n                                                                                                              \n    // 处理 ephemeral app                                                                    \n    \n    // 构造一个 ActivityRecord\n    ActivityRecord r = new ActivityRecord();                                                   \n                                                                                                     \n    final ActivityStack stack = mSupervisor.mFocusedStack;                                                    \n    if (voiceSession == null && (stack.mResumedActivity == null                                               \n            || stack.mResumedActivity.info.applicationInfo.uid != callingUid)) {\n        // 前台 stack 还没 resume 状态的 Activity，检查是否允许 app 切换\n        if (!mService.checkAppSwitchAllowedLocked() {                                          \n            PendingActivityLaunch pal =  new PendingActivityLaunch();                                              \n            mPendingActivityLaunches.add(pal);                                                                \n            ActivityOptions.abort(options);\n            // 切换 app 失败\n            return ActivityManager.START_SWITCHES_CANCELED;                                                   \n        }                                                                                                     \n    }                                                                                                         \n                                                                                                              \n    if (mService.mDidAppSwitch) {                                                                             \n        // 从上次禁止 app 切换以来，这是第二次，允许 app 切换，并将切换时间设置为 0                                                            \n        mService.mAppSwitchesAllowedTime = 0;                                                                 \n    } else {                                                                                                  \n        mService.mDidAppSwitch = true;                                                                        \n    }                                                                                                         \n    \n    // 执行因为不允许 app 切换，而加到等待启动的 Activity\n    doPendingActivityLaunchesLocked(false);                                                                   \n                                                                                                              \n    return startActivity();                                                                    \n}                                                                                                             \n```\n\n``` java\nprivate int startActivity() {                                                        \n    int result = START_CANCELED;                                                               \n    try {                                                                                      \n        mService.mWindowManager.deferSurfaceLayout();\n        // 下一步流程\n        result = startActivityUnchecked();                           \n    } finally {                                                                                \n        // 如果启动 Activity 没有成功， 从 task 中移除 Activity                                                      \n        if (!ActivityManager.isStartResultSuccessful(result)                                   \n                && mStartActivity.getTask() != null) {                                         \n            mStartActivity.getTask().removeActivity(mStartActivity);                           \n        }                                                                                      \n        mService.mWindowManager.continueSurfaceLayout();                                       \n    }                                                                                          \n                                                                                               \n    postStartActivityProcessing();                                                                     \n                                                                                               \n    return result;                                                                             \n}                                                                                              \n```\n\n``` java\nprivate int startActivityUnchecked() {\n\t\n    // 设置一些初始化状态\n    setInitialState();\n    // 计算 launch flags\n    computeLaunchingTaskFlags();\n    // 计算源 Task，源 Task 是否存在等\n    computeSourceStack();\n    // 获取是否存在可以复用的 Activity，根据 flags 和 launchMode\n    ActivityRecord reusedActivity = getReusableIntentActivity();\n    if (reusedActivity != null) {\n    \t// 存在可复用的 Activity，复用它\n        // 可能需要清除 Task 中其他 Activity，并将启动的 Activity 前置\n    }\n    if (mStartActivity.packageName == null) {\n    \treturn START_CLASS_NOT_FOUND;\n    }\n    // 如果启动的 Activity 与当前 Task 顶部的 Activity 相同，判断是否需要继续启动新的 Activity\n    final boolean dontStart = top != null && mStartActivity.resultTo == null\n                && top.realActivity.equals(mStartActivity.realActivity)\n                && top.userId == mStartActivity.userId\n                && top.app != null && top.app.thread != null\n                && ((mLaunchFlags & FLAG_ACTIVITY_SINGLE_TOP) != 0\n                || mLaunchSingleTop || mLaunchSingleTask);\n    if(dontStart){\n        // 传递一个新的 Intent 到 onNewIntent \n        top.deliverNewIntentLocked();\n        return START_DELIVERED_TO_TOP;\n    }\n    \n    // 获取 mTargetStack\n    if (mStartActivity.resultTo == null && mInTask == null && !mAddingToTask\n                && (mLaunchFlags & FLAG_ACTIVITY_NEW_TASK) != 0) {\n    \tnewTask = true;\n        // 需要创建新的 Task\n        result = setTaskFromReuseOrCreateNewTask();\n    } else if (mSourceRecord != null) {\n        // 从源 Activity 中获取 Task\n    \tresult = setTaskFromSourceRecord();\n    } else if (mInTask != null) {\n        // 从 InTask 中获取 Task\n    \tresult = setTaskFromInTask();\n    } else {\n        // 可能创建新的 Task 或使用当前 Task，一般不会发生\n    \tsetTaskToCurrentTopOrCreateNewTask();\n    }\n    \n    // 使用 mTargetStack 启动 Activity \n    mTargetStack.startActivityLocked();\n    \n    if (mDoResume) {\n        if (!mTargetStack.isFocusable()\n                    || (topTaskActivity != null && topTaskActivity.mTaskOverlay\n                    && mStartActivity != topTaskActivity)) {\n        \t// 目标 Task 不可聚焦 ，或者源 Task 栈顶 Activity 总是在其他 Activity 之上，并且不为源 Activity\n            // 那么我们不恢复目标 Task，只需要确保它可见即可\n            mTargetStack.ensureActivitiesVisibleLocked(null, 0, !PRESERVE_WINDOWS);\n        }\n    } else {\n        if (mTargetStack.isFocusable() && !mSupervisor.isFocusedStack(mTargetStack)) {\n        \t// 如果目标 Task 之前不是可聚焦，但是现在为可聚焦，那么移动到前台\n            mTargetStack.moveToFront(\"startActivityUnchecked\");\n        }\n        // 恢复目标 Task\n        mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,\n                        mOptions);\n    } else {\n        // 如果不需要恢复，那么加到\"最近活动\"中\n        mTargetStack.addRecentActivityLocked(mStartActivity);\n    }\n    \n    return START_SUCCESS;\n}\n\nprivate void setInitialState(){\n    // 获取 DisplayId\n    mSourceDisplayId = getSourceDisplayId();\n    // 获取用于启动 Activity 的范围，Rect\n    mLaunchBounds = getOerrideBounds();\n    // launchMode\n    mLaunchSingleTop = r.launchmode == LAUNCH_SINGLE_TOP;\n    mLaunchSingleInstance = r.launchMode == LAUNCH_SINGLE_INSTANCE;\n    mLaunchSingleTask = r.launchMode == LAUNCH_SINGLE_TASK;\n    // Intent flags 的处理，如果和 Manifest 存在冲突，以 Manifest 为主\n    // 如果 requestCode >= 0，同时启动的 Activity 位于新的 Task，发送取消的结果给源 Activity\n    sendNewTaskResultRequestIfNeeded();\n}\n\nprivate void computeLaunchingTaskFlags(){\n    if (mSourceRecord == null && mInTask != null && mInTask.getStack() != null){\n        // 如果不存在源 Activity\n        final Intent baseIntent = mInTask.getBaseIntent();\n        final ActivityRecord root = mInTask.getRootActivity();\n        if (baseIntent == null){\n            throw new IllegalArgumentException();\n        }\n        if (mLaunchSingleInstance || mLaunchSingleTask) {\n            // 如果设置了 SingleInstacne 或 SingleTask\n        \tif (!baseIntent.getComponent().equals(mStartActivity.intent.getComponent())){\n                // Task 不符合\n                throw new IllegalArgumentException();\n            }\n            \n            if(root != null){\n                // 已经存在 Task 根 Activity\n                throw new IllegalArgumentException();\n            }\n        }\n        \n        if (root == null) {\n        \t// 如果不存在根 Activity，重新设置 launch flags\n            mAddingToTask = true;\n        }else if ((mLaunchFlags & FLAG_ACTIVITY_NEW_TASK) != 0) {\n             mAddingToTask = false;\n        }else {\n            mAddingToTask = true;\n        }\n    }else {\n                     if ((mStartActivity.isResolverActivity() || mStartActivity.noDisplay) && mSourceRecord != null\n                    && mSourceRecord.isFreeform())  {\n                         // 如果使用 ResolverActivity 启动或者 noDisplay\n                mAddingToTask = true;\n            }\n    }\n    \n    if(mInTask == null){\n        if (mSourceRecord == null) {\n        \tif ((mLaunchFlags & FLAG_ACTIVITY_NEW_TASK) == 0 && mInTask == null) {\n                // 不存在 Task，并且不存在源 Activity\n            \tmLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;\n            }\n        }else if (mSourceRecord.launchMode == LAUNCH_SINGLE_INSTANCE) {\n        \t// 如果源 Activity 的 launchMode 是 SingleInstance，要设置 NEW_TASK flag\n            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;\n        }else if (mLaunchSingleInstance || mLaunchSingleTask) {\n        \t// 如果启动 Activity 的 launchMode 是 SingleInstance 或 SingleTask，需要设置 NEW_TASK flag\n            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;\n        }\n    }\n    \n}\n```\n\nActivityStarter 主要的作用是，计算 launch flags，创建或者复用合适的 Task，即 ActivityStack，从而启动 Activity\n\n### ActivityStack\n\n``` java\nfinal void startActivityLocked(){\n    if(!newTask) {\n      // 如果从已存在的 Task 中启动 Activity\n      boolean startIt = true;\n      for (int taskNdx = mTaskHistory.size() - 1; taskNdx >= 0; --taskNdx) {\n      \ttask = mTaskHistory.get(taskNdx);\n          if (task.getTopActivity() == null){\n              // 如果 task 不存在 Activity\n              continue;\n          }\n          if (task == rTask) {\n          \t// 找到对应的 task\n            if (!startIt) {\n            \t// 如果当前对于用户还不可见，那么只是添加它，而不启动它，它将在用户导航回来时启动\n                r.createWindowContainer();\n                ActivityOptions.abort(options);\n                return;\n            }\n          } else if (task.numFullscreen > 0) {\n              startIt = false;\n          }\n      }\n    }\n    \n    // 如果当前 task 为活动 task，那么不需要传递 onuserLeaving 回调\n    if (task == activityTask && mTaskHistory.indexOf(task) != (mTaskHistory.size() - 1)) {\n        mStackSupervisor.mUserLeaving = false;\n    }\n    \n    if (!isHomeOrRecentsStack() || numActivities() > 0) {\n    \t// 如果当前不是 Home 或 Recent Task,或者活动 Activity 数量大于 0\n        \n        // 处理 动画\n        \n        if (newTask) {\n            if ((r.intent.getFlags() & Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != 0) {\n            // 如果设置了重置的标记\n            resetTaskIfNeededLocked(r, r);\n            doShow = topRunningNonDelayedActivityLocked(null) == r;\n            } else if (options != null && options.getAnimationType()\n                    == ActivityOptions.ANIM_SCENE_TRANSITION) {\n                // 需要进行转场动画\n                doShow = false;\n        }\n    }\n        \n        \n        if (r.mLaunchTaskBehind) {\n        \t// 如果为 true，那么不开启 window，但要确保 Activity 是可见的\n            r.setVisibility(true);\n            ensureActivitiesVisibleLocked(null, 0, !PRESERVE_WINDOWS);\n        } else if (SHOW_APP_STARTING_PREVIEW && doShow) {\n            TaskRecord prevTask = r.getTask();\n            ActivityRecord prev = prevTask.topRunningActivityWithStartingWindowLocked();\n            if (prev != null) {\n                // 以下两种情况不展示之前的 Activity 预览\n            \tif (prev.getTask() != prevTask) {\n                    // 之前的 Activity 在不同的 Task\n                \tprev = null;\n                } else if (prev.nowVisible) {\n                    // 现在可见\n                \t prev = null;\n                }\n            }\n            // 显示启动 Activity 的 Window\n        \tr.showStartingWindow(prev, newTask, isTaskSwitch(r, focusedTopActivity));\n        } else {\n            // 当前为栈顶 Activity\n            ActivityOptions.abort(options);\n        }\n    \n}\n```\n\n`ActivityStack.startActivityLocked` 主要是创建 WindowContainer，同时显示 Window\n\n### ActivityStackSupervisor\n\n``` java\nboolean resumeFocusedStackTopActivityLocked(){\n    if (targetStack != null && isFocusedStack(targetStack)) {\n        // 存在 targetStack\n    \treturn targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);\n    }\n    final ActivityRecord r = mFocusedStack.topRunningActivityLocked();\n    if (r == null || r.state != RESUMED) {\n        // 恢复聚焦 task\n    \tmFocusedStack.resumeTopActivityUncheckedLocked(null, null);\n    } else if (r.state == RESUMED) {\n        // 执行应用转场动画\n    \tmFocusedStack.executeAppTransition(targetOptions);\n    }\n}\n```\n\n### ActivityStack\n\n``` java\nboolean resumeTopActivityUncheckedLocked() {\n    if (mStackSupervisor.inResumeTopActivity) {\n        // 防止递归\n    \treturn false;\n    }\n    try {\n        // 设置恢复标记\n        mStackSupervisor.inResumeTopActivity = true;\n        result = resumeTopActivityInnerLocked(prev, options);\n    } finally {\n        mStackSupervisor.inResumeTopActivity = false;\n    }\n    // 在恢复过程中，确保必要的暂停逻辑\n    mStackSupervisor.checkReadyForSleepLocked();\n}\n```\n\n``` java\nprivate boolean resumeTopActivityInnerLocked() {\n    \n    // 寻找需要恢复的栈顶 Activity，它必须是未结束并且聚焦\n    final ActivityRecord next = topRunningActivityLocked(true /* focusableOnly */);\n    final boolean hasRunningActivity = next != null;\n    final ActivityRecord parent = mActivityContainer.mParentActivity;\n    final boolean isParentNotResumed = parent != null && parent.state != ActivityState.RESUMED;\n    if (hasRunningActivity\n                && (isParentNotResumed || !mActivityContainer.isAttachedLocked())) {\n           // 如果父 Activity 不是恢复状态，则不恢复当前 Activity\n            return false;\n        }\n    \n    if (!hasRunningActivity) {\n        // 当前 Task 没有需要恢复的 Activity\n    \treturn resumeTopActivityInNextFocusableStack(prev, options, \"noMoreActivities\");\n    }\n    \n    if (mResumedActivity == next && next.state == ActivityState.RESUMED &&\n                    mStackSupervisor.allResumedActivitiesComplete()) {\n        // 如果 Activity 已经是恢复状态\n        // 确保已经执行了所有等待的转场\n        executeAppTransition(options);\n    \treturn false;\n    }\n    \n    if (mService.isSleepingOrShuttingDownLocked()\n                && mLastPausedActivity == next\n                && mStackSupervisor.allPausedActivitiesComplete()) {\n    \t// 如果系统处于休眠状态，当前 Activity 处于暂停状态\n        // 确保转场执行\n        executeAppTransition(options);\n        return false;\n    }\n    \n    if (!mService.mUserController.hasStartedUserState(next.userId)) {\n        // 如果拥有该 Activity 的用户没有启动\n    \treturn false;\n    }\n    \n    if (!mStackSupervisor.allPausedActivitiesComplete()) {\n    \t// 如果存在暂停 Activity 的操作未完成\n        return false;\n    }\n    \n    boolean lastResumedCanPip = false;\n    final ActivityStack lastFocusedStack = mStackSupervisor.getLastStack();\n    if (lastFocusedStack != null && lastFocusedStack != this) {\n    \tfinal ActivityRecord lastResumed = lastFocusedStack.mResumedActivity;\n        // 最后一个恢复的 Activity 是否可以 画中画\n        lastResumedCanPip = lastResumed != null && lastResumed.checkEnterPictureInPictureState(\n                    \"resumeTopActivity\", true /* noThrow */, userLeaving /* beforeStopping */);\n    }\n    \n    // 是否需要可以在上一个 Activity 暂停时进行恢复\n    final boolean resumeWhilePausing = (next.info.flags & FLAG_RESUME_WHILE_PAUSING) != 0\n                && !lastResumedCanPip;\n    // 是否暂停了回退的 task\n    boolean pausing = mStackSupervisor.pauseBackStacks(userLeaving, next, false);\n    \n    if (mResumedActivity != null) {\n        // 暂停上一个恢复状态的 Activity\n    \tpausing |= startPausingLocked(userLeaving, false, next, false);\n    }\n    \n    if (pausing && !resumeWhilePausing) {\n    \t// 之前的 Activity 已经暂停，但不能进行恢复当前 Activity\n        if (next.app != null && next.app.thread != null) {\n            // hosting application，一般不执行\n            // 让当前 Activity 放在 Lru 的顶部，避免早早杀死\n        \tmService.updateLruProcessLocked(next.app, true, null);\n        }\n        return true;\n    } else if (mResumedActivity == next && next.state == ActivityState.RESUMED &&\n                mStackSupervisor.allResumedActivitiesComplete()) {\n    \t// 当前需要恢复的 Activity 已经是恢复状态\n        // 确保执行转场\n        executeAppTransition(options);\n        return true;\n    }\n    \n    if (mService.isSleepingLocked() && mLastNoHistoryActivity != null &&\n                !mLastNoHistoryActivity.finishing) {\n        // 结束因为系统休眠而还没结束的 Activity\n    \trequestFinishActivityLocked(mLastNoHistoryActivity.appToken, Activity.RESULT_CANCELED,\n                    null, \"resume-no-history\", false);\n        mLastNoHistoryActivity = null;\n    }\n    \n    if (prev != null && prev != next) {\n    \tif (!mStackSupervisor.mActivitiesWaitingForVisibleActivity.contains(prev)\n                    && next != null && !next.nowVisible) {\n        \tmStackSupervisor.mActivitiesWaitingForVisibleActivity.add(prev);\n        } else {\n            // 如果当前需要恢复的 Activity 已经可见，所有隐藏上一个 Activity\n            if (prev.finishing) {\n            \tprev.setVisibility(false);\n            } else {\n                \n            }\n        }\n    }\n    \n    // Activity 转场处理\n    \n    ActivityStack lastStack = mStackSupervisor.getLastStack();\n    if (next.app != null && next.app.thread != null) {\n        // 上一个 Activity 是否为透明\n    \tfinal boolean lastActivityTranslucent = lastStack != null\n                    && (!lastStack.mFullscreen\n                    || (lastStack.mLastPausedActivity != null\n                    && !lastStack.mLastPausedActivity.fullscreen));\n        \n        if (!next.visible || next.stopped || lastActivityTranslucent) {\n            // 前一个 Activity 为透明，并且当前 Activity 还没显示\n            // 设置为显示状态\n            next.setVisibility(true);\n        }\n        \n        // 让窗口管理器重新基于新的 Activity 顺序评估屏幕的方向\n    boolean notUpdated = true;\n    if (mStackSupervisor.isFocusedStack(this)) {\n    \tfinal Configuration config = mWindowManager.updateOrientationFromAppTokens(\n                        mStackSupervisor.getDisplayOverrideConfiguration(mDisplayId),\n                        next.mayFreezeScreenLocked(next.app) ? next.appToken : null, mDisplayId);\n        \n        if (config != null) {\n    \tnext.frozenBeforeDestroy = true;\n        }\n        notUpdated = !mService.updateDisplayOverrideConfigurationLocked(config, next,\n                        false /* deferResume */, mDisplayId);\n    }\n    \n     if (notUpdated) {\n         // 配置发生更新无法保持已经存在的 Activity 实例\n         // 重新获取需要恢复的 Activity\n         ActivityRecord nextNext = topRunningActivityLocked();\n         // 确保 Activity 仍然保持在栈顶，同时安排另外一次执行\n         if (nextNext != next) {\n         \tmStackSupervisor.scheduleResumeTopActivities();\n         }\n         if (!next.visible || next.stopped) {\n         \tnext.setVisibility(true);\n         }\n         next.completeResumeLocked();\n         return true;\n     }\n    \n    try {\n        // 传递所有等待的结果\n        \n        if (next.newIntents != null){\n            next.app.thread.scheduleNewIntent(\n                            next.newIntents, next.appToken, false /* andPause */);\n        }\n        \n        next.notifyAppResumed(next.stopped);\n        \n        // 准备恢复 Activity\n        next.app.thread.scheduleResumeActivity(next.appToken, next.app.repProcState,\n                        mService.isNextTransitionForward(), resumeAnimOptions);\n    } catch (Exception e){\n        // 发生异常，重新启动 Activity\n        mStackSupervisor.startSpecificActivityLocked(next, true, false);\n        return true;\n    }\n        \n        try {\n            next.completeResumeLocked();\n        } catch(Exception e){\n            // 发生异常，结束 Activity\n            requestFinishActivityLocked(next.appToken, Activity.RESULT_CANCELED, null,\n                        \"resume-exception\", true);\n            return true;\n        }\n        \n    } else {\n        // 需要启动 Activity\n        mStackSupervisor.startSpecificActivityLocked(next, true, true);\n    }\n    \n    return true;\n\n}\n```\n\n如果可以不需要重新启动 Activity，则直接恢复 Activity 即可，否则进行重新启动流程：\n\n### ActivityStackSupervisor\n\n``` java\nvoid startSpecificActivityLocked() {\n    // 获取应用进程信息\n    ProcessRecord app = mService.getProcessRecordLocked(r.processName,\n                r.info.applicationInfo.uid, true);\n    \n    if (app != null && app.thread != null) {\n    \t// 如果进程已经启动\n        try {\n            realStartActivityLocked(r, app, andResume, checkConfig);\n            return;\n        }catch (RemoteException e){\n            \n        }\n    }\n    \n    // 启动应用进程\n    mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,\n                \"activity\", r.intent.getComponent(), false, false, true);\n}\n```\n\n``` java\nfinal boolean realStartActivityLocked() {\n    // 冻结屏幕\n    r.startFreezingScreenLocked(app, 0);\n    if (checkConfig) {\n    \t// 根据新的 Activity 顺序重新评估屏幕的方向\n    }\n    \n    int idx = app.activities.indexOf(r);\n    if (idx < 0) {\n        // 将 Activity 添加到应用进程中\n        app.activities.add(r);\n    }\n    \n    try {\n        app.thread.scheduleLaunchActivity();\n    }catch(RemoteException e){\n        // 发生异常，结束 Activity\n        stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, null,\n                        \"2nd-crash\", false);\n        return false;\n    }\n    \n    return true;\n}\n```\n\n启动流程最后还是回到了 ApplicationThread\n\n### ApplicationThread\n\n``` java\npublic final void scheduleLaunchActivity() {\n    // 通过 Handler 发送 LAUNCH_ACTIVITY\n    sendMessage(H.LAUNCH_ACTIVITY, r);\n}\n```\n\n我们单独把 LAUNCH_ACTIVITY 的处理拿出来：\n\n``` java\nfinal ActivityClientRecord r = (ActivityClientRecord) msg.obj;\nr.packageInfo = getPackageInfoNoCheck(\n                            r.activityInfo.applicationInfo, r.compatInfo);\nhandleLaunchActivity(r, null, \"LAUNCH_ACTIVITY\");\n```\n\n### ActivityThread\n\n``` java\nprivate void handleLaunchActivity() {\n    // 执行启动 Activity\n    Activity a = performLaunchActivity(r, customIntent);\n    if (a != null) {\n        // resume activity\n        handleResumeActivity(r.token, false, r.isForward,\n                    !r.activity.mFinished && !r.startsNotResumed, r.lastProcessedSeq, reason);\n    } else {\n        \n    }\n}\n```\n\n``` java\nprivate performLaunchActivity() {\n    // Activity 信息初始化\n    \n    // 创建 context\n    ContextImpl appContext = createBaseContextForActivity(r);\n    Activity activity = null;\n    try {\n        java.lang.ClassLoader cl = appContext.getClassLoader();\n        // 构建 Activity\n        activity = mInstrumentation.newActivity(\n                    cl, component.getClassName(), r.intent);\n    }catch(Exception e){\n        \n    }\n    \n    try {\n        Application app = r.packageInfo.makeApplication(false, mInstrumentation);\n        if(activity != null){\n        \tactivity.attach();\n            \n            // 通过 Instrumentation 执行 Activity onCreate\n            if (r.isPersistable()) {\n                 mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);\n            }else {\n                mInstrumentation.callActivityOnCreate(activity, r.state);\n            }\n            \n            if (!r.activity.mFinished) {\n                // Activity onStart\n            \tactivity.performStart();\n            }\n            \n            // 通过 Instrumentation 执行 Activity onRestoreInstanceState\n            if (!r.activity.mFinished) {\n            \tif (r.isPersistable()) {\n                \tif (r.state != null || r.persistentState != null) {\n                    \tmInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,\n                                    r.persistentState);\n                    }\n                } else if (r.state != null) {\n                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);\n                }\n            }\n            \n             // 通过 Instrumentation 执行 Activity onPostCreeate\n            if (!r.activity.mFinished) {\n            \tif (r.isPersistable()) {\n                    mInstrumentation.callActivityOnPostCreate(activity, r.state,\n                                r.persistentState);\n                }else {\n                    mInstrumentation.callActivityOnPostCreate(activity, r.state);\n                }\n            }       \n    }\n        \n    return activity;\n    \n}\n```\n\n``` java\nfinal void handleResumeActivity() {\n    r = performResumeActivity();\n    if(r != null) {\n        final Activity a = r.activity;\n        if (r.window == null && !a.mFinished && willBeVisible) {\n            r.window = r.activity.getWindow();\n            View decor = r.window.getDecorView();\n            decor.setVisibility(View.INVISIBLE);\n            ViewManager wm = a.getWindowManager();\n            if (a.mVisibleFromClient) {\n            \tif (!a.mWindowAdded) {\n                \ta.mWindowAdded = true;\n                    // window\n                    wm.addView(decor, l);\n                }\n            }\n        }\n    }\n}\n```\n\n``` java\npublic final ActivityClientRecord performResumeActivity() {\n \tif (r != null && !r.activity.mFinished) {\n    \ttry {\n            // 处理等待的 Intent\n            if (r.pendingIntents != null) {\n            \tdeliverNewIntents(r, r.pendingIntents);\n                r.pendingIntents = null;\n            }\n            // 处理等待的 result\n            if (r.pendingResults != null) {\n            \tdeliverResults(r, r.pendingResults);\n                r.pendingResults = null;\n            }\n            // 执行 resume\n            r.activity.performResume();\n        }\n    }\n}\n```\n\n### Instrumentation\n\n``` java\npublic Activity newActivity(){\n    return (Activity)cl.loadClass(className).newInstance();\n}\n```\n\n``` java\nprivate void callActivityOnCreate(){\n    prePerformCreate(activity);\n    activity.performCreate(icicle);\n    postPerformCreate(activity);\n}\n```\n\n### Activity\n\n``` java\nfinal void performCreate() {\n    restoreHasCurrentPermissionRequest(icicle);\n    // 调用 onCreate\n    onCreate(icicle);\n    mActivityTransitionState.readState(icicle);\n    performCreateCommon();\n}\n```\n\n``` java\nfinal void performStart() {\n    mActivityTransitionState.setEnterActivityOptions(this, getActivityOptions());\n    mInstrumentation.callActivityOnStart(this);\n    mActivityTransitionState.enterReady(this);\n}\n```\n\n``` java\nfinal void performResume() {\n    // 执行 restart\n    performRestart();\n    mInstrumentation.callActivityOnResume(this);\n}\n```\n\n``` java\nfinal void performRestart() {\n    if (mStopped) {\n        mStopped = false;\n        mInstrumentation.callActivityOnRestart(this);\n        // 执行 start\n        performStart();\n    }\n}\n```\n\n### Instrumentation\n\n``` java\npublic void callActivityOnStart() {\n    activity.onStart();\n}\n```\n\n``` java\npublic void callActivityOnResume() {\n     activity.mResumed = true;\n    activity.onResume();\n}\n```\n\n``` java\npublic void callActivityOnRestart() {\n    activity.onRestart();\n}\n```\n\n## 总结\n\n简单总结下 Activity 的启动流程：\n\n1. 从用户应用进程开始启动，如果从桌面启动，则为 launcher 进程，用户进程通过 Binder 机制与 system_server 进程进行通信\n2. ActivityManagerService 用于管理所有的 Activity 活动\n   * 当接受到启动 Activity 的调用时，使用 `resolveActivity` ，查询系统中符合要求的 Activity\n   * 创建使用合适的  ActivityStack 和 launch flags 来启动 Activity\n   * 如果存在可以直接恢复 Activity，则恢复，否则重新启动 Activity\n   * 如果不存在应用进程，先创建应用进程\n3. 最终启动流程又会通过 Binder 调用回应用进程，使用 ActivityThread 去执行\n   * 使用 Instrumentation 去通过反射构建 Activity 实例\n   * 使用 Handler 机制调用 Activity 的生命周期\n\n下面的图例来自[博客](http://gityuan.com/2016/03/12/start-activity/)：\n\n![启动流程](http://gityuan.com/images/activity/start_activity_process.jpg)\n\n### 时序图\n\n![Android启动流程](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png?x-oss-process=style/doc-img)\n\n","source":"_posts/Activity启动流程-基于Android26.md","raw":"---\ntitle: Activity启动流程(基于Android26)\ndate: 2018-03-27 09:54:17\ncategories: Android\ntags: Android Framework\n---\n\n> 基于 Android 26，分析 Android Activity 启动流程\n\n## 参考\n\n[startActivity启动过程分析](http://gityuan.com/2016/03/12/start-activity/)\n\n## 源码\n\n**源码篇幅可能过长，所以会省略一下不必要的代码和注释**\n\n### Activity\n\n``` java\n@Override                                    \npublic void startActivity() {   \n    this.startActivity(intent, null);        \n}\n\n@Override                                                           \npublic void startActivity() {\n    if (options != null) {                                          \n        startActivityForResult(intent, -1, options);                \n    } else {                                                        \n        startActivityForResult(intent, -1);                         \n    }                                                               \n}                                                                   \n```\n\n最终都会调用到 `startActivityForResult`：\n\n``` java\npublic void startActivityForResult() {                                                             \n    if (mParent == null) {\n        // 转场动画的处理\n        Instrumentation.ActivityResult ar = mInstrumentation.execStartActivity();                                                                                                                                                      \n        if (ar != null) {                                                                       \n            mMainThread.sendActivityResult();                                                                                                             \n        }                                                                                       \n        if (requestCode >= 0) {                                                                                        \n            mStartedActivity = true;                                                            \n        }                                                                                                                                                                             \n    } else {                                                                                    \n        // 如果存在 Parent Activity 则交由它处理                                                                                    \n    }                                                                                           \n}                                                                                               \n```\n\n可以知道 Activity 启动委托给了 Instrumentation 进行实现\n\n### Instrumentation\n\n``` java\npublic ActivityResult execStartActivity() {\n    // 由 ActivityThread.getApplicationThread 提供的 ApplicationThread\n    IApplicationThread whoThread = (IApplicationThread) contextThread;                                                                \n    if (mActivityMonitors != null) {                                       \n        synchronized (mSync) {                                             \n            final int N = mActivityMonitors.size();                        \n            for (int i=0; i<N; i++) {                                      \n                final ActivityMonitor am = mActivityMonitors.get(i);       \n                ActivityResult result = null;                              \n                if (am.ignoreMatchingSpecificIntents()) {\n                    // true 表示这个监视器被用于使用 onStartActivity 拦截所有 Activity 启动 \n                    result = am.onStartActivity(intent);                   \n                }                                                          \n                if (result != null) {                                      \n                    am.mHits++;                                            \n                    return result;                                         \n                } else if (am.match(who, null, intent)) {\n                    // match 使用 IntentFilter 和 类名 进行匹配\n                    am.mHits++;                                            \n                    if (am.isBlocking()) {\n                        // 当前监视器阻止 Activity 启动\n                        return requestCode >= 0 ? am.getResult() : null;   \n                    }                                                      \n                    break;                                                 \n                }                                                          \n            }                                                              \n        }                                                                  \n    }                                                                      \n    try {\n        // 委托为 ActivityManagerService(AMS) 去处理\n        int result = ActivityManager.getService().startActivity();                          \n        // 检查 AMS 的处理结果\n        checkStartActivityResult(result, intent);                          \n    } catch (RemoteException e) {                                          \n        throw new RuntimeException(\"Failure from system\", e);              \n    }                                                                      \n    return null;                                                           \n}                                                                          \n```\n\n可以通过最后的调用委托给了`ActivityManager.getService`，实际上就是 ActivityManagerService(AMS) 的 Binder 代理类实现\n\n> 相对于之前的版本，比如 Android 23，现在已经没有了 ActivityManagerProxy 和 ActivityManagerNative，将直接与 system_server 进程上的 AMS 进行 IPC\n\n``` java\npublic static IActivityManager getService() {\n    return IActivityManagerSingleton.get();  \n}\n\nprivate static final Singleton<IActivityManager> IActivityManagerSingleton =          \n        new Singleton<IActivityManager>() {                                           \n            @Override                                                                 \n            protected IActivityManager create() {                                     \n                final IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);\n                final IActivityManager am = IActivityManager.Stub.asInterface(b);     \n                return am;                                                            \n            }                                                                         \n        };                                                                            \n```\n\n### ActivityManagerService\n\n``` java\n@Override                                                                                       \npublic final int startActivity() {                           \n    return startActivityAsUser();                                                     \n}\n\n@Override                                                                                                                          \npublic final int startActivityAsUser() {                                                                                                                                   \n    return mActivityStarter.startActivityMayWait();                                                                                                \n}                                                                                                                                  \n```\n\n这里将启动请求又委托给了 ActivityStarter\n\n### ActivityStarter\n\n``` java\nfinal int startActivityMayWait() {                                                \n    // Intent 的响应\n    ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);                                                                                                                                           \n    // Intent 的 Activity 信息                                                               \n    ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);                                                                                                                                                                                                                                                                                                                                        \n        final ActivityRecord[] outRecord = new ActivityRecord[1];\n    \t// 调用 startActivityLocked\n        int res = startActivityLocked(outRecord);                                                                                                                          \n        return res;                                                                                                       \n    }                                                                                                                     \n}                                                                                                                         \n```\n\n``` java\nprivate int startActivity() {\n    // 源 Activity 记录，即在哪个 Activity 进行 startActivity\n    ActivityRecord sourceRecord = null;\n    // 如果使用 startActivityForResult，result 返回的 Activity 称为结果 Activity\n    ActivityRecord resultRecord = null;                                                                       \n    if (resultTo != null) {\n        // 获取 Activity Stack 中已经存在的源 Activity 记录\n        sourceRecord = mSupervisor.isInAnyStackLocked(resultTo);                                                                                 \n        if (sourceRecord != null) {                                                                           \n            if (requestCode >= 0 && !sourceRecord.finishing) {\n                // requestCode >= 0，源 Activity 同时为 结果 Activity\n                resultRecord = sourceRecord;                                                                  \n            }                                                                                                 \n        }                                                                                                     \n    }                                                                                                         \n                                                                                                              \n    final int launchFlags = intent.getFlags();                                                                \n                                                                                                              \n    if ((launchFlags & Intent.FLAG_ACTIVITY_FORWARD_RESULT) != 0 && sourceRecord != null) {                   \n        // 使用 FLAG_ACTIVITY_FORWARD_RESULT，可以将返回结果的源 Activity 转移为当前正在新启动的 Activity\n        // 比如：A -> B,B - C 使用了 FLAG_ACTIVITY_FORWARD_RESULT,那么 C 的 setResult 会返回给 A\n        if (requestCode >= 0) {\n            // 不允许有 requestCode\n            ActivityOptions.abort(options);                                                                   \n            return ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;                                        \n        }\n        // 将源 Activity 的结果 Activity 设置为新 Activity 的结果 Activity\n        resultRecord = sourceRecord.resultTo;                                                                 \n        if (resultRecord != null && !resultRecord.isInStackLocked()) {                                        \n            resultRecord = null;                                                                              \n        }\n        // requestCode 处理\n        resultWho = sourceRecord.resultWho;                                                                   \n        requestCode = sourceRecord.requestCode;                                                               \n        sourceRecord.resultTo = null;                                                                         \n        if (resultRecord != null) {\n            // 删除源 Activity 记录\n            resultRecord.removeResultsLocked(sourceRecord, resultWho, requestCode);                           \n        }                                                                                                                                                                                         \n    }                                                                                                         \n                                                                                                              \n    if (err == ActivityManager.START_SUCCESS && intent.getComponent() == null) {                              \n        // component 找不到                                                                         \n        err = ActivityManager.START_INTENT_NOT_RESOLVED;                                                      \n    }                                                                                                         \n                                                                                                              \n    if (err == ActivityManager.START_SUCCESS && aInfo == null) {                                              \n        // ActivityInfo 找不到                                                                         \n        err = ActivityManager.START_CLASS_NOT_FOUND;                                                          \n    }                                                                                                         \n                                                                                                              \n    if (err == ActivityManager.START_SUCCESS && sourceRecord != null                                          \n            && sourceRecord.getTask().voiceSession != null) {                                                 \n        // 语音启动 Activity，检查是否符合                                                                      \n    }                                                                                                         \n                                                                                                              \n    if (err == ActivityManager.START_SUCCESS && voiceSession != null) {                                       \n        // 启动语音会话                                                       \n    }                                                                                                         \n                                                                                                              \n    final ActivityStack resultStack = resultRecord == null ? null : resultRecord.getStack();                  \n                                                                                                              \n    if (err != START_SUCCESS) {\n        // 启动 Activity 失败\n        if (resultRecord != null) {\n            // 发送取消通知\n            resultStack.sendActivityResultLocked(                                                             \n                    -1, resultRecord, resultWho, requestCode, RESULT_CANCELED, null);                         \n        }                                                                                                     \n        ActivityOptions.abort(options);                                                                       \n        return err;                                                                                           \n    }                                                                                                         \n                                                                                                              \n    // 进行一些权限检查，判断是否终止                                                              \n    if (abort) {\n        // 如果需要终止 Activity\n        if (resultRecord != null) {                                                                           \n            resultStack.sendActivityResultLocked();                                                                   \n        }                                                                                                     \n        // 返回启动成功，实际终止                                                                \n        ActivityOptions.abort(options);                                                                       \n        return START_SUCCESS;                                                                                 \n    }                                                                                                         \n                                                                                                              \n    // 如果权限检查是否在启动 Activity 之前，那么先启动权限检查的 Intent                                                             \n                                                                                                              \n    // 处理 ephemeral app                                                                    \n    \n    // 构造一个 ActivityRecord\n    ActivityRecord r = new ActivityRecord();                                                   \n                                                                                                     \n    final ActivityStack stack = mSupervisor.mFocusedStack;                                                    \n    if (voiceSession == null && (stack.mResumedActivity == null                                               \n            || stack.mResumedActivity.info.applicationInfo.uid != callingUid)) {\n        // 前台 stack 还没 resume 状态的 Activity，检查是否允许 app 切换\n        if (!mService.checkAppSwitchAllowedLocked() {                                          \n            PendingActivityLaunch pal =  new PendingActivityLaunch();                                              \n            mPendingActivityLaunches.add(pal);                                                                \n            ActivityOptions.abort(options);\n            // 切换 app 失败\n            return ActivityManager.START_SWITCHES_CANCELED;                                                   \n        }                                                                                                     \n    }                                                                                                         \n                                                                                                              \n    if (mService.mDidAppSwitch) {                                                                             \n        // 从上次禁止 app 切换以来，这是第二次，允许 app 切换，并将切换时间设置为 0                                                            \n        mService.mAppSwitchesAllowedTime = 0;                                                                 \n    } else {                                                                                                  \n        mService.mDidAppSwitch = true;                                                                        \n    }                                                                                                         \n    \n    // 执行因为不允许 app 切换，而加到等待启动的 Activity\n    doPendingActivityLaunchesLocked(false);                                                                   \n                                                                                                              \n    return startActivity();                                                                    \n}                                                                                                             \n```\n\n``` java\nprivate int startActivity() {                                                        \n    int result = START_CANCELED;                                                               \n    try {                                                                                      \n        mService.mWindowManager.deferSurfaceLayout();\n        // 下一步流程\n        result = startActivityUnchecked();                           \n    } finally {                                                                                \n        // 如果启动 Activity 没有成功， 从 task 中移除 Activity                                                      \n        if (!ActivityManager.isStartResultSuccessful(result)                                   \n                && mStartActivity.getTask() != null) {                                         \n            mStartActivity.getTask().removeActivity(mStartActivity);                           \n        }                                                                                      \n        mService.mWindowManager.continueSurfaceLayout();                                       \n    }                                                                                          \n                                                                                               \n    postStartActivityProcessing();                                                                     \n                                                                                               \n    return result;                                                                             \n}                                                                                              \n```\n\n``` java\nprivate int startActivityUnchecked() {\n\t\n    // 设置一些初始化状态\n    setInitialState();\n    // 计算 launch flags\n    computeLaunchingTaskFlags();\n    // 计算源 Task，源 Task 是否存在等\n    computeSourceStack();\n    // 获取是否存在可以复用的 Activity，根据 flags 和 launchMode\n    ActivityRecord reusedActivity = getReusableIntentActivity();\n    if (reusedActivity != null) {\n    \t// 存在可复用的 Activity，复用它\n        // 可能需要清除 Task 中其他 Activity，并将启动的 Activity 前置\n    }\n    if (mStartActivity.packageName == null) {\n    \treturn START_CLASS_NOT_FOUND;\n    }\n    // 如果启动的 Activity 与当前 Task 顶部的 Activity 相同，判断是否需要继续启动新的 Activity\n    final boolean dontStart = top != null && mStartActivity.resultTo == null\n                && top.realActivity.equals(mStartActivity.realActivity)\n                && top.userId == mStartActivity.userId\n                && top.app != null && top.app.thread != null\n                && ((mLaunchFlags & FLAG_ACTIVITY_SINGLE_TOP) != 0\n                || mLaunchSingleTop || mLaunchSingleTask);\n    if(dontStart){\n        // 传递一个新的 Intent 到 onNewIntent \n        top.deliverNewIntentLocked();\n        return START_DELIVERED_TO_TOP;\n    }\n    \n    // 获取 mTargetStack\n    if (mStartActivity.resultTo == null && mInTask == null && !mAddingToTask\n                && (mLaunchFlags & FLAG_ACTIVITY_NEW_TASK) != 0) {\n    \tnewTask = true;\n        // 需要创建新的 Task\n        result = setTaskFromReuseOrCreateNewTask();\n    } else if (mSourceRecord != null) {\n        // 从源 Activity 中获取 Task\n    \tresult = setTaskFromSourceRecord();\n    } else if (mInTask != null) {\n        // 从 InTask 中获取 Task\n    \tresult = setTaskFromInTask();\n    } else {\n        // 可能创建新的 Task 或使用当前 Task，一般不会发生\n    \tsetTaskToCurrentTopOrCreateNewTask();\n    }\n    \n    // 使用 mTargetStack 启动 Activity \n    mTargetStack.startActivityLocked();\n    \n    if (mDoResume) {\n        if (!mTargetStack.isFocusable()\n                    || (topTaskActivity != null && topTaskActivity.mTaskOverlay\n                    && mStartActivity != topTaskActivity)) {\n        \t// 目标 Task 不可聚焦 ，或者源 Task 栈顶 Activity 总是在其他 Activity 之上，并且不为源 Activity\n            // 那么我们不恢复目标 Task，只需要确保它可见即可\n            mTargetStack.ensureActivitiesVisibleLocked(null, 0, !PRESERVE_WINDOWS);\n        }\n    } else {\n        if (mTargetStack.isFocusable() && !mSupervisor.isFocusedStack(mTargetStack)) {\n        \t// 如果目标 Task 之前不是可聚焦，但是现在为可聚焦，那么移动到前台\n            mTargetStack.moveToFront(\"startActivityUnchecked\");\n        }\n        // 恢复目标 Task\n        mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,\n                        mOptions);\n    } else {\n        // 如果不需要恢复，那么加到\"最近活动\"中\n        mTargetStack.addRecentActivityLocked(mStartActivity);\n    }\n    \n    return START_SUCCESS;\n}\n\nprivate void setInitialState(){\n    // 获取 DisplayId\n    mSourceDisplayId = getSourceDisplayId();\n    // 获取用于启动 Activity 的范围，Rect\n    mLaunchBounds = getOerrideBounds();\n    // launchMode\n    mLaunchSingleTop = r.launchmode == LAUNCH_SINGLE_TOP;\n    mLaunchSingleInstance = r.launchMode == LAUNCH_SINGLE_INSTANCE;\n    mLaunchSingleTask = r.launchMode == LAUNCH_SINGLE_TASK;\n    // Intent flags 的处理，如果和 Manifest 存在冲突，以 Manifest 为主\n    // 如果 requestCode >= 0，同时启动的 Activity 位于新的 Task，发送取消的结果给源 Activity\n    sendNewTaskResultRequestIfNeeded();\n}\n\nprivate void computeLaunchingTaskFlags(){\n    if (mSourceRecord == null && mInTask != null && mInTask.getStack() != null){\n        // 如果不存在源 Activity\n        final Intent baseIntent = mInTask.getBaseIntent();\n        final ActivityRecord root = mInTask.getRootActivity();\n        if (baseIntent == null){\n            throw new IllegalArgumentException();\n        }\n        if (mLaunchSingleInstance || mLaunchSingleTask) {\n            // 如果设置了 SingleInstacne 或 SingleTask\n        \tif (!baseIntent.getComponent().equals(mStartActivity.intent.getComponent())){\n                // Task 不符合\n                throw new IllegalArgumentException();\n            }\n            \n            if(root != null){\n                // 已经存在 Task 根 Activity\n                throw new IllegalArgumentException();\n            }\n        }\n        \n        if (root == null) {\n        \t// 如果不存在根 Activity，重新设置 launch flags\n            mAddingToTask = true;\n        }else if ((mLaunchFlags & FLAG_ACTIVITY_NEW_TASK) != 0) {\n             mAddingToTask = false;\n        }else {\n            mAddingToTask = true;\n        }\n    }else {\n                     if ((mStartActivity.isResolverActivity() || mStartActivity.noDisplay) && mSourceRecord != null\n                    && mSourceRecord.isFreeform())  {\n                         // 如果使用 ResolverActivity 启动或者 noDisplay\n                mAddingToTask = true;\n            }\n    }\n    \n    if(mInTask == null){\n        if (mSourceRecord == null) {\n        \tif ((mLaunchFlags & FLAG_ACTIVITY_NEW_TASK) == 0 && mInTask == null) {\n                // 不存在 Task，并且不存在源 Activity\n            \tmLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;\n            }\n        }else if (mSourceRecord.launchMode == LAUNCH_SINGLE_INSTANCE) {\n        \t// 如果源 Activity 的 launchMode 是 SingleInstance，要设置 NEW_TASK flag\n            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;\n        }else if (mLaunchSingleInstance || mLaunchSingleTask) {\n        \t// 如果启动 Activity 的 launchMode 是 SingleInstance 或 SingleTask，需要设置 NEW_TASK flag\n            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;\n        }\n    }\n    \n}\n```\n\nActivityStarter 主要的作用是，计算 launch flags，创建或者复用合适的 Task，即 ActivityStack，从而启动 Activity\n\n### ActivityStack\n\n``` java\nfinal void startActivityLocked(){\n    if(!newTask) {\n      // 如果从已存在的 Task 中启动 Activity\n      boolean startIt = true;\n      for (int taskNdx = mTaskHistory.size() - 1; taskNdx >= 0; --taskNdx) {\n      \ttask = mTaskHistory.get(taskNdx);\n          if (task.getTopActivity() == null){\n              // 如果 task 不存在 Activity\n              continue;\n          }\n          if (task == rTask) {\n          \t// 找到对应的 task\n            if (!startIt) {\n            \t// 如果当前对于用户还不可见，那么只是添加它，而不启动它，它将在用户导航回来时启动\n                r.createWindowContainer();\n                ActivityOptions.abort(options);\n                return;\n            }\n          } else if (task.numFullscreen > 0) {\n              startIt = false;\n          }\n      }\n    }\n    \n    // 如果当前 task 为活动 task，那么不需要传递 onuserLeaving 回调\n    if (task == activityTask && mTaskHistory.indexOf(task) != (mTaskHistory.size() - 1)) {\n        mStackSupervisor.mUserLeaving = false;\n    }\n    \n    if (!isHomeOrRecentsStack() || numActivities() > 0) {\n    \t// 如果当前不是 Home 或 Recent Task,或者活动 Activity 数量大于 0\n        \n        // 处理 动画\n        \n        if (newTask) {\n            if ((r.intent.getFlags() & Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != 0) {\n            // 如果设置了重置的标记\n            resetTaskIfNeededLocked(r, r);\n            doShow = topRunningNonDelayedActivityLocked(null) == r;\n            } else if (options != null && options.getAnimationType()\n                    == ActivityOptions.ANIM_SCENE_TRANSITION) {\n                // 需要进行转场动画\n                doShow = false;\n        }\n    }\n        \n        \n        if (r.mLaunchTaskBehind) {\n        \t// 如果为 true，那么不开启 window，但要确保 Activity 是可见的\n            r.setVisibility(true);\n            ensureActivitiesVisibleLocked(null, 0, !PRESERVE_WINDOWS);\n        } else if (SHOW_APP_STARTING_PREVIEW && doShow) {\n            TaskRecord prevTask = r.getTask();\n            ActivityRecord prev = prevTask.topRunningActivityWithStartingWindowLocked();\n            if (prev != null) {\n                // 以下两种情况不展示之前的 Activity 预览\n            \tif (prev.getTask() != prevTask) {\n                    // 之前的 Activity 在不同的 Task\n                \tprev = null;\n                } else if (prev.nowVisible) {\n                    // 现在可见\n                \t prev = null;\n                }\n            }\n            // 显示启动 Activity 的 Window\n        \tr.showStartingWindow(prev, newTask, isTaskSwitch(r, focusedTopActivity));\n        } else {\n            // 当前为栈顶 Activity\n            ActivityOptions.abort(options);\n        }\n    \n}\n```\n\n`ActivityStack.startActivityLocked` 主要是创建 WindowContainer，同时显示 Window\n\n### ActivityStackSupervisor\n\n``` java\nboolean resumeFocusedStackTopActivityLocked(){\n    if (targetStack != null && isFocusedStack(targetStack)) {\n        // 存在 targetStack\n    \treturn targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);\n    }\n    final ActivityRecord r = mFocusedStack.topRunningActivityLocked();\n    if (r == null || r.state != RESUMED) {\n        // 恢复聚焦 task\n    \tmFocusedStack.resumeTopActivityUncheckedLocked(null, null);\n    } else if (r.state == RESUMED) {\n        // 执行应用转场动画\n    \tmFocusedStack.executeAppTransition(targetOptions);\n    }\n}\n```\n\n### ActivityStack\n\n``` java\nboolean resumeTopActivityUncheckedLocked() {\n    if (mStackSupervisor.inResumeTopActivity) {\n        // 防止递归\n    \treturn false;\n    }\n    try {\n        // 设置恢复标记\n        mStackSupervisor.inResumeTopActivity = true;\n        result = resumeTopActivityInnerLocked(prev, options);\n    } finally {\n        mStackSupervisor.inResumeTopActivity = false;\n    }\n    // 在恢复过程中，确保必要的暂停逻辑\n    mStackSupervisor.checkReadyForSleepLocked();\n}\n```\n\n``` java\nprivate boolean resumeTopActivityInnerLocked() {\n    \n    // 寻找需要恢复的栈顶 Activity，它必须是未结束并且聚焦\n    final ActivityRecord next = topRunningActivityLocked(true /* focusableOnly */);\n    final boolean hasRunningActivity = next != null;\n    final ActivityRecord parent = mActivityContainer.mParentActivity;\n    final boolean isParentNotResumed = parent != null && parent.state != ActivityState.RESUMED;\n    if (hasRunningActivity\n                && (isParentNotResumed || !mActivityContainer.isAttachedLocked())) {\n           // 如果父 Activity 不是恢复状态，则不恢复当前 Activity\n            return false;\n        }\n    \n    if (!hasRunningActivity) {\n        // 当前 Task 没有需要恢复的 Activity\n    \treturn resumeTopActivityInNextFocusableStack(prev, options, \"noMoreActivities\");\n    }\n    \n    if (mResumedActivity == next && next.state == ActivityState.RESUMED &&\n                    mStackSupervisor.allResumedActivitiesComplete()) {\n        // 如果 Activity 已经是恢复状态\n        // 确保已经执行了所有等待的转场\n        executeAppTransition(options);\n    \treturn false;\n    }\n    \n    if (mService.isSleepingOrShuttingDownLocked()\n                && mLastPausedActivity == next\n                && mStackSupervisor.allPausedActivitiesComplete()) {\n    \t// 如果系统处于休眠状态，当前 Activity 处于暂停状态\n        // 确保转场执行\n        executeAppTransition(options);\n        return false;\n    }\n    \n    if (!mService.mUserController.hasStartedUserState(next.userId)) {\n        // 如果拥有该 Activity 的用户没有启动\n    \treturn false;\n    }\n    \n    if (!mStackSupervisor.allPausedActivitiesComplete()) {\n    \t// 如果存在暂停 Activity 的操作未完成\n        return false;\n    }\n    \n    boolean lastResumedCanPip = false;\n    final ActivityStack lastFocusedStack = mStackSupervisor.getLastStack();\n    if (lastFocusedStack != null && lastFocusedStack != this) {\n    \tfinal ActivityRecord lastResumed = lastFocusedStack.mResumedActivity;\n        // 最后一个恢复的 Activity 是否可以 画中画\n        lastResumedCanPip = lastResumed != null && lastResumed.checkEnterPictureInPictureState(\n                    \"resumeTopActivity\", true /* noThrow */, userLeaving /* beforeStopping */);\n    }\n    \n    // 是否需要可以在上一个 Activity 暂停时进行恢复\n    final boolean resumeWhilePausing = (next.info.flags & FLAG_RESUME_WHILE_PAUSING) != 0\n                && !lastResumedCanPip;\n    // 是否暂停了回退的 task\n    boolean pausing = mStackSupervisor.pauseBackStacks(userLeaving, next, false);\n    \n    if (mResumedActivity != null) {\n        // 暂停上一个恢复状态的 Activity\n    \tpausing |= startPausingLocked(userLeaving, false, next, false);\n    }\n    \n    if (pausing && !resumeWhilePausing) {\n    \t// 之前的 Activity 已经暂停，但不能进行恢复当前 Activity\n        if (next.app != null && next.app.thread != null) {\n            // hosting application，一般不执行\n            // 让当前 Activity 放在 Lru 的顶部，避免早早杀死\n        \tmService.updateLruProcessLocked(next.app, true, null);\n        }\n        return true;\n    } else if (mResumedActivity == next && next.state == ActivityState.RESUMED &&\n                mStackSupervisor.allResumedActivitiesComplete()) {\n    \t// 当前需要恢复的 Activity 已经是恢复状态\n        // 确保执行转场\n        executeAppTransition(options);\n        return true;\n    }\n    \n    if (mService.isSleepingLocked() && mLastNoHistoryActivity != null &&\n                !mLastNoHistoryActivity.finishing) {\n        // 结束因为系统休眠而还没结束的 Activity\n    \trequestFinishActivityLocked(mLastNoHistoryActivity.appToken, Activity.RESULT_CANCELED,\n                    null, \"resume-no-history\", false);\n        mLastNoHistoryActivity = null;\n    }\n    \n    if (prev != null && prev != next) {\n    \tif (!mStackSupervisor.mActivitiesWaitingForVisibleActivity.contains(prev)\n                    && next != null && !next.nowVisible) {\n        \tmStackSupervisor.mActivitiesWaitingForVisibleActivity.add(prev);\n        } else {\n            // 如果当前需要恢复的 Activity 已经可见，所有隐藏上一个 Activity\n            if (prev.finishing) {\n            \tprev.setVisibility(false);\n            } else {\n                \n            }\n        }\n    }\n    \n    // Activity 转场处理\n    \n    ActivityStack lastStack = mStackSupervisor.getLastStack();\n    if (next.app != null && next.app.thread != null) {\n        // 上一个 Activity 是否为透明\n    \tfinal boolean lastActivityTranslucent = lastStack != null\n                    && (!lastStack.mFullscreen\n                    || (lastStack.mLastPausedActivity != null\n                    && !lastStack.mLastPausedActivity.fullscreen));\n        \n        if (!next.visible || next.stopped || lastActivityTranslucent) {\n            // 前一个 Activity 为透明，并且当前 Activity 还没显示\n            // 设置为显示状态\n            next.setVisibility(true);\n        }\n        \n        // 让窗口管理器重新基于新的 Activity 顺序评估屏幕的方向\n    boolean notUpdated = true;\n    if (mStackSupervisor.isFocusedStack(this)) {\n    \tfinal Configuration config = mWindowManager.updateOrientationFromAppTokens(\n                        mStackSupervisor.getDisplayOverrideConfiguration(mDisplayId),\n                        next.mayFreezeScreenLocked(next.app) ? next.appToken : null, mDisplayId);\n        \n        if (config != null) {\n    \tnext.frozenBeforeDestroy = true;\n        }\n        notUpdated = !mService.updateDisplayOverrideConfigurationLocked(config, next,\n                        false /* deferResume */, mDisplayId);\n    }\n    \n     if (notUpdated) {\n         // 配置发生更新无法保持已经存在的 Activity 实例\n         // 重新获取需要恢复的 Activity\n         ActivityRecord nextNext = topRunningActivityLocked();\n         // 确保 Activity 仍然保持在栈顶，同时安排另外一次执行\n         if (nextNext != next) {\n         \tmStackSupervisor.scheduleResumeTopActivities();\n         }\n         if (!next.visible || next.stopped) {\n         \tnext.setVisibility(true);\n         }\n         next.completeResumeLocked();\n         return true;\n     }\n    \n    try {\n        // 传递所有等待的结果\n        \n        if (next.newIntents != null){\n            next.app.thread.scheduleNewIntent(\n                            next.newIntents, next.appToken, false /* andPause */);\n        }\n        \n        next.notifyAppResumed(next.stopped);\n        \n        // 准备恢复 Activity\n        next.app.thread.scheduleResumeActivity(next.appToken, next.app.repProcState,\n                        mService.isNextTransitionForward(), resumeAnimOptions);\n    } catch (Exception e){\n        // 发生异常，重新启动 Activity\n        mStackSupervisor.startSpecificActivityLocked(next, true, false);\n        return true;\n    }\n        \n        try {\n            next.completeResumeLocked();\n        } catch(Exception e){\n            // 发生异常，结束 Activity\n            requestFinishActivityLocked(next.appToken, Activity.RESULT_CANCELED, null,\n                        \"resume-exception\", true);\n            return true;\n        }\n        \n    } else {\n        // 需要启动 Activity\n        mStackSupervisor.startSpecificActivityLocked(next, true, true);\n    }\n    \n    return true;\n\n}\n```\n\n如果可以不需要重新启动 Activity，则直接恢复 Activity 即可，否则进行重新启动流程：\n\n### ActivityStackSupervisor\n\n``` java\nvoid startSpecificActivityLocked() {\n    // 获取应用进程信息\n    ProcessRecord app = mService.getProcessRecordLocked(r.processName,\n                r.info.applicationInfo.uid, true);\n    \n    if (app != null && app.thread != null) {\n    \t// 如果进程已经启动\n        try {\n            realStartActivityLocked(r, app, andResume, checkConfig);\n            return;\n        }catch (RemoteException e){\n            \n        }\n    }\n    \n    // 启动应用进程\n    mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,\n                \"activity\", r.intent.getComponent(), false, false, true);\n}\n```\n\n``` java\nfinal boolean realStartActivityLocked() {\n    // 冻结屏幕\n    r.startFreezingScreenLocked(app, 0);\n    if (checkConfig) {\n    \t// 根据新的 Activity 顺序重新评估屏幕的方向\n    }\n    \n    int idx = app.activities.indexOf(r);\n    if (idx < 0) {\n        // 将 Activity 添加到应用进程中\n        app.activities.add(r);\n    }\n    \n    try {\n        app.thread.scheduleLaunchActivity();\n    }catch(RemoteException e){\n        // 发生异常，结束 Activity\n        stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, null,\n                        \"2nd-crash\", false);\n        return false;\n    }\n    \n    return true;\n}\n```\n\n启动流程最后还是回到了 ApplicationThread\n\n### ApplicationThread\n\n``` java\npublic final void scheduleLaunchActivity() {\n    // 通过 Handler 发送 LAUNCH_ACTIVITY\n    sendMessage(H.LAUNCH_ACTIVITY, r);\n}\n```\n\n我们单独把 LAUNCH_ACTIVITY 的处理拿出来：\n\n``` java\nfinal ActivityClientRecord r = (ActivityClientRecord) msg.obj;\nr.packageInfo = getPackageInfoNoCheck(\n                            r.activityInfo.applicationInfo, r.compatInfo);\nhandleLaunchActivity(r, null, \"LAUNCH_ACTIVITY\");\n```\n\n### ActivityThread\n\n``` java\nprivate void handleLaunchActivity() {\n    // 执行启动 Activity\n    Activity a = performLaunchActivity(r, customIntent);\n    if (a != null) {\n        // resume activity\n        handleResumeActivity(r.token, false, r.isForward,\n                    !r.activity.mFinished && !r.startsNotResumed, r.lastProcessedSeq, reason);\n    } else {\n        \n    }\n}\n```\n\n``` java\nprivate performLaunchActivity() {\n    // Activity 信息初始化\n    \n    // 创建 context\n    ContextImpl appContext = createBaseContextForActivity(r);\n    Activity activity = null;\n    try {\n        java.lang.ClassLoader cl = appContext.getClassLoader();\n        // 构建 Activity\n        activity = mInstrumentation.newActivity(\n                    cl, component.getClassName(), r.intent);\n    }catch(Exception e){\n        \n    }\n    \n    try {\n        Application app = r.packageInfo.makeApplication(false, mInstrumentation);\n        if(activity != null){\n        \tactivity.attach();\n            \n            // 通过 Instrumentation 执行 Activity onCreate\n            if (r.isPersistable()) {\n                 mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);\n            }else {\n                mInstrumentation.callActivityOnCreate(activity, r.state);\n            }\n            \n            if (!r.activity.mFinished) {\n                // Activity onStart\n            \tactivity.performStart();\n            }\n            \n            // 通过 Instrumentation 执行 Activity onRestoreInstanceState\n            if (!r.activity.mFinished) {\n            \tif (r.isPersistable()) {\n                \tif (r.state != null || r.persistentState != null) {\n                    \tmInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,\n                                    r.persistentState);\n                    }\n                } else if (r.state != null) {\n                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);\n                }\n            }\n            \n             // 通过 Instrumentation 执行 Activity onPostCreeate\n            if (!r.activity.mFinished) {\n            \tif (r.isPersistable()) {\n                    mInstrumentation.callActivityOnPostCreate(activity, r.state,\n                                r.persistentState);\n                }else {\n                    mInstrumentation.callActivityOnPostCreate(activity, r.state);\n                }\n            }       \n    }\n        \n    return activity;\n    \n}\n```\n\n``` java\nfinal void handleResumeActivity() {\n    r = performResumeActivity();\n    if(r != null) {\n        final Activity a = r.activity;\n        if (r.window == null && !a.mFinished && willBeVisible) {\n            r.window = r.activity.getWindow();\n            View decor = r.window.getDecorView();\n            decor.setVisibility(View.INVISIBLE);\n            ViewManager wm = a.getWindowManager();\n            if (a.mVisibleFromClient) {\n            \tif (!a.mWindowAdded) {\n                \ta.mWindowAdded = true;\n                    // window\n                    wm.addView(decor, l);\n                }\n            }\n        }\n    }\n}\n```\n\n``` java\npublic final ActivityClientRecord performResumeActivity() {\n \tif (r != null && !r.activity.mFinished) {\n    \ttry {\n            // 处理等待的 Intent\n            if (r.pendingIntents != null) {\n            \tdeliverNewIntents(r, r.pendingIntents);\n                r.pendingIntents = null;\n            }\n            // 处理等待的 result\n            if (r.pendingResults != null) {\n            \tdeliverResults(r, r.pendingResults);\n                r.pendingResults = null;\n            }\n            // 执行 resume\n            r.activity.performResume();\n        }\n    }\n}\n```\n\n### Instrumentation\n\n``` java\npublic Activity newActivity(){\n    return (Activity)cl.loadClass(className).newInstance();\n}\n```\n\n``` java\nprivate void callActivityOnCreate(){\n    prePerformCreate(activity);\n    activity.performCreate(icicle);\n    postPerformCreate(activity);\n}\n```\n\n### Activity\n\n``` java\nfinal void performCreate() {\n    restoreHasCurrentPermissionRequest(icicle);\n    // 调用 onCreate\n    onCreate(icicle);\n    mActivityTransitionState.readState(icicle);\n    performCreateCommon();\n}\n```\n\n``` java\nfinal void performStart() {\n    mActivityTransitionState.setEnterActivityOptions(this, getActivityOptions());\n    mInstrumentation.callActivityOnStart(this);\n    mActivityTransitionState.enterReady(this);\n}\n```\n\n``` java\nfinal void performResume() {\n    // 执行 restart\n    performRestart();\n    mInstrumentation.callActivityOnResume(this);\n}\n```\n\n``` java\nfinal void performRestart() {\n    if (mStopped) {\n        mStopped = false;\n        mInstrumentation.callActivityOnRestart(this);\n        // 执行 start\n        performStart();\n    }\n}\n```\n\n### Instrumentation\n\n``` java\npublic void callActivityOnStart() {\n    activity.onStart();\n}\n```\n\n``` java\npublic void callActivityOnResume() {\n     activity.mResumed = true;\n    activity.onResume();\n}\n```\n\n``` java\npublic void callActivityOnRestart() {\n    activity.onRestart();\n}\n```\n\n## 总结\n\n简单总结下 Activity 的启动流程：\n\n1. 从用户应用进程开始启动，如果从桌面启动，则为 launcher 进程，用户进程通过 Binder 机制与 system_server 进程进行通信\n2. ActivityManagerService 用于管理所有的 Activity 活动\n   * 当接受到启动 Activity 的调用时，使用 `resolveActivity` ，查询系统中符合要求的 Activity\n   * 创建使用合适的  ActivityStack 和 launch flags 来启动 Activity\n   * 如果存在可以直接恢复 Activity，则恢复，否则重新启动 Activity\n   * 如果不存在应用进程，先创建应用进程\n3. 最终启动流程又会通过 Binder 调用回应用进程，使用 ActivityThread 去执行\n   * 使用 Instrumentation 去通过反射构建 Activity 实例\n   * 使用 Handler 机制调用 Activity 的生命周期\n\n下面的图例来自[博客](http://gityuan.com/2016/03/12/start-activity/)：\n\n![启动流程](http://gityuan.com/images/activity/start_activity_process.jpg)\n\n### 时序图\n\n![Android启动流程](https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png?x-oss-process=style/doc-img)\n\n","slug":"Activity启动流程-基于Android26","published":1,"updated":"2022-06-15T11:19:32.304Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrm5001bfho6bczzgrn8","content":"<blockquote>\n<p>基于 Android 26，分析 Android Activity 启动流程</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://gityuan.com/2016/03/12/start-activity/\">startActivity启动过程分析</a></p>\n<h2 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h2><p><strong>源码篇幅可能过长，所以会省略一下不必要的代码和注释</strong></p>\n<h3 id=\"Activity\"><a href=\"#Activity\" class=\"headerlink\" title=\"Activity\"></a>Activity</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                    </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivity</span><span class=\"params\">()</span> &#123;   </span><br><span class=\"line\">    <span class=\"built_in\">this</span>.startActivity(intent, <span class=\"literal\">null</span>);        </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                           </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (options != <span class=\"literal\">null</span>) &#123;                                          </span><br><span class=\"line\">        startActivityForResult(intent, -<span class=\"number\">1</span>, options);                </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                        </span><br><span class=\"line\">        startActivityForResult(intent, -<span class=\"number\">1</span>);                         </span><br><span class=\"line\">    &#125;                                                               </span><br><span class=\"line\">&#125;                                                                   </span><br></pre></td></tr></table></figure>\n\n<p>最终都会调用到 <code>startActivityForResult</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivityForResult</span><span class=\"params\">()</span> &#123;                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mParent == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 转场动画的处理</span></span><br><span class=\"line\">        Instrumentation.<span class=\"type\">ActivityResult</span> <span class=\"variable\">ar</span> <span class=\"operator\">=</span> mInstrumentation.execStartActivity();                                                                                                                                                      </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ar != <span class=\"literal\">null</span>) &#123;                                                                       </span><br><span class=\"line\">            mMainThread.sendActivityResult();                                                                                                             </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (requestCode &gt;= <span class=\"number\">0</span>) &#123;                                                                                        </span><br><span class=\"line\">            mStartedActivity = <span class=\"literal\">true</span>;                                                            </span><br><span class=\"line\">        &#125;                                                                                                                                                                             </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                                    </span><br><span class=\"line\">        <span class=\"comment\">// 如果存在 Parent Activity 则交由它处理                                                                                    </span></span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">&#125;                                                                                               </span><br></pre></td></tr></table></figure>\n\n<p>可以知道 Activity 启动委托给了 Instrumentation 进行实现</p>\n<h3 id=\"Instrumentation\"><a href=\"#Instrumentation\" class=\"headerlink\" title=\"Instrumentation\"></a>Instrumentation</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> ActivityResult <span class=\"title function_\">execStartActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 由 ActivityThread.getApplicationThread 提供的 ApplicationThread</span></span><br><span class=\"line\">    <span class=\"type\">IApplicationThread</span> <span class=\"variable\">whoThread</span> <span class=\"operator\">=</span> (IApplicationThread) contextThread;                                                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mActivityMonitors != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (mSync) &#123;                                             </span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">N</span> <span class=\"operator\">=</span> mActivityMonitors.size();                        </span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>; i&lt;N; i++) &#123;                                      </span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">ActivityMonitor</span> <span class=\"variable\">am</span> <span class=\"operator\">=</span> mActivityMonitors.get(i);       </span><br><span class=\"line\">                <span class=\"type\">ActivityResult</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;                              </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (am.ignoreMatchingSpecificIntents()) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// true 表示这个监视器被用于使用 onStartActivity 拦截所有 Activity 启动 </span></span><br><span class=\"line\">                    result = am.onStartActivity(intent);                   </span><br><span class=\"line\">                &#125;                                                          </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (result != <span class=\"literal\">null</span>) &#123;                                      </span><br><span class=\"line\">                    am.mHits++;                                            </span><br><span class=\"line\">                    <span class=\"keyword\">return</span> result;                                         </span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (am.match(who, <span class=\"literal\">null</span>, intent)) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// match 使用 IntentFilter 和 类名 进行匹配</span></span><br><span class=\"line\">                    am.mHits++;                                            </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (am.isBlocking()) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// 当前监视器阻止 Activity 启动</span></span><br><span class=\"line\">                        <span class=\"keyword\">return</span> requestCode &gt;= <span class=\"number\">0</span> ? am.getResult() : <span class=\"literal\">null</span>;   </span><br><span class=\"line\">                    &#125;                                                      </span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                                                 </span><br><span class=\"line\">                &#125;                                                          </span><br><span class=\"line\">            &#125;                                                              </span><br><span class=\"line\">        &#125;                                                                  </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 委托为 ActivityManagerService(AMS) 去处理</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> ActivityManager.getService().startActivity();                          </span><br><span class=\"line\">        <span class=\"comment\">// 检查 AMS 的处理结果</span></span><br><span class=\"line\">        checkStartActivityResult(result, intent);                          </span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (RemoteException e) &#123;                                          </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Failure from system&quot;</span>, e);              </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;                                                           </span><br><span class=\"line\">&#125;                                                                          </span><br></pre></td></tr></table></figure>\n\n<p>可以通过最后的调用委托给了<code>ActivityManager.getService</code>，实际上就是 ActivityManagerService(AMS) 的 Binder 代理类实现</p>\n<blockquote>\n<p>相对于之前的版本，比如 Android 23，现在已经没有了 ActivityManagerProxy 和 ActivityManagerNative，将直接与 system_server 进程上的 AMS 进行 IPC</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IActivityManager <span class=\"title function_\">getService</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> IActivityManagerSingleton.get();  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =          </span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">Singleton</span>&lt;IActivityManager&gt;() &#123;                                           </span><br><span class=\"line\">            <span class=\"meta\">@Override</span>                                                                 </span><br><span class=\"line\">            <span class=\"keyword\">protected</span> IActivityManager <span class=\"title function_\">create</span><span class=\"params\">()</span> &#123;                                     </span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">IBinder</span> <span class=\"variable\">b</span> <span class=\"operator\">=</span> ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">IActivityManager</span> <span class=\"variable\">am</span> <span class=\"operator\">=</span> IActivityManager.Stub.asInterface(b);     </span><br><span class=\"line\">                <span class=\"keyword\">return</span> am;                                                            </span><br><span class=\"line\">            &#125;                                                                         </span><br><span class=\"line\">        &#125;;                                                                            </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ActivityManagerService\"><a href=\"#ActivityManagerService\" class=\"headerlink\" title=\"ActivityManagerService\"></a>ActivityManagerService</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivity</span><span class=\"params\">()</span> &#123;                           </span><br><span class=\"line\">    <span class=\"keyword\">return</span> startActivityAsUser();                                                     </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                                                          </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivityAsUser</span><span class=\"params\">()</span> &#123;                                                                                                                                   </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mActivityStarter.startActivityMayWait();                                                                                                </span><br><span class=\"line\">&#125;                                                                                                                                  </span><br></pre></td></tr></table></figure>\n\n<p>这里将启动请求又委托给了 ActivityStarter</p>\n<h3 id=\"ActivityStarter\"><a href=\"#ActivityStarter\" class=\"headerlink\" title=\"ActivityStarter\"></a>ActivityStarter</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivityMayWait</span><span class=\"params\">()</span> &#123;                                                </span><br><span class=\"line\">    <span class=\"comment\">// Intent 的响应</span></span><br><span class=\"line\">    <span class=\"type\">ResolveInfo</span> <span class=\"variable\">rInfo</span> <span class=\"operator\">=</span> mSupervisor.resolveIntent(intent, resolvedType, userId);                                                                                                                                           </span><br><span class=\"line\">    <span class=\"comment\">// Intent 的 Activity 信息                                                               </span></span><br><span class=\"line\">    <span class=\"type\">ActivityInfo</span> <span class=\"variable\">aInfo</span> <span class=\"operator\">=</span> mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);                                                                                                                                                                                                                                                                                                                                        </span><br><span class=\"line\">        <span class=\"keyword\">final</span> ActivityRecord[] outRecord = <span class=\"keyword\">new</span> <span class=\"title class_\">ActivityRecord</span>[<span class=\"number\">1</span>];</span><br><span class=\"line\">    \t<span class=\"comment\">// 调用 startActivityLocked</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> startActivityLocked(outRecord);                                                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">return</span> res;                                                                                                       </span><br><span class=\"line\">    &#125;                                                                                                                     </span><br><span class=\"line\">&#125;                                                                                                                         </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 源 Activity 记录，即在哪个 Activity 进行 startActivity</span></span><br><span class=\"line\">    <span class=\"type\">ActivityRecord</span> <span class=\"variable\">sourceRecord</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 如果使用 startActivityForResult，result 返回的 Activity 称为结果 Activity</span></span><br><span class=\"line\">    <span class=\"type\">ActivityRecord</span> <span class=\"variable\">resultRecord</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (resultTo != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 获取 Activity Stack 中已经存在的源 Activity 记录</span></span><br><span class=\"line\">        sourceRecord = mSupervisor.isInAnyStackLocked(resultTo);                                                                                 </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sourceRecord != <span class=\"literal\">null</span>) &#123;                                                                           </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (requestCode &gt;= <span class=\"number\">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// requestCode &gt;= 0，源 Activity 同时为 结果 Activity</span></span><br><span class=\"line\">                resultRecord = sourceRecord;                                                                  </span><br><span class=\"line\">            &#125;                                                                                                 </span><br><span class=\"line\">        &#125;                                                                                                     </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">launchFlags</span> <span class=\"operator\">=</span> intent.getFlags();                                                                </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class=\"number\">0</span> &amp;&amp; sourceRecord != <span class=\"literal\">null</span>) &#123;                   </span><br><span class=\"line\">        <span class=\"comment\">// 使用 FLAG_ACTIVITY_FORWARD_RESULT，可以将返回结果的源 Activity 转移为当前正在新启动的 Activity</span></span><br><span class=\"line\">        <span class=\"comment\">// 比如：A -&gt; B,B - C 使用了 FLAG_ACTIVITY_FORWARD_RESULT,那么 C 的 setResult 会返回给 A</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (requestCode &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 不允许有 requestCode</span></span><br><span class=\"line\">            ActivityOptions.abort(options);                                                                   </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;                                        </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 将源 Activity 的结果 Activity 设置为新 Activity 的结果 Activity</span></span><br><span class=\"line\">        resultRecord = sourceRecord.resultTo;                                                                 </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultRecord != <span class=\"literal\">null</span> &amp;&amp; !resultRecord.isInStackLocked()) &#123;                                        </span><br><span class=\"line\">            resultRecord = <span class=\"literal\">null</span>;                                                                              </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// requestCode 处理</span></span><br><span class=\"line\">        resultWho = sourceRecord.resultWho;                                                                   </span><br><span class=\"line\">        requestCode = sourceRecord.requestCode;                                                               </span><br><span class=\"line\">        sourceRecord.resultTo = <span class=\"literal\">null</span>;                                                                         </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultRecord != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 删除源 Activity 记录</span></span><br><span class=\"line\">            resultRecord.removeResultsLocked(sourceRecord, resultWho, requestCode);                           </span><br><span class=\"line\">        &#125;                                                                                                                                                                                         </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class=\"literal\">null</span>) &#123;                              </span><br><span class=\"line\">        <span class=\"comment\">// component 找不到                                                                         </span></span><br><span class=\"line\">        err = ActivityManager.START_INTENT_NOT_RESOLVED;                                                      </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class=\"literal\">null</span>) &#123;                                              </span><br><span class=\"line\">        <span class=\"comment\">// ActivityInfo 找不到                                                                         </span></span><br><span class=\"line\">        err = ActivityManager.START_CLASS_NOT_FOUND;                                                          </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; sourceRecord != <span class=\"literal\">null</span>                                          </span><br><span class=\"line\">            &amp;&amp; sourceRecord.getTask().voiceSession != <span class=\"literal\">null</span>) &#123;                                                 </span><br><span class=\"line\">        <span class=\"comment\">// 语音启动 Activity，检查是否符合                                                                      </span></span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; voiceSession != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">        <span class=\"comment\">// 启动语音会话                                                       </span></span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityStack</span> <span class=\"variable\">resultStack</span> <span class=\"operator\">=</span> resultRecord == <span class=\"literal\">null</span> ? <span class=\"literal\">null</span> : resultRecord.getStack();                  </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err != START_SUCCESS) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 启动 Activity 失败</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultRecord != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 发送取消通知</span></span><br><span class=\"line\">            resultStack.sendActivityResultLocked(                                                             </span><br><span class=\"line\">                    -<span class=\"number\">1</span>, resultRecord, resultWho, requestCode, RESULT_CANCELED, <span class=\"literal\">null</span>);                         </span><br><span class=\"line\">        &#125;                                                                                                     </span><br><span class=\"line\">        ActivityOptions.abort(options);                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">return</span> err;                                                                                           </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"comment\">// 进行一些权限检查，判断是否终止                                                              </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (abort) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果需要终止 Activity</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultRecord != <span class=\"literal\">null</span>) &#123;                                                                           </span><br><span class=\"line\">            resultStack.sendActivityResultLocked();                                                                   </span><br><span class=\"line\">        &#125;                                                                                                     </span><br><span class=\"line\">        <span class=\"comment\">// 返回启动成功，实际终止                                                                </span></span><br><span class=\"line\">        ActivityOptions.abort(options);                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_SUCCESS;                                                                                 </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"comment\">// 如果权限检查是否在启动 Activity 之前，那么先启动权限检查的 Intent                                                             </span></span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"comment\">// 处理 ephemeral app                                                                    </span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 构造一个 ActivityRecord</span></span><br><span class=\"line\">    <span class=\"type\">ActivityRecord</span> <span class=\"variable\">r</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ActivityRecord</span>();                                                   </span><br><span class=\"line\">                                                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityStack</span> <span class=\"variable\">stack</span> <span class=\"operator\">=</span> mSupervisor.mFocusedStack;                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (voiceSession == <span class=\"literal\">null</span> &amp;&amp; (stack.mResumedActivity == <span class=\"literal\">null</span>                                               </span><br><span class=\"line\">            || stack.mResumedActivity.info.applicationInfo.uid != callingUid)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 前台 stack 还没 resume 状态的 Activity，检查是否允许 app 切换</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mService.checkAppSwitchAllowedLocked() &#123;                                          </span><br><span class=\"line\">            <span class=\"type\">PendingActivityLaunch</span> <span class=\"variable\">pal</span> <span class=\"operator\">=</span>  <span class=\"keyword\">new</span> <span class=\"title class_\">PendingActivityLaunch</span>();                                              </span><br><span class=\"line\">            mPendingActivityLaunches.add(pal);                                                                </span><br><span class=\"line\">            ActivityOptions.abort(options);</span><br><span class=\"line\">            <span class=\"comment\">// 切换 app 失败</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> ActivityManager.START_SWITCHES_CANCELED;                                                   </span><br><span class=\"line\">        &#125;                                                                                                     </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.mDidAppSwitch) &#123;                                                                             </span><br><span class=\"line\">        <span class=\"comment\">// 从上次禁止 app 切换以来，这是第二次，允许 app 切换，并将切换时间设置为 0                                                            </span></span><br><span class=\"line\">        mService.mAppSwitchesAllowedTime = <span class=\"number\">0</span>;                                                                 </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                                                  </span><br><span class=\"line\">        mService.mDidAppSwitch = <span class=\"literal\">true</span>;                                                                        </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 执行因为不允许 app 切换，而加到等待启动的 Activity</span></span><br><span class=\"line\">    doPendingActivityLaunchesLocked(<span class=\"literal\">false</span>);                                                                   </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">return</span> startActivity();                                                                    </span><br><span class=\"line\">&#125;                                                                                                             </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivity</span><span class=\"params\">()</span> &#123;                                                        </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> START_CANCELED;                                                               </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;                                                                                      </span><br><span class=\"line\">        mService.mWindowManager.deferSurfaceLayout();</span><br><span class=\"line\">        <span class=\"comment\">// 下一步流程</span></span><br><span class=\"line\">        result = startActivityUnchecked();                           </span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;                                                                                </span><br><span class=\"line\">        <span class=\"comment\">// 如果启动 Activity 没有成功， 从 task 中移除 Activity                                                      </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!ActivityManager.isStartResultSuccessful(result)                                   </span><br><span class=\"line\">                &amp;&amp; mStartActivity.getTask() != <span class=\"literal\">null</span>) &#123;                                         </span><br><span class=\"line\">            mStartActivity.getTask().removeActivity(mStartActivity);                           </span><br><span class=\"line\">        &#125;                                                                                      </span><br><span class=\"line\">        mService.mWindowManager.continueSurfaceLayout();                                       </span><br><span class=\"line\">    &#125;                                                                                          </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    postStartActivityProcessing();                                                                     </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;                                                                             </span><br><span class=\"line\">&#125;                                                                                              </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivityUnchecked</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"comment\">// 设置一些初始化状态</span></span><br><span class=\"line\">    setInitialState();</span><br><span class=\"line\">    <span class=\"comment\">// 计算 launch flags</span></span><br><span class=\"line\">    computeLaunchingTaskFlags();</span><br><span class=\"line\">    <span class=\"comment\">// 计算源 Task，源 Task 是否存在等</span></span><br><span class=\"line\">    computeSourceStack();</span><br><span class=\"line\">    <span class=\"comment\">// 获取是否存在可以复用的 Activity，根据 flags 和 launchMode</span></span><br><span class=\"line\">    <span class=\"type\">ActivityRecord</span> <span class=\"variable\">reusedActivity</span> <span class=\"operator\">=</span> getReusableIntentActivity();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (reusedActivity != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 存在可复用的 Activity，复用它</span></span><br><span class=\"line\">        <span class=\"comment\">// 可能需要清除 Task 中其他 Activity，并将启动的 Activity 前置</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartActivity.packageName == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> START_CLASS_NOT_FOUND;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 如果启动的 Activity 与当前 Task 顶部的 Activity 相同，判断是否需要继续启动新的 Activity</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">dontStart</span> <span class=\"operator\">=</span> top != <span class=\"literal\">null</span> &amp;&amp; mStartActivity.resultTo == <span class=\"literal\">null</span></span><br><span class=\"line\">                &amp;&amp; top.realActivity.equals(mStartActivity.realActivity)</span><br><span class=\"line\">                &amp;&amp; top.userId == mStartActivity.userId</span><br><span class=\"line\">                &amp;&amp; top.app != <span class=\"literal\">null</span> &amp;&amp; top.app.thread != <span class=\"literal\">null</span></span><br><span class=\"line\">                &amp;&amp; ((mLaunchFlags &amp; FLAG_ACTIVITY_SINGLE_TOP) != <span class=\"number\">0</span></span><br><span class=\"line\">                || mLaunchSingleTop || mLaunchSingleTask);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(dontStart)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 传递一个新的 Intent 到 onNewIntent </span></span><br><span class=\"line\">        top.deliverNewIntentLocked();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_DELIVERED_TO_TOP;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 获取 mTargetStack</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartActivity.resultTo == <span class=\"literal\">null</span> &amp;&amp; mInTask == <span class=\"literal\">null</span> &amp;&amp; !mAddingToTask</span><br><span class=\"line\">                &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    \tnewTask = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 需要创建新的 Task</span></span><br><span class=\"line\">        result = setTaskFromReuseOrCreateNewTask();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mSourceRecord != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 从源 Activity 中获取 Task</span></span><br><span class=\"line\">    \tresult = setTaskFromSourceRecord();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mInTask != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 从 InTask 中获取 Task</span></span><br><span class=\"line\">    \tresult = setTaskFromInTask();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 可能创建新的 Task 或使用当前 Task，一般不会发生</span></span><br><span class=\"line\">    \tsetTaskToCurrentTopOrCreateNewTask();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 使用 mTargetStack 启动 Activity </span></span><br><span class=\"line\">    mTargetStack.startActivityLocked();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDoResume) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mTargetStack.isFocusable()</span><br><span class=\"line\">                    || (topTaskActivity != <span class=\"literal\">null</span> &amp;&amp; topTaskActivity.mTaskOverlay</span><br><span class=\"line\">                    &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 目标 Task 不可聚焦 ，或者源 Task 栈顶 Activity 总是在其他 Activity 之上，并且不为源 Activity</span></span><br><span class=\"line\">            <span class=\"comment\">// 那么我们不恢复目标 Task，只需要确保它可见即可</span></span><br><span class=\"line\">            mTargetStack.ensureActivitiesVisibleLocked(<span class=\"literal\">null</span>, <span class=\"number\">0</span>, !PRESERVE_WINDOWS);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mTargetStack.isFocusable() &amp;&amp; !mSupervisor.isFocusedStack(mTargetStack)) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 如果目标 Task 之前不是可聚焦，但是现在为可聚焦，那么移动到前台</span></span><br><span class=\"line\">            mTargetStack.moveToFront(<span class=\"string\">&quot;startActivityUnchecked&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 恢复目标 Task</span></span><br><span class=\"line\">        mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,</span><br><span class=\"line\">                        mOptions);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果不需要恢复，那么加到&quot;最近活动&quot;中</span></span><br><span class=\"line\">        mTargetStack.addRecentActivityLocked(mStartActivity);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> START_SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setInitialState</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获取 DisplayId</span></span><br><span class=\"line\">    mSourceDisplayId = getSourceDisplayId();</span><br><span class=\"line\">    <span class=\"comment\">// 获取用于启动 Activity 的范围，Rect</span></span><br><span class=\"line\">    mLaunchBounds = getOerrideBounds();</span><br><span class=\"line\">    <span class=\"comment\">// launchMode</span></span><br><span class=\"line\">    mLaunchSingleTop = r.launchmode == LAUNCH_SINGLE_TOP;</span><br><span class=\"line\">    mLaunchSingleInstance = r.launchMode == LAUNCH_SINGLE_INSTANCE;</span><br><span class=\"line\">    mLaunchSingleTask = r.launchMode == LAUNCH_SINGLE_TASK;</span><br><span class=\"line\">    <span class=\"comment\">// Intent flags 的处理，如果和 Manifest 存在冲突，以 Manifest 为主</span></span><br><span class=\"line\">    <span class=\"comment\">// 如果 requestCode &gt;= 0，同时启动的 Activity 位于新的 Task，发送取消的结果给源 Activity</span></span><br><span class=\"line\">    sendNewTaskResultRequestIfNeeded();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">computeLaunchingTaskFlags</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mSourceRecord == <span class=\"literal\">null</span> &amp;&amp; mInTask != <span class=\"literal\">null</span> &amp;&amp; mInTask.getStack() != <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果不存在源 Activity</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">Intent</span> <span class=\"variable\">baseIntent</span> <span class=\"operator\">=</span> mInTask.getBaseIntent();</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">ActivityRecord</span> <span class=\"variable\">root</span> <span class=\"operator\">=</span> mInTask.getRootActivity();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (baseIntent == <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mLaunchSingleInstance || mLaunchSingleTask) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果设置了 SingleInstacne 或 SingleTask</span></span><br><span class=\"line\">        \t<span class=\"keyword\">if</span> (!baseIntent.getComponent().equals(mStartActivity.intent.getComponent()))&#123;</span><br><span class=\"line\">                <span class=\"comment\">// Task 不符合</span></span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">if</span>(root != <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">                <span class=\"comment\">// 已经存在 Task 根 Activity</span></span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (root == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 如果不存在根 Activity，重新设置 launch flags</span></span><br><span class=\"line\">            mAddingToTask = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">             mAddingToTask = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            mAddingToTask = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                     <span class=\"keyword\">if</span> ((mStartActivity.isResolverActivity() || mStartActivity.noDisplay) &amp;&amp; mSourceRecord != <span class=\"literal\">null</span></span><br><span class=\"line\">                    &amp;&amp; mSourceRecord.isFreeform())  &#123;</span><br><span class=\"line\">                         <span class=\"comment\">// 如果使用 ResolverActivity 启动或者 noDisplay</span></span><br><span class=\"line\">                mAddingToTask = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(mInTask == <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mSourceRecord == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        \t<span class=\"keyword\">if</span> ((mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) == <span class=\"number\">0</span> &amp;&amp; mInTask == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 不存在 Task，并且不存在源 Activity</span></span><br><span class=\"line\">            \tmLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mSourceRecord.launchMode == LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 如果源 Activity 的 launchMode 是 SingleInstance，要设置 NEW_TASK flag</span></span><br><span class=\"line\">            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mLaunchSingleInstance || mLaunchSingleTask) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 如果启动 Activity 的 launchMode 是 SingleInstance 或 SingleTask，需要设置 NEW_TASK flag</span></span><br><span class=\"line\">            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ActivityStarter 主要的作用是，计算 launch flags，创建或者复用合适的 Task，即 ActivityStack，从而启动 Activity</p>\n<h3 id=\"ActivityStack\"><a href=\"#ActivityStack\" class=\"headerlink\" title=\"ActivityStack\"></a>ActivityStack</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivityLocked</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!newTask) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果从已存在的 Task 中启动 Activity</span></span><br><span class=\"line\">      <span class=\"type\">boolean</span> <span class=\"variable\">startIt</span> <span class=\"operator\">=</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">taskNdx</span> <span class=\"operator\">=</span> mTaskHistory.size() - <span class=\"number\">1</span>; taskNdx &gt;= <span class=\"number\">0</span>; --taskNdx) &#123;</span><br><span class=\"line\">      \ttask = mTaskHistory.get(taskNdx);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (task.getTopActivity() == <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">              <span class=\"comment\">// 如果 task 不存在 Activity</span></span><br><span class=\"line\">              <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (task == rTask) &#123;</span><br><span class=\"line\">          \t<span class=\"comment\">// 找到对应的 task</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!startIt) &#123;</span><br><span class=\"line\">            \t<span class=\"comment\">// 如果当前对于用户还不可见，那么只是添加它，而不启动它，它将在用户导航回来时启动</span></span><br><span class=\"line\">                r.createWindowContainer();</span><br><span class=\"line\">                ActivityOptions.abort(options);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (task.numFullscreen &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">              startIt = <span class=\"literal\">false</span>;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 如果当前 task 为活动 task，那么不需要传递 onuserLeaving 回调</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (task == activityTask &amp;&amp; mTaskHistory.indexOf(task) != (mTaskHistory.size() - <span class=\"number\">1</span>)) &#123;</span><br><span class=\"line\">        mStackSupervisor.mUserLeaving = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!isHomeOrRecentsStack() || numActivities() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 如果当前不是 Home 或 Recent Task,或者活动 Activity 数量大于 0</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 处理 动画</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newTask) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果设置了重置的标记</span></span><br><span class=\"line\">            resetTaskIfNeededLocked(r, r);</span><br><span class=\"line\">            doShow = topRunningNonDelayedActivityLocked(<span class=\"literal\">null</span>) == r;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (options != <span class=\"literal\">null</span> &amp;&amp; options.getAnimationType()</span><br><span class=\"line\">                    == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 需要进行转场动画</span></span><br><span class=\"line\">                doShow = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 如果为 true，那么不开启 window，但要确保 Activity 是可见的</span></span><br><span class=\"line\">            r.setVisibility(<span class=\"literal\">true</span>);</span><br><span class=\"line\">            ensureActivitiesVisibleLocked(<span class=\"literal\">null</span>, <span class=\"number\">0</span>, !PRESERVE_WINDOWS);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</span><br><span class=\"line\">            <span class=\"type\">TaskRecord</span> <span class=\"variable\">prevTask</span> <span class=\"operator\">=</span> r.getTask();</span><br><span class=\"line\">            <span class=\"type\">ActivityRecord</span> <span class=\"variable\">prev</span> <span class=\"operator\">=</span> prevTask.topRunningActivityWithStartingWindowLocked();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (prev != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 以下两种情况不展示之前的 Activity 预览</span></span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (prev.getTask() != prevTask) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 之前的 Activity 在不同的 Task</span></span><br><span class=\"line\">                \tprev = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (prev.nowVisible) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 现在可见</span></span><br><span class=\"line\">                \t prev = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 显示启动 Activity 的 Window</span></span><br><span class=\"line\">        \tr.showStartingWindow(prev, newTask, isTaskSwitch(r, focusedTopActivity));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 当前为栈顶 Activity</span></span><br><span class=\"line\">            ActivityOptions.abort(options);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>ActivityStack.startActivityLocked</code> 主要是创建 WindowContainer，同时显示 Window</p>\n<h3 id=\"ActivityStackSupervisor\"><a href=\"#ActivityStackSupervisor\" class=\"headerlink\" title=\"ActivityStackSupervisor\"></a>ActivityStackSupervisor</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"title function_\">resumeFocusedStackTopActivityLocked</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetStack != <span class=\"literal\">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 存在 targetStack</span></span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityRecord</span> <span class=\"variable\">r</span> <span class=\"operator\">=</span> mFocusedStack.topRunningActivityLocked();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (r == <span class=\"literal\">null</span> || r.state != RESUMED) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 恢复聚焦 task</span></span><br><span class=\"line\">    \tmFocusedStack.resumeTopActivityUncheckedLocked(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (r.state == RESUMED) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 执行应用转场动画</span></span><br><span class=\"line\">    \tmFocusedStack.executeAppTransition(targetOptions);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ActivityStack-1\"><a href=\"#ActivityStack-1\" class=\"headerlink\" title=\"ActivityStack\"></a>ActivityStack</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"title function_\">resumeTopActivityUncheckedLocked</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 防止递归</span></span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 设置恢复标记</span></span><br><span class=\"line\">        mStackSupervisor.inResumeTopActivity = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        result = resumeTopActivityInnerLocked(prev, options);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        mStackSupervisor.inResumeTopActivity = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 在恢复过程中，确保必要的暂停逻辑</span></span><br><span class=\"line\">    mStackSupervisor.checkReadyForSleepLocked();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">boolean</span> <span class=\"title function_\">resumeTopActivityInnerLocked</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 寻找需要恢复的栈顶 Activity，它必须是未结束并且聚焦</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityRecord</span> <span class=\"variable\">next</span> <span class=\"operator\">=</span> topRunningActivityLocked(<span class=\"literal\">true</span> <span class=\"comment\">/* focusableOnly */</span>);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">hasRunningActivity</span> <span class=\"operator\">=</span> next != <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityRecord</span> <span class=\"variable\">parent</span> <span class=\"operator\">=</span> mActivityContainer.mParentActivity;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">isParentNotResumed</span> <span class=\"operator\">=</span> parent != <span class=\"literal\">null</span> &amp;&amp; parent.state != ActivityState.RESUMED;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasRunningActivity</span><br><span class=\"line\">                &amp;&amp; (isParentNotResumed || !mActivityContainer.isAttachedLocked())) &#123;</span><br><span class=\"line\">           <span class=\"comment\">// 如果父 Activity 不是恢复状态，则不恢复当前 Activity</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!hasRunningActivity) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前 Task 没有需要恢复的 Activity</span></span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> resumeTopActivityInNextFocusableStack(prev, options, <span class=\"string\">&quot;noMoreActivities&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</span><br><span class=\"line\">                    mStackSupervisor.allResumedActivitiesComplete()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果 Activity 已经是恢复状态</span></span><br><span class=\"line\">        <span class=\"comment\">// 确保已经执行了所有等待的转场</span></span><br><span class=\"line\">        executeAppTransition(options);</span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.isSleepingOrShuttingDownLocked()</span><br><span class=\"line\">                &amp;&amp; mLastPausedActivity == next</span><br><span class=\"line\">                &amp;&amp; mStackSupervisor.allPausedActivitiesComplete()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 如果系统处于休眠状态，当前 Activity 处于暂停状态</span></span><br><span class=\"line\">        <span class=\"comment\">// 确保转场执行</span></span><br><span class=\"line\">        executeAppTransition(options);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!mService.mUserController.hasStartedUserState(next.userId)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果拥有该 Activity 的用户没有启动</span></span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!mStackSupervisor.allPausedActivitiesComplete()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 如果存在暂停 Activity 的操作未完成</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">lastResumedCanPip</span> <span class=\"operator\">=</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityStack</span> <span class=\"variable\">lastFocusedStack</span> <span class=\"operator\">=</span> mStackSupervisor.getLastStack();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (lastFocusedStack != <span class=\"literal\">null</span> &amp;&amp; lastFocusedStack != <span class=\"built_in\">this</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">final</span> <span class=\"type\">ActivityRecord</span> <span class=\"variable\">lastResumed</span> <span class=\"operator\">=</span> lastFocusedStack.mResumedActivity;</span><br><span class=\"line\">        <span class=\"comment\">// 最后一个恢复的 Activity 是否可以 画中画</span></span><br><span class=\"line\">        lastResumedCanPip = lastResumed != <span class=\"literal\">null</span> &amp;&amp; lastResumed.checkEnterPictureInPictureState(</span><br><span class=\"line\">                    <span class=\"string\">&quot;resumeTopActivity&quot;</span>, <span class=\"literal\">true</span> <span class=\"comment\">/* noThrow */</span>, userLeaving <span class=\"comment\">/* beforeStopping */</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 是否需要可以在上一个 Activity 暂停时进行恢复</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">resumeWhilePausing</span> <span class=\"operator\">=</span> (next.info.flags &amp; FLAG_RESUME_WHILE_PAUSING) != <span class=\"number\">0</span></span><br><span class=\"line\">                &amp;&amp; !lastResumedCanPip;</span><br><span class=\"line\">    <span class=\"comment\">// 是否暂停了回退的 task</span></span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">pausing</span> <span class=\"operator\">=</span> mStackSupervisor.pauseBackStacks(userLeaving, next, <span class=\"literal\">false</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mResumedActivity != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 暂停上一个恢复状态的 Activity</span></span><br><span class=\"line\">    \tpausing |= startPausingLocked(userLeaving, <span class=\"literal\">false</span>, next, <span class=\"literal\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pausing &amp;&amp; !resumeWhilePausing) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 之前的 Activity 已经暂停，但不能进行恢复当前 Activity</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (next.app != <span class=\"literal\">null</span> &amp;&amp; next.app.thread != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// hosting application，一般不执行</span></span><br><span class=\"line\">            <span class=\"comment\">// 让当前 Activity 放在 Lru 的顶部，避免早早杀死</span></span><br><span class=\"line\">        \tmService.updateLruProcessLocked(next.app, <span class=\"literal\">true</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</span><br><span class=\"line\">                mStackSupervisor.allResumedActivitiesComplete()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 当前需要恢复的 Activity 已经是恢复状态</span></span><br><span class=\"line\">        <span class=\"comment\">// 确保执行转场</span></span><br><span class=\"line\">        executeAppTransition(options);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.isSleepingLocked() &amp;&amp; mLastNoHistoryActivity != <span class=\"literal\">null</span> &amp;&amp;</span><br><span class=\"line\">                !mLastNoHistoryActivity.finishing) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 结束因为系统休眠而还没结束的 Activity</span></span><br><span class=\"line\">    \trequestFinishActivityLocked(mLastNoHistoryActivity.appToken, Activity.RESULT_CANCELED,</span><br><span class=\"line\">                    <span class=\"literal\">null</span>, <span class=\"string\">&quot;resume-no-history&quot;</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        mLastNoHistoryActivity = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (prev != <span class=\"literal\">null</span> &amp;&amp; prev != next) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">if</span> (!mStackSupervisor.mActivitiesWaitingForVisibleActivity.contains(prev)</span><br><span class=\"line\">                    &amp;&amp; next != <span class=\"literal\">null</span> &amp;&amp; !next.nowVisible) &#123;</span><br><span class=\"line\">        \tmStackSupervisor.mActivitiesWaitingForVisibleActivity.add(prev);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果当前需要恢复的 Activity 已经可见，所有隐藏上一个 Activity</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (prev.finishing) &#123;</span><br><span class=\"line\">            \tprev.setVisibility(<span class=\"literal\">false</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// Activity 转场处理</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">ActivityStack</span> <span class=\"variable\">lastStack</span> <span class=\"operator\">=</span> mStackSupervisor.getLastStack();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (next.app != <span class=\"literal\">null</span> &amp;&amp; next.app.thread != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 上一个 Activity 是否为透明</span></span><br><span class=\"line\">    \t<span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">lastActivityTranslucent</span> <span class=\"operator\">=</span> lastStack != <span class=\"literal\">null</span></span><br><span class=\"line\">                    &amp;&amp; (!lastStack.mFullscreen</span><br><span class=\"line\">                    || (lastStack.mLastPausedActivity != <span class=\"literal\">null</span></span><br><span class=\"line\">                    &amp;&amp; !lastStack.mLastPausedActivity.fullscreen));</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!next.visible || next.stopped || lastActivityTranslucent) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 前一个 Activity 为透明，并且当前 Activity 还没显示</span></span><br><span class=\"line\">            <span class=\"comment\">// 设置为显示状态</span></span><br><span class=\"line\">            next.setVisibility(<span class=\"literal\">true</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 让窗口管理器重新基于新的 Activity 顺序评估屏幕的方向</span></span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">notUpdated</span> <span class=\"operator\">=</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStackSupervisor.isFocusedStack(<span class=\"built_in\">this</span>)) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">final</span> <span class=\"type\">Configuration</span> <span class=\"variable\">config</span> <span class=\"operator\">=</span> mWindowManager.updateOrientationFromAppTokens(</span><br><span class=\"line\">                        mStackSupervisor.getDisplayOverrideConfiguration(mDisplayId),</span><br><span class=\"line\">                        next.mayFreezeScreenLocked(next.app) ? next.appToken : <span class=\"literal\">null</span>, mDisplayId);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (config != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \tnext.frozenBeforeDestroy = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        notUpdated = !mService.updateDisplayOverrideConfigurationLocked(config, next,</span><br><span class=\"line\">                        <span class=\"literal\">false</span> <span class=\"comment\">/* deferResume */</span>, mDisplayId);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">     <span class=\"keyword\">if</span> (notUpdated) &#123;</span><br><span class=\"line\">         <span class=\"comment\">// 配置发生更新无法保持已经存在的 Activity 实例</span></span><br><span class=\"line\">         <span class=\"comment\">// 重新获取需要恢复的 Activity</span></span><br><span class=\"line\">         <span class=\"type\">ActivityRecord</span> <span class=\"variable\">nextNext</span> <span class=\"operator\">=</span> topRunningActivityLocked();</span><br><span class=\"line\">         <span class=\"comment\">// 确保 Activity 仍然保持在栈顶，同时安排另外一次执行</span></span><br><span class=\"line\">         <span class=\"keyword\">if</span> (nextNext != next) &#123;</span><br><span class=\"line\">         \tmStackSupervisor.scheduleResumeTopActivities();</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (!next.visible || next.stopped) &#123;</span><br><span class=\"line\">         \tnext.setVisibility(<span class=\"literal\">true</span>);</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         next.completeResumeLocked();</span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 传递所有等待的结果</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (next.newIntents != <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">            next.app.thread.scheduleNewIntent(</span><br><span class=\"line\">                            next.newIntents, next.appToken, <span class=\"literal\">false</span> <span class=\"comment\">/* andPause */</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        next.notifyAppResumed(next.stopped);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 准备恢复 Activity</span></span><br><span class=\"line\">        next.app.thread.scheduleResumeActivity(next.appToken, next.app.repProcState,</span><br><span class=\"line\">                        mService.isNextTransitionForward(), resumeAnimOptions);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 发生异常，重新启动 Activity</span></span><br><span class=\"line\">        mStackSupervisor.startSpecificActivityLocked(next, <span class=\"literal\">true</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            next.completeResumeLocked();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span>(Exception e)&#123;</span><br><span class=\"line\">            <span class=\"comment\">// 发生异常，结束 Activity</span></span><br><span class=\"line\">            requestFinishActivityLocked(next.appToken, Activity.RESULT_CANCELED, <span class=\"literal\">null</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;resume-exception&quot;</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 需要启动 Activity</span></span><br><span class=\"line\">        mStackSupervisor.startSpecificActivityLocked(next, <span class=\"literal\">true</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果可以不需要重新启动 Activity，则直接恢复 Activity 即可，否则进行重新启动流程：</p>\n<h3 id=\"ActivityStackSupervisor-1\"><a href=\"#ActivityStackSupervisor-1\" class=\"headerlink\" title=\"ActivityStackSupervisor\"></a>ActivityStackSupervisor</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">startSpecificActivityLocked</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获取应用进程信息</span></span><br><span class=\"line\">    <span class=\"type\">ProcessRecord</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> mService.getProcessRecordLocked(r.processName,</span><br><span class=\"line\">                r.info.applicationInfo.uid, <span class=\"literal\">true</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (app != <span class=\"literal\">null</span> &amp;&amp; app.thread != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 如果进程已经启动</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">catch</span> (RemoteException e)&#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 启动应用进程</span></span><br><span class=\"line\">    mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class=\"literal\">true</span>, <span class=\"number\">0</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;activity&quot;</span>, r.intent.getComponent(), <span class=\"literal\">false</span>, <span class=\"literal\">false</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"title function_\">realStartActivityLocked</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 冻结屏幕</span></span><br><span class=\"line\">    r.startFreezingScreenLocked(app, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (checkConfig) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 根据新的 Activity 顺序重新评估屏幕的方向</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">idx</span> <span class=\"operator\">=</span> app.activities.indexOf(r);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (idx &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 将 Activity 添加到应用进程中</span></span><br><span class=\"line\">        app.activities.add(r);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        app.thread.scheduleLaunchActivity();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">catch</span>(RemoteException e)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 发生异常，结束 Activity</span></span><br><span class=\"line\">        stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class=\"literal\">null</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;2nd-crash&quot;</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>启动流程最后还是回到了 ApplicationThread</p>\n<h3 id=\"ApplicationThread\"><a href=\"#ApplicationThread\" class=\"headerlink\" title=\"ApplicationThread\"></a>ApplicationThread</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">scheduleLaunchActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 通过 Handler 发送 LAUNCH_ACTIVITY</span></span><br><span class=\"line\">    sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>我们单独把 LAUNCH_ACTIVITY 的处理拿出来：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">ActivityClientRecord</span> <span class=\"variable\">r</span> <span class=\"operator\">=</span> (ActivityClientRecord) msg.obj;</span><br><span class=\"line\">r.packageInfo = getPackageInfoNoCheck(</span><br><span class=\"line\">                            r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class=\"line\">handleLaunchActivity(r, <span class=\"literal\">null</span>, <span class=\"string\">&quot;LAUNCH_ACTIVITY&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ActivityThread\"><a href=\"#ActivityThread\" class=\"headerlink\" title=\"ActivityThread\"></a>ActivityThread</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handleLaunchActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 执行启动 Activity</span></span><br><span class=\"line\">    <span class=\"type\">Activity</span> <span class=\"variable\">a</span> <span class=\"operator\">=</span> performLaunchActivity(r, customIntent);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (a != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// resume activity</span></span><br><span class=\"line\">        handleResumeActivity(r.token, <span class=\"literal\">false</span>, r.isForward,</span><br><span class=\"line\">                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"title function_\">performLaunchActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Activity 信息初始化</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 创建 context</span></span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">appContext</span> <span class=\"operator\">=</span> createBaseContextForActivity(r);</span><br><span class=\"line\">    <span class=\"type\">Activity</span> <span class=\"variable\">activity</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        java.lang.<span class=\"type\">ClassLoader</span> <span class=\"variable\">cl</span> <span class=\"operator\">=</span> appContext.getClassLoader();</span><br><span class=\"line\">        <span class=\"comment\">// 构建 Activity</span></span><br><span class=\"line\">        activity = mInstrumentation.newActivity(</span><br><span class=\"line\">                    cl, component.getClassName(), r.intent);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">catch</span>(Exception e)&#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> r.packageInfo.makeApplication(<span class=\"literal\">false</span>, mInstrumentation);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(activity != <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">        \tactivity.attach();</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">// 通过 Instrumentation 执行 Activity onCreate</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (r.isPersistable()) &#123;</span><br><span class=\"line\">                 mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class=\"line\">            &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!r.activity.mFinished) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Activity onStart</span></span><br><span class=\"line\">            \tactivity.performStart();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">// 通过 Instrumentation 执行 Activity onRestoreInstanceState</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!r.activity.mFinished) &#123;</span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (r.isPersistable()) &#123;</span><br><span class=\"line\">                \t<span class=\"keyword\">if</span> (r.state != <span class=\"literal\">null</span> || r.persistentState != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    \tmInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</span><br><span class=\"line\">                                    r.persistentState);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (r.state != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">             <span class=\"comment\">// 通过 Instrumentation 执行 Activity onPostCreeate</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!r.activity.mFinished) &#123;</span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (r.isPersistable()) &#123;</span><br><span class=\"line\">                    mInstrumentation.callActivityOnPostCreate(activity, r.state,</span><br><span class=\"line\">                                r.persistentState);</span><br><span class=\"line\">                &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    mInstrumentation.callActivityOnPostCreate(activity, r.state);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"keyword\">return</span> activity;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handleResumeActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    r = performResumeActivity();</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(r != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">Activity</span> <span class=\"variable\">a</span> <span class=\"operator\">=</span> r.activity;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.window == <span class=\"literal\">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class=\"line\">            r.window = r.activity.getWindow();</span><br><span class=\"line\">            <span class=\"type\">View</span> <span class=\"variable\">decor</span> <span class=\"operator\">=</span> r.window.getDecorView();</span><br><span class=\"line\">            decor.setVisibility(View.INVISIBLE);</span><br><span class=\"line\">            <span class=\"type\">ViewManager</span> <span class=\"variable\">wm</span> <span class=\"operator\">=</span> a.getWindowManager();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (a.mVisibleFromClient) &#123;</span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (!a.mWindowAdded) &#123;</span><br><span class=\"line\">                \ta.mWindowAdded = <span class=\"literal\">true</span>;</span><br><span class=\"line\">                    <span class=\"comment\">// window</span></span><br><span class=\"line\">                    wm.addView(decor, l);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> ActivityClientRecord <span class=\"title function_\">performResumeActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"> \t<span class=\"keyword\">if</span> (r != <span class=\"literal\">null</span> &amp;&amp; !r.activity.mFinished) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 处理等待的 Intent</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (r.pendingIntents != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            \tdeliverNewIntents(r, r.pendingIntents);</span><br><span class=\"line\">                r.pendingIntents = <span class=\"literal\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 处理等待的 result</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (r.pendingResults != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            \tdeliverResults(r, r.pendingResults);</span><br><span class=\"line\">                r.pendingResults = <span class=\"literal\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 执行 resume</span></span><br><span class=\"line\">            r.activity.performResume();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Instrumentation-1\"><a href=\"#Instrumentation-1\" class=\"headerlink\" title=\"Instrumentation\"></a>Instrumentation</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> Activity <span class=\"title function_\">newActivity</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (Activity)cl.loadClass(className).newInstance();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">callActivityOnCreate</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    prePerformCreate(activity);</span><br><span class=\"line\">    activity.performCreate(icicle);</span><br><span class=\"line\">    postPerformCreate(activity);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Activity-1\"><a href=\"#Activity-1\" class=\"headerlink\" title=\"Activity\"></a>Activity</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performCreate</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    restoreHasCurrentPermissionRequest(icicle);</span><br><span class=\"line\">    <span class=\"comment\">// 调用 onCreate</span></span><br><span class=\"line\">    onCreate(icicle);</span><br><span class=\"line\">    mActivityTransitionState.readState(icicle);</span><br><span class=\"line\">    performCreateCommon();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performStart</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    mActivityTransitionState.setEnterActivityOptions(<span class=\"built_in\">this</span>, getActivityOptions());</span><br><span class=\"line\">    mInstrumentation.callActivityOnStart(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">    mActivityTransitionState.enterReady(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performResume</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 执行 restart</span></span><br><span class=\"line\">    performRestart();</span><br><span class=\"line\">    mInstrumentation.callActivityOnResume(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performRestart</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStopped) &#123;</span><br><span class=\"line\">        mStopped = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        mInstrumentation.callActivityOnRestart(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 执行 start</span></span><br><span class=\"line\">        performStart();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Instrumentation-2\"><a href=\"#Instrumentation-2\" class=\"headerlink\" title=\"Instrumentation\"></a>Instrumentation</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">callActivityOnStart</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    activity.onStart();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">callActivityOnResume</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">     activity.mResumed = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    activity.onResume();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">callActivityOnRestart</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    activity.onRestart();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>简单总结下 Activity 的启动流程：</p>\n<ol>\n<li>从用户应用进程开始启动，如果从桌面启动，则为 launcher 进程，用户进程通过 Binder 机制与 system_server 进程进行通信</li>\n<li>ActivityManagerService 用于管理所有的 Activity 活动<ul>\n<li>当接受到启动 Activity 的调用时，使用 <code>resolveActivity</code> ，查询系统中符合要求的 Activity</li>\n<li>创建使用合适的  ActivityStack 和 launch flags 来启动 Activity</li>\n<li>如果存在可以直接恢复 Activity，则恢复，否则重新启动 Activity</li>\n<li>如果不存在应用进程，先创建应用进程</li>\n</ul>\n</li>\n<li>最终启动流程又会通过 Binder 调用回应用进程，使用 ActivityThread 去执行<ul>\n<li>使用 Instrumentation 去通过反射构建 Activity 实例</li>\n<li>使用 Handler 机制调用 Activity 的生命周期</li>\n</ul>\n</li>\n</ol>\n<p>下面的图例来自<a href=\"http://gityuan.com/2016/03/12/start-activity/\">博客</a>：</p>\n<p><img src=\"http://gityuan.com/images/activity/start_activity_process.jpg\" alt=\"启动流程\"></p>\n<h3 id=\"时序图\"><a href=\"#时序图\" class=\"headerlink\" title=\"时序图\"></a>时序图</h3><p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png?x-oss-process=style/doc-img\" alt=\"Android启动流程\"></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>基于 Android 26，分析 Android Activity 启动流程</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://gityuan.com/2016/03/12/start-activity/\">startActivity启动过程分析</a></p>\n<h2 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h2><p><strong>源码篇幅可能过长，所以会省略一下不必要的代码和注释</strong></p>\n<h3 id=\"Activity\"><a href=\"#Activity\" class=\"headerlink\" title=\"Activity\"></a>Activity</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                    </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivity</span><span class=\"params\">()</span> &#123;   </span><br><span class=\"line\">    <span class=\"built_in\">this</span>.startActivity(intent, <span class=\"literal\">null</span>);        </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                           </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (options != <span class=\"literal\">null</span>) &#123;                                          </span><br><span class=\"line\">        startActivityForResult(intent, -<span class=\"number\">1</span>, options);                </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                        </span><br><span class=\"line\">        startActivityForResult(intent, -<span class=\"number\">1</span>);                         </span><br><span class=\"line\">    &#125;                                                               </span><br><span class=\"line\">&#125;                                                                   </span><br></pre></td></tr></table></figure>\n\n<p>最终都会调用到 <code>startActivityForResult</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivityForResult</span><span class=\"params\">()</span> &#123;                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mParent == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 转场动画的处理</span></span><br><span class=\"line\">        Instrumentation.<span class=\"type\">ActivityResult</span> <span class=\"variable\">ar</span> <span class=\"operator\">=</span> mInstrumentation.execStartActivity();                                                                                                                                                      </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ar != <span class=\"literal\">null</span>) &#123;                                                                       </span><br><span class=\"line\">            mMainThread.sendActivityResult();                                                                                                             </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (requestCode &gt;= <span class=\"number\">0</span>) &#123;                                                                                        </span><br><span class=\"line\">            mStartedActivity = <span class=\"literal\">true</span>;                                                            </span><br><span class=\"line\">        &#125;                                                                                                                                                                             </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                                    </span><br><span class=\"line\">        <span class=\"comment\">// 如果存在 Parent Activity 则交由它处理                                                                                    </span></span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">&#125;                                                                                               </span><br></pre></td></tr></table></figure>\n\n<p>可以知道 Activity 启动委托给了 Instrumentation 进行实现</p>\n<h3 id=\"Instrumentation\"><a href=\"#Instrumentation\" class=\"headerlink\" title=\"Instrumentation\"></a>Instrumentation</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> ActivityResult <span class=\"title function_\">execStartActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 由 ActivityThread.getApplicationThread 提供的 ApplicationThread</span></span><br><span class=\"line\">    <span class=\"type\">IApplicationThread</span> <span class=\"variable\">whoThread</span> <span class=\"operator\">=</span> (IApplicationThread) contextThread;                                                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mActivityMonitors != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (mSync) &#123;                                             </span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">N</span> <span class=\"operator\">=</span> mActivityMonitors.size();                        </span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>; i&lt;N; i++) &#123;                                      </span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">ActivityMonitor</span> <span class=\"variable\">am</span> <span class=\"operator\">=</span> mActivityMonitors.get(i);       </span><br><span class=\"line\">                <span class=\"type\">ActivityResult</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;                              </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (am.ignoreMatchingSpecificIntents()) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// true 表示这个监视器被用于使用 onStartActivity 拦截所有 Activity 启动 </span></span><br><span class=\"line\">                    result = am.onStartActivity(intent);                   </span><br><span class=\"line\">                &#125;                                                          </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (result != <span class=\"literal\">null</span>) &#123;                                      </span><br><span class=\"line\">                    am.mHits++;                                            </span><br><span class=\"line\">                    <span class=\"keyword\">return</span> result;                                         </span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (am.match(who, <span class=\"literal\">null</span>, intent)) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// match 使用 IntentFilter 和 类名 进行匹配</span></span><br><span class=\"line\">                    am.mHits++;                                            </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (am.isBlocking()) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// 当前监视器阻止 Activity 启动</span></span><br><span class=\"line\">                        <span class=\"keyword\">return</span> requestCode &gt;= <span class=\"number\">0</span> ? am.getResult() : <span class=\"literal\">null</span>;   </span><br><span class=\"line\">                    &#125;                                                      </span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                                                 </span><br><span class=\"line\">                &#125;                                                          </span><br><span class=\"line\">            &#125;                                                              </span><br><span class=\"line\">        &#125;                                                                  </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 委托为 ActivityManagerService(AMS) 去处理</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> ActivityManager.getService().startActivity();                          </span><br><span class=\"line\">        <span class=\"comment\">// 检查 AMS 的处理结果</span></span><br><span class=\"line\">        checkStartActivityResult(result, intent);                          </span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (RemoteException e) &#123;                                          </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Failure from system&quot;</span>, e);              </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;                                                           </span><br><span class=\"line\">&#125;                                                                          </span><br></pre></td></tr></table></figure>\n\n<p>可以通过最后的调用委托给了<code>ActivityManager.getService</code>，实际上就是 ActivityManagerService(AMS) 的 Binder 代理类实现</p>\n<blockquote>\n<p>相对于之前的版本，比如 Android 23，现在已经没有了 ActivityManagerProxy 和 ActivityManagerNative，将直接与 system_server 进程上的 AMS 进行 IPC</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IActivityManager <span class=\"title function_\">getService</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> IActivityManagerSingleton.get();  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =          </span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">Singleton</span>&lt;IActivityManager&gt;() &#123;                                           </span><br><span class=\"line\">            <span class=\"meta\">@Override</span>                                                                 </span><br><span class=\"line\">            <span class=\"keyword\">protected</span> IActivityManager <span class=\"title function_\">create</span><span class=\"params\">()</span> &#123;                                     </span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">IBinder</span> <span class=\"variable\">b</span> <span class=\"operator\">=</span> ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"type\">IActivityManager</span> <span class=\"variable\">am</span> <span class=\"operator\">=</span> IActivityManager.Stub.asInterface(b);     </span><br><span class=\"line\">                <span class=\"keyword\">return</span> am;                                                            </span><br><span class=\"line\">            &#125;                                                                         </span><br><span class=\"line\">        &#125;;                                                                            </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ActivityManagerService\"><a href=\"#ActivityManagerService\" class=\"headerlink\" title=\"ActivityManagerService\"></a>ActivityManagerService</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivity</span><span class=\"params\">()</span> &#123;                           </span><br><span class=\"line\">    <span class=\"keyword\">return</span> startActivityAsUser();                                                     </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                                                          </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivityAsUser</span><span class=\"params\">()</span> &#123;                                                                                                                                   </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mActivityStarter.startActivityMayWait();                                                                                                </span><br><span class=\"line\">&#125;                                                                                                                                  </span><br></pre></td></tr></table></figure>\n\n<p>这里将启动请求又委托给了 ActivityStarter</p>\n<h3 id=\"ActivityStarter\"><a href=\"#ActivityStarter\" class=\"headerlink\" title=\"ActivityStarter\"></a>ActivityStarter</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivityMayWait</span><span class=\"params\">()</span> &#123;                                                </span><br><span class=\"line\">    <span class=\"comment\">// Intent 的响应</span></span><br><span class=\"line\">    <span class=\"type\">ResolveInfo</span> <span class=\"variable\">rInfo</span> <span class=\"operator\">=</span> mSupervisor.resolveIntent(intent, resolvedType, userId);                                                                                                                                           </span><br><span class=\"line\">    <span class=\"comment\">// Intent 的 Activity 信息                                                               </span></span><br><span class=\"line\">    <span class=\"type\">ActivityInfo</span> <span class=\"variable\">aInfo</span> <span class=\"operator\">=</span> mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);                                                                                                                                                                                                                                                                                                                                        </span><br><span class=\"line\">        <span class=\"keyword\">final</span> ActivityRecord[] outRecord = <span class=\"keyword\">new</span> <span class=\"title class_\">ActivityRecord</span>[<span class=\"number\">1</span>];</span><br><span class=\"line\">    \t<span class=\"comment\">// 调用 startActivityLocked</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> startActivityLocked(outRecord);                                                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">return</span> res;                                                                                                       </span><br><span class=\"line\">    &#125;                                                                                                                     </span><br><span class=\"line\">&#125;                                                                                                                         </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 源 Activity 记录，即在哪个 Activity 进行 startActivity</span></span><br><span class=\"line\">    <span class=\"type\">ActivityRecord</span> <span class=\"variable\">sourceRecord</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 如果使用 startActivityForResult，result 返回的 Activity 称为结果 Activity</span></span><br><span class=\"line\">    <span class=\"type\">ActivityRecord</span> <span class=\"variable\">resultRecord</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (resultTo != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 获取 Activity Stack 中已经存在的源 Activity 记录</span></span><br><span class=\"line\">        sourceRecord = mSupervisor.isInAnyStackLocked(resultTo);                                                                                 </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sourceRecord != <span class=\"literal\">null</span>) &#123;                                                                           </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (requestCode &gt;= <span class=\"number\">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// requestCode &gt;= 0，源 Activity 同时为 结果 Activity</span></span><br><span class=\"line\">                resultRecord = sourceRecord;                                                                  </span><br><span class=\"line\">            &#125;                                                                                                 </span><br><span class=\"line\">        &#125;                                                                                                     </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">launchFlags</span> <span class=\"operator\">=</span> intent.getFlags();                                                                </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class=\"number\">0</span> &amp;&amp; sourceRecord != <span class=\"literal\">null</span>) &#123;                   </span><br><span class=\"line\">        <span class=\"comment\">// 使用 FLAG_ACTIVITY_FORWARD_RESULT，可以将返回结果的源 Activity 转移为当前正在新启动的 Activity</span></span><br><span class=\"line\">        <span class=\"comment\">// 比如：A -&gt; B,B - C 使用了 FLAG_ACTIVITY_FORWARD_RESULT,那么 C 的 setResult 会返回给 A</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (requestCode &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 不允许有 requestCode</span></span><br><span class=\"line\">            ActivityOptions.abort(options);                                                                   </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;                                        </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 将源 Activity 的结果 Activity 设置为新 Activity 的结果 Activity</span></span><br><span class=\"line\">        resultRecord = sourceRecord.resultTo;                                                                 </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultRecord != <span class=\"literal\">null</span> &amp;&amp; !resultRecord.isInStackLocked()) &#123;                                        </span><br><span class=\"line\">            resultRecord = <span class=\"literal\">null</span>;                                                                              </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// requestCode 处理</span></span><br><span class=\"line\">        resultWho = sourceRecord.resultWho;                                                                   </span><br><span class=\"line\">        requestCode = sourceRecord.requestCode;                                                               </span><br><span class=\"line\">        sourceRecord.resultTo = <span class=\"literal\">null</span>;                                                                         </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultRecord != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 删除源 Activity 记录</span></span><br><span class=\"line\">            resultRecord.removeResultsLocked(sourceRecord, resultWho, requestCode);                           </span><br><span class=\"line\">        &#125;                                                                                                                                                                                         </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class=\"literal\">null</span>) &#123;                              </span><br><span class=\"line\">        <span class=\"comment\">// component 找不到                                                                         </span></span><br><span class=\"line\">        err = ActivityManager.START_INTENT_NOT_RESOLVED;                                                      </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class=\"literal\">null</span>) &#123;                                              </span><br><span class=\"line\">        <span class=\"comment\">// ActivityInfo 找不到                                                                         </span></span><br><span class=\"line\">        err = ActivityManager.START_CLASS_NOT_FOUND;                                                          </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; sourceRecord != <span class=\"literal\">null</span>                                          </span><br><span class=\"line\">            &amp;&amp; sourceRecord.getTask().voiceSession != <span class=\"literal\">null</span>) &#123;                                                 </span><br><span class=\"line\">        <span class=\"comment\">// 语音启动 Activity，检查是否符合                                                                      </span></span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; voiceSession != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">        <span class=\"comment\">// 启动语音会话                                                       </span></span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityStack</span> <span class=\"variable\">resultStack</span> <span class=\"operator\">=</span> resultRecord == <span class=\"literal\">null</span> ? <span class=\"literal\">null</span> : resultRecord.getStack();                  </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err != START_SUCCESS) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 启动 Activity 失败</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultRecord != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 发送取消通知</span></span><br><span class=\"line\">            resultStack.sendActivityResultLocked(                                                             </span><br><span class=\"line\">                    -<span class=\"number\">1</span>, resultRecord, resultWho, requestCode, RESULT_CANCELED, <span class=\"literal\">null</span>);                         </span><br><span class=\"line\">        &#125;                                                                                                     </span><br><span class=\"line\">        ActivityOptions.abort(options);                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">return</span> err;                                                                                           </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"comment\">// 进行一些权限检查，判断是否终止                                                              </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (abort) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果需要终止 Activity</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultRecord != <span class=\"literal\">null</span>) &#123;                                                                           </span><br><span class=\"line\">            resultStack.sendActivityResultLocked();                                                                   </span><br><span class=\"line\">        &#125;                                                                                                     </span><br><span class=\"line\">        <span class=\"comment\">// 返回启动成功，实际终止                                                                </span></span><br><span class=\"line\">        ActivityOptions.abort(options);                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_SUCCESS;                                                                                 </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"comment\">// 如果权限检查是否在启动 Activity 之前，那么先启动权限检查的 Intent                                                             </span></span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"comment\">// 处理 ephemeral app                                                                    </span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 构造一个 ActivityRecord</span></span><br><span class=\"line\">    <span class=\"type\">ActivityRecord</span> <span class=\"variable\">r</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ActivityRecord</span>();                                                   </span><br><span class=\"line\">                                                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityStack</span> <span class=\"variable\">stack</span> <span class=\"operator\">=</span> mSupervisor.mFocusedStack;                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (voiceSession == <span class=\"literal\">null</span> &amp;&amp; (stack.mResumedActivity == <span class=\"literal\">null</span>                                               </span><br><span class=\"line\">            || stack.mResumedActivity.info.applicationInfo.uid != callingUid)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 前台 stack 还没 resume 状态的 Activity，检查是否允许 app 切换</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mService.checkAppSwitchAllowedLocked() &#123;                                          </span><br><span class=\"line\">            <span class=\"type\">PendingActivityLaunch</span> <span class=\"variable\">pal</span> <span class=\"operator\">=</span>  <span class=\"keyword\">new</span> <span class=\"title class_\">PendingActivityLaunch</span>();                                              </span><br><span class=\"line\">            mPendingActivityLaunches.add(pal);                                                                </span><br><span class=\"line\">            ActivityOptions.abort(options);</span><br><span class=\"line\">            <span class=\"comment\">// 切换 app 失败</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> ActivityManager.START_SWITCHES_CANCELED;                                                   </span><br><span class=\"line\">        &#125;                                                                                                     </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.mDidAppSwitch) &#123;                                                                             </span><br><span class=\"line\">        <span class=\"comment\">// 从上次禁止 app 切换以来，这是第二次，允许 app 切换，并将切换时间设置为 0                                                            </span></span><br><span class=\"line\">        mService.mAppSwitchesAllowedTime = <span class=\"number\">0</span>;                                                                 </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                                                  </span><br><span class=\"line\">        mService.mDidAppSwitch = <span class=\"literal\">true</span>;                                                                        </span><br><span class=\"line\">    &#125;                                                                                                         </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 执行因为不允许 app 切换，而加到等待启动的 Activity</span></span><br><span class=\"line\">    doPendingActivityLaunchesLocked(<span class=\"literal\">false</span>);                                                                   </span><br><span class=\"line\">                                                                                                              </span><br><span class=\"line\">    <span class=\"keyword\">return</span> startActivity();                                                                    </span><br><span class=\"line\">&#125;                                                                                                             </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivity</span><span class=\"params\">()</span> &#123;                                                        </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> START_CANCELED;                                                               </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;                                                                                      </span><br><span class=\"line\">        mService.mWindowManager.deferSurfaceLayout();</span><br><span class=\"line\">        <span class=\"comment\">// 下一步流程</span></span><br><span class=\"line\">        result = startActivityUnchecked();                           </span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;                                                                                </span><br><span class=\"line\">        <span class=\"comment\">// 如果启动 Activity 没有成功， 从 task 中移除 Activity                                                      </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!ActivityManager.isStartResultSuccessful(result)                                   </span><br><span class=\"line\">                &amp;&amp; mStartActivity.getTask() != <span class=\"literal\">null</span>) &#123;                                         </span><br><span class=\"line\">            mStartActivity.getTask().removeActivity(mStartActivity);                           </span><br><span class=\"line\">        &#125;                                                                                      </span><br><span class=\"line\">        mService.mWindowManager.continueSurfaceLayout();                                       </span><br><span class=\"line\">    &#125;                                                                                          </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    postStartActivityProcessing();                                                                     </span><br><span class=\"line\">                                                                                               </span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;                                                                             </span><br><span class=\"line\">&#125;                                                                                              </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"title function_\">startActivityUnchecked</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"comment\">// 设置一些初始化状态</span></span><br><span class=\"line\">    setInitialState();</span><br><span class=\"line\">    <span class=\"comment\">// 计算 launch flags</span></span><br><span class=\"line\">    computeLaunchingTaskFlags();</span><br><span class=\"line\">    <span class=\"comment\">// 计算源 Task，源 Task 是否存在等</span></span><br><span class=\"line\">    computeSourceStack();</span><br><span class=\"line\">    <span class=\"comment\">// 获取是否存在可以复用的 Activity，根据 flags 和 launchMode</span></span><br><span class=\"line\">    <span class=\"type\">ActivityRecord</span> <span class=\"variable\">reusedActivity</span> <span class=\"operator\">=</span> getReusableIntentActivity();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (reusedActivity != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 存在可复用的 Activity，复用它</span></span><br><span class=\"line\">        <span class=\"comment\">// 可能需要清除 Task 中其他 Activity，并将启动的 Activity 前置</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartActivity.packageName == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> START_CLASS_NOT_FOUND;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 如果启动的 Activity 与当前 Task 顶部的 Activity 相同，判断是否需要继续启动新的 Activity</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">dontStart</span> <span class=\"operator\">=</span> top != <span class=\"literal\">null</span> &amp;&amp; mStartActivity.resultTo == <span class=\"literal\">null</span></span><br><span class=\"line\">                &amp;&amp; top.realActivity.equals(mStartActivity.realActivity)</span><br><span class=\"line\">                &amp;&amp; top.userId == mStartActivity.userId</span><br><span class=\"line\">                &amp;&amp; top.app != <span class=\"literal\">null</span> &amp;&amp; top.app.thread != <span class=\"literal\">null</span></span><br><span class=\"line\">                &amp;&amp; ((mLaunchFlags &amp; FLAG_ACTIVITY_SINGLE_TOP) != <span class=\"number\">0</span></span><br><span class=\"line\">                || mLaunchSingleTop || mLaunchSingleTask);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(dontStart)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 传递一个新的 Intent 到 onNewIntent </span></span><br><span class=\"line\">        top.deliverNewIntentLocked();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_DELIVERED_TO_TOP;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 获取 mTargetStack</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartActivity.resultTo == <span class=\"literal\">null</span> &amp;&amp; mInTask == <span class=\"literal\">null</span> &amp;&amp; !mAddingToTask</span><br><span class=\"line\">                &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    \tnewTask = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 需要创建新的 Task</span></span><br><span class=\"line\">        result = setTaskFromReuseOrCreateNewTask();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mSourceRecord != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 从源 Activity 中获取 Task</span></span><br><span class=\"line\">    \tresult = setTaskFromSourceRecord();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mInTask != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 从 InTask 中获取 Task</span></span><br><span class=\"line\">    \tresult = setTaskFromInTask();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 可能创建新的 Task 或使用当前 Task，一般不会发生</span></span><br><span class=\"line\">    \tsetTaskToCurrentTopOrCreateNewTask();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 使用 mTargetStack 启动 Activity </span></span><br><span class=\"line\">    mTargetStack.startActivityLocked();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDoResume) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mTargetStack.isFocusable()</span><br><span class=\"line\">                    || (topTaskActivity != <span class=\"literal\">null</span> &amp;&amp; topTaskActivity.mTaskOverlay</span><br><span class=\"line\">                    &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 目标 Task 不可聚焦 ，或者源 Task 栈顶 Activity 总是在其他 Activity 之上，并且不为源 Activity</span></span><br><span class=\"line\">            <span class=\"comment\">// 那么我们不恢复目标 Task，只需要确保它可见即可</span></span><br><span class=\"line\">            mTargetStack.ensureActivitiesVisibleLocked(<span class=\"literal\">null</span>, <span class=\"number\">0</span>, !PRESERVE_WINDOWS);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mTargetStack.isFocusable() &amp;&amp; !mSupervisor.isFocusedStack(mTargetStack)) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 如果目标 Task 之前不是可聚焦，但是现在为可聚焦，那么移动到前台</span></span><br><span class=\"line\">            mTargetStack.moveToFront(<span class=\"string\">&quot;startActivityUnchecked&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 恢复目标 Task</span></span><br><span class=\"line\">        mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,</span><br><span class=\"line\">                        mOptions);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果不需要恢复，那么加到&quot;最近活动&quot;中</span></span><br><span class=\"line\">        mTargetStack.addRecentActivityLocked(mStartActivity);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> START_SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setInitialState</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获取 DisplayId</span></span><br><span class=\"line\">    mSourceDisplayId = getSourceDisplayId();</span><br><span class=\"line\">    <span class=\"comment\">// 获取用于启动 Activity 的范围，Rect</span></span><br><span class=\"line\">    mLaunchBounds = getOerrideBounds();</span><br><span class=\"line\">    <span class=\"comment\">// launchMode</span></span><br><span class=\"line\">    mLaunchSingleTop = r.launchmode == LAUNCH_SINGLE_TOP;</span><br><span class=\"line\">    mLaunchSingleInstance = r.launchMode == LAUNCH_SINGLE_INSTANCE;</span><br><span class=\"line\">    mLaunchSingleTask = r.launchMode == LAUNCH_SINGLE_TASK;</span><br><span class=\"line\">    <span class=\"comment\">// Intent flags 的处理，如果和 Manifest 存在冲突，以 Manifest 为主</span></span><br><span class=\"line\">    <span class=\"comment\">// 如果 requestCode &gt;= 0，同时启动的 Activity 位于新的 Task，发送取消的结果给源 Activity</span></span><br><span class=\"line\">    sendNewTaskResultRequestIfNeeded();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">computeLaunchingTaskFlags</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mSourceRecord == <span class=\"literal\">null</span> &amp;&amp; mInTask != <span class=\"literal\">null</span> &amp;&amp; mInTask.getStack() != <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果不存在源 Activity</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">Intent</span> <span class=\"variable\">baseIntent</span> <span class=\"operator\">=</span> mInTask.getBaseIntent();</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">ActivityRecord</span> <span class=\"variable\">root</span> <span class=\"operator\">=</span> mInTask.getRootActivity();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (baseIntent == <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mLaunchSingleInstance || mLaunchSingleTask) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果设置了 SingleInstacne 或 SingleTask</span></span><br><span class=\"line\">        \t<span class=\"keyword\">if</span> (!baseIntent.getComponent().equals(mStartActivity.intent.getComponent()))&#123;</span><br><span class=\"line\">                <span class=\"comment\">// Task 不符合</span></span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">if</span>(root != <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">                <span class=\"comment\">// 已经存在 Task 根 Activity</span></span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (root == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 如果不存在根 Activity，重新设置 launch flags</span></span><br><span class=\"line\">            mAddingToTask = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">             mAddingToTask = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            mAddingToTask = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                     <span class=\"keyword\">if</span> ((mStartActivity.isResolverActivity() || mStartActivity.noDisplay) &amp;&amp; mSourceRecord != <span class=\"literal\">null</span></span><br><span class=\"line\">                    &amp;&amp; mSourceRecord.isFreeform())  &#123;</span><br><span class=\"line\">                         <span class=\"comment\">// 如果使用 ResolverActivity 启动或者 noDisplay</span></span><br><span class=\"line\">                mAddingToTask = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(mInTask == <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mSourceRecord == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        \t<span class=\"keyword\">if</span> ((mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) == <span class=\"number\">0</span> &amp;&amp; mInTask == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 不存在 Task，并且不存在源 Activity</span></span><br><span class=\"line\">            \tmLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mSourceRecord.launchMode == LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 如果源 Activity 的 launchMode 是 SingleInstance，要设置 NEW_TASK flag</span></span><br><span class=\"line\">            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mLaunchSingleInstance || mLaunchSingleTask) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 如果启动 Activity 的 launchMode 是 SingleInstance 或 SingleTask，需要设置 NEW_TASK flag</span></span><br><span class=\"line\">            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ActivityStarter 主要的作用是，计算 launch flags，创建或者复用合适的 Task，即 ActivityStack，从而启动 Activity</p>\n<h3 id=\"ActivityStack\"><a href=\"#ActivityStack\" class=\"headerlink\" title=\"ActivityStack\"></a>ActivityStack</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startActivityLocked</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!newTask) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果从已存在的 Task 中启动 Activity</span></span><br><span class=\"line\">      <span class=\"type\">boolean</span> <span class=\"variable\">startIt</span> <span class=\"operator\">=</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">taskNdx</span> <span class=\"operator\">=</span> mTaskHistory.size() - <span class=\"number\">1</span>; taskNdx &gt;= <span class=\"number\">0</span>; --taskNdx) &#123;</span><br><span class=\"line\">      \ttask = mTaskHistory.get(taskNdx);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (task.getTopActivity() == <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">              <span class=\"comment\">// 如果 task 不存在 Activity</span></span><br><span class=\"line\">              <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (task == rTask) &#123;</span><br><span class=\"line\">          \t<span class=\"comment\">// 找到对应的 task</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!startIt) &#123;</span><br><span class=\"line\">            \t<span class=\"comment\">// 如果当前对于用户还不可见，那么只是添加它，而不启动它，它将在用户导航回来时启动</span></span><br><span class=\"line\">                r.createWindowContainer();</span><br><span class=\"line\">                ActivityOptions.abort(options);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (task.numFullscreen &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">              startIt = <span class=\"literal\">false</span>;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 如果当前 task 为活动 task，那么不需要传递 onuserLeaving 回调</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (task == activityTask &amp;&amp; mTaskHistory.indexOf(task) != (mTaskHistory.size() - <span class=\"number\">1</span>)) &#123;</span><br><span class=\"line\">        mStackSupervisor.mUserLeaving = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!isHomeOrRecentsStack() || numActivities() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 如果当前不是 Home 或 Recent Task,或者活动 Activity 数量大于 0</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 处理 动画</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newTask) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果设置了重置的标记</span></span><br><span class=\"line\">            resetTaskIfNeededLocked(r, r);</span><br><span class=\"line\">            doShow = topRunningNonDelayedActivityLocked(<span class=\"literal\">null</span>) == r;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (options != <span class=\"literal\">null</span> &amp;&amp; options.getAnimationType()</span><br><span class=\"line\">                    == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 需要进行转场动画</span></span><br><span class=\"line\">                doShow = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class=\"line\">        \t<span class=\"comment\">// 如果为 true，那么不开启 window，但要确保 Activity 是可见的</span></span><br><span class=\"line\">            r.setVisibility(<span class=\"literal\">true</span>);</span><br><span class=\"line\">            ensureActivitiesVisibleLocked(<span class=\"literal\">null</span>, <span class=\"number\">0</span>, !PRESERVE_WINDOWS);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</span><br><span class=\"line\">            <span class=\"type\">TaskRecord</span> <span class=\"variable\">prevTask</span> <span class=\"operator\">=</span> r.getTask();</span><br><span class=\"line\">            <span class=\"type\">ActivityRecord</span> <span class=\"variable\">prev</span> <span class=\"operator\">=</span> prevTask.topRunningActivityWithStartingWindowLocked();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (prev != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 以下两种情况不展示之前的 Activity 预览</span></span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (prev.getTask() != prevTask) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 之前的 Activity 在不同的 Task</span></span><br><span class=\"line\">                \tprev = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (prev.nowVisible) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 现在可见</span></span><br><span class=\"line\">                \t prev = <span class=\"literal\">null</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 显示启动 Activity 的 Window</span></span><br><span class=\"line\">        \tr.showStartingWindow(prev, newTask, isTaskSwitch(r, focusedTopActivity));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 当前为栈顶 Activity</span></span><br><span class=\"line\">            ActivityOptions.abort(options);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>ActivityStack.startActivityLocked</code> 主要是创建 WindowContainer，同时显示 Window</p>\n<h3 id=\"ActivityStackSupervisor\"><a href=\"#ActivityStackSupervisor\" class=\"headerlink\" title=\"ActivityStackSupervisor\"></a>ActivityStackSupervisor</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"title function_\">resumeFocusedStackTopActivityLocked</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetStack != <span class=\"literal\">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 存在 targetStack</span></span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityRecord</span> <span class=\"variable\">r</span> <span class=\"operator\">=</span> mFocusedStack.topRunningActivityLocked();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (r == <span class=\"literal\">null</span> || r.state != RESUMED) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 恢复聚焦 task</span></span><br><span class=\"line\">    \tmFocusedStack.resumeTopActivityUncheckedLocked(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (r.state == RESUMED) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 执行应用转场动画</span></span><br><span class=\"line\">    \tmFocusedStack.executeAppTransition(targetOptions);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ActivityStack-1\"><a href=\"#ActivityStack-1\" class=\"headerlink\" title=\"ActivityStack\"></a>ActivityStack</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"title function_\">resumeTopActivityUncheckedLocked</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 防止递归</span></span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 设置恢复标记</span></span><br><span class=\"line\">        mStackSupervisor.inResumeTopActivity = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        result = resumeTopActivityInnerLocked(prev, options);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        mStackSupervisor.inResumeTopActivity = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 在恢复过程中，确保必要的暂停逻辑</span></span><br><span class=\"line\">    mStackSupervisor.checkReadyForSleepLocked();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">boolean</span> <span class=\"title function_\">resumeTopActivityInnerLocked</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 寻找需要恢复的栈顶 Activity，它必须是未结束并且聚焦</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityRecord</span> <span class=\"variable\">next</span> <span class=\"operator\">=</span> topRunningActivityLocked(<span class=\"literal\">true</span> <span class=\"comment\">/* focusableOnly */</span>);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">hasRunningActivity</span> <span class=\"operator\">=</span> next != <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityRecord</span> <span class=\"variable\">parent</span> <span class=\"operator\">=</span> mActivityContainer.mParentActivity;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">isParentNotResumed</span> <span class=\"operator\">=</span> parent != <span class=\"literal\">null</span> &amp;&amp; parent.state != ActivityState.RESUMED;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasRunningActivity</span><br><span class=\"line\">                &amp;&amp; (isParentNotResumed || !mActivityContainer.isAttachedLocked())) &#123;</span><br><span class=\"line\">           <span class=\"comment\">// 如果父 Activity 不是恢复状态，则不恢复当前 Activity</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!hasRunningActivity) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前 Task 没有需要恢复的 Activity</span></span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> resumeTopActivityInNextFocusableStack(prev, options, <span class=\"string\">&quot;noMoreActivities&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</span><br><span class=\"line\">                    mStackSupervisor.allResumedActivitiesComplete()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果 Activity 已经是恢复状态</span></span><br><span class=\"line\">        <span class=\"comment\">// 确保已经执行了所有等待的转场</span></span><br><span class=\"line\">        executeAppTransition(options);</span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.isSleepingOrShuttingDownLocked()</span><br><span class=\"line\">                &amp;&amp; mLastPausedActivity == next</span><br><span class=\"line\">                &amp;&amp; mStackSupervisor.allPausedActivitiesComplete()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 如果系统处于休眠状态，当前 Activity 处于暂停状态</span></span><br><span class=\"line\">        <span class=\"comment\">// 确保转场执行</span></span><br><span class=\"line\">        executeAppTransition(options);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!mService.mUserController.hasStartedUserState(next.userId)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果拥有该 Activity 的用户没有启动</span></span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!mStackSupervisor.allPausedActivitiesComplete()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 如果存在暂停 Activity 的操作未完成</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">lastResumedCanPip</span> <span class=\"operator\">=</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">ActivityStack</span> <span class=\"variable\">lastFocusedStack</span> <span class=\"operator\">=</span> mStackSupervisor.getLastStack();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (lastFocusedStack != <span class=\"literal\">null</span> &amp;&amp; lastFocusedStack != <span class=\"built_in\">this</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">final</span> <span class=\"type\">ActivityRecord</span> <span class=\"variable\">lastResumed</span> <span class=\"operator\">=</span> lastFocusedStack.mResumedActivity;</span><br><span class=\"line\">        <span class=\"comment\">// 最后一个恢复的 Activity 是否可以 画中画</span></span><br><span class=\"line\">        lastResumedCanPip = lastResumed != <span class=\"literal\">null</span> &amp;&amp; lastResumed.checkEnterPictureInPictureState(</span><br><span class=\"line\">                    <span class=\"string\">&quot;resumeTopActivity&quot;</span>, <span class=\"literal\">true</span> <span class=\"comment\">/* noThrow */</span>, userLeaving <span class=\"comment\">/* beforeStopping */</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 是否需要可以在上一个 Activity 暂停时进行恢复</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">resumeWhilePausing</span> <span class=\"operator\">=</span> (next.info.flags &amp; FLAG_RESUME_WHILE_PAUSING) != <span class=\"number\">0</span></span><br><span class=\"line\">                &amp;&amp; !lastResumedCanPip;</span><br><span class=\"line\">    <span class=\"comment\">// 是否暂停了回退的 task</span></span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">pausing</span> <span class=\"operator\">=</span> mStackSupervisor.pauseBackStacks(userLeaving, next, <span class=\"literal\">false</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mResumedActivity != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 暂停上一个恢复状态的 Activity</span></span><br><span class=\"line\">    \tpausing |= startPausingLocked(userLeaving, <span class=\"literal\">false</span>, next, <span class=\"literal\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pausing &amp;&amp; !resumeWhilePausing) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 之前的 Activity 已经暂停，但不能进行恢复当前 Activity</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (next.app != <span class=\"literal\">null</span> &amp;&amp; next.app.thread != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// hosting application，一般不执行</span></span><br><span class=\"line\">            <span class=\"comment\">// 让当前 Activity 放在 Lru 的顶部，避免早早杀死</span></span><br><span class=\"line\">        \tmService.updateLruProcessLocked(next.app, <span class=\"literal\">true</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</span><br><span class=\"line\">                mStackSupervisor.allResumedActivitiesComplete()) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 当前需要恢复的 Activity 已经是恢复状态</span></span><br><span class=\"line\">        <span class=\"comment\">// 确保执行转场</span></span><br><span class=\"line\">        executeAppTransition(options);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.isSleepingLocked() &amp;&amp; mLastNoHistoryActivity != <span class=\"literal\">null</span> &amp;&amp;</span><br><span class=\"line\">                !mLastNoHistoryActivity.finishing) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 结束因为系统休眠而还没结束的 Activity</span></span><br><span class=\"line\">    \trequestFinishActivityLocked(mLastNoHistoryActivity.appToken, Activity.RESULT_CANCELED,</span><br><span class=\"line\">                    <span class=\"literal\">null</span>, <span class=\"string\">&quot;resume-no-history&quot;</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        mLastNoHistoryActivity = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (prev != <span class=\"literal\">null</span> &amp;&amp; prev != next) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">if</span> (!mStackSupervisor.mActivitiesWaitingForVisibleActivity.contains(prev)</span><br><span class=\"line\">                    &amp;&amp; next != <span class=\"literal\">null</span> &amp;&amp; !next.nowVisible) &#123;</span><br><span class=\"line\">        \tmStackSupervisor.mActivitiesWaitingForVisibleActivity.add(prev);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果当前需要恢复的 Activity 已经可见，所有隐藏上一个 Activity</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (prev.finishing) &#123;</span><br><span class=\"line\">            \tprev.setVisibility(<span class=\"literal\">false</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// Activity 转场处理</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">ActivityStack</span> <span class=\"variable\">lastStack</span> <span class=\"operator\">=</span> mStackSupervisor.getLastStack();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (next.app != <span class=\"literal\">null</span> &amp;&amp; next.app.thread != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 上一个 Activity 是否为透明</span></span><br><span class=\"line\">    \t<span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"variable\">lastActivityTranslucent</span> <span class=\"operator\">=</span> lastStack != <span class=\"literal\">null</span></span><br><span class=\"line\">                    &amp;&amp; (!lastStack.mFullscreen</span><br><span class=\"line\">                    || (lastStack.mLastPausedActivity != <span class=\"literal\">null</span></span><br><span class=\"line\">                    &amp;&amp; !lastStack.mLastPausedActivity.fullscreen));</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!next.visible || next.stopped || lastActivityTranslucent) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 前一个 Activity 为透明，并且当前 Activity 还没显示</span></span><br><span class=\"line\">            <span class=\"comment\">// 设置为显示状态</span></span><br><span class=\"line\">            next.setVisibility(<span class=\"literal\">true</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 让窗口管理器重新基于新的 Activity 顺序评估屏幕的方向</span></span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">notUpdated</span> <span class=\"operator\">=</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStackSupervisor.isFocusedStack(<span class=\"built_in\">this</span>)) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">final</span> <span class=\"type\">Configuration</span> <span class=\"variable\">config</span> <span class=\"operator\">=</span> mWindowManager.updateOrientationFromAppTokens(</span><br><span class=\"line\">                        mStackSupervisor.getDisplayOverrideConfiguration(mDisplayId),</span><br><span class=\"line\">                        next.mayFreezeScreenLocked(next.app) ? next.appToken : <span class=\"literal\">null</span>, mDisplayId);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (config != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \tnext.frozenBeforeDestroy = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        notUpdated = !mService.updateDisplayOverrideConfigurationLocked(config, next,</span><br><span class=\"line\">                        <span class=\"literal\">false</span> <span class=\"comment\">/* deferResume */</span>, mDisplayId);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">     <span class=\"keyword\">if</span> (notUpdated) &#123;</span><br><span class=\"line\">         <span class=\"comment\">// 配置发生更新无法保持已经存在的 Activity 实例</span></span><br><span class=\"line\">         <span class=\"comment\">// 重新获取需要恢复的 Activity</span></span><br><span class=\"line\">         <span class=\"type\">ActivityRecord</span> <span class=\"variable\">nextNext</span> <span class=\"operator\">=</span> topRunningActivityLocked();</span><br><span class=\"line\">         <span class=\"comment\">// 确保 Activity 仍然保持在栈顶，同时安排另外一次执行</span></span><br><span class=\"line\">         <span class=\"keyword\">if</span> (nextNext != next) &#123;</span><br><span class=\"line\">         \tmStackSupervisor.scheduleResumeTopActivities();</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (!next.visible || next.stopped) &#123;</span><br><span class=\"line\">         \tnext.setVisibility(<span class=\"literal\">true</span>);</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         next.completeResumeLocked();</span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 传递所有等待的结果</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (next.newIntents != <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">            next.app.thread.scheduleNewIntent(</span><br><span class=\"line\">                            next.newIntents, next.appToken, <span class=\"literal\">false</span> <span class=\"comment\">/* andPause */</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        next.notifyAppResumed(next.stopped);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 准备恢复 Activity</span></span><br><span class=\"line\">        next.app.thread.scheduleResumeActivity(next.appToken, next.app.repProcState,</span><br><span class=\"line\">                        mService.isNextTransitionForward(), resumeAnimOptions);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 发生异常，重新启动 Activity</span></span><br><span class=\"line\">        mStackSupervisor.startSpecificActivityLocked(next, <span class=\"literal\">true</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            next.completeResumeLocked();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span>(Exception e)&#123;</span><br><span class=\"line\">            <span class=\"comment\">// 发生异常，结束 Activity</span></span><br><span class=\"line\">            requestFinishActivityLocked(next.appToken, Activity.RESULT_CANCELED, <span class=\"literal\">null</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;resume-exception&quot;</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 需要启动 Activity</span></span><br><span class=\"line\">        mStackSupervisor.startSpecificActivityLocked(next, <span class=\"literal\">true</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果可以不需要重新启动 Activity，则直接恢复 Activity 即可，否则进行重新启动流程：</p>\n<h3 id=\"ActivityStackSupervisor-1\"><a href=\"#ActivityStackSupervisor-1\" class=\"headerlink\" title=\"ActivityStackSupervisor\"></a>ActivityStackSupervisor</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">startSpecificActivityLocked</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获取应用进程信息</span></span><br><span class=\"line\">    <span class=\"type\">ProcessRecord</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> mService.getProcessRecordLocked(r.processName,</span><br><span class=\"line\">                r.info.applicationInfo.uid, <span class=\"literal\">true</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (app != <span class=\"literal\">null</span> &amp;&amp; app.thread != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 如果进程已经启动</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">catch</span> (RemoteException e)&#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 启动应用进程</span></span><br><span class=\"line\">    mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class=\"literal\">true</span>, <span class=\"number\">0</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;activity&quot;</span>, r.intent.getComponent(), <span class=\"literal\">false</span>, <span class=\"literal\">false</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"title function_\">realStartActivityLocked</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 冻结屏幕</span></span><br><span class=\"line\">    r.startFreezingScreenLocked(app, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (checkConfig) &#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 根据新的 Activity 顺序重新评估屏幕的方向</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">idx</span> <span class=\"operator\">=</span> app.activities.indexOf(r);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (idx &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 将 Activity 添加到应用进程中</span></span><br><span class=\"line\">        app.activities.add(r);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        app.thread.scheduleLaunchActivity();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">catch</span>(RemoteException e)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 发生异常，结束 Activity</span></span><br><span class=\"line\">        stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class=\"literal\">null</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;2nd-crash&quot;</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>启动流程最后还是回到了 ApplicationThread</p>\n<h3 id=\"ApplicationThread\"><a href=\"#ApplicationThread\" class=\"headerlink\" title=\"ApplicationThread\"></a>ApplicationThread</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">scheduleLaunchActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 通过 Handler 发送 LAUNCH_ACTIVITY</span></span><br><span class=\"line\">    sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>我们单独把 LAUNCH_ACTIVITY 的处理拿出来：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">ActivityClientRecord</span> <span class=\"variable\">r</span> <span class=\"operator\">=</span> (ActivityClientRecord) msg.obj;</span><br><span class=\"line\">r.packageInfo = getPackageInfoNoCheck(</span><br><span class=\"line\">                            r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class=\"line\">handleLaunchActivity(r, <span class=\"literal\">null</span>, <span class=\"string\">&quot;LAUNCH_ACTIVITY&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ActivityThread\"><a href=\"#ActivityThread\" class=\"headerlink\" title=\"ActivityThread\"></a>ActivityThread</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handleLaunchActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 执行启动 Activity</span></span><br><span class=\"line\">    <span class=\"type\">Activity</span> <span class=\"variable\">a</span> <span class=\"operator\">=</span> performLaunchActivity(r, customIntent);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (a != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// resume activity</span></span><br><span class=\"line\">        handleResumeActivity(r.token, <span class=\"literal\">false</span>, r.isForward,</span><br><span class=\"line\">                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"title function_\">performLaunchActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Activity 信息初始化</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 创建 context</span></span><br><span class=\"line\">    <span class=\"type\">ContextImpl</span> <span class=\"variable\">appContext</span> <span class=\"operator\">=</span> createBaseContextForActivity(r);</span><br><span class=\"line\">    <span class=\"type\">Activity</span> <span class=\"variable\">activity</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        java.lang.<span class=\"type\">ClassLoader</span> <span class=\"variable\">cl</span> <span class=\"operator\">=</span> appContext.getClassLoader();</span><br><span class=\"line\">        <span class=\"comment\">// 构建 Activity</span></span><br><span class=\"line\">        activity = mInstrumentation.newActivity(</span><br><span class=\"line\">                    cl, component.getClassName(), r.intent);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">catch</span>(Exception e)&#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> r.packageInfo.makeApplication(<span class=\"literal\">false</span>, mInstrumentation);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(activity != <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">        \tactivity.attach();</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">// 通过 Instrumentation 执行 Activity onCreate</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (r.isPersistable()) &#123;</span><br><span class=\"line\">                 mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class=\"line\">            &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!r.activity.mFinished) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Activity onStart</span></span><br><span class=\"line\">            \tactivity.performStart();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">// 通过 Instrumentation 执行 Activity onRestoreInstanceState</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!r.activity.mFinished) &#123;</span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (r.isPersistable()) &#123;</span><br><span class=\"line\">                \t<span class=\"keyword\">if</span> (r.state != <span class=\"literal\">null</span> || r.persistentState != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    \tmInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</span><br><span class=\"line\">                                    r.persistentState);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (r.state != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">             <span class=\"comment\">// 通过 Instrumentation 执行 Activity onPostCreeate</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!r.activity.mFinished) &#123;</span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (r.isPersistable()) &#123;</span><br><span class=\"line\">                    mInstrumentation.callActivityOnPostCreate(activity, r.state,</span><br><span class=\"line\">                                r.persistentState);</span><br><span class=\"line\">                &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    mInstrumentation.callActivityOnPostCreate(activity, r.state);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"keyword\">return</span> activity;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handleResumeActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    r = performResumeActivity();</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(r != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">Activity</span> <span class=\"variable\">a</span> <span class=\"operator\">=</span> r.activity;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.window == <span class=\"literal\">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class=\"line\">            r.window = r.activity.getWindow();</span><br><span class=\"line\">            <span class=\"type\">View</span> <span class=\"variable\">decor</span> <span class=\"operator\">=</span> r.window.getDecorView();</span><br><span class=\"line\">            decor.setVisibility(View.INVISIBLE);</span><br><span class=\"line\">            <span class=\"type\">ViewManager</span> <span class=\"variable\">wm</span> <span class=\"operator\">=</span> a.getWindowManager();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (a.mVisibleFromClient) &#123;</span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (!a.mWindowAdded) &#123;</span><br><span class=\"line\">                \ta.mWindowAdded = <span class=\"literal\">true</span>;</span><br><span class=\"line\">                    <span class=\"comment\">// window</span></span><br><span class=\"line\">                    wm.addView(decor, l);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> ActivityClientRecord <span class=\"title function_\">performResumeActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"> \t<span class=\"keyword\">if</span> (r != <span class=\"literal\">null</span> &amp;&amp; !r.activity.mFinished) &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 处理等待的 Intent</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (r.pendingIntents != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            \tdeliverNewIntents(r, r.pendingIntents);</span><br><span class=\"line\">                r.pendingIntents = <span class=\"literal\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 处理等待的 result</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (r.pendingResults != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            \tdeliverResults(r, r.pendingResults);</span><br><span class=\"line\">                r.pendingResults = <span class=\"literal\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 执行 resume</span></span><br><span class=\"line\">            r.activity.performResume();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Instrumentation-1\"><a href=\"#Instrumentation-1\" class=\"headerlink\" title=\"Instrumentation\"></a>Instrumentation</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> Activity <span class=\"title function_\">newActivity</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (Activity)cl.loadClass(className).newInstance();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">callActivityOnCreate</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    prePerformCreate(activity);</span><br><span class=\"line\">    activity.performCreate(icicle);</span><br><span class=\"line\">    postPerformCreate(activity);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Activity-1\"><a href=\"#Activity-1\" class=\"headerlink\" title=\"Activity\"></a>Activity</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performCreate</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    restoreHasCurrentPermissionRequest(icicle);</span><br><span class=\"line\">    <span class=\"comment\">// 调用 onCreate</span></span><br><span class=\"line\">    onCreate(icicle);</span><br><span class=\"line\">    mActivityTransitionState.readState(icicle);</span><br><span class=\"line\">    performCreateCommon();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performStart</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    mActivityTransitionState.setEnterActivityOptions(<span class=\"built_in\">this</span>, getActivityOptions());</span><br><span class=\"line\">    mInstrumentation.callActivityOnStart(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">    mActivityTransitionState.enterReady(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performResume</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 执行 restart</span></span><br><span class=\"line\">    performRestart();</span><br><span class=\"line\">    mInstrumentation.callActivityOnResume(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">performRestart</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStopped) &#123;</span><br><span class=\"line\">        mStopped = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        mInstrumentation.callActivityOnRestart(<span class=\"built_in\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 执行 start</span></span><br><span class=\"line\">        performStart();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Instrumentation-2\"><a href=\"#Instrumentation-2\" class=\"headerlink\" title=\"Instrumentation\"></a>Instrumentation</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">callActivityOnStart</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    activity.onStart();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">callActivityOnResume</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">     activity.mResumed = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    activity.onResume();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">callActivityOnRestart</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    activity.onRestart();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>简单总结下 Activity 的启动流程：</p>\n<ol>\n<li>从用户应用进程开始启动，如果从桌面启动，则为 launcher 进程，用户进程通过 Binder 机制与 system_server 进程进行通信</li>\n<li>ActivityManagerService 用于管理所有的 Activity 活动<ul>\n<li>当接受到启动 Activity 的调用时，使用 <code>resolveActivity</code> ，查询系统中符合要求的 Activity</li>\n<li>创建使用合适的  ActivityStack 和 launch flags 来启动 Activity</li>\n<li>如果存在可以直接恢复 Activity，则恢复，否则重新启动 Activity</li>\n<li>如果不存在应用进程，先创建应用进程</li>\n</ul>\n</li>\n<li>最终启动流程又会通过 Binder 调用回应用进程，使用 ActivityThread 去执行<ul>\n<li>使用 Instrumentation 去通过反射构建 Activity 实例</li>\n<li>使用 Handler 机制调用 Activity 的生命周期</li>\n</ul>\n</li>\n</ol>\n<p>下面的图例来自<a href=\"http://gityuan.com/2016/03/12/start-activity/\">博客</a>：</p>\n<p><img src=\"http://gityuan.com/images/activity/start_activity_process.jpg\" alt=\"启动流程\"></p>\n<h3 id=\"时序图\"><a href=\"#时序图\" class=\"headerlink\" title=\"时序图\"></a>时序图</h3><p><img src=\"https://leo-doc-img.oss-cn-hangzhou.aliyuncs.com/doc-img/Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png?x-oss-process=style/doc-img\" alt=\"Android启动流程\"></p>\n"},{"title":"Android消息机制-Handler","date":"2018-03-23T12:29:21.000Z","_content":"\n### 参考\n\n[Android消息机制1-Handler(Java层)](http://gityuan.com/2015/12/26/handler-message-framework/)\n\n[Android消息机制2-Handler(Native层)](http://gityuan.com/2015/12/27/handler-message-native/)\n\n[Android应用程序消息处理机制（Looper、Handler）分析](http://blog.csdn.net/luoshengyang/article/details/6817933)\n\n[管道(Unix)](https://zh.wikipedia.org/wiki/%E7%AE%A1%E9%81%93_(Unix))\n\n[Epoll](https://zh.wikipedia.org/zh-hans/Epoll)\n\n[文件描述符](https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6)\n\nHandler 机制主要由四个部分组成：\n\n* Looper\n* MessageQueue\n* Message\n* Handler\n\n### 典型用法\n\n``` java\nclass LooperThread extends Thread {\n    public Handler mHandler;\n    \n    public void run() {\n        Looper.prepare();\n        \n        mHandler = new Handler() {\n            public void handleMessage(Message msg) {\n                // process incoming messages here\n            }\n        };\n        \n        Looper.loop();\n    }\n}\n```\n\n### Looper\n\n不断循环执行 `Looper.loop`，按分发机制将消息分发给目标处理者\n\n``` java\nprivate static void prepare(boolean quitAllowed) {\n    if(sThreadLocal.get() != null) {\n        throw new RuntimeException(\"Only one Looper may be created per thread\");\n    }\n    // 构建 Looper 存储到 ThreadLocal\n    sThreadLocal.set(new Looper(quitAllowed));\n}\n```\n\n`sThreadLocal` 是一个 ThreadLocal 类型的静态变量\n\n> ThreadLocal：线程本地存储区（Thread Local Storage），每个线程都有自己的私有的本地存储区域，不同线程之间彼此不能访问对方的 TLS 区域\n\n``` java\nprivate Looper(boolean quitAllowed) {\n    // Looper 中创建 MessageQueue\n    mQueue = new MessageQueue(quitAllowed);\n    mThread = Thread.currentThread();\n}\n```\n\n``` java\npublic static void loop() {                                                                     \n    final Looper me = myLooper();                                                               \n    if (me == null) {                                                                           \n        throw new RuntimeException(\"No Looper; Looper.prepare() wasn't called on this thread.\");\n    }                                                                                           \n    final MessageQueue queue = me.mQueue;                                                       \n                                                                                                \n    // Make sure the identity of this thread is that of the local process,                      \n    // and keep track of what that identity token actually is.                                  \n    Binder.clearCallingIdentity();                                                              \n    final long ident = Binder.clearCallingIdentity();                                           \n                                                                                                \n    for (;;) {                                                                                  \n        Message msg = queue.next(); // 获取下一条 Message，可能会阻塞                                              \n        if (msg == null) {                                                                      \n            // No message indicates that the message queue is quitting.                         \n            return;                                                                             \n        }                                                                                       \n                                                                                                \n        // This must be in a local variable, in case a UI event sets the logger                 \n        final Printer logging = me.mLogging;                                                    \n        if (logging != null) {                                                                  \n            logging.println(\">>>>> Dispatching to \" + msg.target + \" \" +                        \n                    msg.callback + \": \" + msg.what);                                            \n        }                                                                                       \n                                                                                                \n        final long slowDispatchThresholdMs = me.mSlowDispatchThresholdMs;                       \n                                                                                                \n        //省略\n        \n        final long start = (slowDispatchThresholdMs == 0) ? 0 : SystemClock.uptimeMillis();     \n        final long end;                                                                         \n        try {\n            // 分发 Message\n            msg.target.dispatchMessage(msg);                                                    \n            end = (slowDispatchThresholdMs == 0) ? 0 : SystemClock.uptimeMillis();              \n        } finally {                                                                             \n            if (traceTag != 0) {                                                                \n                Trace.traceEnd(traceTag);                                                       \n            }                                                                                   \n        }                                                                                       \n        if (slowDispatchThresholdMs > 0) {                                                      \n            final long time = end - start;                                                      \n            if (time > slowDispatchThresholdMs) {                                               \n                Slog.w(TAG, \"Dispatch took \" + time + \"ms on \"                                  \n                        + Thread.currentThread().getName() + \", h=\" +                           \n                        msg.target + \" cb=\" + msg.callback + \" msg=\" + msg.what);               \n            }                                                                                   \n        }                                                                                       \n                                                                                                \n        if (logging != null) {                                                                  \n            logging.println(\"<<<<< Finished to \" + msg.target + \" \" + msg.callback);            \n        }                                                                                       \n                                                                                                \n        // Make sure that during the course of dispatching the                                  \n        // identity of the thread wasn't corrupted.                                             \n        final long newIdent = Binder.clearCallingIdentity();                                    \n        if (ident != newIdent) {                                                                \n            Log.wtf(TAG, \"Thread identity changed from 0x\"                                      \n                    + Long.toHexString(ident) + \" to 0x\"                                        \n                    + Long.toHexString(newIdent) + \" while dispatching to \"                     \n                    + msg.target.getClass().getName() + \" \"                                     \n                    + msg.callback + \" what=\" + msg.what);                                      \n        }                                                                                       \n         \n        // 释放 Message\n        msg.recycleUnchecked();                                                                 \n    }                                                                                           \n}                                                                                               \n```\n\n``` java\n// Looper.quit 最终调用的都是 MessageQueue.quit\npublic void quit() {\n    mQueue.quit(false); // 移除消息\n}\n\npublic void quitSafely() {\n    mQueue.quit(true); // 安全移除消息\n}\n```\n\nMessageQueue 在构造方法中，会调用 native 方法 `nativeInit` 方法，在 NativeMessageQueue 的构造方法中，会构造一个 JNI 层的 Looper\n\n``` cpp\n// frameworks/base/libs\nLooper::Looper(bool allowNonCallbacks) :  \n    mAllowNonCallbacks(allowNonCallbacks),  \n    mResponseIndex(0) {\n    // 管道机制\n    int wakeFds[2];  \n    int result = pipe(wakeFds);  \n    ......  \n  \n    mWakeReadPipeFd = wakeFds[0];  \n    mWakeWritePipeFd = wakeFds[1];  \n  \t\n    ......  \n  \n#ifdef LOOPER_USES_EPOLL  \n    // 分配新的 epoll 实例同时注册唤醒管道\n    mEpollFd = epoll_create(EPOLL_SIZE_HINT);  \n    ......  \n  \n    struct epoll_event eventItem;  \n    memset(& eventItem, 0, sizeof(epoll_event)); // zero out unused members of data field union\n    // 观察 EPOLLIN 事件\n    eventItem.events = EPOLLIN;  \n    eventItem.data.fd = mWakeReadPipeFd;  \n    result = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, mWakeReadPipeFd, & eventItem);  \n    ......  \n#else  \n    ......  \n#endif  \n  \n    ......  \n}  \n```\n\n> 管道：Linux 系统中的一种进程间通信机制。简单来说，管道就是一个文件，在管道的两端，分别是两个打开文件的文件描述符，这两个打开文件描述符都是对应同一个文件，其中一个是用来读的，别一个是用来写的，一般的使用方式就是，一个线程通过读文件描述符中来读管道的内容，当管道没有内容时，这个线程就会进入等待状态，而另外一个线程通过写文件描述符来向管道中写入内容，写入内容的时候，如果另一端正有线程正在等待管道中的内容，那么这个线程就会被唤醒。\n>\n> epoll：Linux 系统中的 epoll 机制为处理大批量句柄而作了改进的 poll，是 Linux 下多路复用 IO 接口select/poll 的增强版本，它能显著减少程序在大量并发连接中只有少量活跃的情况下的系统 CPU 利用率。\n\npipe 是 Linux 系统中的管道机制，用于 IPC，在管道机制的实现中，又使用 epoll 机制来监听读写事件。\n\n以上在 Android 上的应用为，当 Java 层的消息队列中没有消息时，就使 Android 应用程序主线程进入等待状态，而当 Java 层的消息队列中来了新的消息后，就唤醒 Android 应用程序的主线程来处理这个消息。\n\n### Handler\n\n``` java\npublic Handler(Callback callback, boolean async) {                                                  \n    if (FIND_POTENTIAL_LEAKS) {                                                                     \n        final Class<? extends Handler> klass = getClass();                                          \n        if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &&          \n                (klass.getModifiers() & Modifier.STATIC) == 0) {\n            // 匿名类、内部类或本地类都必须申明为 static，否则会警告出现内存泄漏\n            Log.w(TAG, \"The following Handler class should be static or leaks might occur: \" +      \n                klass.getCanonicalName());                                                          \n        }                                                                                           \n    }                                                                                               \n    // 默认使用当前线程的 Looper                                                                                                \n    mLooper = Looper.myLooper();                                                                    \n    if (mLooper == null) {                                                                          \n        throw new RuntimeException(                                                                 \n            \"Can't create handler inside thread that has not called Looper.prepare()\");             \n    }                                                                                               \n    mQueue = mLooper.mQueue;                                                                        \n    mCallback = callback;\n    // 是否为异步处理\n    mAsynchronous = async;                                                                          \n}                                                                                                   \n```\n\n在 `Looper.loop` 中，当存在 Message 需要处理时，会调用 `dispatchMessage` 来进行分发：\n\n``` java\npublic void dispatchMessage(Message msg) {      \n    if (msg.callback != null) {\n        // 先调用 callback\n        handleCallback(msg);                    \n    } else {                                    \n        if (mCallback != null) {\n            // 接着检查通过构造方法传进来的 Callback\n            if (mCallback.handleMessage(msg)) { \n                return;                         \n            }                                   \n        }\n        // 最后调用 handleMessage\n        handleMessage(msg);                     \n    }                                           \n}                                               \n```\n\n通过 Handler 发送消息：\n\n![发送消息调用链](http://gityuan.com/images/handler/java_sendmessage.png)\n\n最终所有的方法都会调用到 `MessageQueue.enqueueMessage`\n\n### MessageQueue\n\n> 消息机制中 Java 层和 C++ 层的连接纽带，大部分核心方法都交给 native 层来处理\n\n``` java\nMessageQueue(boolean quitAllowed) { \n    mQuitAllowed = quitAllowed;\n    // used by native code\n    mPtr = nativeInit();            \n}                                   \n```\n\nMessageQueue 的初始化工作主要由 native 方法来执行\n\n``` cpp\n//frameworks/base/core/jni/android_os_MessageQueue.cpp\nstatic void android_os_MessageQueue_nativeInit(JNIEnv* env, jobject obj) {\n    // 构建一个 NativeMessageQueue，在它的构造方法中，也会创建一个 Looper，不过这个 Looper 对象实现是在 JNI 层\n    NativeMessageQueue* nativeMessageQueue = new NativeMessageQueue();  \n    if (! nativeMessageQueue) {  \n        jniThrowRuntimeException(env, \"Unable to allocate native queue\");  \n        return;  \n    }  \n  \t\n    // 在这里，会 NativeMessageQueue 保存到 Java 层 MessageQueue 的 mPtr 变量中，这里保存的是一个偏移量\n    android_os_MessageQueue_setNativeMessageQueue(env, obj, nativeMessageQueue);  \n}  \n```\n\n`nativeInit` 中主要是在 JNI 层创建一个 NativeMessageQueue 并将偏移量保存在 MessageQueue 中的 `mPtr`，关联了 NativeMessageQueue 和 MessageQueue\n\n``` java\nMessage next() {                                                                              \n    // messsage loop has already quit                                                              \n    final long ptr = mPtr;                                                                    \n    if (ptr == 0) {                                                                           \n        return null;                                                                          \n    }                                                                                         \n                                                                                              \n    int pendingIdleHandlerCount = -1; // -1 only during first iteration                       \n    int nextPollTimeoutMillis = 0;                                                            \n    for (;;) {                                                                                \n        if (nextPollTimeoutMillis != 0) {                                                     \n            Binder.flushPendingCommands();                                                    \n        }                                                                                     \n        // 阻塞操作，当等待nextPollTimeoutMillis时长，或者消息队列被唤醒，都会返回\n        // ptr 是在 JNI 层创建的 NativeMessageQueue\n        nativePollOnce(ptr, nextPollTimeoutMillis);                                           \n        \n        // 当前 nativePollOnce 返回后，查看消息队列中是否存在消息\n        synchronized (this) {                                                                 \n            // 尝试检索下一条消息，如果找到则返回                            \n            final long now = SystemClock.uptimeMillis();                                      \n            Message prevMsg = null;                                                           \n            Message msg = mMessages;                                                          \n            if (msg != null && msg.target == null) {                                          \n                // 找到下一条异步消息或者没有消息了，则退出循环\n                do {                                                                          \n                    prevMsg = msg;                                                            \n                    msg = msg.next;                                                           \n                } while (msg != null && !msg.isAsynchronous());                               \n            }                                                                                 \n            if (msg != null) {                                                                \n                if (now < msg.when) {                                                         \n                    // 下一个消息还没准备好，重新设置唤醒超时时间\n                    nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);\n                } else {                                                                      \n                    // 获取一条消息                                                         \n                    mBlocked = false;\n                    if (prevMsg != null) {                                                    \n                        prevMsg.next = msg.next;                                              \n                    } else {                                                                  \n                        mMessages = msg.next;                                                 \n                    }                                                                         \n                    msg.next = null;                                                          \n                    if (DEBUG) Log.v(TAG, \"Returning message: \" + msg);\n                    // 标记当前消息已使用\n                    msg.markInUse();                                                          \n                    return msg;                                                               \n                }                                                                             \n            } else {                                                                          \n                // 当前还没有消息，设置为 -1，无限等待中                                                     \n                nextPollTimeoutMillis = -1;                                                   \n            }                                                                                 \n                                                                                              \n            // Process the quit message now that all pending messages have been handled.      \n            if (mQuitting) {                                                                  \n                dispose();                                                                    \n                return null;                                                                  \n            }                                                                                 \n                                                                                              \n            // queue is empty or if the first message\n            // get pending idle handler count\n            if (pendingIdleHandlerCount < 0                                                   \n                    && (mMessages == null || now < mMessages.when)) {                         \n                pendingIdleHandlerCount = mIdleHandlers.size();                               \n            }                                                                                 \n            if (pendingIdleHandlerCount <= 0) {                                               \n                // 没有 idle handlers 需要运行，循环继续等待                        \n                mBlocked = true;                                                              \n                continue;                                                                     \n            }                                                                                 \n                                                                                              \n            if (mPendingIdleHandlers == null) {                                               \n                mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)]; \n            }                                                                                 \n            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);               \n        }                                                                                     \n                                                                                              \n        // Run the idle handlers.                                                        \n        // We only ever reach this code block during the first iteration                    \n        for (int i = 0; i < pendingIdleHandlerCount; i++) {                                   \n            final IdleHandler idler = mPendingIdleHandlers[i];                                \n            mPendingIdleHandlers[i] = null;           \n                                                                                              \n            boolean keep = false;                                                             \n            try {                                                                             \n                keep = idler.queueIdle();                                                     \n            } catch (Throwable t) {                                                           \n                Log.wtf(TAG, \"IdleHandler threw exception\", t);                               \n            }                                                                                 \n                                                                                              \n            if (!keep) {                                                                      \n                synchronized (this) {\n                    mIdleHandlers.remove(idler);                                              \n                }                                                                             \n            }                                                                                 \n        }                                                                                     \n                                                                                              \n        // Reset the idle handler count to 0 so we do not run them again.                     \n        pendingIdleHandlerCount = 0;                                                          \n                                                                                              \n        //不设置超时时间,因为可能在处理 IdleHandler 时可能有新的消息加入                \n        nextPollTimeoutMillis = 0;                                                            \n    }                                                                                         \n}                                                                                             \n```\n\n在 `next` 方法中，`nativePollOnce` 是阻塞操作，其中 `nextPollTimeoutMillis` 代表下一个消息到来之前，还需要等待的时长；`nextPollTimeoutMillis == -1` 表示当前没有更多消息。`nativePollOnce` 调用结束后，从 `mMessages` 中提取一个消息\n\n当处于空闲时，执行 `IdleHandler` 中的回调方法。\n\n``` cpp\n// frameworks/base/core/jni/android_os_MessageQueue.cpp\nstatic void android_os_MessageQueue_nativePollOnce(JNIEnv* env, jobject obj,  \n        jint ptr, jint timeoutMillis) {\n    // 通过前面设置的 mPrt 获取 NativeMessageQueue\n    NativeMessageQueue* nativeMessageQueue = reinterpret_cast<NativeMessageQueue*>(ptr); \n    // 调用 NativeMessageQueue.pollOnce 进行轮询\n    nativeMessageQueue->pollOnce(timeoutMillis);  \n}  \n```\n\n``` cpp\nvoid NativeMessageQueue::pollOnce(int timeoutMillis) {\n    // 将调用转发给了 JNI 层的 Looper\n    mLooper->pollOnce(timeoutMillis);  \n} \n```\n\n`pollOnce` 会调用 `pollnner` 来进一步操作，如果 `pollnner` 返回值不等于 0，则返回\n\n``` cpp\n// frameworks/base/libs/utils/Looper.cpp\nint Looper::pollInner(int timeoutMillis) {  \n    ......  \n  \n    int result = ALOOPER_POLL_WAKE;  \n  \n    ......  \n  \n#ifdef LOOPER_USES_EPOLL  \n    struct epoll_event eventItems[EPOLL_MAX_EVENTS];\n    // 调用 epoll_wait 检查 epoll 专用文件描述符 mEpollFd 所监控的文件描述符是否有 IO 事件,超时时间为 timeoutMillis\n    // 在 JNI 层的 Looper 构造函数中，设置了要监控 mWakeReadPipeFd 文件描述符的 EPOLLIN 事件\n    // 如果检查成功或者超时，则结束等待\n    // 处于 Idle 状态\n    int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);\n    bool acquiredLock = false;  \n#else  \n    ......  \n#endif  \n    \n    // eventCount < 0 可能出错了\n    if (eventCount < 0) {  \n        if (errno == EINTR) {  \n            goto Done;  \n        }  \n  \n        LOGW(\"Poll failed with an unexpected error, errno=%d\", errno);  \n        result = ALOOPER_POLL_ERROR;  \n        goto Done;  \n    }  \n  \t\n    // eventCount == 0 超时\n    if (eventCount == 0) {  \n        ......  \n        result = ALOOPER_POLL_TIMEOUT;  \n        goto Done;  \n    }  \n  \n    ......  \n  \n#ifdef LOOPER_USES_EPOLL\n    // eventCount > 0 存在事件\n    for (int i = 0; i < eventCount; i++) {  \n        int fd = eventItems[i].data.fd;  \n        uint32_t epollEvents = eventItems[i].events;  \n        if (fd == mWakeReadPipeFd) {  \n            if (epollEvents & EPOLLIN) {\n                // Looper 中使用 epoll 监听的 EPOLLIN 事件\n                awoken();  \n            } else {  \n                LOGW(\"Ignoring unexpected epoll events 0x%x on wake read pipe.\", epollEvents);  \n            }  \n        } else {  \n            ......  \n        }  \n    }  \n    if (acquiredLock) {  \n        mLock.unlock();  \n    }  \nDone: ;  \n#else  \n    ......  \n#endif  \n  \n    ......  \n  \n    return result;  \n} \n```\n\n``` cpp\nvoid Looper::awoken() {  \n    ......  \n  \n    char buffer[16];  \n    ssize_t nRead;  \n    do {  \n        nRead = read(mWakeReadPipeFd, buffer, sizeof(buffer));  \n    } while ((nRead == -1 && errno == EINTR) || nRead == sizeof(buffer));  \n}  \n```\n\n总结上面的代码，Looper 通过 `loop` 调用 MessageQueue 的 `next`，`next` 中又会调用到 native 方法 `nativePollOnce`，在这个方法中，会调用到 NativeMessageQueue 的 `pollInner`，这里会通过在 JNI 层 Looper 的构造方法中，使用 epoll 监听管道 EPOLLIN 事件，如果存在调用 `awoken`，清空管道中的内容，以便下次再调用pollInner函数时，知道自从上次处理完消息队列中的消息后，有没有新的消息加进来。\n\n``` java\nboolean enqueueMessage(Message msg, long when) {                                         \n    if (msg.target == null) {                                                            \n        throw new IllegalArgumentException(\"Message must have a target.\");               \n    }                                                                                    \n    if (msg.isInUse()) {                                                                 \n        throw new IllegalStateException(msg + \" This message is already in use.\");       \n    }                                                                                    \n                                                                                         \n    synchronized (this) {                                                                \n        if (mQuitting) {                                                                 \n            IllegalStateException e = new IllegalStateException(                         \n                    msg.target + \" sending message to a Handler on a dead thread\");      \n            Log.w(TAG, e.getMessage(), e);                                               \n            msg.recycle();                                                               \n            return false;                                                                \n        }                                                                                \n                                                                                         \n        msg.markInUse();                                                                 \n        msg.when = when;                                                                 \n        Message p = mMessages;                                                           \n        boolean needWake;                                                                \n        if (p == null || when == 0 || when < p.when) {                                   \n            // 不存在头部消息或立即执行或执行时机快于头部消息\n            // 将处理的消息作为新的头部消息\n            msg.next = p;                                                                \n            mMessages = msg;                                                             \n            needWake = mBlocked;                                                         \n        } else {                                                                         \n            // 将处理的消息插入到队列的尾部\n            // 一般不需要唤醒事件队列，除非消息头存在 barrier，并且当前处理的消息是队列中最早的异步消息\n            needWake = mBlocked && p.target == null && msg.isAsynchronous();             \n            Message prev;                                                                \n            for (;;) {                                                                   \n                prev = p;                                                                \n                p = p.next;                                                              \n                if (p == null || when < p.when) {                                        \n                    break;                                                               \n                }                                                                        \n                if (needWake && p.isAsynchronous()) {                                    \n                    needWake = false;                                                    \n                }                                                                        \n            }                                                                            \n            msg.next = p; // invariant: p == prev.next                                   \n            prev.next = msg;                                                             \n        }                                                                                \n                                                                                         \n        // We can assume mPtr != 0 because mQuitting is false.                           \n        if (needWake) {                                                                  \n            nativeWake(mPtr);                                                            \n        }                                                                                \n    }                                                                                    \n    return true;                                                                         \n}                                                                                        \n```\n\n`MessageQueue` 是按照消息触发时间的先后顺序排列的，队列头部的消息是最早触发的。当有消息加入，会从队列头部开始遍历，插入到合适的位置，以保证所有消息的时间顺序。\n\n如果当前线程处于空闲等待状态，那么还需要调用 `nativeWake` 来唤醒：\n\n``` cpp\n// frameworks/base/core/jni/android_os_MessageQueue.cpp\nstatic void android_os_MessageQueue_nativeWake(JNIEnv* env, jobject obj, jint ptr) {\n    // ptr 获取 NativeMessageQueue\n    NativeMessageQueue* nativeMessageQueue = reinterpret_cast<NativeMessageQueue*>(ptr);  \n    return nativeMessageQueue->wake();  \n}  \n```\n\n这里将唤醒请求转发到 Looper `wake`：\n\n``` cpp\n// frameworks/base/libs/utils/Looper.cpp\nvoid Looper::wake() {  \n    ......  \n  \n    ssize_t nWrite;  \n    do {\n        // 先管道中写入 \"W\n        nWrite = write(mWakeWritePipeFd, \"W\", 1);  \n    } while (nWrite == -1 && errno == EINTR);  \n  \n    .......  \n}  \n```\n\n往管道写入内容，从而唤醒线程，因为当消息队列中没有消息处理时，线程会进入空闲等待状态，具体是通过 Looper 的 `polllnner` 中调用 `epoll_wait` 进入\n\n``` java\nvoid removeMessages(Handler h, int what, Object object) {     \n    if (h == null) {                                          \n        return;                                               \n    }                                                         \n                                                              \n    synchronized (this) {                                     \n        Message p = mMessages;                                \n                                                              \n        // 从队列头部开始，移除连续的所有符合条件的消息                     \n        while (p != null && p.target == h && p.what == what   \n               && (object == null || p.obj == object)) {      \n            Message n = p.next;                               \n            mMessages = n;\n            // 找到对应的消息，释放它\n            p.recycleUnchecked();                             \n            p = n;                                            \n        }                                                     \n                                                              \n        //  从新的队列头部开始，移除全部符合条件的消息                  \n        while (p != null) {                                   \n            Message n = p.next;                               \n            if (n != null) {                                  \n                if (n.target == h && n.what == what           \n                    && (object == null || n.obj == object)) { \n                    Message nn = n.next;                      \n                    n.recycleUnchecked();                     \n                    p.next = nn;                              \n                    continue;                                 \n                }                                             \n            }                                                 \n            p = n;                                            \n        }                                                     \n    }                                                         \n}                                                             \n```\n\n`postSyncBarrier` 提交一个同步屏障，这将会阻止队列中消息的执行，直到手动调用 `removeSyncBarrier`\n\n当 MessageQueue 退出时，需要 `dispose`：\n\n``` java\n// Disposes of the underlying message queue.                 \n// Must only be called on the looper thread or the finalizer.\nprivate void dispose() {                                     \n    if (mPtr != 0) {\n        // native 方法\n        nativeDestroy(mPtr);\n        // mPtr 是记录 JNI 层的 NativeMessageQueue 的偏移量\n        mPtr = 0;                                            \n    }                                                        \n}                                                            \n```\n\n`nativeDestroy` 最终会调用 RefBase 的 `decStrong`：\n\n``` cpp\nvoid RefBase::decStrong(const void* id) const\n{\n    weakref_impl* const refs = mRefs;\n    refs->removeStrongRef(id); //移除强引用\n    const int32_t c = android_atomic_dec(&refs->mStrong);\n    if (c == 1) {\n        refs->mBase->onLastStrongRef(id);\n        if ((refs->mFlags&OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) {\n            delete this;\n        }\n    }\n    refs->decWeak(id); // 移除弱引用\n}\n```\n\n### Message\n\n``` java\nvoid recycleUnchecked() {                 \n    // 标记为使用状态，清除其他状态     \n    flags = FLAG_IN_USE;                  \n    what = 0;                             \n    arg1 = 0;                             \n    arg2 = 0;                             \n    obj = null;                           \n    replyTo = null;                       \n    sendingUid = -1;                      \n    when = 0;                             \n    target = null;                        \n    callback = null;                      \n    data = null;                          \n                                          \n    synchronized (sPoolSync) {\n        // 消息缓存\n        if (sPoolSize < MAX_POOL_SIZE) {  \n            next = sPool;                 \n            sPool = this;                 \n            sPoolSize++;                  \n        }                                 \n    }                                     \n}                                         \n```\n\n``` java\npublic static Message obtain() {             \n    synchronized (sPoolSync) {               \n        if (sPool != null) {\n            // 从缓存中获取\n            Message m = sPool;               \n            sPool = m.next;                  \n            m.next = null;                   \n            m.flags = 0; // clear in-use flag\n            sPoolSize--;                     \n            return m;                        \n        }                                    \n    }                                        \n    return new Message();                    \n}                                            \n```\n\n### 总结\n\n![消息机制](http://gityuan.com/images/handler/handler_java.jpg)\n\nJava 层：\n\n* Handler 通过 `sendMessage`，将 Message 通过 `MessageQueue.enqueueMessage` 添加到队列中\n* Looper 通过 `loop` 提取需要执行的 Message，并交与 `Message.target` 的 Handler 进行 `dispatchMessage` 分发\n*  将 Message 添加到 MessageQueue 时，会唤醒 Looper 线程；如果 MessageQueue 中没有 Message 时，并处于 Idle 状态，则会执行 IdelHandler \n\nJNI 层：\n\n* 线程在进入循环之前，会在 JNI 创建管道(Pipe) ，当消息队列为空时，线程处于空闲等待状态\n* 通过 epoll 机制监听 `EPOLLIN` 事件，当有新事件进入消息队列时，并且当前线程处于空闲状态，通过向管道写入数据，来唤醒线程\n\n消息分发的优先级：\n\n1. `Message.callback.run()`\n2. `Handler.mCallback.handleMessage()`\n3. `Handler.handleMessage()`\n\n> EPOLL：Linux 内核的可扩展 I/O 事件通知机制\n>\n> PIPE：管道是一系列将标准输入输出链接起来的进程，其中每个进程的输出被直接作为下一个进程的输入\n>\n> 文件描述符(File descriptor)：用于表述指向[文件](https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6)的引用的抽象化概念","source":"_posts/Android消息机制-Handler.md","raw":"---\ntitle: Android消息机制-Handler\ndate: 2018-03-23 20:29:21\ncategories: Android\n---\n\n### 参考\n\n[Android消息机制1-Handler(Java层)](http://gityuan.com/2015/12/26/handler-message-framework/)\n\n[Android消息机制2-Handler(Native层)](http://gityuan.com/2015/12/27/handler-message-native/)\n\n[Android应用程序消息处理机制（Looper、Handler）分析](http://blog.csdn.net/luoshengyang/article/details/6817933)\n\n[管道(Unix)](https://zh.wikipedia.org/wiki/%E7%AE%A1%E9%81%93_(Unix))\n\n[Epoll](https://zh.wikipedia.org/zh-hans/Epoll)\n\n[文件描述符](https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6)\n\nHandler 机制主要由四个部分组成：\n\n* Looper\n* MessageQueue\n* Message\n* Handler\n\n### 典型用法\n\n``` java\nclass LooperThread extends Thread {\n    public Handler mHandler;\n    \n    public void run() {\n        Looper.prepare();\n        \n        mHandler = new Handler() {\n            public void handleMessage(Message msg) {\n                // process incoming messages here\n            }\n        };\n        \n        Looper.loop();\n    }\n}\n```\n\n### Looper\n\n不断循环执行 `Looper.loop`，按分发机制将消息分发给目标处理者\n\n``` java\nprivate static void prepare(boolean quitAllowed) {\n    if(sThreadLocal.get() != null) {\n        throw new RuntimeException(\"Only one Looper may be created per thread\");\n    }\n    // 构建 Looper 存储到 ThreadLocal\n    sThreadLocal.set(new Looper(quitAllowed));\n}\n```\n\n`sThreadLocal` 是一个 ThreadLocal 类型的静态变量\n\n> ThreadLocal：线程本地存储区（Thread Local Storage），每个线程都有自己的私有的本地存储区域，不同线程之间彼此不能访问对方的 TLS 区域\n\n``` java\nprivate Looper(boolean quitAllowed) {\n    // Looper 中创建 MessageQueue\n    mQueue = new MessageQueue(quitAllowed);\n    mThread = Thread.currentThread();\n}\n```\n\n``` java\npublic static void loop() {                                                                     \n    final Looper me = myLooper();                                                               \n    if (me == null) {                                                                           \n        throw new RuntimeException(\"No Looper; Looper.prepare() wasn't called on this thread.\");\n    }                                                                                           \n    final MessageQueue queue = me.mQueue;                                                       \n                                                                                                \n    // Make sure the identity of this thread is that of the local process,                      \n    // and keep track of what that identity token actually is.                                  \n    Binder.clearCallingIdentity();                                                              \n    final long ident = Binder.clearCallingIdentity();                                           \n                                                                                                \n    for (;;) {                                                                                  \n        Message msg = queue.next(); // 获取下一条 Message，可能会阻塞                                              \n        if (msg == null) {                                                                      \n            // No message indicates that the message queue is quitting.                         \n            return;                                                                             \n        }                                                                                       \n                                                                                                \n        // This must be in a local variable, in case a UI event sets the logger                 \n        final Printer logging = me.mLogging;                                                    \n        if (logging != null) {                                                                  \n            logging.println(\">>>>> Dispatching to \" + msg.target + \" \" +                        \n                    msg.callback + \": \" + msg.what);                                            \n        }                                                                                       \n                                                                                                \n        final long slowDispatchThresholdMs = me.mSlowDispatchThresholdMs;                       \n                                                                                                \n        //省略\n        \n        final long start = (slowDispatchThresholdMs == 0) ? 0 : SystemClock.uptimeMillis();     \n        final long end;                                                                         \n        try {\n            // 分发 Message\n            msg.target.dispatchMessage(msg);                                                    \n            end = (slowDispatchThresholdMs == 0) ? 0 : SystemClock.uptimeMillis();              \n        } finally {                                                                             \n            if (traceTag != 0) {                                                                \n                Trace.traceEnd(traceTag);                                                       \n            }                                                                                   \n        }                                                                                       \n        if (slowDispatchThresholdMs > 0) {                                                      \n            final long time = end - start;                                                      \n            if (time > slowDispatchThresholdMs) {                                               \n                Slog.w(TAG, \"Dispatch took \" + time + \"ms on \"                                  \n                        + Thread.currentThread().getName() + \", h=\" +                           \n                        msg.target + \" cb=\" + msg.callback + \" msg=\" + msg.what);               \n            }                                                                                   \n        }                                                                                       \n                                                                                                \n        if (logging != null) {                                                                  \n            logging.println(\"<<<<< Finished to \" + msg.target + \" \" + msg.callback);            \n        }                                                                                       \n                                                                                                \n        // Make sure that during the course of dispatching the                                  \n        // identity of the thread wasn't corrupted.                                             \n        final long newIdent = Binder.clearCallingIdentity();                                    \n        if (ident != newIdent) {                                                                \n            Log.wtf(TAG, \"Thread identity changed from 0x\"                                      \n                    + Long.toHexString(ident) + \" to 0x\"                                        \n                    + Long.toHexString(newIdent) + \" while dispatching to \"                     \n                    + msg.target.getClass().getName() + \" \"                                     \n                    + msg.callback + \" what=\" + msg.what);                                      \n        }                                                                                       \n         \n        // 释放 Message\n        msg.recycleUnchecked();                                                                 \n    }                                                                                           \n}                                                                                               \n```\n\n``` java\n// Looper.quit 最终调用的都是 MessageQueue.quit\npublic void quit() {\n    mQueue.quit(false); // 移除消息\n}\n\npublic void quitSafely() {\n    mQueue.quit(true); // 安全移除消息\n}\n```\n\nMessageQueue 在构造方法中，会调用 native 方法 `nativeInit` 方法，在 NativeMessageQueue 的构造方法中，会构造一个 JNI 层的 Looper\n\n``` cpp\n// frameworks/base/libs\nLooper::Looper(bool allowNonCallbacks) :  \n    mAllowNonCallbacks(allowNonCallbacks),  \n    mResponseIndex(0) {\n    // 管道机制\n    int wakeFds[2];  \n    int result = pipe(wakeFds);  \n    ......  \n  \n    mWakeReadPipeFd = wakeFds[0];  \n    mWakeWritePipeFd = wakeFds[1];  \n  \t\n    ......  \n  \n#ifdef LOOPER_USES_EPOLL  \n    // 分配新的 epoll 实例同时注册唤醒管道\n    mEpollFd = epoll_create(EPOLL_SIZE_HINT);  \n    ......  \n  \n    struct epoll_event eventItem;  \n    memset(& eventItem, 0, sizeof(epoll_event)); // zero out unused members of data field union\n    // 观察 EPOLLIN 事件\n    eventItem.events = EPOLLIN;  \n    eventItem.data.fd = mWakeReadPipeFd;  \n    result = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, mWakeReadPipeFd, & eventItem);  \n    ......  \n#else  \n    ......  \n#endif  \n  \n    ......  \n}  \n```\n\n> 管道：Linux 系统中的一种进程间通信机制。简单来说，管道就是一个文件，在管道的两端，分别是两个打开文件的文件描述符，这两个打开文件描述符都是对应同一个文件，其中一个是用来读的，别一个是用来写的，一般的使用方式就是，一个线程通过读文件描述符中来读管道的内容，当管道没有内容时，这个线程就会进入等待状态，而另外一个线程通过写文件描述符来向管道中写入内容，写入内容的时候，如果另一端正有线程正在等待管道中的内容，那么这个线程就会被唤醒。\n>\n> epoll：Linux 系统中的 epoll 机制为处理大批量句柄而作了改进的 poll，是 Linux 下多路复用 IO 接口select/poll 的增强版本，它能显著减少程序在大量并发连接中只有少量活跃的情况下的系统 CPU 利用率。\n\npipe 是 Linux 系统中的管道机制，用于 IPC，在管道机制的实现中，又使用 epoll 机制来监听读写事件。\n\n以上在 Android 上的应用为，当 Java 层的消息队列中没有消息时，就使 Android 应用程序主线程进入等待状态，而当 Java 层的消息队列中来了新的消息后，就唤醒 Android 应用程序的主线程来处理这个消息。\n\n### Handler\n\n``` java\npublic Handler(Callback callback, boolean async) {                                                  \n    if (FIND_POTENTIAL_LEAKS) {                                                                     \n        final Class<? extends Handler> klass = getClass();                                          \n        if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &&          \n                (klass.getModifiers() & Modifier.STATIC) == 0) {\n            // 匿名类、内部类或本地类都必须申明为 static，否则会警告出现内存泄漏\n            Log.w(TAG, \"The following Handler class should be static or leaks might occur: \" +      \n                klass.getCanonicalName());                                                          \n        }                                                                                           \n    }                                                                                               \n    // 默认使用当前线程的 Looper                                                                                                \n    mLooper = Looper.myLooper();                                                                    \n    if (mLooper == null) {                                                                          \n        throw new RuntimeException(                                                                 \n            \"Can't create handler inside thread that has not called Looper.prepare()\");             \n    }                                                                                               \n    mQueue = mLooper.mQueue;                                                                        \n    mCallback = callback;\n    // 是否为异步处理\n    mAsynchronous = async;                                                                          \n}                                                                                                   \n```\n\n在 `Looper.loop` 中，当存在 Message 需要处理时，会调用 `dispatchMessage` 来进行分发：\n\n``` java\npublic void dispatchMessage(Message msg) {      \n    if (msg.callback != null) {\n        // 先调用 callback\n        handleCallback(msg);                    \n    } else {                                    \n        if (mCallback != null) {\n            // 接着检查通过构造方法传进来的 Callback\n            if (mCallback.handleMessage(msg)) { \n                return;                         \n            }                                   \n        }\n        // 最后调用 handleMessage\n        handleMessage(msg);                     \n    }                                           \n}                                               \n```\n\n通过 Handler 发送消息：\n\n![发送消息调用链](http://gityuan.com/images/handler/java_sendmessage.png)\n\n最终所有的方法都会调用到 `MessageQueue.enqueueMessage`\n\n### MessageQueue\n\n> 消息机制中 Java 层和 C++ 层的连接纽带，大部分核心方法都交给 native 层来处理\n\n``` java\nMessageQueue(boolean quitAllowed) { \n    mQuitAllowed = quitAllowed;\n    // used by native code\n    mPtr = nativeInit();            \n}                                   \n```\n\nMessageQueue 的初始化工作主要由 native 方法来执行\n\n``` cpp\n//frameworks/base/core/jni/android_os_MessageQueue.cpp\nstatic void android_os_MessageQueue_nativeInit(JNIEnv* env, jobject obj) {\n    // 构建一个 NativeMessageQueue，在它的构造方法中，也会创建一个 Looper，不过这个 Looper 对象实现是在 JNI 层\n    NativeMessageQueue* nativeMessageQueue = new NativeMessageQueue();  \n    if (! nativeMessageQueue) {  \n        jniThrowRuntimeException(env, \"Unable to allocate native queue\");  \n        return;  \n    }  \n  \t\n    // 在这里，会 NativeMessageQueue 保存到 Java 层 MessageQueue 的 mPtr 变量中，这里保存的是一个偏移量\n    android_os_MessageQueue_setNativeMessageQueue(env, obj, nativeMessageQueue);  \n}  \n```\n\n`nativeInit` 中主要是在 JNI 层创建一个 NativeMessageQueue 并将偏移量保存在 MessageQueue 中的 `mPtr`，关联了 NativeMessageQueue 和 MessageQueue\n\n``` java\nMessage next() {                                                                              \n    // messsage loop has already quit                                                              \n    final long ptr = mPtr;                                                                    \n    if (ptr == 0) {                                                                           \n        return null;                                                                          \n    }                                                                                         \n                                                                                              \n    int pendingIdleHandlerCount = -1; // -1 only during first iteration                       \n    int nextPollTimeoutMillis = 0;                                                            \n    for (;;) {                                                                                \n        if (nextPollTimeoutMillis != 0) {                                                     \n            Binder.flushPendingCommands();                                                    \n        }                                                                                     \n        // 阻塞操作，当等待nextPollTimeoutMillis时长，或者消息队列被唤醒，都会返回\n        // ptr 是在 JNI 层创建的 NativeMessageQueue\n        nativePollOnce(ptr, nextPollTimeoutMillis);                                           \n        \n        // 当前 nativePollOnce 返回后，查看消息队列中是否存在消息\n        synchronized (this) {                                                                 \n            // 尝试检索下一条消息，如果找到则返回                            \n            final long now = SystemClock.uptimeMillis();                                      \n            Message prevMsg = null;                                                           \n            Message msg = mMessages;                                                          \n            if (msg != null && msg.target == null) {                                          \n                // 找到下一条异步消息或者没有消息了，则退出循环\n                do {                                                                          \n                    prevMsg = msg;                                                            \n                    msg = msg.next;                                                           \n                } while (msg != null && !msg.isAsynchronous());                               \n            }                                                                                 \n            if (msg != null) {                                                                \n                if (now < msg.when) {                                                         \n                    // 下一个消息还没准备好，重新设置唤醒超时时间\n                    nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);\n                } else {                                                                      \n                    // 获取一条消息                                                         \n                    mBlocked = false;\n                    if (prevMsg != null) {                                                    \n                        prevMsg.next = msg.next;                                              \n                    } else {                                                                  \n                        mMessages = msg.next;                                                 \n                    }                                                                         \n                    msg.next = null;                                                          \n                    if (DEBUG) Log.v(TAG, \"Returning message: \" + msg);\n                    // 标记当前消息已使用\n                    msg.markInUse();                                                          \n                    return msg;                                                               \n                }                                                                             \n            } else {                                                                          \n                // 当前还没有消息，设置为 -1，无限等待中                                                     \n                nextPollTimeoutMillis = -1;                                                   \n            }                                                                                 \n                                                                                              \n            // Process the quit message now that all pending messages have been handled.      \n            if (mQuitting) {                                                                  \n                dispose();                                                                    \n                return null;                                                                  \n            }                                                                                 \n                                                                                              \n            // queue is empty or if the first message\n            // get pending idle handler count\n            if (pendingIdleHandlerCount < 0                                                   \n                    && (mMessages == null || now < mMessages.when)) {                         \n                pendingIdleHandlerCount = mIdleHandlers.size();                               \n            }                                                                                 \n            if (pendingIdleHandlerCount <= 0) {                                               \n                // 没有 idle handlers 需要运行，循环继续等待                        \n                mBlocked = true;                                                              \n                continue;                                                                     \n            }                                                                                 \n                                                                                              \n            if (mPendingIdleHandlers == null) {                                               \n                mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)]; \n            }                                                                                 \n            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);               \n        }                                                                                     \n                                                                                              \n        // Run the idle handlers.                                                        \n        // We only ever reach this code block during the first iteration                    \n        for (int i = 0; i < pendingIdleHandlerCount; i++) {                                   \n            final IdleHandler idler = mPendingIdleHandlers[i];                                \n            mPendingIdleHandlers[i] = null;           \n                                                                                              \n            boolean keep = false;                                                             \n            try {                                                                             \n                keep = idler.queueIdle();                                                     \n            } catch (Throwable t) {                                                           \n                Log.wtf(TAG, \"IdleHandler threw exception\", t);                               \n            }                                                                                 \n                                                                                              \n            if (!keep) {                                                                      \n                synchronized (this) {\n                    mIdleHandlers.remove(idler);                                              \n                }                                                                             \n            }                                                                                 \n        }                                                                                     \n                                                                                              \n        // Reset the idle handler count to 0 so we do not run them again.                     \n        pendingIdleHandlerCount = 0;                                                          \n                                                                                              \n        //不设置超时时间,因为可能在处理 IdleHandler 时可能有新的消息加入                \n        nextPollTimeoutMillis = 0;                                                            \n    }                                                                                         \n}                                                                                             \n```\n\n在 `next` 方法中，`nativePollOnce` 是阻塞操作，其中 `nextPollTimeoutMillis` 代表下一个消息到来之前，还需要等待的时长；`nextPollTimeoutMillis == -1` 表示当前没有更多消息。`nativePollOnce` 调用结束后，从 `mMessages` 中提取一个消息\n\n当处于空闲时，执行 `IdleHandler` 中的回调方法。\n\n``` cpp\n// frameworks/base/core/jni/android_os_MessageQueue.cpp\nstatic void android_os_MessageQueue_nativePollOnce(JNIEnv* env, jobject obj,  \n        jint ptr, jint timeoutMillis) {\n    // 通过前面设置的 mPrt 获取 NativeMessageQueue\n    NativeMessageQueue* nativeMessageQueue = reinterpret_cast<NativeMessageQueue*>(ptr); \n    // 调用 NativeMessageQueue.pollOnce 进行轮询\n    nativeMessageQueue->pollOnce(timeoutMillis);  \n}  \n```\n\n``` cpp\nvoid NativeMessageQueue::pollOnce(int timeoutMillis) {\n    // 将调用转发给了 JNI 层的 Looper\n    mLooper->pollOnce(timeoutMillis);  \n} \n```\n\n`pollOnce` 会调用 `pollnner` 来进一步操作，如果 `pollnner` 返回值不等于 0，则返回\n\n``` cpp\n// frameworks/base/libs/utils/Looper.cpp\nint Looper::pollInner(int timeoutMillis) {  \n    ......  \n  \n    int result = ALOOPER_POLL_WAKE;  \n  \n    ......  \n  \n#ifdef LOOPER_USES_EPOLL  \n    struct epoll_event eventItems[EPOLL_MAX_EVENTS];\n    // 调用 epoll_wait 检查 epoll 专用文件描述符 mEpollFd 所监控的文件描述符是否有 IO 事件,超时时间为 timeoutMillis\n    // 在 JNI 层的 Looper 构造函数中，设置了要监控 mWakeReadPipeFd 文件描述符的 EPOLLIN 事件\n    // 如果检查成功或者超时，则结束等待\n    // 处于 Idle 状态\n    int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);\n    bool acquiredLock = false;  \n#else  \n    ......  \n#endif  \n    \n    // eventCount < 0 可能出错了\n    if (eventCount < 0) {  \n        if (errno == EINTR) {  \n            goto Done;  \n        }  \n  \n        LOGW(\"Poll failed with an unexpected error, errno=%d\", errno);  \n        result = ALOOPER_POLL_ERROR;  \n        goto Done;  \n    }  \n  \t\n    // eventCount == 0 超时\n    if (eventCount == 0) {  \n        ......  \n        result = ALOOPER_POLL_TIMEOUT;  \n        goto Done;  \n    }  \n  \n    ......  \n  \n#ifdef LOOPER_USES_EPOLL\n    // eventCount > 0 存在事件\n    for (int i = 0; i < eventCount; i++) {  \n        int fd = eventItems[i].data.fd;  \n        uint32_t epollEvents = eventItems[i].events;  \n        if (fd == mWakeReadPipeFd) {  \n            if (epollEvents & EPOLLIN) {\n                // Looper 中使用 epoll 监听的 EPOLLIN 事件\n                awoken();  \n            } else {  \n                LOGW(\"Ignoring unexpected epoll events 0x%x on wake read pipe.\", epollEvents);  \n            }  \n        } else {  \n            ......  \n        }  \n    }  \n    if (acquiredLock) {  \n        mLock.unlock();  \n    }  \nDone: ;  \n#else  \n    ......  \n#endif  \n  \n    ......  \n  \n    return result;  \n} \n```\n\n``` cpp\nvoid Looper::awoken() {  \n    ......  \n  \n    char buffer[16];  \n    ssize_t nRead;  \n    do {  \n        nRead = read(mWakeReadPipeFd, buffer, sizeof(buffer));  \n    } while ((nRead == -1 && errno == EINTR) || nRead == sizeof(buffer));  \n}  \n```\n\n总结上面的代码，Looper 通过 `loop` 调用 MessageQueue 的 `next`，`next` 中又会调用到 native 方法 `nativePollOnce`，在这个方法中，会调用到 NativeMessageQueue 的 `pollInner`，这里会通过在 JNI 层 Looper 的构造方法中，使用 epoll 监听管道 EPOLLIN 事件，如果存在调用 `awoken`，清空管道中的内容，以便下次再调用pollInner函数时，知道自从上次处理完消息队列中的消息后，有没有新的消息加进来。\n\n``` java\nboolean enqueueMessage(Message msg, long when) {                                         \n    if (msg.target == null) {                                                            \n        throw new IllegalArgumentException(\"Message must have a target.\");               \n    }                                                                                    \n    if (msg.isInUse()) {                                                                 \n        throw new IllegalStateException(msg + \" This message is already in use.\");       \n    }                                                                                    \n                                                                                         \n    synchronized (this) {                                                                \n        if (mQuitting) {                                                                 \n            IllegalStateException e = new IllegalStateException(                         \n                    msg.target + \" sending message to a Handler on a dead thread\");      \n            Log.w(TAG, e.getMessage(), e);                                               \n            msg.recycle();                                                               \n            return false;                                                                \n        }                                                                                \n                                                                                         \n        msg.markInUse();                                                                 \n        msg.when = when;                                                                 \n        Message p = mMessages;                                                           \n        boolean needWake;                                                                \n        if (p == null || when == 0 || when < p.when) {                                   \n            // 不存在头部消息或立即执行或执行时机快于头部消息\n            // 将处理的消息作为新的头部消息\n            msg.next = p;                                                                \n            mMessages = msg;                                                             \n            needWake = mBlocked;                                                         \n        } else {                                                                         \n            // 将处理的消息插入到队列的尾部\n            // 一般不需要唤醒事件队列，除非消息头存在 barrier，并且当前处理的消息是队列中最早的异步消息\n            needWake = mBlocked && p.target == null && msg.isAsynchronous();             \n            Message prev;                                                                \n            for (;;) {                                                                   \n                prev = p;                                                                \n                p = p.next;                                                              \n                if (p == null || when < p.when) {                                        \n                    break;                                                               \n                }                                                                        \n                if (needWake && p.isAsynchronous()) {                                    \n                    needWake = false;                                                    \n                }                                                                        \n            }                                                                            \n            msg.next = p; // invariant: p == prev.next                                   \n            prev.next = msg;                                                             \n        }                                                                                \n                                                                                         \n        // We can assume mPtr != 0 because mQuitting is false.                           \n        if (needWake) {                                                                  \n            nativeWake(mPtr);                                                            \n        }                                                                                \n    }                                                                                    \n    return true;                                                                         \n}                                                                                        \n```\n\n`MessageQueue` 是按照消息触发时间的先后顺序排列的，队列头部的消息是最早触发的。当有消息加入，会从队列头部开始遍历，插入到合适的位置，以保证所有消息的时间顺序。\n\n如果当前线程处于空闲等待状态，那么还需要调用 `nativeWake` 来唤醒：\n\n``` cpp\n// frameworks/base/core/jni/android_os_MessageQueue.cpp\nstatic void android_os_MessageQueue_nativeWake(JNIEnv* env, jobject obj, jint ptr) {\n    // ptr 获取 NativeMessageQueue\n    NativeMessageQueue* nativeMessageQueue = reinterpret_cast<NativeMessageQueue*>(ptr);  \n    return nativeMessageQueue->wake();  \n}  \n```\n\n这里将唤醒请求转发到 Looper `wake`：\n\n``` cpp\n// frameworks/base/libs/utils/Looper.cpp\nvoid Looper::wake() {  \n    ......  \n  \n    ssize_t nWrite;  \n    do {\n        // 先管道中写入 \"W\n        nWrite = write(mWakeWritePipeFd, \"W\", 1);  \n    } while (nWrite == -1 && errno == EINTR);  \n  \n    .......  \n}  \n```\n\n往管道写入内容，从而唤醒线程，因为当消息队列中没有消息处理时，线程会进入空闲等待状态，具体是通过 Looper 的 `polllnner` 中调用 `epoll_wait` 进入\n\n``` java\nvoid removeMessages(Handler h, int what, Object object) {     \n    if (h == null) {                                          \n        return;                                               \n    }                                                         \n                                                              \n    synchronized (this) {                                     \n        Message p = mMessages;                                \n                                                              \n        // 从队列头部开始，移除连续的所有符合条件的消息                     \n        while (p != null && p.target == h && p.what == what   \n               && (object == null || p.obj == object)) {      \n            Message n = p.next;                               \n            mMessages = n;\n            // 找到对应的消息，释放它\n            p.recycleUnchecked();                             \n            p = n;                                            \n        }                                                     \n                                                              \n        //  从新的队列头部开始，移除全部符合条件的消息                  \n        while (p != null) {                                   \n            Message n = p.next;                               \n            if (n != null) {                                  \n                if (n.target == h && n.what == what           \n                    && (object == null || n.obj == object)) { \n                    Message nn = n.next;                      \n                    n.recycleUnchecked();                     \n                    p.next = nn;                              \n                    continue;                                 \n                }                                             \n            }                                                 \n            p = n;                                            \n        }                                                     \n    }                                                         \n}                                                             \n```\n\n`postSyncBarrier` 提交一个同步屏障，这将会阻止队列中消息的执行，直到手动调用 `removeSyncBarrier`\n\n当 MessageQueue 退出时，需要 `dispose`：\n\n``` java\n// Disposes of the underlying message queue.                 \n// Must only be called on the looper thread or the finalizer.\nprivate void dispose() {                                     \n    if (mPtr != 0) {\n        // native 方法\n        nativeDestroy(mPtr);\n        // mPtr 是记录 JNI 层的 NativeMessageQueue 的偏移量\n        mPtr = 0;                                            \n    }                                                        \n}                                                            \n```\n\n`nativeDestroy` 最终会调用 RefBase 的 `decStrong`：\n\n``` cpp\nvoid RefBase::decStrong(const void* id) const\n{\n    weakref_impl* const refs = mRefs;\n    refs->removeStrongRef(id); //移除强引用\n    const int32_t c = android_atomic_dec(&refs->mStrong);\n    if (c == 1) {\n        refs->mBase->onLastStrongRef(id);\n        if ((refs->mFlags&OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) {\n            delete this;\n        }\n    }\n    refs->decWeak(id); // 移除弱引用\n}\n```\n\n### Message\n\n``` java\nvoid recycleUnchecked() {                 \n    // 标记为使用状态，清除其他状态     \n    flags = FLAG_IN_USE;                  \n    what = 0;                             \n    arg1 = 0;                             \n    arg2 = 0;                             \n    obj = null;                           \n    replyTo = null;                       \n    sendingUid = -1;                      \n    when = 0;                             \n    target = null;                        \n    callback = null;                      \n    data = null;                          \n                                          \n    synchronized (sPoolSync) {\n        // 消息缓存\n        if (sPoolSize < MAX_POOL_SIZE) {  \n            next = sPool;                 \n            sPool = this;                 \n            sPoolSize++;                  \n        }                                 \n    }                                     \n}                                         \n```\n\n``` java\npublic static Message obtain() {             \n    synchronized (sPoolSync) {               \n        if (sPool != null) {\n            // 从缓存中获取\n            Message m = sPool;               \n            sPool = m.next;                  \n            m.next = null;                   \n            m.flags = 0; // clear in-use flag\n            sPoolSize--;                     \n            return m;                        \n        }                                    \n    }                                        \n    return new Message();                    \n}                                            \n```\n\n### 总结\n\n![消息机制](http://gityuan.com/images/handler/handler_java.jpg)\n\nJava 层：\n\n* Handler 通过 `sendMessage`，将 Message 通过 `MessageQueue.enqueueMessage` 添加到队列中\n* Looper 通过 `loop` 提取需要执行的 Message，并交与 `Message.target` 的 Handler 进行 `dispatchMessage` 分发\n*  将 Message 添加到 MessageQueue 时，会唤醒 Looper 线程；如果 MessageQueue 中没有 Message 时，并处于 Idle 状态，则会执行 IdelHandler \n\nJNI 层：\n\n* 线程在进入循环之前，会在 JNI 创建管道(Pipe) ，当消息队列为空时，线程处于空闲等待状态\n* 通过 epoll 机制监听 `EPOLLIN` 事件，当有新事件进入消息队列时，并且当前线程处于空闲状态，通过向管道写入数据，来唤醒线程\n\n消息分发的优先级：\n\n1. `Message.callback.run()`\n2. `Handler.mCallback.handleMessage()`\n3. `Handler.handleMessage()`\n\n> EPOLL：Linux 内核的可扩展 I/O 事件通知机制\n>\n> PIPE：管道是一系列将标准输入输出链接起来的进程，其中每个进程的输出被直接作为下一个进程的输入\n>\n> 文件描述符(File descriptor)：用于表述指向[文件](https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6)的引用的抽象化概念","slug":"Android消息机制-Handler","published":1,"updated":"2022-06-15T11:19:32.311Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrm6001efho69o9o7f8f","content":"<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><p><a href=\"http://gityuan.com/2015/12/26/handler-message-framework/\">Android消息机制1-Handler(Java层)</a></p>\n<p><a href=\"http://gityuan.com/2015/12/27/handler-message-native/\">Android消息机制2-Handler(Native层)</a></p>\n<p><a href=\"http://blog.csdn.net/luoshengyang/article/details/6817933\">Android应用程序消息处理机制（Looper、Handler）分析</a></p>\n<p><a href=\"https://zh.wikipedia.org/wiki/%E7%AE%A1%E9%81%93_(Unix)\">管道(Unix)</a></p>\n<p><a href=\"https://zh.wikipedia.org/zh-hans/Epoll\">Epoll</a></p>\n<p><a href=\"https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6\">文件描述符</a></p>\n<p>Handler 机制主要由四个部分组成：</p>\n<ul>\n<li>Looper</li>\n<li>MessageQueue</li>\n<li>Message</li>\n<li>Handler</li>\n</ul>\n<h3 id=\"典型用法\"><a href=\"#典型用法\" class=\"headerlink\" title=\"典型用法\"></a>典型用法</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">LooperThread</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Thread</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Handler mHandler;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        Looper.prepare();</span><br><span class=\"line\">        </span><br><span class=\"line\">        mHandler = <span class=\"keyword\">new</span> <span class=\"title class_\">Handler</span>() &#123;</span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handleMessage</span><span class=\"params\">(Message msg)</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// process incoming messages here</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        </span><br><span class=\"line\">        Looper.loop();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Looper\"><a href=\"#Looper\" class=\"headerlink\" title=\"Looper\"></a>Looper</h3><p>不断循环执行 <code>Looper.loop</code>，按分发机制将消息分发给目标处理者</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">prepare</span><span class=\"params\">(<span class=\"type\">boolean</span> quitAllowed)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(sThreadLocal.get() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 构建 Looper 存储到 ThreadLocal</span></span><br><span class=\"line\">    sThreadLocal.set(<span class=\"keyword\">new</span> <span class=\"title class_\">Looper</span>(quitAllowed));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sThreadLocal</code> 是一个 ThreadLocal 类型的静态变量</p>\n<blockquote>\n<p>ThreadLocal：线程本地存储区（Thread Local Storage），每个线程都有自己的私有的本地存储区域，不同线程之间彼此不能访问对方的 TLS 区域</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"title function_\">Looper</span><span class=\"params\">(<span class=\"type\">boolean</span> quitAllowed)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Looper 中创建 MessageQueue</span></span><br><span class=\"line\">    mQueue = <span class=\"keyword\">new</span> <span class=\"title class_\">MessageQueue</span>(quitAllowed);</span><br><span class=\"line\">    mThread = Thread.currentThread();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">loop</span><span class=\"params\">()</span> &#123;                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">Looper</span> <span class=\"variable\">me</span> <span class=\"operator\">=</span> myLooper();                                                               </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (me == <span class=\"literal\">null</span>) &#123;                                                                           </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>);</span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">MessageQueue</span> <span class=\"variable\">queue</span> <span class=\"operator\">=</span> me.mQueue;                                                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">    <span class=\"comment\">// Make sure the identity of this thread is that of the local process,                      </span></span><br><span class=\"line\">    <span class=\"comment\">// and keep track of what that identity token actually is.                                  </span></span><br><span class=\"line\">    Binder.clearCallingIdentity();                                                              </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">ident</span> <span class=\"operator\">=</span> Binder.clearCallingIdentity();                                           </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (;;) &#123;                                                                                  </span><br><span class=\"line\">        <span class=\"type\">Message</span> <span class=\"variable\">msg</span> <span class=\"operator\">=</span> queue.next(); <span class=\"comment\">// 获取下一条 Message，可能会阻塞                                              </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (msg == <span class=\"literal\">null</span>) &#123;                                                                      </span><br><span class=\"line\">            <span class=\"comment\">// No message indicates that the message queue is quitting.                         </span></span><br><span class=\"line\">            <span class=\"keyword\">return</span>;                                                                             </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">        <span class=\"comment\">// This must be in a local variable, in case a UI event sets the logger                 </span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">Printer</span> <span class=\"variable\">logging</span> <span class=\"operator\">=</span> me.mLogging;                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (logging != <span class=\"literal\">null</span>) &#123;                                                                  </span><br><span class=\"line\">            logging.println(<span class=\"string\">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> + msg.target + <span class=\"string\">&quot; &quot;</span> +                        </span><br><span class=\"line\">                    msg.callback + <span class=\"string\">&quot;: &quot;</span> + msg.what);                                            </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">slowDispatchThresholdMs</span> <span class=\"operator\">=</span> me.mSlowDispatchThresholdMs;                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">        <span class=\"comment\">//省略</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">start</span> <span class=\"operator\">=</span> (slowDispatchThresholdMs == <span class=\"number\">0</span>) ? <span class=\"number\">0</span> : SystemClock.uptimeMillis();     </span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">long</span> end;                                                                         </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 分发 Message</span></span><br><span class=\"line\">            msg.target.dispatchMessage(msg);                                                    </span><br><span class=\"line\">            end = (slowDispatchThresholdMs == <span class=\"number\">0</span>) ? <span class=\"number\">0</span> : SystemClock.uptimeMillis();              </span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;                                                                             </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (traceTag != <span class=\"number\">0</span>) &#123;                                                                </span><br><span class=\"line\">                Trace.traceEnd(traceTag);                                                       </span><br><span class=\"line\">            &#125;                                                                                   </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (slowDispatchThresholdMs &gt; <span class=\"number\">0</span>) &#123;                                                      </span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">time</span> <span class=\"operator\">=</span> end - start;                                                      </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (time &gt; slowDispatchThresholdMs) &#123;                                               </span><br><span class=\"line\">                Slog.w(TAG, <span class=\"string\">&quot;Dispatch took &quot;</span> + time + <span class=\"string\">&quot;ms on &quot;</span>                                  </span><br><span class=\"line\">                        + Thread.currentThread().getName() + <span class=\"string\">&quot;, h=&quot;</span> +                           </span><br><span class=\"line\">                        msg.target + <span class=\"string\">&quot; cb=&quot;</span> + msg.callback + <span class=\"string\">&quot; msg=&quot;</span> + msg.what);               </span><br><span class=\"line\">            &#125;                                                                                   </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (logging != <span class=\"literal\">null</span>) &#123;                                                                  </span><br><span class=\"line\">            logging.println(<span class=\"string\">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.target + <span class=\"string\">&quot; &quot;</span> + msg.callback);            </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">        <span class=\"comment\">// Make sure that during the course of dispatching the                                  </span></span><br><span class=\"line\">        <span class=\"comment\">// identity of the thread wasn&#x27;t corrupted.                                             </span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">newIdent</span> <span class=\"operator\">=</span> Binder.clearCallingIdentity();                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ident != newIdent) &#123;                                                                </span><br><span class=\"line\">            Log.wtf(TAG, <span class=\"string\">&quot;Thread identity changed from 0x&quot;</span>                                      </span><br><span class=\"line\">                    + Long.toHexString(ident) + <span class=\"string\">&quot; to 0x&quot;</span>                                        </span><br><span class=\"line\">                    + Long.toHexString(newIdent) + <span class=\"string\">&quot; while dispatching to &quot;</span>                     </span><br><span class=\"line\">                    + msg.target.getClass().getName() + <span class=\"string\">&quot; &quot;</span>                                     </span><br><span class=\"line\">                    + msg.callback + <span class=\"string\">&quot; what=&quot;</span> + msg.what);                                      </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">         </span><br><span class=\"line\">        <span class=\"comment\">// 释放 Message</span></span><br><span class=\"line\">        msg.recycleUnchecked();                                                                 </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">&#125;                                                                                               </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Looper.quit 最终调用的都是 MessageQueue.quit</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">quit</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    mQueue.quit(<span class=\"literal\">false</span>); <span class=\"comment\">// 移除消息</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">quitSafely</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    mQueue.quit(<span class=\"literal\">true</span>); <span class=\"comment\">// 安全移除消息</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>MessageQueue 在构造方法中，会调用 native 方法 <code>nativeInit</code> 方法，在 NativeMessageQueue 的构造方法中，会构造一个 JNI 层的 Looper</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// frameworks/base/libs</span></span><br><span class=\"line\">Looper::<span class=\"built_in\">Looper</span>(<span class=\"type\">bool</span> allowNonCallbacks) :  </span><br><span class=\"line\">    <span class=\"built_in\">mAllowNonCallbacks</span>(allowNonCallbacks),  </span><br><span class=\"line\">    <span class=\"built_in\">mResponseIndex</span>(<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 管道机制</span></span><br><span class=\"line\">    <span class=\"type\">int</span> wakeFds[<span class=\"number\">2</span>];  </span><br><span class=\"line\">    <span class=\"type\">int</span> result = <span class=\"built_in\">pipe</span>(wakeFds);  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    mWakeReadPipeFd = wakeFds[<span class=\"number\">0</span>];  </span><br><span class=\"line\">    mWakeWritePipeFd = wakeFds[<span class=\"number\">1</span>];  </span><br><span class=\"line\">  \t</span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> LOOPER_USES_EPOLL  </span></span><br><span class=\"line\">    <span class=\"comment\">// 分配新的 epoll 实例同时注册唤醒管道</span></span><br><span class=\"line\">    mEpollFd = <span class=\"built_in\">epoll_create</span>(EPOLL_SIZE_HINT);  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">struct</span> <span class=\"title class_\">epoll_event</span> eventItem;  </span><br><span class=\"line\">    <span class=\"built_in\">memset</span>(&amp; eventItem, <span class=\"number\">0</span>, <span class=\"built_in\">sizeof</span>(epoll_event)); <span class=\"comment\">// zero out unused members of data field union</span></span><br><span class=\"line\">    <span class=\"comment\">// 观察 EPOLLIN 事件</span></span><br><span class=\"line\">    eventItem.events = EPOLLIN;  </span><br><span class=\"line\">    eventItem.data.fd = mWakeReadPipeFd;  </span><br><span class=\"line\">    result = <span class=\"built_in\">epoll_ctl</span>(mEpollFd, EPOLL_CTL_ADD, mWakeReadPipeFd, &amp; eventItem);  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span>  </span></span><br><span class=\"line\">    ......  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span>  </span></span><br><span class=\"line\">  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>管道：Linux 系统中的一种进程间通信机制。简单来说，管道就是一个文件，在管道的两端，分别是两个打开文件的文件描述符，这两个打开文件描述符都是对应同一个文件，其中一个是用来读的，别一个是用来写的，一般的使用方式就是，一个线程通过读文件描述符中来读管道的内容，当管道没有内容时，这个线程就会进入等待状态，而另外一个线程通过写文件描述符来向管道中写入内容，写入内容的时候，如果另一端正有线程正在等待管道中的内容，那么这个线程就会被唤醒。</p>\n<p>epoll：Linux 系统中的 epoll 机制为处理大批量句柄而作了改进的 poll，是 Linux 下多路复用 IO 接口select&#x2F;poll 的增强版本，它能显著减少程序在大量并发连接中只有少量活跃的情况下的系统 CPU 利用率。</p>\n</blockquote>\n<p>pipe 是 Linux 系统中的管道机制，用于 IPC，在管道机制的实现中，又使用 epoll 机制来监听读写事件。</p>\n<p>以上在 Android 上的应用为，当 Java 层的消息队列中没有消息时，就使 Android 应用程序主线程进入等待状态，而当 Java 层的消息队列中来了新的消息后，就唤醒 Android 应用程序的主线程来处理这个消息。</p>\n<h3 id=\"Handler\"><a href=\"#Handler\" class=\"headerlink\" title=\"Handler\"></a>Handler</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">Handler</span><span class=\"params\">(Callback callback, <span class=\"type\">boolean</span> async)</span> &#123;                                                  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (FIND_POTENTIAL_LEAKS) &#123;                                                                     </span><br><span class=\"line\">        <span class=\"keyword\">final</span> Class&lt;? <span class=\"keyword\">extends</span> <span class=\"title class_\">Handler</span>&gt; klass = getClass();                                          </span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;          </span><br><span class=\"line\">                (klass.getModifiers() &amp; Modifier.STATIC) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 匿名类、内部类或本地类都必须申明为 static，否则会警告出现内存泄漏</span></span><br><span class=\"line\">            Log.w(TAG, <span class=\"string\">&quot;The following Handler class should be static or leaks might occur: &quot;</span> +      </span><br><span class=\"line\">                klass.getCanonicalName());                                                          </span><br><span class=\"line\">        &#125;                                                                                           </span><br><span class=\"line\">    &#125;                                                                                               </span><br><span class=\"line\">    <span class=\"comment\">// 默认使用当前线程的 Looper                                                                                                </span></span><br><span class=\"line\">    mLooper = Looper.myLooper();                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mLooper == <span class=\"literal\">null</span>) &#123;                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(                                                                 </span><br><span class=\"line\">            <span class=\"string\">&quot;Can&#x27;t create handler inside thread that has not called Looper.prepare()&quot;</span>);             </span><br><span class=\"line\">    &#125;                                                                                               </span><br><span class=\"line\">    mQueue = mLooper.mQueue;                                                                        </span><br><span class=\"line\">    mCallback = callback;</span><br><span class=\"line\">    <span class=\"comment\">// 是否为异步处理</span></span><br><span class=\"line\">    mAsynchronous = async;                                                                          </span><br><span class=\"line\">&#125;                                                                                                   </span><br></pre></td></tr></table></figure>\n\n<p>在 <code>Looper.loop</code> 中，当存在 Message 需要处理时，会调用 <code>dispatchMessage</code> 来进行分发：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">dispatchMessage</span><span class=\"params\">(Message msg)</span> &#123;      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (msg.callback != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 先调用 callback</span></span><br><span class=\"line\">        handleCallback(msg);                    </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mCallback != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 接着检查通过构造方法传进来的 Callback</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mCallback.handleMessage(msg)) &#123; </span><br><span class=\"line\">                <span class=\"keyword\">return</span>;                         </span><br><span class=\"line\">            &#125;                                   </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 最后调用 handleMessage</span></span><br><span class=\"line\">        handleMessage(msg);                     </span><br><span class=\"line\">    &#125;                                           </span><br><span class=\"line\">&#125;                                               </span><br></pre></td></tr></table></figure>\n\n<p>通过 Handler 发送消息：</p>\n<p><img src=\"http://gityuan.com/images/handler/java_sendmessage.png\" alt=\"发送消息调用链\"></p>\n<p>最终所有的方法都会调用到 <code>MessageQueue.enqueueMessage</code></p>\n<h3 id=\"MessageQueue\"><a href=\"#MessageQueue\" class=\"headerlink\" title=\"MessageQueue\"></a>MessageQueue</h3><blockquote>\n<p>消息机制中 Java 层和 C++ 层的连接纽带，大部分核心方法都交给 native 层来处理</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MessageQueue(<span class=\"type\">boolean</span> quitAllowed) &#123; </span><br><span class=\"line\">    mQuitAllowed = quitAllowed;</span><br><span class=\"line\">    <span class=\"comment\">// used by native code</span></span><br><span class=\"line\">    mPtr = nativeInit();            </span><br><span class=\"line\">&#125;                                   </span><br></pre></td></tr></table></figure>\n\n<p>MessageQueue 的初始化工作主要由 native 方法来执行</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//frameworks/base/core/jni/android_os_MessageQueue.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">android_os_MessageQueue_nativeInit</span><span class=\"params\">(JNIEnv* env, jobject obj)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 构建一个 NativeMessageQueue，在它的构造方法中，也会创建一个 Looper，不过这个 Looper 对象实现是在 JNI 层</span></span><br><span class=\"line\">    NativeMessageQueue* nativeMessageQueue = <span class=\"keyword\">new</span> <span class=\"built_in\">NativeMessageQueue</span>();  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (! nativeMessageQueue) &#123;  </span><br><span class=\"line\">        <span class=\"built_in\">jniThrowRuntimeException</span>(env, <span class=\"string\">&quot;Unable to allocate native queue&quot;</span>);  </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">  \t</span><br><span class=\"line\">    <span class=\"comment\">// 在这里，会 NativeMessageQueue 保存到 Java 层 MessageQueue 的 mPtr 变量中，这里保存的是一个偏移量</span></span><br><span class=\"line\">    <span class=\"built_in\">android_os_MessageQueue_setNativeMessageQueue</span>(env, obj, nativeMessageQueue);  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p><code>nativeInit</code> 中主要是在 JNI 层创建一个 NativeMessageQueue 并将偏移量保存在 MessageQueue 中的 <code>mPtr</code>，关联了 NativeMessageQueue 和 MessageQueue</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Message <span class=\"title function_\">next</span><span class=\"params\">()</span> &#123;                                                                              </span><br><span class=\"line\">    <span class=\"comment\">// messsage loop has already quit                                                              </span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">ptr</span> <span class=\"operator\">=</span> mPtr;                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ptr == <span class=\"number\">0</span>) &#123;                                                                           </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;                                                                          </span><br><span class=\"line\">    &#125;                                                                                         </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">pendingIdleHandlerCount</span> <span class=\"operator\">=</span> -<span class=\"number\">1</span>; <span class=\"comment\">// -1 only during first iteration                       </span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">nextPollTimeoutMillis</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;                                                            </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (;;) &#123;                                                                                </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (nextPollTimeoutMillis != <span class=\"number\">0</span>) &#123;                                                     </span><br><span class=\"line\">            Binder.flushPendingCommands();                                                    </span><br><span class=\"line\">        &#125;                                                                                     </span><br><span class=\"line\">        <span class=\"comment\">// 阻塞操作，当等待nextPollTimeoutMillis时长，或者消息队列被唤醒，都会返回</span></span><br><span class=\"line\">        <span class=\"comment\">// ptr 是在 JNI 层创建的 NativeMessageQueue</span></span><br><span class=\"line\">        nativePollOnce(ptr, nextPollTimeoutMillis);                                           </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 当前 nativePollOnce 返回后，查看消息队列中是否存在消息</span></span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (<span class=\"built_in\">this</span>) &#123;                                                                 </span><br><span class=\"line\">            <span class=\"comment\">// 尝试检索下一条消息，如果找到则返回                            </span></span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">now</span> <span class=\"operator\">=</span> SystemClock.uptimeMillis();                                      </span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">prevMsg</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;                                                           </span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">msg</span> <span class=\"operator\">=</span> mMessages;                                                          </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (msg != <span class=\"literal\">null</span> &amp;&amp; msg.target == <span class=\"literal\">null</span>) &#123;                                          </span><br><span class=\"line\">                <span class=\"comment\">// 找到下一条异步消息或者没有消息了，则退出循环</span></span><br><span class=\"line\">                <span class=\"keyword\">do</span> &#123;                                                                          </span><br><span class=\"line\">                    prevMsg = msg;                                                            </span><br><span class=\"line\">                    msg = msg.next;                                                           </span><br><span class=\"line\">                &#125; <span class=\"keyword\">while</span> (msg != <span class=\"literal\">null</span> &amp;&amp; !msg.isAsynchronous());                               </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (msg != <span class=\"literal\">null</span>) &#123;                                                                </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (now &lt; msg.when) &#123;                                                         </span><br><span class=\"line\">                    <span class=\"comment\">// 下一个消息还没准备好，重新设置唤醒超时时间</span></span><br><span class=\"line\">                    nextPollTimeoutMillis = (<span class=\"type\">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;                                                                      </span><br><span class=\"line\">                    <span class=\"comment\">// 获取一条消息                                                         </span></span><br><span class=\"line\">                    mBlocked = <span class=\"literal\">false</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (prevMsg != <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">                        prevMsg.next = msg.next;                                              </span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;                                                                  </span><br><span class=\"line\">                        mMessages = msg.next;                                                 </span><br><span class=\"line\">                    &#125;                                                                         </span><br><span class=\"line\">                    msg.next = <span class=\"literal\">null</span>;                                                          </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (DEBUG) Log.v(TAG, <span class=\"string\">&quot;Returning message: &quot;</span> + msg);</span><br><span class=\"line\">                    <span class=\"comment\">// 标记当前消息已使用</span></span><br><span class=\"line\">                    msg.markInUse();                                                          </span><br><span class=\"line\">                    <span class=\"keyword\">return</span> msg;                                                               </span><br><span class=\"line\">                &#125;                                                                             </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;                                                                          </span><br><span class=\"line\">                <span class=\"comment\">// 当前还没有消息，设置为 -1，无限等待中                                                     </span></span><br><span class=\"line\">                nextPollTimeoutMillis = -<span class=\"number\">1</span>;                                                   </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">            <span class=\"comment\">// Process the quit message now that all pending messages have been handled.      </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mQuitting) &#123;                                                                  </span><br><span class=\"line\">                dispose();                                                                    </span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;                                                                  </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">            <span class=\"comment\">// queue is empty or if the first message</span></span><br><span class=\"line\">            <span class=\"comment\">// get pending idle handler count</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (pendingIdleHandlerCount &lt; <span class=\"number\">0</span>                                                   </span><br><span class=\"line\">                    &amp;&amp; (mMessages == <span class=\"literal\">null</span> || now &lt; mMessages.when)) &#123;                         </span><br><span class=\"line\">                pendingIdleHandlerCount = mIdleHandlers.size();                               </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (pendingIdleHandlerCount &lt;= <span class=\"number\">0</span>) &#123;                                               </span><br><span class=\"line\">                <span class=\"comment\">// 没有 idle handlers 需要运行，循环继续等待                        </span></span><br><span class=\"line\">                mBlocked = <span class=\"literal\">true</span>;                                                              </span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;                                                                     </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mPendingIdleHandlers == <span class=\"literal\">null</span>) &#123;                                               </span><br><span class=\"line\">                mPendingIdleHandlers = <span class=\"keyword\">new</span> <span class=\"title class_\">IdleHandler</span>[Math.max(pendingIdleHandlerCount, <span class=\"number\">4</span>)]; </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);               </span><br><span class=\"line\">        &#125;                                                                                     </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">        <span class=\"comment\">// Run the idle handlers.                                                        </span></span><br><span class=\"line\">        <span class=\"comment\">// We only ever reach this code block during the first iteration                    </span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;                                   </span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">IdleHandler</span> <span class=\"variable\">idler</span> <span class=\"operator\">=</span> mPendingIdleHandlers[i];                                </span><br><span class=\"line\">            mPendingIdleHandlers[i] = <span class=\"literal\">null</span>;           </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">            <span class=\"type\">boolean</span> <span class=\"variable\">keep</span> <span class=\"operator\">=</span> <span class=\"literal\">false</span>;                                                             </span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;                                                                             </span><br><span class=\"line\">                keep = idler.queueIdle();                                                     </span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;                                                           </span><br><span class=\"line\">                Log.wtf(TAG, <span class=\"string\">&quot;IdleHandler threw exception&quot;</span>, t);                               </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!keep) &#123;                                                                      </span><br><span class=\"line\">                <span class=\"keyword\">synchronized</span> (<span class=\"built_in\">this</span>) &#123;</span><br><span class=\"line\">                    mIdleHandlers.remove(idler);                                              </span><br><span class=\"line\">                &#125;                                                                             </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">        &#125;                                                                                     </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">        <span class=\"comment\">// Reset the idle handler count to 0 so we do not run them again.                     </span></span><br><span class=\"line\">        pendingIdleHandlerCount = <span class=\"number\">0</span>;                                                          </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">        <span class=\"comment\">//不设置超时时间,因为可能在处理 IdleHandler 时可能有新的消息加入                </span></span><br><span class=\"line\">        nextPollTimeoutMillis = <span class=\"number\">0</span>;                                                            </span><br><span class=\"line\">    &#125;                                                                                         </span><br><span class=\"line\">&#125;                                                                                             </span><br></pre></td></tr></table></figure>\n\n<p>在 <code>next</code> 方法中，<code>nativePollOnce</code> 是阻塞操作，其中 <code>nextPollTimeoutMillis</code> 代表下一个消息到来之前，还需要等待的时长；<code>nextPollTimeoutMillis == -1</code> 表示当前没有更多消息。<code>nativePollOnce</code> 调用结束后，从 <code>mMessages</code> 中提取一个消息</p>\n<p>当处于空闲时，执行 <code>IdleHandler</code> 中的回调方法。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// frameworks/base/core/jni/android_os_MessageQueue.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">android_os_MessageQueue_nativePollOnce</span><span class=\"params\">(JNIEnv* env, jobject obj,  </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        jint ptr, jint timeoutMillis)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 通过前面设置的 mPrt 获取 NativeMessageQueue</span></span><br><span class=\"line\">    NativeMessageQueue* nativeMessageQueue = <span class=\"built_in\">reinterpret_cast</span>&lt;NativeMessageQueue*&gt;(ptr); </span><br><span class=\"line\">    <span class=\"comment\">// 调用 NativeMessageQueue.pollOnce 进行轮询</span></span><br><span class=\"line\">    nativeMessageQueue-&gt;<span class=\"built_in\">pollOnce</span>(timeoutMillis);  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">NativeMessageQueue::pollOnce</span><span class=\"params\">(<span class=\"type\">int</span> timeoutMillis)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 将调用转发给了 JNI 层的 Looper</span></span><br><span class=\"line\">    mLooper-&gt;<span class=\"built_in\">pollOnce</span>(timeoutMillis);  </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n\n<p><code>pollOnce</code> 会调用 <code>pollnner</code> 来进一步操作，如果 <code>pollnner</code> 返回值不等于 0，则返回</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// frameworks/base/libs/utils/Looper.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Looper::pollInner</span><span class=\"params\">(<span class=\"type\">int</span> timeoutMillis)</span> </span>&#123;  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"type\">int</span> result = ALOOPER_POLL_WAKE;  </span><br><span class=\"line\">  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> LOOPER_USES_EPOLL  </span></span><br><span class=\"line\">    <span class=\"keyword\">struct</span> <span class=\"title class_\">epoll_event</span> eventItems[EPOLL_MAX_EVENTS];</span><br><span class=\"line\">    <span class=\"comment\">// 调用 epoll_wait 检查 epoll 专用文件描述符 mEpollFd 所监控的文件描述符是否有 IO 事件,超时时间为 timeoutMillis</span></span><br><span class=\"line\">    <span class=\"comment\">// 在 JNI 层的 Looper 构造函数中，设置了要监控 mWakeReadPipeFd 文件描述符的 EPOLLIN 事件</span></span><br><span class=\"line\">    <span class=\"comment\">// 如果检查成功或者超时，则结束等待</span></span><br><span class=\"line\">    <span class=\"comment\">// 处于 Idle 状态</span></span><br><span class=\"line\">    <span class=\"type\">int</span> eventCount = <span class=\"built_in\">epoll_wait</span>(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);</span><br><span class=\"line\">    <span class=\"type\">bool</span> acquiredLock = <span class=\"literal\">false</span>;  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span>  </span></span><br><span class=\"line\">    ......  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span>  </span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// eventCount &lt; 0 可能出错了</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (eventCount &lt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (errno == EINTR) &#123;  </span><br><span class=\"line\">            <span class=\"keyword\">goto</span> Done;  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">  </span><br><span class=\"line\">        <span class=\"built_in\">LOGW</span>(<span class=\"string\">&quot;Poll failed with an unexpected error, errno=%d&quot;</span>, errno);  </span><br><span class=\"line\">        result = ALOOPER_POLL_ERROR;  </span><br><span class=\"line\">        <span class=\"keyword\">goto</span> Done;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">  \t</span><br><span class=\"line\">    <span class=\"comment\">// eventCount == 0 超时</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (eventCount == <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">        ......  </span><br><span class=\"line\">        result = ALOOPER_POLL_TIMEOUT;  </span><br><span class=\"line\">        <span class=\"keyword\">goto</span> Done;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> LOOPER_USES_EPOLL</span></span><br><span class=\"line\">    <span class=\"comment\">// eventCount &gt; 0 存在事件</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; eventCount; i++) &#123;  </span><br><span class=\"line\">        <span class=\"type\">int</span> fd = eventItems[i].data.fd;  </span><br><span class=\"line\">        <span class=\"type\">uint32_t</span> epollEvents = eventItems[i].events;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (fd == mWakeReadPipeFd) &#123;  </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (epollEvents &amp; EPOLLIN) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Looper 中使用 epoll 监听的 EPOLLIN 事件</span></span><br><span class=\"line\">                <span class=\"built_in\">awoken</span>();  </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">                <span class=\"built_in\">LOGW</span>(<span class=\"string\">&quot;Ignoring unexpected epoll events 0x%x on wake read pipe.&quot;</span>, epollEvents);  </span><br><span class=\"line\">            &#125;  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">            ......  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (acquiredLock) &#123;  </span><br><span class=\"line\">        mLock.<span class=\"built_in\">unlock</span>();  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">Done: ;  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span>  </span></span><br><span class=\"line\">    ......  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span>  </span></span><br><span class=\"line\">  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;  </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Looper::awoken</span><span class=\"params\">()</span> </span>&#123;  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"type\">char</span> buffer[<span class=\"number\">16</span>];  </span><br><span class=\"line\">    <span class=\"type\">ssize_t</span> nRead;  </span><br><span class=\"line\">    <span class=\"keyword\">do</span> &#123;  </span><br><span class=\"line\">        nRead = <span class=\"built_in\">read</span>(mWakeReadPipeFd, buffer, <span class=\"built_in\">sizeof</span>(buffer));  </span><br><span class=\"line\">    &#125; <span class=\"keyword\">while</span> ((nRead == <span class=\"number\">-1</span> &amp;&amp; errno == EINTR) || nRead == <span class=\"built_in\">sizeof</span>(buffer));  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p>总结上面的代码，Looper 通过 <code>loop</code> 调用 MessageQueue 的 <code>next</code>，<code>next</code> 中又会调用到 native 方法 <code>nativePollOnce</code>，在这个方法中，会调用到 NativeMessageQueue 的 <code>pollInner</code>，这里会通过在 JNI 层 Looper 的构造方法中，使用 epoll 监听管道 EPOLLIN 事件，如果存在调用 <code>awoken</code>，清空管道中的内容，以便下次再调用pollInner函数时，知道自从上次处理完消息队列中的消息后，有没有新的消息加进来。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"title function_\">enqueueMessage</span><span class=\"params\">(Message msg, <span class=\"type\">long</span> when)</span> &#123;                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (msg.target == <span class=\"literal\">null</span>) &#123;                                                            </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Message must have a target.&quot;</span>);               </span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (msg.isInUse()) &#123;                                                                 </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(msg + <span class=\"string\">&quot; This message is already in use.&quot;</span>);       </span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"built_in\">this</span>) &#123;                                                                </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mQuitting) &#123;                                                                 </span><br><span class=\"line\">            <span class=\"type\">IllegalStateException</span> <span class=\"variable\">e</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(                         </span><br><span class=\"line\">                    msg.target + <span class=\"string\">&quot; sending message to a Handler on a dead thread&quot;</span>);      </span><br><span class=\"line\">            Log.w(TAG, e.getMessage(), e);                                               </span><br><span class=\"line\">            msg.recycle();                                                               </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;                                                                </span><br><span class=\"line\">        &#125;                                                                                </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">        msg.markInUse();                                                                 </span><br><span class=\"line\">        msg.when = when;                                                                 </span><br><span class=\"line\">        <span class=\"type\">Message</span> <span class=\"variable\">p</span> <span class=\"operator\">=</span> mMessages;                                                           </span><br><span class=\"line\">        <span class=\"type\">boolean</span> needWake;                                                                </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p == <span class=\"literal\">null</span> || when == <span class=\"number\">0</span> || when &lt; p.when) &#123;                                   </span><br><span class=\"line\">            <span class=\"comment\">// 不存在头部消息或立即执行或执行时机快于头部消息</span></span><br><span class=\"line\">            <span class=\"comment\">// 将处理的消息作为新的头部消息</span></span><br><span class=\"line\">            msg.next = p;                                                                </span><br><span class=\"line\">            mMessages = msg;                                                             </span><br><span class=\"line\">            needWake = mBlocked;                                                         </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;                                                                         </span><br><span class=\"line\">            <span class=\"comment\">// 将处理的消息插入到队列的尾部</span></span><br><span class=\"line\">            <span class=\"comment\">// 一般不需要唤醒事件队列，除非消息头存在 barrier，并且当前处理的消息是队列中最早的异步消息</span></span><br><span class=\"line\">            needWake = mBlocked &amp;&amp; p.target == <span class=\"literal\">null</span> &amp;&amp; msg.isAsynchronous();             </span><br><span class=\"line\">            Message prev;                                                                </span><br><span class=\"line\">            <span class=\"keyword\">for</span> (;;) &#123;                                                                   </span><br><span class=\"line\">                prev = p;                                                                </span><br><span class=\"line\">                p = p.next;                                                              </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (p == <span class=\"literal\">null</span> || when &lt; p.when) &#123;                                        </span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                                                               </span><br><span class=\"line\">                &#125;                                                                        </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;                                    </span><br><span class=\"line\">                    needWake = <span class=\"literal\">false</span>;                                                    </span><br><span class=\"line\">                &#125;                                                                        </span><br><span class=\"line\">            &#125;                                                                            </span><br><span class=\"line\">            msg.next = p; <span class=\"comment\">// invariant: p == prev.next                                   </span></span><br><span class=\"line\">            prev.next = msg;                                                             </span><br><span class=\"line\">        &#125;                                                                                </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">        <span class=\"comment\">// We can assume mPtr != 0 because mQuitting is false.                           </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (needWake) &#123;                                                                  </span><br><span class=\"line\">            nativeWake(mPtr);                                                            </span><br><span class=\"line\">        &#125;                                                                                </span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                                                                         </span><br><span class=\"line\">&#125;                                                                                        </span><br></pre></td></tr></table></figure>\n\n<p><code>MessageQueue</code> 是按照消息触发时间的先后顺序排列的，队列头部的消息是最早触发的。当有消息加入，会从队列头部开始遍历，插入到合适的位置，以保证所有消息的时间顺序。</p>\n<p>如果当前线程处于空闲等待状态，那么还需要调用 <code>nativeWake</code> 来唤醒：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// frameworks/base/core/jni/android_os_MessageQueue.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">android_os_MessageQueue_nativeWake</span><span class=\"params\">(JNIEnv* env, jobject obj, jint ptr)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ptr 获取 NativeMessageQueue</span></span><br><span class=\"line\">    NativeMessageQueue* nativeMessageQueue = <span class=\"built_in\">reinterpret_cast</span>&lt;NativeMessageQueue*&gt;(ptr);  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> nativeMessageQueue-&gt;<span class=\"built_in\">wake</span>();  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p>这里将唤醒请求转发到 Looper <code>wake</code>：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// frameworks/base/libs/utils/Looper.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Looper::wake</span><span class=\"params\">()</span> </span>&#123;  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"type\">ssize_t</span> nWrite;  </span><br><span class=\"line\">    <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 先管道中写入 &quot;W</span></span><br><span class=\"line\">        nWrite = <span class=\"built_in\">write</span>(mWakeWritePipeFd, <span class=\"string\">&quot;W&quot;</span>, <span class=\"number\">1</span>);  </span><br><span class=\"line\">    &#125; <span class=\"keyword\">while</span> (nWrite == <span class=\"number\">-1</span> &amp;&amp; errno == EINTR);  </span><br><span class=\"line\">  </span><br><span class=\"line\">    .......  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p>往管道写入内容，从而唤醒线程，因为当消息队列中没有消息处理时，线程会进入空闲等待状态，具体是通过 Looper 的 <code>polllnner</code> 中调用 <code>epoll_wait</code> 进入</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">removeMessages</span><span class=\"params\">(Handler h, <span class=\"type\">int</span> what, Object object)</span> &#123;     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (h == <span class=\"literal\">null</span>) &#123;                                          </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                               </span><br><span class=\"line\">    &#125;                                                         </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"built_in\">this</span>) &#123;                                     </span><br><span class=\"line\">        <span class=\"type\">Message</span> <span class=\"variable\">p</span> <span class=\"operator\">=</span> mMessages;                                </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">        <span class=\"comment\">// 从队列头部开始，移除连续的所有符合条件的消息                     </span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (p != <span class=\"literal\">null</span> &amp;&amp; p.target == h &amp;&amp; p.what == what   </span><br><span class=\"line\">               &amp;&amp; (object == <span class=\"literal\">null</span> || p.obj == object)) &#123;      </span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> p.next;                               </span><br><span class=\"line\">            mMessages = n;</span><br><span class=\"line\">            <span class=\"comment\">// 找到对应的消息，释放它</span></span><br><span class=\"line\">            p.recycleUnchecked();                             </span><br><span class=\"line\">            p = n;                                            </span><br><span class=\"line\">        &#125;                                                     </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">        <span class=\"comment\">//  从新的队列头部开始，移除全部符合条件的消息                  </span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (p != <span class=\"literal\">null</span>) &#123;                                   </span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> p.next;                               </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (n != <span class=\"literal\">null</span>) &#123;                                  </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (n.target == h &amp;&amp; n.what == what           </span><br><span class=\"line\">                    &amp;&amp; (object == <span class=\"literal\">null</span> || n.obj == object)) &#123; </span><br><span class=\"line\">                    <span class=\"type\">Message</span> <span class=\"variable\">nn</span> <span class=\"operator\">=</span> n.next;                      </span><br><span class=\"line\">                    n.recycleUnchecked();                     </span><br><span class=\"line\">                    p.next = nn;                              </span><br><span class=\"line\">                    <span class=\"keyword\">continue</span>;                                 </span><br><span class=\"line\">                &#125;                                             </span><br><span class=\"line\">            &#125;                                                 </span><br><span class=\"line\">            p = n;                                            </span><br><span class=\"line\">        &#125;                                                     </span><br><span class=\"line\">    &#125;                                                         </span><br><span class=\"line\">&#125;                                                             </span><br></pre></td></tr></table></figure>\n\n<p><code>postSyncBarrier</code> 提交一个同步屏障，这将会阻止队列中消息的执行，直到手动调用 <code>removeSyncBarrier</code></p>\n<p>当 MessageQueue 退出时，需要 <code>dispose</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Disposes of the underlying message queue.                 </span></span><br><span class=\"line\"><span class=\"comment\">// Must only be called on the looper thread or the finalizer.</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">dispose</span><span class=\"params\">()</span> &#123;                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mPtr != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// native 方法</span></span><br><span class=\"line\">        nativeDestroy(mPtr);</span><br><span class=\"line\">        <span class=\"comment\">// mPtr 是记录 JNI 层的 NativeMessageQueue 的偏移量</span></span><br><span class=\"line\">        mPtr = <span class=\"number\">0</span>;                                            </span><br><span class=\"line\">    &#125;                                                        </span><br><span class=\"line\">&#125;                                                            </span><br></pre></td></tr></table></figure>\n\n<p><code>nativeDestroy</code> 最终会调用 RefBase 的 <code>decStrong</code>：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">RefBase::decStrong</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">void</span>* id)</span> <span class=\"type\">const</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    weakref_impl* <span class=\"type\">const</span> refs = mRefs;</span><br><span class=\"line\">    refs-&gt;<span class=\"built_in\">removeStrongRef</span>(id); <span class=\"comment\">//移除强引用</span></span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">int32_t</span> c = <span class=\"built_in\">android_atomic_dec</span>(&amp;refs-&gt;mStrong);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (c == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        refs-&gt;mBase-&gt;<span class=\"built_in\">onLastStrongRef</span>(id);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">delete</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    refs-&gt;<span class=\"built_in\">decWeak</span>(id); <span class=\"comment\">// 移除弱引用</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Message\"><a href=\"#Message\" class=\"headerlink\" title=\"Message\"></a>Message</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">recycleUnchecked</span><span class=\"params\">()</span> &#123;                 </span><br><span class=\"line\">    <span class=\"comment\">// 标记为使用状态，清除其他状态     </span></span><br><span class=\"line\">    flags = FLAG_IN_USE;                  </span><br><span class=\"line\">    what = <span class=\"number\">0</span>;                             </span><br><span class=\"line\">    arg1 = <span class=\"number\">0</span>;                             </span><br><span class=\"line\">    arg2 = <span class=\"number\">0</span>;                             </span><br><span class=\"line\">    obj = <span class=\"literal\">null</span>;                           </span><br><span class=\"line\">    replyTo = <span class=\"literal\">null</span>;                       </span><br><span class=\"line\">    sendingUid = -<span class=\"number\">1</span>;                      </span><br><span class=\"line\">    when = <span class=\"number\">0</span>;                             </span><br><span class=\"line\">    target = <span class=\"literal\">null</span>;                        </span><br><span class=\"line\">    callback = <span class=\"literal\">null</span>;                      </span><br><span class=\"line\">    data = <span class=\"literal\">null</span>;                          </span><br><span class=\"line\">                                          </span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (sPoolSync) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 消息缓存</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sPoolSize &lt; MAX_POOL_SIZE) &#123;  </span><br><span class=\"line\">            next = sPool;                 </span><br><span class=\"line\">            sPool = <span class=\"built_in\">this</span>;                 </span><br><span class=\"line\">            sPoolSize++;                  </span><br><span class=\"line\">        &#125;                                 </span><br><span class=\"line\">    &#125;                                     </span><br><span class=\"line\">&#125;                                         </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Message <span class=\"title function_\">obtain</span><span class=\"params\">()</span> &#123;             </span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (sPoolSync) &#123;               </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sPool != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 从缓存中获取</span></span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">m</span> <span class=\"operator\">=</span> sPool;               </span><br><span class=\"line\">            sPool = m.next;                  </span><br><span class=\"line\">            m.next = <span class=\"literal\">null</span>;                   </span><br><span class=\"line\">            m.flags = <span class=\"number\">0</span>; <span class=\"comment\">// clear in-use flag</span></span><br><span class=\"line\">            sPoolSize--;                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> m;                        </span><br><span class=\"line\">        &#125;                                    </span><br><span class=\"line\">    &#125;                                        </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Message</span>();                    </span><br><span class=\"line\">&#125;                                            </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p><img src=\"http://gityuan.com/images/handler/handler_java.jpg\" alt=\"消息机制\"></p>\n<p>Java 层：</p>\n<ul>\n<li>Handler 通过 <code>sendMessage</code>，将 Message 通过 <code>MessageQueue.enqueueMessage</code> 添加到队列中</li>\n<li>Looper 通过 <code>loop</code> 提取需要执行的 Message，并交与 <code>Message.target</code> 的 Handler 进行 <code>dispatchMessage</code> 分发</li>\n<li>将 Message 添加到 MessageQueue 时，会唤醒 Looper 线程；如果 MessageQueue 中没有 Message 时，并处于 Idle 状态，则会执行 IdelHandler</li>\n</ul>\n<p>JNI 层：</p>\n<ul>\n<li>线程在进入循环之前，会在 JNI 创建管道(Pipe) ，当消息队列为空时，线程处于空闲等待状态</li>\n<li>通过 epoll 机制监听 <code>EPOLLIN</code> 事件，当有新事件进入消息队列时，并且当前线程处于空闲状态，通过向管道写入数据，来唤醒线程</li>\n</ul>\n<p>消息分发的优先级：</p>\n<ol>\n<li><code>Message.callback.run()</code></li>\n<li><code>Handler.mCallback.handleMessage()</code></li>\n<li><code>Handler.handleMessage()</code></li>\n</ol>\n<blockquote>\n<p>EPOLL：Linux 内核的可扩展 I&#x2F;O 事件通知机制</p>\n<p>PIPE：管道是一系列将标准输入输出链接起来的进程，其中每个进程的输出被直接作为下一个进程的输入</p>\n<p>文件描述符(File descriptor)：用于表述指向<a href=\"https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6\">文件</a>的引用的抽象化概念</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><p><a href=\"http://gityuan.com/2015/12/26/handler-message-framework/\">Android消息机制1-Handler(Java层)</a></p>\n<p><a href=\"http://gityuan.com/2015/12/27/handler-message-native/\">Android消息机制2-Handler(Native层)</a></p>\n<p><a href=\"http://blog.csdn.net/luoshengyang/article/details/6817933\">Android应用程序消息处理机制（Looper、Handler）分析</a></p>\n<p><a href=\"https://zh.wikipedia.org/wiki/%E7%AE%A1%E9%81%93_(Unix)\">管道(Unix)</a></p>\n<p><a href=\"https://zh.wikipedia.org/zh-hans/Epoll\">Epoll</a></p>\n<p><a href=\"https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6\">文件描述符</a></p>\n<p>Handler 机制主要由四个部分组成：</p>\n<ul>\n<li>Looper</li>\n<li>MessageQueue</li>\n<li>Message</li>\n<li>Handler</li>\n</ul>\n<h3 id=\"典型用法\"><a href=\"#典型用法\" class=\"headerlink\" title=\"典型用法\"></a>典型用法</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">LooperThread</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Thread</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Handler mHandler;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        Looper.prepare();</span><br><span class=\"line\">        </span><br><span class=\"line\">        mHandler = <span class=\"keyword\">new</span> <span class=\"title class_\">Handler</span>() &#123;</span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handleMessage</span><span class=\"params\">(Message msg)</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// process incoming messages here</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        </span><br><span class=\"line\">        Looper.loop();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Looper\"><a href=\"#Looper\" class=\"headerlink\" title=\"Looper\"></a>Looper</h3><p>不断循环执行 <code>Looper.loop</code>，按分发机制将消息分发给目标处理者</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">prepare</span><span class=\"params\">(<span class=\"type\">boolean</span> quitAllowed)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(sThreadLocal.get() != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 构建 Looper 存储到 ThreadLocal</span></span><br><span class=\"line\">    sThreadLocal.set(<span class=\"keyword\">new</span> <span class=\"title class_\">Looper</span>(quitAllowed));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sThreadLocal</code> 是一个 ThreadLocal 类型的静态变量</p>\n<blockquote>\n<p>ThreadLocal：线程本地存储区（Thread Local Storage），每个线程都有自己的私有的本地存储区域，不同线程之间彼此不能访问对方的 TLS 区域</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"title function_\">Looper</span><span class=\"params\">(<span class=\"type\">boolean</span> quitAllowed)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Looper 中创建 MessageQueue</span></span><br><span class=\"line\">    mQueue = <span class=\"keyword\">new</span> <span class=\"title class_\">MessageQueue</span>(quitAllowed);</span><br><span class=\"line\">    mThread = Thread.currentThread();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">loop</span><span class=\"params\">()</span> &#123;                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">Looper</span> <span class=\"variable\">me</span> <span class=\"operator\">=</span> myLooper();                                                               </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (me == <span class=\"literal\">null</span>) &#123;                                                                           </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(<span class=\"string\">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>);</span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">MessageQueue</span> <span class=\"variable\">queue</span> <span class=\"operator\">=</span> me.mQueue;                                                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">    <span class=\"comment\">// Make sure the identity of this thread is that of the local process,                      </span></span><br><span class=\"line\">    <span class=\"comment\">// and keep track of what that identity token actually is.                                  </span></span><br><span class=\"line\">    Binder.clearCallingIdentity();                                                              </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">ident</span> <span class=\"operator\">=</span> Binder.clearCallingIdentity();                                           </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (;;) &#123;                                                                                  </span><br><span class=\"line\">        <span class=\"type\">Message</span> <span class=\"variable\">msg</span> <span class=\"operator\">=</span> queue.next(); <span class=\"comment\">// 获取下一条 Message，可能会阻塞                                              </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (msg == <span class=\"literal\">null</span>) &#123;                                                                      </span><br><span class=\"line\">            <span class=\"comment\">// No message indicates that the message queue is quitting.                         </span></span><br><span class=\"line\">            <span class=\"keyword\">return</span>;                                                                             </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">        <span class=\"comment\">// This must be in a local variable, in case a UI event sets the logger                 </span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">Printer</span> <span class=\"variable\">logging</span> <span class=\"operator\">=</span> me.mLogging;                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (logging != <span class=\"literal\">null</span>) &#123;                                                                  </span><br><span class=\"line\">            logging.println(<span class=\"string\">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> + msg.target + <span class=\"string\">&quot; &quot;</span> +                        </span><br><span class=\"line\">                    msg.callback + <span class=\"string\">&quot;: &quot;</span> + msg.what);                                            </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">slowDispatchThresholdMs</span> <span class=\"operator\">=</span> me.mSlowDispatchThresholdMs;                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">        <span class=\"comment\">//省略</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">start</span> <span class=\"operator\">=</span> (slowDispatchThresholdMs == <span class=\"number\">0</span>) ? <span class=\"number\">0</span> : SystemClock.uptimeMillis();     </span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">long</span> end;                                                                         </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 分发 Message</span></span><br><span class=\"line\">            msg.target.dispatchMessage(msg);                                                    </span><br><span class=\"line\">            end = (slowDispatchThresholdMs == <span class=\"number\">0</span>) ? <span class=\"number\">0</span> : SystemClock.uptimeMillis();              </span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;                                                                             </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (traceTag != <span class=\"number\">0</span>) &#123;                                                                </span><br><span class=\"line\">                Trace.traceEnd(traceTag);                                                       </span><br><span class=\"line\">            &#125;                                                                                   </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (slowDispatchThresholdMs &gt; <span class=\"number\">0</span>) &#123;                                                      </span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">time</span> <span class=\"operator\">=</span> end - start;                                                      </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (time &gt; slowDispatchThresholdMs) &#123;                                               </span><br><span class=\"line\">                Slog.w(TAG, <span class=\"string\">&quot;Dispatch took &quot;</span> + time + <span class=\"string\">&quot;ms on &quot;</span>                                  </span><br><span class=\"line\">                        + Thread.currentThread().getName() + <span class=\"string\">&quot;, h=&quot;</span> +                           </span><br><span class=\"line\">                        msg.target + <span class=\"string\">&quot; cb=&quot;</span> + msg.callback + <span class=\"string\">&quot; msg=&quot;</span> + msg.what);               </span><br><span class=\"line\">            &#125;                                                                                   </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (logging != <span class=\"literal\">null</span>) &#123;                                                                  </span><br><span class=\"line\">            logging.println(<span class=\"string\">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.target + <span class=\"string\">&quot; &quot;</span> + msg.callback);            </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">                                                                                                </span><br><span class=\"line\">        <span class=\"comment\">// Make sure that during the course of dispatching the                                  </span></span><br><span class=\"line\">        <span class=\"comment\">// identity of the thread wasn&#x27;t corrupted.                                             </span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">newIdent</span> <span class=\"operator\">=</span> Binder.clearCallingIdentity();                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ident != newIdent) &#123;                                                                </span><br><span class=\"line\">            Log.wtf(TAG, <span class=\"string\">&quot;Thread identity changed from 0x&quot;</span>                                      </span><br><span class=\"line\">                    + Long.toHexString(ident) + <span class=\"string\">&quot; to 0x&quot;</span>                                        </span><br><span class=\"line\">                    + Long.toHexString(newIdent) + <span class=\"string\">&quot; while dispatching to &quot;</span>                     </span><br><span class=\"line\">                    + msg.target.getClass().getName() + <span class=\"string\">&quot; &quot;</span>                                     </span><br><span class=\"line\">                    + msg.callback + <span class=\"string\">&quot; what=&quot;</span> + msg.what);                                      </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">         </span><br><span class=\"line\">        <span class=\"comment\">// 释放 Message</span></span><br><span class=\"line\">        msg.recycleUnchecked();                                                                 </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">&#125;                                                                                               </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Looper.quit 最终调用的都是 MessageQueue.quit</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">quit</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    mQueue.quit(<span class=\"literal\">false</span>); <span class=\"comment\">// 移除消息</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">quitSafely</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    mQueue.quit(<span class=\"literal\">true</span>); <span class=\"comment\">// 安全移除消息</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>MessageQueue 在构造方法中，会调用 native 方法 <code>nativeInit</code> 方法，在 NativeMessageQueue 的构造方法中，会构造一个 JNI 层的 Looper</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// frameworks/base/libs</span></span><br><span class=\"line\">Looper::<span class=\"built_in\">Looper</span>(<span class=\"type\">bool</span> allowNonCallbacks) :  </span><br><span class=\"line\">    <span class=\"built_in\">mAllowNonCallbacks</span>(allowNonCallbacks),  </span><br><span class=\"line\">    <span class=\"built_in\">mResponseIndex</span>(<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 管道机制</span></span><br><span class=\"line\">    <span class=\"type\">int</span> wakeFds[<span class=\"number\">2</span>];  </span><br><span class=\"line\">    <span class=\"type\">int</span> result = <span class=\"built_in\">pipe</span>(wakeFds);  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    mWakeReadPipeFd = wakeFds[<span class=\"number\">0</span>];  </span><br><span class=\"line\">    mWakeWritePipeFd = wakeFds[<span class=\"number\">1</span>];  </span><br><span class=\"line\">  \t</span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> LOOPER_USES_EPOLL  </span></span><br><span class=\"line\">    <span class=\"comment\">// 分配新的 epoll 实例同时注册唤醒管道</span></span><br><span class=\"line\">    mEpollFd = <span class=\"built_in\">epoll_create</span>(EPOLL_SIZE_HINT);  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">struct</span> <span class=\"title class_\">epoll_event</span> eventItem;  </span><br><span class=\"line\">    <span class=\"built_in\">memset</span>(&amp; eventItem, <span class=\"number\">0</span>, <span class=\"built_in\">sizeof</span>(epoll_event)); <span class=\"comment\">// zero out unused members of data field union</span></span><br><span class=\"line\">    <span class=\"comment\">// 观察 EPOLLIN 事件</span></span><br><span class=\"line\">    eventItem.events = EPOLLIN;  </span><br><span class=\"line\">    eventItem.data.fd = mWakeReadPipeFd;  </span><br><span class=\"line\">    result = <span class=\"built_in\">epoll_ctl</span>(mEpollFd, EPOLL_CTL_ADD, mWakeReadPipeFd, &amp; eventItem);  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span>  </span></span><br><span class=\"line\">    ......  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span>  </span></span><br><span class=\"line\">  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>管道：Linux 系统中的一种进程间通信机制。简单来说，管道就是一个文件，在管道的两端，分别是两个打开文件的文件描述符，这两个打开文件描述符都是对应同一个文件，其中一个是用来读的，别一个是用来写的，一般的使用方式就是，一个线程通过读文件描述符中来读管道的内容，当管道没有内容时，这个线程就会进入等待状态，而另外一个线程通过写文件描述符来向管道中写入内容，写入内容的时候，如果另一端正有线程正在等待管道中的内容，那么这个线程就会被唤醒。</p>\n<p>epoll：Linux 系统中的 epoll 机制为处理大批量句柄而作了改进的 poll，是 Linux 下多路复用 IO 接口select&#x2F;poll 的增强版本，它能显著减少程序在大量并发连接中只有少量活跃的情况下的系统 CPU 利用率。</p>\n</blockquote>\n<p>pipe 是 Linux 系统中的管道机制，用于 IPC，在管道机制的实现中，又使用 epoll 机制来监听读写事件。</p>\n<p>以上在 Android 上的应用为，当 Java 层的消息队列中没有消息时，就使 Android 应用程序主线程进入等待状态，而当 Java 层的消息队列中来了新的消息后，就唤醒 Android 应用程序的主线程来处理这个消息。</p>\n<h3 id=\"Handler\"><a href=\"#Handler\" class=\"headerlink\" title=\"Handler\"></a>Handler</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">Handler</span><span class=\"params\">(Callback callback, <span class=\"type\">boolean</span> async)</span> &#123;                                                  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (FIND_POTENTIAL_LEAKS) &#123;                                                                     </span><br><span class=\"line\">        <span class=\"keyword\">final</span> Class&lt;? <span class=\"keyword\">extends</span> <span class=\"title class_\">Handler</span>&gt; klass = getClass();                                          </span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;          </span><br><span class=\"line\">                (klass.getModifiers() &amp; Modifier.STATIC) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 匿名类、内部类或本地类都必须申明为 static，否则会警告出现内存泄漏</span></span><br><span class=\"line\">            Log.w(TAG, <span class=\"string\">&quot;The following Handler class should be static or leaks might occur: &quot;</span> +      </span><br><span class=\"line\">                klass.getCanonicalName());                                                          </span><br><span class=\"line\">        &#125;                                                                                           </span><br><span class=\"line\">    &#125;                                                                                               </span><br><span class=\"line\">    <span class=\"comment\">// 默认使用当前线程的 Looper                                                                                                </span></span><br><span class=\"line\">    mLooper = Looper.myLooper();                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mLooper == <span class=\"literal\">null</span>) &#123;                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(                                                                 </span><br><span class=\"line\">            <span class=\"string\">&quot;Can&#x27;t create handler inside thread that has not called Looper.prepare()&quot;</span>);             </span><br><span class=\"line\">    &#125;                                                                                               </span><br><span class=\"line\">    mQueue = mLooper.mQueue;                                                                        </span><br><span class=\"line\">    mCallback = callback;</span><br><span class=\"line\">    <span class=\"comment\">// 是否为异步处理</span></span><br><span class=\"line\">    mAsynchronous = async;                                                                          </span><br><span class=\"line\">&#125;                                                                                                   </span><br></pre></td></tr></table></figure>\n\n<p>在 <code>Looper.loop</code> 中，当存在 Message 需要处理时，会调用 <code>dispatchMessage</code> 来进行分发：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">dispatchMessage</span><span class=\"params\">(Message msg)</span> &#123;      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (msg.callback != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 先调用 callback</span></span><br><span class=\"line\">        handleCallback(msg);                    </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mCallback != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 接着检查通过构造方法传进来的 Callback</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mCallback.handleMessage(msg)) &#123; </span><br><span class=\"line\">                <span class=\"keyword\">return</span>;                         </span><br><span class=\"line\">            &#125;                                   </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 最后调用 handleMessage</span></span><br><span class=\"line\">        handleMessage(msg);                     </span><br><span class=\"line\">    &#125;                                           </span><br><span class=\"line\">&#125;                                               </span><br></pre></td></tr></table></figure>\n\n<p>通过 Handler 发送消息：</p>\n<p><img src=\"http://gityuan.com/images/handler/java_sendmessage.png\" alt=\"发送消息调用链\"></p>\n<p>最终所有的方法都会调用到 <code>MessageQueue.enqueueMessage</code></p>\n<h3 id=\"MessageQueue\"><a href=\"#MessageQueue\" class=\"headerlink\" title=\"MessageQueue\"></a>MessageQueue</h3><blockquote>\n<p>消息机制中 Java 层和 C++ 层的连接纽带，大部分核心方法都交给 native 层来处理</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MessageQueue(<span class=\"type\">boolean</span> quitAllowed) &#123; </span><br><span class=\"line\">    mQuitAllowed = quitAllowed;</span><br><span class=\"line\">    <span class=\"comment\">// used by native code</span></span><br><span class=\"line\">    mPtr = nativeInit();            </span><br><span class=\"line\">&#125;                                   </span><br></pre></td></tr></table></figure>\n\n<p>MessageQueue 的初始化工作主要由 native 方法来执行</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//frameworks/base/core/jni/android_os_MessageQueue.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">android_os_MessageQueue_nativeInit</span><span class=\"params\">(JNIEnv* env, jobject obj)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 构建一个 NativeMessageQueue，在它的构造方法中，也会创建一个 Looper，不过这个 Looper 对象实现是在 JNI 层</span></span><br><span class=\"line\">    NativeMessageQueue* nativeMessageQueue = <span class=\"keyword\">new</span> <span class=\"built_in\">NativeMessageQueue</span>();  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (! nativeMessageQueue) &#123;  </span><br><span class=\"line\">        <span class=\"built_in\">jniThrowRuntimeException</span>(env, <span class=\"string\">&quot;Unable to allocate native queue&quot;</span>);  </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">  \t</span><br><span class=\"line\">    <span class=\"comment\">// 在这里，会 NativeMessageQueue 保存到 Java 层 MessageQueue 的 mPtr 变量中，这里保存的是一个偏移量</span></span><br><span class=\"line\">    <span class=\"built_in\">android_os_MessageQueue_setNativeMessageQueue</span>(env, obj, nativeMessageQueue);  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p><code>nativeInit</code> 中主要是在 JNI 层创建一个 NativeMessageQueue 并将偏移量保存在 MessageQueue 中的 <code>mPtr</code>，关联了 NativeMessageQueue 和 MessageQueue</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Message <span class=\"title function_\">next</span><span class=\"params\">()</span> &#123;                                                                              </span><br><span class=\"line\">    <span class=\"comment\">// messsage loop has already quit                                                              </span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">ptr</span> <span class=\"operator\">=</span> mPtr;                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ptr == <span class=\"number\">0</span>) &#123;                                                                           </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;                                                                          </span><br><span class=\"line\">    &#125;                                                                                         </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">pendingIdleHandlerCount</span> <span class=\"operator\">=</span> -<span class=\"number\">1</span>; <span class=\"comment\">// -1 only during first iteration                       </span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">nextPollTimeoutMillis</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;                                                            </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (;;) &#123;                                                                                </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (nextPollTimeoutMillis != <span class=\"number\">0</span>) &#123;                                                     </span><br><span class=\"line\">            Binder.flushPendingCommands();                                                    </span><br><span class=\"line\">        &#125;                                                                                     </span><br><span class=\"line\">        <span class=\"comment\">// 阻塞操作，当等待nextPollTimeoutMillis时长，或者消息队列被唤醒，都会返回</span></span><br><span class=\"line\">        <span class=\"comment\">// ptr 是在 JNI 层创建的 NativeMessageQueue</span></span><br><span class=\"line\">        nativePollOnce(ptr, nextPollTimeoutMillis);                                           </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 当前 nativePollOnce 返回后，查看消息队列中是否存在消息</span></span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (<span class=\"built_in\">this</span>) &#123;                                                                 </span><br><span class=\"line\">            <span class=\"comment\">// 尝试检索下一条消息，如果找到则返回                            </span></span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">now</span> <span class=\"operator\">=</span> SystemClock.uptimeMillis();                                      </span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">prevMsg</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;                                                           </span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">msg</span> <span class=\"operator\">=</span> mMessages;                                                          </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (msg != <span class=\"literal\">null</span> &amp;&amp; msg.target == <span class=\"literal\">null</span>) &#123;                                          </span><br><span class=\"line\">                <span class=\"comment\">// 找到下一条异步消息或者没有消息了，则退出循环</span></span><br><span class=\"line\">                <span class=\"keyword\">do</span> &#123;                                                                          </span><br><span class=\"line\">                    prevMsg = msg;                                                            </span><br><span class=\"line\">                    msg = msg.next;                                                           </span><br><span class=\"line\">                &#125; <span class=\"keyword\">while</span> (msg != <span class=\"literal\">null</span> &amp;&amp; !msg.isAsynchronous());                               </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (msg != <span class=\"literal\">null</span>) &#123;                                                                </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (now &lt; msg.when) &#123;                                                         </span><br><span class=\"line\">                    <span class=\"comment\">// 下一个消息还没准备好，重新设置唤醒超时时间</span></span><br><span class=\"line\">                    nextPollTimeoutMillis = (<span class=\"type\">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;                                                                      </span><br><span class=\"line\">                    <span class=\"comment\">// 获取一条消息                                                         </span></span><br><span class=\"line\">                    mBlocked = <span class=\"literal\">false</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (prevMsg != <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">                        prevMsg.next = msg.next;                                              </span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;                                                                  </span><br><span class=\"line\">                        mMessages = msg.next;                                                 </span><br><span class=\"line\">                    &#125;                                                                         </span><br><span class=\"line\">                    msg.next = <span class=\"literal\">null</span>;                                                          </span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (DEBUG) Log.v(TAG, <span class=\"string\">&quot;Returning message: &quot;</span> + msg);</span><br><span class=\"line\">                    <span class=\"comment\">// 标记当前消息已使用</span></span><br><span class=\"line\">                    msg.markInUse();                                                          </span><br><span class=\"line\">                    <span class=\"keyword\">return</span> msg;                                                               </span><br><span class=\"line\">                &#125;                                                                             </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;                                                                          </span><br><span class=\"line\">                <span class=\"comment\">// 当前还没有消息，设置为 -1，无限等待中                                                     </span></span><br><span class=\"line\">                nextPollTimeoutMillis = -<span class=\"number\">1</span>;                                                   </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">            <span class=\"comment\">// Process the quit message now that all pending messages have been handled.      </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mQuitting) &#123;                                                                  </span><br><span class=\"line\">                dispose();                                                                    </span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;                                                                  </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">            <span class=\"comment\">// queue is empty or if the first message</span></span><br><span class=\"line\">            <span class=\"comment\">// get pending idle handler count</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (pendingIdleHandlerCount &lt; <span class=\"number\">0</span>                                                   </span><br><span class=\"line\">                    &amp;&amp; (mMessages == <span class=\"literal\">null</span> || now &lt; mMessages.when)) &#123;                         </span><br><span class=\"line\">                pendingIdleHandlerCount = mIdleHandlers.size();                               </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (pendingIdleHandlerCount &lt;= <span class=\"number\">0</span>) &#123;                                               </span><br><span class=\"line\">                <span class=\"comment\">// 没有 idle handlers 需要运行，循环继续等待                        </span></span><br><span class=\"line\">                mBlocked = <span class=\"literal\">true</span>;                                                              </span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;                                                                     </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mPendingIdleHandlers == <span class=\"literal\">null</span>) &#123;                                               </span><br><span class=\"line\">                mPendingIdleHandlers = <span class=\"keyword\">new</span> <span class=\"title class_\">IdleHandler</span>[Math.max(pendingIdleHandlerCount, <span class=\"number\">4</span>)]; </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);               </span><br><span class=\"line\">        &#125;                                                                                     </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">        <span class=\"comment\">// Run the idle handlers.                                                        </span></span><br><span class=\"line\">        <span class=\"comment\">// We only ever reach this code block during the first iteration                    </span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;                                   </span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"type\">IdleHandler</span> <span class=\"variable\">idler</span> <span class=\"operator\">=</span> mPendingIdleHandlers[i];                                </span><br><span class=\"line\">            mPendingIdleHandlers[i] = <span class=\"literal\">null</span>;           </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">            <span class=\"type\">boolean</span> <span class=\"variable\">keep</span> <span class=\"operator\">=</span> <span class=\"literal\">false</span>;                                                             </span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;                                                                             </span><br><span class=\"line\">                keep = idler.queueIdle();                                                     </span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;                                                           </span><br><span class=\"line\">                Log.wtf(TAG, <span class=\"string\">&quot;IdleHandler threw exception&quot;</span>, t);                               </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!keep) &#123;                                                                      </span><br><span class=\"line\">                <span class=\"keyword\">synchronized</span> (<span class=\"built_in\">this</span>) &#123;</span><br><span class=\"line\">                    mIdleHandlers.remove(idler);                                              </span><br><span class=\"line\">                &#125;                                                                             </span><br><span class=\"line\">            &#125;                                                                                 </span><br><span class=\"line\">        &#125;                                                                                     </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">        <span class=\"comment\">// Reset the idle handler count to 0 so we do not run them again.                     </span></span><br><span class=\"line\">        pendingIdleHandlerCount = <span class=\"number\">0</span>;                                                          </span><br><span class=\"line\">                                                                                              </span><br><span class=\"line\">        <span class=\"comment\">//不设置超时时间,因为可能在处理 IdleHandler 时可能有新的消息加入                </span></span><br><span class=\"line\">        nextPollTimeoutMillis = <span class=\"number\">0</span>;                                                            </span><br><span class=\"line\">    &#125;                                                                                         </span><br><span class=\"line\">&#125;                                                                                             </span><br></pre></td></tr></table></figure>\n\n<p>在 <code>next</code> 方法中，<code>nativePollOnce</code> 是阻塞操作，其中 <code>nextPollTimeoutMillis</code> 代表下一个消息到来之前，还需要等待的时长；<code>nextPollTimeoutMillis == -1</code> 表示当前没有更多消息。<code>nativePollOnce</code> 调用结束后，从 <code>mMessages</code> 中提取一个消息</p>\n<p>当处于空闲时，执行 <code>IdleHandler</code> 中的回调方法。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// frameworks/base/core/jni/android_os_MessageQueue.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">android_os_MessageQueue_nativePollOnce</span><span class=\"params\">(JNIEnv* env, jobject obj,  </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        jint ptr, jint timeoutMillis)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 通过前面设置的 mPrt 获取 NativeMessageQueue</span></span><br><span class=\"line\">    NativeMessageQueue* nativeMessageQueue = <span class=\"built_in\">reinterpret_cast</span>&lt;NativeMessageQueue*&gt;(ptr); </span><br><span class=\"line\">    <span class=\"comment\">// 调用 NativeMessageQueue.pollOnce 进行轮询</span></span><br><span class=\"line\">    nativeMessageQueue-&gt;<span class=\"built_in\">pollOnce</span>(timeoutMillis);  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">NativeMessageQueue::pollOnce</span><span class=\"params\">(<span class=\"type\">int</span> timeoutMillis)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 将调用转发给了 JNI 层的 Looper</span></span><br><span class=\"line\">    mLooper-&gt;<span class=\"built_in\">pollOnce</span>(timeoutMillis);  </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n\n<p><code>pollOnce</code> 会调用 <code>pollnner</code> 来进一步操作，如果 <code>pollnner</code> 返回值不等于 0，则返回</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// frameworks/base/libs/utils/Looper.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Looper::pollInner</span><span class=\"params\">(<span class=\"type\">int</span> timeoutMillis)</span> </span>&#123;  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"type\">int</span> result = ALOOPER_POLL_WAKE;  </span><br><span class=\"line\">  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> LOOPER_USES_EPOLL  </span></span><br><span class=\"line\">    <span class=\"keyword\">struct</span> <span class=\"title class_\">epoll_event</span> eventItems[EPOLL_MAX_EVENTS];</span><br><span class=\"line\">    <span class=\"comment\">// 调用 epoll_wait 检查 epoll 专用文件描述符 mEpollFd 所监控的文件描述符是否有 IO 事件,超时时间为 timeoutMillis</span></span><br><span class=\"line\">    <span class=\"comment\">// 在 JNI 层的 Looper 构造函数中，设置了要监控 mWakeReadPipeFd 文件描述符的 EPOLLIN 事件</span></span><br><span class=\"line\">    <span class=\"comment\">// 如果检查成功或者超时，则结束等待</span></span><br><span class=\"line\">    <span class=\"comment\">// 处于 Idle 状态</span></span><br><span class=\"line\">    <span class=\"type\">int</span> eventCount = <span class=\"built_in\">epoll_wait</span>(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);</span><br><span class=\"line\">    <span class=\"type\">bool</span> acquiredLock = <span class=\"literal\">false</span>;  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span>  </span></span><br><span class=\"line\">    ......  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span>  </span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// eventCount &lt; 0 可能出错了</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (eventCount &lt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (errno == EINTR) &#123;  </span><br><span class=\"line\">            <span class=\"keyword\">goto</span> Done;  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">  </span><br><span class=\"line\">        <span class=\"built_in\">LOGW</span>(<span class=\"string\">&quot;Poll failed with an unexpected error, errno=%d&quot;</span>, errno);  </span><br><span class=\"line\">        result = ALOOPER_POLL_ERROR;  </span><br><span class=\"line\">        <span class=\"keyword\">goto</span> Done;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">  \t</span><br><span class=\"line\">    <span class=\"comment\">// eventCount == 0 超时</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (eventCount == <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">        ......  </span><br><span class=\"line\">        result = ALOOPER_POLL_TIMEOUT;  </span><br><span class=\"line\">        <span class=\"keyword\">goto</span> Done;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> LOOPER_USES_EPOLL</span></span><br><span class=\"line\">    <span class=\"comment\">// eventCount &gt; 0 存在事件</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; eventCount; i++) &#123;  </span><br><span class=\"line\">        <span class=\"type\">int</span> fd = eventItems[i].data.fd;  </span><br><span class=\"line\">        <span class=\"type\">uint32_t</span> epollEvents = eventItems[i].events;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (fd == mWakeReadPipeFd) &#123;  </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (epollEvents &amp; EPOLLIN) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Looper 中使用 epoll 监听的 EPOLLIN 事件</span></span><br><span class=\"line\">                <span class=\"built_in\">awoken</span>();  </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">                <span class=\"built_in\">LOGW</span>(<span class=\"string\">&quot;Ignoring unexpected epoll events 0x%x on wake read pipe.&quot;</span>, epollEvents);  </span><br><span class=\"line\">            &#125;  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">            ......  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (acquiredLock) &#123;  </span><br><span class=\"line\">        mLock.<span class=\"built_in\">unlock</span>();  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">Done: ;  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span>  </span></span><br><span class=\"line\">    ......  </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span>  </span></span><br><span class=\"line\">  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;  </span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Looper::awoken</span><span class=\"params\">()</span> </span>&#123;  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"type\">char</span> buffer[<span class=\"number\">16</span>];  </span><br><span class=\"line\">    <span class=\"type\">ssize_t</span> nRead;  </span><br><span class=\"line\">    <span class=\"keyword\">do</span> &#123;  </span><br><span class=\"line\">        nRead = <span class=\"built_in\">read</span>(mWakeReadPipeFd, buffer, <span class=\"built_in\">sizeof</span>(buffer));  </span><br><span class=\"line\">    &#125; <span class=\"keyword\">while</span> ((nRead == <span class=\"number\">-1</span> &amp;&amp; errno == EINTR) || nRead == <span class=\"built_in\">sizeof</span>(buffer));  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p>总结上面的代码，Looper 通过 <code>loop</code> 调用 MessageQueue 的 <code>next</code>，<code>next</code> 中又会调用到 native 方法 <code>nativePollOnce</code>，在这个方法中，会调用到 NativeMessageQueue 的 <code>pollInner</code>，这里会通过在 JNI 层 Looper 的构造方法中，使用 epoll 监听管道 EPOLLIN 事件，如果存在调用 <code>awoken</code>，清空管道中的内容，以便下次再调用pollInner函数时，知道自从上次处理完消息队列中的消息后，有没有新的消息加进来。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"title function_\">enqueueMessage</span><span class=\"params\">(Message msg, <span class=\"type\">long</span> when)</span> &#123;                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (msg.target == <span class=\"literal\">null</span>) &#123;                                                            </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Message must have a target.&quot;</span>);               </span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (msg.isInUse()) &#123;                                                                 </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(msg + <span class=\"string\">&quot; This message is already in use.&quot;</span>);       </span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"built_in\">this</span>) &#123;                                                                </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mQuitting) &#123;                                                                 </span><br><span class=\"line\">            <span class=\"type\">IllegalStateException</span> <span class=\"variable\">e</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(                         </span><br><span class=\"line\">                    msg.target + <span class=\"string\">&quot; sending message to a Handler on a dead thread&quot;</span>);      </span><br><span class=\"line\">            Log.w(TAG, e.getMessage(), e);                                               </span><br><span class=\"line\">            msg.recycle();                                                               </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;                                                                </span><br><span class=\"line\">        &#125;                                                                                </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">        msg.markInUse();                                                                 </span><br><span class=\"line\">        msg.when = when;                                                                 </span><br><span class=\"line\">        <span class=\"type\">Message</span> <span class=\"variable\">p</span> <span class=\"operator\">=</span> mMessages;                                                           </span><br><span class=\"line\">        <span class=\"type\">boolean</span> needWake;                                                                </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p == <span class=\"literal\">null</span> || when == <span class=\"number\">0</span> || when &lt; p.when) &#123;                                   </span><br><span class=\"line\">            <span class=\"comment\">// 不存在头部消息或立即执行或执行时机快于头部消息</span></span><br><span class=\"line\">            <span class=\"comment\">// 将处理的消息作为新的头部消息</span></span><br><span class=\"line\">            msg.next = p;                                                                </span><br><span class=\"line\">            mMessages = msg;                                                             </span><br><span class=\"line\">            needWake = mBlocked;                                                         </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;                                                                         </span><br><span class=\"line\">            <span class=\"comment\">// 将处理的消息插入到队列的尾部</span></span><br><span class=\"line\">            <span class=\"comment\">// 一般不需要唤醒事件队列，除非消息头存在 barrier，并且当前处理的消息是队列中最早的异步消息</span></span><br><span class=\"line\">            needWake = mBlocked &amp;&amp; p.target == <span class=\"literal\">null</span> &amp;&amp; msg.isAsynchronous();             </span><br><span class=\"line\">            Message prev;                                                                </span><br><span class=\"line\">            <span class=\"keyword\">for</span> (;;) &#123;                                                                   </span><br><span class=\"line\">                prev = p;                                                                </span><br><span class=\"line\">                p = p.next;                                                              </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (p == <span class=\"literal\">null</span> || when &lt; p.when) &#123;                                        </span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                                                               </span><br><span class=\"line\">                &#125;                                                                        </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;                                    </span><br><span class=\"line\">                    needWake = <span class=\"literal\">false</span>;                                                    </span><br><span class=\"line\">                &#125;                                                                        </span><br><span class=\"line\">            &#125;                                                                            </span><br><span class=\"line\">            msg.next = p; <span class=\"comment\">// invariant: p == prev.next                                   </span></span><br><span class=\"line\">            prev.next = msg;                                                             </span><br><span class=\"line\">        &#125;                                                                                </span><br><span class=\"line\">                                                                                         </span><br><span class=\"line\">        <span class=\"comment\">// We can assume mPtr != 0 because mQuitting is false.                           </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (needWake) &#123;                                                                  </span><br><span class=\"line\">            nativeWake(mPtr);                                                            </span><br><span class=\"line\">        &#125;                                                                                </span><br><span class=\"line\">    &#125;                                                                                    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                                                                         </span><br><span class=\"line\">&#125;                                                                                        </span><br></pre></td></tr></table></figure>\n\n<p><code>MessageQueue</code> 是按照消息触发时间的先后顺序排列的，队列头部的消息是最早触发的。当有消息加入，会从队列头部开始遍历，插入到合适的位置，以保证所有消息的时间顺序。</p>\n<p>如果当前线程处于空闲等待状态，那么还需要调用 <code>nativeWake</code> 来唤醒：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// frameworks/base/core/jni/android_os_MessageQueue.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">android_os_MessageQueue_nativeWake</span><span class=\"params\">(JNIEnv* env, jobject obj, jint ptr)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ptr 获取 NativeMessageQueue</span></span><br><span class=\"line\">    NativeMessageQueue* nativeMessageQueue = <span class=\"built_in\">reinterpret_cast</span>&lt;NativeMessageQueue*&gt;(ptr);  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> nativeMessageQueue-&gt;<span class=\"built_in\">wake</span>();  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p>这里将唤醒请求转发到 Looper <code>wake</code>：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// frameworks/base/libs/utils/Looper.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Looper::wake</span><span class=\"params\">()</span> </span>&#123;  </span><br><span class=\"line\">    ......  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"type\">ssize_t</span> nWrite;  </span><br><span class=\"line\">    <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 先管道中写入 &quot;W</span></span><br><span class=\"line\">        nWrite = <span class=\"built_in\">write</span>(mWakeWritePipeFd, <span class=\"string\">&quot;W&quot;</span>, <span class=\"number\">1</span>);  </span><br><span class=\"line\">    &#125; <span class=\"keyword\">while</span> (nWrite == <span class=\"number\">-1</span> &amp;&amp; errno == EINTR);  </span><br><span class=\"line\">  </span><br><span class=\"line\">    .......  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p>往管道写入内容，从而唤醒线程，因为当消息队列中没有消息处理时，线程会进入空闲等待状态，具体是通过 Looper 的 <code>polllnner</code> 中调用 <code>epoll_wait</code> 进入</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">removeMessages</span><span class=\"params\">(Handler h, <span class=\"type\">int</span> what, Object object)</span> &#123;     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (h == <span class=\"literal\">null</span>) &#123;                                          </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                               </span><br><span class=\"line\">    &#125;                                                         </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"built_in\">this</span>) &#123;                                     </span><br><span class=\"line\">        <span class=\"type\">Message</span> <span class=\"variable\">p</span> <span class=\"operator\">=</span> mMessages;                                </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">        <span class=\"comment\">// 从队列头部开始，移除连续的所有符合条件的消息                     </span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (p != <span class=\"literal\">null</span> &amp;&amp; p.target == h &amp;&amp; p.what == what   </span><br><span class=\"line\">               &amp;&amp; (object == <span class=\"literal\">null</span> || p.obj == object)) &#123;      </span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> p.next;                               </span><br><span class=\"line\">            mMessages = n;</span><br><span class=\"line\">            <span class=\"comment\">// 找到对应的消息，释放它</span></span><br><span class=\"line\">            p.recycleUnchecked();                             </span><br><span class=\"line\">            p = n;                                            </span><br><span class=\"line\">        &#125;                                                     </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">        <span class=\"comment\">//  从新的队列头部开始，移除全部符合条件的消息                  </span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (p != <span class=\"literal\">null</span>) &#123;                                   </span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> p.next;                               </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (n != <span class=\"literal\">null</span>) &#123;                                  </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (n.target == h &amp;&amp; n.what == what           </span><br><span class=\"line\">                    &amp;&amp; (object == <span class=\"literal\">null</span> || n.obj == object)) &#123; </span><br><span class=\"line\">                    <span class=\"type\">Message</span> <span class=\"variable\">nn</span> <span class=\"operator\">=</span> n.next;                      </span><br><span class=\"line\">                    n.recycleUnchecked();                     </span><br><span class=\"line\">                    p.next = nn;                              </span><br><span class=\"line\">                    <span class=\"keyword\">continue</span>;                                 </span><br><span class=\"line\">                &#125;                                             </span><br><span class=\"line\">            &#125;                                                 </span><br><span class=\"line\">            p = n;                                            </span><br><span class=\"line\">        &#125;                                                     </span><br><span class=\"line\">    &#125;                                                         </span><br><span class=\"line\">&#125;                                                             </span><br></pre></td></tr></table></figure>\n\n<p><code>postSyncBarrier</code> 提交一个同步屏障，这将会阻止队列中消息的执行，直到手动调用 <code>removeSyncBarrier</code></p>\n<p>当 MessageQueue 退出时，需要 <code>dispose</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Disposes of the underlying message queue.                 </span></span><br><span class=\"line\"><span class=\"comment\">// Must only be called on the looper thread or the finalizer.</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">dispose</span><span class=\"params\">()</span> &#123;                                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mPtr != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// native 方法</span></span><br><span class=\"line\">        nativeDestroy(mPtr);</span><br><span class=\"line\">        <span class=\"comment\">// mPtr 是记录 JNI 层的 NativeMessageQueue 的偏移量</span></span><br><span class=\"line\">        mPtr = <span class=\"number\">0</span>;                                            </span><br><span class=\"line\">    &#125;                                                        </span><br><span class=\"line\">&#125;                                                            </span><br></pre></td></tr></table></figure>\n\n<p><code>nativeDestroy</code> 最终会调用 RefBase 的 <code>decStrong</code>：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">RefBase::decStrong</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">void</span>* id)</span> <span class=\"type\">const</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    weakref_impl* <span class=\"type\">const</span> refs = mRefs;</span><br><span class=\"line\">    refs-&gt;<span class=\"built_in\">removeStrongRef</span>(id); <span class=\"comment\">//移除强引用</span></span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">int32_t</span> c = <span class=\"built_in\">android_atomic_dec</span>(&amp;refs-&gt;mStrong);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (c == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        refs-&gt;mBase-&gt;<span class=\"built_in\">onLastStrongRef</span>(id);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">delete</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    refs-&gt;<span class=\"built_in\">decWeak</span>(id); <span class=\"comment\">// 移除弱引用</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Message\"><a href=\"#Message\" class=\"headerlink\" title=\"Message\"></a>Message</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">recycleUnchecked</span><span class=\"params\">()</span> &#123;                 </span><br><span class=\"line\">    <span class=\"comment\">// 标记为使用状态，清除其他状态     </span></span><br><span class=\"line\">    flags = FLAG_IN_USE;                  </span><br><span class=\"line\">    what = <span class=\"number\">0</span>;                             </span><br><span class=\"line\">    arg1 = <span class=\"number\">0</span>;                             </span><br><span class=\"line\">    arg2 = <span class=\"number\">0</span>;                             </span><br><span class=\"line\">    obj = <span class=\"literal\">null</span>;                           </span><br><span class=\"line\">    replyTo = <span class=\"literal\">null</span>;                       </span><br><span class=\"line\">    sendingUid = -<span class=\"number\">1</span>;                      </span><br><span class=\"line\">    when = <span class=\"number\">0</span>;                             </span><br><span class=\"line\">    target = <span class=\"literal\">null</span>;                        </span><br><span class=\"line\">    callback = <span class=\"literal\">null</span>;                      </span><br><span class=\"line\">    data = <span class=\"literal\">null</span>;                          </span><br><span class=\"line\">                                          </span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (sPoolSync) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 消息缓存</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sPoolSize &lt; MAX_POOL_SIZE) &#123;  </span><br><span class=\"line\">            next = sPool;                 </span><br><span class=\"line\">            sPool = <span class=\"built_in\">this</span>;                 </span><br><span class=\"line\">            sPoolSize++;                  </span><br><span class=\"line\">        &#125;                                 </span><br><span class=\"line\">    &#125;                                     </span><br><span class=\"line\">&#125;                                         </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Message <span class=\"title function_\">obtain</span><span class=\"params\">()</span> &#123;             </span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (sPoolSync) &#123;               </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sPool != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 从缓存中获取</span></span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">m</span> <span class=\"operator\">=</span> sPool;               </span><br><span class=\"line\">            sPool = m.next;                  </span><br><span class=\"line\">            m.next = <span class=\"literal\">null</span>;                   </span><br><span class=\"line\">            m.flags = <span class=\"number\">0</span>; <span class=\"comment\">// clear in-use flag</span></span><br><span class=\"line\">            sPoolSize--;                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> m;                        </span><br><span class=\"line\">        &#125;                                    </span><br><span class=\"line\">    &#125;                                        </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Message</span>();                    </span><br><span class=\"line\">&#125;                                            </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p><img src=\"http://gityuan.com/images/handler/handler_java.jpg\" alt=\"消息机制\"></p>\n<p>Java 层：</p>\n<ul>\n<li>Handler 通过 <code>sendMessage</code>，将 Message 通过 <code>MessageQueue.enqueueMessage</code> 添加到队列中</li>\n<li>Looper 通过 <code>loop</code> 提取需要执行的 Message，并交与 <code>Message.target</code> 的 Handler 进行 <code>dispatchMessage</code> 分发</li>\n<li>将 Message 添加到 MessageQueue 时，会唤醒 Looper 线程；如果 MessageQueue 中没有 Message 时，并处于 Idle 状态，则会执行 IdelHandler</li>\n</ul>\n<p>JNI 层：</p>\n<ul>\n<li>线程在进入循环之前，会在 JNI 创建管道(Pipe) ，当消息队列为空时，线程处于空闲等待状态</li>\n<li>通过 epoll 机制监听 <code>EPOLLIN</code> 事件，当有新事件进入消息队列时，并且当前线程处于空闲状态，通过向管道写入数据，来唤醒线程</li>\n</ul>\n<p>消息分发的优先级：</p>\n<ol>\n<li><code>Message.callback.run()</code></li>\n<li><code>Handler.mCallback.handleMessage()</code></li>\n<li><code>Handler.handleMessage()</code></li>\n</ol>\n<blockquote>\n<p>EPOLL：Linux 内核的可扩展 I&#x2F;O 事件通知机制</p>\n<p>PIPE：管道是一系列将标准输入输出链接起来的进程，其中每个进程的输出被直接作为下一个进程的输入</p>\n<p>文件描述符(File descriptor)：用于表述指向<a href=\"https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6\">文件</a>的引用的抽象化概念</p>\n</blockquote>\n"},{"title":"Jetpack中的Lifecycle","date":"2019-01-14T07:57:11.000Z","_content":"\n### 关于本文\n\n有很多项目都会使用 MVP 这种项目架构，使用 Presenter 来减轻 `Activity` 的负担，具体的 `MVP` 实现可以阅读 Google 推出的 [android-architecture](https://github.com/googlesamples/android-architecture)。\n\n一般使用 MVP，都会遇到一个问题，如何将 Presenter 和 View 的生命周期进行绑定，常见的做法是，在 `Activity` 的生命周期中手动调用 Presenter 的回调方法，更复杂的做法可能需要在 Presenter 或者 View 维护一个操作栈，在指定生命周期中去执行操作。\n\n### 关于Lifecycle\n\n[lifecycle](https://developer.android.com/topic/libraries/architecture/lifecycle) 是 Google 推出的用于响应 `Activity` 和 `Fragment` 生命周期改变的库。\n\n**These components help you produce better-organized, and often lighter-weight code, that is easier to maintain.**\n\n#### Lifecycle\n\n`Lifecycle` 是一个包含比如 `Activity` 或 `Fragment` 生命周期状态的类，同时允许其他对象去订阅这些状态\n\n`Lifecycle` 使用 Event 和 State 来管理生命周期状态的变化\n\n##### Event\n\n生命周期变化的事件\n\n##### State\n\n当前生命周期的状态\n\n使用 Google 文档中图片来表示这两者的关系：\n\n![lifecycle-states](https://developer.android.com/images/topic/libraries/architecture/lifecycle-states.png)\n\n我们可以调用 `addObserver` 去注册一个监听者\n\n``` kotlin\nlifecycle.addObserver(presenter)\n```\n\n而 `presenter` 则需要实现 `LifecycleObserver` 接口，具体的回调方法则通过注解的形式：\n\n``` kotlin\nclass Presenter : LifecycleObserver {\n\n    @OnLifecycleEvent(Lifecycle.Event.ON_START)\n    fun onStart() {\n\n    }\n\n    @OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)\n    fun onDestroy() {\n\n    }\n\n}\n```\n\n当然我们也可以调用 `getCurrentState()` 来获取 `Lifecycle` 当前的状态\n\n#### LifecycleOwner\n\n上面我们简单介绍了 `Lifecyle` 和 `LifecycleObserver`  的作用和关系之后，再来看下 `getLifecycle` 这个方法：\n\n> 因为上面的例子是用 kotlin 写的，所以 `lifecycle.addObserver` 实际上应该为 `getLifecycle().addObserver()`\n\n``` java\npublic interface LifecycleOwner {\n    /**\n     * Returns the Lifecycle of the provider.\n     *\n     * @return The lifecycle of the provider.\n     */\n    @NonNull\n    Lifecycle getLifecycle();\n}\n```\n\n简单来说，`LifecycleOwner` 用于提供 `Lifecycle`，`LifecycleObserver` 监听 `Lifecycle` 的状态变化，`Lifecycle` 则是 `Activity` 或 `Fragment` 生命周期状态的抽象。\n\n可以看到 `Fragment` 和 `ComponentActivity` 等实现了 `LifecycleOwner` 接口，这里我们看下 `ComponentActivity` 的实现：\n\n``` java\nprivate LifecycleRegistry mLifecycleRegistry = new LifecycleRegistry(this);\n\n@CallSuper                                                   \n@Override                                                    \nprotected void onSaveInstanceState(Bundle outState) {\n    // 这里需要注意，onSaveInstanceState 状态设置为 CREATED\n    mLifecycleRegistry.markState(Lifecycle.State.CREATED);   \n    super.onSaveInstanceState(outState);                     \n}                                                            \n\n@Override                         \npublic Lifecycle getLifecycle() { \n    return mLifecycleRegistry;    \n}\n\n@Override                                                        \n@SuppressWarnings(\"RestrictedApi\")                               \nprotected void onCreate(@Nullable Bundle savedInstanceState) {   \n    super.onCreate(savedInstanceState);                          \n    ReportFragment.injectIfNeededIn(this);                       \n}                                                                \n```\n\n可以看到代码非常简洁，那它又是怎么去实现的呢？可以看到在 `onCreate` 中会调用 `ReportFragment.injectIfNeededIn`\n\n``` java\npublic static void injectIfNeededIn(Activity activity) {                                     \n    // ProcessLifecycleOwner should always correctly work and some activities may not extend \n    // FragmentActivity from support lib, so we use framework fragments for activities       \n    android.app.FragmentManager manager = activity.getFragmentManager();                     \n    if (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == null) {                            \n        manager.beginTransaction().add(new ReportFragment(), REPORT_FRAGMENT_TAG).commit();  \n        // Hopefully, we are the first to make a transaction.                                \n        manager.executePendingTransactions();                                                \n    }                                                                                        \n}   \n```\n\n这里会添加一个 `ReportFragment` 如果有阅读过 Glide 源码的同学，应该会看到类似的实现：通过添加一个透明的 `Fragment` 会监听 `Activity` 的生命周期。\n\n``` java\n@Override                                                               \npublic void onActivityCreated(Bundle savedInstanceState) {              \n    super.onActivityCreated(savedInstanceState);                        \n    dispatchCreate(mProcessListener);                                   \n    dispatch(Lifecycle.Event.ON_CREATE);                                \n}                                                                       \n                                                                        \n@Override                                                               \npublic void onStart() {                                                 \n    super.onStart();                                                    \n    dispatchStart(mProcessListener);                                    \n    dispatch(Lifecycle.Event.ON_START);                                 \n}                                                                       \n                                                                        \n@Override                                                               \npublic void onResume() {                                                \n    super.onResume();                                                   \n    dispatchResume(mProcessListener);                                   \n    dispatch(Lifecycle.Event.ON_RESUME);                                \n}                                                                       \n                                                                        \n@Override                                                               \npublic void onPause() {                                                 \n    super.onPause();                                                    \n    dispatch(Lifecycle.Event.ON_PAUSE);                                 \n}                                                                       \n                                                                        \n@Override                                                               \npublic void onStop() {                                                  \n    super.onStop();                                                     \n    dispatch(Lifecycle.Event.ON_STOP);                                  \n}                                                                       \n                                                                        \n@Override                                                               \npublic void onDestroy() {                                               \n    super.onDestroy();                                                  \n    dispatch(Lifecycle.Event.ON_DESTROY);                               \n    // just want to be sure that we won't leak reference to an activity \n    mProcessListener = null;                                            \n}\n\nprivate void dispatch(Lifecycle.Event event) {                                         \n    Activity activity = getActivity();                                                 \n    if (activity instanceof LifecycleRegistryOwner) {                                  \n        ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);\n        return;                                                                        \n    }                                                                                  \n                                                                                       \n    if (activity instanceof LifecycleOwner) {                                          \n        Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();              \n        if (lifecycle instanceof LifecycleRegistry) {                                  \n            ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);               \n        }                                                                              \n    }                                                                                  \n}                                                                                      \n```\n\n在 `Activity` 的各种生命周期回调方法中，调用 `handleLifecycleEvent()` 分发 `Lifecycle.Event`\n\n##### handleLifecycleEvent\n\n`LifecycleRegistry` 是 `Lifecycle` 的实现类，看下 `handleLifecycleEvent` 的实现：\n\n``` java\npublic void handleLifecycleEvent(@NonNull Lifecycle.Event event) {    \n    State next = getStateAfter(event);                                \n    moveToState(next);                                                \n}                                                                     \n\n// event 和 Sate 的对应关系\nstatic State getStateAfter(Event event) {                                  \n    switch (event) {                                                       \n        case ON_CREATE:                                                    \n        case ON_STOP:                                                      \n            return CREATED;                                                \n        case ON_START:                                                     \n        case ON_PAUSE:                                                     \n            return STARTED;                                                \n        case ON_RESUME:                                                    \n            return RESUMED;                                                \n        case ON_DESTROY:                                                   \n            return DESTROYED;                                              \n        case ON_ANY:                                                       \n            break;                                                         \n    }                                                                      \n    throw new IllegalArgumentException(\"Unexpected event value \" + event); \n}                                                                          \n\nprivate void moveToState(State next) {                                \n    if (mState == next) {                                             \n        return;                                                       \n    }                                                                 \n    mState = next;                                                    \n    if (mHandlingEvent || mAddingObserverCounter != 0) {\n        // 正在处理事件中或者正在处理添加 Observer 中\n        mNewEventOccurred = true;                                     \n        // we will figure out what to do on upper level.              \n        return;                                                       \n    }\n    // 标记正在处理事件\n    mHandlingEvent = true;\n    // 同步状态\n    sync();                                                           \n    mHandlingEvent = false;                                           \n}\n\n// happens only on the top of stack (never in reentrance),                                    \n// so it doesn't have to take in account parents                                              \nprivate void sync() {\n    // 使用弱应用持有 LifecycleOwner，也是为了防止 Activity/Fragment 内存泄漏\n    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();                                    \n    if (lifecycleOwner == null) {\n        Log.w(LOG_TAG, \"LifecycleOwner is garbage collected, you shouldn't try dispatch \"     \n                + \"new events from it.\");                                                     \n        return;                                                                               \n    }                                                                                         \n    while (!isSynced()) {\n        // 如果还没完成同步\n        mNewEventOccurred = false;                                                            \n        // no need to check eldest for nullability, because isSynced does it for us.     \n        \n        // 使用 eldest(start) 判断是否需要回退 \n        // 使用 newest(end) 判断是否需要前进，刚添加的 observer 一般为初始化状态\n        if (mState.compareTo(mObserverMap.eldest().getValue().mState) < 0) {\n            // 最先添加的 observer 的状态大于当前状态，回退\n            backwardPass(lifecycleOwner);                                                     \n        }                                                                                     \n        Entry<LifecycleObserver, ObserverWithState> newest = mObserverMap.newest();           \n        if (!mNewEventOccurred && newest != null                                              \n                && mState.compareTo(newest.getValue().mState) > 0) {\n            // 最新添加的 observer 如果状态一致，则可以乐观地表示在它之前添加的 observer 状态也是一致的\n            // mNewEventOccurred 表示有新的事件发生，则放弃这次同步，延迟到下一次\n            forwardPass(lifecycleOwner);                                                      \n        }                                                                                     \n    }                                                                                         \n    mNewEventOccurred = false;                                                                \n}\n\nprivate boolean isSynced() {                                                            \n    if (mObserverMap.size() == 0) {                                                     \n        return true;                                                                    \n    }\n    // eldest 最先添加的，newest 最新添加的\n    State eldestObserverState = mObserverMap.eldest().getValue().mState;                \n    State newestObserverState = mObserverMap.newest().getValue().mState;\n    // 判断状态是否一致\n    return eldestObserverState == newestObserverState && mState == newestObserverState; \n}                                                                                       \n```\n\n使用 `sync()` 同步状态，这里分为两种情况，一种是需要回退状态（backward），另外一种则是需要前进（forward），其中 `backward` 代码如下：\n\n``` java\nprivate void backwardPass(LifecycleOwner lifecycleOwner) {\n    // 使用 eldest(start) 判断是否需要回退 \n    // 降序迭代，end -> start\n    Iterator<Entry<LifecycleObserver, ObserverWithState>> descendingIterator =         \n            mObserverMap.descendingIterator();                                         \n    while (descendingIterator.hasNext() && !mNewEventOccurred) {\n        // mNewEventOccurred 判断是否有新事件分发\n        Entry<LifecycleObserver, ObserverWithState> entry = descendingIterator.next(); \n        ObserverWithState observer = entry.getValue();                                 \n        while ((observer.mState.compareTo(mState) > 0 && !mNewEventOccurred            \n                && mObserverMap.contains(entry.getKey()))) {\n            // 回退\n            // 举个例子：observer.state 为 RESUMED\n            // mState 为 CREATED\n            // downEvent(observer.state) 为 ON_PAUSE\n            Event event = downEvent(observer.mState);\n            // getStateAfter(event) 为 STARTED\n            // 最终：RESUMED -> STARTED，在下一次同步中再同步为 CREATED\n            // pushParentState 和 popParentState 则是将 state 暂存在 List 中，这个作用我们会在 addObserver 中讲\n            pushParentState(getStateAfter(event));\n            // 分发事件\n            observer.dispatchEvent(lifecycleOwner, event);                             \n            popParentState();                                                          \n        }                                                                              \n    }                                                                                  \n}\n\nprivate static Event downEvent(State state) {                             \n    switch (state) {                                                      \n        case INITIALIZED:                                                 \n            throw new IllegalArgumentException();                         \n        case CREATED:                                                     \n            return ON_DESTROY;                                            \n        case STARTED:                                                     \n            return ON_STOP;                                               \n        case RESUMED:                                                     \n            return ON_PAUSE;                                              \n        case DESTROYED:                                                   \n            throw new IllegalArgumentException();                         \n    }                                                                     \n    throw new IllegalArgumentException(\"Unexpected state value \" + state);\n} \n\nstatic State getStateAfter(Event event) {                                   \n    switch (event) {                                                        \n        case ON_CREATE:                                                     \n        case ON_STOP:                                                       \n            return CREATED;                                                 \n        case ON_START:                                                      \n        case ON_PAUSE:                                                      \n            return STARTED;                                                 \n        case ON_RESUME:                                                     \n            return RESUMED;                                                 \n        case ON_DESTROY:                                                    \n            return DESTROYED;                                               \n        case ON_ANY:                                                        \n            break;                                                          \n    }                                                                       \n    throw new IllegalArgumentException(\"Unexpected event value \" + event);  \n}\n\n// ObserverWithState.java\nvoid dispatchEvent(LifecycleOwner owner, Event event) { \n    State newState = getStateAfter(event);\n    // 使用较小的状态同步\n    mState = min(mState, newState);                     \n    mLifecycleObserver.onStateChanged(owner, event);    \n    mState = newState;                                  \n}                                                       \n```\n\n总结下 `backwardPass()` 的逻辑：将较大的状态逐步回退。为什么说是逐步呢？比如 `observer.state` 是 `RESUMED`，当前状态是 `CREATED`，那这里会分两次回退，分别为：`RESUMED -> STARTED` 和 `STARTED -> CREATED`\n\n`forwardPass()` 逻辑类似，则不分析了。\n\n##### addObserver\n\n`addObserver()` 是添加 `Observer` 的方法，源码如下：\n\n``` java\n@Override                                                                                 \npublic void addObserver(@NonNull LifecycleObserver observer) {\n    // 如果不是 DESTROYED，则从 INITIALIZED 开始分发\n    State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;\n    // ObserverWithState 用于分发事件给 observer\n    ObserverWithState statefulObserver = new ObserverWithState(observer, initialState);   \n    ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);    \n                                                                                          \n    if (previous != null) { \n        // 唯一性\n        return;                                                                           \n    }                                                                                     \n    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();                                \n    if (lifecycleOwner == null) {  \n        // mLifecycleOwner 为弱引用\n        // it is null we should be destroyed. Fallback quickly                            \n        return;                                                                           \n    }                                                                                     \n    \n    // isReentrance 表示是否在分发事件时新添加了 observer\n    // 举个例子：在 observer 在 onStart() 中又调用了 addObserver()\n    boolean isReentrance = mAddingObserverCounter != 0 || mHandlingEvent; \n    // 计算需要分发的状态\n    State targetState = calculateTargetState(observer);                                   \n    mAddingObserverCounter++; \n    // 将事件逐步分发到 targetState\n    while ((statefulObserver.mState.compareTo(targetState) < 0                            \n            && mObserverMap.contains(observer))) {\n        // 如果 statefulObserver.state 小于 targetState\n        pushParentState(statefulObserver.mState);\n        // 如果 state 为 STARTED，则 upEvent(state) 则为 ON_RESUME\n        statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState)); \n        popParentState();                                                                 \n        // mState / subling may have been changed recalculate                             \n        targetState = calculateTargetState(observer);                                     \n    }                                                                                     \n                                                                                          \n    if (!isReentrance) {                                                                  \n        // we do sync only on the top level.\n        // 当前为重入，则不进行同步\n        sync();                                                                           \n    }                                                                                     \n    mAddingObserverCounter--;                                                             \n}\n\nprivate static Event upEvent(State state) {                                  \n    switch (state) {                                                         \n        case INITIALIZED:                                                    \n        case DESTROYED:                                                      \n            return ON_CREATE;                                                \n        case CREATED:                                                        \n            return ON_START;                                                 \n        case STARTED:                                                        \n            return ON_RESUME;                                                \n        case RESUMED:                                                        \n            throw new IllegalArgumentException();                            \n    }                                                                        \n    throw new IllegalArgumentException(\"Unexpected state value \" + state);   \n}                                                                            \n\nprivate State calculateTargetState(LifecycleObserver observer) {\n    // 获取上一个添加的 observer\n    Entry<LifecycleObserver, ObserverWithState> previous = mObserverMap.ceil(observer);       \n\t\n    State siblingState = previous != null ? previous.getValue().mState : null;\n    // mParentStates 是个 List，它的添加和删除分别由 pushParentState() 和 popParentState()，它们是成对出现的，在 dispatchEvent 的前后\n    // 在这种 case 下，会存在 parentState：在 dispatchEvent 时，又调用了 addObserver()，即上面说的 isReentrance\n    State parentState = !mParentStates.isEmpty() ? mParentStates.get(mParentStates.size() - 1)\n            : null;\n    // 这里的计算是获取更合适的状态\n    // 考虑以下这种 case：某个 observer 在 onStart() 中再调用 addObserver，那这个 observer 理应使用 STARTED 状态分发，而当前状态即 mState 可能是 RESUMED，再在 sync() 中进行同步\n    return min(min(mState, siblingState), parentState);                                       \n}                                                                                             \n```\n\n`addObserver()` 主要考虑了 Reentrance 的情况，即在 `observer` 的事件分发中，又添加了新的 `observer` 的情况。\n\n#### ProcessLifecycleOwner\n\n`ProcessLifecycleOwner` 提供应用进程的生命周期。跟 `Activity` 和 `Fragment` 的生命周期不一样的是：\n\n* `ON_CREATE` 只会分发一次\n*  `ON_DESTROY` 则不会被分发\n* `ON_START` 和 `ON_RESUME` 在第一个 `Activity` 的时候分发\n* `ON_PAUSE` 和 `ON_STOP` 则在最后一个 `Activity` 的时候**延迟**分发，用于防止因为配置改变，而导致 `Activity` 重建\n\n下面我们来分析下 `ProcessLifecycleOwner` 的源码，首先看下 `init()`：\n\n``` java\n\n// 单例\nprivate static final ProcessLifecycleOwner sInstance = new ProcessLifecycleOwner();\n\nstatic void init(Context context) {\n    // 调用 attach\n    sInstance.attach(context);      \n}                                   \n\nvoid attach(Context context) {                                                          \n    mHandler = new Handler();\n    // 同样是使用 LifecycleRegistry 来处理\n    // 先分发 ON_CREATE，而且只会分发一次\n    mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);                          \n    Application app = (Application) context.getApplicationContext();\n    app.registerActivityLifecycleCallbacks(new EmptyActivityLifecycleCallbacks() {      \n        @Override                                                                       \n        public void onActivityCreated(Activity activity, Bundle savedInstanceState) {   \n            ReportFragment.get(activity).setProcessListener(mInitializationListener);   \n        }                                                                               \n                                                                                        \n        @Override                                                                       \n        public void onActivityPaused(Activity activity) {                               \n            activityPaused();                                                           \n        }                                                                               \n                                                                                        \n        @Override                                                                       \n        public void onActivityStopped(Activity activity) {                              \n            activityStopped();                                                          \n        }                                                                               \n    });                                                                                 \n}\n\nActivityInitializationListener mInitializationListener =      \n        new ActivityInitializationListener() {                \n            @Override                                         \n            public void onCreate() {                          \n            }                                                 \n                                                              \n            @Override                                         \n            public void onStart() {                           \n                activityStarted();                            \n            }                                                 \n                                                              \n            @Override                                         \n            public void onResume() {                          \n                activityResumed();                            \n            }                                                 \n        };\n\n      \n                                                 \n// ground truth counters                         \nprivate int mStartedCounter = 0;                 \nprivate int mResumedCounter = 0;                 \n                                                 \nprivate boolean mPauseSent = true;               \nprivate boolean mStopSent = true;                \n\nvoid activityStarted() {\n    // 计数\n    mStartedCounter++;                                            \n    if (mStartedCounter == 1 && mStopSent) {\n        // 第一次调用，分发 ON_START\n        // mStopSent 为 true 的情况：\n        // 1. 默认为 true\n        // 2. dispatchStopIfNeeded 中设置\n        // 防止因为配置改变，Activity 创建而导致重新分发\n        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START); \n        mStopSent = false;                                        \n    }                                                             \n}\n\n void activityResumed() {                                               \n     mResumedCounter++;                                                 \n     if (mResumedCounter == 1) {                                        \n         if (mPauseSent) {\n             // 第一次调用分发 ON_RESUME\n             mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME); \n             mPauseSent = false;                                        \n         } else { \n             // 配置改变，Activity 创建，删除延迟的 pause runnable\n             mHandler.removeCallbacks(mDelayedPauseRunnable);           \n         }                                                              \n     }                                                                  \n }                                                                      \n```\n\n上面是初始事件分发流程，下面我们来看下 `ON_PAUSE` 和 `ON_STOP` 的分发：\n\n``` java\n@VisibleForTesting                               \nstatic final long TIMEOUT_MS = 700; //mls \n\n// 在 onActivityPaused 中调用\nvoid activityPaused() {\n    // 计数\n    mResumedCounter--;                                              \n    if (mResumedCounter == 0) {\n        // 延迟分发\n        mHandler.postDelayed(mDelayedPauseRunnable, TIMEOUT_MS);    \n    }                                                               \n}\n \nprivate Runnable mDelayedPauseRunnable = new Runnable() { \n    @Override                                             \n    public void run() { \n        // 延迟分发\n        dispatchPauseIfNeeded();                          \n        dispatchStopIfNeeded();                           \n    }                                                     \n};                                                        \n\nvoid activityStopped() { \n    // 计数\n    mStartedCounter--;                                              \n    dispatchStopIfNeeded();                                         \n}                                                                   \n                                                                    \nvoid dispatchPauseIfNeeded() {\n    if (mResumedCounter == 0) {\n        // 计数\n        mPauseSent = true;\n        // 分发 ON_PAUSE\n        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);   \n    }                                                               \n}                                                                   \n                                                                    \nvoid dispatchStopIfNeeded() {                                       \n    if (mStartedCounter == 0 && mPauseSent) {\n        // 计数为 0，同时已经分发了 ON_PAUSE\n        // 分发 ON_STOP\n        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_STOP);    \n        mStopSent = true;                                           \n    }                                                               \n}                                                                   \n```\n\n到这里，我们已经将 `ProcessLifecycleOwner` 的流程分析完了，那 `ProcessLifecycleOwner.init()` 是在那里调用的呢？\n\n其实是用了一种比较巧妙的方法，在 `lifecycle-process` 这个包下的 `AndroidManifest.xml` 文件中，可以看到有如下配置：\n\n``` xml\n<application>\n        <provider\n            android:name=\"androidx.lifecycle.ProcessLifecycleOwnerInitializer\"\n            android:authorities=\"${applicationId}.lifecycle-process\"\n            android:exported=\"false\"\n            android:multiprocess=\"true\" />\n</application>\n```\n\n其中 `ProcessLifecycleOwnerInitializer` 是一个 `ContentProvider` 即利用 `ContentProvider` 来实现自动初始化\n\n> ContentProvider 的 `onCreate` 方法会在应用启动时候调用\n>\n> Implement this to initialize your content provider on startup. This method is called for all registered content providers on the application main thread at application launch time. It must not perform lengthy operations, or application startup will be delayed.\n\n``` java\n@Override                                     \npublic boolean onCreate() {                   \n    LifecycleDispatcher.init(getContext());   \n    ProcessLifecycleOwner.init(getContext()); \n    return true;                              \n}                                             \n```\n\n可以看到这里调用了两个初始化方法，其中 `ProcessLifecycleOwner.init()` 我们已经分析了，再看看 `LifecycleDispatcher.init()`\n\n``` java\nstatic void init(Context context) {                                                 \n    if (sInitialized.getAndSet(true)) {                                             \n        return;                                                                     \n    }                                                                               \n    ((Application) context.getApplicationContext())                                 \n            .registerActivityLifecycleCallbacks(new DispatcherActivityCallback());  \n}                                                                                   \n                                                                                    \n@SuppressWarnings(\"WeakerAccess\")                                                   \n@VisibleForTesting                                                                  \nstatic class DispatcherActivityCallback extends EmptyActivityLifecycleCallbacks {   \n                                                                                    \n    @Override                                                                       \n    public void onActivityCreated(Activity activity, Bundle savedInstanceState) {   \n        ReportFragment.injectIfNeededIn(activity);                                  \n    }                                                                               \n                                                                                    \n    @Override                                                                       \n    public void onActivityStopped(Activity activity) {                              \n    }                                                                               \n                                                                                    \n    @Override                                                                       \n    public void onActivitySaveInstanceState(Activity activity, Bundle outState) {   \n    }                                                                               \n}                                                                                   \n```\n\n初始化的逻辑比较简单，即在 `Activity` 创建时，调用 `ReportFragment.injectIfneededIn()` ，其实我们在 `Activity` 的 `Lifecycle` 处理中，也见到这个方法： \n\n``` java                                                       \n// ComponentActivity.java\n@Override                                                        \n@SuppressWarnings(\"RestrictedApi\")                               \nprotected void onCreate(@Nullable Bundle savedInstanceState) {   \n    super.onCreate(savedInstanceState);                          \n    ReportFragment.injectIfNeededIn(this);                       \n}\n\n// ReportFragment.java\npublic static void injectIfNeededIn(Activity activity) {                                      \n    // ProcessLifecycleOwner should always correctly work and some activities may not extend  \n    // FragmentActivity from support lib, so we use framework fragments for activities        \n    android.app.FragmentManager manager = activity.getFragmentManager();                      \n    if (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == null) {\n        // 重复添加判断\n        manager.beginTransaction().add(new ReportFragment(), REPORT_FRAGMENT_TAG).commit();   \n        // Hopefully, we are the first to make a transaction.                                 \n        manager.executePendingTransactions();                                                 \n    }                                                                                         \n}                                                                                             \n```\n\n这里可以理解为双重保障吧，可能存在不继承 `ComponentActivity` 的 `Activity`。\n\n### 总结\n\n分析了 `Lifecycle`  的整个流程，可以发现其实逻辑还是比较简单的，实现上也是参考了其他开源库的做法，比如 `ReportFragment` 通过添加一个透明的 `Fragment` 去感知 `Activity` 的生命周期，`Glide` 也是这么做的。还有使用 `ContentProvider` 去实现在 `Application` 创建时自动初始化，也是一个不错的想法。\n\n`Lifecycle` 的源码比我一开始想象的复杂，不是在于它的逻辑，而是在 `sync()` 这一块，通过 `Listener` 执行状态回调是一个非常常见的做法，但是有很多需要考虑的 case，举个例子，在分发回调时，有新的状态发生，那么应该怎么去处理。或者，在回调方法中，又添加了新的 `Listener`，那应该怎么处理。\n\n学习源码，不仅仅是学习实现原理，还可以学习一个健壮的库是如何处理各种场景下的 case 的。","source":"_posts/Jetpack中的Lifecycle.md","raw":"---\ntitle: Jetpack中的Lifecycle\ndate: 2019-01-14 15:57:11\ncategories: Android\ntags: Jetpack\n---\n\n### 关于本文\n\n有很多项目都会使用 MVP 这种项目架构，使用 Presenter 来减轻 `Activity` 的负担，具体的 `MVP` 实现可以阅读 Google 推出的 [android-architecture](https://github.com/googlesamples/android-architecture)。\n\n一般使用 MVP，都会遇到一个问题，如何将 Presenter 和 View 的生命周期进行绑定，常见的做法是，在 `Activity` 的生命周期中手动调用 Presenter 的回调方法，更复杂的做法可能需要在 Presenter 或者 View 维护一个操作栈，在指定生命周期中去执行操作。\n\n### 关于Lifecycle\n\n[lifecycle](https://developer.android.com/topic/libraries/architecture/lifecycle) 是 Google 推出的用于响应 `Activity` 和 `Fragment` 生命周期改变的库。\n\n**These components help you produce better-organized, and often lighter-weight code, that is easier to maintain.**\n\n#### Lifecycle\n\n`Lifecycle` 是一个包含比如 `Activity` 或 `Fragment` 生命周期状态的类，同时允许其他对象去订阅这些状态\n\n`Lifecycle` 使用 Event 和 State 来管理生命周期状态的变化\n\n##### Event\n\n生命周期变化的事件\n\n##### State\n\n当前生命周期的状态\n\n使用 Google 文档中图片来表示这两者的关系：\n\n![lifecycle-states](https://developer.android.com/images/topic/libraries/architecture/lifecycle-states.png)\n\n我们可以调用 `addObserver` 去注册一个监听者\n\n``` kotlin\nlifecycle.addObserver(presenter)\n```\n\n而 `presenter` 则需要实现 `LifecycleObserver` 接口，具体的回调方法则通过注解的形式：\n\n``` kotlin\nclass Presenter : LifecycleObserver {\n\n    @OnLifecycleEvent(Lifecycle.Event.ON_START)\n    fun onStart() {\n\n    }\n\n    @OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)\n    fun onDestroy() {\n\n    }\n\n}\n```\n\n当然我们也可以调用 `getCurrentState()` 来获取 `Lifecycle` 当前的状态\n\n#### LifecycleOwner\n\n上面我们简单介绍了 `Lifecyle` 和 `LifecycleObserver`  的作用和关系之后，再来看下 `getLifecycle` 这个方法：\n\n> 因为上面的例子是用 kotlin 写的，所以 `lifecycle.addObserver` 实际上应该为 `getLifecycle().addObserver()`\n\n``` java\npublic interface LifecycleOwner {\n    /**\n     * Returns the Lifecycle of the provider.\n     *\n     * @return The lifecycle of the provider.\n     */\n    @NonNull\n    Lifecycle getLifecycle();\n}\n```\n\n简单来说，`LifecycleOwner` 用于提供 `Lifecycle`，`LifecycleObserver` 监听 `Lifecycle` 的状态变化，`Lifecycle` 则是 `Activity` 或 `Fragment` 生命周期状态的抽象。\n\n可以看到 `Fragment` 和 `ComponentActivity` 等实现了 `LifecycleOwner` 接口，这里我们看下 `ComponentActivity` 的实现：\n\n``` java\nprivate LifecycleRegistry mLifecycleRegistry = new LifecycleRegistry(this);\n\n@CallSuper                                                   \n@Override                                                    \nprotected void onSaveInstanceState(Bundle outState) {\n    // 这里需要注意，onSaveInstanceState 状态设置为 CREATED\n    mLifecycleRegistry.markState(Lifecycle.State.CREATED);   \n    super.onSaveInstanceState(outState);                     \n}                                                            \n\n@Override                         \npublic Lifecycle getLifecycle() { \n    return mLifecycleRegistry;    \n}\n\n@Override                                                        \n@SuppressWarnings(\"RestrictedApi\")                               \nprotected void onCreate(@Nullable Bundle savedInstanceState) {   \n    super.onCreate(savedInstanceState);                          \n    ReportFragment.injectIfNeededIn(this);                       \n}                                                                \n```\n\n可以看到代码非常简洁，那它又是怎么去实现的呢？可以看到在 `onCreate` 中会调用 `ReportFragment.injectIfNeededIn`\n\n``` java\npublic static void injectIfNeededIn(Activity activity) {                                     \n    // ProcessLifecycleOwner should always correctly work and some activities may not extend \n    // FragmentActivity from support lib, so we use framework fragments for activities       \n    android.app.FragmentManager manager = activity.getFragmentManager();                     \n    if (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == null) {                            \n        manager.beginTransaction().add(new ReportFragment(), REPORT_FRAGMENT_TAG).commit();  \n        // Hopefully, we are the first to make a transaction.                                \n        manager.executePendingTransactions();                                                \n    }                                                                                        \n}   \n```\n\n这里会添加一个 `ReportFragment` 如果有阅读过 Glide 源码的同学，应该会看到类似的实现：通过添加一个透明的 `Fragment` 会监听 `Activity` 的生命周期。\n\n``` java\n@Override                                                               \npublic void onActivityCreated(Bundle savedInstanceState) {              \n    super.onActivityCreated(savedInstanceState);                        \n    dispatchCreate(mProcessListener);                                   \n    dispatch(Lifecycle.Event.ON_CREATE);                                \n}                                                                       \n                                                                        \n@Override                                                               \npublic void onStart() {                                                 \n    super.onStart();                                                    \n    dispatchStart(mProcessListener);                                    \n    dispatch(Lifecycle.Event.ON_START);                                 \n}                                                                       \n                                                                        \n@Override                                                               \npublic void onResume() {                                                \n    super.onResume();                                                   \n    dispatchResume(mProcessListener);                                   \n    dispatch(Lifecycle.Event.ON_RESUME);                                \n}                                                                       \n                                                                        \n@Override                                                               \npublic void onPause() {                                                 \n    super.onPause();                                                    \n    dispatch(Lifecycle.Event.ON_PAUSE);                                 \n}                                                                       \n                                                                        \n@Override                                                               \npublic void onStop() {                                                  \n    super.onStop();                                                     \n    dispatch(Lifecycle.Event.ON_STOP);                                  \n}                                                                       \n                                                                        \n@Override                                                               \npublic void onDestroy() {                                               \n    super.onDestroy();                                                  \n    dispatch(Lifecycle.Event.ON_DESTROY);                               \n    // just want to be sure that we won't leak reference to an activity \n    mProcessListener = null;                                            \n}\n\nprivate void dispatch(Lifecycle.Event event) {                                         \n    Activity activity = getActivity();                                                 \n    if (activity instanceof LifecycleRegistryOwner) {                                  \n        ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);\n        return;                                                                        \n    }                                                                                  \n                                                                                       \n    if (activity instanceof LifecycleOwner) {                                          \n        Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();              \n        if (lifecycle instanceof LifecycleRegistry) {                                  \n            ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);               \n        }                                                                              \n    }                                                                                  \n}                                                                                      \n```\n\n在 `Activity` 的各种生命周期回调方法中，调用 `handleLifecycleEvent()` 分发 `Lifecycle.Event`\n\n##### handleLifecycleEvent\n\n`LifecycleRegistry` 是 `Lifecycle` 的实现类，看下 `handleLifecycleEvent` 的实现：\n\n``` java\npublic void handleLifecycleEvent(@NonNull Lifecycle.Event event) {    \n    State next = getStateAfter(event);                                \n    moveToState(next);                                                \n}                                                                     \n\n// event 和 Sate 的对应关系\nstatic State getStateAfter(Event event) {                                  \n    switch (event) {                                                       \n        case ON_CREATE:                                                    \n        case ON_STOP:                                                      \n            return CREATED;                                                \n        case ON_START:                                                     \n        case ON_PAUSE:                                                     \n            return STARTED;                                                \n        case ON_RESUME:                                                    \n            return RESUMED;                                                \n        case ON_DESTROY:                                                   \n            return DESTROYED;                                              \n        case ON_ANY:                                                       \n            break;                                                         \n    }                                                                      \n    throw new IllegalArgumentException(\"Unexpected event value \" + event); \n}                                                                          \n\nprivate void moveToState(State next) {                                \n    if (mState == next) {                                             \n        return;                                                       \n    }                                                                 \n    mState = next;                                                    \n    if (mHandlingEvent || mAddingObserverCounter != 0) {\n        // 正在处理事件中或者正在处理添加 Observer 中\n        mNewEventOccurred = true;                                     \n        // we will figure out what to do on upper level.              \n        return;                                                       \n    }\n    // 标记正在处理事件\n    mHandlingEvent = true;\n    // 同步状态\n    sync();                                                           \n    mHandlingEvent = false;                                           \n}\n\n// happens only on the top of stack (never in reentrance),                                    \n// so it doesn't have to take in account parents                                              \nprivate void sync() {\n    // 使用弱应用持有 LifecycleOwner，也是为了防止 Activity/Fragment 内存泄漏\n    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();                                    \n    if (lifecycleOwner == null) {\n        Log.w(LOG_TAG, \"LifecycleOwner is garbage collected, you shouldn't try dispatch \"     \n                + \"new events from it.\");                                                     \n        return;                                                                               \n    }                                                                                         \n    while (!isSynced()) {\n        // 如果还没完成同步\n        mNewEventOccurred = false;                                                            \n        // no need to check eldest for nullability, because isSynced does it for us.     \n        \n        // 使用 eldest(start) 判断是否需要回退 \n        // 使用 newest(end) 判断是否需要前进，刚添加的 observer 一般为初始化状态\n        if (mState.compareTo(mObserverMap.eldest().getValue().mState) < 0) {\n            // 最先添加的 observer 的状态大于当前状态，回退\n            backwardPass(lifecycleOwner);                                                     \n        }                                                                                     \n        Entry<LifecycleObserver, ObserverWithState> newest = mObserverMap.newest();           \n        if (!mNewEventOccurred && newest != null                                              \n                && mState.compareTo(newest.getValue().mState) > 0) {\n            // 最新添加的 observer 如果状态一致，则可以乐观地表示在它之前添加的 observer 状态也是一致的\n            // mNewEventOccurred 表示有新的事件发生，则放弃这次同步，延迟到下一次\n            forwardPass(lifecycleOwner);                                                      \n        }                                                                                     \n    }                                                                                         \n    mNewEventOccurred = false;                                                                \n}\n\nprivate boolean isSynced() {                                                            \n    if (mObserverMap.size() == 0) {                                                     \n        return true;                                                                    \n    }\n    // eldest 最先添加的，newest 最新添加的\n    State eldestObserverState = mObserverMap.eldest().getValue().mState;                \n    State newestObserverState = mObserverMap.newest().getValue().mState;\n    // 判断状态是否一致\n    return eldestObserverState == newestObserverState && mState == newestObserverState; \n}                                                                                       \n```\n\n使用 `sync()` 同步状态，这里分为两种情况，一种是需要回退状态（backward），另外一种则是需要前进（forward），其中 `backward` 代码如下：\n\n``` java\nprivate void backwardPass(LifecycleOwner lifecycleOwner) {\n    // 使用 eldest(start) 判断是否需要回退 \n    // 降序迭代，end -> start\n    Iterator<Entry<LifecycleObserver, ObserverWithState>> descendingIterator =         \n            mObserverMap.descendingIterator();                                         \n    while (descendingIterator.hasNext() && !mNewEventOccurred) {\n        // mNewEventOccurred 判断是否有新事件分发\n        Entry<LifecycleObserver, ObserverWithState> entry = descendingIterator.next(); \n        ObserverWithState observer = entry.getValue();                                 \n        while ((observer.mState.compareTo(mState) > 0 && !mNewEventOccurred            \n                && mObserverMap.contains(entry.getKey()))) {\n            // 回退\n            // 举个例子：observer.state 为 RESUMED\n            // mState 为 CREATED\n            // downEvent(observer.state) 为 ON_PAUSE\n            Event event = downEvent(observer.mState);\n            // getStateAfter(event) 为 STARTED\n            // 最终：RESUMED -> STARTED，在下一次同步中再同步为 CREATED\n            // pushParentState 和 popParentState 则是将 state 暂存在 List 中，这个作用我们会在 addObserver 中讲\n            pushParentState(getStateAfter(event));\n            // 分发事件\n            observer.dispatchEvent(lifecycleOwner, event);                             \n            popParentState();                                                          \n        }                                                                              \n    }                                                                                  \n}\n\nprivate static Event downEvent(State state) {                             \n    switch (state) {                                                      \n        case INITIALIZED:                                                 \n            throw new IllegalArgumentException();                         \n        case CREATED:                                                     \n            return ON_DESTROY;                                            \n        case STARTED:                                                     \n            return ON_STOP;                                               \n        case RESUMED:                                                     \n            return ON_PAUSE;                                              \n        case DESTROYED:                                                   \n            throw new IllegalArgumentException();                         \n    }                                                                     \n    throw new IllegalArgumentException(\"Unexpected state value \" + state);\n} \n\nstatic State getStateAfter(Event event) {                                   \n    switch (event) {                                                        \n        case ON_CREATE:                                                     \n        case ON_STOP:                                                       \n            return CREATED;                                                 \n        case ON_START:                                                      \n        case ON_PAUSE:                                                      \n            return STARTED;                                                 \n        case ON_RESUME:                                                     \n            return RESUMED;                                                 \n        case ON_DESTROY:                                                    \n            return DESTROYED;                                               \n        case ON_ANY:                                                        \n            break;                                                          \n    }                                                                       \n    throw new IllegalArgumentException(\"Unexpected event value \" + event);  \n}\n\n// ObserverWithState.java\nvoid dispatchEvent(LifecycleOwner owner, Event event) { \n    State newState = getStateAfter(event);\n    // 使用较小的状态同步\n    mState = min(mState, newState);                     \n    mLifecycleObserver.onStateChanged(owner, event);    \n    mState = newState;                                  \n}                                                       \n```\n\n总结下 `backwardPass()` 的逻辑：将较大的状态逐步回退。为什么说是逐步呢？比如 `observer.state` 是 `RESUMED`，当前状态是 `CREATED`，那这里会分两次回退，分别为：`RESUMED -> STARTED` 和 `STARTED -> CREATED`\n\n`forwardPass()` 逻辑类似，则不分析了。\n\n##### addObserver\n\n`addObserver()` 是添加 `Observer` 的方法，源码如下：\n\n``` java\n@Override                                                                                 \npublic void addObserver(@NonNull LifecycleObserver observer) {\n    // 如果不是 DESTROYED，则从 INITIALIZED 开始分发\n    State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;\n    // ObserverWithState 用于分发事件给 observer\n    ObserverWithState statefulObserver = new ObserverWithState(observer, initialState);   \n    ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);    \n                                                                                          \n    if (previous != null) { \n        // 唯一性\n        return;                                                                           \n    }                                                                                     \n    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();                                \n    if (lifecycleOwner == null) {  \n        // mLifecycleOwner 为弱引用\n        // it is null we should be destroyed. Fallback quickly                            \n        return;                                                                           \n    }                                                                                     \n    \n    // isReentrance 表示是否在分发事件时新添加了 observer\n    // 举个例子：在 observer 在 onStart() 中又调用了 addObserver()\n    boolean isReentrance = mAddingObserverCounter != 0 || mHandlingEvent; \n    // 计算需要分发的状态\n    State targetState = calculateTargetState(observer);                                   \n    mAddingObserverCounter++; \n    // 将事件逐步分发到 targetState\n    while ((statefulObserver.mState.compareTo(targetState) < 0                            \n            && mObserverMap.contains(observer))) {\n        // 如果 statefulObserver.state 小于 targetState\n        pushParentState(statefulObserver.mState);\n        // 如果 state 为 STARTED，则 upEvent(state) 则为 ON_RESUME\n        statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState)); \n        popParentState();                                                                 \n        // mState / subling may have been changed recalculate                             \n        targetState = calculateTargetState(observer);                                     \n    }                                                                                     \n                                                                                          \n    if (!isReentrance) {                                                                  \n        // we do sync only on the top level.\n        // 当前为重入，则不进行同步\n        sync();                                                                           \n    }                                                                                     \n    mAddingObserverCounter--;                                                             \n}\n\nprivate static Event upEvent(State state) {                                  \n    switch (state) {                                                         \n        case INITIALIZED:                                                    \n        case DESTROYED:                                                      \n            return ON_CREATE;                                                \n        case CREATED:                                                        \n            return ON_START;                                                 \n        case STARTED:                                                        \n            return ON_RESUME;                                                \n        case RESUMED:                                                        \n            throw new IllegalArgumentException();                            \n    }                                                                        \n    throw new IllegalArgumentException(\"Unexpected state value \" + state);   \n}                                                                            \n\nprivate State calculateTargetState(LifecycleObserver observer) {\n    // 获取上一个添加的 observer\n    Entry<LifecycleObserver, ObserverWithState> previous = mObserverMap.ceil(observer);       \n\t\n    State siblingState = previous != null ? previous.getValue().mState : null;\n    // mParentStates 是个 List，它的添加和删除分别由 pushParentState() 和 popParentState()，它们是成对出现的，在 dispatchEvent 的前后\n    // 在这种 case 下，会存在 parentState：在 dispatchEvent 时，又调用了 addObserver()，即上面说的 isReentrance\n    State parentState = !mParentStates.isEmpty() ? mParentStates.get(mParentStates.size() - 1)\n            : null;\n    // 这里的计算是获取更合适的状态\n    // 考虑以下这种 case：某个 observer 在 onStart() 中再调用 addObserver，那这个 observer 理应使用 STARTED 状态分发，而当前状态即 mState 可能是 RESUMED，再在 sync() 中进行同步\n    return min(min(mState, siblingState), parentState);                                       \n}                                                                                             \n```\n\n`addObserver()` 主要考虑了 Reentrance 的情况，即在 `observer` 的事件分发中，又添加了新的 `observer` 的情况。\n\n#### ProcessLifecycleOwner\n\n`ProcessLifecycleOwner` 提供应用进程的生命周期。跟 `Activity` 和 `Fragment` 的生命周期不一样的是：\n\n* `ON_CREATE` 只会分发一次\n*  `ON_DESTROY` 则不会被分发\n* `ON_START` 和 `ON_RESUME` 在第一个 `Activity` 的时候分发\n* `ON_PAUSE` 和 `ON_STOP` 则在最后一个 `Activity` 的时候**延迟**分发，用于防止因为配置改变，而导致 `Activity` 重建\n\n下面我们来分析下 `ProcessLifecycleOwner` 的源码，首先看下 `init()`：\n\n``` java\n\n// 单例\nprivate static final ProcessLifecycleOwner sInstance = new ProcessLifecycleOwner();\n\nstatic void init(Context context) {\n    // 调用 attach\n    sInstance.attach(context);      \n}                                   \n\nvoid attach(Context context) {                                                          \n    mHandler = new Handler();\n    // 同样是使用 LifecycleRegistry 来处理\n    // 先分发 ON_CREATE，而且只会分发一次\n    mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);                          \n    Application app = (Application) context.getApplicationContext();\n    app.registerActivityLifecycleCallbacks(new EmptyActivityLifecycleCallbacks() {      \n        @Override                                                                       \n        public void onActivityCreated(Activity activity, Bundle savedInstanceState) {   \n            ReportFragment.get(activity).setProcessListener(mInitializationListener);   \n        }                                                                               \n                                                                                        \n        @Override                                                                       \n        public void onActivityPaused(Activity activity) {                               \n            activityPaused();                                                           \n        }                                                                               \n                                                                                        \n        @Override                                                                       \n        public void onActivityStopped(Activity activity) {                              \n            activityStopped();                                                          \n        }                                                                               \n    });                                                                                 \n}\n\nActivityInitializationListener mInitializationListener =      \n        new ActivityInitializationListener() {                \n            @Override                                         \n            public void onCreate() {                          \n            }                                                 \n                                                              \n            @Override                                         \n            public void onStart() {                           \n                activityStarted();                            \n            }                                                 \n                                                              \n            @Override                                         \n            public void onResume() {                          \n                activityResumed();                            \n            }                                                 \n        };\n\n      \n                                                 \n// ground truth counters                         \nprivate int mStartedCounter = 0;                 \nprivate int mResumedCounter = 0;                 \n                                                 \nprivate boolean mPauseSent = true;               \nprivate boolean mStopSent = true;                \n\nvoid activityStarted() {\n    // 计数\n    mStartedCounter++;                                            \n    if (mStartedCounter == 1 && mStopSent) {\n        // 第一次调用，分发 ON_START\n        // mStopSent 为 true 的情况：\n        // 1. 默认为 true\n        // 2. dispatchStopIfNeeded 中设置\n        // 防止因为配置改变，Activity 创建而导致重新分发\n        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START); \n        mStopSent = false;                                        \n    }                                                             \n}\n\n void activityResumed() {                                               \n     mResumedCounter++;                                                 \n     if (mResumedCounter == 1) {                                        \n         if (mPauseSent) {\n             // 第一次调用分发 ON_RESUME\n             mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME); \n             mPauseSent = false;                                        \n         } else { \n             // 配置改变，Activity 创建，删除延迟的 pause runnable\n             mHandler.removeCallbacks(mDelayedPauseRunnable);           \n         }                                                              \n     }                                                                  \n }                                                                      \n```\n\n上面是初始事件分发流程，下面我们来看下 `ON_PAUSE` 和 `ON_STOP` 的分发：\n\n``` java\n@VisibleForTesting                               \nstatic final long TIMEOUT_MS = 700; //mls \n\n// 在 onActivityPaused 中调用\nvoid activityPaused() {\n    // 计数\n    mResumedCounter--;                                              \n    if (mResumedCounter == 0) {\n        // 延迟分发\n        mHandler.postDelayed(mDelayedPauseRunnable, TIMEOUT_MS);    \n    }                                                               \n}\n \nprivate Runnable mDelayedPauseRunnable = new Runnable() { \n    @Override                                             \n    public void run() { \n        // 延迟分发\n        dispatchPauseIfNeeded();                          \n        dispatchStopIfNeeded();                           \n    }                                                     \n};                                                        \n\nvoid activityStopped() { \n    // 计数\n    mStartedCounter--;                                              \n    dispatchStopIfNeeded();                                         \n}                                                                   \n                                                                    \nvoid dispatchPauseIfNeeded() {\n    if (mResumedCounter == 0) {\n        // 计数\n        mPauseSent = true;\n        // 分发 ON_PAUSE\n        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);   \n    }                                                               \n}                                                                   \n                                                                    \nvoid dispatchStopIfNeeded() {                                       \n    if (mStartedCounter == 0 && mPauseSent) {\n        // 计数为 0，同时已经分发了 ON_PAUSE\n        // 分发 ON_STOP\n        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_STOP);    \n        mStopSent = true;                                           \n    }                                                               \n}                                                                   \n```\n\n到这里，我们已经将 `ProcessLifecycleOwner` 的流程分析完了，那 `ProcessLifecycleOwner.init()` 是在那里调用的呢？\n\n其实是用了一种比较巧妙的方法，在 `lifecycle-process` 这个包下的 `AndroidManifest.xml` 文件中，可以看到有如下配置：\n\n``` xml\n<application>\n        <provider\n            android:name=\"androidx.lifecycle.ProcessLifecycleOwnerInitializer\"\n            android:authorities=\"${applicationId}.lifecycle-process\"\n            android:exported=\"false\"\n            android:multiprocess=\"true\" />\n</application>\n```\n\n其中 `ProcessLifecycleOwnerInitializer` 是一个 `ContentProvider` 即利用 `ContentProvider` 来实现自动初始化\n\n> ContentProvider 的 `onCreate` 方法会在应用启动时候调用\n>\n> Implement this to initialize your content provider on startup. This method is called for all registered content providers on the application main thread at application launch time. It must not perform lengthy operations, or application startup will be delayed.\n\n``` java\n@Override                                     \npublic boolean onCreate() {                   \n    LifecycleDispatcher.init(getContext());   \n    ProcessLifecycleOwner.init(getContext()); \n    return true;                              \n}                                             \n```\n\n可以看到这里调用了两个初始化方法，其中 `ProcessLifecycleOwner.init()` 我们已经分析了，再看看 `LifecycleDispatcher.init()`\n\n``` java\nstatic void init(Context context) {                                                 \n    if (sInitialized.getAndSet(true)) {                                             \n        return;                                                                     \n    }                                                                               \n    ((Application) context.getApplicationContext())                                 \n            .registerActivityLifecycleCallbacks(new DispatcherActivityCallback());  \n}                                                                                   \n                                                                                    \n@SuppressWarnings(\"WeakerAccess\")                                                   \n@VisibleForTesting                                                                  \nstatic class DispatcherActivityCallback extends EmptyActivityLifecycleCallbacks {   \n                                                                                    \n    @Override                                                                       \n    public void onActivityCreated(Activity activity, Bundle savedInstanceState) {   \n        ReportFragment.injectIfNeededIn(activity);                                  \n    }                                                                               \n                                                                                    \n    @Override                                                                       \n    public void onActivityStopped(Activity activity) {                              \n    }                                                                               \n                                                                                    \n    @Override                                                                       \n    public void onActivitySaveInstanceState(Activity activity, Bundle outState) {   \n    }                                                                               \n}                                                                                   \n```\n\n初始化的逻辑比较简单，即在 `Activity` 创建时，调用 `ReportFragment.injectIfneededIn()` ，其实我们在 `Activity` 的 `Lifecycle` 处理中，也见到这个方法： \n\n``` java                                                       \n// ComponentActivity.java\n@Override                                                        \n@SuppressWarnings(\"RestrictedApi\")                               \nprotected void onCreate(@Nullable Bundle savedInstanceState) {   \n    super.onCreate(savedInstanceState);                          \n    ReportFragment.injectIfNeededIn(this);                       \n}\n\n// ReportFragment.java\npublic static void injectIfNeededIn(Activity activity) {                                      \n    // ProcessLifecycleOwner should always correctly work and some activities may not extend  \n    // FragmentActivity from support lib, so we use framework fragments for activities        \n    android.app.FragmentManager manager = activity.getFragmentManager();                      \n    if (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == null) {\n        // 重复添加判断\n        manager.beginTransaction().add(new ReportFragment(), REPORT_FRAGMENT_TAG).commit();   \n        // Hopefully, we are the first to make a transaction.                                 \n        manager.executePendingTransactions();                                                 \n    }                                                                                         \n}                                                                                             \n```\n\n这里可以理解为双重保障吧，可能存在不继承 `ComponentActivity` 的 `Activity`。\n\n### 总结\n\n分析了 `Lifecycle`  的整个流程，可以发现其实逻辑还是比较简单的，实现上也是参考了其他开源库的做法，比如 `ReportFragment` 通过添加一个透明的 `Fragment` 去感知 `Activity` 的生命周期，`Glide` 也是这么做的。还有使用 `ContentProvider` 去实现在 `Application` 创建时自动初始化，也是一个不错的想法。\n\n`Lifecycle` 的源码比我一开始想象的复杂，不是在于它的逻辑，而是在 `sync()` 这一块，通过 `Listener` 执行状态回调是一个非常常见的做法，但是有很多需要考虑的 case，举个例子，在分发回调时，有新的状态发生，那么应该怎么去处理。或者，在回调方法中，又添加了新的 `Listener`，那应该怎么处理。\n\n学习源码，不仅仅是学习实现原理，还可以学习一个健壮的库是如何处理各种场景下的 case 的。","slug":"Jetpack中的Lifecycle","published":1,"updated":"2022-06-15T11:19:32.320Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrm6001hfho629mrgobk","content":"<h3 id=\"关于本文\"><a href=\"#关于本文\" class=\"headerlink\" title=\"关于本文\"></a>关于本文</h3><p>有很多项目都会使用 MVP 这种项目架构，使用 Presenter 来减轻 <code>Activity</code> 的负担，具体的 <code>MVP</code> 实现可以阅读 Google 推出的 <a href=\"https://github.com/googlesamples/android-architecture\">android-architecture</a>。</p>\n<p>一般使用 MVP，都会遇到一个问题，如何将 Presenter 和 View 的生命周期进行绑定，常见的做法是，在 <code>Activity</code> 的生命周期中手动调用 Presenter 的回调方法，更复杂的做法可能需要在 Presenter 或者 View 维护一个操作栈，在指定生命周期中去执行操作。</p>\n<h3 id=\"关于Lifecycle\"><a href=\"#关于Lifecycle\" class=\"headerlink\" title=\"关于Lifecycle\"></a>关于Lifecycle</h3><p><a href=\"https://developer.android.com/topic/libraries/architecture/lifecycle\">lifecycle</a> 是 Google 推出的用于响应 <code>Activity</code> 和 <code>Fragment</code> 生命周期改变的库。</p>\n<p><strong>These components help you produce better-organized, and often lighter-weight code, that is easier to maintain.</strong></p>\n<h4 id=\"Lifecycle\"><a href=\"#Lifecycle\" class=\"headerlink\" title=\"Lifecycle\"></a>Lifecycle</h4><p><code>Lifecycle</code> 是一个包含比如 <code>Activity</code> 或 <code>Fragment</code> 生命周期状态的类，同时允许其他对象去订阅这些状态</p>\n<p><code>Lifecycle</code> 使用 Event 和 State 来管理生命周期状态的变化</p>\n<h5 id=\"Event\"><a href=\"#Event\" class=\"headerlink\" title=\"Event\"></a>Event</h5><p>生命周期变化的事件</p>\n<h5 id=\"State\"><a href=\"#State\" class=\"headerlink\" title=\"State\"></a>State</h5><p>当前生命周期的状态</p>\n<p>使用 Google 文档中图片来表示这两者的关系：</p>\n<p><img src=\"https://developer.android.com/images/topic/libraries/architecture/lifecycle-states.png\" alt=\"lifecycle-states\"></p>\n<p>我们可以调用 <code>addObserver</code> 去注册一个监听者</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lifecycle.addObserver(presenter)</span><br></pre></td></tr></table></figure>\n\n<p>而 <code>presenter</code> 则需要实现 <code>LifecycleObserver</code> 接口，具体的回调方法则通过注解的形式：</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Presenter</span> : <span class=\"type\">LifecycleObserver &#123;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@OnLifecycleEvent(Lifecycle.Event.ON_START)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">onStart</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">onDestroy</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>当然我们也可以调用 <code>getCurrentState()</code> 来获取 <code>Lifecycle</code> 当前的状态</p>\n<h4 id=\"LifecycleOwner\"><a href=\"#LifecycleOwner\" class=\"headerlink\" title=\"LifecycleOwner\"></a>LifecycleOwner</h4><p>上面我们简单介绍了 <code>Lifecyle</code> 和 <code>LifecycleObserver</code>  的作用和关系之后，再来看下 <code>getLifecycle</code> 这个方法：</p>\n<blockquote>\n<p>因为上面的例子是用 kotlin 写的，所以 <code>lifecycle.addObserver</code> 实际上应该为 <code>getLifecycle().addObserver()</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">LifecycleOwner</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Returns the Lifecycle of the provider.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> The lifecycle of the provider.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@NonNull</span></span><br><span class=\"line\">    Lifecycle <span class=\"title function_\">getLifecycle</span><span class=\"params\">()</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>简单来说，<code>LifecycleOwner</code> 用于提供 <code>Lifecycle</code>，<code>LifecycleObserver</code> 监听 <code>Lifecycle</code> 的状态变化，<code>Lifecycle</code> 则是 <code>Activity</code> 或 <code>Fragment</code> 生命周期状态的抽象。</p>\n<p>可以看到 <code>Fragment</code> 和 <code>ComponentActivity</code> 等实现了 <code>LifecycleOwner</code> 接口，这里我们看下 <code>ComponentActivity</code> 的实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">LifecycleRegistry</span> <span class=\"variable\">mLifecycleRegistry</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">LifecycleRegistry</span>(<span class=\"built_in\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@CallSuper</span>                                                   </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                    </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onSaveInstanceState</span><span class=\"params\">(Bundle outState)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 这里需要注意，onSaveInstanceState 状态设置为 CREATED</span></span><br><span class=\"line\">    mLifecycleRegistry.markState(Lifecycle.State.CREATED);   </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onSaveInstanceState(outState);                     </span><br><span class=\"line\">&#125;                                                            </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                         </span><br><span class=\"line\"><span class=\"keyword\">public</span> Lifecycle <span class=\"title function_\">getLifecycle</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mLifecycleRegistry;    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                        </span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;RestrictedApi&quot;)</span>                               </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> Bundle savedInstanceState)</span> &#123;   </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onCreate(savedInstanceState);                          </span><br><span class=\"line\">    ReportFragment.injectIfNeededIn(<span class=\"built_in\">this</span>);                       </span><br><span class=\"line\">&#125;                                                                </span><br></pre></td></tr></table></figure>\n\n<p>可以看到代码非常简洁，那它又是怎么去实现的呢？可以看到在 <code>onCreate</code> 中会调用 <code>ReportFragment.injectIfNeededIn</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">injectIfNeededIn</span><span class=\"params\">(Activity activity)</span> &#123;                                     </span><br><span class=\"line\">    <span class=\"comment\">// ProcessLifecycleOwner should always correctly work and some activities may not extend </span></span><br><span class=\"line\">    <span class=\"comment\">// FragmentActivity from support lib, so we use framework fragments for activities       </span></span><br><span class=\"line\">    android.app.<span class=\"type\">FragmentManager</span> <span class=\"variable\">manager</span> <span class=\"operator\">=</span> activity.getFragmentManager();                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class=\"literal\">null</span>) &#123;                            </span><br><span class=\"line\">        manager.beginTransaction().add(<span class=\"keyword\">new</span> <span class=\"title class_\">ReportFragment</span>(), REPORT_FRAGMENT_TAG).commit();  </span><br><span class=\"line\">        <span class=\"comment\">// Hopefully, we are the first to make a transaction.                                </span></span><br><span class=\"line\">        manager.executePendingTransactions();                                                </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">&#125;   </span><br></pre></td></tr></table></figure>\n\n<p>这里会添加一个 <code>ReportFragment</code> 如果有阅读过 Glide 源码的同学，应该会看到类似的实现：通过添加一个透明的 <code>Fragment</code> 会监听 <code>Activity</code> 的生命周期。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityCreated</span><span class=\"params\">(Bundle savedInstanceState)</span> &#123;              </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onActivityCreated(savedInstanceState);                        </span><br><span class=\"line\">    dispatchCreate(mProcessListener);                                   </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_CREATE);                                </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                        </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onStart</span><span class=\"params\">()</span> &#123;                                                 </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onStart();                                                    </span><br><span class=\"line\">    dispatchStart(mProcessListener);                                    </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_START);                                 </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                        </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onResume</span><span class=\"params\">()</span> &#123;                                                </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onResume();                                                   </span><br><span class=\"line\">    dispatchResume(mProcessListener);                                   </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_RESUME);                                </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                        </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onPause</span><span class=\"params\">()</span> &#123;                                                 </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onPause();                                                    </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_PAUSE);                                 </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                        </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onStop</span><span class=\"params\">()</span> &#123;                                                  </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onStop();                                                     </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_STOP);                                  </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                        </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onDestroy</span><span class=\"params\">()</span> &#123;                                               </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onDestroy();                                                  </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_DESTROY);                               </span><br><span class=\"line\">    <span class=\"comment\">// just want to be sure that we won&#x27;t leak reference to an activity </span></span><br><span class=\"line\">    mProcessListener = <span class=\"literal\">null</span>;                                            </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">dispatch</span><span class=\"params\">(Lifecycle.Event event)</span> &#123;                                         </span><br><span class=\"line\">    <span class=\"type\">Activity</span> <span class=\"variable\">activity</span> <span class=\"operator\">=</span> getActivity();                                                 </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (activity <span class=\"keyword\">instanceof</span> LifecycleRegistryOwner) &#123;                                  </span><br><span class=\"line\">        ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                        </span><br><span class=\"line\">    &#125;                                                                                  </span><br><span class=\"line\">                                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (activity <span class=\"keyword\">instanceof</span> LifecycleOwner) &#123;                                          </span><br><span class=\"line\">        <span class=\"type\">Lifecycle</span> <span class=\"variable\">lifecycle</span> <span class=\"operator\">=</span> ((LifecycleOwner) activity).getLifecycle();              </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (lifecycle <span class=\"keyword\">instanceof</span> LifecycleRegistry) &#123;                                  </span><br><span class=\"line\">            ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);               </span><br><span class=\"line\">        &#125;                                                                              </span><br><span class=\"line\">    &#125;                                                                                  </span><br><span class=\"line\">&#125;                                                                                      </span><br></pre></td></tr></table></figure>\n\n<p>在 <code>Activity</code> 的各种生命周期回调方法中，调用 <code>handleLifecycleEvent()</code> 分发 <code>Lifecycle.Event</code></p>\n<h5 id=\"handleLifecycleEvent\"><a href=\"#handleLifecycleEvent\" class=\"headerlink\" title=\"handleLifecycleEvent\"></a>handleLifecycleEvent</h5><p><code>LifecycleRegistry</code> 是 <code>Lifecycle</code> 的实现类，看下 <code>handleLifecycleEvent</code> 的实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handleLifecycleEvent</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Lifecycle.Event event)</span> &#123;    </span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">next</span> <span class=\"operator\">=</span> getStateAfter(event);                                </span><br><span class=\"line\">    moveToState(next);                                                </span><br><span class=\"line\">&#125;                                                                     </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// event 和 Sate 的对应关系</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> State <span class=\"title function_\">getStateAfter</span><span class=\"params\">(Event event)</span> &#123;                                  </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (event) &#123;                                                       </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_CREATE:                                                    </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_STOP:                                                      </span><br><span class=\"line\">            <span class=\"keyword\">return</span> CREATED;                                                </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_START:                                                     </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_PAUSE:                                                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> STARTED;                                                </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_RESUME:                                                    </span><br><span class=\"line\">            <span class=\"keyword\">return</span> RESUMED;                                                </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_DESTROY:                                                   </span><br><span class=\"line\">            <span class=\"keyword\">return</span> DESTROYED;                                              </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_ANY:                                                       </span><br><span class=\"line\">            <span class=\"keyword\">break</span>;                                                         </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Unexpected event value &quot;</span> + event); </span><br><span class=\"line\">&#125;                                                                          </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">moveToState</span><span class=\"params\">(State next)</span> &#123;                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mState == next) &#123;                                             </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                       </span><br><span class=\"line\">    &#125;                                                                 </span><br><span class=\"line\">    mState = next;                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mHandlingEvent || mAddingObserverCounter != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 正在处理事件中或者正在处理添加 Observer 中</span></span><br><span class=\"line\">        mNewEventOccurred = <span class=\"literal\">true</span>;                                     </span><br><span class=\"line\">        <span class=\"comment\">// we will figure out what to do on upper level.              </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 标记正在处理事件</span></span><br><span class=\"line\">    mHandlingEvent = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 同步状态</span></span><br><span class=\"line\">    sync();                                                           </span><br><span class=\"line\">    mHandlingEvent = <span class=\"literal\">false</span>;                                           </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// happens only on the top of stack (never in reentrance),                                    </span></span><br><span class=\"line\"><span class=\"comment\">// so it doesn&#x27;t have to take in account parents                                              </span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sync</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 使用弱应用持有 LifecycleOwner，也是为了防止 Activity/Fragment 内存泄漏</span></span><br><span class=\"line\">    <span class=\"type\">LifecycleOwner</span> <span class=\"variable\">lifecycleOwner</span> <span class=\"operator\">=</span> mLifecycleOwner.get();                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (lifecycleOwner == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        Log.w(LOG_TAG, <span class=\"string\">&quot;LifecycleOwner is garbage collected, you shouldn&#x27;t try dispatch &quot;</span>     </span><br><span class=\"line\">                + <span class=\"string\">&quot;new events from it.&quot;</span>);                                                     </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                               </span><br><span class=\"line\">    &#125;                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (!isSynced()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果还没完成同步</span></span><br><span class=\"line\">        mNewEventOccurred = <span class=\"literal\">false</span>;                                                            </span><br><span class=\"line\">        <span class=\"comment\">// no need to check eldest for nullability, because isSynced does it for us.     </span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 使用 eldest(start) 判断是否需要回退 </span></span><br><span class=\"line\">        <span class=\"comment\">// 使用 newest(end) 判断是否需要前进，刚添加的 observer 一般为初始化状态</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 最先添加的 observer 的状态大于当前状态，回退</span></span><br><span class=\"line\">            backwardPass(lifecycleOwner);                                                     </span><br><span class=\"line\">        &#125;                                                                                     </span><br><span class=\"line\">        Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();           </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class=\"literal\">null</span>                                              </span><br><span class=\"line\">                &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 最新添加的 observer 如果状态一致，则可以乐观地表示在它之前添加的 observer 状态也是一致的</span></span><br><span class=\"line\">            <span class=\"comment\">// mNewEventOccurred 表示有新的事件发生，则放弃这次同步，延迟到下一次</span></span><br><span class=\"line\">            forwardPass(lifecycleOwner);                                                      </span><br><span class=\"line\">        &#125;                                                                                     </span><br><span class=\"line\">    &#125;                                                                                         </span><br><span class=\"line\">    mNewEventOccurred = <span class=\"literal\">false</span>;                                                                </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">boolean</span> <span class=\"title function_\">isSynced</span><span class=\"params\">()</span> &#123;                                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mObserverMap.size() == <span class=\"number\">0</span>) &#123;                                                     </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                                                                    </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// eldest 最先添加的，newest 最新添加的</span></span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">eldestObserverState</span> <span class=\"operator\">=</span> mObserverMap.eldest().getValue().mState;                </span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">newestObserverState</span> <span class=\"operator\">=</span> mObserverMap.newest().getValue().mState;</span><br><span class=\"line\">    <span class=\"comment\">// 判断状态是否一致</span></span><br><span class=\"line\">    <span class=\"type\">return</span> <span class=\"variable\">eldestObserverState</span> <span class=\"operator\">=</span>= newestObserverState &amp;&amp; mState == newestObserverState; </span><br><span class=\"line\">&#125;                                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>使用 <code>sync()</code> 同步状态，这里分为两种情况，一种是需要回退状态（backward），另外一种则是需要前进（forward），其中 <code>backward</code> 代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backwardPass</span><span class=\"params\">(LifecycleOwner lifecycleOwner)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 使用 eldest(start) 判断是否需要回退 </span></span><br><span class=\"line\">    <span class=\"comment\">// 降序迭代，end -&gt; start</span></span><br><span class=\"line\">    Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; descendingIterator =         </span><br><span class=\"line\">            mObserverMap.descendingIterator();                                         </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (descendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// mNewEventOccurred 判断是否有新事件分发</span></span><br><span class=\"line\">        Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = descendingIterator.next(); </span><br><span class=\"line\">        <span class=\"type\">ObserverWithState</span> <span class=\"variable\">observer</span> <span class=\"operator\">=</span> entry.getValue();                                 </span><br><span class=\"line\">        <span class=\"keyword\">while</span> ((observer.mState.compareTo(mState) &gt; <span class=\"number\">0</span> &amp;&amp; !mNewEventOccurred            </span><br><span class=\"line\">                &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 回退</span></span><br><span class=\"line\">            <span class=\"comment\">// 举个例子：observer.state 为 RESUMED</span></span><br><span class=\"line\">            <span class=\"comment\">// mState 为 CREATED</span></span><br><span class=\"line\">            <span class=\"comment\">// downEvent(observer.state) 为 ON_PAUSE</span></span><br><span class=\"line\">            <span class=\"type\">Event</span> <span class=\"variable\">event</span> <span class=\"operator\">=</span> downEvent(observer.mState);</span><br><span class=\"line\">            <span class=\"comment\">// getStateAfter(event) 为 STARTED</span></span><br><span class=\"line\">            <span class=\"comment\">// 最终：RESUMED -&gt; STARTED，在下一次同步中再同步为 CREATED</span></span><br><span class=\"line\">            <span class=\"comment\">// pushParentState 和 popParentState 则是将 state 暂存在 List 中，这个作用我们会在 addObserver 中讲</span></span><br><span class=\"line\">            pushParentState(getStateAfter(event));</span><br><span class=\"line\">            <span class=\"comment\">// 分发事件</span></span><br><span class=\"line\">            observer.dispatchEvent(lifecycleOwner, event);                             </span><br><span class=\"line\">            popParentState();                                                          </span><br><span class=\"line\">        &#125;                                                                              </span><br><span class=\"line\">    &#125;                                                                                  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Event <span class=\"title function_\">downEvent</span><span class=\"params\">(State state)</span> &#123;                             </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (state) &#123;                                                      </span><br><span class=\"line\">        <span class=\"keyword\">case</span> INITIALIZED:                                                 </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();                         </span><br><span class=\"line\">        <span class=\"keyword\">case</span> CREATED:                                                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_DESTROY;                                            </span><br><span class=\"line\">        <span class=\"keyword\">case</span> STARTED:                                                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_STOP;                                               </span><br><span class=\"line\">        <span class=\"keyword\">case</span> RESUMED:                                                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_PAUSE;                                              </span><br><span class=\"line\">        <span class=\"keyword\">case</span> DESTROYED:                                                   </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();                         </span><br><span class=\"line\">    &#125;                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Unexpected state value &quot;</span> + state);</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> State <span class=\"title function_\">getStateAfter</span><span class=\"params\">(Event event)</span> &#123;                                   </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (event) &#123;                                                        </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_CREATE:                                                     </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_STOP:                                                       </span><br><span class=\"line\">            <span class=\"keyword\">return</span> CREATED;                                                 </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_START:                                                      </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_PAUSE:                                                      </span><br><span class=\"line\">            <span class=\"keyword\">return</span> STARTED;                                                 </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_RESUME:                                                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> RESUMED;                                                 </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_DESTROY:                                                    </span><br><span class=\"line\">            <span class=\"keyword\">return</span> DESTROYED;                                               </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_ANY:                                                        </span><br><span class=\"line\">            <span class=\"keyword\">break</span>;                                                          </span><br><span class=\"line\">    &#125;                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Unexpected event value &quot;</span> + event);  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ObserverWithState.java</span></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">dispatchEvent</span><span class=\"params\">(LifecycleOwner owner, Event event)</span> &#123; </span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">newState</span> <span class=\"operator\">=</span> getStateAfter(event);</span><br><span class=\"line\">    <span class=\"comment\">// 使用较小的状态同步</span></span><br><span class=\"line\">    mState = min(mState, newState);                     </span><br><span class=\"line\">    mLifecycleObserver.onStateChanged(owner, event);    </span><br><span class=\"line\">    mState = newState;                                  </span><br><span class=\"line\">&#125;                                                       </span><br></pre></td></tr></table></figure>\n\n<p>总结下 <code>backwardPass()</code> 的逻辑：将较大的状态逐步回退。为什么说是逐步呢？比如 <code>observer.state</code> 是 <code>RESUMED</code>，当前状态是 <code>CREATED</code>，那这里会分两次回退，分别为：<code>RESUMED -&gt; STARTED</code> 和 <code>STARTED -&gt; CREATED</code></p>\n<p><code>forwardPass()</code> 逻辑类似，则不分析了。</p>\n<h5 id=\"addObserver\"><a href=\"#addObserver\" class=\"headerlink\" title=\"addObserver\"></a>addObserver</h5><p><code>addObserver()</code> 是添加 <code>Observer</code> 的方法，源码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                 </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addObserver</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> LifecycleObserver observer)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果不是 DESTROYED，则从 INITIALIZED 开始分发</span></span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">initialState</span> <span class=\"operator\">=</span> mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class=\"line\">    <span class=\"comment\">// ObserverWithState 用于分发事件给 observer</span></span><br><span class=\"line\">    <span class=\"type\">ObserverWithState</span> <span class=\"variable\">statefulObserver</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObserverWithState</span>(observer, initialState);   </span><br><span class=\"line\">    <span class=\"type\">ObserverWithState</span> <span class=\"variable\">previous</span> <span class=\"operator\">=</span> mObserverMap.putIfAbsent(observer, statefulObserver);    </span><br><span class=\"line\">                                                                                          </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (previous != <span class=\"literal\">null</span>) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 唯一性</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                           </span><br><span class=\"line\">    &#125;                                                                                     </span><br><span class=\"line\">    <span class=\"type\">LifecycleOwner</span> <span class=\"variable\">lifecycleOwner</span> <span class=\"operator\">=</span> mLifecycleOwner.get();                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (lifecycleOwner == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">        <span class=\"comment\">// mLifecycleOwner 为弱引用</span></span><br><span class=\"line\">        <span class=\"comment\">// it is null we should be destroyed. Fallback quickly                            </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                           </span><br><span class=\"line\">    &#125;                                                                                     </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// isReentrance 表示是否在分发事件时新添加了 observer</span></span><br><span class=\"line\">    <span class=\"comment\">// 举个例子：在 observer 在 onStart() 中又调用了 addObserver()</span></span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">isReentrance</span> <span class=\"operator\">=</span> mAddingObserverCounter != <span class=\"number\">0</span> || mHandlingEvent; </span><br><span class=\"line\">    <span class=\"comment\">// 计算需要分发的状态</span></span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">targetState</span> <span class=\"operator\">=</span> calculateTargetState(observer);                                   </span><br><span class=\"line\">    mAddingObserverCounter++; </span><br><span class=\"line\">    <span class=\"comment\">// 将事件逐步分发到 targetState</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class=\"number\">0</span>                            </span><br><span class=\"line\">            &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果 statefulObserver.state 小于 targetState</span></span><br><span class=\"line\">        pushParentState(statefulObserver.mState);</span><br><span class=\"line\">        <span class=\"comment\">// 如果 state 为 STARTED，则 upEvent(state) 则为 ON_RESUME</span></span><br><span class=\"line\">        statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState)); </span><br><span class=\"line\">        popParentState();                                                                 </span><br><span class=\"line\">        <span class=\"comment\">// mState / subling may have been changed recalculate                             </span></span><br><span class=\"line\">        targetState = calculateTargetState(observer);                                     </span><br><span class=\"line\">    &#125;                                                                                     </span><br><span class=\"line\">                                                                                          </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!isReentrance) &#123;                                                                  </span><br><span class=\"line\">        <span class=\"comment\">// we do sync only on the top level.</span></span><br><span class=\"line\">        <span class=\"comment\">// 当前为重入，则不进行同步</span></span><br><span class=\"line\">        sync();                                                                           </span><br><span class=\"line\">    &#125;                                                                                     </span><br><span class=\"line\">    mAddingObserverCounter--;                                                             </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Event <span class=\"title function_\">upEvent</span><span class=\"params\">(State state)</span> &#123;                                  </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (state) &#123;                                                         </span><br><span class=\"line\">        <span class=\"keyword\">case</span> INITIALIZED:                                                    </span><br><span class=\"line\">        <span class=\"keyword\">case</span> DESTROYED:                                                      </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_CREATE;                                                </span><br><span class=\"line\">        <span class=\"keyword\">case</span> CREATED:                                                        </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_START;                                                 </span><br><span class=\"line\">        <span class=\"keyword\">case</span> STARTED:                                                        </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_RESUME;                                                </span><br><span class=\"line\">        <span class=\"keyword\">case</span> RESUMED:                                                        </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();                            </span><br><span class=\"line\">    &#125;                                                                        </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Unexpected state value &quot;</span> + state);   </span><br><span class=\"line\">&#125;                                                                            </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> State <span class=\"title function_\">calculateTargetState</span><span class=\"params\">(LifecycleObserver observer)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获取上一个添加的 observer</span></span><br><span class=\"line\">    Entry&lt;LifecycleObserver, ObserverWithState&gt; previous = mObserverMap.ceil(observer);       </span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">siblingState</span> <span class=\"operator\">=</span> previous != <span class=\"literal\">null</span> ? previous.getValue().mState : <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">// mParentStates 是个 List，它的添加和删除分别由 pushParentState() 和 popParentState()，它们是成对出现的，在 dispatchEvent 的前后</span></span><br><span class=\"line\">    <span class=\"comment\">// 在这种 case 下，会存在 parentState：在 dispatchEvent 时，又调用了 addObserver()，即上面说的 isReentrance</span></span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">parentState</span> <span class=\"operator\">=</span> !mParentStates.isEmpty() ? mParentStates.get(mParentStates.size() - <span class=\"number\">1</span>)</span><br><span class=\"line\">            : <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 这里的计算是获取更合适的状态</span></span><br><span class=\"line\">    <span class=\"comment\">// 考虑以下这种 case：某个 observer 在 onStart() 中再调用 addObserver，那这个 observer 理应使用 STARTED 状态分发，而当前状态即 mState 可能是 RESUMED，再在 sync() 中进行同步</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> min(min(mState, siblingState), parentState);                                       </span><br><span class=\"line\">&#125;                                                                                             </span><br></pre></td></tr></table></figure>\n\n<p><code>addObserver()</code> 主要考虑了 Reentrance 的情况，即在 <code>observer</code> 的事件分发中，又添加了新的 <code>observer</code> 的情况。</p>\n<h4 id=\"ProcessLifecycleOwner\"><a href=\"#ProcessLifecycleOwner\" class=\"headerlink\" title=\"ProcessLifecycleOwner\"></a>ProcessLifecycleOwner</h4><p><code>ProcessLifecycleOwner</code> 提供应用进程的生命周期。跟 <code>Activity</code> 和 <code>Fragment</code> 的生命周期不一样的是：</p>\n<ul>\n<li><code>ON_CREATE</code> 只会分发一次</li>\n<li><code>ON_DESTROY</code> 则不会被分发</li>\n<li><code>ON_START</code> 和 <code>ON_RESUME</code> 在第一个 <code>Activity</code> 的时候分发</li>\n<li><code>ON_PAUSE</code> 和 <code>ON_STOP</code> 则在最后一个 <code>Activity</code> 的时候<strong>延迟</strong>分发，用于防止因为配置改变，而导致 <code>Activity</code> 重建</li>\n</ul>\n<p>下面我们来分析下 <code>ProcessLifecycleOwner</code> 的源码，首先看下 <code>init()</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 单例</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">ProcessLifecycleOwner</span> <span class=\"variable\">sInstance</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ProcessLifecycleOwner</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">(Context context)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 调用 attach</span></span><br><span class=\"line\">    sInstance.attach(context);      </span><br><span class=\"line\">&#125;                                   </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">attach</span><span class=\"params\">(Context context)</span> &#123;                                                          </span><br><span class=\"line\">    mHandler = <span class=\"keyword\">new</span> <span class=\"title class_\">Handler</span>();</span><br><span class=\"line\">    <span class=\"comment\">// 同样是使用 LifecycleRegistry 来处理</span></span><br><span class=\"line\">    <span class=\"comment\">// 先分发 ON_CREATE，而且只会分发一次</span></span><br><span class=\"line\">    mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);                          </span><br><span class=\"line\">    <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> (Application) context.getApplicationContext();</span><br><span class=\"line\">    app.registerActivityLifecycleCallbacks(<span class=\"keyword\">new</span> <span class=\"title class_\">EmptyActivityLifecycleCallbacks</span>() &#123;      </span><br><span class=\"line\">        <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityCreated</span><span class=\"params\">(Activity activity, Bundle savedInstanceState)</span> &#123;   </span><br><span class=\"line\">            ReportFragment.get(activity).setProcessListener(mInitializationListener);   </span><br><span class=\"line\">        &#125;                                                                               </span><br><span class=\"line\">                                                                                        </span><br><span class=\"line\">        <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityPaused</span><span class=\"params\">(Activity activity)</span> &#123;                               </span><br><span class=\"line\">            activityPaused();                                                           </span><br><span class=\"line\">        &#125;                                                                               </span><br><span class=\"line\">                                                                                        </span><br><span class=\"line\">        <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityStopped</span><span class=\"params\">(Activity activity)</span> &#123;                              </span><br><span class=\"line\">            activityStopped();                                                          </span><br><span class=\"line\">        &#125;                                                                               </span><br><span class=\"line\">    &#125;);                                                                                 </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">ActivityInitializationListener</span> <span class=\"variable\">mInitializationListener</span> <span class=\"operator\">=</span>      </span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">ActivityInitializationListener</span>() &#123;                </span><br><span class=\"line\">            <span class=\"meta\">@Override</span>                                         </span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">()</span> &#123;                          </span><br><span class=\"line\">            &#125;                                                 </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">            <span class=\"meta\">@Override</span>                                         </span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onStart</span><span class=\"params\">()</span> &#123;                           </span><br><span class=\"line\">                activityStarted();                            </span><br><span class=\"line\">            &#125;                                                 </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">            <span class=\"meta\">@Override</span>                                         </span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onResume</span><span class=\"params\">()</span> &#123;                          </span><br><span class=\"line\">                activityResumed();                            </span><br><span class=\"line\">            &#125;                                                 </span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      </span><br><span class=\"line\">                                                 </span><br><span class=\"line\"><span class=\"comment\">// ground truth counters                         </span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">mStartedCounter</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;                 </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">mResumedCounter</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;                 </span><br><span class=\"line\">                                                 </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">boolean</span> <span class=\"variable\">mPauseSent</span> <span class=\"operator\">=</span> <span class=\"literal\">true</span>;               </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">boolean</span> <span class=\"variable\">mStopSent</span> <span class=\"operator\">=</span> <span class=\"literal\">true</span>;                </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">activityStarted</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 计数</span></span><br><span class=\"line\">    mStartedCounter++;                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartedCounter == <span class=\"number\">1</span> &amp;&amp; mStopSent) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 第一次调用，分发 ON_START</span></span><br><span class=\"line\">        <span class=\"comment\">// mStopSent 为 true 的情况：</span></span><br><span class=\"line\">        <span class=\"comment\">// 1. 默认为 true</span></span><br><span class=\"line\">        <span class=\"comment\">// 2. dispatchStopIfNeeded 中设置</span></span><br><span class=\"line\">        <span class=\"comment\">// 防止因为配置改变，Activity 创建而导致重新分发</span></span><br><span class=\"line\">        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START); </span><br><span class=\"line\">        mStopSent = <span class=\"literal\">false</span>;                                        </span><br><span class=\"line\">    &#125;                                                             </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">void</span> <span class=\"title function_\">activityResumed</span><span class=\"params\">()</span> &#123;                                               </span><br><span class=\"line\">     mResumedCounter++;                                                 </span><br><span class=\"line\">     <span class=\"keyword\">if</span> (mResumedCounter == <span class=\"number\">1</span>) &#123;                                        </span><br><span class=\"line\">         <span class=\"keyword\">if</span> (mPauseSent) &#123;</span><br><span class=\"line\">             <span class=\"comment\">// 第一次调用分发 ON_RESUME</span></span><br><span class=\"line\">             mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME); </span><br><span class=\"line\">             mPauseSent = <span class=\"literal\">false</span>;                                        </span><br><span class=\"line\">         &#125; <span class=\"keyword\">else</span> &#123; </span><br><span class=\"line\">             <span class=\"comment\">// 配置改变，Activity 创建，删除延迟的 pause runnable</span></span><br><span class=\"line\">             mHandler.removeCallbacks(mDelayedPauseRunnable);           </span><br><span class=\"line\">         &#125;                                                              </span><br><span class=\"line\">     &#125;                                                                  </span><br><span class=\"line\"> &#125;                                                                      </span><br></pre></td></tr></table></figure>\n\n<p>上面是初始事件分发流程，下面我们来看下 <code>ON_PAUSE</code> 和 <code>ON_STOP</code> 的分发：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@VisibleForTesting</span>                               </span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">TIMEOUT_MS</span> <span class=\"operator\">=</span> <span class=\"number\">700</span>; <span class=\"comment\">//mls </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 在 onActivityPaused 中调用</span></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">activityPaused</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 计数</span></span><br><span class=\"line\">    mResumedCounter--;                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mResumedCounter == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 延迟分发</span></span><br><span class=\"line\">        mHandler.postDelayed(mDelayedPauseRunnable, TIMEOUT_MS);    </span><br><span class=\"line\">    &#125;                                                               </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">Runnable</span> <span class=\"variable\">mDelayedPauseRunnable</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123; </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                             </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 延迟分发</span></span><br><span class=\"line\">        dispatchPauseIfNeeded();                          </span><br><span class=\"line\">        dispatchStopIfNeeded();                           </span><br><span class=\"line\">    &#125;                                                     </span><br><span class=\"line\">&#125;;                                                        </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">activityStopped</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">    <span class=\"comment\">// 计数</span></span><br><span class=\"line\">    mStartedCounter--;                                              </span><br><span class=\"line\">    dispatchStopIfNeeded();                                         </span><br><span class=\"line\">&#125;                                                                   </span><br><span class=\"line\">                                                                    </span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">dispatchPauseIfNeeded</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mResumedCounter == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 计数</span></span><br><span class=\"line\">        mPauseSent = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 分发 ON_PAUSE</span></span><br><span class=\"line\">        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);   </span><br><span class=\"line\">    &#125;                                                               </span><br><span class=\"line\">&#125;                                                                   </span><br><span class=\"line\">                                                                    </span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">dispatchStopIfNeeded</span><span class=\"params\">()</span> &#123;                                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartedCounter == <span class=\"number\">0</span> &amp;&amp; mPauseSent) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 计数为 0，同时已经分发了 ON_PAUSE</span></span><br><span class=\"line\">        <span class=\"comment\">// 分发 ON_STOP</span></span><br><span class=\"line\">        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_STOP);    </span><br><span class=\"line\">        mStopSent = <span class=\"literal\">true</span>;                                           </span><br><span class=\"line\">    &#125;                                                               </span><br><span class=\"line\">&#125;                                                                   </span><br></pre></td></tr></table></figure>\n\n<p>到这里，我们已经将 <code>ProcessLifecycleOwner</code> 的流程分析完了，那 <code>ProcessLifecycleOwner.init()</code> 是在那里调用的呢？</p>\n<p>其实是用了一种比较巧妙的方法，在 <code>lifecycle-process</code> 这个包下的 <code>AndroidManifest.xml</code> 文件中，可以看到有如下配置：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">application</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">provider</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;androidx.lifecycle.ProcessLifecycleOwnerInitializer&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:authorities</span>=<span class=\"string\">&quot;$&#123;applicationId&#125;.lifecycle-process&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:exported</span>=<span class=\"string\">&quot;false&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:multiprocess</span>=<span class=\"string\">&quot;true&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">application</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>其中 <code>ProcessLifecycleOwnerInitializer</code> 是一个 <code>ContentProvider</code> 即利用 <code>ContentProvider</code> 来实现自动初始化</p>\n<blockquote>\n<p>ContentProvider 的 <code>onCreate</code> 方法会在应用启动时候调用</p>\n<p>Implement this to initialize your content provider on startup. This method is called for all registered content providers on the application main thread at application launch time. It must not perform lengthy operations, or application startup will be delayed.</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                     </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">onCreate</span><span class=\"params\">()</span> &#123;                   </span><br><span class=\"line\">    LifecycleDispatcher.init(getContext());   </span><br><span class=\"line\">    ProcessLifecycleOwner.init(getContext()); </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                              </span><br><span class=\"line\">&#125;                                             </span><br></pre></td></tr></table></figure>\n\n<p>可以看到这里调用了两个初始化方法，其中 <code>ProcessLifecycleOwner.init()</code> 我们已经分析了，再看看 <code>LifecycleDispatcher.init()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">(Context context)</span> &#123;                                                 </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (sInitialized.getAndSet(<span class=\"literal\">true</span>)) &#123;                                             </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                     </span><br><span class=\"line\">    &#125;                                                                               </span><br><span class=\"line\">    ((Application) context.getApplicationContext())                                 </span><br><span class=\"line\">            .registerActivityLifecycleCallbacks(<span class=\"keyword\">new</span> <span class=\"title class_\">DispatcherActivityCallback</span>());  </span><br><span class=\"line\">&#125;                                                                                   </span><br><span class=\"line\">                                                                                    </span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;WeakerAccess&quot;)</span>                                                   </span><br><span class=\"line\"><span class=\"meta\">@VisibleForTesting</span>                                                                  </span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DispatcherActivityCallback</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">EmptyActivityLifecycleCallbacks</span> &#123;   </span><br><span class=\"line\">                                                                                    </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityCreated</span><span class=\"params\">(Activity activity, Bundle savedInstanceState)</span> &#123;   </span><br><span class=\"line\">        ReportFragment.injectIfNeededIn(activity);                                  </span><br><span class=\"line\">    &#125;                                                                               </span><br><span class=\"line\">                                                                                    </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityStopped</span><span class=\"params\">(Activity activity)</span> &#123;                              </span><br><span class=\"line\">    &#125;                                                                               </span><br><span class=\"line\">                                                                                    </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivitySaveInstanceState</span><span class=\"params\">(Activity activity, Bundle outState)</span> &#123;   </span><br><span class=\"line\">    &#125;                                                                               </span><br><span class=\"line\">&#125;                                                                                   </span><br></pre></td></tr></table></figure>\n\n<p>初始化的逻辑比较简单，即在 <code>Activity</code> 创建时，调用 <code>ReportFragment.injectIfneededIn()</code> ，其实我们在 <code>Activity</code> 的 <code>Lifecycle</code> 处理中，也见到这个方法： </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ComponentActivity.java</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                        </span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;RestrictedApi&quot;)</span>                               </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> Bundle savedInstanceState)</span> &#123;   </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onCreate(savedInstanceState);                          </span><br><span class=\"line\">    ReportFragment.injectIfNeededIn(<span class=\"built_in\">this</span>);                       </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ReportFragment.java</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">injectIfNeededIn</span><span class=\"params\">(Activity activity)</span> &#123;                                      </span><br><span class=\"line\">    <span class=\"comment\">// ProcessLifecycleOwner should always correctly work and some activities may not extend  </span></span><br><span class=\"line\">    <span class=\"comment\">// FragmentActivity from support lib, so we use framework fragments for activities        </span></span><br><span class=\"line\">    android.app.<span class=\"type\">FragmentManager</span> <span class=\"variable\">manager</span> <span class=\"operator\">=</span> activity.getFragmentManager();                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 重复添加判断</span></span><br><span class=\"line\">        manager.beginTransaction().add(<span class=\"keyword\">new</span> <span class=\"title class_\">ReportFragment</span>(), REPORT_FRAGMENT_TAG).commit();   </span><br><span class=\"line\">        <span class=\"comment\">// Hopefully, we are the first to make a transaction.                                 </span></span><br><span class=\"line\">        manager.executePendingTransactions();                                                 </span><br><span class=\"line\">    &#125;                                                                                         </span><br><span class=\"line\">&#125;                                                                                             </span><br></pre></td></tr></table></figure>\n\n<p>这里可以理解为双重保障吧，可能存在不继承 <code>ComponentActivity</code> 的 <code>Activity</code>。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>分析了 <code>Lifecycle</code>  的整个流程，可以发现其实逻辑还是比较简单的，实现上也是参考了其他开源库的做法，比如 <code>ReportFragment</code> 通过添加一个透明的 <code>Fragment</code> 去感知 <code>Activity</code> 的生命周期，<code>Glide</code> 也是这么做的。还有使用 <code>ContentProvider</code> 去实现在 <code>Application</code> 创建时自动初始化，也是一个不错的想法。</p>\n<p><code>Lifecycle</code> 的源码比我一开始想象的复杂，不是在于它的逻辑，而是在 <code>sync()</code> 这一块，通过 <code>Listener</code> 执行状态回调是一个非常常见的做法，但是有很多需要考虑的 case，举个例子，在分发回调时，有新的状态发生，那么应该怎么去处理。或者，在回调方法中，又添加了新的 <code>Listener</code>，那应该怎么处理。</p>\n<p>学习源码，不仅仅是学习实现原理，还可以学习一个健壮的库是如何处理各种场景下的 case 的。</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"关于本文\"><a href=\"#关于本文\" class=\"headerlink\" title=\"关于本文\"></a>关于本文</h3><p>有很多项目都会使用 MVP 这种项目架构，使用 Presenter 来减轻 <code>Activity</code> 的负担，具体的 <code>MVP</code> 实现可以阅读 Google 推出的 <a href=\"https://github.com/googlesamples/android-architecture\">android-architecture</a>。</p>\n<p>一般使用 MVP，都会遇到一个问题，如何将 Presenter 和 View 的生命周期进行绑定，常见的做法是，在 <code>Activity</code> 的生命周期中手动调用 Presenter 的回调方法，更复杂的做法可能需要在 Presenter 或者 View 维护一个操作栈，在指定生命周期中去执行操作。</p>\n<h3 id=\"关于Lifecycle\"><a href=\"#关于Lifecycle\" class=\"headerlink\" title=\"关于Lifecycle\"></a>关于Lifecycle</h3><p><a href=\"https://developer.android.com/topic/libraries/architecture/lifecycle\">lifecycle</a> 是 Google 推出的用于响应 <code>Activity</code> 和 <code>Fragment</code> 生命周期改变的库。</p>\n<p><strong>These components help you produce better-organized, and often lighter-weight code, that is easier to maintain.</strong></p>\n<h4 id=\"Lifecycle\"><a href=\"#Lifecycle\" class=\"headerlink\" title=\"Lifecycle\"></a>Lifecycle</h4><p><code>Lifecycle</code> 是一个包含比如 <code>Activity</code> 或 <code>Fragment</code> 生命周期状态的类，同时允许其他对象去订阅这些状态</p>\n<p><code>Lifecycle</code> 使用 Event 和 State 来管理生命周期状态的变化</p>\n<h5 id=\"Event\"><a href=\"#Event\" class=\"headerlink\" title=\"Event\"></a>Event</h5><p>生命周期变化的事件</p>\n<h5 id=\"State\"><a href=\"#State\" class=\"headerlink\" title=\"State\"></a>State</h5><p>当前生命周期的状态</p>\n<p>使用 Google 文档中图片来表示这两者的关系：</p>\n<p><img src=\"https://developer.android.com/images/topic/libraries/architecture/lifecycle-states.png\" alt=\"lifecycle-states\"></p>\n<p>我们可以调用 <code>addObserver</code> 去注册一个监听者</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lifecycle.addObserver(presenter)</span><br></pre></td></tr></table></figure>\n\n<p>而 <code>presenter</code> 则需要实现 <code>LifecycleObserver</code> 接口，具体的回调方法则通过注解的形式：</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Presenter</span> : <span class=\"type\">LifecycleObserver &#123;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@OnLifecycleEvent(Lifecycle.Event.ON_START)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">onStart</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">onDestroy</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>当然我们也可以调用 <code>getCurrentState()</code> 来获取 <code>Lifecycle</code> 当前的状态</p>\n<h4 id=\"LifecycleOwner\"><a href=\"#LifecycleOwner\" class=\"headerlink\" title=\"LifecycleOwner\"></a>LifecycleOwner</h4><p>上面我们简单介绍了 <code>Lifecyle</code> 和 <code>LifecycleObserver</code>  的作用和关系之后，再来看下 <code>getLifecycle</code> 这个方法：</p>\n<blockquote>\n<p>因为上面的例子是用 kotlin 写的，所以 <code>lifecycle.addObserver</code> 实际上应该为 <code>getLifecycle().addObserver()</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">LifecycleOwner</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Returns the Lifecycle of the provider.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> The lifecycle of the provider.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@NonNull</span></span><br><span class=\"line\">    Lifecycle <span class=\"title function_\">getLifecycle</span><span class=\"params\">()</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>简单来说，<code>LifecycleOwner</code> 用于提供 <code>Lifecycle</code>，<code>LifecycleObserver</code> 监听 <code>Lifecycle</code> 的状态变化，<code>Lifecycle</code> 则是 <code>Activity</code> 或 <code>Fragment</code> 生命周期状态的抽象。</p>\n<p>可以看到 <code>Fragment</code> 和 <code>ComponentActivity</code> 等实现了 <code>LifecycleOwner</code> 接口，这里我们看下 <code>ComponentActivity</code> 的实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">LifecycleRegistry</span> <span class=\"variable\">mLifecycleRegistry</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">LifecycleRegistry</span>(<span class=\"built_in\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@CallSuper</span>                                                   </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                    </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onSaveInstanceState</span><span class=\"params\">(Bundle outState)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 这里需要注意，onSaveInstanceState 状态设置为 CREATED</span></span><br><span class=\"line\">    mLifecycleRegistry.markState(Lifecycle.State.CREATED);   </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onSaveInstanceState(outState);                     </span><br><span class=\"line\">&#125;                                                            </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                         </span><br><span class=\"line\"><span class=\"keyword\">public</span> Lifecycle <span class=\"title function_\">getLifecycle</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">    <span class=\"keyword\">return</span> mLifecycleRegistry;    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                        </span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;RestrictedApi&quot;)</span>                               </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> Bundle savedInstanceState)</span> &#123;   </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onCreate(savedInstanceState);                          </span><br><span class=\"line\">    ReportFragment.injectIfNeededIn(<span class=\"built_in\">this</span>);                       </span><br><span class=\"line\">&#125;                                                                </span><br></pre></td></tr></table></figure>\n\n<p>可以看到代码非常简洁，那它又是怎么去实现的呢？可以看到在 <code>onCreate</code> 中会调用 <code>ReportFragment.injectIfNeededIn</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">injectIfNeededIn</span><span class=\"params\">(Activity activity)</span> &#123;                                     </span><br><span class=\"line\">    <span class=\"comment\">// ProcessLifecycleOwner should always correctly work and some activities may not extend </span></span><br><span class=\"line\">    <span class=\"comment\">// FragmentActivity from support lib, so we use framework fragments for activities       </span></span><br><span class=\"line\">    android.app.<span class=\"type\">FragmentManager</span> <span class=\"variable\">manager</span> <span class=\"operator\">=</span> activity.getFragmentManager();                     </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class=\"literal\">null</span>) &#123;                            </span><br><span class=\"line\">        manager.beginTransaction().add(<span class=\"keyword\">new</span> <span class=\"title class_\">ReportFragment</span>(), REPORT_FRAGMENT_TAG).commit();  </span><br><span class=\"line\">        <span class=\"comment\">// Hopefully, we are the first to make a transaction.                                </span></span><br><span class=\"line\">        manager.executePendingTransactions();                                                </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">&#125;   </span><br></pre></td></tr></table></figure>\n\n<p>这里会添加一个 <code>ReportFragment</code> 如果有阅读过 Glide 源码的同学，应该会看到类似的实现：通过添加一个透明的 <code>Fragment</code> 会监听 <code>Activity</code> 的生命周期。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityCreated</span><span class=\"params\">(Bundle savedInstanceState)</span> &#123;              </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onActivityCreated(savedInstanceState);                        </span><br><span class=\"line\">    dispatchCreate(mProcessListener);                                   </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_CREATE);                                </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                        </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onStart</span><span class=\"params\">()</span> &#123;                                                 </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onStart();                                                    </span><br><span class=\"line\">    dispatchStart(mProcessListener);                                    </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_START);                                 </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                        </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onResume</span><span class=\"params\">()</span> &#123;                                                </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onResume();                                                   </span><br><span class=\"line\">    dispatchResume(mProcessListener);                                   </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_RESUME);                                </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                        </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onPause</span><span class=\"params\">()</span> &#123;                                                 </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onPause();                                                    </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_PAUSE);                                 </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                        </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onStop</span><span class=\"params\">()</span> &#123;                                                  </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onStop();                                                     </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_STOP);                                  </span><br><span class=\"line\">&#125;                                                                       </span><br><span class=\"line\">                                                                        </span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                               </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onDestroy</span><span class=\"params\">()</span> &#123;                                               </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onDestroy();                                                  </span><br><span class=\"line\">    dispatch(Lifecycle.Event.ON_DESTROY);                               </span><br><span class=\"line\">    <span class=\"comment\">// just want to be sure that we won&#x27;t leak reference to an activity </span></span><br><span class=\"line\">    mProcessListener = <span class=\"literal\">null</span>;                                            </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">dispatch</span><span class=\"params\">(Lifecycle.Event event)</span> &#123;                                         </span><br><span class=\"line\">    <span class=\"type\">Activity</span> <span class=\"variable\">activity</span> <span class=\"operator\">=</span> getActivity();                                                 </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (activity <span class=\"keyword\">instanceof</span> LifecycleRegistryOwner) &#123;                                  </span><br><span class=\"line\">        ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                        </span><br><span class=\"line\">    &#125;                                                                                  </span><br><span class=\"line\">                                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (activity <span class=\"keyword\">instanceof</span> LifecycleOwner) &#123;                                          </span><br><span class=\"line\">        <span class=\"type\">Lifecycle</span> <span class=\"variable\">lifecycle</span> <span class=\"operator\">=</span> ((LifecycleOwner) activity).getLifecycle();              </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (lifecycle <span class=\"keyword\">instanceof</span> LifecycleRegistry) &#123;                                  </span><br><span class=\"line\">            ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);               </span><br><span class=\"line\">        &#125;                                                                              </span><br><span class=\"line\">    &#125;                                                                                  </span><br><span class=\"line\">&#125;                                                                                      </span><br></pre></td></tr></table></figure>\n\n<p>在 <code>Activity</code> 的各种生命周期回调方法中，调用 <code>handleLifecycleEvent()</code> 分发 <code>Lifecycle.Event</code></p>\n<h5 id=\"handleLifecycleEvent\"><a href=\"#handleLifecycleEvent\" class=\"headerlink\" title=\"handleLifecycleEvent\"></a>handleLifecycleEvent</h5><p><code>LifecycleRegistry</code> 是 <code>Lifecycle</code> 的实现类，看下 <code>handleLifecycleEvent</code> 的实现：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handleLifecycleEvent</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Lifecycle.Event event)</span> &#123;    </span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">next</span> <span class=\"operator\">=</span> getStateAfter(event);                                </span><br><span class=\"line\">    moveToState(next);                                                </span><br><span class=\"line\">&#125;                                                                     </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// event 和 Sate 的对应关系</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> State <span class=\"title function_\">getStateAfter</span><span class=\"params\">(Event event)</span> &#123;                                  </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (event) &#123;                                                       </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_CREATE:                                                    </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_STOP:                                                      </span><br><span class=\"line\">            <span class=\"keyword\">return</span> CREATED;                                                </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_START:                                                     </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_PAUSE:                                                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> STARTED;                                                </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_RESUME:                                                    </span><br><span class=\"line\">            <span class=\"keyword\">return</span> RESUMED;                                                </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_DESTROY:                                                   </span><br><span class=\"line\">            <span class=\"keyword\">return</span> DESTROYED;                                              </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_ANY:                                                       </span><br><span class=\"line\">            <span class=\"keyword\">break</span>;                                                         </span><br><span class=\"line\">    &#125;                                                                      </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Unexpected event value &quot;</span> + event); </span><br><span class=\"line\">&#125;                                                                          </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">moveToState</span><span class=\"params\">(State next)</span> &#123;                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mState == next) &#123;                                             </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                       </span><br><span class=\"line\">    &#125;                                                                 </span><br><span class=\"line\">    mState = next;                                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mHandlingEvent || mAddingObserverCounter != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 正在处理事件中或者正在处理添加 Observer 中</span></span><br><span class=\"line\">        mNewEventOccurred = <span class=\"literal\">true</span>;                                     </span><br><span class=\"line\">        <span class=\"comment\">// we will figure out what to do on upper level.              </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 标记正在处理事件</span></span><br><span class=\"line\">    mHandlingEvent = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 同步状态</span></span><br><span class=\"line\">    sync();                                                           </span><br><span class=\"line\">    mHandlingEvent = <span class=\"literal\">false</span>;                                           </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// happens only on the top of stack (never in reentrance),                                    </span></span><br><span class=\"line\"><span class=\"comment\">// so it doesn&#x27;t have to take in account parents                                              </span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sync</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 使用弱应用持有 LifecycleOwner，也是为了防止 Activity/Fragment 内存泄漏</span></span><br><span class=\"line\">    <span class=\"type\">LifecycleOwner</span> <span class=\"variable\">lifecycleOwner</span> <span class=\"operator\">=</span> mLifecycleOwner.get();                                    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (lifecycleOwner == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        Log.w(LOG_TAG, <span class=\"string\">&quot;LifecycleOwner is garbage collected, you shouldn&#x27;t try dispatch &quot;</span>     </span><br><span class=\"line\">                + <span class=\"string\">&quot;new events from it.&quot;</span>);                                                     </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                               </span><br><span class=\"line\">    &#125;                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (!isSynced()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果还没完成同步</span></span><br><span class=\"line\">        mNewEventOccurred = <span class=\"literal\">false</span>;                                                            </span><br><span class=\"line\">        <span class=\"comment\">// no need to check eldest for nullability, because isSynced does it for us.     </span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 使用 eldest(start) 判断是否需要回退 </span></span><br><span class=\"line\">        <span class=\"comment\">// 使用 newest(end) 判断是否需要前进，刚添加的 observer 一般为初始化状态</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 最先添加的 observer 的状态大于当前状态，回退</span></span><br><span class=\"line\">            backwardPass(lifecycleOwner);                                                     </span><br><span class=\"line\">        &#125;                                                                                     </span><br><span class=\"line\">        Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();           </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class=\"literal\">null</span>                                              </span><br><span class=\"line\">                &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 最新添加的 observer 如果状态一致，则可以乐观地表示在它之前添加的 observer 状态也是一致的</span></span><br><span class=\"line\">            <span class=\"comment\">// mNewEventOccurred 表示有新的事件发生，则放弃这次同步，延迟到下一次</span></span><br><span class=\"line\">            forwardPass(lifecycleOwner);                                                      </span><br><span class=\"line\">        &#125;                                                                                     </span><br><span class=\"line\">    &#125;                                                                                         </span><br><span class=\"line\">    mNewEventOccurred = <span class=\"literal\">false</span>;                                                                </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">boolean</span> <span class=\"title function_\">isSynced</span><span class=\"params\">()</span> &#123;                                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mObserverMap.size() == <span class=\"number\">0</span>) &#123;                                                     </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                                                                    </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// eldest 最先添加的，newest 最新添加的</span></span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">eldestObserverState</span> <span class=\"operator\">=</span> mObserverMap.eldest().getValue().mState;                </span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">newestObserverState</span> <span class=\"operator\">=</span> mObserverMap.newest().getValue().mState;</span><br><span class=\"line\">    <span class=\"comment\">// 判断状态是否一致</span></span><br><span class=\"line\">    <span class=\"type\">return</span> <span class=\"variable\">eldestObserverState</span> <span class=\"operator\">=</span>= newestObserverState &amp;&amp; mState == newestObserverState; </span><br><span class=\"line\">&#125;                                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>使用 <code>sync()</code> 同步状态，这里分为两种情况，一种是需要回退状态（backward），另外一种则是需要前进（forward），其中 <code>backward</code> 代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backwardPass</span><span class=\"params\">(LifecycleOwner lifecycleOwner)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 使用 eldest(start) 判断是否需要回退 </span></span><br><span class=\"line\">    <span class=\"comment\">// 降序迭代，end -&gt; start</span></span><br><span class=\"line\">    Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; descendingIterator =         </span><br><span class=\"line\">            mObserverMap.descendingIterator();                                         </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (descendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// mNewEventOccurred 判断是否有新事件分发</span></span><br><span class=\"line\">        Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = descendingIterator.next(); </span><br><span class=\"line\">        <span class=\"type\">ObserverWithState</span> <span class=\"variable\">observer</span> <span class=\"operator\">=</span> entry.getValue();                                 </span><br><span class=\"line\">        <span class=\"keyword\">while</span> ((observer.mState.compareTo(mState) &gt; <span class=\"number\">0</span> &amp;&amp; !mNewEventOccurred            </span><br><span class=\"line\">                &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 回退</span></span><br><span class=\"line\">            <span class=\"comment\">// 举个例子：observer.state 为 RESUMED</span></span><br><span class=\"line\">            <span class=\"comment\">// mState 为 CREATED</span></span><br><span class=\"line\">            <span class=\"comment\">// downEvent(observer.state) 为 ON_PAUSE</span></span><br><span class=\"line\">            <span class=\"type\">Event</span> <span class=\"variable\">event</span> <span class=\"operator\">=</span> downEvent(observer.mState);</span><br><span class=\"line\">            <span class=\"comment\">// getStateAfter(event) 为 STARTED</span></span><br><span class=\"line\">            <span class=\"comment\">// 最终：RESUMED -&gt; STARTED，在下一次同步中再同步为 CREATED</span></span><br><span class=\"line\">            <span class=\"comment\">// pushParentState 和 popParentState 则是将 state 暂存在 List 中，这个作用我们会在 addObserver 中讲</span></span><br><span class=\"line\">            pushParentState(getStateAfter(event));</span><br><span class=\"line\">            <span class=\"comment\">// 分发事件</span></span><br><span class=\"line\">            observer.dispatchEvent(lifecycleOwner, event);                             </span><br><span class=\"line\">            popParentState();                                                          </span><br><span class=\"line\">        &#125;                                                                              </span><br><span class=\"line\">    &#125;                                                                                  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Event <span class=\"title function_\">downEvent</span><span class=\"params\">(State state)</span> &#123;                             </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (state) &#123;                                                      </span><br><span class=\"line\">        <span class=\"keyword\">case</span> INITIALIZED:                                                 </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();                         </span><br><span class=\"line\">        <span class=\"keyword\">case</span> CREATED:                                                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_DESTROY;                                            </span><br><span class=\"line\">        <span class=\"keyword\">case</span> STARTED:                                                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_STOP;                                               </span><br><span class=\"line\">        <span class=\"keyword\">case</span> RESUMED:                                                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_PAUSE;                                              </span><br><span class=\"line\">        <span class=\"keyword\">case</span> DESTROYED:                                                   </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();                         </span><br><span class=\"line\">    &#125;                                                                     </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Unexpected state value &quot;</span> + state);</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> State <span class=\"title function_\">getStateAfter</span><span class=\"params\">(Event event)</span> &#123;                                   </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (event) &#123;                                                        </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_CREATE:                                                     </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_STOP:                                                       </span><br><span class=\"line\">            <span class=\"keyword\">return</span> CREATED;                                                 </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_START:                                                      </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_PAUSE:                                                      </span><br><span class=\"line\">            <span class=\"keyword\">return</span> STARTED;                                                 </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_RESUME:                                                     </span><br><span class=\"line\">            <span class=\"keyword\">return</span> RESUMED;                                                 </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_DESTROY:                                                    </span><br><span class=\"line\">            <span class=\"keyword\">return</span> DESTROYED;                                               </span><br><span class=\"line\">        <span class=\"keyword\">case</span> ON_ANY:                                                        </span><br><span class=\"line\">            <span class=\"keyword\">break</span>;                                                          </span><br><span class=\"line\">    &#125;                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Unexpected event value &quot;</span> + event);  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ObserverWithState.java</span></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">dispatchEvent</span><span class=\"params\">(LifecycleOwner owner, Event event)</span> &#123; </span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">newState</span> <span class=\"operator\">=</span> getStateAfter(event);</span><br><span class=\"line\">    <span class=\"comment\">// 使用较小的状态同步</span></span><br><span class=\"line\">    mState = min(mState, newState);                     </span><br><span class=\"line\">    mLifecycleObserver.onStateChanged(owner, event);    </span><br><span class=\"line\">    mState = newState;                                  </span><br><span class=\"line\">&#125;                                                       </span><br></pre></td></tr></table></figure>\n\n<p>总结下 <code>backwardPass()</code> 的逻辑：将较大的状态逐步回退。为什么说是逐步呢？比如 <code>observer.state</code> 是 <code>RESUMED</code>，当前状态是 <code>CREATED</code>，那这里会分两次回退，分别为：<code>RESUMED -&gt; STARTED</code> 和 <code>STARTED -&gt; CREATED</code></p>\n<p><code>forwardPass()</code> 逻辑类似，则不分析了。</p>\n<h5 id=\"addObserver\"><a href=\"#addObserver\" class=\"headerlink\" title=\"addObserver\"></a>addObserver</h5><p><code>addObserver()</code> 是添加 <code>Observer</code> 的方法，源码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                                                                 </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addObserver</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> LifecycleObserver observer)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果不是 DESTROYED，则从 INITIALIZED 开始分发</span></span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">initialState</span> <span class=\"operator\">=</span> mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class=\"line\">    <span class=\"comment\">// ObserverWithState 用于分发事件给 observer</span></span><br><span class=\"line\">    <span class=\"type\">ObserverWithState</span> <span class=\"variable\">statefulObserver</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObserverWithState</span>(observer, initialState);   </span><br><span class=\"line\">    <span class=\"type\">ObserverWithState</span> <span class=\"variable\">previous</span> <span class=\"operator\">=</span> mObserverMap.putIfAbsent(observer, statefulObserver);    </span><br><span class=\"line\">                                                                                          </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (previous != <span class=\"literal\">null</span>) &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 唯一性</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                           </span><br><span class=\"line\">    &#125;                                                                                     </span><br><span class=\"line\">    <span class=\"type\">LifecycleOwner</span> <span class=\"variable\">lifecycleOwner</span> <span class=\"operator\">=</span> mLifecycleOwner.get();                                </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (lifecycleOwner == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">        <span class=\"comment\">// mLifecycleOwner 为弱引用</span></span><br><span class=\"line\">        <span class=\"comment\">// it is null we should be destroyed. Fallback quickly                            </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                           </span><br><span class=\"line\">    &#125;                                                                                     </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// isReentrance 表示是否在分发事件时新添加了 observer</span></span><br><span class=\"line\">    <span class=\"comment\">// 举个例子：在 observer 在 onStart() 中又调用了 addObserver()</span></span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">isReentrance</span> <span class=\"operator\">=</span> mAddingObserverCounter != <span class=\"number\">0</span> || mHandlingEvent; </span><br><span class=\"line\">    <span class=\"comment\">// 计算需要分发的状态</span></span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">targetState</span> <span class=\"operator\">=</span> calculateTargetState(observer);                                   </span><br><span class=\"line\">    mAddingObserverCounter++; </span><br><span class=\"line\">    <span class=\"comment\">// 将事件逐步分发到 targetState</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class=\"number\">0</span>                            </span><br><span class=\"line\">            &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果 statefulObserver.state 小于 targetState</span></span><br><span class=\"line\">        pushParentState(statefulObserver.mState);</span><br><span class=\"line\">        <span class=\"comment\">// 如果 state 为 STARTED，则 upEvent(state) 则为 ON_RESUME</span></span><br><span class=\"line\">        statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState)); </span><br><span class=\"line\">        popParentState();                                                                 </span><br><span class=\"line\">        <span class=\"comment\">// mState / subling may have been changed recalculate                             </span></span><br><span class=\"line\">        targetState = calculateTargetState(observer);                                     </span><br><span class=\"line\">    &#125;                                                                                     </span><br><span class=\"line\">                                                                                          </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!isReentrance) &#123;                                                                  </span><br><span class=\"line\">        <span class=\"comment\">// we do sync only on the top level.</span></span><br><span class=\"line\">        <span class=\"comment\">// 当前为重入，则不进行同步</span></span><br><span class=\"line\">        sync();                                                                           </span><br><span class=\"line\">    &#125;                                                                                     </span><br><span class=\"line\">    mAddingObserverCounter--;                                                             </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Event <span class=\"title function_\">upEvent</span><span class=\"params\">(State state)</span> &#123;                                  </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (state) &#123;                                                         </span><br><span class=\"line\">        <span class=\"keyword\">case</span> INITIALIZED:                                                    </span><br><span class=\"line\">        <span class=\"keyword\">case</span> DESTROYED:                                                      </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_CREATE;                                                </span><br><span class=\"line\">        <span class=\"keyword\">case</span> CREATED:                                                        </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_START;                                                 </span><br><span class=\"line\">        <span class=\"keyword\">case</span> STARTED:                                                        </span><br><span class=\"line\">            <span class=\"keyword\">return</span> ON_RESUME;                                                </span><br><span class=\"line\">        <span class=\"keyword\">case</span> RESUMED:                                                        </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>();                            </span><br><span class=\"line\">    &#125;                                                                        </span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Unexpected state value &quot;</span> + state);   </span><br><span class=\"line\">&#125;                                                                            </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> State <span class=\"title function_\">calculateTargetState</span><span class=\"params\">(LifecycleObserver observer)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获取上一个添加的 observer</span></span><br><span class=\"line\">    Entry&lt;LifecycleObserver, ObserverWithState&gt; previous = mObserverMap.ceil(observer);       </span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">siblingState</span> <span class=\"operator\">=</span> previous != <span class=\"literal\">null</span> ? previous.getValue().mState : <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">// mParentStates 是个 List，它的添加和删除分别由 pushParentState() 和 popParentState()，它们是成对出现的，在 dispatchEvent 的前后</span></span><br><span class=\"line\">    <span class=\"comment\">// 在这种 case 下，会存在 parentState：在 dispatchEvent 时，又调用了 addObserver()，即上面说的 isReentrance</span></span><br><span class=\"line\">    <span class=\"type\">State</span> <span class=\"variable\">parentState</span> <span class=\"operator\">=</span> !mParentStates.isEmpty() ? mParentStates.get(mParentStates.size() - <span class=\"number\">1</span>)</span><br><span class=\"line\">            : <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 这里的计算是获取更合适的状态</span></span><br><span class=\"line\">    <span class=\"comment\">// 考虑以下这种 case：某个 observer 在 onStart() 中再调用 addObserver，那这个 observer 理应使用 STARTED 状态分发，而当前状态即 mState 可能是 RESUMED，再在 sync() 中进行同步</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> min(min(mState, siblingState), parentState);                                       </span><br><span class=\"line\">&#125;                                                                                             </span><br></pre></td></tr></table></figure>\n\n<p><code>addObserver()</code> 主要考虑了 Reentrance 的情况，即在 <code>observer</code> 的事件分发中，又添加了新的 <code>observer</code> 的情况。</p>\n<h4 id=\"ProcessLifecycleOwner\"><a href=\"#ProcessLifecycleOwner\" class=\"headerlink\" title=\"ProcessLifecycleOwner\"></a>ProcessLifecycleOwner</h4><p><code>ProcessLifecycleOwner</code> 提供应用进程的生命周期。跟 <code>Activity</code> 和 <code>Fragment</code> 的生命周期不一样的是：</p>\n<ul>\n<li><code>ON_CREATE</code> 只会分发一次</li>\n<li><code>ON_DESTROY</code> 则不会被分发</li>\n<li><code>ON_START</code> 和 <code>ON_RESUME</code> 在第一个 <code>Activity</code> 的时候分发</li>\n<li><code>ON_PAUSE</code> 和 <code>ON_STOP</code> 则在最后一个 <code>Activity</code> 的时候<strong>延迟</strong>分发，用于防止因为配置改变，而导致 <code>Activity</code> 重建</li>\n</ul>\n<p>下面我们来分析下 <code>ProcessLifecycleOwner</code> 的源码，首先看下 <code>init()</code>：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 单例</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">ProcessLifecycleOwner</span> <span class=\"variable\">sInstance</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ProcessLifecycleOwner</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">(Context context)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 调用 attach</span></span><br><span class=\"line\">    sInstance.attach(context);      </span><br><span class=\"line\">&#125;                                   </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">attach</span><span class=\"params\">(Context context)</span> &#123;                                                          </span><br><span class=\"line\">    mHandler = <span class=\"keyword\">new</span> <span class=\"title class_\">Handler</span>();</span><br><span class=\"line\">    <span class=\"comment\">// 同样是使用 LifecycleRegistry 来处理</span></span><br><span class=\"line\">    <span class=\"comment\">// 先分发 ON_CREATE，而且只会分发一次</span></span><br><span class=\"line\">    mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);                          </span><br><span class=\"line\">    <span class=\"type\">Application</span> <span class=\"variable\">app</span> <span class=\"operator\">=</span> (Application) context.getApplicationContext();</span><br><span class=\"line\">    app.registerActivityLifecycleCallbacks(<span class=\"keyword\">new</span> <span class=\"title class_\">EmptyActivityLifecycleCallbacks</span>() &#123;      </span><br><span class=\"line\">        <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityCreated</span><span class=\"params\">(Activity activity, Bundle savedInstanceState)</span> &#123;   </span><br><span class=\"line\">            ReportFragment.get(activity).setProcessListener(mInitializationListener);   </span><br><span class=\"line\">        &#125;                                                                               </span><br><span class=\"line\">                                                                                        </span><br><span class=\"line\">        <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityPaused</span><span class=\"params\">(Activity activity)</span> &#123;                               </span><br><span class=\"line\">            activityPaused();                                                           </span><br><span class=\"line\">        &#125;                                                                               </span><br><span class=\"line\">                                                                                        </span><br><span class=\"line\">        <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityStopped</span><span class=\"params\">(Activity activity)</span> &#123;                              </span><br><span class=\"line\">            activityStopped();                                                          </span><br><span class=\"line\">        &#125;                                                                               </span><br><span class=\"line\">    &#125;);                                                                                 </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">ActivityInitializationListener</span> <span class=\"variable\">mInitializationListener</span> <span class=\"operator\">=</span>      </span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">ActivityInitializationListener</span>() &#123;                </span><br><span class=\"line\">            <span class=\"meta\">@Override</span>                                         </span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">()</span> &#123;                          </span><br><span class=\"line\">            &#125;                                                 </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">            <span class=\"meta\">@Override</span>                                         </span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onStart</span><span class=\"params\">()</span> &#123;                           </span><br><span class=\"line\">                activityStarted();                            </span><br><span class=\"line\">            &#125;                                                 </span><br><span class=\"line\">                                                              </span><br><span class=\"line\">            <span class=\"meta\">@Override</span>                                         </span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onResume</span><span class=\"params\">()</span> &#123;                          </span><br><span class=\"line\">                activityResumed();                            </span><br><span class=\"line\">            &#125;                                                 </span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      </span><br><span class=\"line\">                                                 </span><br><span class=\"line\"><span class=\"comment\">// ground truth counters                         </span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">mStartedCounter</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;                 </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">mResumedCounter</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;                 </span><br><span class=\"line\">                                                 </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">boolean</span> <span class=\"variable\">mPauseSent</span> <span class=\"operator\">=</span> <span class=\"literal\">true</span>;               </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">boolean</span> <span class=\"variable\">mStopSent</span> <span class=\"operator\">=</span> <span class=\"literal\">true</span>;                </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">activityStarted</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 计数</span></span><br><span class=\"line\">    mStartedCounter++;                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartedCounter == <span class=\"number\">1</span> &amp;&amp; mStopSent) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 第一次调用，分发 ON_START</span></span><br><span class=\"line\">        <span class=\"comment\">// mStopSent 为 true 的情况：</span></span><br><span class=\"line\">        <span class=\"comment\">// 1. 默认为 true</span></span><br><span class=\"line\">        <span class=\"comment\">// 2. dispatchStopIfNeeded 中设置</span></span><br><span class=\"line\">        <span class=\"comment\">// 防止因为配置改变，Activity 创建而导致重新分发</span></span><br><span class=\"line\">        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START); </span><br><span class=\"line\">        mStopSent = <span class=\"literal\">false</span>;                                        </span><br><span class=\"line\">    &#125;                                                             </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">void</span> <span class=\"title function_\">activityResumed</span><span class=\"params\">()</span> &#123;                                               </span><br><span class=\"line\">     mResumedCounter++;                                                 </span><br><span class=\"line\">     <span class=\"keyword\">if</span> (mResumedCounter == <span class=\"number\">1</span>) &#123;                                        </span><br><span class=\"line\">         <span class=\"keyword\">if</span> (mPauseSent) &#123;</span><br><span class=\"line\">             <span class=\"comment\">// 第一次调用分发 ON_RESUME</span></span><br><span class=\"line\">             mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME); </span><br><span class=\"line\">             mPauseSent = <span class=\"literal\">false</span>;                                        </span><br><span class=\"line\">         &#125; <span class=\"keyword\">else</span> &#123; </span><br><span class=\"line\">             <span class=\"comment\">// 配置改变，Activity 创建，删除延迟的 pause runnable</span></span><br><span class=\"line\">             mHandler.removeCallbacks(mDelayedPauseRunnable);           </span><br><span class=\"line\">         &#125;                                                              </span><br><span class=\"line\">     &#125;                                                                  </span><br><span class=\"line\"> &#125;                                                                      </span><br></pre></td></tr></table></figure>\n\n<p>上面是初始事件分发流程，下面我们来看下 <code>ON_PAUSE</code> 和 <code>ON_STOP</code> 的分发：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@VisibleForTesting</span>                               </span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">TIMEOUT_MS</span> <span class=\"operator\">=</span> <span class=\"number\">700</span>; <span class=\"comment\">//mls </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 在 onActivityPaused 中调用</span></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">activityPaused</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 计数</span></span><br><span class=\"line\">    mResumedCounter--;                                              </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mResumedCounter == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 延迟分发</span></span><br><span class=\"line\">        mHandler.postDelayed(mDelayedPauseRunnable, TIMEOUT_MS);    </span><br><span class=\"line\">    &#125;                                                               </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">Runnable</span> <span class=\"variable\">mDelayedPauseRunnable</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123; </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                             </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">        <span class=\"comment\">// 延迟分发</span></span><br><span class=\"line\">        dispatchPauseIfNeeded();                          </span><br><span class=\"line\">        dispatchStopIfNeeded();                           </span><br><span class=\"line\">    &#125;                                                     </span><br><span class=\"line\">&#125;;                                                        </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">activityStopped</span><span class=\"params\">()</span> &#123; </span><br><span class=\"line\">    <span class=\"comment\">// 计数</span></span><br><span class=\"line\">    mStartedCounter--;                                              </span><br><span class=\"line\">    dispatchStopIfNeeded();                                         </span><br><span class=\"line\">&#125;                                                                   </span><br><span class=\"line\">                                                                    </span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">dispatchPauseIfNeeded</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mResumedCounter == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 计数</span></span><br><span class=\"line\">        mPauseSent = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 分发 ON_PAUSE</span></span><br><span class=\"line\">        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);   </span><br><span class=\"line\">    &#125;                                                               </span><br><span class=\"line\">&#125;                                                                   </span><br><span class=\"line\">                                                                    </span><br><span class=\"line\"><span class=\"keyword\">void</span> <span class=\"title function_\">dispatchStopIfNeeded</span><span class=\"params\">()</span> &#123;                                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartedCounter == <span class=\"number\">0</span> &amp;&amp; mPauseSent) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 计数为 0，同时已经分发了 ON_PAUSE</span></span><br><span class=\"line\">        <span class=\"comment\">// 分发 ON_STOP</span></span><br><span class=\"line\">        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_STOP);    </span><br><span class=\"line\">        mStopSent = <span class=\"literal\">true</span>;                                           </span><br><span class=\"line\">    &#125;                                                               </span><br><span class=\"line\">&#125;                                                                   </span><br></pre></td></tr></table></figure>\n\n<p>到这里，我们已经将 <code>ProcessLifecycleOwner</code> 的流程分析完了，那 <code>ProcessLifecycleOwner.init()</code> 是在那里调用的呢？</p>\n<p>其实是用了一种比较巧妙的方法，在 <code>lifecycle-process</code> 这个包下的 <code>AndroidManifest.xml</code> 文件中，可以看到有如下配置：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">application</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">provider</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;androidx.lifecycle.ProcessLifecycleOwnerInitializer&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:authorities</span>=<span class=\"string\">&quot;$&#123;applicationId&#125;.lifecycle-process&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:exported</span>=<span class=\"string\">&quot;false&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:multiprocess</span>=<span class=\"string\">&quot;true&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">application</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>其中 <code>ProcessLifecycleOwnerInitializer</code> 是一个 <code>ContentProvider</code> 即利用 <code>ContentProvider</code> 来实现自动初始化</p>\n<blockquote>\n<p>ContentProvider 的 <code>onCreate</code> 方法会在应用启动时候调用</p>\n<p>Implement this to initialize your content provider on startup. This method is called for all registered content providers on the application main thread at application launch time. It must not perform lengthy operations, or application startup will be delayed.</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span>                                     </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">onCreate</span><span class=\"params\">()</span> &#123;                   </span><br><span class=\"line\">    LifecycleDispatcher.init(getContext());   </span><br><span class=\"line\">    ProcessLifecycleOwner.init(getContext()); </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;                              </span><br><span class=\"line\">&#125;                                             </span><br></pre></td></tr></table></figure>\n\n<p>可以看到这里调用了两个初始化方法，其中 <code>ProcessLifecycleOwner.init()</code> 我们已经分析了，再看看 <code>LifecycleDispatcher.init()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">(Context context)</span> &#123;                                                 </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (sInitialized.getAndSet(<span class=\"literal\">true</span>)) &#123;                                             </span><br><span class=\"line\">        <span class=\"keyword\">return</span>;                                                                     </span><br><span class=\"line\">    &#125;                                                                               </span><br><span class=\"line\">    ((Application) context.getApplicationContext())                                 </span><br><span class=\"line\">            .registerActivityLifecycleCallbacks(<span class=\"keyword\">new</span> <span class=\"title class_\">DispatcherActivityCallback</span>());  </span><br><span class=\"line\">&#125;                                                                                   </span><br><span class=\"line\">                                                                                    </span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;WeakerAccess&quot;)</span>                                                   </span><br><span class=\"line\"><span class=\"meta\">@VisibleForTesting</span>                                                                  </span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DispatcherActivityCallback</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">EmptyActivityLifecycleCallbacks</span> &#123;   </span><br><span class=\"line\">                                                                                    </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityCreated</span><span class=\"params\">(Activity activity, Bundle savedInstanceState)</span> &#123;   </span><br><span class=\"line\">        ReportFragment.injectIfNeededIn(activity);                                  </span><br><span class=\"line\">    &#125;                                                                               </span><br><span class=\"line\">                                                                                    </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivityStopped</span><span class=\"params\">(Activity activity)</span> &#123;                              </span><br><span class=\"line\">    &#125;                                                                               </span><br><span class=\"line\">                                                                                    </span><br><span class=\"line\">    <span class=\"meta\">@Override</span>                                                                       </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onActivitySaveInstanceState</span><span class=\"params\">(Activity activity, Bundle outState)</span> &#123;   </span><br><span class=\"line\">    &#125;                                                                               </span><br><span class=\"line\">&#125;                                                                                   </span><br></pre></td></tr></table></figure>\n\n<p>初始化的逻辑比较简单，即在 <code>Activity</code> 创建时，调用 <code>ReportFragment.injectIfneededIn()</code> ，其实我们在 <code>Activity</code> 的 <code>Lifecycle</code> 处理中，也见到这个方法： </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ComponentActivity.java</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span>                                                        </span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;RestrictedApi&quot;)</span>                               </span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">(<span class=\"meta\">@Nullable</span> Bundle savedInstanceState)</span> &#123;   </span><br><span class=\"line\">    <span class=\"built_in\">super</span>.onCreate(savedInstanceState);                          </span><br><span class=\"line\">    ReportFragment.injectIfNeededIn(<span class=\"built_in\">this</span>);                       </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ReportFragment.java</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">injectIfNeededIn</span><span class=\"params\">(Activity activity)</span> &#123;                                      </span><br><span class=\"line\">    <span class=\"comment\">// ProcessLifecycleOwner should always correctly work and some activities may not extend  </span></span><br><span class=\"line\">    <span class=\"comment\">// FragmentActivity from support lib, so we use framework fragments for activities        </span></span><br><span class=\"line\">    android.app.<span class=\"type\">FragmentManager</span> <span class=\"variable\">manager</span> <span class=\"operator\">=</span> activity.getFragmentManager();                      </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 重复添加判断</span></span><br><span class=\"line\">        manager.beginTransaction().add(<span class=\"keyword\">new</span> <span class=\"title class_\">ReportFragment</span>(), REPORT_FRAGMENT_TAG).commit();   </span><br><span class=\"line\">        <span class=\"comment\">// Hopefully, we are the first to make a transaction.                                 </span></span><br><span class=\"line\">        manager.executePendingTransactions();                                                 </span><br><span class=\"line\">    &#125;                                                                                         </span><br><span class=\"line\">&#125;                                                                                             </span><br></pre></td></tr></table></figure>\n\n<p>这里可以理解为双重保障吧，可能存在不继承 <code>ComponentActivity</code> 的 <code>Activity</code>。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>分析了 <code>Lifecycle</code>  的整个流程，可以发现其实逻辑还是比较简单的，实现上也是参考了其他开源库的做法，比如 <code>ReportFragment</code> 通过添加一个透明的 <code>Fragment</code> 去感知 <code>Activity</code> 的生命周期，<code>Glide</code> 也是这么做的。还有使用 <code>ContentProvider</code> 去实现在 <code>Application</code> 创建时自动初始化，也是一个不错的想法。</p>\n<p><code>Lifecycle</code> 的源码比我一开始想象的复杂，不是在于它的逻辑，而是在 <code>sync()</code> 这一块，通过 <code>Listener</code> 执行状态回调是一个非常常见的做法，但是有很多需要考虑的 case，举个例子，在分发回调时，有新的状态发生，那么应该怎么去处理。或者，在回调方法中，又添加了新的 <code>Listener</code>，那应该怎么处理。</p>\n<p>学习源码，不仅仅是学习实现原理，还可以学习一个健壮的库是如何处理各种场景下的 case 的。</p>\n"},{"title":"浅谈Flutter构建","date":"2019-08-30T11:50:56.000Z","_content":"\n### 不同版本构建产物的差异\n\n写这篇文章的时间为：2019.08.25，当前 Flutter SDK 最新版本为 v1.9.5，其中 stable 最新版本为 v1.7.8+hotfix.4。\n\n随着版本的更新，Flutter 构建的产物也在调整，以 Android 为例，我们使用默认的 flutter_app 项目来测试，在不修改源码的情况下，使用不同的 SDK 版本来执行打包命令，每个版本都打两个包：debug 和 release。\n\n![APK](https://user-gold-cdn.xitu.io/2019/8/25/16cc779633694337?w=758&h=506&f=png&s=34431)\n\n每个版本生成的 Flutter 产物如下所示，这里不列出 fonts、LICENSE 这些文件：\n\n| 版本  | 类型    | 内容                                                         | 说明                                                         |\n| ----- | ------- | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| 1.5.4 | debug   | assets/flutter_assets/kernel_blob.bin<br />assets/flutter_assets/isolate_snapshot_data<br />assets/flutter_assets/vm_snapshot_data<br />lib/x86_64/libflutter.so<br />lib/x86/libflutter.so<br />lib/armeabi-v7a/libflutter.so |                                                              |\n| 1.5.4 | release | assets/isolate_snapshot_data<br />assets/isolate_snapshot_instr<br />assets/vm_snapshot_data<br />assets/vm_snapshot_instr<br />lib/armeabi-v7a/libflutter.so |                                                              |\n| 1.6.7 | debug   | 新增了<br />assets/snapshot_blob.bind.d.fingerprint<br />assets/snapshot_blob.bin.d<br /> |                                                              |\n| 1.6.7 | release | 无变化                                                       |                                                              |\n| 1.7.8 | debug   | 删除了<br />assets/snapshot_blob.bind.d.fingerprint<br />assets/snapshot_blob.bin.d<br />新增了<br />lib/arm64-v8a/libflutter.so |                                                              |\n| 1.7.8 | release | 删除了<br />assets/isolate_snapshot_data<br />assets/isolate_snapshot_instr<br />assets/vm_snapshot_data<br />assets/vm_snapshot_instr<br />新增了<br />lib/armeabi-v7a/libapp.so<br />lib/arm64-v8a/libflutter.so<br />lib/arm64-v8a/libapp.so | 从这个版本开始，release 下不使用 snapshot，同时增加了同时打包 64 位 so 文件 |\n| 1.8.4 | debug   | 无变化                                                       |                                                              |\n| 1.8.4 | release | 无变化                                                       |                                                              |\n| 1.9.5 | debug   | 无变化                                                       |                                                              |\n| 1.9.5 | release | 无变化                                                       |                                                              |\n\n从上面的表格来看，1.5.x 版本和 1.7.x 版本的变化是比较明显的，主要的变化有两点，第一，1.7.x 版本增加了支持同时编译 32 位和 64 位两种架构，这个在之前一直被诟病，现在官方支持了。第二，release 模式下，不使用 snapshot 文件，而使用 libapp.so。snapshot 是 Dart VM 所支持的一种文件格式，类似 JVM 的 jar 一样，可以运行在虚拟机环境的文件。\n\n除了变化以外，我们还注意到一些不变的文件，比如 debug 模式下，一直存在的 kernel_blob.bin 文件；lib 目录下 libflutter.so 文件；这些文件各自的作用又是什么呢。带着疑问，我们一起看看 Flutter 的构建过程。\n\n### Flutter 支持的编译模式\n\n> 关于编译模式这块主要参考的：\n>\n> * [Flutter’s Compilation Patterns](https://proandroiddev.com/flutters-compilation-patterns-24e139d14177)\n\nFlutter 是基于 Dart 开发的，所以 Flutter 的构建跟 Dart 是分不开的。所以，我们先讲 Dart。\n\n在将 Dart 之前，我们先了解两种编译模式，JIT 和 AOT：\n\n##### JIT\n\nJIT(Just In Time) 翻译为 **即时编译**，指的是在程序运行中，将热点代码编译成机器码，提高运行效率。常见例子有 V8 引擎和 JVM，JIT 可以充分利用解释型语言的优点，动态执行源码，而不用考虑平台差异性。这里需要注意的是，对于 JVM 来说，源码指字节码，而不是 Java 源码。\n\n> 这里需要区分，JIT 和解释型语言的区别，JIT 是一种编译模式，比如，Java 是编译型语言，但它也可以使用 JIT。\n\n##### AOT\n\nAOT(Ahead Of Time) 称为 **运行前编译**，指的是在程序运行之前，已经编译成对应平台的机器码，不需要在运行中解释编译，就可以直接运行。常见例子有 C 和 C++。\n\n虽然，我们会区别 JIT 和 AOT 两种编译模式，但实际上，有很多语言并不是完全使用 JIT 或者 AOT 的，通常它们会混用这两种模式，来达到最大的性能优化。\n\n#### Dart 支持的编译模式\n\nDart VM 支持四种编译模式：\n\n* **Script**：最常见的 JIT 模式，可以直接在虚拟机中执行 Dart 源码，像解释型语言一样使用。\n\n  通过执行 `dart xxx.dart` 就可以运行，写一些临时脚本，非常方便。\n\n* **Kernel Snapshots**：JIT 模式，和 **Script** 模式不同的是，这种模式执行的是 [Kernel AST](https://github.com/dart-lang/sdk/tree/master/pkg/kernel) 的二进制数据，这里不包含解析后的类和函数，编译后的代码，所以它们可以在不同的平台之间移植。\n\n  在 [Flutter’s Compilation Patterns](https://proandroiddev.com/flutters-compilation-patterns-24e139d14177) 这篇文章中，将 Kernel Snapshots 称为 Script Snapshots 也是对的，这应该是之前的叫法，从 [dart-lang](https://github.com/dart-lang) 的 [wiki](https://github.com/dart-lang/sdk/wiki/Snapshots/_compare/a3bb7a829f461bf4703533d23462f1ac3760a2d8) 中可以看出来：\n\n  ![Kernel Snapshots And Script Snapshots](https://user-gold-cdn.xitu.io/2019/8/27/16cd1d07e1258d95?w=986&h=299&f=png&s=62397)\n\n  \n\n  Dart Kernel 是 Dart 程序中的一种中间语言，更多的资料可阅读 [Kernel Documentation](https://github.com/dart-lang/sdk/wiki/Kernel-Documentation)。\n\n  通过执行 `dart --snapshot-kind=kernel --snapshot=xx.snapshot xx.dart` 生成。\n\n* **JIT Application Snapshots**：JIT 模式，这里执行的是已经解析过的类和函数，所以它会运行起来会更快。但是这不是平台无关，它只能针对 32位 或者 64位 架构运行。\n\n  通过执行 `dart --snapshot-kind=app-jit --snapshot=xx.snapshot xx.dart` 生成。\n\n* **AOT Application Snapshots**：AOT 模式，在这种模式下，Dart 源码会被提前编译成特定平台的二进制文件。\n\n  要使用 AOT 模式，需要使用 `dart2aot` 命令， 具体使用为：`dart2aot xx.dart xx.dart.aot`，然后使用 `dartaotruntime` 命令执行。\n\nDart JIT 模式需要配合 Dart VM(虚拟机) ，AOT 则会使用 runtime 来执行，引用官网中的图片来说明：\n\n![jit-and-aot](https://user-gold-cdn.xitu.io/2019/8/27/16cd13e09839fae9?w=795&h=252&f=png&s=18282)\n\n\n\n可以用下面这张图来总结上面的四种模式：\n\n> 图片来源于 [flutters-compilation-patterns](https://proandroiddev.com/flutters-compilation-patterns-24e139d14177)\n\n![Dart’s compilation patterns](https://user-gold-cdn.xitu.io/2019/8/25/16cc7eb579c05a1d?w=1344&h=386&f=png&s=54640)\n\n四种模式下的产物大小和启动速度比较：\n\n> 图片来源于 [exploring-flutter-in-android](https://medium.com/@takahirom/exploring-flutter-in-android-533598ba17d2)\n\n![whai is snapshot](https://user-gold-cdn.xitu.io/2019/8/28/16cd76297cd9f674?w=373&h=263&f=png&s=37448)\n\n### Flutter 构建过程\n\n> 下面的分析都是基于 **v1.5.4-hotfix.2**\n\n执行 `flutter build apk` 时，默认会生成 release APK，实际是执行的 sdk/bin/flutter 命令，参数为 build apk：\n\n``` shell\nDART_SDK_PATH=\"$FLUTTER_ROOT/bin/cache/dart-sdk\"\nDART=\"$DART_SDK_PATH/bin/dart\"\nSNAPSHOT_PATH=\"$FLUTTER_ROOT/bin/cache/flutter_tools.snapshot\"\n\"$DART\" $FLUTTER_TOOL_ARGS \"$SNAPSHOT_PATH\" \"$@\"\n```\n\n上面的命令完整应该为：`dart flutter_tools.snapshot args`，snapshot 文件我们上面提过，是 Dart 的一种代码集合，类似 Java 中 Jar 包。\n\nflutter_tools 的源码位于 sdk/packages/flutter_tools/bin 下的 flutter_tools.dart，跟 Java 一样，这里也有个 `main()` 函数，其中调用的是 `executable.main()` 函数。\n\n在 main 函数中，会注册多个命令处理器，比如：\n\n* DoctorCommand 对应 `flutter doctor` 命令\n* CleanCommand 对应 `flutter clean` 命令\n* 等等\n\n我们这次要研究的目标是 BuildCommand，它里面又包含了以下子命令处理器：\n\n* BuildApkCommand 对应 `flutter build apk` 命令\n* BuildAppBundleCommand 对应 `flutter build bundle` 命令\n* BuildAotCommand 对应 `flutter build aot` 命令\n* 等等\n\n#### Build APK\n\n首先我们要理清 build apk 或者 build ios，和 build bundle、build aot 之间的关系。这里我们以 build apk 为例：\n\n当执行 `flutter build apk` 时，最终会调用到 gradle.dart 中的 `_buildGradleProjectV2()` 方法，在这里最后也是调用 gradle 执行 assemble task。而在项目中的 android/app/build.gradle 中可以看到：\n\n``` groovy\napply from: \"$flutterRoot/packages/flutter_tools/gradle/flutter.gradle\"\n```\n\n也就是说，会在 flutter.gradle 这里去插入一些编译 Flutter 产物的脚本。\n\nflutter.gradle 是通过插件的形式去实现的，这个插件命名为 FlutterPlugin。这个插件的主要作用有一些几点：\n\n* 除了默认的 debug 和 release 之外，新增了 profile、dynamicProfile、dynamicRelease 这三种 buildTypes：\n\n  ``` groovy\n  project.android.buildTypes {                                \n      profile {                                               \n          initWith debug                                      \n          if (it.hasProperty('matchingFallbacks')) {          \n              matchingFallbacks = ['debug', 'release']        \n          }                                                   \n      }                                                       \n      dynamicProfile {                                        \n          initWith debug                                      \n          if (it.hasProperty('matchingFallbacks')) {          \n              matchingFallbacks = ['debug', 'release']        \n          }                                                   \n      }                                                       \n      dynamicRelease {                                        \n          initWith debug                                      \n          if (it.hasProperty('matchingFallbacks')) {          \n              matchingFallbacks = ['debug', 'release']        \n          }                                                   \n      }                                                       \n  }                                                           \n  ```\n\n* 动态添加 flutter.jar 依赖：\n\n  ``` groovy\n  private void addFlutterJarApiDependency(Project project, buildType, Task flutterX86JarTask) {   \n      project.dependencies {                                                                      \n          String configuration;                                                                   \n          if (project.getConfigurations().findByName(\"api\")) {                                    \n              configuration = buildType.name + \"Api\";                                             \n          } else {                                                                                \n              configuration = buildType.name + \"Compile\";                                         \n          }                                                                                       \n          add(configuration, project.files {                                                      \n              String buildMode = buildModeFor(buildType)                                          \n              if (buildMode == \"debug\") {                                                         \n                  [flutterX86JarTask, debugFlutterJar]                                            \n              } else if (buildMode == \"profile\") {                                                \n                  profileFlutterJar                                                               \n              } else if (buildMode == \"dynamicProfile\") {                                         \n                  dynamicProfileFlutterJar                                                        \n              } else if (buildMode == \"dynamicRelease\") {                                         \n                  dynamicReleaseFlutterJar                                                        \n              } else {                                                                            \n                  releaseFlutterJar                                                               \n              }                                                                                   \n          })                                                                                      \n      }                                                                                           \n  }                                                                                               \n  ```\n\n* 动态添加第三方插件依赖：\n\n  ``` groovy\n  project.dependencies {                                             \n      if (project.getConfigurations().findByName(\"implementation\")) {\n          implementation pluginProject                               \n      } else {                                                       \n          compile pluginProject                                      \n      }                                                              \n  ```\n\n* 在 assemble task 中添加一个 FlutterTask，这个 task 非常重要，这里会去生成 Flutter 所需要的产物：\n\n  首先，当 buildType 是 profile 或 release 时，会执行 `flutter build aot`：\n\n  ``` groovy\n  if (buildMode == \"profile\" || buildMode == \"release\") {                               \n      project.exec {                                                                    \n          executable flutterExecutable.absolutePath                                     \n          workingDir sourceDir                                                          \n          if (localEngine != null) {                                                    \n              args \"--local-engine\", localEngine                                        \n              args \"--local-engine-src-path\", localEngineSrcPath                        \n          }                                                                             \n          args \"build\", \"aot\"                                                           \n          args \"--suppress-analytics\"                                                   \n          args \"--quiet\"                                                                \n          args \"--target\", targetPath                                                   \n          args \"--target-platform\", \"android-arm\"                                       \n          args \"--output-dir\", \"${intermediateDir}\"                                     \n          if (trackWidgetCreation) {                                                    \n              args \"--track-widget-creation\"                                            \n          }                                                                             \n          if (extraFrontEndOptions != null) {                                           \n              args \"--extra-front-end-options\", \"${extraFrontEndOptions}\"               \n          }                                                                             \n          if (extraGenSnapshotOptions != null) {                                        \n              args \"--extra-gen-snapshot-options\", \"${extraGenSnapshotOptions}\"         \n          }                                                                             \n          if (buildSharedLibrary) {                                                     \n              args \"--build-shared-library\"                                             \n          }                                                                             \n          if (targetPlatform != null) {                                                 \n              args \"--target-platform\", \"${targetPlatform}\"                             \n          }                                                                             \n          args \"--${buildMode}\"                                                         \n      }                                                                                 \n  }                                                                                     \n  ```\n\n  其次，执行 `flutter build bundle` 命令，当 buildType 为 profile 或 release 时，添加额外的 --precompiled 选项。\n\n  ``` groovy\n  project.exec {                                                                    \n      executable flutterExecutable.absolutePath                                     \n      workingDir sourceDir                                                          \n      if (localEngine != null) {                                                    \n          args \"--local-engine\", localEngine                                        \n          args \"--local-engine-src-path\", localEngineSrcPath                        \n      }                                                                             \n      args \"build\", \"bundle\"                                                        \n      args \"--suppress-analytics\"                                                   \n      args \"--target\", targetPath                                                   \n      if (verbose) {                                                                \n          args \"--verbose\"                                                          \n      }                                                                             \n      if (fileSystemRoots != null) {                                                \n          for (root in fileSystemRoots) {                                           \n              args \"--filesystem-root\", root                                        \n          }                                                                         \n      }                                                                             \n      if (fileSystemScheme != null) {                                               \n          args \"--filesystem-scheme\", fileSystemScheme                              \n      }                                                                             \n      if (trackWidgetCreation) {                                                    \n          args \"--track-widget-creation\"                                            \n      }                                                                             \n      if (compilationTraceFilePath != null) {                                       \n          args \"--compilation-trace-file\", compilationTraceFilePath                 \n      }                                                                             \n      if (createPatch) {                                                            \n          args \"--patch\"                                                            \n          args \"--build-number\", project.android.defaultConfig.versionCode          \n          if (buildNumber != null) {                                                \n              assert buildNumber == project.android.defaultConfig.versionCode       \n          }                                                                         \n      }                                                                             \n      if (baselineDir != null) {                                                    \n          args \"--baseline-dir\", baselineDir                                        \n      }                                                                             \n      if (extraFrontEndOptions != null) {                                           \n          args \"--extra-front-end-options\", \"${extraFrontEndOptions}\"               \n      }                                                                             \n      if (extraGenSnapshotOptions != null) {                                        \n          args \"--extra-gen-snapshot-options\", \"${extraGenSnapshotOptions}\"         \n      }                                                                             \n      if (targetPlatform != null) {                                                 \n          args \"--target-platform\", \"${targetPlatform}\"                             \n      }                                                                             \n      if (buildMode == \"release\" || buildMode == \"profile\") {                       \n          args \"--precompiled\"                                                      \n      } else {                                                                      \n          args \"--depfile\", \"${intermediateDir}/snapshot_blob.bin.d\"                \n      }                                                                             \n      args \"--asset-dir\", \"${intermediateDir}/flutter_assets\"                       \n      if (buildMode == \"debug\") {                                                   \n          args \"--debug\"                                                            \n      }                                                                             \n      if (buildMode == \"profile\" || buildMode == \"dynamicProfile\") {                \n          args \"--profile\"                                                          \n      }                                                                             \n      if (buildMode == \"release\" || buildMode == \"dynamicRelease\") {                \n          args \"--release\"                                                          \n      }                                                                             \n      if (buildMode == \"dynamicProfile\" || buildMode == \"dynamicRelease\") {         \n          args \"--dynamic\"                                                          \n      }                                                                             \n  }                                                                                 \n  ```\n\n稍微总结下，当 buildType 为 debug 时，只需要执行：\n\n``` shell\nflutter build bundle\n```\n\n而当 buildType 为 release 时，需要执行两个命令：\n\n``` shell\nflutter build aot\nflutter build bundle --precompiled\n```\n\n#### Build AOT\n\n当执行 `flutter build aot` 时，相关的逻辑在 BuildAotCommand 中，它主要分成两个步骤：\n\n1. 编译 kernel。kernel 指 Dart 的一种中间语言，更多资料可以阅读 [Kernel-Documentation](https://github.com/dart-lang/sdk/wiki/Kernel-Documentation)。最终会调用到 compile.dart 中的 `KernelCompiler.compile()` 方法：\n\n   ``` dart\n   final List<String> command = <String>[                                                                  \n     engineDartPath,                                                                                       \n     frontendServer,                                                                                       \n     '--sdk-root',                                                                                         \n     sdkRoot,                                                                                              \n     '--strong',                                                                                           \n     '--target=$targetModel',                                                                              \n   ];                                                                                                      \n   if (trackWidgetCreation)                                                                                \n     command.add('--track-widget-creation');                                                               \n   if (!linkPlatformKernelIn)                                                                              \n     command.add('--no-link-platform');                                                                    \n   if (aot) {                                                                                              \n     command.add('--aot');                                                                                 \n     command.add('--tfa');                                                                                 \n   }                                                                                                       \n   if (targetProductVm) {                                                                                  \n     command.add('-Ddart.vm.product=true');                                                                \n   }                                                                                                       \n   if (incrementalCompilerByteStorePath != null) {                                                         \n     command.add('--incremental');                                                                         \n   }                                                                                                       \n   Uri mainUri;                                                                                            \n   if (packagesPath != null) {                                                                             \n     command.addAll(<String>['--packages', packagesPath]);                                                 \n     mainUri = PackageUriMapper.findUri(mainPath, packagesPath, fileSystemScheme, fileSystemRoots);        \n   }                                                                                                       \n   if (outputFilePath != null) {                                                                           \n     command.addAll(<String>['--output-dill', outputFilePath]);                                            \n   }                                                                                                       \n   if (depFilePath != null && (fileSystemRoots == null || fileSystemRoots.isEmpty)) {                      \n     command.addAll(<String>['--depfile', depFilePath]);                                                   \n   }                                                                                                       \n   if (fileSystemRoots != null) {                                                                          \n     for (String root in fileSystemRoots) {                                                                \n       command.addAll(<String>['--filesystem-root', root]);                                                \n     }                                                                                                     \n   }                                                                                                       \n   if (fileSystemScheme != null) {                                                                         \n     command.addAll(<String>['--filesystem-scheme', fileSystemScheme]);                                    \n   }                                                                                                       \n   if (initializeFromDill != null) {                                                                       \n     command.addAll(<String>['--initialize-from-dill', initializeFromDill]);                               \n   }                                                                                                       \n                                                                                                           \n   if (extraFrontEndOptions != null)                                                                       \n     command.addAll(extraFrontEndOptions);                                                                 \n                                                                                                           \n   command.add(mainUri?.toString() ?? mainPath);                                                           \n                                                                                                           \n   printTrace(command.join(' '));                                                                          \n   final Process server = await processManager                                                             \n     .start(command)                                                                                       \n     .catchError((dynamic error, StackTrace stack) {                                                       \n       printError('Failed to start frontend server $error, $stack');                                       \n     });                                                                                                   \n                                                                                                           \n   ```\n\n   engineDart 指向  Dart SDK 目录，上面代码执行的最终命令可以简化为：\n\n   ``` shell\n   dart frontend_server.dart.snapshot --output-dill app.dill packages:main.dart\n   ```\n\n   app.dill 这里面其实就包含了我们的业务代码了，可以使用 `strings app.dill` 查看：\n\n   ![app.dill](https://user-gold-cdn.xitu.io/2019/8/29/16cdcd6bb5bcfcfe?w=579&h=281&f=png&s=39501)\n\n2. 生成 snpshot。相关的代码位于 base/build.dart 中的 `AOTSnapshotter.build()` 函数中，有两种模式：app-aot-assemble 和 app-aot-blobs。\n\n   ###### app-aot-assemble\n\n   在执行 aot 命令时，增加 `--build-shared-library` 选项，完整命令如下：\n\n   `flutter build aot --build-shared-library`\n\n   > iOS 只能使用这种模式，在 Flutter SDK 1.7.x 之后，这个也是 Android 的默认选项。\n\n   ``` dart\n   // buildSharedLibrary is ignored for iOS builds.                                        \n   if (platform == TargetPlatform.ios)                                                     \n     buildSharedLibrary = false;                                                           \n                                                                                           \n   if (buildSharedLibrary && androidSdk.ndk == null) {\n     // 需要有 NDK 环境\n     final String explanation = AndroidNdk.explainMissingNdk(androidSdk.directory);        \n     printError(                                                                           \n       'Could not find NDK in Android SDK at ${androidSdk.directory}:\\n'                   \n       '\\n'                                                                                \n       '  $explanation\\n'                                                                  \n       '\\n'                                                                                \n       'Unable to build with --build-shared-library\\n'                                     \n       'To install the NDK, see instructions at https://developer.android.com/ndk/guides/' \n     );                                                                                    \n     return 1;                                                                             \n   }                                                                                       \n   ```\n\n   这种模式下，会将产物编译为二进制文件，在 iOS 上为 App.framework，Android 上则为 app.so。\n\n   ``` dart\n   // Assembly AOT snapshot.                                \n   outputPaths.add(assembly);                               \n   genSnapshotArgs.add('--snapshot_kind=app-aot-assembly'); \n   genSnapshotArgs.add('--assembly=$assembly');             \n   ```\n\n   ##### app-aot-blobs\n\n   当使用这种模式时，会生成四个产物，分别是：\n\n   > instr 全称是 Instructions\n   >\n   > 了解更多：[Flutter-engine-operation-in-AOT-Mode](https://github.com/flutter/flutter/wiki/Flutter-engine-operation-in-AOT-Mode)\n\n   * isolate_snapshot_data：\n\n     表示 isolate 堆存储区的初始状态和特定的信息。和 vm_snapshot_data 配合，更快的启动 Dart VM。\n\n   * isolate_snapshot_instr:\n\n     包含由 Dart isolate 执行的 AOT 代码。\n\n   * vm_snapshot_data:\n\n     表示 isolates 之间的共享的 Dart 堆存储区的初始状态，用于更快的启动 Dart VM。\n\n   * vm_snapshot_instr:\n\n     包含 VM 中所有的 isolates 之间共享的常见例程的指令\n\n   isolate_snapshot_data 和 isolate_snapshot_instr 跟业务相关，而 vm_snapshot_data 和 vm_snapshot_instr 则是跟 VM 相关，无关业务。\n\n   我们可以使用 `strings` 查看下 isolate_snapshot_data  中内容：\n\n   ![isolate_snapshot_data](https://user-gold-cdn.xitu.io/2019/8/30/16ce1f8f15b2cf3b?w=683&h=263&f=png&s=42699)\n\n   \n   \n   #### 小结\n   \n   上面两种模式相关的代码如下：\n   \n   ``` dart\n   final String assembly = fs.path.join(outputDir.path, 'snapshot_assembly.S');                                              \n   if (buildSharedLibrary || platform == TargetPlatform.ios) {                                                               \n     // Assembly AOT snapshot.                                                                                               \n     outputPaths.add(assembly);                                                                                              \n     genSnapshotArgs.add('--snapshot_kind=app-aot-assembly');                                                                \n     genSnapshotArgs.add('--assembly=$assembly');                                                                            \n   } else {                                                                                                                  \n     // Blob AOT snapshot.                                                                                                   \n     final String vmSnapshotData = fs.path.join(outputDir.path, 'vm_snapshot_data');                                         \n     final String isolateSnapshotData = fs.path.join(outputDir.path, 'isolate_snapshot_data');                               \n     final String vmSnapshotInstructions = fs.path.join(outputDir.path, 'vm_snapshot_instr');                                \n     final String isolateSnapshotInstructions = fs.path.join(outputDir.path, 'isolate_snapshot_instr');                      \n     outputPaths.addAll(<String>[vmSnapshotData, isolateSnapshotData, vmSnapshotInstructions, isolateSnapshotInstructions]); \n     genSnapshotArgs.addAll(<String>[                                                                                        \n       '--snapshot_kind=app-aot-blobs',                                                                                      \n       '--vm_snapshot_data=$vmSnapshotData',                                                                                 \n       '--isolate_snapshot_data=$isolateSnapshotData',                                                                       \n       '--vm_snapshot_instructions=$vmSnapshotInstructions',                                                                 \n '--isolate_snapshot_instructions=$isolateSnapshotInstructions',                                                       \n     ]);                                                                                                                     \n}                                                                                                                         \n   ```\n   \n   从执行速度来看，app-aot-assemble 是要快于 app-aot-blobs 的，因为它不需要 Dart VM 环境，只需要 Dart Runtime 即可，而 snapshots 文件是需要 Dart VM 去加载执行的。但使用 snapshots 使得动态执行代码变成可能。\n\n   iOS 默认使用 app-aot-assemble 模式，更多是 App Store 本身的限制：\n   \n   > 引用于[flutters-compilation-patterns](https://proandroiddev.com/flutters-compilation-patterns-24e139d14177)\n   >\n   > App Store does not allow dispatch binary executable code. \n   \n   而 Android 默认使用 app-aot-blobs 模式，可能更多是从性能方面考虑，必须调用从 so 文件中调用 native 函数，需要用 JNI，有性能损耗，而且调用也比较麻烦，不过在 Flutter SDK 1.7.x 已经改成 app-aot-assemble 模式。\n#### Build Bundle\n\n当执行 `flutter build bundle` 时，相关的代码逻辑在 BuildBundleCommand 中，build bundle 主要做两件事：第一，如果没有添加 `--precompiled` 选项时，会先编译 kernel；第二，生成 assets(图片、字体等)。\n\n   1. 编译 kernel。这个步骤和 build aot 的第一个步骤是一样的，最终会生成 app.dill，这是业务代码编译后的产物。同时，这个会创建一个 kernelContent，这个在第二个步骤会讲到：\n   \n      ``` dart\n      kernelContent = DevFSFileContent(fs.file(compilerOutput.outputFilename));\n      ```\n   \n   2. 生成 assets。首先，会收集图片资源、字体等：\n   \n      ``` dart\n      final AssetBundle assets = await buildAssets(           \n        manifestPath: manifestPath,                           \n        assetDirPath: assetDirPath,                           \n        packagesPath: packagesPath,                           \n        reportLicensedPackages: reportLicensedPackages,       \n      );                                                      \n      ```\n   \n      其中包含有以下内容：\n   \n      ![assets](https://user-gold-cdn.xitu.io/2019/8/30/16ce1dca5d92427d?w=745&h=265&f=png&s=49891)\n   \n      接着，会将这些，包含上面生成 kernelContent，一起收集到指定目录，kernelContent 就是编译生成的 app.dill，但这里会拷贝并重命名为 kernel_blob.bin：\n   \n      ``` dart\n      const String _kKernelKey = 'kernel_blob.bin';                   \n      const String _kVMSnapshotData = 'vm_snapshot_data';             \n      const String _kIsolateSnapshotData = 'isolate_snapshot_data';   \n      \n      final String vmSnapshotData = artifacts.getArtifactPath(Artifact.vmSnapshotData, mode: buildMode);            \n      final String isolateSnapshotData = artifacts.getArtifactPath(Artifact.isolateSnapshotData, mode: buildMode); \n      assetEntries[_kKernelKey] = kernelContent;                                                                    \n      assetEntries[_kVMSnapshotData] = DevFSFileContent(fs.file(vmSnapshotData));                                   \n      assetEntries[_kIsolateSnapshotData] = DevFSFileContent(fs.file(isolateSnapshotData));                         \n      ```\n   \n      我们注意到，这里同样会生成 vm_snapshot_data 和 isolate_snapshot_data，但并没有生成相应的指令集。在这里的 isolate_snapshot_data 中并不会包含我们的业务代码，业务代码会存放在 kernel_blob.bin 文件中。可以使用 `strings` 命令查看，而且这两个文件的 MD5 值是一致的。\n   \n      ```\n      MD5 (app.dill) = 3876e8c6f4b13a88cc3cfc3b9fd108c4\n      MD5 (flutter_assets/kernel_blob.bin) = 3876e8c6f4b13a88cc3cfc3b9fd108c4\n      ```\n      \n      关于 snapshot 生成相关可以去看 **gen_snapshot**。\n\n   #### 小结\n\n##### debug\n\ndebug 模式下，会执行一个命令：\n\n   ``` shell\n   flutter build bundle\n   ```\n\n它会生成 assets、vm_snapshot_data、isolate_snapshot_data 和 kernel_bloc.bin。其中我们的业务代码存放在 kernel_bloc.bin 中，它是 app.dill 的拷贝。\n\n##### release\n\nrelease 模式下，会执行两个命令：\n\n   ``` shell\n   flutter build aot\n   ```\n\n它会先生成 app.dill，而且这里分为两种模式：app-aot-assemble 和 app-aot-blobs。iOS 或者 添加了 `--build-shared-library` 会使用 app-aot-assemble，这种模式会生成 App.Framework 或 app.so。Android 默认使用 app-aot-blobs，这种模式会生成 isolate_snapshot_data、isolate_snapshot_instr、vm_snapshot_data 和 vm_snapshot_instr 四个文件。\n\n   ``` shell\n   flutter build bundle --precompiled\n   ```\n\n这里只会生成 assets。\n\n### 调试源码\n\n调试是阅读源码最好的帮手，调试 flutter_tools 的方式比较简单，我用的是 IntelliJ，Android Studio 应该也类似，先导入源码，源码位于 sdk/packages/flutter_tools；新建一个 Dart Command Line App，设置 Dart file 为 bin/flutter_tools.dart，Program arguments 设置你要调试的命令，比如 `build aot`，Working directory 则用 `flutter create` 创建个项目即可；最后打好断点，debug 运行。\n\n![debug_tools](https://user-gold-cdn.xitu.io/2019/8/30/16ce208c64320c8d?w=1071&h=673&f=png&s=60679)\n\n> 因为源码中有很多异步代码，用 await 修饰的，可以使用 **Force run to Cursor** 直接执行到下一行即可。\n\n### 结尾\n\n为了避免篇幅太长，文章尽量避免贴很多的代码，只是贴了关键函数，感兴趣的读者可以去阅读相关的源码。\n\nAndroid 在 release 模式下，使用 app-aot-blobs 模式，用的是 snapshot 文件，这里要实现动态下发代码，应该还是有可能的，需要进一步研究。下一步应该会研究下**热加载**的实现，这对于实现动态化应该很有帮助。\n\n最后，Flutter 是一个非常好玩的事物，Dart 也是一个非常优秀的语言，enjoy it。\n\n> 因为我用习惯了 Typora 写 Markdown 了，但又需要用到掘金的图床，所以写了个小脚本用来上传图片。\n>\n> ``` python\n> import requests\n> import sys\n> \n> if __name__ == \"__main__\":\n>  file_path = sys.argv[1]\n>  upload_file = open(file_path,mode='rb')\n>  data = requests.post('https://cdn-ms.juejin.im/v1/upload?bucket=gold-user-assets',files={'file': upload_file}).json()\n>  print('upload url: ' + data['d']['url']['https'])\n> ```","source":"_posts/浅谈Flutter构建.md","raw":"---\ntitle: 浅谈Flutter构建\ndate: 2019-08-30 19:50:56\ncategories: Flutter\ntags:\n---\n\n### 不同版本构建产物的差异\n\n写这篇文章的时间为：2019.08.25，当前 Flutter SDK 最新版本为 v1.9.5，其中 stable 最新版本为 v1.7.8+hotfix.4。\n\n随着版本的更新，Flutter 构建的产物也在调整，以 Android 为例，我们使用默认的 flutter_app 项目来测试，在不修改源码的情况下，使用不同的 SDK 版本来执行打包命令，每个版本都打两个包：debug 和 release。\n\n![APK](https://user-gold-cdn.xitu.io/2019/8/25/16cc779633694337?w=758&h=506&f=png&s=34431)\n\n每个版本生成的 Flutter 产物如下所示，这里不列出 fonts、LICENSE 这些文件：\n\n| 版本  | 类型    | 内容                                                         | 说明                                                         |\n| ----- | ------- | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| 1.5.4 | debug   | assets/flutter_assets/kernel_blob.bin<br />assets/flutter_assets/isolate_snapshot_data<br />assets/flutter_assets/vm_snapshot_data<br />lib/x86_64/libflutter.so<br />lib/x86/libflutter.so<br />lib/armeabi-v7a/libflutter.so |                                                              |\n| 1.5.4 | release | assets/isolate_snapshot_data<br />assets/isolate_snapshot_instr<br />assets/vm_snapshot_data<br />assets/vm_snapshot_instr<br />lib/armeabi-v7a/libflutter.so |                                                              |\n| 1.6.7 | debug   | 新增了<br />assets/snapshot_blob.bind.d.fingerprint<br />assets/snapshot_blob.bin.d<br /> |                                                              |\n| 1.6.7 | release | 无变化                                                       |                                                              |\n| 1.7.8 | debug   | 删除了<br />assets/snapshot_blob.bind.d.fingerprint<br />assets/snapshot_blob.bin.d<br />新增了<br />lib/arm64-v8a/libflutter.so |                                                              |\n| 1.7.8 | release | 删除了<br />assets/isolate_snapshot_data<br />assets/isolate_snapshot_instr<br />assets/vm_snapshot_data<br />assets/vm_snapshot_instr<br />新增了<br />lib/armeabi-v7a/libapp.so<br />lib/arm64-v8a/libflutter.so<br />lib/arm64-v8a/libapp.so | 从这个版本开始，release 下不使用 snapshot，同时增加了同时打包 64 位 so 文件 |\n| 1.8.4 | debug   | 无变化                                                       |                                                              |\n| 1.8.4 | release | 无变化                                                       |                                                              |\n| 1.9.5 | debug   | 无变化                                                       |                                                              |\n| 1.9.5 | release | 无变化                                                       |                                                              |\n\n从上面的表格来看，1.5.x 版本和 1.7.x 版本的变化是比较明显的，主要的变化有两点，第一，1.7.x 版本增加了支持同时编译 32 位和 64 位两种架构，这个在之前一直被诟病，现在官方支持了。第二，release 模式下，不使用 snapshot 文件，而使用 libapp.so。snapshot 是 Dart VM 所支持的一种文件格式，类似 JVM 的 jar 一样，可以运行在虚拟机环境的文件。\n\n除了变化以外，我们还注意到一些不变的文件，比如 debug 模式下，一直存在的 kernel_blob.bin 文件；lib 目录下 libflutter.so 文件；这些文件各自的作用又是什么呢。带着疑问，我们一起看看 Flutter 的构建过程。\n\n### Flutter 支持的编译模式\n\n> 关于编译模式这块主要参考的：\n>\n> * [Flutter’s Compilation Patterns](https://proandroiddev.com/flutters-compilation-patterns-24e139d14177)\n\nFlutter 是基于 Dart 开发的，所以 Flutter 的构建跟 Dart 是分不开的。所以，我们先讲 Dart。\n\n在将 Dart 之前，我们先了解两种编译模式，JIT 和 AOT：\n\n##### JIT\n\nJIT(Just In Time) 翻译为 **即时编译**，指的是在程序运行中，将热点代码编译成机器码，提高运行效率。常见例子有 V8 引擎和 JVM，JIT 可以充分利用解释型语言的优点，动态执行源码，而不用考虑平台差异性。这里需要注意的是，对于 JVM 来说，源码指字节码，而不是 Java 源码。\n\n> 这里需要区分，JIT 和解释型语言的区别，JIT 是一种编译模式，比如，Java 是编译型语言，但它也可以使用 JIT。\n\n##### AOT\n\nAOT(Ahead Of Time) 称为 **运行前编译**，指的是在程序运行之前，已经编译成对应平台的机器码，不需要在运行中解释编译，就可以直接运行。常见例子有 C 和 C++。\n\n虽然，我们会区别 JIT 和 AOT 两种编译模式，但实际上，有很多语言并不是完全使用 JIT 或者 AOT 的，通常它们会混用这两种模式，来达到最大的性能优化。\n\n#### Dart 支持的编译模式\n\nDart VM 支持四种编译模式：\n\n* **Script**：最常见的 JIT 模式，可以直接在虚拟机中执行 Dart 源码，像解释型语言一样使用。\n\n  通过执行 `dart xxx.dart` 就可以运行，写一些临时脚本，非常方便。\n\n* **Kernel Snapshots**：JIT 模式，和 **Script** 模式不同的是，这种模式执行的是 [Kernel AST](https://github.com/dart-lang/sdk/tree/master/pkg/kernel) 的二进制数据，这里不包含解析后的类和函数，编译后的代码，所以它们可以在不同的平台之间移植。\n\n  在 [Flutter’s Compilation Patterns](https://proandroiddev.com/flutters-compilation-patterns-24e139d14177) 这篇文章中，将 Kernel Snapshots 称为 Script Snapshots 也是对的，这应该是之前的叫法，从 [dart-lang](https://github.com/dart-lang) 的 [wiki](https://github.com/dart-lang/sdk/wiki/Snapshots/_compare/a3bb7a829f461bf4703533d23462f1ac3760a2d8) 中可以看出来：\n\n  ![Kernel Snapshots And Script Snapshots](https://user-gold-cdn.xitu.io/2019/8/27/16cd1d07e1258d95?w=986&h=299&f=png&s=62397)\n\n  \n\n  Dart Kernel 是 Dart 程序中的一种中间语言，更多的资料可阅读 [Kernel Documentation](https://github.com/dart-lang/sdk/wiki/Kernel-Documentation)。\n\n  通过执行 `dart --snapshot-kind=kernel --snapshot=xx.snapshot xx.dart` 生成。\n\n* **JIT Application Snapshots**：JIT 模式，这里执行的是已经解析过的类和函数，所以它会运行起来会更快。但是这不是平台无关，它只能针对 32位 或者 64位 架构运行。\n\n  通过执行 `dart --snapshot-kind=app-jit --snapshot=xx.snapshot xx.dart` 生成。\n\n* **AOT Application Snapshots**：AOT 模式，在这种模式下，Dart 源码会被提前编译成特定平台的二进制文件。\n\n  要使用 AOT 模式，需要使用 `dart2aot` 命令， 具体使用为：`dart2aot xx.dart xx.dart.aot`，然后使用 `dartaotruntime` 命令执行。\n\nDart JIT 模式需要配合 Dart VM(虚拟机) ，AOT 则会使用 runtime 来执行，引用官网中的图片来说明：\n\n![jit-and-aot](https://user-gold-cdn.xitu.io/2019/8/27/16cd13e09839fae9?w=795&h=252&f=png&s=18282)\n\n\n\n可以用下面这张图来总结上面的四种模式：\n\n> 图片来源于 [flutters-compilation-patterns](https://proandroiddev.com/flutters-compilation-patterns-24e139d14177)\n\n![Dart’s compilation patterns](https://user-gold-cdn.xitu.io/2019/8/25/16cc7eb579c05a1d?w=1344&h=386&f=png&s=54640)\n\n四种模式下的产物大小和启动速度比较：\n\n> 图片来源于 [exploring-flutter-in-android](https://medium.com/@takahirom/exploring-flutter-in-android-533598ba17d2)\n\n![whai is snapshot](https://user-gold-cdn.xitu.io/2019/8/28/16cd76297cd9f674?w=373&h=263&f=png&s=37448)\n\n### Flutter 构建过程\n\n> 下面的分析都是基于 **v1.5.4-hotfix.2**\n\n执行 `flutter build apk` 时，默认会生成 release APK，实际是执行的 sdk/bin/flutter 命令，参数为 build apk：\n\n``` shell\nDART_SDK_PATH=\"$FLUTTER_ROOT/bin/cache/dart-sdk\"\nDART=\"$DART_SDK_PATH/bin/dart\"\nSNAPSHOT_PATH=\"$FLUTTER_ROOT/bin/cache/flutter_tools.snapshot\"\n\"$DART\" $FLUTTER_TOOL_ARGS \"$SNAPSHOT_PATH\" \"$@\"\n```\n\n上面的命令完整应该为：`dart flutter_tools.snapshot args`，snapshot 文件我们上面提过，是 Dart 的一种代码集合，类似 Java 中 Jar 包。\n\nflutter_tools 的源码位于 sdk/packages/flutter_tools/bin 下的 flutter_tools.dart，跟 Java 一样，这里也有个 `main()` 函数，其中调用的是 `executable.main()` 函数。\n\n在 main 函数中，会注册多个命令处理器，比如：\n\n* DoctorCommand 对应 `flutter doctor` 命令\n* CleanCommand 对应 `flutter clean` 命令\n* 等等\n\n我们这次要研究的目标是 BuildCommand，它里面又包含了以下子命令处理器：\n\n* BuildApkCommand 对应 `flutter build apk` 命令\n* BuildAppBundleCommand 对应 `flutter build bundle` 命令\n* BuildAotCommand 对应 `flutter build aot` 命令\n* 等等\n\n#### Build APK\n\n首先我们要理清 build apk 或者 build ios，和 build bundle、build aot 之间的关系。这里我们以 build apk 为例：\n\n当执行 `flutter build apk` 时，最终会调用到 gradle.dart 中的 `_buildGradleProjectV2()` 方法，在这里最后也是调用 gradle 执行 assemble task。而在项目中的 android/app/build.gradle 中可以看到：\n\n``` groovy\napply from: \"$flutterRoot/packages/flutter_tools/gradle/flutter.gradle\"\n```\n\n也就是说，会在 flutter.gradle 这里去插入一些编译 Flutter 产物的脚本。\n\nflutter.gradle 是通过插件的形式去实现的，这个插件命名为 FlutterPlugin。这个插件的主要作用有一些几点：\n\n* 除了默认的 debug 和 release 之外，新增了 profile、dynamicProfile、dynamicRelease 这三种 buildTypes：\n\n  ``` groovy\n  project.android.buildTypes {                                \n      profile {                                               \n          initWith debug                                      \n          if (it.hasProperty('matchingFallbacks')) {          \n              matchingFallbacks = ['debug', 'release']        \n          }                                                   \n      }                                                       \n      dynamicProfile {                                        \n          initWith debug                                      \n          if (it.hasProperty('matchingFallbacks')) {          \n              matchingFallbacks = ['debug', 'release']        \n          }                                                   \n      }                                                       \n      dynamicRelease {                                        \n          initWith debug                                      \n          if (it.hasProperty('matchingFallbacks')) {          \n              matchingFallbacks = ['debug', 'release']        \n          }                                                   \n      }                                                       \n  }                                                           \n  ```\n\n* 动态添加 flutter.jar 依赖：\n\n  ``` groovy\n  private void addFlutterJarApiDependency(Project project, buildType, Task flutterX86JarTask) {   \n      project.dependencies {                                                                      \n          String configuration;                                                                   \n          if (project.getConfigurations().findByName(\"api\")) {                                    \n              configuration = buildType.name + \"Api\";                                             \n          } else {                                                                                \n              configuration = buildType.name + \"Compile\";                                         \n          }                                                                                       \n          add(configuration, project.files {                                                      \n              String buildMode = buildModeFor(buildType)                                          \n              if (buildMode == \"debug\") {                                                         \n                  [flutterX86JarTask, debugFlutterJar]                                            \n              } else if (buildMode == \"profile\") {                                                \n                  profileFlutterJar                                                               \n              } else if (buildMode == \"dynamicProfile\") {                                         \n                  dynamicProfileFlutterJar                                                        \n              } else if (buildMode == \"dynamicRelease\") {                                         \n                  dynamicReleaseFlutterJar                                                        \n              } else {                                                                            \n                  releaseFlutterJar                                                               \n              }                                                                                   \n          })                                                                                      \n      }                                                                                           \n  }                                                                                               \n  ```\n\n* 动态添加第三方插件依赖：\n\n  ``` groovy\n  project.dependencies {                                             \n      if (project.getConfigurations().findByName(\"implementation\")) {\n          implementation pluginProject                               \n      } else {                                                       \n          compile pluginProject                                      \n      }                                                              \n  ```\n\n* 在 assemble task 中添加一个 FlutterTask，这个 task 非常重要，这里会去生成 Flutter 所需要的产物：\n\n  首先，当 buildType 是 profile 或 release 时，会执行 `flutter build aot`：\n\n  ``` groovy\n  if (buildMode == \"profile\" || buildMode == \"release\") {                               \n      project.exec {                                                                    \n          executable flutterExecutable.absolutePath                                     \n          workingDir sourceDir                                                          \n          if (localEngine != null) {                                                    \n              args \"--local-engine\", localEngine                                        \n              args \"--local-engine-src-path\", localEngineSrcPath                        \n          }                                                                             \n          args \"build\", \"aot\"                                                           \n          args \"--suppress-analytics\"                                                   \n          args \"--quiet\"                                                                \n          args \"--target\", targetPath                                                   \n          args \"--target-platform\", \"android-arm\"                                       \n          args \"--output-dir\", \"${intermediateDir}\"                                     \n          if (trackWidgetCreation) {                                                    \n              args \"--track-widget-creation\"                                            \n          }                                                                             \n          if (extraFrontEndOptions != null) {                                           \n              args \"--extra-front-end-options\", \"${extraFrontEndOptions}\"               \n          }                                                                             \n          if (extraGenSnapshotOptions != null) {                                        \n              args \"--extra-gen-snapshot-options\", \"${extraGenSnapshotOptions}\"         \n          }                                                                             \n          if (buildSharedLibrary) {                                                     \n              args \"--build-shared-library\"                                             \n          }                                                                             \n          if (targetPlatform != null) {                                                 \n              args \"--target-platform\", \"${targetPlatform}\"                             \n          }                                                                             \n          args \"--${buildMode}\"                                                         \n      }                                                                                 \n  }                                                                                     \n  ```\n\n  其次，执行 `flutter build bundle` 命令，当 buildType 为 profile 或 release 时，添加额外的 --precompiled 选项。\n\n  ``` groovy\n  project.exec {                                                                    \n      executable flutterExecutable.absolutePath                                     \n      workingDir sourceDir                                                          \n      if (localEngine != null) {                                                    \n          args \"--local-engine\", localEngine                                        \n          args \"--local-engine-src-path\", localEngineSrcPath                        \n      }                                                                             \n      args \"build\", \"bundle\"                                                        \n      args \"--suppress-analytics\"                                                   \n      args \"--target\", targetPath                                                   \n      if (verbose) {                                                                \n          args \"--verbose\"                                                          \n      }                                                                             \n      if (fileSystemRoots != null) {                                                \n          for (root in fileSystemRoots) {                                           \n              args \"--filesystem-root\", root                                        \n          }                                                                         \n      }                                                                             \n      if (fileSystemScheme != null) {                                               \n          args \"--filesystem-scheme\", fileSystemScheme                              \n      }                                                                             \n      if (trackWidgetCreation) {                                                    \n          args \"--track-widget-creation\"                                            \n      }                                                                             \n      if (compilationTraceFilePath != null) {                                       \n          args \"--compilation-trace-file\", compilationTraceFilePath                 \n      }                                                                             \n      if (createPatch) {                                                            \n          args \"--patch\"                                                            \n          args \"--build-number\", project.android.defaultConfig.versionCode          \n          if (buildNumber != null) {                                                \n              assert buildNumber == project.android.defaultConfig.versionCode       \n          }                                                                         \n      }                                                                             \n      if (baselineDir != null) {                                                    \n          args \"--baseline-dir\", baselineDir                                        \n      }                                                                             \n      if (extraFrontEndOptions != null) {                                           \n          args \"--extra-front-end-options\", \"${extraFrontEndOptions}\"               \n      }                                                                             \n      if (extraGenSnapshotOptions != null) {                                        \n          args \"--extra-gen-snapshot-options\", \"${extraGenSnapshotOptions}\"         \n      }                                                                             \n      if (targetPlatform != null) {                                                 \n          args \"--target-platform\", \"${targetPlatform}\"                             \n      }                                                                             \n      if (buildMode == \"release\" || buildMode == \"profile\") {                       \n          args \"--precompiled\"                                                      \n      } else {                                                                      \n          args \"--depfile\", \"${intermediateDir}/snapshot_blob.bin.d\"                \n      }                                                                             \n      args \"--asset-dir\", \"${intermediateDir}/flutter_assets\"                       \n      if (buildMode == \"debug\") {                                                   \n          args \"--debug\"                                                            \n      }                                                                             \n      if (buildMode == \"profile\" || buildMode == \"dynamicProfile\") {                \n          args \"--profile\"                                                          \n      }                                                                             \n      if (buildMode == \"release\" || buildMode == \"dynamicRelease\") {                \n          args \"--release\"                                                          \n      }                                                                             \n      if (buildMode == \"dynamicProfile\" || buildMode == \"dynamicRelease\") {         \n          args \"--dynamic\"                                                          \n      }                                                                             \n  }                                                                                 \n  ```\n\n稍微总结下，当 buildType 为 debug 时，只需要执行：\n\n``` shell\nflutter build bundle\n```\n\n而当 buildType 为 release 时，需要执行两个命令：\n\n``` shell\nflutter build aot\nflutter build bundle --precompiled\n```\n\n#### Build AOT\n\n当执行 `flutter build aot` 时，相关的逻辑在 BuildAotCommand 中，它主要分成两个步骤：\n\n1. 编译 kernel。kernel 指 Dart 的一种中间语言，更多资料可以阅读 [Kernel-Documentation](https://github.com/dart-lang/sdk/wiki/Kernel-Documentation)。最终会调用到 compile.dart 中的 `KernelCompiler.compile()` 方法：\n\n   ``` dart\n   final List<String> command = <String>[                                                                  \n     engineDartPath,                                                                                       \n     frontendServer,                                                                                       \n     '--sdk-root',                                                                                         \n     sdkRoot,                                                                                              \n     '--strong',                                                                                           \n     '--target=$targetModel',                                                                              \n   ];                                                                                                      \n   if (trackWidgetCreation)                                                                                \n     command.add('--track-widget-creation');                                                               \n   if (!linkPlatformKernelIn)                                                                              \n     command.add('--no-link-platform');                                                                    \n   if (aot) {                                                                                              \n     command.add('--aot');                                                                                 \n     command.add('--tfa');                                                                                 \n   }                                                                                                       \n   if (targetProductVm) {                                                                                  \n     command.add('-Ddart.vm.product=true');                                                                \n   }                                                                                                       \n   if (incrementalCompilerByteStorePath != null) {                                                         \n     command.add('--incremental');                                                                         \n   }                                                                                                       \n   Uri mainUri;                                                                                            \n   if (packagesPath != null) {                                                                             \n     command.addAll(<String>['--packages', packagesPath]);                                                 \n     mainUri = PackageUriMapper.findUri(mainPath, packagesPath, fileSystemScheme, fileSystemRoots);        \n   }                                                                                                       \n   if (outputFilePath != null) {                                                                           \n     command.addAll(<String>['--output-dill', outputFilePath]);                                            \n   }                                                                                                       \n   if (depFilePath != null && (fileSystemRoots == null || fileSystemRoots.isEmpty)) {                      \n     command.addAll(<String>['--depfile', depFilePath]);                                                   \n   }                                                                                                       \n   if (fileSystemRoots != null) {                                                                          \n     for (String root in fileSystemRoots) {                                                                \n       command.addAll(<String>['--filesystem-root', root]);                                                \n     }                                                                                                     \n   }                                                                                                       \n   if (fileSystemScheme != null) {                                                                         \n     command.addAll(<String>['--filesystem-scheme', fileSystemScheme]);                                    \n   }                                                                                                       \n   if (initializeFromDill != null) {                                                                       \n     command.addAll(<String>['--initialize-from-dill', initializeFromDill]);                               \n   }                                                                                                       \n                                                                                                           \n   if (extraFrontEndOptions != null)                                                                       \n     command.addAll(extraFrontEndOptions);                                                                 \n                                                                                                           \n   command.add(mainUri?.toString() ?? mainPath);                                                           \n                                                                                                           \n   printTrace(command.join(' '));                                                                          \n   final Process server = await processManager                                                             \n     .start(command)                                                                                       \n     .catchError((dynamic error, StackTrace stack) {                                                       \n       printError('Failed to start frontend server $error, $stack');                                       \n     });                                                                                                   \n                                                                                                           \n   ```\n\n   engineDart 指向  Dart SDK 目录，上面代码执行的最终命令可以简化为：\n\n   ``` shell\n   dart frontend_server.dart.snapshot --output-dill app.dill packages:main.dart\n   ```\n\n   app.dill 这里面其实就包含了我们的业务代码了，可以使用 `strings app.dill` 查看：\n\n   ![app.dill](https://user-gold-cdn.xitu.io/2019/8/29/16cdcd6bb5bcfcfe?w=579&h=281&f=png&s=39501)\n\n2. 生成 snpshot。相关的代码位于 base/build.dart 中的 `AOTSnapshotter.build()` 函数中，有两种模式：app-aot-assemble 和 app-aot-blobs。\n\n   ###### app-aot-assemble\n\n   在执行 aot 命令时，增加 `--build-shared-library` 选项，完整命令如下：\n\n   `flutter build aot --build-shared-library`\n\n   > iOS 只能使用这种模式，在 Flutter SDK 1.7.x 之后，这个也是 Android 的默认选项。\n\n   ``` dart\n   // buildSharedLibrary is ignored for iOS builds.                                        \n   if (platform == TargetPlatform.ios)                                                     \n     buildSharedLibrary = false;                                                           \n                                                                                           \n   if (buildSharedLibrary && androidSdk.ndk == null) {\n     // 需要有 NDK 环境\n     final String explanation = AndroidNdk.explainMissingNdk(androidSdk.directory);        \n     printError(                                                                           \n       'Could not find NDK in Android SDK at ${androidSdk.directory}:\\n'                   \n       '\\n'                                                                                \n       '  $explanation\\n'                                                                  \n       '\\n'                                                                                \n       'Unable to build with --build-shared-library\\n'                                     \n       'To install the NDK, see instructions at https://developer.android.com/ndk/guides/' \n     );                                                                                    \n     return 1;                                                                             \n   }                                                                                       \n   ```\n\n   这种模式下，会将产物编译为二进制文件，在 iOS 上为 App.framework，Android 上则为 app.so。\n\n   ``` dart\n   // Assembly AOT snapshot.                                \n   outputPaths.add(assembly);                               \n   genSnapshotArgs.add('--snapshot_kind=app-aot-assembly'); \n   genSnapshotArgs.add('--assembly=$assembly');             \n   ```\n\n   ##### app-aot-blobs\n\n   当使用这种模式时，会生成四个产物，分别是：\n\n   > instr 全称是 Instructions\n   >\n   > 了解更多：[Flutter-engine-operation-in-AOT-Mode](https://github.com/flutter/flutter/wiki/Flutter-engine-operation-in-AOT-Mode)\n\n   * isolate_snapshot_data：\n\n     表示 isolate 堆存储区的初始状态和特定的信息。和 vm_snapshot_data 配合，更快的启动 Dart VM。\n\n   * isolate_snapshot_instr:\n\n     包含由 Dart isolate 执行的 AOT 代码。\n\n   * vm_snapshot_data:\n\n     表示 isolates 之间的共享的 Dart 堆存储区的初始状态，用于更快的启动 Dart VM。\n\n   * vm_snapshot_instr:\n\n     包含 VM 中所有的 isolates 之间共享的常见例程的指令\n\n   isolate_snapshot_data 和 isolate_snapshot_instr 跟业务相关，而 vm_snapshot_data 和 vm_snapshot_instr 则是跟 VM 相关，无关业务。\n\n   我们可以使用 `strings` 查看下 isolate_snapshot_data  中内容：\n\n   ![isolate_snapshot_data](https://user-gold-cdn.xitu.io/2019/8/30/16ce1f8f15b2cf3b?w=683&h=263&f=png&s=42699)\n\n   \n   \n   #### 小结\n   \n   上面两种模式相关的代码如下：\n   \n   ``` dart\n   final String assembly = fs.path.join(outputDir.path, 'snapshot_assembly.S');                                              \n   if (buildSharedLibrary || platform == TargetPlatform.ios) {                                                               \n     // Assembly AOT snapshot.                                                                                               \n     outputPaths.add(assembly);                                                                                              \n     genSnapshotArgs.add('--snapshot_kind=app-aot-assembly');                                                                \n     genSnapshotArgs.add('--assembly=$assembly');                                                                            \n   } else {                                                                                                                  \n     // Blob AOT snapshot.                                                                                                   \n     final String vmSnapshotData = fs.path.join(outputDir.path, 'vm_snapshot_data');                                         \n     final String isolateSnapshotData = fs.path.join(outputDir.path, 'isolate_snapshot_data');                               \n     final String vmSnapshotInstructions = fs.path.join(outputDir.path, 'vm_snapshot_instr');                                \n     final String isolateSnapshotInstructions = fs.path.join(outputDir.path, 'isolate_snapshot_instr');                      \n     outputPaths.addAll(<String>[vmSnapshotData, isolateSnapshotData, vmSnapshotInstructions, isolateSnapshotInstructions]); \n     genSnapshotArgs.addAll(<String>[                                                                                        \n       '--snapshot_kind=app-aot-blobs',                                                                                      \n       '--vm_snapshot_data=$vmSnapshotData',                                                                                 \n       '--isolate_snapshot_data=$isolateSnapshotData',                                                                       \n       '--vm_snapshot_instructions=$vmSnapshotInstructions',                                                                 \n '--isolate_snapshot_instructions=$isolateSnapshotInstructions',                                                       \n     ]);                                                                                                                     \n}                                                                                                                         \n   ```\n   \n   从执行速度来看，app-aot-assemble 是要快于 app-aot-blobs 的，因为它不需要 Dart VM 环境，只需要 Dart Runtime 即可，而 snapshots 文件是需要 Dart VM 去加载执行的。但使用 snapshots 使得动态执行代码变成可能。\n\n   iOS 默认使用 app-aot-assemble 模式，更多是 App Store 本身的限制：\n   \n   > 引用于[flutters-compilation-patterns](https://proandroiddev.com/flutters-compilation-patterns-24e139d14177)\n   >\n   > App Store does not allow dispatch binary executable code. \n   \n   而 Android 默认使用 app-aot-blobs 模式，可能更多是从性能方面考虑，必须调用从 so 文件中调用 native 函数，需要用 JNI，有性能损耗，而且调用也比较麻烦，不过在 Flutter SDK 1.7.x 已经改成 app-aot-assemble 模式。\n#### Build Bundle\n\n当执行 `flutter build bundle` 时，相关的代码逻辑在 BuildBundleCommand 中，build bundle 主要做两件事：第一，如果没有添加 `--precompiled` 选项时，会先编译 kernel；第二，生成 assets(图片、字体等)。\n\n   1. 编译 kernel。这个步骤和 build aot 的第一个步骤是一样的，最终会生成 app.dill，这是业务代码编译后的产物。同时，这个会创建一个 kernelContent，这个在第二个步骤会讲到：\n   \n      ``` dart\n      kernelContent = DevFSFileContent(fs.file(compilerOutput.outputFilename));\n      ```\n   \n   2. 生成 assets。首先，会收集图片资源、字体等：\n   \n      ``` dart\n      final AssetBundle assets = await buildAssets(           \n        manifestPath: manifestPath,                           \n        assetDirPath: assetDirPath,                           \n        packagesPath: packagesPath,                           \n        reportLicensedPackages: reportLicensedPackages,       \n      );                                                      \n      ```\n   \n      其中包含有以下内容：\n   \n      ![assets](https://user-gold-cdn.xitu.io/2019/8/30/16ce1dca5d92427d?w=745&h=265&f=png&s=49891)\n   \n      接着，会将这些，包含上面生成 kernelContent，一起收集到指定目录，kernelContent 就是编译生成的 app.dill，但这里会拷贝并重命名为 kernel_blob.bin：\n   \n      ``` dart\n      const String _kKernelKey = 'kernel_blob.bin';                   \n      const String _kVMSnapshotData = 'vm_snapshot_data';             \n      const String _kIsolateSnapshotData = 'isolate_snapshot_data';   \n      \n      final String vmSnapshotData = artifacts.getArtifactPath(Artifact.vmSnapshotData, mode: buildMode);            \n      final String isolateSnapshotData = artifacts.getArtifactPath(Artifact.isolateSnapshotData, mode: buildMode); \n      assetEntries[_kKernelKey] = kernelContent;                                                                    \n      assetEntries[_kVMSnapshotData] = DevFSFileContent(fs.file(vmSnapshotData));                                   \n      assetEntries[_kIsolateSnapshotData] = DevFSFileContent(fs.file(isolateSnapshotData));                         \n      ```\n   \n      我们注意到，这里同样会生成 vm_snapshot_data 和 isolate_snapshot_data，但并没有生成相应的指令集。在这里的 isolate_snapshot_data 中并不会包含我们的业务代码，业务代码会存放在 kernel_blob.bin 文件中。可以使用 `strings` 命令查看，而且这两个文件的 MD5 值是一致的。\n   \n      ```\n      MD5 (app.dill) = 3876e8c6f4b13a88cc3cfc3b9fd108c4\n      MD5 (flutter_assets/kernel_blob.bin) = 3876e8c6f4b13a88cc3cfc3b9fd108c4\n      ```\n      \n      关于 snapshot 生成相关可以去看 **gen_snapshot**。\n\n   #### 小结\n\n##### debug\n\ndebug 模式下，会执行一个命令：\n\n   ``` shell\n   flutter build bundle\n   ```\n\n它会生成 assets、vm_snapshot_data、isolate_snapshot_data 和 kernel_bloc.bin。其中我们的业务代码存放在 kernel_bloc.bin 中，它是 app.dill 的拷贝。\n\n##### release\n\nrelease 模式下，会执行两个命令：\n\n   ``` shell\n   flutter build aot\n   ```\n\n它会先生成 app.dill，而且这里分为两种模式：app-aot-assemble 和 app-aot-blobs。iOS 或者 添加了 `--build-shared-library` 会使用 app-aot-assemble，这种模式会生成 App.Framework 或 app.so。Android 默认使用 app-aot-blobs，这种模式会生成 isolate_snapshot_data、isolate_snapshot_instr、vm_snapshot_data 和 vm_snapshot_instr 四个文件。\n\n   ``` shell\n   flutter build bundle --precompiled\n   ```\n\n这里只会生成 assets。\n\n### 调试源码\n\n调试是阅读源码最好的帮手，调试 flutter_tools 的方式比较简单，我用的是 IntelliJ，Android Studio 应该也类似，先导入源码，源码位于 sdk/packages/flutter_tools；新建一个 Dart Command Line App，设置 Dart file 为 bin/flutter_tools.dart，Program arguments 设置你要调试的命令，比如 `build aot`，Working directory 则用 `flutter create` 创建个项目即可；最后打好断点，debug 运行。\n\n![debug_tools](https://user-gold-cdn.xitu.io/2019/8/30/16ce208c64320c8d?w=1071&h=673&f=png&s=60679)\n\n> 因为源码中有很多异步代码，用 await 修饰的，可以使用 **Force run to Cursor** 直接执行到下一行即可。\n\n### 结尾\n\n为了避免篇幅太长，文章尽量避免贴很多的代码，只是贴了关键函数，感兴趣的读者可以去阅读相关的源码。\n\nAndroid 在 release 模式下，使用 app-aot-blobs 模式，用的是 snapshot 文件，这里要实现动态下发代码，应该还是有可能的，需要进一步研究。下一步应该会研究下**热加载**的实现，这对于实现动态化应该很有帮助。\n\n最后，Flutter 是一个非常好玩的事物，Dart 也是一个非常优秀的语言，enjoy it。\n\n> 因为我用习惯了 Typora 写 Markdown 了，但又需要用到掘金的图床，所以写了个小脚本用来上传图片。\n>\n> ``` python\n> import requests\n> import sys\n> \n> if __name__ == \"__main__\":\n>  file_path = sys.argv[1]\n>  upload_file = open(file_path,mode='rb')\n>  data = requests.post('https://cdn-ms.juejin.im/v1/upload?bucket=gold-user-assets',files={'file': upload_file}).json()\n>  print('upload url: ' + data['d']['url']['https'])\n> ```","slug":"浅谈Flutter构建","published":1,"updated":"2022-06-15T11:19:32.326Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrm7001kfho6dyq66p0l","content":"<h3 id=\"不同版本构建产物的差异\"><a href=\"#不同版本构建产物的差异\" class=\"headerlink\" title=\"不同版本构建产物的差异\"></a>不同版本构建产物的差异</h3><p>写这篇文章的时间为：2019.08.25，当前 Flutter SDK 最新版本为 v1.9.5，其中 stable 最新版本为 v1.7.8+hotfix.4。</p>\n<p>随着版本的更新，Flutter 构建的产物也在调整，以 Android 为例，我们使用默认的 flutter_app 项目来测试，在不修改源码的情况下，使用不同的 SDK 版本来执行打包命令，每个版本都打两个包：debug 和 release。</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/25/16cc779633694337?w=758&h=506&f=png&s=34431\" alt=\"APK\"></p>\n<p>每个版本生成的 Flutter 产物如下所示，这里不列出 fonts、LICENSE 这些文件：</p>\n<table>\n<thead>\n<tr>\n<th>版本</th>\n<th>类型</th>\n<th>内容</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1.5.4</td>\n<td>debug</td>\n<td>assets&#x2F;flutter_assets&#x2F;kernel_blob.bin<br />assets&#x2F;flutter_assets&#x2F;isolate_snapshot_data<br />assets&#x2F;flutter_assets&#x2F;vm_snapshot_data<br />lib&#x2F;x86_64&#x2F;libflutter.so<br />lib&#x2F;x86&#x2F;libflutter.so<br />lib&#x2F;armeabi-v7a&#x2F;libflutter.so</td>\n<td></td>\n</tr>\n<tr>\n<td>1.5.4</td>\n<td>release</td>\n<td>assets&#x2F;isolate_snapshot_data<br />assets&#x2F;isolate_snapshot_instr<br />assets&#x2F;vm_snapshot_data<br />assets&#x2F;vm_snapshot_instr<br />lib&#x2F;armeabi-v7a&#x2F;libflutter.so</td>\n<td></td>\n</tr>\n<tr>\n<td>1.6.7</td>\n<td>debug</td>\n<td>新增了<br />assets&#x2F;snapshot_blob.bind.d.fingerprint<br />assets&#x2F;snapshot_blob.bin.d<br /></td>\n<td></td>\n</tr>\n<tr>\n<td>1.6.7</td>\n<td>release</td>\n<td>无变化</td>\n<td></td>\n</tr>\n<tr>\n<td>1.7.8</td>\n<td>debug</td>\n<td>删除了<br />assets&#x2F;snapshot_blob.bind.d.fingerprint<br />assets&#x2F;snapshot_blob.bin.d<br />新增了<br />lib&#x2F;arm64-v8a&#x2F;libflutter.so</td>\n<td></td>\n</tr>\n<tr>\n<td>1.7.8</td>\n<td>release</td>\n<td>删除了<br />assets&#x2F;isolate_snapshot_data<br />assets&#x2F;isolate_snapshot_instr<br />assets&#x2F;vm_snapshot_data<br />assets&#x2F;vm_snapshot_instr<br />新增了<br />lib&#x2F;armeabi-v7a&#x2F;libapp.so<br />lib&#x2F;arm64-v8a&#x2F;libflutter.so<br />lib&#x2F;arm64-v8a&#x2F;libapp.so</td>\n<td>从这个版本开始，release 下不使用 snapshot，同时增加了同时打包 64 位 so 文件</td>\n</tr>\n<tr>\n<td>1.8.4</td>\n<td>debug</td>\n<td>无变化</td>\n<td></td>\n</tr>\n<tr>\n<td>1.8.4</td>\n<td>release</td>\n<td>无变化</td>\n<td></td>\n</tr>\n<tr>\n<td>1.9.5</td>\n<td>debug</td>\n<td>无变化</td>\n<td></td>\n</tr>\n<tr>\n<td>1.9.5</td>\n<td>release</td>\n<td>无变化</td>\n<td></td>\n</tr>\n</tbody></table>\n<p>从上面的表格来看，1.5.x 版本和 1.7.x 版本的变化是比较明显的，主要的变化有两点，第一，1.7.x 版本增加了支持同时编译 32 位和 64 位两种架构，这个在之前一直被诟病，现在官方支持了。第二，release 模式下，不使用 snapshot 文件，而使用 libapp.so。snapshot 是 Dart VM 所支持的一种文件格式，类似 JVM 的 jar 一样，可以运行在虚拟机环境的文件。</p>\n<p>除了变化以外，我们还注意到一些不变的文件，比如 debug 模式下，一直存在的 kernel_blob.bin 文件；lib 目录下 libflutter.so 文件；这些文件各自的作用又是什么呢。带着疑问，我们一起看看 Flutter 的构建过程。</p>\n<h3 id=\"Flutter-支持的编译模式\"><a href=\"#Flutter-支持的编译模式\" class=\"headerlink\" title=\"Flutter 支持的编译模式\"></a>Flutter 支持的编译模式</h3><blockquote>\n<p>关于编译模式这块主要参考的：</p>\n<ul>\n<li><a href=\"https://proandroiddev.com/flutters-compilation-patterns-24e139d14177\">Flutter’s Compilation Patterns</a></li>\n</ul>\n</blockquote>\n<p>Flutter 是基于 Dart 开发的，所以 Flutter 的构建跟 Dart 是分不开的。所以，我们先讲 Dart。</p>\n<p>在将 Dart 之前，我们先了解两种编译模式，JIT 和 AOT：</p>\n<h5 id=\"JIT\"><a href=\"#JIT\" class=\"headerlink\" title=\"JIT\"></a>JIT</h5><p>JIT(Just In Time) 翻译为 <strong>即时编译</strong>，指的是在程序运行中，将热点代码编译成机器码，提高运行效率。常见例子有 V8 引擎和 JVM，JIT 可以充分利用解释型语言的优点，动态执行源码，而不用考虑平台差异性。这里需要注意的是，对于 JVM 来说，源码指字节码，而不是 Java 源码。</p>\n<blockquote>\n<p>这里需要区分，JIT 和解释型语言的区别，JIT 是一种编译模式，比如，Java 是编译型语言，但它也可以使用 JIT。</p>\n</blockquote>\n<h5 id=\"AOT\"><a href=\"#AOT\" class=\"headerlink\" title=\"AOT\"></a>AOT</h5><p>AOT(Ahead Of Time) 称为 <strong>运行前编译</strong>，指的是在程序运行之前，已经编译成对应平台的机器码，不需要在运行中解释编译，就可以直接运行。常见例子有 C 和 C++。</p>\n<p>虽然，我们会区别 JIT 和 AOT 两种编译模式，但实际上，有很多语言并不是完全使用 JIT 或者 AOT 的，通常它们会混用这两种模式，来达到最大的性能优化。</p>\n<h4 id=\"Dart-支持的编译模式\"><a href=\"#Dart-支持的编译模式\" class=\"headerlink\" title=\"Dart 支持的编译模式\"></a>Dart 支持的编译模式</h4><p>Dart VM 支持四种编译模式：</p>\n<ul>\n<li><p><strong>Script</strong>：最常见的 JIT 模式，可以直接在虚拟机中执行 Dart 源码，像解释型语言一样使用。</p>\n<p>通过执行 <code>dart xxx.dart</code> 就可以运行，写一些临时脚本，非常方便。</p>\n</li>\n<li><p><strong>Kernel Snapshots</strong>：JIT 模式，和 <strong>Script</strong> 模式不同的是，这种模式执行的是 <a href=\"https://github.com/dart-lang/sdk/tree/master/pkg/kernel\">Kernel AST</a> 的二进制数据，这里不包含解析后的类和函数，编译后的代码，所以它们可以在不同的平台之间移植。</p>\n<p>在 <a href=\"https://proandroiddev.com/flutters-compilation-patterns-24e139d14177\">Flutter’s Compilation Patterns</a> 这篇文章中，将 Kernel Snapshots 称为 Script Snapshots 也是对的，这应该是之前的叫法，从 <a href=\"https://github.com/dart-lang\">dart-lang</a> 的 <a href=\"https://github.com/dart-lang/sdk/wiki/Snapshots/_compare/a3bb7a829f461bf4703533d23462f1ac3760a2d8\">wiki</a> 中可以看出来：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/27/16cd1d07e1258d95?w=986&h=299&f=png&s=62397\" alt=\"Kernel Snapshots And Script Snapshots\"></p>\n<p>Dart Kernel 是 Dart 程序中的一种中间语言，更多的资料可阅读 <a href=\"https://github.com/dart-lang/sdk/wiki/Kernel-Documentation\">Kernel Documentation</a>。</p>\n<p>通过执行 <code>dart --snapshot-kind=kernel --snapshot=xx.snapshot xx.dart</code> 生成。</p>\n</li>\n<li><p><strong>JIT Application Snapshots</strong>：JIT 模式，这里执行的是已经解析过的类和函数，所以它会运行起来会更快。但是这不是平台无关，它只能针对 32位 或者 64位 架构运行。</p>\n<p>通过执行 <code>dart --snapshot-kind=app-jit --snapshot=xx.snapshot xx.dart</code> 生成。</p>\n</li>\n<li><p><strong>AOT Application Snapshots</strong>：AOT 模式，在这种模式下，Dart 源码会被提前编译成特定平台的二进制文件。</p>\n<p>要使用 AOT 模式，需要使用 <code>dart2aot</code> 命令， 具体使用为：<code>dart2aot xx.dart xx.dart.aot</code>，然后使用 <code>dartaotruntime</code> 命令执行。</p>\n</li>\n</ul>\n<p>Dart JIT 模式需要配合 Dart VM(虚拟机) ，AOT 则会使用 runtime 来执行，引用官网中的图片来说明：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/27/16cd13e09839fae9?w=795&h=252&f=png&s=18282\" alt=\"jit-and-aot\"></p>\n<p>可以用下面这张图来总结上面的四种模式：</p>\n<blockquote>\n<p>图片来源于 <a href=\"https://proandroiddev.com/flutters-compilation-patterns-24e139d14177\">flutters-compilation-patterns</a></p>\n</blockquote>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/25/16cc7eb579c05a1d?w=1344&h=386&f=png&s=54640\" alt=\"Dart’s compilation patterns\"></p>\n<p>四种模式下的产物大小和启动速度比较：</p>\n<blockquote>\n<p>图片来源于 <a href=\"https://medium.com/@takahirom/exploring-flutter-in-android-533598ba17d2\">exploring-flutter-in-android</a></p>\n</blockquote>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/28/16cd76297cd9f674?w=373&h=263&f=png&s=37448\" alt=\"whai is snapshot\"></p>\n<h3 id=\"Flutter-构建过程\"><a href=\"#Flutter-构建过程\" class=\"headerlink\" title=\"Flutter 构建过程\"></a>Flutter 构建过程</h3><blockquote>\n<p>下面的分析都是基于 <strong>v1.5.4-hotfix.2</strong></p>\n</blockquote>\n<p>执行 <code>flutter build apk</code> 时，默认会生成 release APK，实际是执行的 sdk&#x2F;bin&#x2F;flutter 命令，参数为 build apk：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DART_SDK_PATH=&quot;$FLUTTER_ROOT/bin/cache/dart-sdk&quot;</span><br><span class=\"line\">DART=&quot;$DART_SDK_PATH/bin/dart&quot;</span><br><span class=\"line\">SNAPSHOT_PATH=&quot;$FLUTTER_ROOT/bin/cache/flutter_tools.snapshot&quot;</span><br><span class=\"line\">&quot;$DART&quot; $FLUTTER_TOOL_ARGS &quot;$SNAPSHOT_PATH&quot; &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<p>上面的命令完整应该为：<code>dart flutter_tools.snapshot args</code>，snapshot 文件我们上面提过，是 Dart 的一种代码集合，类似 Java 中 Jar 包。</p>\n<p>flutter_tools 的源码位于 sdk&#x2F;packages&#x2F;flutter_tools&#x2F;bin 下的 flutter_tools.dart，跟 Java 一样，这里也有个 <code>main()</code> 函数，其中调用的是 <code>executable.main()</code> 函数。</p>\n<p>在 main 函数中，会注册多个命令处理器，比如：</p>\n<ul>\n<li>DoctorCommand 对应 <code>flutter doctor</code> 命令</li>\n<li>CleanCommand 对应 <code>flutter clean</code> 命令</li>\n<li>等等</li>\n</ul>\n<p>我们这次要研究的目标是 BuildCommand，它里面又包含了以下子命令处理器：</p>\n<ul>\n<li>BuildApkCommand 对应 <code>flutter build apk</code> 命令</li>\n<li>BuildAppBundleCommand 对应 <code>flutter build bundle</code> 命令</li>\n<li>BuildAotCommand 对应 <code>flutter build aot</code> 命令</li>\n<li>等等</li>\n</ul>\n<h4 id=\"Build-APK\"><a href=\"#Build-APK\" class=\"headerlink\" title=\"Build APK\"></a>Build APK</h4><p>首先我们要理清 build apk 或者 build ios，和 build bundle、build aot 之间的关系。这里我们以 build apk 为例：</p>\n<p>当执行 <code>flutter build apk</code> 时，最终会调用到 gradle.dart 中的 <code>_buildGradleProjectV2()</code> 方法，在这里最后也是调用 gradle 执行 assemble task。而在项目中的 android&#x2F;app&#x2F;build.gradle 中可以看到：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">from:</span> <span class=\"string\">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>也就是说，会在 flutter.gradle 这里去插入一些编译 Flutter 产物的脚本。</p>\n<p>flutter.gradle 是通过插件的形式去实现的，这个插件命名为 FlutterPlugin。这个插件的主要作用有一些几点：</p>\n<ul>\n<li><p>除了默认的 debug 和 release 之外，新增了 profile、dynamicProfile、dynamicRelease 这三种 buildTypes：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.android.buildTypes &#123;                                </span><br><span class=\"line\">    profile &#123;                                               </span><br><span class=\"line\">        initWith debug                                      </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;          </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]        </span><br><span class=\"line\">        &#125;                                                   </span><br><span class=\"line\">    &#125;                                                       </span><br><span class=\"line\">    dynamicProfile &#123;                                        </span><br><span class=\"line\">        initWith debug                                      </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;          </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]        </span><br><span class=\"line\">        &#125;                                                   </span><br><span class=\"line\">    &#125;                                                       </span><br><span class=\"line\">    dynamicRelease &#123;                                        </span><br><span class=\"line\">        initWith debug                                      </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;          </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]        </span><br><span class=\"line\">        &#125;                                                   </span><br><span class=\"line\">    &#125;                                                       </span><br><span class=\"line\">&#125;                                                           </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>动态添加 flutter.jar 依赖：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">void</span> addFlutterJarApiDependency(Project project, buildType, Task flutterX86JarTask) &#123;   </span><br><span class=\"line\">    project.dependencies &#123;                                                                      </span><br><span class=\"line\">        String configuration;                                                                   </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (project.getConfigurations().findByName(<span class=\"string\">&quot;api&quot;</span>)) &#123;                                    </span><br><span class=\"line\">            configuration = buildType.name + <span class=\"string\">&quot;Api&quot;</span>;                                             </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;                                                                                </span><br><span class=\"line\">            configuration = buildType.name + <span class=\"string\">&quot;Compile&quot;</span>;                                         </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">        add(configuration, project.files &#123;                                                      </span><br><span class=\"line\">            String buildMode = buildModeFor(buildType)                                          </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;debug&quot;</span>) &#123;                                                         </span><br><span class=\"line\">                [flutterX86JarTask, debugFlutterJar]                                            </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;profile&quot;</span>) &#123;                                                </span><br><span class=\"line\">                profileFlutterJar                                                               </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;dynamicProfile&quot;</span>) &#123;                                         </span><br><span class=\"line\">                dynamicProfileFlutterJar                                                        </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;dynamicRelease&quot;</span>) &#123;                                         </span><br><span class=\"line\">                dynamicReleaseFlutterJar                                                        </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;                                                                            </span><br><span class=\"line\">                releaseFlutterJar                                                               </span><br><span class=\"line\">            &#125;                                                                                   </span><br><span class=\"line\">        &#125;)                                                                                      </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">&#125;                                                                                               </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>动态添加第三方插件依赖：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.dependencies &#123;                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (project.getConfigurations().findByName(<span class=\"string\">&quot;implementation&quot;</span>)) &#123;</span><br><span class=\"line\">        implementation pluginProject                               </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                       </span><br><span class=\"line\">        compile pluginProject                                      </span><br><span class=\"line\">    &#125;                                                              </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在 assemble task 中添加一个 FlutterTask，这个 task 非常重要，这里会去生成 Flutter 所需要的产物：</p>\n<p>首先，当 buildType 是 profile 或 release 时，会执行 <code>flutter build aot</code>：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;profile&quot;</span> || buildMode == <span class=\"string\">&quot;release&quot;</span>) &#123;                               </span><br><span class=\"line\">    project.exec &#123;                                                                    </span><br><span class=\"line\">        executable flutterExecutable.absolutePath                                     </span><br><span class=\"line\">        workingDir sourceDir                                                          </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (localEngine != <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">            args <span class=\"string\">&quot;--local-engine&quot;</span>, localEngine                                        </span><br><span class=\"line\">            args <span class=\"string\">&quot;--local-engine-src-path&quot;</span>, localEngineSrcPath                        </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        args <span class=\"string\">&quot;build&quot;</span>, <span class=\"string\">&quot;aot&quot;</span>                                                           </span><br><span class=\"line\">        args <span class=\"string\">&quot;--suppress-analytics&quot;</span>                                                   </span><br><span class=\"line\">        args <span class=\"string\">&quot;--quiet&quot;</span>                                                                </span><br><span class=\"line\">        args <span class=\"string\">&quot;--target&quot;</span>, targetPath                                                   </span><br><span class=\"line\">        args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;android-arm&quot;</span>                                       </span><br><span class=\"line\">        args <span class=\"string\">&quot;--output-dir&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;&quot;</span>                                     </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (trackWidgetCreation) &#123;                                                    </span><br><span class=\"line\">            args <span class=\"string\">&quot;--track-widget-creation&quot;</span>                                            </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (extraFrontEndOptions != <span class=\"literal\">null</span>) &#123;                                           </span><br><span class=\"line\">            args <span class=\"string\">&quot;--extra-front-end-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraFrontEndOptions&#125;&quot;</span>               </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (extraGenSnapshotOptions != <span class=\"literal\">null</span>) &#123;                                        </span><br><span class=\"line\">            args <span class=\"string\">&quot;--extra-gen-snapshot-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraGenSnapshotOptions&#125;&quot;</span>         </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildSharedLibrary) &#123;                                                     </span><br><span class=\"line\">            args <span class=\"string\">&quot;--build-shared-library&quot;</span>                                             </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (targetPlatform != <span class=\"literal\">null</span>) &#123;                                                 </span><br><span class=\"line\">            args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;$&#123;targetPlatform&#125;&quot;</span>                             </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        args <span class=\"string\">&quot;--$&#123;buildMode&#125;&quot;</span>                                                         </span><br><span class=\"line\">    &#125;                                                                                 </span><br><span class=\"line\">&#125;                                                                                     </span><br></pre></td></tr></table></figure>\n\n<p>其次，执行 <code>flutter build bundle</code> 命令，当 buildType 为 profile 或 release 时，添加额外的 –precompiled 选项。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.exec &#123;                                                                    </span><br><span class=\"line\">    executable flutterExecutable.absolutePath                                     </span><br><span class=\"line\">    workingDir sourceDir                                                          </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (localEngine != <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">        args <span class=\"string\">&quot;--local-engine&quot;</span>, localEngine                                        </span><br><span class=\"line\">        args <span class=\"string\">&quot;--local-engine-src-path&quot;</span>, localEngineSrcPath                        </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    args <span class=\"string\">&quot;build&quot;</span>, <span class=\"string\">&quot;bundle&quot;</span>                                                        </span><br><span class=\"line\">    args <span class=\"string\">&quot;--suppress-analytics&quot;</span>                                                   </span><br><span class=\"line\">    args <span class=\"string\">&quot;--target&quot;</span>, targetPath                                                   </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (verbose) &#123;                                                                </span><br><span class=\"line\">        args <span class=\"string\">&quot;--verbose&quot;</span>                                                          </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fileSystemRoots != <span class=\"literal\">null</span>) &#123;                                                </span><br><span class=\"line\">        <span class=\"keyword\">for</span> (root <span class=\"keyword\">in</span> fileSystemRoots) &#123;                                           </span><br><span class=\"line\">            args <span class=\"string\">&quot;--filesystem-root&quot;</span>, root                                        </span><br><span class=\"line\">        &#125;                                                                         </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fileSystemScheme != <span class=\"literal\">null</span>) &#123;                                               </span><br><span class=\"line\">        args <span class=\"string\">&quot;--filesystem-scheme&quot;</span>, fileSystemScheme                              </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (trackWidgetCreation) &#123;                                                    </span><br><span class=\"line\">        args <span class=\"string\">&quot;--track-widget-creation&quot;</span>                                            </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (compilationTraceFilePath != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">        args <span class=\"string\">&quot;--compilation-trace-file&quot;</span>, compilationTraceFilePath                 </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (createPatch) &#123;                                                            </span><br><span class=\"line\">        args <span class=\"string\">&quot;--patch&quot;</span>                                                            </span><br><span class=\"line\">        args <span class=\"string\">&quot;--build-number&quot;</span>, project.android.defaultConfig.versionCode          </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildNumber != <span class=\"literal\">null</span>) &#123;                                                </span><br><span class=\"line\">            <span class=\"keyword\">assert</span> buildNumber == project.android.defaultConfig.versionCode       </span><br><span class=\"line\">        &#125;                                                                         </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (baselineDir != <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">        args <span class=\"string\">&quot;--baseline-dir&quot;</span>, baselineDir                                        </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (extraFrontEndOptions != <span class=\"literal\">null</span>) &#123;                                           </span><br><span class=\"line\">        args <span class=\"string\">&quot;--extra-front-end-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraFrontEndOptions&#125;&quot;</span>               </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (extraGenSnapshotOptions != <span class=\"literal\">null</span>) &#123;                                        </span><br><span class=\"line\">        args <span class=\"string\">&quot;--extra-gen-snapshot-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraGenSnapshotOptions&#125;&quot;</span>         </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetPlatform != <span class=\"literal\">null</span>) &#123;                                                 </span><br><span class=\"line\">        args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;$&#123;targetPlatform&#125;&quot;</span>                             </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;release&quot;</span> || buildMode == <span class=\"string\">&quot;profile&quot;</span>) &#123;                       </span><br><span class=\"line\">        args <span class=\"string\">&quot;--precompiled&quot;</span>                                                      </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                      </span><br><span class=\"line\">        args <span class=\"string\">&quot;--depfile&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;/snapshot_blob.bin.d&quot;</span>                </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    args <span class=\"string\">&quot;--asset-dir&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;/flutter_assets&quot;</span>                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;debug&quot;</span>) &#123;                                                   </span><br><span class=\"line\">        args <span class=\"string\">&quot;--debug&quot;</span>                                                            </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;profile&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicProfile&quot;</span>) &#123;                </span><br><span class=\"line\">        args <span class=\"string\">&quot;--profile&quot;</span>                                                          </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;release&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicRelease&quot;</span>) &#123;                </span><br><span class=\"line\">        args <span class=\"string\">&quot;--release&quot;</span>                                                          </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;dynamicProfile&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicRelease&quot;</span>) &#123;         </span><br><span class=\"line\">        args <span class=\"string\">&quot;--dynamic&quot;</span>                                                          </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">&#125;                                                                                 </span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>稍微总结下，当 buildType 为 debug 时，只需要执行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flutter build bundle</span><br></pre></td></tr></table></figure>\n\n<p>而当 buildType 为 release 时，需要执行两个命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flutter build aot</span><br><span class=\"line\">flutter build bundle --precompiled</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Build-AOT\"><a href=\"#Build-AOT\" class=\"headerlink\" title=\"Build AOT\"></a>Build AOT</h4><p>当执行 <code>flutter build aot</code> 时，相关的逻辑在 BuildAotCommand 中，它主要分成两个步骤：</p>\n<ol>\n<li><p>编译 kernel。kernel 指 Dart 的一种中间语言，更多资料可以阅读 <a href=\"https://github.com/dart-lang/sdk/wiki/Kernel-Documentation\">Kernel-Documentation</a>。最终会调用到 compile.dart 中的 <code>KernelCompiler.compile()</code> 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">String</span>&gt; command = &lt;<span class=\"built_in\">String</span>&gt;[                                                                  </span><br><span class=\"line\">  engineDartPath,                                                                                       </span><br><span class=\"line\">  frontendServer,                                                                                       </span><br><span class=\"line\">  <span class=\"string\">&#x27;--sdk-root&#x27;</span>,                                                                                         </span><br><span class=\"line\">  sdkRoot,                                                                                              </span><br><span class=\"line\">  <span class=\"string\">&#x27;--strong&#x27;</span>,                                                                                           </span><br><span class=\"line\">  <span class=\"string\">&#x27;--target=<span class=\"subst\">$targetModel</span>&#x27;</span>,                                                                              </span><br><span class=\"line\">];                                                                                                      </span><br><span class=\"line\"><span class=\"keyword\">if</span> (trackWidgetCreation)                                                                                </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;--track-widget-creation&#x27;</span>);                                                               </span><br><span class=\"line\"><span class=\"keyword\">if</span> (!linkPlatformKernelIn)                                                                              </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;--no-link-platform&#x27;</span>);                                                                    </span><br><span class=\"line\"><span class=\"keyword\">if</span> (aot) &#123;                                                                                              </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;--aot&#x27;</span>);                                                                                 </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;--tfa&#x27;</span>);                                                                                 </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (targetProductVm) &#123;                                                                                  </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;-Ddart.vm.product=true&#x27;</span>);                                                                </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (incrementalCompilerByteStorePath != <span class=\"keyword\">null</span>) &#123;                                                         </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;--incremental&#x27;</span>);                                                                         </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"built_in\">Uri</span> mainUri;                                                                                            </span><br><span class=\"line\"><span class=\"keyword\">if</span> (packagesPath != <span class=\"keyword\">null</span>) &#123;                                                                             </span><br><span class=\"line\">  command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--packages&#x27;</span>, packagesPath]);                                                 </span><br><span class=\"line\">  mainUri = PackageUriMapper.findUri(mainPath, packagesPath, fileSystemScheme, fileSystemRoots);        </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (outputFilePath != <span class=\"keyword\">null</span>) &#123;                                                                           </span><br><span class=\"line\">  command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--output-dill&#x27;</span>, outputFilePath]);                                            </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (depFilePath != <span class=\"keyword\">null</span> &amp;&amp; (fileSystemRoots == <span class=\"keyword\">null</span> || fileSystemRoots.isEmpty)) &#123;                      </span><br><span class=\"line\">  command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--depfile&#x27;</span>, depFilePath]);                                                   </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (fileSystemRoots != <span class=\"keyword\">null</span>) &#123;                                                                          </span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"built_in\">String</span> root <span class=\"keyword\">in</span> fileSystemRoots) &#123;                                                                </span><br><span class=\"line\">    command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--filesystem-root&#x27;</span>, root]);                                                </span><br><span class=\"line\">  &#125;                                                                                                     </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (fileSystemScheme != <span class=\"keyword\">null</span>) &#123;                                                                         </span><br><span class=\"line\">  command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--filesystem-scheme&#x27;</span>, fileSystemScheme]);                                    </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (initializeFromDill != <span class=\"keyword\">null</span>) &#123;                                                                       </span><br><span class=\"line\">  command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--initialize-from-dill&#x27;</span>, initializeFromDill]);                               </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\"><span class=\"keyword\">if</span> (extraFrontEndOptions != <span class=\"keyword\">null</span>)                                                                       </span><br><span class=\"line\">  command.addAll(extraFrontEndOptions);                                                                 </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">command.add(mainUri?.toString() ?? mainPath);                                                           </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">printTrace(command.join(<span class=\"string\">&#x27; &#x27;</span>));                                                                          </span><br><span class=\"line\"><span class=\"keyword\">final</span> Process server = <span class=\"keyword\">await</span> processManager                                                             </span><br><span class=\"line\">  .start(command)                                                                                       </span><br><span class=\"line\">  .catchError((<span class=\"built_in\">dynamic</span> error, StackTrace stack) &#123;                                                       </span><br><span class=\"line\">    printError(<span class=\"string\">&#x27;Failed to start frontend server <span class=\"subst\">$error</span>, <span class=\"subst\">$stack</span>&#x27;</span>);                                       </span><br><span class=\"line\">  &#125;);                                                                                                   </span><br><span class=\"line\">                                                                                                        </span><br></pre></td></tr></table></figure>\n\n<p>engineDart 指向  Dart SDK 目录，上面代码执行的最终命令可以简化为：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dart frontend_server.dart.snapshot --output-dill app.dill packages:main.dart</span><br></pre></td></tr></table></figure>\n\n<p>app.dill 这里面其实就包含了我们的业务代码了，可以使用 <code>strings app.dill</code> 查看：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/29/16cdcd6bb5bcfcfe?w=579&h=281&f=png&s=39501\" alt=\"app.dill\"></p>\n</li>\n<li><p>生成 snpshot。相关的代码位于 base&#x2F;build.dart 中的 <code>AOTSnapshotter.build()</code> 函数中，有两种模式：app-aot-assemble 和 app-aot-blobs。</p>\n</li>\n</ol>\n<h6 id=\"app-aot-assemble\"><a href=\"#app-aot-assemble\" class=\"headerlink\" title=\"app-aot-assemble\"></a>app-aot-assemble</h6><p>   在执行 aot 命令时，增加 <code>--build-shared-library</code> 选项，完整命令如下：</p>\n<p>   <code>flutter build aot --build-shared-library</code></p>\n<blockquote>\n<p>iOS 只能使用这种模式，在 Flutter SDK 1.7.x 之后，这个也是 Android 的默认选项。</p>\n</blockquote>\n   <figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// buildSharedLibrary is ignored for iOS builds.                                        </span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (platform == TargetPlatform.ios)                                                     </span><br><span class=\"line\">  buildSharedLibrary = <span class=\"keyword\">false</span>;                                                           </span><br><span class=\"line\">                                                                                        </span><br><span class=\"line\"><span class=\"keyword\">if</span> (buildSharedLibrary &amp;&amp; androidSdk.ndk == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 需要有 NDK 环境</span></span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> explanation = AndroidNdk.explainMissingNdk(androidSdk.directory);        </span><br><span class=\"line\">  printError(                                                                           </span><br><span class=\"line\">    <span class=\"string\">&#x27;Could not find NDK in Android SDK at <span class=\"subst\">$&#123;androidSdk.directory&#125;</span>:\\n&#x27;</span>                   </span><br><span class=\"line\">    <span class=\"string\">&#x27;\\n&#x27;</span>                                                                                </span><br><span class=\"line\">    <span class=\"string\">&#x27;  <span class=\"subst\">$explanation</span>\\n&#x27;</span>                                                                  </span><br><span class=\"line\">    <span class=\"string\">&#x27;\\n&#x27;</span>                                                                                </span><br><span class=\"line\">    <span class=\"string\">&#x27;Unable to build with --build-shared-library\\n&#x27;</span>                                     </span><br><span class=\"line\">    <span class=\"string\">&#x27;To install the NDK, see instructions at https://developer.android.com/ndk/guides/&#x27;</span> </span><br><span class=\"line\">  );                                                                                    </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1</span>;                                                                             </span><br><span class=\"line\">&#125;                                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>   这种模式下，会将产物编译为二进制文件，在 iOS 上为 App.framework，Android 上则为 app.so。</p>\n   <figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Assembly AOT snapshot.                                </span></span><br><span class=\"line\">outputPaths.add(assembly);                               </span><br><span class=\"line\">genSnapshotArgs.add(<span class=\"string\">&#x27;--snapshot_kind=app-aot-assembly&#x27;</span>); </span><br><span class=\"line\">genSnapshotArgs.add(<span class=\"string\">&#x27;--assembly=<span class=\"subst\">$assembly</span>&#x27;</span>);             </span><br></pre></td></tr></table></figure>\n\n<h5 id=\"app-aot-blobs\"><a href=\"#app-aot-blobs\" class=\"headerlink\" title=\"app-aot-blobs\"></a>app-aot-blobs</h5><p>   当使用这种模式时，会生成四个产物，分别是：</p>\n<blockquote>\n<p>instr 全称是 Instructions</p>\n<p>了解更多：<a href=\"https://github.com/flutter/flutter/wiki/Flutter-engine-operation-in-AOT-Mode\">Flutter-engine-operation-in-AOT-Mode</a></p>\n</blockquote>\n<ul>\n<li><p>isolate_snapshot_data：</p>\n<p>表示 isolate 堆存储区的初始状态和特定的信息。和 vm_snapshot_data 配合，更快的启动 Dart VM。</p>\n</li>\n<li><p>isolate_snapshot_instr:</p>\n<p>包含由 Dart isolate 执行的 AOT 代码。</p>\n</li>\n<li><p>vm_snapshot_data:</p>\n<p>表示 isolates 之间的共享的 Dart 堆存储区的初始状态，用于更快的启动 Dart VM。</p>\n</li>\n<li><p>vm_snapshot_instr:</p>\n<p>包含 VM 中所有的 isolates 之间共享的常见例程的指令</p>\n</li>\n</ul>\n<p>   isolate_snapshot_data 和 isolate_snapshot_instr 跟业务相关，而 vm_snapshot_data 和 vm_snapshot_instr 则是跟 VM 相关，无关业务。</p>\n<p>   我们可以使用 <code>strings</code> 查看下 isolate_snapshot_data  中内容：</p>\n<p>   <img src=\"https://user-gold-cdn.xitu.io/2019/8/30/16ce1f8f15b2cf3b?w=683&h=263&f=png&s=42699\" alt=\"isolate_snapshot_data\"></p>\n<h4 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h4><p>   上面两种模式相关的代码如下：</p>\n   <figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> assembly = fs.path.join(outputDir.path, <span class=\"string\">&#x27;snapshot_assembly.S&#x27;</span>);                                              </span><br><span class=\"line\">   <span class=\"keyword\">if</span> (buildSharedLibrary || platform == TargetPlatform.ios) &#123;                                                               </span><br><span class=\"line\">     <span class=\"comment\">// Assembly AOT snapshot.                                                                                               </span></span><br><span class=\"line\">     outputPaths.add(assembly);                                                                                              </span><br><span class=\"line\">     genSnapshotArgs.add(<span class=\"string\">&#x27;--snapshot_kind=app-aot-assembly&#x27;</span>);                                                                </span><br><span class=\"line\">     genSnapshotArgs.add(<span class=\"string\">&#x27;--assembly=<span class=\"subst\">$assembly</span>&#x27;</span>);                                                                            </span><br><span class=\"line\">   &#125; <span class=\"keyword\">else</span> &#123;                                                                                                                  </span><br><span class=\"line\">     <span class=\"comment\">// Blob AOT snapshot.                                                                                                   </span></span><br><span class=\"line\">     <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> vmSnapshotData = fs.path.join(outputDir.path, <span class=\"string\">&#x27;vm_snapshot_data&#x27;</span>);                                         </span><br><span class=\"line\">     <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> isolateSnapshotData = fs.path.join(outputDir.path, <span class=\"string\">&#x27;isolate_snapshot_data&#x27;</span>);                               </span><br><span class=\"line\">     <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> vmSnapshotInstructions = fs.path.join(outputDir.path, <span class=\"string\">&#x27;vm_snapshot_instr&#x27;</span>);                                </span><br><span class=\"line\">     <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> isolateSnapshotInstructions = fs.path.join(outputDir.path, <span class=\"string\">&#x27;isolate_snapshot_instr&#x27;</span>);                      </span><br><span class=\"line\">     outputPaths.addAll(&lt;<span class=\"built_in\">String</span>&gt;[vmSnapshotData, isolateSnapshotData, vmSnapshotInstructions, isolateSnapshotInstructions]); </span><br><span class=\"line\">     genSnapshotArgs.addAll(&lt;<span class=\"built_in\">String</span>&gt;[                                                                                        </span><br><span class=\"line\">       <span class=\"string\">&#x27;--snapshot_kind=app-aot-blobs&#x27;</span>,                                                                                      </span><br><span class=\"line\">       <span class=\"string\">&#x27;--vm_snapshot_data=<span class=\"subst\">$vmSnapshotData</span>&#x27;</span>,                                                                                 </span><br><span class=\"line\">       <span class=\"string\">&#x27;--isolate_snapshot_data=<span class=\"subst\">$isolateSnapshotData</span>&#x27;</span>,                                                                       </span><br><span class=\"line\">       <span class=\"string\">&#x27;--vm_snapshot_instructions=<span class=\"subst\">$vmSnapshotInstructions</span>&#x27;</span>,                                                                 </span><br><span class=\"line\"> <span class=\"string\">&#x27;--isolate_snapshot_instructions=<span class=\"subst\">$isolateSnapshotInstructions</span>&#x27;</span>,                                                       </span><br><span class=\"line\">     ]);                                                                                                                     </span><br><span class=\"line\">&#125;                                                                                                                         </span><br></pre></td></tr></table></figure>\n<p>   从执行速度来看，app-aot-assemble 是要快于 app-aot-blobs 的，因为它不需要 Dart VM 环境，只需要 Dart Runtime 即可，而 snapshots 文件是需要 Dart VM 去加载执行的。但使用 snapshots 使得动态执行代码变成可能。</p>\n<p>   iOS 默认使用 app-aot-assemble 模式，更多是 App Store 本身的限制：</p>\n<blockquote>\n<p>引用于<a href=\"https://proandroiddev.com/flutters-compilation-patterns-24e139d14177\">flutters-compilation-patterns</a></p>\n<p>App Store does not allow dispatch binary executable code. </p>\n</blockquote>\n<p>   而 Android 默认使用 app-aot-blobs 模式，可能更多是从性能方面考虑，必须调用从 so 文件中调用 native 函数，需要用 JNI，有性能损耗，而且调用也比较麻烦，不过在 Flutter SDK 1.7.x 已经改成 app-aot-assemble 模式。</p>\n<h4 id=\"Build-Bundle\"><a href=\"#Build-Bundle\" class=\"headerlink\" title=\"Build Bundle\"></a>Build Bundle</h4><p>当执行 <code>flutter build bundle</code> 时，相关的代码逻辑在 BuildBundleCommand 中，build bundle 主要做两件事：第一，如果没有添加 <code>--precompiled</code> 选项时，会先编译 kernel；第二，生成 assets(图片、字体等)。</p>\n<ol>\n<li><p>编译 kernel。这个步骤和 build aot 的第一个步骤是一样的，最终会生成 app.dill，这是业务代码编译后的产物。同时，这个会创建一个 kernelContent，这个在第二个步骤会讲到：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kernelContent = DevFSFileContent(fs.file(compilerOutput.outputFilename));</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>生成 assets。首先，会收集图片资源、字体等：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> AssetBundle assets = <span class=\"keyword\">await</span> buildAssets(           </span><br><span class=\"line\">  manifestPath: manifestPath,                           </span><br><span class=\"line\">  assetDirPath: assetDirPath,                           </span><br><span class=\"line\">  packagesPath: packagesPath,                           </span><br><span class=\"line\">  reportLicensedPackages: reportLicensedPackages,       </span><br><span class=\"line\">);                                                      </span><br></pre></td></tr></table></figure>\n\n<p>其中包含有以下内容：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/30/16ce1dca5d92427d?w=745&h=265&f=png&s=49891\" alt=\"assets\"></p>\n<p>接着，会将这些，包含上面生成 kernelContent，一起收集到指定目录，kernelContent 就是编译生成的 app.dill，但这里会拷贝并重命名为 kernel_blob.bin：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"built_in\">String</span> _kKernelKey = <span class=\"string\">&#x27;kernel_blob.bin&#x27;</span>;                   </span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"built_in\">String</span> _kVMSnapshotData = <span class=\"string\">&#x27;vm_snapshot_data&#x27;</span>;             </span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"built_in\">String</span> _kIsolateSnapshotData = <span class=\"string\">&#x27;isolate_snapshot_data&#x27;</span>;   </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">String</span> vmSnapshotData = artifacts.getArtifactPath(Artifact.vmSnapshotData, mode: buildMode);            </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">String</span> isolateSnapshotData = artifacts.getArtifactPath(Artifact.isolateSnapshotData, mode: buildMode); </span><br><span class=\"line\">assetEntries[_kKernelKey] = kernelContent;                                                                    </span><br><span class=\"line\">assetEntries[_kVMSnapshotData] = DevFSFileContent(fs.file(vmSnapshotData));                                   </span><br><span class=\"line\">assetEntries[_kIsolateSnapshotData] = DevFSFileContent(fs.file(isolateSnapshotData));                         </span><br></pre></td></tr></table></figure>\n\n<p>我们注意到，这里同样会生成 vm_snapshot_data 和 isolate_snapshot_data，但并没有生成相应的指令集。在这里的 isolate_snapshot_data 中并不会包含我们的业务代码，业务代码会存放在 kernel_blob.bin 文件中。可以使用 <code>strings</code> 命令查看，而且这两个文件的 MD5 值是一致的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MD5 (app.dill) = 3876e8c6f4b13a88cc3cfc3b9fd108c4</span><br><span class=\"line\">MD5 (flutter_assets/kernel_blob.bin) = 3876e8c6f4b13a88cc3cfc3b9fd108c4</span><br></pre></td></tr></table></figure>\n\n<p>关于 snapshot 生成相关可以去看 <strong>gen_snapshot</strong>。</p>\n</li>\n</ol>\n<h4 id=\"小结-1\"><a href=\"#小结-1\" class=\"headerlink\" title=\"小结\"></a>小结</h4><h5 id=\"debug\"><a href=\"#debug\" class=\"headerlink\" title=\"debug\"></a>debug</h5><p>debug 模式下，会执行一个命令：</p>\n   <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flutter build bundle</span><br></pre></td></tr></table></figure>\n\n<p>它会生成 assets、vm_snapshot_data、isolate_snapshot_data 和 kernel_bloc.bin。其中我们的业务代码存放在 kernel_bloc.bin 中，它是 app.dill 的拷贝。</p>\n<h5 id=\"release\"><a href=\"#release\" class=\"headerlink\" title=\"release\"></a>release</h5><p>release 模式下，会执行两个命令：</p>\n   <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flutter build aot</span><br></pre></td></tr></table></figure>\n\n<p>它会先生成 app.dill，而且这里分为两种模式：app-aot-assemble 和 app-aot-blobs。iOS 或者 添加了 <code>--build-shared-library</code> 会使用 app-aot-assemble，这种模式会生成 App.Framework 或 app.so。Android 默认使用 app-aot-blobs，这种模式会生成 isolate_snapshot_data、isolate_snapshot_instr、vm_snapshot_data 和 vm_snapshot_instr 四个文件。</p>\n   <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flutter build bundle --precompiled</span><br></pre></td></tr></table></figure>\n\n<p>这里只会生成 assets。</p>\n<h3 id=\"调试源码\"><a href=\"#调试源码\" class=\"headerlink\" title=\"调试源码\"></a>调试源码</h3><p>调试是阅读源码最好的帮手，调试 flutter_tools 的方式比较简单，我用的是 IntelliJ，Android Studio 应该也类似，先导入源码，源码位于 sdk&#x2F;packages&#x2F;flutter_tools；新建一个 Dart Command Line App，设置 Dart file 为 bin&#x2F;flutter_tools.dart，Program arguments 设置你要调试的命令，比如 <code>build aot</code>，Working directory 则用 <code>flutter create</code> 创建个项目即可；最后打好断点，debug 运行。</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/30/16ce208c64320c8d?w=1071&h=673&f=png&s=60679\" alt=\"debug_tools\"></p>\n<blockquote>\n<p>因为源码中有很多异步代码，用 await 修饰的，可以使用 <strong>Force run to Cursor</strong> 直接执行到下一行即可。</p>\n</blockquote>\n<h3 id=\"结尾\"><a href=\"#结尾\" class=\"headerlink\" title=\"结尾\"></a>结尾</h3><p>为了避免篇幅太长，文章尽量避免贴很多的代码，只是贴了关键函数，感兴趣的读者可以去阅读相关的源码。</p>\n<p>Android 在 release 模式下，使用 app-aot-blobs 模式，用的是 snapshot 文件，这里要实现动态下发代码，应该还是有可能的，需要进一步研究。下一步应该会研究下<strong>热加载</strong>的实现，这对于实现动态化应该很有帮助。</p>\n<p>最后，Flutter 是一个非常好玩的事物，Dart 也是一个非常优秀的语言，enjoy it。</p>\n<blockquote>\n<p>因为我用习惯了 Typora 写 Markdown 了，但又需要用到掘金的图床，所以写了个小脚本用来上传图片。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\"> file_path = sys.argv[<span class=\"number\">1</span>]</span><br><span class=\"line\"> upload_file = <span class=\"built_in\">open</span>(file_path,mode=<span class=\"string\">&#x27;rb&#x27;</span>)</span><br><span class=\"line\"> data = requests.post(<span class=\"string\">&#x27;https://cdn-ms.juejin.im/v1/upload?bucket=gold-user-assets&#x27;</span>,files=&#123;<span class=\"string\">&#x27;file&#x27;</span>: upload_file&#125;).json()</span><br><span class=\"line\"> <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;upload url: &#x27;</span> + data[<span class=\"string\">&#x27;d&#x27;</span>][<span class=\"string\">&#x27;url&#x27;</span>][<span class=\"string\">&#x27;https&#x27;</span>])</span><br></pre></td></tr></table></figure></blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"不同版本构建产物的差异\"><a href=\"#不同版本构建产物的差异\" class=\"headerlink\" title=\"不同版本构建产物的差异\"></a>不同版本构建产物的差异</h3><p>写这篇文章的时间为：2019.08.25，当前 Flutter SDK 最新版本为 v1.9.5，其中 stable 最新版本为 v1.7.8+hotfix.4。</p>\n<p>随着版本的更新，Flutter 构建的产物也在调整，以 Android 为例，我们使用默认的 flutter_app 项目来测试，在不修改源码的情况下，使用不同的 SDK 版本来执行打包命令，每个版本都打两个包：debug 和 release。</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/25/16cc779633694337?w=758&h=506&f=png&s=34431\" alt=\"APK\"></p>\n<p>每个版本生成的 Flutter 产物如下所示，这里不列出 fonts、LICENSE 这些文件：</p>\n<table>\n<thead>\n<tr>\n<th>版本</th>\n<th>类型</th>\n<th>内容</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1.5.4</td>\n<td>debug</td>\n<td>assets&#x2F;flutter_assets&#x2F;kernel_blob.bin<br />assets&#x2F;flutter_assets&#x2F;isolate_snapshot_data<br />assets&#x2F;flutter_assets&#x2F;vm_snapshot_data<br />lib&#x2F;x86_64&#x2F;libflutter.so<br />lib&#x2F;x86&#x2F;libflutter.so<br />lib&#x2F;armeabi-v7a&#x2F;libflutter.so</td>\n<td></td>\n</tr>\n<tr>\n<td>1.5.4</td>\n<td>release</td>\n<td>assets&#x2F;isolate_snapshot_data<br />assets&#x2F;isolate_snapshot_instr<br />assets&#x2F;vm_snapshot_data<br />assets&#x2F;vm_snapshot_instr<br />lib&#x2F;armeabi-v7a&#x2F;libflutter.so</td>\n<td></td>\n</tr>\n<tr>\n<td>1.6.7</td>\n<td>debug</td>\n<td>新增了<br />assets&#x2F;snapshot_blob.bind.d.fingerprint<br />assets&#x2F;snapshot_blob.bin.d<br /></td>\n<td></td>\n</tr>\n<tr>\n<td>1.6.7</td>\n<td>release</td>\n<td>无变化</td>\n<td></td>\n</tr>\n<tr>\n<td>1.7.8</td>\n<td>debug</td>\n<td>删除了<br />assets&#x2F;snapshot_blob.bind.d.fingerprint<br />assets&#x2F;snapshot_blob.bin.d<br />新增了<br />lib&#x2F;arm64-v8a&#x2F;libflutter.so</td>\n<td></td>\n</tr>\n<tr>\n<td>1.7.8</td>\n<td>release</td>\n<td>删除了<br />assets&#x2F;isolate_snapshot_data<br />assets&#x2F;isolate_snapshot_instr<br />assets&#x2F;vm_snapshot_data<br />assets&#x2F;vm_snapshot_instr<br />新增了<br />lib&#x2F;armeabi-v7a&#x2F;libapp.so<br />lib&#x2F;arm64-v8a&#x2F;libflutter.so<br />lib&#x2F;arm64-v8a&#x2F;libapp.so</td>\n<td>从这个版本开始，release 下不使用 snapshot，同时增加了同时打包 64 位 so 文件</td>\n</tr>\n<tr>\n<td>1.8.4</td>\n<td>debug</td>\n<td>无变化</td>\n<td></td>\n</tr>\n<tr>\n<td>1.8.4</td>\n<td>release</td>\n<td>无变化</td>\n<td></td>\n</tr>\n<tr>\n<td>1.9.5</td>\n<td>debug</td>\n<td>无变化</td>\n<td></td>\n</tr>\n<tr>\n<td>1.9.5</td>\n<td>release</td>\n<td>无变化</td>\n<td></td>\n</tr>\n</tbody></table>\n<p>从上面的表格来看，1.5.x 版本和 1.7.x 版本的变化是比较明显的，主要的变化有两点，第一，1.7.x 版本增加了支持同时编译 32 位和 64 位两种架构，这个在之前一直被诟病，现在官方支持了。第二，release 模式下，不使用 snapshot 文件，而使用 libapp.so。snapshot 是 Dart VM 所支持的一种文件格式，类似 JVM 的 jar 一样，可以运行在虚拟机环境的文件。</p>\n<p>除了变化以外，我们还注意到一些不变的文件，比如 debug 模式下，一直存在的 kernel_blob.bin 文件；lib 目录下 libflutter.so 文件；这些文件各自的作用又是什么呢。带着疑问，我们一起看看 Flutter 的构建过程。</p>\n<h3 id=\"Flutter-支持的编译模式\"><a href=\"#Flutter-支持的编译模式\" class=\"headerlink\" title=\"Flutter 支持的编译模式\"></a>Flutter 支持的编译模式</h3><blockquote>\n<p>关于编译模式这块主要参考的：</p>\n<ul>\n<li><a href=\"https://proandroiddev.com/flutters-compilation-patterns-24e139d14177\">Flutter’s Compilation Patterns</a></li>\n</ul>\n</blockquote>\n<p>Flutter 是基于 Dart 开发的，所以 Flutter 的构建跟 Dart 是分不开的。所以，我们先讲 Dart。</p>\n<p>在将 Dart 之前，我们先了解两种编译模式，JIT 和 AOT：</p>\n<h5 id=\"JIT\"><a href=\"#JIT\" class=\"headerlink\" title=\"JIT\"></a>JIT</h5><p>JIT(Just In Time) 翻译为 <strong>即时编译</strong>，指的是在程序运行中，将热点代码编译成机器码，提高运行效率。常见例子有 V8 引擎和 JVM，JIT 可以充分利用解释型语言的优点，动态执行源码，而不用考虑平台差异性。这里需要注意的是，对于 JVM 来说，源码指字节码，而不是 Java 源码。</p>\n<blockquote>\n<p>这里需要区分，JIT 和解释型语言的区别，JIT 是一种编译模式，比如，Java 是编译型语言，但它也可以使用 JIT。</p>\n</blockquote>\n<h5 id=\"AOT\"><a href=\"#AOT\" class=\"headerlink\" title=\"AOT\"></a>AOT</h5><p>AOT(Ahead Of Time) 称为 <strong>运行前编译</strong>，指的是在程序运行之前，已经编译成对应平台的机器码，不需要在运行中解释编译，就可以直接运行。常见例子有 C 和 C++。</p>\n<p>虽然，我们会区别 JIT 和 AOT 两种编译模式，但实际上，有很多语言并不是完全使用 JIT 或者 AOT 的，通常它们会混用这两种模式，来达到最大的性能优化。</p>\n<h4 id=\"Dart-支持的编译模式\"><a href=\"#Dart-支持的编译模式\" class=\"headerlink\" title=\"Dart 支持的编译模式\"></a>Dart 支持的编译模式</h4><p>Dart VM 支持四种编译模式：</p>\n<ul>\n<li><p><strong>Script</strong>：最常见的 JIT 模式，可以直接在虚拟机中执行 Dart 源码，像解释型语言一样使用。</p>\n<p>通过执行 <code>dart xxx.dart</code> 就可以运行，写一些临时脚本，非常方便。</p>\n</li>\n<li><p><strong>Kernel Snapshots</strong>：JIT 模式，和 <strong>Script</strong> 模式不同的是，这种模式执行的是 <a href=\"https://github.com/dart-lang/sdk/tree/master/pkg/kernel\">Kernel AST</a> 的二进制数据，这里不包含解析后的类和函数，编译后的代码，所以它们可以在不同的平台之间移植。</p>\n<p>在 <a href=\"https://proandroiddev.com/flutters-compilation-patterns-24e139d14177\">Flutter’s Compilation Patterns</a> 这篇文章中，将 Kernel Snapshots 称为 Script Snapshots 也是对的，这应该是之前的叫法，从 <a href=\"https://github.com/dart-lang\">dart-lang</a> 的 <a href=\"https://github.com/dart-lang/sdk/wiki/Snapshots/_compare/a3bb7a829f461bf4703533d23462f1ac3760a2d8\">wiki</a> 中可以看出来：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/27/16cd1d07e1258d95?w=986&h=299&f=png&s=62397\" alt=\"Kernel Snapshots And Script Snapshots\"></p>\n<p>Dart Kernel 是 Dart 程序中的一种中间语言，更多的资料可阅读 <a href=\"https://github.com/dart-lang/sdk/wiki/Kernel-Documentation\">Kernel Documentation</a>。</p>\n<p>通过执行 <code>dart --snapshot-kind=kernel --snapshot=xx.snapshot xx.dart</code> 生成。</p>\n</li>\n<li><p><strong>JIT Application Snapshots</strong>：JIT 模式，这里执行的是已经解析过的类和函数，所以它会运行起来会更快。但是这不是平台无关，它只能针对 32位 或者 64位 架构运行。</p>\n<p>通过执行 <code>dart --snapshot-kind=app-jit --snapshot=xx.snapshot xx.dart</code> 生成。</p>\n</li>\n<li><p><strong>AOT Application Snapshots</strong>：AOT 模式，在这种模式下，Dart 源码会被提前编译成特定平台的二进制文件。</p>\n<p>要使用 AOT 模式，需要使用 <code>dart2aot</code> 命令， 具体使用为：<code>dart2aot xx.dart xx.dart.aot</code>，然后使用 <code>dartaotruntime</code> 命令执行。</p>\n</li>\n</ul>\n<p>Dart JIT 模式需要配合 Dart VM(虚拟机) ，AOT 则会使用 runtime 来执行，引用官网中的图片来说明：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/27/16cd13e09839fae9?w=795&h=252&f=png&s=18282\" alt=\"jit-and-aot\"></p>\n<p>可以用下面这张图来总结上面的四种模式：</p>\n<blockquote>\n<p>图片来源于 <a href=\"https://proandroiddev.com/flutters-compilation-patterns-24e139d14177\">flutters-compilation-patterns</a></p>\n</blockquote>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/25/16cc7eb579c05a1d?w=1344&h=386&f=png&s=54640\" alt=\"Dart’s compilation patterns\"></p>\n<p>四种模式下的产物大小和启动速度比较：</p>\n<blockquote>\n<p>图片来源于 <a href=\"https://medium.com/@takahirom/exploring-flutter-in-android-533598ba17d2\">exploring-flutter-in-android</a></p>\n</blockquote>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/28/16cd76297cd9f674?w=373&h=263&f=png&s=37448\" alt=\"whai is snapshot\"></p>\n<h3 id=\"Flutter-构建过程\"><a href=\"#Flutter-构建过程\" class=\"headerlink\" title=\"Flutter 构建过程\"></a>Flutter 构建过程</h3><blockquote>\n<p>下面的分析都是基于 <strong>v1.5.4-hotfix.2</strong></p>\n</blockquote>\n<p>执行 <code>flutter build apk</code> 时，默认会生成 release APK，实际是执行的 sdk&#x2F;bin&#x2F;flutter 命令，参数为 build apk：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DART_SDK_PATH=&quot;$FLUTTER_ROOT/bin/cache/dart-sdk&quot;</span><br><span class=\"line\">DART=&quot;$DART_SDK_PATH/bin/dart&quot;</span><br><span class=\"line\">SNAPSHOT_PATH=&quot;$FLUTTER_ROOT/bin/cache/flutter_tools.snapshot&quot;</span><br><span class=\"line\">&quot;$DART&quot; $FLUTTER_TOOL_ARGS &quot;$SNAPSHOT_PATH&quot; &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<p>上面的命令完整应该为：<code>dart flutter_tools.snapshot args</code>，snapshot 文件我们上面提过，是 Dart 的一种代码集合，类似 Java 中 Jar 包。</p>\n<p>flutter_tools 的源码位于 sdk&#x2F;packages&#x2F;flutter_tools&#x2F;bin 下的 flutter_tools.dart，跟 Java 一样，这里也有个 <code>main()</code> 函数，其中调用的是 <code>executable.main()</code> 函数。</p>\n<p>在 main 函数中，会注册多个命令处理器，比如：</p>\n<ul>\n<li>DoctorCommand 对应 <code>flutter doctor</code> 命令</li>\n<li>CleanCommand 对应 <code>flutter clean</code> 命令</li>\n<li>等等</li>\n</ul>\n<p>我们这次要研究的目标是 BuildCommand，它里面又包含了以下子命令处理器：</p>\n<ul>\n<li>BuildApkCommand 对应 <code>flutter build apk</code> 命令</li>\n<li>BuildAppBundleCommand 对应 <code>flutter build bundle</code> 命令</li>\n<li>BuildAotCommand 对应 <code>flutter build aot</code> 命令</li>\n<li>等等</li>\n</ul>\n<h4 id=\"Build-APK\"><a href=\"#Build-APK\" class=\"headerlink\" title=\"Build APK\"></a>Build APK</h4><p>首先我们要理清 build apk 或者 build ios，和 build bundle、build aot 之间的关系。这里我们以 build apk 为例：</p>\n<p>当执行 <code>flutter build apk</code> 时，最终会调用到 gradle.dart 中的 <code>_buildGradleProjectV2()</code> 方法，在这里最后也是调用 gradle 执行 assemble task。而在项目中的 android&#x2F;app&#x2F;build.gradle 中可以看到：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">from:</span> <span class=\"string\">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>也就是说，会在 flutter.gradle 这里去插入一些编译 Flutter 产物的脚本。</p>\n<p>flutter.gradle 是通过插件的形式去实现的，这个插件命名为 FlutterPlugin。这个插件的主要作用有一些几点：</p>\n<ul>\n<li><p>除了默认的 debug 和 release 之外，新增了 profile、dynamicProfile、dynamicRelease 这三种 buildTypes：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.android.buildTypes &#123;                                </span><br><span class=\"line\">    profile &#123;                                               </span><br><span class=\"line\">        initWith debug                                      </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;          </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]        </span><br><span class=\"line\">        &#125;                                                   </span><br><span class=\"line\">    &#125;                                                       </span><br><span class=\"line\">    dynamicProfile &#123;                                        </span><br><span class=\"line\">        initWith debug                                      </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;          </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]        </span><br><span class=\"line\">        &#125;                                                   </span><br><span class=\"line\">    &#125;                                                       </span><br><span class=\"line\">    dynamicRelease &#123;                                        </span><br><span class=\"line\">        initWith debug                                      </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;          </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]        </span><br><span class=\"line\">        &#125;                                                   </span><br><span class=\"line\">    &#125;                                                       </span><br><span class=\"line\">&#125;                                                           </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>动态添加 flutter.jar 依赖：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">void</span> addFlutterJarApiDependency(Project project, buildType, Task flutterX86JarTask) &#123;   </span><br><span class=\"line\">    project.dependencies &#123;                                                                      </span><br><span class=\"line\">        String configuration;                                                                   </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (project.getConfigurations().findByName(<span class=\"string\">&quot;api&quot;</span>)) &#123;                                    </span><br><span class=\"line\">            configuration = buildType.name + <span class=\"string\">&quot;Api&quot;</span>;                                             </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;                                                                                </span><br><span class=\"line\">            configuration = buildType.name + <span class=\"string\">&quot;Compile&quot;</span>;                                         </span><br><span class=\"line\">        &#125;                                                                                       </span><br><span class=\"line\">        add(configuration, project.files &#123;                                                      </span><br><span class=\"line\">            String buildMode = buildModeFor(buildType)                                          </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;debug&quot;</span>) &#123;                                                         </span><br><span class=\"line\">                [flutterX86JarTask, debugFlutterJar]                                            </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;profile&quot;</span>) &#123;                                                </span><br><span class=\"line\">                profileFlutterJar                                                               </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;dynamicProfile&quot;</span>) &#123;                                         </span><br><span class=\"line\">                dynamicProfileFlutterJar                                                        </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;dynamicRelease&quot;</span>) &#123;                                         </span><br><span class=\"line\">                dynamicReleaseFlutterJar                                                        </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;                                                                            </span><br><span class=\"line\">                releaseFlutterJar                                                               </span><br><span class=\"line\">            &#125;                                                                                   </span><br><span class=\"line\">        &#125;)                                                                                      </span><br><span class=\"line\">    &#125;                                                                                           </span><br><span class=\"line\">&#125;                                                                                               </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>动态添加第三方插件依赖：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.dependencies &#123;                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (project.getConfigurations().findByName(<span class=\"string\">&quot;implementation&quot;</span>)) &#123;</span><br><span class=\"line\">        implementation pluginProject                               </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                       </span><br><span class=\"line\">        compile pluginProject                                      </span><br><span class=\"line\">    &#125;                                                              </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在 assemble task 中添加一个 FlutterTask，这个 task 非常重要，这里会去生成 Flutter 所需要的产物：</p>\n<p>首先，当 buildType 是 profile 或 release 时，会执行 <code>flutter build aot</code>：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;profile&quot;</span> || buildMode == <span class=\"string\">&quot;release&quot;</span>) &#123;                               </span><br><span class=\"line\">    project.exec &#123;                                                                    </span><br><span class=\"line\">        executable flutterExecutable.absolutePath                                     </span><br><span class=\"line\">        workingDir sourceDir                                                          </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (localEngine != <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">            args <span class=\"string\">&quot;--local-engine&quot;</span>, localEngine                                        </span><br><span class=\"line\">            args <span class=\"string\">&quot;--local-engine-src-path&quot;</span>, localEngineSrcPath                        </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        args <span class=\"string\">&quot;build&quot;</span>, <span class=\"string\">&quot;aot&quot;</span>                                                           </span><br><span class=\"line\">        args <span class=\"string\">&quot;--suppress-analytics&quot;</span>                                                   </span><br><span class=\"line\">        args <span class=\"string\">&quot;--quiet&quot;</span>                                                                </span><br><span class=\"line\">        args <span class=\"string\">&quot;--target&quot;</span>, targetPath                                                   </span><br><span class=\"line\">        args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;android-arm&quot;</span>                                       </span><br><span class=\"line\">        args <span class=\"string\">&quot;--output-dir&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;&quot;</span>                                     </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (trackWidgetCreation) &#123;                                                    </span><br><span class=\"line\">            args <span class=\"string\">&quot;--track-widget-creation&quot;</span>                                            </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (extraFrontEndOptions != <span class=\"literal\">null</span>) &#123;                                           </span><br><span class=\"line\">            args <span class=\"string\">&quot;--extra-front-end-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraFrontEndOptions&#125;&quot;</span>               </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (extraGenSnapshotOptions != <span class=\"literal\">null</span>) &#123;                                        </span><br><span class=\"line\">            args <span class=\"string\">&quot;--extra-gen-snapshot-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraGenSnapshotOptions&#125;&quot;</span>         </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildSharedLibrary) &#123;                                                     </span><br><span class=\"line\">            args <span class=\"string\">&quot;--build-shared-library&quot;</span>                                             </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (targetPlatform != <span class=\"literal\">null</span>) &#123;                                                 </span><br><span class=\"line\">            args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;$&#123;targetPlatform&#125;&quot;</span>                             </span><br><span class=\"line\">        &#125;                                                                             </span><br><span class=\"line\">        args <span class=\"string\">&quot;--$&#123;buildMode&#125;&quot;</span>                                                         </span><br><span class=\"line\">    &#125;                                                                                 </span><br><span class=\"line\">&#125;                                                                                     </span><br></pre></td></tr></table></figure>\n\n<p>其次，执行 <code>flutter build bundle</code> 命令，当 buildType 为 profile 或 release 时，添加额外的 –precompiled 选项。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.exec &#123;                                                                    </span><br><span class=\"line\">    executable flutterExecutable.absolutePath                                     </span><br><span class=\"line\">    workingDir sourceDir                                                          </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (localEngine != <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">        args <span class=\"string\">&quot;--local-engine&quot;</span>, localEngine                                        </span><br><span class=\"line\">        args <span class=\"string\">&quot;--local-engine-src-path&quot;</span>, localEngineSrcPath                        </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    args <span class=\"string\">&quot;build&quot;</span>, <span class=\"string\">&quot;bundle&quot;</span>                                                        </span><br><span class=\"line\">    args <span class=\"string\">&quot;--suppress-analytics&quot;</span>                                                   </span><br><span class=\"line\">    args <span class=\"string\">&quot;--target&quot;</span>, targetPath                                                   </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (verbose) &#123;                                                                </span><br><span class=\"line\">        args <span class=\"string\">&quot;--verbose&quot;</span>                                                          </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fileSystemRoots != <span class=\"literal\">null</span>) &#123;                                                </span><br><span class=\"line\">        <span class=\"keyword\">for</span> (root <span class=\"keyword\">in</span> fileSystemRoots) &#123;                                           </span><br><span class=\"line\">            args <span class=\"string\">&quot;--filesystem-root&quot;</span>, root                                        </span><br><span class=\"line\">        &#125;                                                                         </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fileSystemScheme != <span class=\"literal\">null</span>) &#123;                                               </span><br><span class=\"line\">        args <span class=\"string\">&quot;--filesystem-scheme&quot;</span>, fileSystemScheme                              </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (trackWidgetCreation) &#123;                                                    </span><br><span class=\"line\">        args <span class=\"string\">&quot;--track-widget-creation&quot;</span>                                            </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (compilationTraceFilePath != <span class=\"literal\">null</span>) &#123;                                       </span><br><span class=\"line\">        args <span class=\"string\">&quot;--compilation-trace-file&quot;</span>, compilationTraceFilePath                 </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (createPatch) &#123;                                                            </span><br><span class=\"line\">        args <span class=\"string\">&quot;--patch&quot;</span>                                                            </span><br><span class=\"line\">        args <span class=\"string\">&quot;--build-number&quot;</span>, project.android.defaultConfig.versionCode          </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildNumber != <span class=\"literal\">null</span>) &#123;                                                </span><br><span class=\"line\">            <span class=\"keyword\">assert</span> buildNumber == project.android.defaultConfig.versionCode       </span><br><span class=\"line\">        &#125;                                                                         </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (baselineDir != <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">        args <span class=\"string\">&quot;--baseline-dir&quot;</span>, baselineDir                                        </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (extraFrontEndOptions != <span class=\"literal\">null</span>) &#123;                                           </span><br><span class=\"line\">        args <span class=\"string\">&quot;--extra-front-end-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraFrontEndOptions&#125;&quot;</span>               </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (extraGenSnapshotOptions != <span class=\"literal\">null</span>) &#123;                                        </span><br><span class=\"line\">        args <span class=\"string\">&quot;--extra-gen-snapshot-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraGenSnapshotOptions&#125;&quot;</span>         </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetPlatform != <span class=\"literal\">null</span>) &#123;                                                 </span><br><span class=\"line\">        args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;$&#123;targetPlatform&#125;&quot;</span>                             </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;release&quot;</span> || buildMode == <span class=\"string\">&quot;profile&quot;</span>) &#123;                       </span><br><span class=\"line\">        args <span class=\"string\">&quot;--precompiled&quot;</span>                                                      </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                      </span><br><span class=\"line\">        args <span class=\"string\">&quot;--depfile&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;/snapshot_blob.bin.d&quot;</span>                </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    args <span class=\"string\">&quot;--asset-dir&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;/flutter_assets&quot;</span>                       </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;debug&quot;</span>) &#123;                                                   </span><br><span class=\"line\">        args <span class=\"string\">&quot;--debug&quot;</span>                                                            </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;profile&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicProfile&quot;</span>) &#123;                </span><br><span class=\"line\">        args <span class=\"string\">&quot;--profile&quot;</span>                                                          </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;release&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicRelease&quot;</span>) &#123;                </span><br><span class=\"line\">        args <span class=\"string\">&quot;--release&quot;</span>                                                          </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;dynamicProfile&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicRelease&quot;</span>) &#123;         </span><br><span class=\"line\">        args <span class=\"string\">&quot;--dynamic&quot;</span>                                                          </span><br><span class=\"line\">    &#125;                                                                             </span><br><span class=\"line\">&#125;                                                                                 </span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>稍微总结下，当 buildType 为 debug 时，只需要执行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flutter build bundle</span><br></pre></td></tr></table></figure>\n\n<p>而当 buildType 为 release 时，需要执行两个命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flutter build aot</span><br><span class=\"line\">flutter build bundle --precompiled</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Build-AOT\"><a href=\"#Build-AOT\" class=\"headerlink\" title=\"Build AOT\"></a>Build AOT</h4><p>当执行 <code>flutter build aot</code> 时，相关的逻辑在 BuildAotCommand 中，它主要分成两个步骤：</p>\n<ol>\n<li><p>编译 kernel。kernel 指 Dart 的一种中间语言，更多资料可以阅读 <a href=\"https://github.com/dart-lang/sdk/wiki/Kernel-Documentation\">Kernel-Documentation</a>。最终会调用到 compile.dart 中的 <code>KernelCompiler.compile()</code> 方法：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">List</span>&lt;<span class=\"built_in\">String</span>&gt; command = &lt;<span class=\"built_in\">String</span>&gt;[                                                                  </span><br><span class=\"line\">  engineDartPath,                                                                                       </span><br><span class=\"line\">  frontendServer,                                                                                       </span><br><span class=\"line\">  <span class=\"string\">&#x27;--sdk-root&#x27;</span>,                                                                                         </span><br><span class=\"line\">  sdkRoot,                                                                                              </span><br><span class=\"line\">  <span class=\"string\">&#x27;--strong&#x27;</span>,                                                                                           </span><br><span class=\"line\">  <span class=\"string\">&#x27;--target=<span class=\"subst\">$targetModel</span>&#x27;</span>,                                                                              </span><br><span class=\"line\">];                                                                                                      </span><br><span class=\"line\"><span class=\"keyword\">if</span> (trackWidgetCreation)                                                                                </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;--track-widget-creation&#x27;</span>);                                                               </span><br><span class=\"line\"><span class=\"keyword\">if</span> (!linkPlatformKernelIn)                                                                              </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;--no-link-platform&#x27;</span>);                                                                    </span><br><span class=\"line\"><span class=\"keyword\">if</span> (aot) &#123;                                                                                              </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;--aot&#x27;</span>);                                                                                 </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;--tfa&#x27;</span>);                                                                                 </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (targetProductVm) &#123;                                                                                  </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;-Ddart.vm.product=true&#x27;</span>);                                                                </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (incrementalCompilerByteStorePath != <span class=\"keyword\">null</span>) &#123;                                                         </span><br><span class=\"line\">  command.add(<span class=\"string\">&#x27;--incremental&#x27;</span>);                                                                         </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"built_in\">Uri</span> mainUri;                                                                                            </span><br><span class=\"line\"><span class=\"keyword\">if</span> (packagesPath != <span class=\"keyword\">null</span>) &#123;                                                                             </span><br><span class=\"line\">  command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--packages&#x27;</span>, packagesPath]);                                                 </span><br><span class=\"line\">  mainUri = PackageUriMapper.findUri(mainPath, packagesPath, fileSystemScheme, fileSystemRoots);        </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (outputFilePath != <span class=\"keyword\">null</span>) &#123;                                                                           </span><br><span class=\"line\">  command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--output-dill&#x27;</span>, outputFilePath]);                                            </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (depFilePath != <span class=\"keyword\">null</span> &amp;&amp; (fileSystemRoots == <span class=\"keyword\">null</span> || fileSystemRoots.isEmpty)) &#123;                      </span><br><span class=\"line\">  command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--depfile&#x27;</span>, depFilePath]);                                                   </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (fileSystemRoots != <span class=\"keyword\">null</span>) &#123;                                                                          </span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"built_in\">String</span> root <span class=\"keyword\">in</span> fileSystemRoots) &#123;                                                                </span><br><span class=\"line\">    command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--filesystem-root&#x27;</span>, root]);                                                </span><br><span class=\"line\">  &#125;                                                                                                     </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (fileSystemScheme != <span class=\"keyword\">null</span>) &#123;                                                                         </span><br><span class=\"line\">  command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--filesystem-scheme&#x27;</span>, fileSystemScheme]);                                    </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\"><span class=\"keyword\">if</span> (initializeFromDill != <span class=\"keyword\">null</span>) &#123;                                                                       </span><br><span class=\"line\">  command.addAll(&lt;<span class=\"built_in\">String</span>&gt;[<span class=\"string\">&#x27;--initialize-from-dill&#x27;</span>, initializeFromDill]);                               </span><br><span class=\"line\">&#125;                                                                                                       </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\"><span class=\"keyword\">if</span> (extraFrontEndOptions != <span class=\"keyword\">null</span>)                                                                       </span><br><span class=\"line\">  command.addAll(extraFrontEndOptions);                                                                 </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">command.add(mainUri?.toString() ?? mainPath);                                                           </span><br><span class=\"line\">                                                                                                        </span><br><span class=\"line\">printTrace(command.join(<span class=\"string\">&#x27; &#x27;</span>));                                                                          </span><br><span class=\"line\"><span class=\"keyword\">final</span> Process server = <span class=\"keyword\">await</span> processManager                                                             </span><br><span class=\"line\">  .start(command)                                                                                       </span><br><span class=\"line\">  .catchError((<span class=\"built_in\">dynamic</span> error, StackTrace stack) &#123;                                                       </span><br><span class=\"line\">    printError(<span class=\"string\">&#x27;Failed to start frontend server <span class=\"subst\">$error</span>, <span class=\"subst\">$stack</span>&#x27;</span>);                                       </span><br><span class=\"line\">  &#125;);                                                                                                   </span><br><span class=\"line\">                                                                                                        </span><br></pre></td></tr></table></figure>\n\n<p>engineDart 指向  Dart SDK 目录，上面代码执行的最终命令可以简化为：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dart frontend_server.dart.snapshot --output-dill app.dill packages:main.dart</span><br></pre></td></tr></table></figure>\n\n<p>app.dill 这里面其实就包含了我们的业务代码了，可以使用 <code>strings app.dill</code> 查看：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/29/16cdcd6bb5bcfcfe?w=579&h=281&f=png&s=39501\" alt=\"app.dill\"></p>\n</li>\n<li><p>生成 snpshot。相关的代码位于 base&#x2F;build.dart 中的 <code>AOTSnapshotter.build()</code> 函数中，有两种模式：app-aot-assemble 和 app-aot-blobs。</p>\n</li>\n</ol>\n<h6 id=\"app-aot-assemble\"><a href=\"#app-aot-assemble\" class=\"headerlink\" title=\"app-aot-assemble\"></a>app-aot-assemble</h6><p>   在执行 aot 命令时，增加 <code>--build-shared-library</code> 选项，完整命令如下：</p>\n<p>   <code>flutter build aot --build-shared-library</code></p>\n<blockquote>\n<p>iOS 只能使用这种模式，在 Flutter SDK 1.7.x 之后，这个也是 Android 的默认选项。</p>\n</blockquote>\n   <figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// buildSharedLibrary is ignored for iOS builds.                                        </span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (platform == TargetPlatform.ios)                                                     </span><br><span class=\"line\">  buildSharedLibrary = <span class=\"keyword\">false</span>;                                                           </span><br><span class=\"line\">                                                                                        </span><br><span class=\"line\"><span class=\"keyword\">if</span> (buildSharedLibrary &amp;&amp; androidSdk.ndk == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 需要有 NDK 环境</span></span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> explanation = AndroidNdk.explainMissingNdk(androidSdk.directory);        </span><br><span class=\"line\">  printError(                                                                           </span><br><span class=\"line\">    <span class=\"string\">&#x27;Could not find NDK in Android SDK at <span class=\"subst\">$&#123;androidSdk.directory&#125;</span>:\\n&#x27;</span>                   </span><br><span class=\"line\">    <span class=\"string\">&#x27;\\n&#x27;</span>                                                                                </span><br><span class=\"line\">    <span class=\"string\">&#x27;  <span class=\"subst\">$explanation</span>\\n&#x27;</span>                                                                  </span><br><span class=\"line\">    <span class=\"string\">&#x27;\\n&#x27;</span>                                                                                </span><br><span class=\"line\">    <span class=\"string\">&#x27;Unable to build with --build-shared-library\\n&#x27;</span>                                     </span><br><span class=\"line\">    <span class=\"string\">&#x27;To install the NDK, see instructions at https://developer.android.com/ndk/guides/&#x27;</span> </span><br><span class=\"line\">  );                                                                                    </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1</span>;                                                                             </span><br><span class=\"line\">&#125;                                                                                       </span><br></pre></td></tr></table></figure>\n\n<p>   这种模式下，会将产物编译为二进制文件，在 iOS 上为 App.framework，Android 上则为 app.so。</p>\n   <figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Assembly AOT snapshot.                                </span></span><br><span class=\"line\">outputPaths.add(assembly);                               </span><br><span class=\"line\">genSnapshotArgs.add(<span class=\"string\">&#x27;--snapshot_kind=app-aot-assembly&#x27;</span>); </span><br><span class=\"line\">genSnapshotArgs.add(<span class=\"string\">&#x27;--assembly=<span class=\"subst\">$assembly</span>&#x27;</span>);             </span><br></pre></td></tr></table></figure>\n\n<h5 id=\"app-aot-blobs\"><a href=\"#app-aot-blobs\" class=\"headerlink\" title=\"app-aot-blobs\"></a>app-aot-blobs</h5><p>   当使用这种模式时，会生成四个产物，分别是：</p>\n<blockquote>\n<p>instr 全称是 Instructions</p>\n<p>了解更多：<a href=\"https://github.com/flutter/flutter/wiki/Flutter-engine-operation-in-AOT-Mode\">Flutter-engine-operation-in-AOT-Mode</a></p>\n</blockquote>\n<ul>\n<li><p>isolate_snapshot_data：</p>\n<p>表示 isolate 堆存储区的初始状态和特定的信息。和 vm_snapshot_data 配合，更快的启动 Dart VM。</p>\n</li>\n<li><p>isolate_snapshot_instr:</p>\n<p>包含由 Dart isolate 执行的 AOT 代码。</p>\n</li>\n<li><p>vm_snapshot_data:</p>\n<p>表示 isolates 之间的共享的 Dart 堆存储区的初始状态，用于更快的启动 Dart VM。</p>\n</li>\n<li><p>vm_snapshot_instr:</p>\n<p>包含 VM 中所有的 isolates 之间共享的常见例程的指令</p>\n</li>\n</ul>\n<p>   isolate_snapshot_data 和 isolate_snapshot_instr 跟业务相关，而 vm_snapshot_data 和 vm_snapshot_instr 则是跟 VM 相关，无关业务。</p>\n<p>   我们可以使用 <code>strings</code> 查看下 isolate_snapshot_data  中内容：</p>\n<p>   <img src=\"https://user-gold-cdn.xitu.io/2019/8/30/16ce1f8f15b2cf3b?w=683&h=263&f=png&s=42699\" alt=\"isolate_snapshot_data\"></p>\n<h4 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h4><p>   上面两种模式相关的代码如下：</p>\n   <figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> assembly = fs.path.join(outputDir.path, <span class=\"string\">&#x27;snapshot_assembly.S&#x27;</span>);                                              </span><br><span class=\"line\">   <span class=\"keyword\">if</span> (buildSharedLibrary || platform == TargetPlatform.ios) &#123;                                                               </span><br><span class=\"line\">     <span class=\"comment\">// Assembly AOT snapshot.                                                                                               </span></span><br><span class=\"line\">     outputPaths.add(assembly);                                                                                              </span><br><span class=\"line\">     genSnapshotArgs.add(<span class=\"string\">&#x27;--snapshot_kind=app-aot-assembly&#x27;</span>);                                                                </span><br><span class=\"line\">     genSnapshotArgs.add(<span class=\"string\">&#x27;--assembly=<span class=\"subst\">$assembly</span>&#x27;</span>);                                                                            </span><br><span class=\"line\">   &#125; <span class=\"keyword\">else</span> &#123;                                                                                                                  </span><br><span class=\"line\">     <span class=\"comment\">// Blob AOT snapshot.                                                                                                   </span></span><br><span class=\"line\">     <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> vmSnapshotData = fs.path.join(outputDir.path, <span class=\"string\">&#x27;vm_snapshot_data&#x27;</span>);                                         </span><br><span class=\"line\">     <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> isolateSnapshotData = fs.path.join(outputDir.path, <span class=\"string\">&#x27;isolate_snapshot_data&#x27;</span>);                               </span><br><span class=\"line\">     <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> vmSnapshotInstructions = fs.path.join(outputDir.path, <span class=\"string\">&#x27;vm_snapshot_instr&#x27;</span>);                                </span><br><span class=\"line\">     <span class=\"keyword\">final</span> <span class=\"built_in\">String</span> isolateSnapshotInstructions = fs.path.join(outputDir.path, <span class=\"string\">&#x27;isolate_snapshot_instr&#x27;</span>);                      </span><br><span class=\"line\">     outputPaths.addAll(&lt;<span class=\"built_in\">String</span>&gt;[vmSnapshotData, isolateSnapshotData, vmSnapshotInstructions, isolateSnapshotInstructions]); </span><br><span class=\"line\">     genSnapshotArgs.addAll(&lt;<span class=\"built_in\">String</span>&gt;[                                                                                        </span><br><span class=\"line\">       <span class=\"string\">&#x27;--snapshot_kind=app-aot-blobs&#x27;</span>,                                                                                      </span><br><span class=\"line\">       <span class=\"string\">&#x27;--vm_snapshot_data=<span class=\"subst\">$vmSnapshotData</span>&#x27;</span>,                                                                                 </span><br><span class=\"line\">       <span class=\"string\">&#x27;--isolate_snapshot_data=<span class=\"subst\">$isolateSnapshotData</span>&#x27;</span>,                                                                       </span><br><span class=\"line\">       <span class=\"string\">&#x27;--vm_snapshot_instructions=<span class=\"subst\">$vmSnapshotInstructions</span>&#x27;</span>,                                                                 </span><br><span class=\"line\"> <span class=\"string\">&#x27;--isolate_snapshot_instructions=<span class=\"subst\">$isolateSnapshotInstructions</span>&#x27;</span>,                                                       </span><br><span class=\"line\">     ]);                                                                                                                     </span><br><span class=\"line\">&#125;                                                                                                                         </span><br></pre></td></tr></table></figure>\n<p>   从执行速度来看，app-aot-assemble 是要快于 app-aot-blobs 的，因为它不需要 Dart VM 环境，只需要 Dart Runtime 即可，而 snapshots 文件是需要 Dart VM 去加载执行的。但使用 snapshots 使得动态执行代码变成可能。</p>\n<p>   iOS 默认使用 app-aot-assemble 模式，更多是 App Store 本身的限制：</p>\n<blockquote>\n<p>引用于<a href=\"https://proandroiddev.com/flutters-compilation-patterns-24e139d14177\">flutters-compilation-patterns</a></p>\n<p>App Store does not allow dispatch binary executable code. </p>\n</blockquote>\n<p>   而 Android 默认使用 app-aot-blobs 模式，可能更多是从性能方面考虑，必须调用从 so 文件中调用 native 函数，需要用 JNI，有性能损耗，而且调用也比较麻烦，不过在 Flutter SDK 1.7.x 已经改成 app-aot-assemble 模式。</p>\n<h4 id=\"Build-Bundle\"><a href=\"#Build-Bundle\" class=\"headerlink\" title=\"Build Bundle\"></a>Build Bundle</h4><p>当执行 <code>flutter build bundle</code> 时，相关的代码逻辑在 BuildBundleCommand 中，build bundle 主要做两件事：第一，如果没有添加 <code>--precompiled</code> 选项时，会先编译 kernel；第二，生成 assets(图片、字体等)。</p>\n<ol>\n<li><p>编译 kernel。这个步骤和 build aot 的第一个步骤是一样的，最终会生成 app.dill，这是业务代码编译后的产物。同时，这个会创建一个 kernelContent，这个在第二个步骤会讲到：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kernelContent = DevFSFileContent(fs.file(compilerOutput.outputFilename));</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>生成 assets。首先，会收集图片资源、字体等：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> AssetBundle assets = <span class=\"keyword\">await</span> buildAssets(           </span><br><span class=\"line\">  manifestPath: manifestPath,                           </span><br><span class=\"line\">  assetDirPath: assetDirPath,                           </span><br><span class=\"line\">  packagesPath: packagesPath,                           </span><br><span class=\"line\">  reportLicensedPackages: reportLicensedPackages,       </span><br><span class=\"line\">);                                                      </span><br></pre></td></tr></table></figure>\n\n<p>其中包含有以下内容：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/30/16ce1dca5d92427d?w=745&h=265&f=png&s=49891\" alt=\"assets\"></p>\n<p>接着，会将这些，包含上面生成 kernelContent，一起收集到指定目录，kernelContent 就是编译生成的 app.dill，但这里会拷贝并重命名为 kernel_blob.bin：</p>\n<figure class=\"highlight dart\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"built_in\">String</span> _kKernelKey = <span class=\"string\">&#x27;kernel_blob.bin&#x27;</span>;                   </span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"built_in\">String</span> _kVMSnapshotData = <span class=\"string\">&#x27;vm_snapshot_data&#x27;</span>;             </span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"built_in\">String</span> _kIsolateSnapshotData = <span class=\"string\">&#x27;isolate_snapshot_data&#x27;</span>;   </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">String</span> vmSnapshotData = artifacts.getArtifactPath(Artifact.vmSnapshotData, mode: buildMode);            </span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"built_in\">String</span> isolateSnapshotData = artifacts.getArtifactPath(Artifact.isolateSnapshotData, mode: buildMode); </span><br><span class=\"line\">assetEntries[_kKernelKey] = kernelContent;                                                                    </span><br><span class=\"line\">assetEntries[_kVMSnapshotData] = DevFSFileContent(fs.file(vmSnapshotData));                                   </span><br><span class=\"line\">assetEntries[_kIsolateSnapshotData] = DevFSFileContent(fs.file(isolateSnapshotData));                         </span><br></pre></td></tr></table></figure>\n\n<p>我们注意到，这里同样会生成 vm_snapshot_data 和 isolate_snapshot_data，但并没有生成相应的指令集。在这里的 isolate_snapshot_data 中并不会包含我们的业务代码，业务代码会存放在 kernel_blob.bin 文件中。可以使用 <code>strings</code> 命令查看，而且这两个文件的 MD5 值是一致的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MD5 (app.dill) = 3876e8c6f4b13a88cc3cfc3b9fd108c4</span><br><span class=\"line\">MD5 (flutter_assets/kernel_blob.bin) = 3876e8c6f4b13a88cc3cfc3b9fd108c4</span><br></pre></td></tr></table></figure>\n\n<p>关于 snapshot 生成相关可以去看 <strong>gen_snapshot</strong>。</p>\n</li>\n</ol>\n<h4 id=\"小结-1\"><a href=\"#小结-1\" class=\"headerlink\" title=\"小结\"></a>小结</h4><h5 id=\"debug\"><a href=\"#debug\" class=\"headerlink\" title=\"debug\"></a>debug</h5><p>debug 模式下，会执行一个命令：</p>\n   <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flutter build bundle</span><br></pre></td></tr></table></figure>\n\n<p>它会生成 assets、vm_snapshot_data、isolate_snapshot_data 和 kernel_bloc.bin。其中我们的业务代码存放在 kernel_bloc.bin 中，它是 app.dill 的拷贝。</p>\n<h5 id=\"release\"><a href=\"#release\" class=\"headerlink\" title=\"release\"></a>release</h5><p>release 模式下，会执行两个命令：</p>\n   <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flutter build aot</span><br></pre></td></tr></table></figure>\n\n<p>它会先生成 app.dill，而且这里分为两种模式：app-aot-assemble 和 app-aot-blobs。iOS 或者 添加了 <code>--build-shared-library</code> 会使用 app-aot-assemble，这种模式会生成 App.Framework 或 app.so。Android 默认使用 app-aot-blobs，这种模式会生成 isolate_snapshot_data、isolate_snapshot_instr、vm_snapshot_data 和 vm_snapshot_instr 四个文件。</p>\n   <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flutter build bundle --precompiled</span><br></pre></td></tr></table></figure>\n\n<p>这里只会生成 assets。</p>\n<h3 id=\"调试源码\"><a href=\"#调试源码\" class=\"headerlink\" title=\"调试源码\"></a>调试源码</h3><p>调试是阅读源码最好的帮手，调试 flutter_tools 的方式比较简单，我用的是 IntelliJ，Android Studio 应该也类似，先导入源码，源码位于 sdk&#x2F;packages&#x2F;flutter_tools；新建一个 Dart Command Line App，设置 Dart file 为 bin&#x2F;flutter_tools.dart，Program arguments 设置你要调试的命令，比如 <code>build aot</code>，Working directory 则用 <code>flutter create</code> 创建个项目即可；最后打好断点，debug 运行。</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/30/16ce208c64320c8d?w=1071&h=673&f=png&s=60679\" alt=\"debug_tools\"></p>\n<blockquote>\n<p>因为源码中有很多异步代码，用 await 修饰的，可以使用 <strong>Force run to Cursor</strong> 直接执行到下一行即可。</p>\n</blockquote>\n<h3 id=\"结尾\"><a href=\"#结尾\" class=\"headerlink\" title=\"结尾\"></a>结尾</h3><p>为了避免篇幅太长，文章尽量避免贴很多的代码，只是贴了关键函数，感兴趣的读者可以去阅读相关的源码。</p>\n<p>Android 在 release 模式下，使用 app-aot-blobs 模式，用的是 snapshot 文件，这里要实现动态下发代码，应该还是有可能的，需要进一步研究。下一步应该会研究下<strong>热加载</strong>的实现，这对于实现动态化应该很有帮助。</p>\n<p>最后，Flutter 是一个非常好玩的事物，Dart 也是一个非常优秀的语言，enjoy it。</p>\n<blockquote>\n<p>因为我用习惯了 Typora 写 Markdown 了，但又需要用到掘金的图床，所以写了个小脚本用来上传图片。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\"> file_path = sys.argv[<span class=\"number\">1</span>]</span><br><span class=\"line\"> upload_file = <span class=\"built_in\">open</span>(file_path,mode=<span class=\"string\">&#x27;rb&#x27;</span>)</span><br><span class=\"line\"> data = requests.post(<span class=\"string\">&#x27;https://cdn-ms.juejin.im/v1/upload?bucket=gold-user-assets&#x27;</span>,files=&#123;<span class=\"string\">&#x27;file&#x27;</span>: upload_file&#125;).json()</span><br><span class=\"line\"> <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;upload url: &#x27;</span> + data[<span class=\"string\">&#x27;d&#x27;</span>][<span class=\"string\">&#x27;url&#x27;</span>][<span class=\"string\">&#x27;https&#x27;</span>])</span><br></pre></td></tr></table></figure></blockquote>\n"},{"title":"无侵入引入Flutter模块","date":"2019-08-22T11:50:10.000Z","_content":"\n### 前言\n\nFlutter 作为当下比较流行的技术，不少公司已经开始在原生项目中接入它，但这也带来了一些问题：\n\n- Flutter SDK 问题，在 Android 中，Flutter 的代码和 Framework 会被编译成产物，而且 debug 和 release 生成的产物也是不太一样的。要编译就需要有 SDK，这意味着其他成员也需要下载 Flutter SDK，即使他不需要开发 Flutter 模块，还有 Flutter 版本的管理也是一个问题，不过这个已经有解决方案了。\n- Android 和 iOS 项目需要共用一套 Flutter 代码，这就需要用合适的方式去管理 Flutter 模块。\n\n> 文章基于 v1.5.4-hotfix.2 Flutter SDK 版本\n\n### Flutter的接入\n\n要优化它，就需要先了解它。以 Android 为例，要接入 Flutter 很方便，首先在 settings.gradle 中：\n\n```groovy\ndef flutterProjectRoot = rootProject.projectDir.parentFile.toPath()\n\ndef plugins = new Properties()\ndef pluginsFile = new File(flutterProjectRoot.toFile(), '.flutter-plugins')\nif (pluginsFile.exists()) {\n    pluginsFile.withReader('UTF-8') { reader -> plugins.load(reader) }\n}\n\nplugins.each { name, path ->\n    def pluginDirectory = flutterProjectRoot.resolve(path).resolve('android').toFile()\n    include \":$name\"\n    project(\":$name\").projectDir = pluginDirectory\n}\n```\n\n这里会将 Flutter 所依赖的第三方插件，include 到我们项目中，而相关的配置就记录在 .flutter-plugins 中。接着在 app 模块下的 build.gradle 中：\n\n```groovy\napply from: \"$flutterRoot/packages/flutter_tools/gradle/flutter.gradle\"\n```\n\nflutter.gradle 这个文件在 Flutter SDK 目录中，我们上面说到编译成产物的操作就是在这个脚本中定义的。所以我们注重看下这个文件：\n\n```groovy\napply plugin: FlutterPlugin\n```\n\nFlutterPlugin 是一个自定义的 Gradle Plugin，而且也是定义在这个文件中的。\n\n```groovy\nproject.android.buildTypes {                            \n    profile {                                           \n        initWith debug                                  \n        if (it.hasProperty('matchingFallbacks')) {      \n            matchingFallbacks = ['debug', 'release']    \n        }                                               \n    }                                                   \n    dynamicProfile {                                    \n        initWith debug                                  \n        if (it.hasProperty('matchingFallbacks')) {      \n            matchingFallbacks = ['debug', 'release']    \n        }                                               \n    }                                                   \n    dynamicRelease {                                    \n        initWith debug                                  \n        if (it.hasProperty('matchingFallbacks')) {      \n            matchingFallbacks = ['debug', 'release']    \n        }                                               \n    }                                                   \n}                                                       \n```\n\n除了默认的 debug 和 release 之外，Flutter 会定义 profile、dynamicProfile、dynamicRelease 这三种 buildType，这里需要注意下，如果项目已经定义了同名的 buildType 的话。`matchingFallbacks` 表示如果引用的模块中不存在相同的 buildType，则使用这些替补选项。\n\n```groovy\nif (project.hasProperty('localEngineOut')) {\n //...\n}\n```\n\n`localEngineOut` 可以用于指定特定的 engine 目录，默认用 SDK 中的，如果自己重新编译了 engine，可以用这个选项来指向。具体可见：[Flutter-Engine-编译指北]([https://fucknmb.com/2019/02/26/Flutter-Engine-%E7%BC%96%E8%AF%91%E6%8C%87%E5%8C%97/](https://fucknmb.com/2019/02/26/Flutter-Engine-编译指北/))\n\n```groovy\nPath baseEnginePath = Paths.get(flutterRoot.absolutePath, \"bin\", \"cache\", \"artifacts\", \"engine\")                              \nString targetArch = 'arm'                                                                                                     \nif (project.hasProperty('target-platform') &&                                                                                 \n    project.property('target-platform') == 'android-arm64') {                                                                 \n  targetArch = 'arm64'                                                                                                        \n}                                                                                                                             \ndebugFlutterJar = baseEnginePath.resolve(\"android-${targetArch}\").resolve(\"flutter.jar\").toFile()                             \nprofileFlutterJar = baseEnginePath.resolve(\"android-${targetArch}-profile\").resolve(\"flutter.jar\").toFile()                   \nreleaseFlutterJar = baseEnginePath.resolve(\"android-${targetArch}-release\").resolve(\"flutter.jar\").toFile()                   \ndynamicProfileFlutterJar = baseEnginePath.resolve(\"android-${targetArch}-dynamic-profile\").resolve(\"flutter.jar\").toFile()    \ndynamicReleaseFlutterJar = baseEnginePath.resolve(\"android-${targetArch}-dynamic-release\").resolve(\"flutter.jar\").toFile()    \nif (!debugFlutterJar.isFile()) {                                                                                              \n    project.exec {                                                                                                            \n        executable flutterExecutable.absolutePath                                                                             \n        args \"--suppress-analytics\"                                                                                           \n        args \"precache\"                                                                                                       \n    }                                                                                                                         \n    if (!debugFlutterJar.isFile()) {                                                                                          \n        throw new GradleException(\"Unable to find flutter.jar in SDK: ${debugFlutterJar}\")                                    \n    }                                                                                                                         \n}                                                                                                                             \n                                                                                                                              \n// Add x86/x86_64 native library. Debug mode only, for now.                                                                   \nflutterX86Jar = project.file(\"${project.buildDir}/${AndroidProject.FD_INTERMEDIATES}/flutter/flutter-x86.jar\")                \nTask flutterX86JarTask = project.tasks.create(\"${flutterBuildPrefix}X86Jar\", Jar) {                                           \n    destinationDir flutterX86Jar.parentFile                                                                                   \n    archiveName flutterX86Jar.name                                                                                            \n    from(\"${flutterRoot}/bin/cache/artifacts/engine/android-x86/libflutter.so\") {                                             \n        into \"lib/x86\"                                                                                                        \n    }                                                                                                                         \n    from(\"${flutterRoot}/bin/cache/artifacts/engine/android-x64/libflutter.so\") {                                             \n        into \"lib/x86_64\"                                                                                                     \n    }                                                                                                                         \n}                                                                                                                             \n// Add flutter.jar dependencies to all <buildType>Api configurations, including custom ones                                   \n// added after applying the Flutter plugin.                                                                                   \nproject.android.buildTypes.each { addFlutterJarApiDependency(project, it, flutterX86JarTask) }                                \nproject.android.buildTypes.whenObjectAdded { addFlutterJarApiDependency(project, it, flutterX86JarTask) }                     \n```\n\n这里的代码看起来很长，其实做的事情就是一件，添加 flutter.jar 依赖，不同的 buildType 添加不同的版本，debug 模式额外增加 x86/x86_64 架构的版本。\n\n```groovy\nproject.extensions.create(\"flutter\", FlutterExtension)   \nproject.afterEvaluate this.&addFlutterTask               \n```\n\n首先添加一个 FlutterExtension 配置块，可选的配置有 source 和 target，用于指定编写的 Flutter 代码目录和执行 Flutter 代码的入口 dart 文件，默认为 `lib/main.dart`。\n\n在 `afterEvaluate` 钩子上添加一个执行方法：addFlutterTask。\n\n`verbose`、`filesystem-roots`、`filesystem-scheme` 这些一些额外可选的参数，这里我们先不关心。\n\n```groovy\nif (project.android.hasProperty(\"applicationVariants\")) {   \n    project.android.applicationVariants.all addFlutterDeps  \n} else {                                                    \n    project.android.libraryVariants.all addFlutterDeps      \n}                                                           \n```\n\n存在 `applicationVariants` 属性表示当前接入 Flutter 的模块是使用 `com.android.application`，`applicationVariants` 和 `libraryVariants` 都是表示当前模块的构建变体，`addFlutterDeps` 是一个闭包，这里的意思是，遍历所有变体，调用 addFlutterDeps。\n\n```groovy\ndef addFlutterDeps = { variant ->                                                                                                        \n    String flutterBuildMode = buildModeFor(variant.buildType)                                                                            \n    if (flutterBuildMode == 'debug' && project.tasks.findByName('${flutterBuildPrefix}X86Jar')) {                                        \n        Task task = project.tasks.findByName(\"compile${variant.name.capitalize()}JavaWithJavac\")                                         \n        if (task) {                                                                                                                      \n            task.dependsOn project.flutterBuildX86Jar                                                                                    \n        }                                                                                                                                \n        task = project.tasks.findByName(\"compile${variant.name.capitalize()}Kotlin\")                                                     \n        if (task) {                                                                                                                      \n            task.dependsOn project.flutterBuildX86Jar                                                                                    \n        }                                                                                                                                \n    }                                                                                                                                    \n                                                                                                                                         \n    FlutterTask flutterTask = project.tasks.create(name: \"${flutterBuildPrefix}${variant.name.capitalize()}\", type: FlutterTask) {       \n        flutterRoot this.flutterRoot                                                                                                     \n        flutterExecutable this.flutterExecutable                                                                                         \n        buildMode flutterBuildMode                                                                                                       \n        localEngine this.localEngine                                                                                                     \n        localEngineSrcPath this.localEngineSrcPath                                                                                       \n        targetPath target                                                                                                                \n        verbose verboseValue                                                                                                             \n        fileSystemRoots fileSystemRootsValue                                                                                             \n        fileSystemScheme fileSystemSchemeValue                                                                                           \n        trackWidgetCreation trackWidgetCreationValue                                                                                     \n        compilationTraceFilePath compilationTraceFilePathValue                                                                           \n        createPatch createPatchValue                                                                                                     \n        buildNumber buildNumberValue                                                                                                     \n        baselineDir baselineDirValue                                                                                                     \n        buildSharedLibrary buildSharedLibraryValue                                                                                       \n        targetPlatform targetPlatformValue                                                                                               \n        sourceDir project.file(project.flutter.source)                                                                                   \n        intermediateDir project.file(\"${project.buildDir}/${AndroidProject.FD_INTERMEDIATES}/flutter/${variant.name}\")                   \n        extraFrontEndOptions extraFrontEndOptionsValue                                                                                   \n        extraGenSnapshotOptions extraGenSnapshotOptionsValue                                                                             \n    }                                                                                                                                    \n                                                                                                                                         \n    // We know that the flutter app is a subproject in another Android app when these tasks exist.                                       \n    Task packageAssets = project.tasks.findByPath(\":flutter:package${variant.name.capitalize()}Assets\")                                  \n    Task cleanPackageAssets = project.tasks.findByPath(\":flutter:cleanPackage${variant.name.capitalize()}Assets\")                        \n                                                                                                                                         \n    Task copyFlutterAssetsTask = project.tasks.create(name: \"copyFlutterAssets${variant.name.capitalize()}\", type: Copy) {               \n        dependsOn flutterTask                                                                                                            \n        if (packageAssets && cleanPackageAssets) {                                                                                       \n            dependsOn packageAssets                                                                                                      \n            dependsOn cleanPackageAssets                                                                                                 \n            into packageAssets.outputDir                                                                                                 \n        } else {                                                                                                                         \n            dependsOn variant.mergeAssets                                                                                                \n            dependsOn \"clean${variant.mergeAssets.name.capitalize()}\"                                                                    \n            into variant.mergeAssets.outputDir                                                                                           \n        }                                                                                                                                \n        with flutterTask.assets                                                                                                          \n    }                                                                                                                                    \n                                                                                                                                         \n    if (packageAssets) {                                                                                                                 \n        String mainModuleName = \"app\"                                                                                                    \n        try {                                                                                                                            \n            String tmpModuleName = project.rootProject.ext.mainModuleName                                                                \n            if (tmpModuleName != null && !tmpModuleName.empty) {                                                                         \n                mainModuleName = tmpModuleName                                                                                           \n            }                                                                                                                            \n        } catch (Exception e) {                                                                                                          \n        }                                                                                                                                \n        // Only include configurations that exist in parent project.                                                                     \n        Task mergeAssets = project.tasks.findByPath(\":${mainModuleName}:merge${variant.name.capitalize()}Assets\")                        \n        if (mergeAssets) {                                                                                                               \n            mergeAssets.dependsOn(copyFlutterAssetsTask)                                                                                 \n        }                                                                                                                                \n    } else {                                                                                                                             \n        variant.outputs[0].processResources.dependsOn(copyFlutterAssetsTask)                                                             \n    }                                                                                                                                    \n}                                                                                                                                        \n```\n\n`variant` 就是上面遍历的构建变体。首先当构建类型为 debug 时，会在 compileJavaWithJavac 和 compileKotlin 这两个 task 之前先执行 flutterBuildX86Jar task。它的作用是引入 x86 架构的 jar 和 so 文件。\n\n> 这里有个 bug\n>\n> ```groovy\n> project.tasks.findByName('${flutterBuildPrefix}X86Jar')\n> ```\n>\n> 判断是否存在 task 时，拼接字符串用的是单引号，正确应该用双引号，最新版本已经改正了。\n\n接下来，会创建两个 task，flutterBuild 和 copyFlutterAssets，flutterBuild 用于编译产物，copyFlutterAssets 则是将产物拷贝到 assets 目录。因为使用 `com.android.application` 和 `com.android.library` 拥有的 task 是不一样的，所有这里用是否存在 packageAssets 和 cleanPackageAssets 这两个 task 去判断引用不同插件的模块，同时引入 library 插件的模块，flutterBuild 需要依赖于这两个 task。\n\nflutterBuild task 实际上 FlutterTask 类型，同时 FlutterTask 继承于 BaseFlutterTask。\n\n```groovy\nabstract class BaseFlutterTask extends DefaultTask { \n@OutputFiles                                                                \nFileCollection getDependenciesFiles() {                                     \n    FileCollection depfiles = project.files()                               \n                                                                            \n    // Include the kernel compiler depfile, since kernel compile is the     \n    // first stage of AOT build in this mode, and it includes all the Dart  \n    // sources.                                                             \n    depfiles += project.files(\"${intermediateDir}/kernel_compile.d\")        \n                                                                            \n    // Include Core JIT kernel compiler depfile, since kernel compile is    \n    // the first stage of JIT builds in this mode, and it includes all the  \n    // Dart sources.                                                        \n    depfiles += project.files(\"${intermediateDir}/snapshot_blob.bin.d\")     \n    return depfiles                                                         \n}                                                                           \n}\n```\n\n`@OutputFiles` 注解用于标示 task 输出的目录，这个可以用来做增量编译和任务缓存等等。\n\n```groovy\nclass FlutterTask extends BaseFlutterTask {\n  @TaskAction      \nvoid build() {   \n    buildBundle()\n}                \n}\n\nvoid buildBundle() {                                                                         \n    if (!sourceDir.isDirectory()) {                                                          \n        throw new GradleException(\"Invalid Flutter source directory: ${sourceDir}\")          \n    }                                                                                        \n                                                                                             \n    intermediateDir.mkdirs()                                                                 \n                                                                                             \n    if (buildMode == \"profile\" || buildMode == \"release\") {                                  \n        project.exec {                                                                       \n            executable flutterExecutable.absolutePath                                        \n            workingDir sourceDir                                                             \n            if (localEngine != null) {                                                       \n                args \"--local-engine\", localEngine                                           \n                args \"--local-engine-src-path\", localEngineSrcPath                           \n            }                                                                                \n            args \"build\", \"aot\"                                                              \n            args \"--suppress-analytics\"                                                      \n            args \"--quiet\"                                                                   \n            args \"--target\", targetPath                                                      \n            args \"--target-platform\", \"android-arm\"                                          \n            args \"--output-dir\", \"${intermediateDir}\"                                        \n            if (trackWidgetCreation) {                                                       \n                args \"--track-widget-creation\"                                               \n            }                                                                                \n            if (extraFrontEndOptions != null) {                                              \n                args \"--extra-front-end-options\", \"${extraFrontEndOptions}\"                  \n            }                                                                                \n            if (extraGenSnapshotOptions != null) {                                           \n                args \"--extra-gen-snapshot-options\", \"${extraGenSnapshotOptions}\"            \n            }                                                                                \n            if (buildSharedLibrary) {                                                        \n                args \"--build-shared-library\"                                                \n            }                                                                                \n            if (targetPlatform != null) {                                                    \n                args \"--target-platform\", \"${targetPlatform}\"                                \n            }                                                                                \n            args \"--${buildMode}\"                                                            \n        }                                                                                    \n    }                                                                                        \n                                                                                             \n    project.exec {                                                                           \n        executable flutterExecutable.absolutePath                                            \n        workingDir sourceDir                                                                 \n        if (localEngine != null) {                                                           \n            args \"--local-engine\", localEngine                                               \n            args \"--local-engine-src-path\", localEngineSrcPath                               \n        }                                                                                    \n        args \"build\", \"bundle\"                                                               \n        args \"--suppress-analytics\"                                                          \n        args \"--target\", targetPath                                                          \n        if (verbose) {                                                                       \n            args \"--verbose\"                                                                 \n        }                                                                                    \n        if (fileSystemRoots != null) {                                                       \n            for (root in fileSystemRoots) {                                                  \n                args \"--filesystem-root\", root                                               \n            }                                                                                \n        }                                                                                    \n        if (fileSystemScheme != null) {                                                      \n            args \"--filesystem-scheme\", fileSystemScheme                                     \n        }                                                                                    \n        if (trackWidgetCreation) {                                                           \n            args \"--track-widget-creation\"                                                   \n        }                                                                                    \n        if (compilationTraceFilePath != null) {                                              \n            args \"--compilation-trace-file\", compilationTraceFilePath                        \n        }                                                                                    \n        if (createPatch) {                                                                   \n            args \"--patch\"                                                                   \n            args \"--build-number\", project.android.defaultConfig.versionCode                 \n            if (buildNumber != null) {                                                       \n                assert buildNumber == project.android.defaultConfig.versionCode              \n            }                                                                                \n        }                                                                                    \n        if (baselineDir != null) {                                                           \n            args \"--baseline-dir\", baselineDir                                               \n        }                                                                                    \n        if (extraFrontEndOptions != null) {                                                  \n            args \"--extra-front-end-options\", \"${extraFrontEndOptions}\"                      \n        }                                                                                    \n        if (extraGenSnapshotOptions != null) {                                               \n            args \"--extra-gen-snapshot-options\", \"${extraGenSnapshotOptions}\"                \n        }                                                                                    \n        if (targetPlatform != null) {                                                        \n            args \"--target-platform\", \"${targetPlatform}\"                                    \n        }                                                                                    \n        if (buildMode == \"release\" || buildMode == \"profile\") {                              \n            args \"--precompiled\"                                                             \n        } else {                                                                             \n            args \"--depfile\", \"${intermediateDir}/snapshot_blob.bin.d\"                       \n        }                                                                                    \n        args \"--asset-dir\", \"${intermediateDir}/flutter_assets\"                              \n        if (buildMode == \"debug\") {                                                          \n            args \"--debug\"                                                                   \n        }                                                                                    \n        if (buildMode == \"profile\" || buildMode == \"dynamicProfile\") {                       \n            args \"--profile\"                                                                 \n        }                                                                                    \n        if (buildMode == \"release\" || buildMode == \"dynamicRelease\") {                       \n            args \"--release\"                                                                 \n        }                                                                                    \n        if (buildMode == \"dynamicProfile\" || buildMode == \"dynamicRelease\") {                \n            args \"--dynamic\"                                                                 \n        }                                                                                    \n    }                                                                                        \n}                                                                                            \n```\n\n用 `@TaskAction` 表示的方法就是 task 执行时候的方法。这里代码也很长，其实就是执行了两个命令。第一，如果是 release 或 profile 模式下，执行 `flutter build aot`。然后执行 `flutter build bundle`。\n\n### 实现\n\n分析完 Flutter 接入的流程后，再回头去看我们一开始面临的问题，现在我们来解决它。\n\n#### 生成 aar\n\n为了其他成员不需要依赖于 Flutter 环境，首先我们需要将 Flutter 代码提前生成为 aar，之所以不是 jar，是因为有图片资源等。生成产物的命令可以参照 FlutterBuildTask，要注意的是，debug 和 release 模式下生成的产物是不一致的。\n\ndebug 模式下的构建产物：\n\n![debug](https://user-gold-cdn.xitu.io/2019/8/22/16cb84ca450f272b?w=460&h=380&f=png&s=39969)\n\nrelease 模式下的构建产物：\n\n![release](https://user-gold-cdn.xitu.io/2019/8/22/16cb84c97b7471b6?w=474&h=210&f=png&s=24868)\n\nFlutter 产物生成不麻烦，照搬命令即可，这主要解决的问题是，Flutter 模块中依赖的第三方插件，上面我们说到，Flutter 模块依赖的第三方插件会生成到配置文件 .flutter-plugins 中。然后在 settings.gradle 中，将这些项目的源码加入我们项目的依赖中去。所有，我们要提前构建的话，就需要将这些代码也打进我们的 aar 中。可惜，官方不支持这种操作，这时候需要第三方库来支持了，[fataar-gradle-plugin](https://github.com/Mobbeel/fataar-gradle-plugin)，不过这个库有个小坑，Android Gradle 插件 3.1.x 的时候，没有将 jni 目录的 so 输出到 aar 中，解决方式，添加：\n\n```groovy\nproject.copy {\n                from \"${project.projectDir.path}/build/intermediates/library_and_local_jars_jni/${variantName}\"\n                include \"**\"\n                into \"${temporaryDir.path}/${variantName}/jni\"\n            }\n```\n\n经过这两个步骤后，我们就能提前将 Flutter 产物和第三方插件的 aar 都打包一个 aar，上传 maven 上等等。\n\n#### 源码管理\n\n因为 Android 项目和 iOS 项目都需要用到同一套 Flutter 源码，所以这里我们可以使用 git 提供的 submodule 的形式接入源码。关于 Flutter SDK 版本管理，可以参照之前的文章：[flutterw](https://juejin.im/post/5d0c39326fb9a07ef63fe4b0)\n\n### 结尾\n\n因为篇幅原因，所以不能将实现细节完整写出来，只能将一些关键点整理出来，希望能对大家有点启发。有其他疑问，欢迎留言讨论。","source":"_posts/无侵入引入Flutter模块.md","raw":"---\ntitle: 无侵入引入Flutter模块\ndate: 2019-08-22 19:50:10\ncategories: Flutter\ntags:\n---\n\n### 前言\n\nFlutter 作为当下比较流行的技术，不少公司已经开始在原生项目中接入它，但这也带来了一些问题：\n\n- Flutter SDK 问题，在 Android 中，Flutter 的代码和 Framework 会被编译成产物，而且 debug 和 release 生成的产物也是不太一样的。要编译就需要有 SDK，这意味着其他成员也需要下载 Flutter SDK，即使他不需要开发 Flutter 模块，还有 Flutter 版本的管理也是一个问题，不过这个已经有解决方案了。\n- Android 和 iOS 项目需要共用一套 Flutter 代码，这就需要用合适的方式去管理 Flutter 模块。\n\n> 文章基于 v1.5.4-hotfix.2 Flutter SDK 版本\n\n### Flutter的接入\n\n要优化它，就需要先了解它。以 Android 为例，要接入 Flutter 很方便，首先在 settings.gradle 中：\n\n```groovy\ndef flutterProjectRoot = rootProject.projectDir.parentFile.toPath()\n\ndef plugins = new Properties()\ndef pluginsFile = new File(flutterProjectRoot.toFile(), '.flutter-plugins')\nif (pluginsFile.exists()) {\n    pluginsFile.withReader('UTF-8') { reader -> plugins.load(reader) }\n}\n\nplugins.each { name, path ->\n    def pluginDirectory = flutterProjectRoot.resolve(path).resolve('android').toFile()\n    include \":$name\"\n    project(\":$name\").projectDir = pluginDirectory\n}\n```\n\n这里会将 Flutter 所依赖的第三方插件，include 到我们项目中，而相关的配置就记录在 .flutter-plugins 中。接着在 app 模块下的 build.gradle 中：\n\n```groovy\napply from: \"$flutterRoot/packages/flutter_tools/gradle/flutter.gradle\"\n```\n\nflutter.gradle 这个文件在 Flutter SDK 目录中，我们上面说到编译成产物的操作就是在这个脚本中定义的。所以我们注重看下这个文件：\n\n```groovy\napply plugin: FlutterPlugin\n```\n\nFlutterPlugin 是一个自定义的 Gradle Plugin，而且也是定义在这个文件中的。\n\n```groovy\nproject.android.buildTypes {                            \n    profile {                                           \n        initWith debug                                  \n        if (it.hasProperty('matchingFallbacks')) {      \n            matchingFallbacks = ['debug', 'release']    \n        }                                               \n    }                                                   \n    dynamicProfile {                                    \n        initWith debug                                  \n        if (it.hasProperty('matchingFallbacks')) {      \n            matchingFallbacks = ['debug', 'release']    \n        }                                               \n    }                                                   \n    dynamicRelease {                                    \n        initWith debug                                  \n        if (it.hasProperty('matchingFallbacks')) {      \n            matchingFallbacks = ['debug', 'release']    \n        }                                               \n    }                                                   \n}                                                       \n```\n\n除了默认的 debug 和 release 之外，Flutter 会定义 profile、dynamicProfile、dynamicRelease 这三种 buildType，这里需要注意下，如果项目已经定义了同名的 buildType 的话。`matchingFallbacks` 表示如果引用的模块中不存在相同的 buildType，则使用这些替补选项。\n\n```groovy\nif (project.hasProperty('localEngineOut')) {\n //...\n}\n```\n\n`localEngineOut` 可以用于指定特定的 engine 目录，默认用 SDK 中的，如果自己重新编译了 engine，可以用这个选项来指向。具体可见：[Flutter-Engine-编译指北]([https://fucknmb.com/2019/02/26/Flutter-Engine-%E7%BC%96%E8%AF%91%E6%8C%87%E5%8C%97/](https://fucknmb.com/2019/02/26/Flutter-Engine-编译指北/))\n\n```groovy\nPath baseEnginePath = Paths.get(flutterRoot.absolutePath, \"bin\", \"cache\", \"artifacts\", \"engine\")                              \nString targetArch = 'arm'                                                                                                     \nif (project.hasProperty('target-platform') &&                                                                                 \n    project.property('target-platform') == 'android-arm64') {                                                                 \n  targetArch = 'arm64'                                                                                                        \n}                                                                                                                             \ndebugFlutterJar = baseEnginePath.resolve(\"android-${targetArch}\").resolve(\"flutter.jar\").toFile()                             \nprofileFlutterJar = baseEnginePath.resolve(\"android-${targetArch}-profile\").resolve(\"flutter.jar\").toFile()                   \nreleaseFlutterJar = baseEnginePath.resolve(\"android-${targetArch}-release\").resolve(\"flutter.jar\").toFile()                   \ndynamicProfileFlutterJar = baseEnginePath.resolve(\"android-${targetArch}-dynamic-profile\").resolve(\"flutter.jar\").toFile()    \ndynamicReleaseFlutterJar = baseEnginePath.resolve(\"android-${targetArch}-dynamic-release\").resolve(\"flutter.jar\").toFile()    \nif (!debugFlutterJar.isFile()) {                                                                                              \n    project.exec {                                                                                                            \n        executable flutterExecutable.absolutePath                                                                             \n        args \"--suppress-analytics\"                                                                                           \n        args \"precache\"                                                                                                       \n    }                                                                                                                         \n    if (!debugFlutterJar.isFile()) {                                                                                          \n        throw new GradleException(\"Unable to find flutter.jar in SDK: ${debugFlutterJar}\")                                    \n    }                                                                                                                         \n}                                                                                                                             \n                                                                                                                              \n// Add x86/x86_64 native library. Debug mode only, for now.                                                                   \nflutterX86Jar = project.file(\"${project.buildDir}/${AndroidProject.FD_INTERMEDIATES}/flutter/flutter-x86.jar\")                \nTask flutterX86JarTask = project.tasks.create(\"${flutterBuildPrefix}X86Jar\", Jar) {                                           \n    destinationDir flutterX86Jar.parentFile                                                                                   \n    archiveName flutterX86Jar.name                                                                                            \n    from(\"${flutterRoot}/bin/cache/artifacts/engine/android-x86/libflutter.so\") {                                             \n        into \"lib/x86\"                                                                                                        \n    }                                                                                                                         \n    from(\"${flutterRoot}/bin/cache/artifacts/engine/android-x64/libflutter.so\") {                                             \n        into \"lib/x86_64\"                                                                                                     \n    }                                                                                                                         \n}                                                                                                                             \n// Add flutter.jar dependencies to all <buildType>Api configurations, including custom ones                                   \n// added after applying the Flutter plugin.                                                                                   \nproject.android.buildTypes.each { addFlutterJarApiDependency(project, it, flutterX86JarTask) }                                \nproject.android.buildTypes.whenObjectAdded { addFlutterJarApiDependency(project, it, flutterX86JarTask) }                     \n```\n\n这里的代码看起来很长，其实做的事情就是一件，添加 flutter.jar 依赖，不同的 buildType 添加不同的版本，debug 模式额外增加 x86/x86_64 架构的版本。\n\n```groovy\nproject.extensions.create(\"flutter\", FlutterExtension)   \nproject.afterEvaluate this.&addFlutterTask               \n```\n\n首先添加一个 FlutterExtension 配置块，可选的配置有 source 和 target，用于指定编写的 Flutter 代码目录和执行 Flutter 代码的入口 dart 文件，默认为 `lib/main.dart`。\n\n在 `afterEvaluate` 钩子上添加一个执行方法：addFlutterTask。\n\n`verbose`、`filesystem-roots`、`filesystem-scheme` 这些一些额外可选的参数，这里我们先不关心。\n\n```groovy\nif (project.android.hasProperty(\"applicationVariants\")) {   \n    project.android.applicationVariants.all addFlutterDeps  \n} else {                                                    \n    project.android.libraryVariants.all addFlutterDeps      \n}                                                           \n```\n\n存在 `applicationVariants` 属性表示当前接入 Flutter 的模块是使用 `com.android.application`，`applicationVariants` 和 `libraryVariants` 都是表示当前模块的构建变体，`addFlutterDeps` 是一个闭包，这里的意思是，遍历所有变体，调用 addFlutterDeps。\n\n```groovy\ndef addFlutterDeps = { variant ->                                                                                                        \n    String flutterBuildMode = buildModeFor(variant.buildType)                                                                            \n    if (flutterBuildMode == 'debug' && project.tasks.findByName('${flutterBuildPrefix}X86Jar')) {                                        \n        Task task = project.tasks.findByName(\"compile${variant.name.capitalize()}JavaWithJavac\")                                         \n        if (task) {                                                                                                                      \n            task.dependsOn project.flutterBuildX86Jar                                                                                    \n        }                                                                                                                                \n        task = project.tasks.findByName(\"compile${variant.name.capitalize()}Kotlin\")                                                     \n        if (task) {                                                                                                                      \n            task.dependsOn project.flutterBuildX86Jar                                                                                    \n        }                                                                                                                                \n    }                                                                                                                                    \n                                                                                                                                         \n    FlutterTask flutterTask = project.tasks.create(name: \"${flutterBuildPrefix}${variant.name.capitalize()}\", type: FlutterTask) {       \n        flutterRoot this.flutterRoot                                                                                                     \n        flutterExecutable this.flutterExecutable                                                                                         \n        buildMode flutterBuildMode                                                                                                       \n        localEngine this.localEngine                                                                                                     \n        localEngineSrcPath this.localEngineSrcPath                                                                                       \n        targetPath target                                                                                                                \n        verbose verboseValue                                                                                                             \n        fileSystemRoots fileSystemRootsValue                                                                                             \n        fileSystemScheme fileSystemSchemeValue                                                                                           \n        trackWidgetCreation trackWidgetCreationValue                                                                                     \n        compilationTraceFilePath compilationTraceFilePathValue                                                                           \n        createPatch createPatchValue                                                                                                     \n        buildNumber buildNumberValue                                                                                                     \n        baselineDir baselineDirValue                                                                                                     \n        buildSharedLibrary buildSharedLibraryValue                                                                                       \n        targetPlatform targetPlatformValue                                                                                               \n        sourceDir project.file(project.flutter.source)                                                                                   \n        intermediateDir project.file(\"${project.buildDir}/${AndroidProject.FD_INTERMEDIATES}/flutter/${variant.name}\")                   \n        extraFrontEndOptions extraFrontEndOptionsValue                                                                                   \n        extraGenSnapshotOptions extraGenSnapshotOptionsValue                                                                             \n    }                                                                                                                                    \n                                                                                                                                         \n    // We know that the flutter app is a subproject in another Android app when these tasks exist.                                       \n    Task packageAssets = project.tasks.findByPath(\":flutter:package${variant.name.capitalize()}Assets\")                                  \n    Task cleanPackageAssets = project.tasks.findByPath(\":flutter:cleanPackage${variant.name.capitalize()}Assets\")                        \n                                                                                                                                         \n    Task copyFlutterAssetsTask = project.tasks.create(name: \"copyFlutterAssets${variant.name.capitalize()}\", type: Copy) {               \n        dependsOn flutterTask                                                                                                            \n        if (packageAssets && cleanPackageAssets) {                                                                                       \n            dependsOn packageAssets                                                                                                      \n            dependsOn cleanPackageAssets                                                                                                 \n            into packageAssets.outputDir                                                                                                 \n        } else {                                                                                                                         \n            dependsOn variant.mergeAssets                                                                                                \n            dependsOn \"clean${variant.mergeAssets.name.capitalize()}\"                                                                    \n            into variant.mergeAssets.outputDir                                                                                           \n        }                                                                                                                                \n        with flutterTask.assets                                                                                                          \n    }                                                                                                                                    \n                                                                                                                                         \n    if (packageAssets) {                                                                                                                 \n        String mainModuleName = \"app\"                                                                                                    \n        try {                                                                                                                            \n            String tmpModuleName = project.rootProject.ext.mainModuleName                                                                \n            if (tmpModuleName != null && !tmpModuleName.empty) {                                                                         \n                mainModuleName = tmpModuleName                                                                                           \n            }                                                                                                                            \n        } catch (Exception e) {                                                                                                          \n        }                                                                                                                                \n        // Only include configurations that exist in parent project.                                                                     \n        Task mergeAssets = project.tasks.findByPath(\":${mainModuleName}:merge${variant.name.capitalize()}Assets\")                        \n        if (mergeAssets) {                                                                                                               \n            mergeAssets.dependsOn(copyFlutterAssetsTask)                                                                                 \n        }                                                                                                                                \n    } else {                                                                                                                             \n        variant.outputs[0].processResources.dependsOn(copyFlutterAssetsTask)                                                             \n    }                                                                                                                                    \n}                                                                                                                                        \n```\n\n`variant` 就是上面遍历的构建变体。首先当构建类型为 debug 时，会在 compileJavaWithJavac 和 compileKotlin 这两个 task 之前先执行 flutterBuildX86Jar task。它的作用是引入 x86 架构的 jar 和 so 文件。\n\n> 这里有个 bug\n>\n> ```groovy\n> project.tasks.findByName('${flutterBuildPrefix}X86Jar')\n> ```\n>\n> 判断是否存在 task 时，拼接字符串用的是单引号，正确应该用双引号，最新版本已经改正了。\n\n接下来，会创建两个 task，flutterBuild 和 copyFlutterAssets，flutterBuild 用于编译产物，copyFlutterAssets 则是将产物拷贝到 assets 目录。因为使用 `com.android.application` 和 `com.android.library` 拥有的 task 是不一样的，所有这里用是否存在 packageAssets 和 cleanPackageAssets 这两个 task 去判断引用不同插件的模块，同时引入 library 插件的模块，flutterBuild 需要依赖于这两个 task。\n\nflutterBuild task 实际上 FlutterTask 类型，同时 FlutterTask 继承于 BaseFlutterTask。\n\n```groovy\nabstract class BaseFlutterTask extends DefaultTask { \n@OutputFiles                                                                \nFileCollection getDependenciesFiles() {                                     \n    FileCollection depfiles = project.files()                               \n                                                                            \n    // Include the kernel compiler depfile, since kernel compile is the     \n    // first stage of AOT build in this mode, and it includes all the Dart  \n    // sources.                                                             \n    depfiles += project.files(\"${intermediateDir}/kernel_compile.d\")        \n                                                                            \n    // Include Core JIT kernel compiler depfile, since kernel compile is    \n    // the first stage of JIT builds in this mode, and it includes all the  \n    // Dart sources.                                                        \n    depfiles += project.files(\"${intermediateDir}/snapshot_blob.bin.d\")     \n    return depfiles                                                         \n}                                                                           \n}\n```\n\n`@OutputFiles` 注解用于标示 task 输出的目录，这个可以用来做增量编译和任务缓存等等。\n\n```groovy\nclass FlutterTask extends BaseFlutterTask {\n  @TaskAction      \nvoid build() {   \n    buildBundle()\n}                \n}\n\nvoid buildBundle() {                                                                         \n    if (!sourceDir.isDirectory()) {                                                          \n        throw new GradleException(\"Invalid Flutter source directory: ${sourceDir}\")          \n    }                                                                                        \n                                                                                             \n    intermediateDir.mkdirs()                                                                 \n                                                                                             \n    if (buildMode == \"profile\" || buildMode == \"release\") {                                  \n        project.exec {                                                                       \n            executable flutterExecutable.absolutePath                                        \n            workingDir sourceDir                                                             \n            if (localEngine != null) {                                                       \n                args \"--local-engine\", localEngine                                           \n                args \"--local-engine-src-path\", localEngineSrcPath                           \n            }                                                                                \n            args \"build\", \"aot\"                                                              \n            args \"--suppress-analytics\"                                                      \n            args \"--quiet\"                                                                   \n            args \"--target\", targetPath                                                      \n            args \"--target-platform\", \"android-arm\"                                          \n            args \"--output-dir\", \"${intermediateDir}\"                                        \n            if (trackWidgetCreation) {                                                       \n                args \"--track-widget-creation\"                                               \n            }                                                                                \n            if (extraFrontEndOptions != null) {                                              \n                args \"--extra-front-end-options\", \"${extraFrontEndOptions}\"                  \n            }                                                                                \n            if (extraGenSnapshotOptions != null) {                                           \n                args \"--extra-gen-snapshot-options\", \"${extraGenSnapshotOptions}\"            \n            }                                                                                \n            if (buildSharedLibrary) {                                                        \n                args \"--build-shared-library\"                                                \n            }                                                                                \n            if (targetPlatform != null) {                                                    \n                args \"--target-platform\", \"${targetPlatform}\"                                \n            }                                                                                \n            args \"--${buildMode}\"                                                            \n        }                                                                                    \n    }                                                                                        \n                                                                                             \n    project.exec {                                                                           \n        executable flutterExecutable.absolutePath                                            \n        workingDir sourceDir                                                                 \n        if (localEngine != null) {                                                           \n            args \"--local-engine\", localEngine                                               \n            args \"--local-engine-src-path\", localEngineSrcPath                               \n        }                                                                                    \n        args \"build\", \"bundle\"                                                               \n        args \"--suppress-analytics\"                                                          \n        args \"--target\", targetPath                                                          \n        if (verbose) {                                                                       \n            args \"--verbose\"                                                                 \n        }                                                                                    \n        if (fileSystemRoots != null) {                                                       \n            for (root in fileSystemRoots) {                                                  \n                args \"--filesystem-root\", root                                               \n            }                                                                                \n        }                                                                                    \n        if (fileSystemScheme != null) {                                                      \n            args \"--filesystem-scheme\", fileSystemScheme                                     \n        }                                                                                    \n        if (trackWidgetCreation) {                                                           \n            args \"--track-widget-creation\"                                                   \n        }                                                                                    \n        if (compilationTraceFilePath != null) {                                              \n            args \"--compilation-trace-file\", compilationTraceFilePath                        \n        }                                                                                    \n        if (createPatch) {                                                                   \n            args \"--patch\"                                                                   \n            args \"--build-number\", project.android.defaultConfig.versionCode                 \n            if (buildNumber != null) {                                                       \n                assert buildNumber == project.android.defaultConfig.versionCode              \n            }                                                                                \n        }                                                                                    \n        if (baselineDir != null) {                                                           \n            args \"--baseline-dir\", baselineDir                                               \n        }                                                                                    \n        if (extraFrontEndOptions != null) {                                                  \n            args \"--extra-front-end-options\", \"${extraFrontEndOptions}\"                      \n        }                                                                                    \n        if (extraGenSnapshotOptions != null) {                                               \n            args \"--extra-gen-snapshot-options\", \"${extraGenSnapshotOptions}\"                \n        }                                                                                    \n        if (targetPlatform != null) {                                                        \n            args \"--target-platform\", \"${targetPlatform}\"                                    \n        }                                                                                    \n        if (buildMode == \"release\" || buildMode == \"profile\") {                              \n            args \"--precompiled\"                                                             \n        } else {                                                                             \n            args \"--depfile\", \"${intermediateDir}/snapshot_blob.bin.d\"                       \n        }                                                                                    \n        args \"--asset-dir\", \"${intermediateDir}/flutter_assets\"                              \n        if (buildMode == \"debug\") {                                                          \n            args \"--debug\"                                                                   \n        }                                                                                    \n        if (buildMode == \"profile\" || buildMode == \"dynamicProfile\") {                       \n            args \"--profile\"                                                                 \n        }                                                                                    \n        if (buildMode == \"release\" || buildMode == \"dynamicRelease\") {                       \n            args \"--release\"                                                                 \n        }                                                                                    \n        if (buildMode == \"dynamicProfile\" || buildMode == \"dynamicRelease\") {                \n            args \"--dynamic\"                                                                 \n        }                                                                                    \n    }                                                                                        \n}                                                                                            \n```\n\n用 `@TaskAction` 表示的方法就是 task 执行时候的方法。这里代码也很长，其实就是执行了两个命令。第一，如果是 release 或 profile 模式下，执行 `flutter build aot`。然后执行 `flutter build bundle`。\n\n### 实现\n\n分析完 Flutter 接入的流程后，再回头去看我们一开始面临的问题，现在我们来解决它。\n\n#### 生成 aar\n\n为了其他成员不需要依赖于 Flutter 环境，首先我们需要将 Flutter 代码提前生成为 aar，之所以不是 jar，是因为有图片资源等。生成产物的命令可以参照 FlutterBuildTask，要注意的是，debug 和 release 模式下生成的产物是不一致的。\n\ndebug 模式下的构建产物：\n\n![debug](https://user-gold-cdn.xitu.io/2019/8/22/16cb84ca450f272b?w=460&h=380&f=png&s=39969)\n\nrelease 模式下的构建产物：\n\n![release](https://user-gold-cdn.xitu.io/2019/8/22/16cb84c97b7471b6?w=474&h=210&f=png&s=24868)\n\nFlutter 产物生成不麻烦，照搬命令即可，这主要解决的问题是，Flutter 模块中依赖的第三方插件，上面我们说到，Flutter 模块依赖的第三方插件会生成到配置文件 .flutter-plugins 中。然后在 settings.gradle 中，将这些项目的源码加入我们项目的依赖中去。所有，我们要提前构建的话，就需要将这些代码也打进我们的 aar 中。可惜，官方不支持这种操作，这时候需要第三方库来支持了，[fataar-gradle-plugin](https://github.com/Mobbeel/fataar-gradle-plugin)，不过这个库有个小坑，Android Gradle 插件 3.1.x 的时候，没有将 jni 目录的 so 输出到 aar 中，解决方式，添加：\n\n```groovy\nproject.copy {\n                from \"${project.projectDir.path}/build/intermediates/library_and_local_jars_jni/${variantName}\"\n                include \"**\"\n                into \"${temporaryDir.path}/${variantName}/jni\"\n            }\n```\n\n经过这两个步骤后，我们就能提前将 Flutter 产物和第三方插件的 aar 都打包一个 aar，上传 maven 上等等。\n\n#### 源码管理\n\n因为 Android 项目和 iOS 项目都需要用到同一套 Flutter 源码，所以这里我们可以使用 git 提供的 submodule 的形式接入源码。关于 Flutter SDK 版本管理，可以参照之前的文章：[flutterw](https://juejin.im/post/5d0c39326fb9a07ef63fe4b0)\n\n### 结尾\n\n因为篇幅原因，所以不能将实现细节完整写出来，只能将一些关键点整理出来，希望能对大家有点启发。有其他疑问，欢迎留言讨论。","slug":"无侵入引入Flutter模块","published":1,"updated":"2022-06-15T11:19:32.325Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl4hzcrm7001nfho68emshdcs","content":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>Flutter 作为当下比较流行的技术，不少公司已经开始在原生项目中接入它，但这也带来了一些问题：</p>\n<ul>\n<li>Flutter SDK 问题，在 Android 中，Flutter 的代码和 Framework 会被编译成产物，而且 debug 和 release 生成的产物也是不太一样的。要编译就需要有 SDK，这意味着其他成员也需要下载 Flutter SDK，即使他不需要开发 Flutter 模块，还有 Flutter 版本的管理也是一个问题，不过这个已经有解决方案了。</li>\n<li>Android 和 iOS 项目需要共用一套 Flutter 代码，这就需要用合适的方式去管理 Flutter 模块。</li>\n</ul>\n<blockquote>\n<p>文章基于 v1.5.4-hotfix.2 Flutter SDK 版本</p>\n</blockquote>\n<h3 id=\"Flutter的接入\"><a href=\"#Flutter的接入\" class=\"headerlink\" title=\"Flutter的接入\"></a>Flutter的接入</h3><p>要优化它，就需要先了解它。以 Android 为例，要接入 Flutter 很方便，首先在 settings.gradle 中：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> flutterProjectRoot = rootProject.projectDir.parentFile.toPath()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> plugins = <span class=\"keyword\">new</span> Properties()</span><br><span class=\"line\"><span class=\"keyword\">def</span> pluginsFile = <span class=\"keyword\">new</span> File(flutterProjectRoot.toFile(), <span class=\"string\">&#x27;.flutter-plugins&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> (pluginsFile.exists()) &#123;</span><br><span class=\"line\">    pluginsFile.withReader(<span class=\"string\">&#x27;UTF-8&#x27;</span>) &#123; reader -&gt; plugins.load(reader) &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">plugins.each &#123; name, path -&gt;</span><br><span class=\"line\">    <span class=\"keyword\">def</span> pluginDirectory = flutterProjectRoot.resolve(path).resolve(<span class=\"string\">&#x27;android&#x27;</span>).toFile()</span><br><span class=\"line\">    include <span class=\"string\">&quot;:$name&quot;</span></span><br><span class=\"line\">    project(<span class=\"string\">&quot;:$name&quot;</span>).projectDir = pluginDirectory</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里会将 Flutter 所依赖的第三方插件，include 到我们项目中，而相关的配置就记录在 .flutter-plugins 中。接着在 app 模块下的 build.gradle 中：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">from:</span> <span class=\"string\">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>flutter.gradle 这个文件在 Flutter SDK 目录中，我们上面说到编译成产物的操作就是在这个脚本中定义的。所以我们注重看下这个文件：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> FlutterPlugin</span><br></pre></td></tr></table></figure>\n\n<p>FlutterPlugin 是一个自定义的 Gradle Plugin，而且也是定义在这个文件中的。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.android.buildTypes &#123;                            </span><br><span class=\"line\">    profile &#123;                                           </span><br><span class=\"line\">        initWith debug                                  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;      </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]    </span><br><span class=\"line\">        &#125;                                               </span><br><span class=\"line\">    &#125;                                                   </span><br><span class=\"line\">    dynamicProfile &#123;                                    </span><br><span class=\"line\">        initWith debug                                  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;      </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]    </span><br><span class=\"line\">        &#125;                                               </span><br><span class=\"line\">    &#125;                                                   </span><br><span class=\"line\">    dynamicRelease &#123;                                    </span><br><span class=\"line\">        initWith debug                                  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;      </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]    </span><br><span class=\"line\">        &#125;                                               </span><br><span class=\"line\">    &#125;                                                   </span><br><span class=\"line\">&#125;                                                       </span><br></pre></td></tr></table></figure>\n\n<p>除了默认的 debug 和 release 之外，Flutter 会定义 profile、dynamicProfile、dynamicRelease 这三种 buildType，这里需要注意下，如果项目已经定义了同名的 buildType 的话。<code>matchingFallbacks</code> 表示如果引用的模块中不存在相同的 buildType，则使用这些替补选项。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (project.hasProperty(<span class=\"string\">&#x27;localEngineOut&#x27;</span>)) &#123;</span><br><span class=\"line\"> <span class=\"comment\">//...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>localEngineOut</code> 可以用于指定特定的 engine 目录，默认用 SDK 中的，如果自己重新编译了 engine，可以用这个选项来指向。具体可见：<a href=\"%5Bhttps://fucknmb.com/2019/02/26/Flutter-Engine-%E7%BC%96%E8%AF%91%E6%8C%87%E5%8C%97/%5D(https://fucknmb.com/2019/02/26/Flutter-Engine-%E7%BC%96%E8%AF%91%E6%8C%87%E5%8C%97/)\">Flutter-Engine-编译指北</a></p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Path baseEnginePath = Paths.get(flutterRoot.absolutePath, <span class=\"string\">&quot;bin&quot;</span>, <span class=\"string\">&quot;cache&quot;</span>, <span class=\"string\">&quot;artifacts&quot;</span>, <span class=\"string\">&quot;engine&quot;</span>)                              </span><br><span class=\"line\">String targetArch = <span class=\"string\">&#x27;arm&#x27;</span>                                                                                                     </span><br><span class=\"line\"><span class=\"keyword\">if</span> (project.hasProperty(<span class=\"string\">&#x27;target-platform&#x27;</span>) &amp;&amp;                                                                                 </span><br><span class=\"line\">    project.property(<span class=\"string\">&#x27;target-platform&#x27;</span>) == <span class=\"string\">&#x27;android-arm64&#x27;</span>) &#123;                                                                 </span><br><span class=\"line\">  targetArch = <span class=\"string\">&#x27;arm64&#x27;</span>                                                                                                        </span><br><span class=\"line\">&#125;                                                                                                                             </span><br><span class=\"line\">debugFlutterJar = baseEnginePath.resolve(<span class=\"string\">&quot;android-$&#123;targetArch&#125;&quot;</span>).resolve(<span class=\"string\">&quot;flutter.jar&quot;</span>).toFile()                             </span><br><span class=\"line\">profileFlutterJar = baseEnginePath.resolve(<span class=\"string\">&quot;android-$&#123;targetArch&#125;-profile&quot;</span>).resolve(<span class=\"string\">&quot;flutter.jar&quot;</span>).toFile()                   </span><br><span class=\"line\">releaseFlutterJar = baseEnginePath.resolve(<span class=\"string\">&quot;android-$&#123;targetArch&#125;-release&quot;</span>).resolve(<span class=\"string\">&quot;flutter.jar&quot;</span>).toFile()                   </span><br><span class=\"line\">dynamicProfileFlutterJar = baseEnginePath.resolve(<span class=\"string\">&quot;android-$&#123;targetArch&#125;-dynamic-profile&quot;</span>).resolve(<span class=\"string\">&quot;flutter.jar&quot;</span>).toFile()    </span><br><span class=\"line\">dynamicReleaseFlutterJar = baseEnginePath.resolve(<span class=\"string\">&quot;android-$&#123;targetArch&#125;-dynamic-release&quot;</span>).resolve(<span class=\"string\">&quot;flutter.jar&quot;</span>).toFile()    </span><br><span class=\"line\"><span class=\"keyword\">if</span> (!debugFlutterJar.isFile()) &#123;                                                                                              </span><br><span class=\"line\">    project.exec &#123;                                                                                                            </span><br><span class=\"line\">        executable flutterExecutable.absolutePath                                                                             </span><br><span class=\"line\">        args <span class=\"string\">&quot;--suppress-analytics&quot;</span>                                                                                           </span><br><span class=\"line\">        args <span class=\"string\">&quot;precache&quot;</span>                                                                                                       </span><br><span class=\"line\">    &#125;                                                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!debugFlutterJar.isFile()) &#123;                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> GradleException(<span class=\"string\">&quot;Unable to find flutter.jar in SDK: $&#123;debugFlutterJar&#125;&quot;</span>)                                    </span><br><span class=\"line\">    &#125;                                                                                                                         </span><br><span class=\"line\">&#125;                                                                                                                             </span><br><span class=\"line\">                                                                                                                              </span><br><span class=\"line\"><span class=\"comment\">// Add x86/x86_64 native library. Debug mode only, for now.                                                                   </span></span><br><span class=\"line\">flutterX86Jar = project.file(<span class=\"string\">&quot;$&#123;project.buildDir&#125;/$&#123;AndroidProject.FD_INTERMEDIATES&#125;/flutter/flutter-x86.jar&quot;</span>)                </span><br><span class=\"line\">Task flutterX86JarTask = project.tasks.create(<span class=\"string\">&quot;$&#123;flutterBuildPrefix&#125;X86Jar&quot;</span>, Jar) &#123;                                           </span><br><span class=\"line\">    destinationDir flutterX86Jar.parentFile                                                                                   </span><br><span class=\"line\">    archiveName flutterX86Jar.name                                                                                            </span><br><span class=\"line\">    from(<span class=\"string\">&quot;$&#123;flutterRoot&#125;/bin/cache/artifacts/engine/android-x86/libflutter.so&quot;</span>) &#123;                                             </span><br><span class=\"line\">        into <span class=\"string\">&quot;lib/x86&quot;</span>                                                                                                        </span><br><span class=\"line\">    &#125;                                                                                                                         </span><br><span class=\"line\">    from(<span class=\"string\">&quot;$&#123;flutterRoot&#125;/bin/cache/artifacts/engine/android-x64/libflutter.so&quot;</span>) &#123;                                             </span><br><span class=\"line\">        into <span class=\"string\">&quot;lib/x86_64&quot;</span>                                                                                                     </span><br><span class=\"line\">    &#125;                                                                                                                         </span><br><span class=\"line\">&#125;                                                                                                                             </span><br><span class=\"line\"><span class=\"comment\">// Add flutter.jar dependencies to all &lt;buildType&gt;Api configurations, including custom ones                                   </span></span><br><span class=\"line\"><span class=\"comment\">// added after applying the Flutter plugin.                                                                                   </span></span><br><span class=\"line\">project.android.buildTypes.each &#123; addFlutterJarApiDependency(project, it, flutterX86JarTask) &#125;                                </span><br><span class=\"line\">project.android.buildTypes.whenObjectAdded &#123; addFlutterJarApiDependency(project, it, flutterX86JarTask) &#125;                     </span><br></pre></td></tr></table></figure>\n\n<p>这里的代码看起来很长，其实做的事情就是一件，添加 flutter.jar 依赖，不同的 buildType 添加不同的版本，debug 模式额外增加 x86&#x2F;x86_64 架构的版本。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.extensions.create(<span class=\"string\">&quot;flutter&quot;</span>, FlutterExtension)   </span><br><span class=\"line\">project.afterEvaluate <span class=\"variable language_\">this</span>.&amp;addFlutterTask               </span><br></pre></td></tr></table></figure>\n\n<p>首先添加一个 FlutterExtension 配置块，可选的配置有 source 和 target，用于指定编写的 Flutter 代码目录和执行 Flutter 代码的入口 dart 文件，默认为 <code>lib/main.dart</code>。</p>\n<p>在 <code>afterEvaluate</code> 钩子上添加一个执行方法：addFlutterTask。</p>\n<p><code>verbose</code>、<code>filesystem-roots</code>、<code>filesystem-scheme</code> 这些一些额外可选的参数，这里我们先不关心。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (project.android.hasProperty(<span class=\"string\">&quot;applicationVariants&quot;</span>)) &#123;   </span><br><span class=\"line\">    project.android.applicationVariants.all addFlutterDeps  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;                                                    </span><br><span class=\"line\">    project.android.libraryVariants.all addFlutterDeps      </span><br><span class=\"line\">&#125;                                                           </span><br></pre></td></tr></table></figure>\n\n<p>存在 <code>applicationVariants</code> 属性表示当前接入 Flutter 的模块是使用 <code>com.android.application</code>，<code>applicationVariants</code> 和 <code>libraryVariants</code> 都是表示当前模块的构建变体，<code>addFlutterDeps</code> 是一个闭包，这里的意思是，遍历所有变体，调用 addFlutterDeps。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> addFlutterDeps = &#123; variant -&gt;                                                                                                        </span><br><span class=\"line\">    String flutterBuildMode = buildModeFor(variant.buildType)                                                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (flutterBuildMode == <span class=\"string\">&#x27;debug&#x27;</span> &amp;&amp; project.tasks.findByName(<span class=\"string\">&#x27;$&#123;flutterBuildPrefix&#125;X86Jar&#x27;</span>)) &#123;                                        </span><br><span class=\"line\">        Task task = project.tasks.findByName(<span class=\"string\">&quot;compile$&#123;variant.name.capitalize()&#125;JavaWithJavac&quot;</span>)                                         </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (task) &#123;                                                                                                                      </span><br><span class=\"line\">            task.dependsOn project.flutterBuildX86Jar                                                                                    </span><br><span class=\"line\">        &#125;                                                                                                                                </span><br><span class=\"line\">        task = project.tasks.findByName(<span class=\"string\">&quot;compile$&#123;variant.name.capitalize()&#125;Kotlin&quot;</span>)                                                     </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (task) &#123;                                                                                                                      </span><br><span class=\"line\">            task.dependsOn project.flutterBuildX86Jar                                                                                    </span><br><span class=\"line\">        &#125;                                                                                                                                </span><br><span class=\"line\">    &#125;                                                                                                                                    </span><br><span class=\"line\">                                                                                                                                         </span><br><span class=\"line\">    FlutterTask flutterTask = project.tasks.create(<span class=\"attr\">name:</span> <span class=\"string\">&quot;$&#123;flutterBuildPrefix&#125;$&#123;variant.name.capitalize()&#125;&quot;</span>, <span class=\"attr\">type:</span> FlutterTask) &#123;       </span><br><span class=\"line\">        flutterRoot <span class=\"variable language_\">this</span>.flutterRoot                                                                                                     </span><br><span class=\"line\">        flutterExecutable <span class=\"variable language_\">this</span>.flutterExecutable                                                                                         </span><br><span class=\"line\">        buildMode flutterBuildMode                                                                                                       </span><br><span class=\"line\">        localEngine <span class=\"variable language_\">this</span>.localEngine                                                                                                     </span><br><span class=\"line\">        localEngineSrcPath <span class=\"variable language_\">this</span>.localEngineSrcPath                                                                                       </span><br><span class=\"line\">        targetPath target                                                                                                                </span><br><span class=\"line\">        verbose verboseValue                                                                                                             </span><br><span class=\"line\">        fileSystemRoots fileSystemRootsValue                                                                                             </span><br><span class=\"line\">        fileSystemScheme fileSystemSchemeValue                                                                                           </span><br><span class=\"line\">        trackWidgetCreation trackWidgetCreationValue                                                                                     </span><br><span class=\"line\">        compilationTraceFilePath compilationTraceFilePathValue                                                                           </span><br><span class=\"line\">        createPatch createPatchValue                                                                                                     </span><br><span class=\"line\">        buildNumber buildNumberValue                                                                                                     </span><br><span class=\"line\">        baselineDir baselineDirValue                                                                                                     </span><br><span class=\"line\">        buildSharedLibrary buildSharedLibraryValue                                                                                       </span><br><span class=\"line\">        targetPlatform targetPlatformValue                                                                                               </span><br><span class=\"line\">        sourceDir project.file(project.flutter.source)                                                                                   </span><br><span class=\"line\">        intermediateDir project.file(<span class=\"string\">&quot;$&#123;project.buildDir&#125;/$&#123;AndroidProject.FD_INTERMEDIATES&#125;/flutter/$&#123;variant.name&#125;&quot;</span>)                   </span><br><span class=\"line\">        extraFrontEndOptions extraFrontEndOptionsValue                                                                                   </span><br><span class=\"line\">        extraGenSnapshotOptions extraGenSnapshotOptionsValue                                                                             </span><br><span class=\"line\">    &#125;                                                                                                                                    </span><br><span class=\"line\">                                                                                                                                         </span><br><span class=\"line\">    <span class=\"comment\">// We know that the flutter app is a subproject in another Android app when these tasks exist.                                       </span></span><br><span class=\"line\">    Task packageAssets = project.tasks.findByPath(<span class=\"string\">&quot;:flutter:package$&#123;variant.name.capitalize()&#125;Assets&quot;</span>)                                  </span><br><span class=\"line\">    Task cleanPackageAssets = project.tasks.findByPath(<span class=\"string\">&quot;:flutter:cleanPackage$&#123;variant.name.capitalize()&#125;Assets&quot;</span>)                        </span><br><span class=\"line\">                                                                                                                                         </span><br><span class=\"line\">    Task copyFlutterAssetsTask = project.tasks.create(<span class=\"attr\">name:</span> <span class=\"string\">&quot;copyFlutterAssets$&#123;variant.name.capitalize()&#125;&quot;</span>, <span class=\"attr\">type:</span> Copy) &#123;               </span><br><span class=\"line\">        dependsOn flutterTask                                                                                                            </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (packageAssets &amp;&amp; cleanPackageAssets) &#123;                                                                                       </span><br><span class=\"line\">            dependsOn packageAssets                                                                                                      </span><br><span class=\"line\">            dependsOn cleanPackageAssets                                                                                                 </span><br><span class=\"line\">            into packageAssets.outputDir                                                                                                 </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;                                                                                                                         </span><br><span class=\"line\">            dependsOn variant.mergeAssets                                                                                                </span><br><span class=\"line\">            dependsOn <span class=\"string\">&quot;clean$&#123;variant.mergeAssets.name.capitalize()&#125;&quot;</span>                                                                    </span><br><span class=\"line\">            into variant.mergeAssets.outputDir                                                                                           </span><br><span class=\"line\">        &#125;                                                                                                                                </span><br><span class=\"line\">        with flutterTask.assets                                                                                                          </span><br><span class=\"line\">    &#125;                                                                                                                                    </span><br><span class=\"line\">                                                                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (packageAssets) &#123;                                                                                                                 </span><br><span class=\"line\">        String mainModuleName = <span class=\"string\">&quot;app&quot;</span>                                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;                                                                                                                            </span><br><span class=\"line\">            String tmpModuleName = project.rootProject.ext.mainModuleName                                                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tmpModuleName != <span class=\"literal\">null</span> &amp;&amp; !tmpModuleName.empty) &#123;                                                                         </span><br><span class=\"line\">                mainModuleName = tmpModuleName                                                                                           </span><br><span class=\"line\">            &#125;                                                                                                                            </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;                                                                                                          </span><br><span class=\"line\">        &#125;                                                                                                                                </span><br><span class=\"line\">        <span class=\"comment\">// Only include configurations that exist in parent project.                                                                     </span></span><br><span class=\"line\">        Task mergeAssets = project.tasks.findByPath(<span class=\"string\">&quot;:$&#123;mainModuleName&#125;:merge$&#123;variant.name.capitalize()&#125;Assets&quot;</span>)                        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mergeAssets) &#123;                                                                                                               </span><br><span class=\"line\">            mergeAssets.dependsOn(copyFlutterAssetsTask)                                                                                 </span><br><span class=\"line\">        &#125;                                                                                                                                </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                                                                             </span><br><span class=\"line\">        variant.outputs[<span class=\"number\">0</span>].processResources.dependsOn(copyFlutterAssetsTask)                                                             </span><br><span class=\"line\">    &#125;                                                                                                                                    </span><br><span class=\"line\">&#125;                                                                                                                                        </span><br></pre></td></tr></table></figure>\n\n<p><code>variant</code> 就是上面遍历的构建变体。首先当构建类型为 debug 时，会在 compileJavaWithJavac 和 compileKotlin 这两个 task 之前先执行 flutterBuildX86Jar task。它的作用是引入 x86 架构的 jar 和 so 文件。</p>\n<blockquote>\n<p>这里有个 bug</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.tasks.findByName(<span class=\"string\">&#x27;$&#123;flutterBuildPrefix&#125;X86Jar&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>判断是否存在 task 时，拼接字符串用的是单引号，正确应该用双引号，最新版本已经改正了。</p>\n</blockquote>\n<p>接下来，会创建两个 task，flutterBuild 和 copyFlutterAssets，flutterBuild 用于编译产物，copyFlutterAssets 则是将产物拷贝到 assets 目录。因为使用 <code>com.android.application</code> 和 <code>com.android.library</code> 拥有的 task 是不一样的，所有这里用是否存在 packageAssets 和 cleanPackageAssets 这两个 task 去判断引用不同插件的模块，同时引入 library 插件的模块，flutterBuild 需要依赖于这两个 task。</p>\n<p>flutterBuild task 实际上 FlutterTask 类型，同时 FlutterTask 继承于 BaseFlutterTask。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">BaseFlutterTask</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">DefaultTask</span> &#123; </span><br><span class=\"line\"><span class=\"meta\">@OutputFiles</span>                                                                </span><br><span class=\"line\">FileCollection getDependenciesFiles() &#123;                                     </span><br><span class=\"line\">    FileCollection depfiles = project.files()                               </span><br><span class=\"line\">                                                                            </span><br><span class=\"line\">    <span class=\"comment\">// Include the kernel compiler depfile, since kernel compile is the     </span></span><br><span class=\"line\">    <span class=\"comment\">// first stage of AOT build in this mode, and it includes all the Dart  </span></span><br><span class=\"line\">    <span class=\"comment\">// sources.                                                             </span></span><br><span class=\"line\">    depfiles += project.files(<span class=\"string\">&quot;$&#123;intermediateDir&#125;/kernel_compile.d&quot;</span>)        </span><br><span class=\"line\">                                                                            </span><br><span class=\"line\">    <span class=\"comment\">// Include Core JIT kernel compiler depfile, since kernel compile is    </span></span><br><span class=\"line\">    <span class=\"comment\">// the first stage of JIT builds in this mode, and it includes all the  </span></span><br><span class=\"line\">    <span class=\"comment\">// Dart sources.                                                        </span></span><br><span class=\"line\">    depfiles += project.files(<span class=\"string\">&quot;$&#123;intermediateDir&#125;/snapshot_blob.bin.d&quot;</span>)     </span><br><span class=\"line\">    <span class=\"keyword\">return</span> depfiles                                                         </span><br><span class=\"line\">&#125;                                                                           </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>@OutputFiles</code> 注解用于标示 task 输出的目录，这个可以用来做增量编译和任务缓存等等。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FlutterTask</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">BaseFlutterTask</span> &#123;</span><br><span class=\"line\">  <span class=\"meta\">@TaskAction</span>      </span><br><span class=\"line\"><span class=\"type\">void</span> build() &#123;   </span><br><span class=\"line\">    buildBundle()</span><br><span class=\"line\">&#125;                </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> buildBundle() &#123;                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!sourceDir.isDirectory()) &#123;                                                          </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> GradleException(<span class=\"string\">&quot;Invalid Flutter source directory: $&#123;sourceDir&#125;&quot;</span>)          </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    intermediateDir.mkdirs()                                                                 </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;profile&quot;</span> || buildMode == <span class=\"string\">&quot;release&quot;</span>) &#123;                                  </span><br><span class=\"line\">        project.exec &#123;                                                                       </span><br><span class=\"line\">            executable flutterExecutable.absolutePath                                        </span><br><span class=\"line\">            workingDir sourceDir                                                             </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (localEngine != <span class=\"literal\">null</span>) &#123;                                                       </span><br><span class=\"line\">                args <span class=\"string\">&quot;--local-engine&quot;</span>, localEngine                                           </span><br><span class=\"line\">                args <span class=\"string\">&quot;--local-engine-src-path&quot;</span>, localEngineSrcPath                           </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            args <span class=\"string\">&quot;build&quot;</span>, <span class=\"string\">&quot;aot&quot;</span>                                                              </span><br><span class=\"line\">            args <span class=\"string\">&quot;--suppress-analytics&quot;</span>                                                      </span><br><span class=\"line\">            args <span class=\"string\">&quot;--quiet&quot;</span>                                                                   </span><br><span class=\"line\">            args <span class=\"string\">&quot;--target&quot;</span>, targetPath                                                      </span><br><span class=\"line\">            args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;android-arm&quot;</span>                                          </span><br><span class=\"line\">            args <span class=\"string\">&quot;--output-dir&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;&quot;</span>                                        </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (trackWidgetCreation) &#123;                                                       </span><br><span class=\"line\">                args <span class=\"string\">&quot;--track-widget-creation&quot;</span>                                               </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (extraFrontEndOptions != <span class=\"literal\">null</span>) &#123;                                              </span><br><span class=\"line\">                args <span class=\"string\">&quot;--extra-front-end-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraFrontEndOptions&#125;&quot;</span>                  </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (extraGenSnapshotOptions != <span class=\"literal\">null</span>) &#123;                                           </span><br><span class=\"line\">                args <span class=\"string\">&quot;--extra-gen-snapshot-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraGenSnapshotOptions&#125;&quot;</span>            </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (buildSharedLibrary) &#123;                                                        </span><br><span class=\"line\">                args <span class=\"string\">&quot;--build-shared-library&quot;</span>                                                </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (targetPlatform != <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">                args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;$&#123;targetPlatform&#125;&quot;</span>                                </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            args <span class=\"string\">&quot;--$&#123;buildMode&#125;&quot;</span>                                                            </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    project.exec &#123;                                                                           </span><br><span class=\"line\">        executable flutterExecutable.absolutePath                                            </span><br><span class=\"line\">        workingDir sourceDir                                                                 </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (localEngine != <span class=\"literal\">null</span>) &#123;                                                           </span><br><span class=\"line\">            args <span class=\"string\">&quot;--local-engine&quot;</span>, localEngine                                               </span><br><span class=\"line\">            args <span class=\"string\">&quot;--local-engine-src-path&quot;</span>, localEngineSrcPath                               </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        args <span class=\"string\">&quot;build&quot;</span>, <span class=\"string\">&quot;bundle&quot;</span>                                                               </span><br><span class=\"line\">        args <span class=\"string\">&quot;--suppress-analytics&quot;</span>                                                          </span><br><span class=\"line\">        args <span class=\"string\">&quot;--target&quot;</span>, targetPath                                                          </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (verbose) &#123;                                                                       </span><br><span class=\"line\">            args <span class=\"string\">&quot;--verbose&quot;</span>                                                                 </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (fileSystemRoots != <span class=\"literal\">null</span>) &#123;                                                       </span><br><span class=\"line\">            <span class=\"keyword\">for</span> (root <span class=\"keyword\">in</span> fileSystemRoots) &#123;                                                  </span><br><span class=\"line\">                args <span class=\"string\">&quot;--filesystem-root&quot;</span>, root                                               </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (fileSystemScheme != <span class=\"literal\">null</span>) &#123;                                                      </span><br><span class=\"line\">            args <span class=\"string\">&quot;--filesystem-scheme&quot;</span>, fileSystemScheme                                     </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (trackWidgetCreation) &#123;                                                           </span><br><span class=\"line\">            args <span class=\"string\">&quot;--track-widget-creation&quot;</span>                                                   </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compilationTraceFilePath != <span class=\"literal\">null</span>) &#123;                                              </span><br><span class=\"line\">            args <span class=\"string\">&quot;--compilation-trace-file&quot;</span>, compilationTraceFilePath                        </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (createPatch) &#123;                                                                   </span><br><span class=\"line\">            args <span class=\"string\">&quot;--patch&quot;</span>                                                                   </span><br><span class=\"line\">            args <span class=\"string\">&quot;--build-number&quot;</span>, project.android.defaultConfig.versionCode                 </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (buildNumber != <span class=\"literal\">null</span>) &#123;                                                       </span><br><span class=\"line\">                <span class=\"keyword\">assert</span> buildNumber == project.android.defaultConfig.versionCode              </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (baselineDir != <span class=\"literal\">null</span>) &#123;                                                           </span><br><span class=\"line\">            args <span class=\"string\">&quot;--baseline-dir&quot;</span>, baselineDir                                               </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (extraFrontEndOptions != <span class=\"literal\">null</span>) &#123;                                                  </span><br><span class=\"line\">            args <span class=\"string\">&quot;--extra-front-end-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraFrontEndOptions&#125;&quot;</span>                      </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (extraGenSnapshotOptions != <span class=\"literal\">null</span>) &#123;                                               </span><br><span class=\"line\">            args <span class=\"string\">&quot;--extra-gen-snapshot-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraGenSnapshotOptions&#125;&quot;</span>                </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (targetPlatform != <span class=\"literal\">null</span>) &#123;                                                        </span><br><span class=\"line\">            args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;$&#123;targetPlatform&#125;&quot;</span>                                    </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;release&quot;</span> || buildMode == <span class=\"string\">&quot;profile&quot;</span>) &#123;                              </span><br><span class=\"line\">            args <span class=\"string\">&quot;--precompiled&quot;</span>                                                             </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;                                                                             </span><br><span class=\"line\">            args <span class=\"string\">&quot;--depfile&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;/snapshot_blob.bin.d&quot;</span>                       </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        args <span class=\"string\">&quot;--asset-dir&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;/flutter_assets&quot;</span>                              </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;debug&quot;</span>) &#123;                                                          </span><br><span class=\"line\">            args <span class=\"string\">&quot;--debug&quot;</span>                                                                   </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;profile&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicProfile&quot;</span>) &#123;                       </span><br><span class=\"line\">            args <span class=\"string\">&quot;--profile&quot;</span>                                                                 </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;release&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicRelease&quot;</span>) &#123;                       </span><br><span class=\"line\">            args <span class=\"string\">&quot;--release&quot;</span>                                                                 </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;dynamicProfile&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicRelease&quot;</span>) &#123;                </span><br><span class=\"line\">            args <span class=\"string\">&quot;--dynamic&quot;</span>                                                                 </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">&#125;                                                                                            </span><br></pre></td></tr></table></figure>\n\n<p>用 <code>@TaskAction</code> 表示的方法就是 task 执行时候的方法。这里代码也很长，其实就是执行了两个命令。第一，如果是 release 或 profile 模式下，执行 <code>flutter build aot</code>。然后执行 <code>flutter build bundle</code>。</p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p>分析完 Flutter 接入的流程后，再回头去看我们一开始面临的问题，现在我们来解决它。</p>\n<h4 id=\"生成-aar\"><a href=\"#生成-aar\" class=\"headerlink\" title=\"生成 aar\"></a>生成 aar</h4><p>为了其他成员不需要依赖于 Flutter 环境，首先我们需要将 Flutter 代码提前生成为 aar，之所以不是 jar，是因为有图片资源等。生成产物的命令可以参照 FlutterBuildTask，要注意的是，debug 和 release 模式下生成的产物是不一致的。</p>\n<p>debug 模式下的构建产物：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/22/16cb84ca450f272b?w=460&h=380&f=png&s=39969\" alt=\"debug\"></p>\n<p>release 模式下的构建产物：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/22/16cb84c97b7471b6?w=474&h=210&f=png&s=24868\" alt=\"release\"></p>\n<p>Flutter 产物生成不麻烦，照搬命令即可，这主要解决的问题是，Flutter 模块中依赖的第三方插件，上面我们说到，Flutter 模块依赖的第三方插件会生成到配置文件 .flutter-plugins 中。然后在 settings.gradle 中，将这些项目的源码加入我们项目的依赖中去。所有，我们要提前构建的话，就需要将这些代码也打进我们的 aar 中。可惜，官方不支持这种操作，这时候需要第三方库来支持了，<a href=\"https://github.com/Mobbeel/fataar-gradle-plugin\">fataar-gradle-plugin</a>，不过这个库有个小坑，Android Gradle 插件 3.1.x 的时候，没有将 jni 目录的 so 输出到 aar 中，解决方式，添加：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.copy &#123;</span><br><span class=\"line\">                from <span class=\"string\">&quot;$&#123;project.projectDir.path&#125;/build/intermediates/library_and_local_jars_jni/$&#123;variantName&#125;&quot;</span></span><br><span class=\"line\">                include <span class=\"string\">&quot;**&quot;</span></span><br><span class=\"line\">                into <span class=\"string\">&quot;$&#123;temporaryDir.path&#125;/$&#123;variantName&#125;/jni&quot;</span></span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure>\n\n<p>经过这两个步骤后，我们就能提前将 Flutter 产物和第三方插件的 aar 都打包一个 aar，上传 maven 上等等。</p>\n<h4 id=\"源码管理\"><a href=\"#源码管理\" class=\"headerlink\" title=\"源码管理\"></a>源码管理</h4><p>因为 Android 项目和 iOS 项目都需要用到同一套 Flutter 源码，所以这里我们可以使用 git 提供的 submodule 的形式接入源码。关于 Flutter SDK 版本管理，可以参照之前的文章：<a href=\"https://juejin.im/post/5d0c39326fb9a07ef63fe4b0\">flutterw</a></p>\n<h3 id=\"结尾\"><a href=\"#结尾\" class=\"headerlink\" title=\"结尾\"></a>结尾</h3><p>因为篇幅原因，所以不能将实现细节完整写出来，只能将一些关键点整理出来，希望能对大家有点启发。有其他疑问，欢迎留言讨论。</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>Flutter 作为当下比较流行的技术，不少公司已经开始在原生项目中接入它，但这也带来了一些问题：</p>\n<ul>\n<li>Flutter SDK 问题，在 Android 中，Flutter 的代码和 Framework 会被编译成产物，而且 debug 和 release 生成的产物也是不太一样的。要编译就需要有 SDK，这意味着其他成员也需要下载 Flutter SDK，即使他不需要开发 Flutter 模块，还有 Flutter 版本的管理也是一个问题，不过这个已经有解决方案了。</li>\n<li>Android 和 iOS 项目需要共用一套 Flutter 代码，这就需要用合适的方式去管理 Flutter 模块。</li>\n</ul>\n<blockquote>\n<p>文章基于 v1.5.4-hotfix.2 Flutter SDK 版本</p>\n</blockquote>\n<h3 id=\"Flutter的接入\"><a href=\"#Flutter的接入\" class=\"headerlink\" title=\"Flutter的接入\"></a>Flutter的接入</h3><p>要优化它，就需要先了解它。以 Android 为例，要接入 Flutter 很方便，首先在 settings.gradle 中：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> flutterProjectRoot = rootProject.projectDir.parentFile.toPath()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> plugins = <span class=\"keyword\">new</span> Properties()</span><br><span class=\"line\"><span class=\"keyword\">def</span> pluginsFile = <span class=\"keyword\">new</span> File(flutterProjectRoot.toFile(), <span class=\"string\">&#x27;.flutter-plugins&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> (pluginsFile.exists()) &#123;</span><br><span class=\"line\">    pluginsFile.withReader(<span class=\"string\">&#x27;UTF-8&#x27;</span>) &#123; reader -&gt; plugins.load(reader) &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">plugins.each &#123; name, path -&gt;</span><br><span class=\"line\">    <span class=\"keyword\">def</span> pluginDirectory = flutterProjectRoot.resolve(path).resolve(<span class=\"string\">&#x27;android&#x27;</span>).toFile()</span><br><span class=\"line\">    include <span class=\"string\">&quot;:$name&quot;</span></span><br><span class=\"line\">    project(<span class=\"string\">&quot;:$name&quot;</span>).projectDir = pluginDirectory</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里会将 Flutter 所依赖的第三方插件，include 到我们项目中，而相关的配置就记录在 .flutter-plugins 中。接着在 app 模块下的 build.gradle 中：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">from:</span> <span class=\"string\">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>flutter.gradle 这个文件在 Flutter SDK 目录中，我们上面说到编译成产物的操作就是在这个脚本中定义的。所以我们注重看下这个文件：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> FlutterPlugin</span><br></pre></td></tr></table></figure>\n\n<p>FlutterPlugin 是一个自定义的 Gradle Plugin，而且也是定义在这个文件中的。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.android.buildTypes &#123;                            </span><br><span class=\"line\">    profile &#123;                                           </span><br><span class=\"line\">        initWith debug                                  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;      </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]    </span><br><span class=\"line\">        &#125;                                               </span><br><span class=\"line\">    &#125;                                                   </span><br><span class=\"line\">    dynamicProfile &#123;                                    </span><br><span class=\"line\">        initWith debug                                  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;      </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]    </span><br><span class=\"line\">        &#125;                                               </span><br><span class=\"line\">    &#125;                                                   </span><br><span class=\"line\">    dynamicRelease &#123;                                    </span><br><span class=\"line\">        initWith debug                                  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (it.hasProperty(<span class=\"string\">&#x27;matchingFallbacks&#x27;</span>)) &#123;      </span><br><span class=\"line\">            matchingFallbacks = [<span class=\"string\">&#x27;debug&#x27;</span>, <span class=\"string\">&#x27;release&#x27;</span>]    </span><br><span class=\"line\">        &#125;                                               </span><br><span class=\"line\">    &#125;                                                   </span><br><span class=\"line\">&#125;                                                       </span><br></pre></td></tr></table></figure>\n\n<p>除了默认的 debug 和 release 之外，Flutter 会定义 profile、dynamicProfile、dynamicRelease 这三种 buildType，这里需要注意下，如果项目已经定义了同名的 buildType 的话。<code>matchingFallbacks</code> 表示如果引用的模块中不存在相同的 buildType，则使用这些替补选项。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (project.hasProperty(<span class=\"string\">&#x27;localEngineOut&#x27;</span>)) &#123;</span><br><span class=\"line\"> <span class=\"comment\">//...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>localEngineOut</code> 可以用于指定特定的 engine 目录，默认用 SDK 中的，如果自己重新编译了 engine，可以用这个选项来指向。具体可见：<a href=\"%5Bhttps://fucknmb.com/2019/02/26/Flutter-Engine-%E7%BC%96%E8%AF%91%E6%8C%87%E5%8C%97/%5D(https://fucknmb.com/2019/02/26/Flutter-Engine-%E7%BC%96%E8%AF%91%E6%8C%87%E5%8C%97/)\">Flutter-Engine-编译指北</a></p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Path baseEnginePath = Paths.get(flutterRoot.absolutePath, <span class=\"string\">&quot;bin&quot;</span>, <span class=\"string\">&quot;cache&quot;</span>, <span class=\"string\">&quot;artifacts&quot;</span>, <span class=\"string\">&quot;engine&quot;</span>)                              </span><br><span class=\"line\">String targetArch = <span class=\"string\">&#x27;arm&#x27;</span>                                                                                                     </span><br><span class=\"line\"><span class=\"keyword\">if</span> (project.hasProperty(<span class=\"string\">&#x27;target-platform&#x27;</span>) &amp;&amp;                                                                                 </span><br><span class=\"line\">    project.property(<span class=\"string\">&#x27;target-platform&#x27;</span>) == <span class=\"string\">&#x27;android-arm64&#x27;</span>) &#123;                                                                 </span><br><span class=\"line\">  targetArch = <span class=\"string\">&#x27;arm64&#x27;</span>                                                                                                        </span><br><span class=\"line\">&#125;                                                                                                                             </span><br><span class=\"line\">debugFlutterJar = baseEnginePath.resolve(<span class=\"string\">&quot;android-$&#123;targetArch&#125;&quot;</span>).resolve(<span class=\"string\">&quot;flutter.jar&quot;</span>).toFile()                             </span><br><span class=\"line\">profileFlutterJar = baseEnginePath.resolve(<span class=\"string\">&quot;android-$&#123;targetArch&#125;-profile&quot;</span>).resolve(<span class=\"string\">&quot;flutter.jar&quot;</span>).toFile()                   </span><br><span class=\"line\">releaseFlutterJar = baseEnginePath.resolve(<span class=\"string\">&quot;android-$&#123;targetArch&#125;-release&quot;</span>).resolve(<span class=\"string\">&quot;flutter.jar&quot;</span>).toFile()                   </span><br><span class=\"line\">dynamicProfileFlutterJar = baseEnginePath.resolve(<span class=\"string\">&quot;android-$&#123;targetArch&#125;-dynamic-profile&quot;</span>).resolve(<span class=\"string\">&quot;flutter.jar&quot;</span>).toFile()    </span><br><span class=\"line\">dynamicReleaseFlutterJar = baseEnginePath.resolve(<span class=\"string\">&quot;android-$&#123;targetArch&#125;-dynamic-release&quot;</span>).resolve(<span class=\"string\">&quot;flutter.jar&quot;</span>).toFile()    </span><br><span class=\"line\"><span class=\"keyword\">if</span> (!debugFlutterJar.isFile()) &#123;                                                                                              </span><br><span class=\"line\">    project.exec &#123;                                                                                                            </span><br><span class=\"line\">        executable flutterExecutable.absolutePath                                                                             </span><br><span class=\"line\">        args <span class=\"string\">&quot;--suppress-analytics&quot;</span>                                                                                           </span><br><span class=\"line\">        args <span class=\"string\">&quot;precache&quot;</span>                                                                                                       </span><br><span class=\"line\">    &#125;                                                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!debugFlutterJar.isFile()) &#123;                                                                                          </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> GradleException(<span class=\"string\">&quot;Unable to find flutter.jar in SDK: $&#123;debugFlutterJar&#125;&quot;</span>)                                    </span><br><span class=\"line\">    &#125;                                                                                                                         </span><br><span class=\"line\">&#125;                                                                                                                             </span><br><span class=\"line\">                                                                                                                              </span><br><span class=\"line\"><span class=\"comment\">// Add x86/x86_64 native library. Debug mode only, for now.                                                                   </span></span><br><span class=\"line\">flutterX86Jar = project.file(<span class=\"string\">&quot;$&#123;project.buildDir&#125;/$&#123;AndroidProject.FD_INTERMEDIATES&#125;/flutter/flutter-x86.jar&quot;</span>)                </span><br><span class=\"line\">Task flutterX86JarTask = project.tasks.create(<span class=\"string\">&quot;$&#123;flutterBuildPrefix&#125;X86Jar&quot;</span>, Jar) &#123;                                           </span><br><span class=\"line\">    destinationDir flutterX86Jar.parentFile                                                                                   </span><br><span class=\"line\">    archiveName flutterX86Jar.name                                                                                            </span><br><span class=\"line\">    from(<span class=\"string\">&quot;$&#123;flutterRoot&#125;/bin/cache/artifacts/engine/android-x86/libflutter.so&quot;</span>) &#123;                                             </span><br><span class=\"line\">        into <span class=\"string\">&quot;lib/x86&quot;</span>                                                                                                        </span><br><span class=\"line\">    &#125;                                                                                                                         </span><br><span class=\"line\">    from(<span class=\"string\">&quot;$&#123;flutterRoot&#125;/bin/cache/artifacts/engine/android-x64/libflutter.so&quot;</span>) &#123;                                             </span><br><span class=\"line\">        into <span class=\"string\">&quot;lib/x86_64&quot;</span>                                                                                                     </span><br><span class=\"line\">    &#125;                                                                                                                         </span><br><span class=\"line\">&#125;                                                                                                                             </span><br><span class=\"line\"><span class=\"comment\">// Add flutter.jar dependencies to all &lt;buildType&gt;Api configurations, including custom ones                                   </span></span><br><span class=\"line\"><span class=\"comment\">// added after applying the Flutter plugin.                                                                                   </span></span><br><span class=\"line\">project.android.buildTypes.each &#123; addFlutterJarApiDependency(project, it, flutterX86JarTask) &#125;                                </span><br><span class=\"line\">project.android.buildTypes.whenObjectAdded &#123; addFlutterJarApiDependency(project, it, flutterX86JarTask) &#125;                     </span><br></pre></td></tr></table></figure>\n\n<p>这里的代码看起来很长，其实做的事情就是一件，添加 flutter.jar 依赖，不同的 buildType 添加不同的版本，debug 模式额外增加 x86&#x2F;x86_64 架构的版本。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.extensions.create(<span class=\"string\">&quot;flutter&quot;</span>, FlutterExtension)   </span><br><span class=\"line\">project.afterEvaluate <span class=\"variable language_\">this</span>.&amp;addFlutterTask               </span><br></pre></td></tr></table></figure>\n\n<p>首先添加一个 FlutterExtension 配置块，可选的配置有 source 和 target，用于指定编写的 Flutter 代码目录和执行 Flutter 代码的入口 dart 文件，默认为 <code>lib/main.dart</code>。</p>\n<p>在 <code>afterEvaluate</code> 钩子上添加一个执行方法：addFlutterTask。</p>\n<p><code>verbose</code>、<code>filesystem-roots</code>、<code>filesystem-scheme</code> 这些一些额外可选的参数，这里我们先不关心。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (project.android.hasProperty(<span class=\"string\">&quot;applicationVariants&quot;</span>)) &#123;   </span><br><span class=\"line\">    project.android.applicationVariants.all addFlutterDeps  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;                                                    </span><br><span class=\"line\">    project.android.libraryVariants.all addFlutterDeps      </span><br><span class=\"line\">&#125;                                                           </span><br></pre></td></tr></table></figure>\n\n<p>存在 <code>applicationVariants</code> 属性表示当前接入 Flutter 的模块是使用 <code>com.android.application</code>，<code>applicationVariants</code> 和 <code>libraryVariants</code> 都是表示当前模块的构建变体，<code>addFlutterDeps</code> 是一个闭包，这里的意思是，遍历所有变体，调用 addFlutterDeps。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> addFlutterDeps = &#123; variant -&gt;                                                                                                        </span><br><span class=\"line\">    String flutterBuildMode = buildModeFor(variant.buildType)                                                                            </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (flutterBuildMode == <span class=\"string\">&#x27;debug&#x27;</span> &amp;&amp; project.tasks.findByName(<span class=\"string\">&#x27;$&#123;flutterBuildPrefix&#125;X86Jar&#x27;</span>)) &#123;                                        </span><br><span class=\"line\">        Task task = project.tasks.findByName(<span class=\"string\">&quot;compile$&#123;variant.name.capitalize()&#125;JavaWithJavac&quot;</span>)                                         </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (task) &#123;                                                                                                                      </span><br><span class=\"line\">            task.dependsOn project.flutterBuildX86Jar                                                                                    </span><br><span class=\"line\">        &#125;                                                                                                                                </span><br><span class=\"line\">        task = project.tasks.findByName(<span class=\"string\">&quot;compile$&#123;variant.name.capitalize()&#125;Kotlin&quot;</span>)                                                     </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (task) &#123;                                                                                                                      </span><br><span class=\"line\">            task.dependsOn project.flutterBuildX86Jar                                                                                    </span><br><span class=\"line\">        &#125;                                                                                                                                </span><br><span class=\"line\">    &#125;                                                                                                                                    </span><br><span class=\"line\">                                                                                                                                         </span><br><span class=\"line\">    FlutterTask flutterTask = project.tasks.create(<span class=\"attr\">name:</span> <span class=\"string\">&quot;$&#123;flutterBuildPrefix&#125;$&#123;variant.name.capitalize()&#125;&quot;</span>, <span class=\"attr\">type:</span> FlutterTask) &#123;       </span><br><span class=\"line\">        flutterRoot <span class=\"variable language_\">this</span>.flutterRoot                                                                                                     </span><br><span class=\"line\">        flutterExecutable <span class=\"variable language_\">this</span>.flutterExecutable                                                                                         </span><br><span class=\"line\">        buildMode flutterBuildMode                                                                                                       </span><br><span class=\"line\">        localEngine <span class=\"variable language_\">this</span>.localEngine                                                                                                     </span><br><span class=\"line\">        localEngineSrcPath <span class=\"variable language_\">this</span>.localEngineSrcPath                                                                                       </span><br><span class=\"line\">        targetPath target                                                                                                                </span><br><span class=\"line\">        verbose verboseValue                                                                                                             </span><br><span class=\"line\">        fileSystemRoots fileSystemRootsValue                                                                                             </span><br><span class=\"line\">        fileSystemScheme fileSystemSchemeValue                                                                                           </span><br><span class=\"line\">        trackWidgetCreation trackWidgetCreationValue                                                                                     </span><br><span class=\"line\">        compilationTraceFilePath compilationTraceFilePathValue                                                                           </span><br><span class=\"line\">        createPatch createPatchValue                                                                                                     </span><br><span class=\"line\">        buildNumber buildNumberValue                                                                                                     </span><br><span class=\"line\">        baselineDir baselineDirValue                                                                                                     </span><br><span class=\"line\">        buildSharedLibrary buildSharedLibraryValue                                                                                       </span><br><span class=\"line\">        targetPlatform targetPlatformValue                                                                                               </span><br><span class=\"line\">        sourceDir project.file(project.flutter.source)                                                                                   </span><br><span class=\"line\">        intermediateDir project.file(<span class=\"string\">&quot;$&#123;project.buildDir&#125;/$&#123;AndroidProject.FD_INTERMEDIATES&#125;/flutter/$&#123;variant.name&#125;&quot;</span>)                   </span><br><span class=\"line\">        extraFrontEndOptions extraFrontEndOptionsValue                                                                                   </span><br><span class=\"line\">        extraGenSnapshotOptions extraGenSnapshotOptionsValue                                                                             </span><br><span class=\"line\">    &#125;                                                                                                                                    </span><br><span class=\"line\">                                                                                                                                         </span><br><span class=\"line\">    <span class=\"comment\">// We know that the flutter app is a subproject in another Android app when these tasks exist.                                       </span></span><br><span class=\"line\">    Task packageAssets = project.tasks.findByPath(<span class=\"string\">&quot;:flutter:package$&#123;variant.name.capitalize()&#125;Assets&quot;</span>)                                  </span><br><span class=\"line\">    Task cleanPackageAssets = project.tasks.findByPath(<span class=\"string\">&quot;:flutter:cleanPackage$&#123;variant.name.capitalize()&#125;Assets&quot;</span>)                        </span><br><span class=\"line\">                                                                                                                                         </span><br><span class=\"line\">    Task copyFlutterAssetsTask = project.tasks.create(<span class=\"attr\">name:</span> <span class=\"string\">&quot;copyFlutterAssets$&#123;variant.name.capitalize()&#125;&quot;</span>, <span class=\"attr\">type:</span> Copy) &#123;               </span><br><span class=\"line\">        dependsOn flutterTask                                                                                                            </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (packageAssets &amp;&amp; cleanPackageAssets) &#123;                                                                                       </span><br><span class=\"line\">            dependsOn packageAssets                                                                                                      </span><br><span class=\"line\">            dependsOn cleanPackageAssets                                                                                                 </span><br><span class=\"line\">            into packageAssets.outputDir                                                                                                 </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;                                                                                                                         </span><br><span class=\"line\">            dependsOn variant.mergeAssets                                                                                                </span><br><span class=\"line\">            dependsOn <span class=\"string\">&quot;clean$&#123;variant.mergeAssets.name.capitalize()&#125;&quot;</span>                                                                    </span><br><span class=\"line\">            into variant.mergeAssets.outputDir                                                                                           </span><br><span class=\"line\">        &#125;                                                                                                                                </span><br><span class=\"line\">        with flutterTask.assets                                                                                                          </span><br><span class=\"line\">    &#125;                                                                                                                                    </span><br><span class=\"line\">                                                                                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (packageAssets) &#123;                                                                                                                 </span><br><span class=\"line\">        String mainModuleName = <span class=\"string\">&quot;app&quot;</span>                                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;                                                                                                                            </span><br><span class=\"line\">            String tmpModuleName = project.rootProject.ext.mainModuleName                                                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tmpModuleName != <span class=\"literal\">null</span> &amp;&amp; !tmpModuleName.empty) &#123;                                                                         </span><br><span class=\"line\">                mainModuleName = tmpModuleName                                                                                           </span><br><span class=\"line\">            &#125;                                                                                                                            </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;                                                                                                          </span><br><span class=\"line\">        &#125;                                                                                                                                </span><br><span class=\"line\">        <span class=\"comment\">// Only include configurations that exist in parent project.                                                                     </span></span><br><span class=\"line\">        Task mergeAssets = project.tasks.findByPath(<span class=\"string\">&quot;:$&#123;mainModuleName&#125;:merge$&#123;variant.name.capitalize()&#125;Assets&quot;</span>)                        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mergeAssets) &#123;                                                                                                               </span><br><span class=\"line\">            mergeAssets.dependsOn(copyFlutterAssetsTask)                                                                                 </span><br><span class=\"line\">        &#125;                                                                                                                                </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;                                                                                                                             </span><br><span class=\"line\">        variant.outputs[<span class=\"number\">0</span>].processResources.dependsOn(copyFlutterAssetsTask)                                                             </span><br><span class=\"line\">    &#125;                                                                                                                                    </span><br><span class=\"line\">&#125;                                                                                                                                        </span><br></pre></td></tr></table></figure>\n\n<p><code>variant</code> 就是上面遍历的构建变体。首先当构建类型为 debug 时，会在 compileJavaWithJavac 和 compileKotlin 这两个 task 之前先执行 flutterBuildX86Jar task。它的作用是引入 x86 架构的 jar 和 so 文件。</p>\n<blockquote>\n<p>这里有个 bug</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.tasks.findByName(<span class=\"string\">&#x27;$&#123;flutterBuildPrefix&#125;X86Jar&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>判断是否存在 task 时，拼接字符串用的是单引号，正确应该用双引号，最新版本已经改正了。</p>\n</blockquote>\n<p>接下来，会创建两个 task，flutterBuild 和 copyFlutterAssets，flutterBuild 用于编译产物，copyFlutterAssets 则是将产物拷贝到 assets 目录。因为使用 <code>com.android.application</code> 和 <code>com.android.library</code> 拥有的 task 是不一样的，所有这里用是否存在 packageAssets 和 cleanPackageAssets 这两个 task 去判断引用不同插件的模块，同时引入 library 插件的模块，flutterBuild 需要依赖于这两个 task。</p>\n<p>flutterBuild task 实际上 FlutterTask 类型，同时 FlutterTask 继承于 BaseFlutterTask。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">BaseFlutterTask</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">DefaultTask</span> &#123; </span><br><span class=\"line\"><span class=\"meta\">@OutputFiles</span>                                                                </span><br><span class=\"line\">FileCollection getDependenciesFiles() &#123;                                     </span><br><span class=\"line\">    FileCollection depfiles = project.files()                               </span><br><span class=\"line\">                                                                            </span><br><span class=\"line\">    <span class=\"comment\">// Include the kernel compiler depfile, since kernel compile is the     </span></span><br><span class=\"line\">    <span class=\"comment\">// first stage of AOT build in this mode, and it includes all the Dart  </span></span><br><span class=\"line\">    <span class=\"comment\">// sources.                                                             </span></span><br><span class=\"line\">    depfiles += project.files(<span class=\"string\">&quot;$&#123;intermediateDir&#125;/kernel_compile.d&quot;</span>)        </span><br><span class=\"line\">                                                                            </span><br><span class=\"line\">    <span class=\"comment\">// Include Core JIT kernel compiler depfile, since kernel compile is    </span></span><br><span class=\"line\">    <span class=\"comment\">// the first stage of JIT builds in this mode, and it includes all the  </span></span><br><span class=\"line\">    <span class=\"comment\">// Dart sources.                                                        </span></span><br><span class=\"line\">    depfiles += project.files(<span class=\"string\">&quot;$&#123;intermediateDir&#125;/snapshot_blob.bin.d&quot;</span>)     </span><br><span class=\"line\">    <span class=\"keyword\">return</span> depfiles                                                         </span><br><span class=\"line\">&#125;                                                                           </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>@OutputFiles</code> 注解用于标示 task 输出的目录，这个可以用来做增量编译和任务缓存等等。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FlutterTask</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">BaseFlutterTask</span> &#123;</span><br><span class=\"line\">  <span class=\"meta\">@TaskAction</span>      </span><br><span class=\"line\"><span class=\"type\">void</span> build() &#123;   </span><br><span class=\"line\">    buildBundle()</span><br><span class=\"line\">&#125;                </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> buildBundle() &#123;                                                                         </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!sourceDir.isDirectory()) &#123;                                                          </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> GradleException(<span class=\"string\">&quot;Invalid Flutter source directory: $&#123;sourceDir&#125;&quot;</span>)          </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    intermediateDir.mkdirs()                                                                 </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;profile&quot;</span> || buildMode == <span class=\"string\">&quot;release&quot;</span>) &#123;                                  </span><br><span class=\"line\">        project.exec &#123;                                                                       </span><br><span class=\"line\">            executable flutterExecutable.absolutePath                                        </span><br><span class=\"line\">            workingDir sourceDir                                                             </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (localEngine != <span class=\"literal\">null</span>) &#123;                                                       </span><br><span class=\"line\">                args <span class=\"string\">&quot;--local-engine&quot;</span>, localEngine                                           </span><br><span class=\"line\">                args <span class=\"string\">&quot;--local-engine-src-path&quot;</span>, localEngineSrcPath                           </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            args <span class=\"string\">&quot;build&quot;</span>, <span class=\"string\">&quot;aot&quot;</span>                                                              </span><br><span class=\"line\">            args <span class=\"string\">&quot;--suppress-analytics&quot;</span>                                                      </span><br><span class=\"line\">            args <span class=\"string\">&quot;--quiet&quot;</span>                                                                   </span><br><span class=\"line\">            args <span class=\"string\">&quot;--target&quot;</span>, targetPath                                                      </span><br><span class=\"line\">            args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;android-arm&quot;</span>                                          </span><br><span class=\"line\">            args <span class=\"string\">&quot;--output-dir&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;&quot;</span>                                        </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (trackWidgetCreation) &#123;                                                       </span><br><span class=\"line\">                args <span class=\"string\">&quot;--track-widget-creation&quot;</span>                                               </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (extraFrontEndOptions != <span class=\"literal\">null</span>) &#123;                                              </span><br><span class=\"line\">                args <span class=\"string\">&quot;--extra-front-end-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraFrontEndOptions&#125;&quot;</span>                  </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (extraGenSnapshotOptions != <span class=\"literal\">null</span>) &#123;                                           </span><br><span class=\"line\">                args <span class=\"string\">&quot;--extra-gen-snapshot-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraGenSnapshotOptions&#125;&quot;</span>            </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (buildSharedLibrary) &#123;                                                        </span><br><span class=\"line\">                args <span class=\"string\">&quot;--build-shared-library&quot;</span>                                                </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (targetPlatform != <span class=\"literal\">null</span>) &#123;                                                    </span><br><span class=\"line\">                args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;$&#123;targetPlatform&#125;&quot;</span>                                </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">            args <span class=\"string\">&quot;--$&#123;buildMode&#125;&quot;</span>                                                            </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">                                                                                             </span><br><span class=\"line\">    project.exec &#123;                                                                           </span><br><span class=\"line\">        executable flutterExecutable.absolutePath                                            </span><br><span class=\"line\">        workingDir sourceDir                                                                 </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (localEngine != <span class=\"literal\">null</span>) &#123;                                                           </span><br><span class=\"line\">            args <span class=\"string\">&quot;--local-engine&quot;</span>, localEngine                                               </span><br><span class=\"line\">            args <span class=\"string\">&quot;--local-engine-src-path&quot;</span>, localEngineSrcPath                               </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        args <span class=\"string\">&quot;build&quot;</span>, <span class=\"string\">&quot;bundle&quot;</span>                                                               </span><br><span class=\"line\">        args <span class=\"string\">&quot;--suppress-analytics&quot;</span>                                                          </span><br><span class=\"line\">        args <span class=\"string\">&quot;--target&quot;</span>, targetPath                                                          </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (verbose) &#123;                                                                       </span><br><span class=\"line\">            args <span class=\"string\">&quot;--verbose&quot;</span>                                                                 </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (fileSystemRoots != <span class=\"literal\">null</span>) &#123;                                                       </span><br><span class=\"line\">            <span class=\"keyword\">for</span> (root <span class=\"keyword\">in</span> fileSystemRoots) &#123;                                                  </span><br><span class=\"line\">                args <span class=\"string\">&quot;--filesystem-root&quot;</span>, root                                               </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (fileSystemScheme != <span class=\"literal\">null</span>) &#123;                                                      </span><br><span class=\"line\">            args <span class=\"string\">&quot;--filesystem-scheme&quot;</span>, fileSystemScheme                                     </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (trackWidgetCreation) &#123;                                                           </span><br><span class=\"line\">            args <span class=\"string\">&quot;--track-widget-creation&quot;</span>                                                   </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compilationTraceFilePath != <span class=\"literal\">null</span>) &#123;                                              </span><br><span class=\"line\">            args <span class=\"string\">&quot;--compilation-trace-file&quot;</span>, compilationTraceFilePath                        </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (createPatch) &#123;                                                                   </span><br><span class=\"line\">            args <span class=\"string\">&quot;--patch&quot;</span>                                                                   </span><br><span class=\"line\">            args <span class=\"string\">&quot;--build-number&quot;</span>, project.android.defaultConfig.versionCode                 </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (buildNumber != <span class=\"literal\">null</span>) &#123;                                                       </span><br><span class=\"line\">                <span class=\"keyword\">assert</span> buildNumber == project.android.defaultConfig.versionCode              </span><br><span class=\"line\">            &#125;                                                                                </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (baselineDir != <span class=\"literal\">null</span>) &#123;                                                           </span><br><span class=\"line\">            args <span class=\"string\">&quot;--baseline-dir&quot;</span>, baselineDir                                               </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (extraFrontEndOptions != <span class=\"literal\">null</span>) &#123;                                                  </span><br><span class=\"line\">            args <span class=\"string\">&quot;--extra-front-end-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraFrontEndOptions&#125;&quot;</span>                      </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (extraGenSnapshotOptions != <span class=\"literal\">null</span>) &#123;                                               </span><br><span class=\"line\">            args <span class=\"string\">&quot;--extra-gen-snapshot-options&quot;</span>, <span class=\"string\">&quot;$&#123;extraGenSnapshotOptions&#125;&quot;</span>                </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (targetPlatform != <span class=\"literal\">null</span>) &#123;                                                        </span><br><span class=\"line\">            args <span class=\"string\">&quot;--target-platform&quot;</span>, <span class=\"string\">&quot;$&#123;targetPlatform&#125;&quot;</span>                                    </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;release&quot;</span> || buildMode == <span class=\"string\">&quot;profile&quot;</span>) &#123;                              </span><br><span class=\"line\">            args <span class=\"string\">&quot;--precompiled&quot;</span>                                                             </span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;                                                                             </span><br><span class=\"line\">            args <span class=\"string\">&quot;--depfile&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;/snapshot_blob.bin.d&quot;</span>                       </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        args <span class=\"string\">&quot;--asset-dir&quot;</span>, <span class=\"string\">&quot;$&#123;intermediateDir&#125;/flutter_assets&quot;</span>                              </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;debug&quot;</span>) &#123;                                                          </span><br><span class=\"line\">            args <span class=\"string\">&quot;--debug&quot;</span>                                                                   </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;profile&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicProfile&quot;</span>) &#123;                       </span><br><span class=\"line\">            args <span class=\"string\">&quot;--profile&quot;</span>                                                                 </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;release&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicRelease&quot;</span>) &#123;                       </span><br><span class=\"line\">            args <span class=\"string\">&quot;--release&quot;</span>                                                                 </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (buildMode == <span class=\"string\">&quot;dynamicProfile&quot;</span> || buildMode == <span class=\"string\">&quot;dynamicRelease&quot;</span>) &#123;                </span><br><span class=\"line\">            args <span class=\"string\">&quot;--dynamic&quot;</span>                                                                 </span><br><span class=\"line\">        &#125;                                                                                    </span><br><span class=\"line\">    &#125;                                                                                        </span><br><span class=\"line\">&#125;                                                                                            </span><br></pre></td></tr></table></figure>\n\n<p>用 <code>@TaskAction</code> 表示的方法就是 task 执行时候的方法。这里代码也很长，其实就是执行了两个命令。第一，如果是 release 或 profile 模式下，执行 <code>flutter build aot</code>。然后执行 <code>flutter build bundle</code>。</p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p>分析完 Flutter 接入的流程后，再回头去看我们一开始面临的问题，现在我们来解决它。</p>\n<h4 id=\"生成-aar\"><a href=\"#生成-aar\" class=\"headerlink\" title=\"生成 aar\"></a>生成 aar</h4><p>为了其他成员不需要依赖于 Flutter 环境，首先我们需要将 Flutter 代码提前生成为 aar，之所以不是 jar，是因为有图片资源等。生成产物的命令可以参照 FlutterBuildTask，要注意的是，debug 和 release 模式下生成的产物是不一致的。</p>\n<p>debug 模式下的构建产物：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/22/16cb84ca450f272b?w=460&h=380&f=png&s=39969\" alt=\"debug\"></p>\n<p>release 模式下的构建产物：</p>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/8/22/16cb84c97b7471b6?w=474&h=210&f=png&s=24868\" alt=\"release\"></p>\n<p>Flutter 产物生成不麻烦，照搬命令即可，这主要解决的问题是，Flutter 模块中依赖的第三方插件，上面我们说到，Flutter 模块依赖的第三方插件会生成到配置文件 .flutter-plugins 中。然后在 settings.gradle 中，将这些项目的源码加入我们项目的依赖中去。所有，我们要提前构建的话，就需要将这些代码也打进我们的 aar 中。可惜，官方不支持这种操作，这时候需要第三方库来支持了，<a href=\"https://github.com/Mobbeel/fataar-gradle-plugin\">fataar-gradle-plugin</a>，不过这个库有个小坑，Android Gradle 插件 3.1.x 的时候，没有将 jni 目录的 so 输出到 aar 中，解决方式，添加：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">project.copy &#123;</span><br><span class=\"line\">                from <span class=\"string\">&quot;$&#123;project.projectDir.path&#125;/build/intermediates/library_and_local_jars_jni/$&#123;variantName&#125;&quot;</span></span><br><span class=\"line\">                include <span class=\"string\">&quot;**&quot;</span></span><br><span class=\"line\">                into <span class=\"string\">&quot;$&#123;temporaryDir.path&#125;/$&#123;variantName&#125;/jni&quot;</span></span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure>\n\n<p>经过这两个步骤后，我们就能提前将 Flutter 产物和第三方插件的 aar 都打包一个 aar，上传 maven 上等等。</p>\n<h4 id=\"源码管理\"><a href=\"#源码管理\" class=\"headerlink\" title=\"源码管理\"></a>源码管理</h4><p>因为 Android 项目和 iOS 项目都需要用到同一套 Flutter 源码，所以这里我们可以使用 git 提供的 submodule 的形式接入源码。关于 Flutter SDK 版本管理，可以参照之前的文章：<a href=\"https://juejin.im/post/5d0c39326fb9a07ef63fe4b0\">flutterw</a></p>\n<h3 id=\"结尾\"><a href=\"#结尾\" class=\"headerlink\" title=\"结尾\"></a>结尾</h3><p>因为篇幅原因，所以不能将实现细节完整写出来，只能将一些关键点整理出来，希望能对大家有点启发。有其他疑问，欢迎留言讨论。</p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cl4hzcrl60001fho6hydz2xn5","category_id":"cl4hzcrlm000kfho6heipgen5","_id":"cl4hzcrm5001dfho667zlf4qk"},{"post_id":"cl4hzcrl90003fho6c8t54zs5","category_id":"cl4hzcrls000ofho65z4d6cnj","_id":"cl4hzcrm6001gfho67jschl65"},{"post_id":"cl4hzcrla0005fho6cvz9gngc","category_id":"cl4hzcrlv000sfho65egm8gol","_id":"cl4hzcrm6001jfho6b6qe1n50"},{"post_id":"cl4hzcrla0006fho66c8betl2","category_id":"cl4hzcrlv000sfho65egm8gol","_id":"cl4hzcrm7001mfho6b22r6q4q"},{"post_id":"cl4hzcrlb0007fho6dlbm4ojr","category_id":"cl4hzcrlv000sfho65egm8gol","_id":"cl4hzcrm7001ofho63bgs4c0x"},{"post_id":"cl4hzcrlb0008fho686eqehs1","category_id":"cl4hzcrlz0010fho6d9izb36a","_id":"cl4hzcrm8001pfho6ho8qgnpb"},{"post_id":"cl4hzcrlc0009fho69t9ef91i","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrm8001qfho6016igx2s"},{"post_id":"cl4hzcrld000afho6fuvvh4ob","category_id":"cl4hzcrlz0012fho615j6021p","_id":"cl4hzcrm8001rfho6djpkb37b"},{"post_id":"cl4hzcrle000bfho667klhlun","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrm8001sfho654wfbnk6"},{"post_id":"cl4hzcrle000cfho6045h8yzw","category_id":"cl4hzcrm00014fho66xta04zr","_id":"cl4hzcrm8001tfho67alke0xi"},{"post_id":"cl4hzcrlf000dfho6esc5592n","category_id":"cl4hzcrm00014fho66xta04zr","_id":"cl4hzcrm8001ufho61b5lf4c6"},{"post_id":"cl4hzcrlf000efho6gjzhdjoq","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrm8001vfho61skk7ye3"},{"post_id":"cl4hzcrlg000ffho67kkj4pxu","category_id":"cl4hzcrlm000kfho6heipgen5","_id":"cl4hzcrm8001wfho60gy4a7t2"},{"post_id":"cl4hzcrlg000gfho6azn98ds1","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrm8001xfho6cop81v6d"},{"post_id":"cl4hzcrlh000hfho6b4si8fy1","category_id":"cl4hzcrm00014fho66xta04zr","_id":"cl4hzcrm8001yfho635ryfcds"},{"post_id":"cl4hzcrlh000ifho66xeyfq4z","category_id":"cl4hzcrls000ofho65z4d6cnj","_id":"cl4hzcrm8001zfho6dyxvdrvi"},{"post_id":"cl4hzcrll000jfho67bppbhe4","category_id":"cl4hzcrlv000sfho65egm8gol","_id":"cl4hzcrm80020fho68gpw1uk4"},{"post_id":"cl4hzcrlq000mfho690mv50uo","category_id":"cl4hzcrm00014fho66xta04zr","_id":"cl4hzcrm80021fho6a3uq7e81"},{"post_id":"cl4hzcrlr000nfho6bysr5y6m","category_id":"cl4hzcrlv000sfho65egm8gol","_id":"cl4hzcrm80022fho62twccv9e"},{"post_id":"cl4hzcrlu000qfho621tbapsn","category_id":"cl4hzcrls000ofho65z4d6cnj","_id":"cl4hzcrm80023fho6cbwralg8"},{"post_id":"cl4hzcrlv000rfho619rucoth","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrm80024fho6a70jgnk7"},{"post_id":"cl4hzcrlv000tfho6cozy06fb","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrm80025fho6du26cqrk"},{"post_id":"cl4hzcrlw000ufho695gob49y","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrm80026fho6b2wz9ci4"},{"post_id":"cl4hzcrlw000wfho621ijcs5z","category_id":"cl4hzcrm00014fho66xta04zr","_id":"cl4hzcrm90027fho6c7gp6lyy"},{"post_id":"cl4hzcrly000xfho63e4od1zl","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrm90028fho6h22n9er5"},{"post_id":"cl4hzcrly000zfho6bs7z8ibe","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrm90029fho6cw21f8pw"},{"post_id":"cl4hzcrm5001bfho6bczzgrn8","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrma002cfho69g42ejt0"},{"post_id":"cl4hzcrm6001efho69o9o7f8f","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrma002dfho6fe9k9acx"},{"post_id":"cl4hzcrm6001hfho629mrgobk","category_id":"cl4hzcrlz0011fho605lph1ko","_id":"cl4hzcrmb002efho60pn424fq"},{"post_id":"cl4hzcrm7001kfho6dyq66p0l","category_id":"cl4hzcrm00014fho66xta04zr","_id":"cl4hzcrmb002ffho6dy09ecs8"},{"post_id":"cl4hzcrm7001nfho68emshdcs","category_id":"cl4hzcrm00014fho66xta04zr","_id":"cl4hzcrmb002gfho62r42hp97"}],"PostTag":[{"post_id":"cl4hzcrlc0009fho69t9ef91i","tag_id":"cl4hzcrlq000lfho6fgdeay4w","_id":"cl4hzcrm5001cfho62cxq9f13"},{"post_id":"cl4hzcrlg000gfho6azn98ds1","tag_id":"cl4hzcrlu000pfho64r6cg58a","_id":"cl4hzcrm6001ffho67hck8wap"},{"post_id":"cl4hzcrlv000rfho619rucoth","tag_id":"cl4hzcrlq000lfho6fgdeay4w","_id":"cl4hzcrm6001ifho6c5tpb7qt"},{"post_id":"cl4hzcrlv000tfho6cozy06fb","tag_id":"cl4hzcrlu000pfho64r6cg58a","_id":"cl4hzcrm7001lfho66e39e843"},{"post_id":"cl4hzcrm6001hfho629mrgobk","tag_id":"cl4hzcrlq000lfho6fgdeay4w","_id":"cl4hzcrma002bfho6biqd6959"},{"post_id":"cl4hzcrm5001bfho6bczzgrn8","tag_id":"cl4hzcrma002afho605fcb36y","_id":"cl4hzcrmb002hfho6hzb9ftbm"}],"Tag":[{"name":"Jetpack","_id":"cl4hzcrlq000lfho6fgdeay4w"},{"name":"性能优化","_id":"cl4hzcrlu000pfho64r6cg58a"},{"name":"Android Framework","_id":"cl4hzcrma002afho605fcb36y"}]}}